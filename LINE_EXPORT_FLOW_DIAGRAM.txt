═══════════════════════════════════════════════════════════════════════════════
                    LINE SCORECARD EXPORT - COMPLETE FLOW
═══════════════════════════════════════════════════════════════════════════════


USER FLOW DIAGRAM
─────────────────────────────────────────────────────────────────────────────

┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 1: USER COMPLETES ROUND                                               │
│  Location: Live Scorecard Page                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
                        ┌────────────────────────┐
                        │  User scores 18 holes  │
                        └────────────────────────┘
                                     │
                                     ▼
                        ┌────────────────────────┐
                        │ Clicks "Complete Round"│
                        └────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 2: FINALIZED SCORECARD DISPLAYED                                      │
│  Function: showFinalizedScorecard() - Line 33528                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │  Modal shows:                   │
                    │  • Round details                │
                    │  • All players' scorecards      │
                    │  • Action buttons:              │
                    │    - Print                      │
                    │    - Share                      │
                    │    - Download PDF               │
                    │    - [Export to LINE] ← NEW!   │
                    │    - Delete (private rounds)    │
                    │    - Close                      │
                    └─────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 3: USER CLICKS "EXPORT TO LINE"                                       │
│  Button: Line 20668 → Calls showLINEExportModal()                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 4: LINE EXPORT MODAL OPENS                                            │
│  Function: showLINEExportModal() - Line 34434                               │
│  Modal: Line 20685-20778                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │  Actions performed:             │
                    │  1. updateLINEMessagePreview()  │
                    │  2. loadLINEFriends()           │
                    │  3. Show modal                  │
                    └─────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 5: USER CONFIGURES EXPORT                                             │
│  Modal Contents:                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

        ┌─────────────────────────────────────────────────────┐
        │  RECIPIENT SELECTION                                 │
        │  ┌───────────────────────────────────────────────┐  │
        │  │ ○ Manual Entry                                │  │
        │  │   └─> [Input: LINE User ID]                   │  │
        │  │                                                │  │
        │  │ ○ Select from Friends (LIFF)                  │  │
        │  │   └─> [Dropdown: Loading friends...]          │  │
        │  └───────────────────────────────────────────────┘  │
        └─────────────────────────────────────────────────────┘
                                     │
        ┌─────────────────────────────────────────────────────┐
        │  MESSAGE PREVIEW (Live)                              │
        │  ┌───────────────────────────────────────────────┐  │
        │  │ ⛳ GOLF SCORECARD                             │  │
        │  │ ═══════════════════════════                  │  │
        │  │                                               │  │
        │  │ 🏆 Bangkok Golf Society                      │  │
        │  │ 📍 Monthly Medal                             │  │
        │  │ 🏌️ Alpine Golf Club (WHITE)                  │  │
        │  │ ...                                           │  │
        │  └───────────────────────────────────────────────┘  │
        └─────────────────────────────────────────────────────┘
                                     │
        ┌─────────────────────────────────────────────────────┐
        │  EXPORT OPTIONS (Checkboxes)                        │
        │  ☑ Include all players in group                     │
        │  ☑ Include detailed statistics                      │
        │                                                      │
        │  (Changes trigger updateLINEMessagePreview())        │
        └─────────────────────────────────────────────────────┘
                                     │
                                     ▼
                        ┌────────────────────────┐
                        │  User enters User ID   │
                        │  & reviews preview     │
                        └────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 6: USER CLICKS "SEND TO LINE"                                         │
│  Button → Calls sendScorecardToLINE() - Line 34627                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 7: CLIENT-SIDE VALIDATION                                             │
│  Function: sendScorecardToLINE() - Line 34627-34703                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │  Validate:                      │
                    │  1. Recipient selected?         │
                    │  2. User ID format valid?       │
                    │     (U + 32 chars = 33 total)   │
                    └─────────────────────────────────┘
                                     │
                          YES ────────┴────── NO
                           │                  │
                           │                  ▼
                           │         ┌──────────────────┐
                           │         │  Show error:     │
                           │         │  "Invalid format"│
                           │         └──────────────────┘
                           │                  │
                           │                  └─────> [STOP]
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 8: FORMAT MESSAGE                                                     │
│  Function: formatScorecardForLINE() - Line 34461                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │  Build message:                 │
                    │  • Header (event/course/date)   │
                    │  • For each player:             │
                    │    - Calculate scores           │
                    │    - Calculate points           │
                    │    - Format hole-by-hole        │
                    │    - Add emoji indicators       │
                    │  • Footer                       │
                    └─────────────────────────────────┘
                                     │
                                     ▼
                        ┌────────────────────────┐
                        │  Message string ready  │
                        │  (~400-1800 chars)     │
                        └────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 9: CALL SUPABASE EDGE FUNCTION                                        │
│  API: SupabaseDB.client.functions.invoke('send-line-scorecard')             │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │  POST to:                       │
                    │  /functions/v1/                 │
                    │  send-line-scorecard            │
                    │                                 │
                    │  Body:                          │
                    │  {                              │
                    │    recipientUserId: "U123...",  │
                    │    message: "⛳ GOLF..."        │
                    │  }                              │
                    └─────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 10: EDGE FUNCTION RECEIVES REQUEST                                    │
│  File: supabase/functions/send-line-scorecard/index.ts                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │  Server-side validation:        │
                    │  1. recipientUserId exists?     │
                    │  2. message exists?             │
                    │  3. User ID format valid?       │
                    │  4. Message length ≤ 5000?      │
                    └─────────────────────────────────┘
                                     │
                          VALID ─────┴───── INVALID
                           │                  │
                           │                  ▼
                           │         ┌──────────────────┐
                           │         │  Return 400 error│
                           │         │  with details    │
                           │         └──────────────────┘
                           │                  │
                           │                  └─────> [RETURN ERROR]
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 11: CALL LINE MESSAGING API                                           │
│  Function: sendLINEMessage() in edge function                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │  POST to LINE API:              │
                    │  https://api.line.me/v2/bot/    │
                    │  message/push                   │
                    │                                 │
                    │  Headers:                       │
                    │  Authorization: Bearer TOKEN    │
                    │                                 │
                    │  Body:                          │
                    │  {                              │
                    │    to: "U123...",               │
                    │    messages: [{                 │
                    │      type: "text",              │
                    │      text: "⛳ GOLF..."         │
                    │    }]                           │
                    │  }                              │
                    └─────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 12: LINE API PROCESSES REQUEST                                        │
│  LINE Platform                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │  LINE validates:                │
                    │  • Channel Access Token valid?  │
                    │  • Recipient User ID exists?    │
                    │  • User hasn't blocked bot?     │
                    └─────────────────────────────────┘
                                     │
                         SUCCESS ────┴──── FAILURE
                           │                  │
                           │                  ▼
                           │         ┌──────────────────┐
                           │         │  LINE returns    │
                           │         │  error response  │
                           │         └──────────────────┘
                           │                  │
                           ▼                  │
                  ┌──────────────┐            │
                  │ LINE sends   │            │
                  │ message to   │            │
                  │ recipient    │            │
                  └──────────────┘            │
                           │                  │
                           │                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 13: RESPONSE RETURNS TO EDGE FUNCTION                                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │  Edge function:                 │
                    │  1. Logs export to database     │
                    │     (scorecard_exports table)   │
                    │  2. Returns success/error       │
                    │     to client                   │
                    └─────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 14: CLIENT RECEIVES RESPONSE                                          │
│  Function: sendScorecardToLINE() - continued                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                         SUCCESS ────┴──── ERROR
                           │                  │
                           ▼                  ▼
                  ┌──────────────┐   ┌──────────────────┐
                  │  Show green  │   │  Show red error  │
                  │  success msg │   │  message with    │
                  │              │   │  details         │
                  │  "✅ Sent    │   │                  │
                  │  successfully"│   │  "❌ Error: ..." │
                  └──────────────┘   └──────────────────┘
                           │                  │
                           ▼                  ▼
                  ┌──────────────┐   ┌──────────────────┐
                  │  Auto-close  │   │  Keep modal open │
                  │  modal after │   │  for retry       │
                  │  2 seconds   │   │                  │
                  └──────────────┘   └──────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 15: RECIPIENT RECEIVES MESSAGE IN LINE APP                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │  LINE notification appears      │
                    │  on recipient's phone           │
                    │                                 │
                    │  Message displays formatted     │
                    │  scorecard with emojis          │
                    └─────────────────────────────────┘
                                     │
                                     ▼
                              ┌──────────┐
                              │   DONE   │
                              └──────────┘


═══════════════════════════════════════════════════════════════════════════════

DATA FLOW DIAGRAM
─────────────────────────────────────────────────────────────────────────────

  Browser (Client)              Supabase              LINE Platform
       │                           │                        │
       │  1. Complete Round        │                        │
       │─────────────────>         │                        │
       │                           │                        │
       │  2. Click Export          │                        │
       │─────────────────>         │                        │
       │                           │                        │
       │  3. Enter User ID         │                        │
       │     & Options             │                        │
       │                           │                        │
       │  4. Click Send            │                        │
       │─────────────────>         │                        │
       │                           │                        │
       │  5. POST /functions/      │                        │
       │     send-line-scorecard   │                        │
       │──────────────────────────>│                        │
       │                           │                        │
       │                           │  6. POST /message/push │
       │                           │───────────────────────>│
       │                           │                        │
       │                           │  7. LINE API Response  │
       │                           │<───────────────────────│
       │                           │                        │
       │                           │  8. Save to DB         │
       │                           │     (scorecard_exports)│
       │                           │                        │
       │  9. Return success/error  │                        │
       │<──────────────────────────│                        │
       │                           │                        │
       │ 10. Show notification     │                        │
       │                           │                        │
       │                           │  11. Deliver message   │
       │                           │         to recipient   │
       │                           │         phone          │
       │                           │                        │


═══════════════════════════════════════════════════════════════════════════════

COMPONENT INTERACTION
─────────────────────────────────────────────────────────────────────────────

┌──────────────────────────────────────────────────────────────────────────┐
│  FRONTEND (index.html)                                                   │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  UI Layer                        JavaScript Layer                        │
│  ─────────                       ─────────────                           │
│                                                                           │
│  • Finalized Scorecard Modal     • LiveScorecardManager                  │
│    - Export button                 - showLINEExportModal()               │
│                                    - closeLINEExportModal()              │
│  • LINE Export Modal               - updateLINEMessagePreview()          │
│    - Recipient input               - formatScorecardForLINE()            │
│    - Message preview               - loadLINEFriends()                   │
│    - Options checkboxes            - sendScorecardToLINE()               │
│    - Send button                                                         │
│    - Status display              Data Sources                            │
│                                  ────────────                            │
│                                  • this.players                          │
│                                  • this.scoresCache                      │
│                                  • this.courseData                       │
│                                  • this.scoringFormats                   │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
                                     │
                                     │ HTTPS POST
                                     │
                                     ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  BACKEND (Supabase Edge Function)                                        │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  send-line-scorecard/index.ts                                            │
│                                                                           │
│  Input Validation                                                        │
│  ────────────────                                                        │
│  • recipientUserId validation                                            │
│  • message validation                                                    │
│  • Character limit check                                                 │
│                                                                           │
│  LINE API Integration                                                    │
│  ────────────────────                                                    │
│  • sendLINEMessage(userId, message)                                      │
│  • Uses LINE_CHANNEL_ACCESS_TOKEN                                        │
│  • POST to api.line.me/v2/bot/message/push                               │
│                                                                           │
│  Database Logging (Optional)                                             │
│  ───────────────────────────                                             │
│  • Insert to scorecard_exports table                                     │
│  • Track exports for analytics                                           │
│                                                                           │
│  Error Handling                                                          │
│  ──────────────                                                          │
│  • Catch LINE API errors                                                 │
│  • Return meaningful error messages                                      │
│  • Log errors for debugging                                              │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
                                     │
                                     │ HTTPS POST
                                     │
                                     ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  EXTERNAL SERVICE (LINE Platform)                                        │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  LINE Messaging API                                                      │
│  api.line.me/v2/bot/message/push                                         │
│                                                                           │
│  • Validates Channel Access Token                                        │
│  • Validates Recipient User ID                                           │
│  • Checks if user blocked bot                                            │
│  • Delivers message to recipient                                         │
│  • Returns success/error response                                        │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
