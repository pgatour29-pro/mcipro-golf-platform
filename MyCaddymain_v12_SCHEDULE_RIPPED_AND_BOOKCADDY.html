<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>UniCaddy Golf — Standalone</title>
<!-- React 18 + ReactDOM 18 (CDN) -->
<script crossorigin="" src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin="" src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<!-- Babel (for in-browser JSX) -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<!-- Tailwind CSS (CDN) -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
    html, body, #root { height: 100%; }
    body { margin: 0; background: #f6f7fb; }
  </style>
<!-- === Runtime v48: Targeted Announcements & IM (read/unread, delete, scope) === -->
<script>
(function(){
  if (window.__gmv48) return; window.__gmv48 = true;

  // ========== utils ==========
  function esc(s){ s = s==null ? '' : String(s); return s.replace(/[&<>]/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]); }); }
  function pad(n){ n = String(n); return n.length<2 ? ('0'+n) : n; }
  function fmt(ts){ var d=new Date(ts); return [pad(d.getMonth()+1), pad(d.getDate()), d.getFullYear()].join('/')+' '+(((d.getHours()+11)%12)+1)+':'+pad(d.getMinutes())+' '+(d.getHours()>=12?'PM':'AM'); }
  function createEl(tag, attrs, html){
    var el = document.createElement(tag);
    if(attrs){ for(var k in attrs){ if(attrs.hasOwnProperty(k)) el.setAttribute(k, attrs[k]); } }
    if(html!=null){ el.innerHTML = html; }
    return el;
  }
  function uid(){ return 'm'+Date.now().toString(36)+Math.random().toString(36).slice(2,7); }

  // ========== identity/context helpers ==========
  function getCurrentUser(){
    // Try to infer from header second line e.g. "Robert Anderson • GM" or "Ning Siriwan • CADDY"
    var role = null, name = null, id = null;
    var header = document.querySelector('header, .header, nav') || document;
    var txt = (header && header.innerText) ? header.innerText : document.body.innerText;
    if(/\u2022\s*GM/i.test(txt)) role = 'GM';
    else if(/\u2022\s*CADDY/i.test(txt)) role = 'CADDY';
    else if(/\u2022\s*GOLFER/i.test(txt)) role = 'GOLFER';
    // initials at top-right like RA / NS / PP
    var avatarChip = Array.from(document.querySelectorAll('button,div,span')).find(el => el.textContent.trim().match(/^[A-Z]{2}$/));
    if(avatarChip){ id = avatarChip.textContent.trim(); }
    // name (best-effort) from the banner title area near "MyCaddy Pro"
    var nameEl = Array.from(document.querySelectorAll('h1,h2,div,span')).find(el => /MyCaddy Pro/i.test(el.textContent));
    if(nameEl){
      // look one sibling down for next lines
      var sib = nameEl.parentElement && nameEl.parentElement.nextElementSibling;
      if(sib) {
        var s = sib.innerText || '';
        var m = s.split('•')[0]; if(m) name = m.trim();
      }
    }
    // stored course
    var course = localStorage.getItem('gm.courseId') || 'DefaultCourse';
    return { id: id || 'ANON', role: role || 'UNKNOWN', name: name || 'User', course: course };
  }

  // ========== storage & event bus ==========
  var STORE='gm.msg.store.v48';
  function emptyStore(){ return { ts:0, items:[] }; }
  function clone(o){ try{ return JSON.parse(JSON.stringify(o)); }catch(_){ return emptyStore(); } }

  function loadStore(){
    try{ var a = JSON.parse(localStorage.getItem(STORE)||'null'); if(a && a.items && a.items.push) return a; }catch(_){}
    try{ var b = JSON.parse(sessionStorage.getItem(STORE)||'null'); if(b && b.items && b.items.push) return b; }catch(_){}
    if (window.__gmMsgs && window.__gmMsgs.items && window.__gmMsgs.items.push) return clone(window.__gmMsgs);
    return emptyStore();
  }
  function saveStore(obj){
    var s = obj || emptyStore();
    try{ localStorage.setItem(STORE, JSON.stringify(s)); }catch(_){}
    try{ sessionStorage.setItem(STORE, JSON.stringify(s)); }catch(_){}
    try{ window.__gmMsgs = clone(s); }catch(_){}
    try{ window.dispatchEvent(new CustomEvent('gm:msg:update', { detail: s })); }catch(_){}
  }

  // ========== visibility logic ==========
  function visibleTo(msg, user){
    if (!msg || !user) return false;
    if (msg.deletedForAll) return false;
    if (msg.deletedBy && msg.deletedBy.indexOf(user.id) >= 0) return false;
    // sender always sees their own unless deletedForAll
    if (msg.sender && msg.sender.id === user.id) return true;

    var sc = msg.scope || { type:'all' };
    if (sc.type === 'all') return true;
    if (sc.type === 'users') return (sc.userIds||[]).indexOf(user.id) >= 0;
    if (sc.type === 'course'){
      if (sc.courseId && user.course !== sc.courseId) return false;
      if (!sc.roles || !sc.roles.length) return true;
      return sc.roles.indexOf(user.role) >= 0;
    }
    // future: society, groups, etc.
    return false;
  }

  function isUnread(msg, user){
    var rb = msg.readBy || []; return rb.indexOf(user.id) === -1 && msg.sender.id !== user.id;
  }

  // ========== banner UI ==========
  function ensureBanner(){
    if (document.getElementById('gmBanner48')) return;
    var host = (document.querySelector('main') || document.body);
    var wrap = createEl('div', { id:'gmBanner48', style:'position:relative;margin:16px 12px;border-radius:12px;border:1px solid #e5e7eb;overflow:hidden;box-shadow:0 6px 14px rgba(0,0,0,.06);background:#fff;z-index:2147483600' });
    wrap.innerHTML = ''
      + '<div style="display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,#2563eb,#1d4ed8);color:#fff;padding:10px 14px">'
      +   '<div style="display:flex;align-items:center;gap:10px"><strong>Messages</strong><small id="gmScopeHint48" style="opacity:.9"></small></div>'
      +   '<div style="display:flex;gap:8px">'
      +     '<button id="gmCompose48" style="font-size:12px;padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.6);background:rgba(255,255,255,.12);color:#fff;cursor:pointer">Compose</button>'
      +     '<button id="gmRefresh48" style="font-size:12px;padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.6);background:rgba(255,255,255,.12);color:#fff;cursor:pointer">Refresh</button>'
      +   '</div>'
      + '</div>'
      + '<div id="gmComposeBox48" style="display:none;padding:10px 14px;border-bottom:1px dashed #e5e7eb;background:#f9fafb">'
      +   '<div style="display:grid;gap:8px">'
      +     '<div style="display:flex;gap:8px;flex-wrap:wrap">'
      +       '<select id="gmAudience48" style="padding:8px;border:1px solid #e5e7eb;border-radius:8px">'
      +         '<option value="all">Everyone</option>'
      +         '<option value="course_all">My course – Everyone</option>'
      +         '<option value="course_caddies">My course – Caddies</option>'
      +         '<option value="course_golfers">My course – Golfers</option>'
      +         '<option value="users">Specific user IDs…</option>'
      +       '</select>'
      +       '<input id="gmCourse48" placeholder="My Course ID/Name" style="display:none;min-width:160px;padding:8px;border:1px solid #e5e7eb;border-radius:8px">'
      +       '<input id="gmUsers48" placeholder="IDs comma-separated e.g. NS,PP" style="display:none;min-width:220px;padding:8px;border:1px solid #e5e7eb;border-radius:8px">'
      +     '</div>'
      +     '<div style="display:flex;gap:8px;flex-wrap:wrap">'
      +       '<input id="gmTitle48" placeholder="Title" style="flex:1;min-width:160px;padding:8px;border:1px solid #e5e7eb;border-radius:8px">'
      +       '<input id="gmBody48" placeholder="Message" style="flex:2;min-width:200px;padding:8px;border:1px solid #e5e7eb;border-radius:8px">'
      +       '<button id="gmSend48" style="padding:8px 12px;border:1px solid #22c55e;background:#22c55e;color:#fff;border-radius:8px;cursor:pointer">Send</button>'
      +     '</div>'
      +   '</div>'
      + '</div>'
      + '<div id="gmList48" style="padding:10px 14px;display:grid;gap:8px"></div>';
    host.insertBefore(wrap, host.firstChild);

    function updateScopeHint(){
      var u=getCurrentUser();
      var hint='('+u.role+(u.course?(' • '+u.course):'')+')'; document.getElementById('gmScopeHint48').textContent=hint;
    }
    updateScopeHint();

    document.getElementById('gmRefresh48').addEventListener('click', drawBanner);
    document.getElementById('gmCompose48').addEventListener('click', function(){
      var box=document.getElementById('gmComposeBox48');
      box.style.display = (box.style.display==='none'||!box.style.display)?'block':'none';
    });

    var aud = document.getElementById('gmAudience48');
    var courseInp = document.getElementById('gmCourse48');
    var usersInp = document.getElementById('gmUsers48');
    var storedCourse = localStorage.getItem('gm.courseId')||'';
    if(storedCourse) courseInp.value = storedCourse;

    function updateAudienceFields(){
      var v=aud.value;
      courseInp.style.display = (v.startsWith('course')) ? 'inline-block' : 'none';
      usersInp.style.display = (v==='users') ? 'inline-block' : 'none';
    }
    aud.addEventListener('change', updateAudienceFields);
    updateAudienceFields();

    document.getElementById('gmSend48').addEventListener('click', function(){
      var user=getCurrentUser();
      var title=document.getElementById('gmTitle48').value.trim();
      var body=document.getElementById('gmBody48').value.trim();
      if(!title && !body) return;
      var scope = { type:'all' };
      var v=aud.value;
      if(v==='all'){ scope={type:'all'}; }
      else if(v==='users'){
        var ids=(usersInp.value||'').split(',').map(function(s){return s.trim().toUpperCase();}).filter(Boolean);
        scope={type:'users', userIds: ids};
      } else if(v.startsWith('course')){
        var course = (courseInp.value||storedCourse||'').trim() || 'DefaultCourse';
        localStorage.setItem('gm.courseId', course);
        var roles=[];
        if(v==='course_caddies') roles=['CADDY']; else if(v==='course_golfers') roles=['GOLFER']; else roles=[]; // course_all => everyone at course
        scope={type:'course', courseId: course, roles: roles};
      }
      var msg = {
        id: uid(),
        ts: Date.now(),
        sender: { id:user.id, role:user.role, course:user.course, name:user.name },
        scope: scope,
        title: title || 'Message',
        body: body || '',
        readBy: [],
        deletedBy: []
      };
      var s=loadStore(); s.items.push(msg); s.ts=Date.now(); saveStore(s);
      document.getElementById('gmTitle48').value=''; document.getElementById('gmBody48').value='';
      drawBanner();
    });

    window.addEventListener('gm:msg:update', drawBanner);
    drawBanner();
  }

  function actionBtn(txt, color){
    var b=document.createElement('button');
    b.textContent=txt;
    b.style.cssText='padding:4px 8px;border-radius:8px;border:1px solid '+(color||'#e5e7eb')+';background:#fff;color:'+(color||'#111827')+';cursor:pointer;font-size:12px';
    return b;
  }

  function drawBanner(){
    var list = document.getElementById('gmList48'); if(!list) return;
    list.innerHTML='';
    var s = loadStore(); var u=getCurrentUser();
    var items = (s.items||[]).filter(function(m){ return visibleTo(m,u); }).sort(function(a,b){ return b.ts-a.ts; }).slice(0,20);
    if(!items.length){
      var r = createEl('div', {style:'border:1px dashed #e5e7eb;border-radius:10px;padding:10px 12px;background:#fafafa'}, 'No messages for your scope.');
      list.appendChild(r); return;
    }
    items.forEach(function(it){
      var row = createEl('div', {style:'border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;background:#fff;display:flex;justify-content:space-between;align-items:flex-start;gap:10px'});
      var left = createEl('div', null,
        '<div style="font-weight:'+(isUnread(it,u)?'700':'600')+'">'+esc(it.title)+'</div>'+
        '<div style="opacity:.9">'+esc(it.body||'')+'</div>'+
        '<div style="font-size:12px;opacity:.7;margin-top:2px">'+fmt(it.ts)+' • from '+esc(it.sender.name||it.sender.id)+'</div>'
      );
      var actions = createEl('div', {style:'display:flex;gap:6px;flex-wrap:wrap'});
      var toggle = actionBtn(isUnread(it,u)?'Mark read':'Mark unread', '#2563eb');
      toggle.addEventListener('click', function(){
        var st=loadStore(); var m=st.items.find(x=>x.id===it.id); if(!m){ drawBanner(); return; }
        m.readBy = m.readBy || [];
        var idx=m.readBy.indexOf(u.id);
        if(idx>=0) m.readBy.splice(idx,1); else m.readBy.push(u.id);
        saveStore(st);
      });
      var delMe = actionBtn('Delete for me', '#ef4444');
      delMe.addEventListener('click', function(){
        var st=loadStore(); var m=st.items.find(x=>x.id===it.id); if(!m){ drawBanner(); return; }
        m.deletedBy = m.deletedBy || [];
        if(m.deletedBy.indexOf(u.id)===-1) m.deletedBy.push(u.id);
        saveStore(st);
      });
      actions.appendChild(toggle); actions.appendChild(delMe);
      if (it.sender && it.sender.id === u.id){
        var delAll = actionBtn('Delete for all', '#b91c1c');
        delAll.addEventListener('click', function(){
          var st=loadStore(); var m=st.items.find(x=>x.id===it.id); if(!m){ drawBanner(); return; }
          m.deletedForAll = true; saveStore(st);
        });
        actions.appendChild(delAll);
      }
      row.appendChild(left); row.appendChild(actions); list.appendChild(row);
    });
  }

  // ========== GM Tool (existing from prior build) ==========
  function ensureGMTool(){
    if (document.getElementById('gmFab47')) return; // keep previous v47 tool if already present
    // In v48 we do not re-inject the tool to avoid duplicate; banner is the new feature.
  }

  // ========== boot ==========
  function boot(){
    try{ ensureBanner(); }catch(_){}
    try{ ensureGMTool(); }catch(_){}
  }
  if (document.readyState !== 'loading') boot();
  document.addEventListener('DOMContentLoaded', boot);
  window.addEventListener('load', boot);
  // Re-evaluate user scope periodically (SPA-like)
  setInterval(drawBanner, 1500);
  window.addEventListener('gm:msg:update', drawBanner);
})();
</script>
<!-- === Runtime v49: Restore GM Tool (Assign + Ann tabs) === -->
<script>
(function(){
  if (window.__gmv49_tool) return; window.__gmv49_tool = true;

  function pad(n){ n = String(n); return n.length<2 ? ('0'+n) : n; }
  function createEl(tag, attrs, html){
    var el = document.createElement(tag);
    if(attrs){ for(var k in attrs){ if(attrs.hasOwnProperty(k)) el.setAttribute(k, attrs[k]); } }
    if(html!=null){ el.innerHTML = html; }
    return el;
  }

  function ensureGMTool49(){
    if (document.getElementById('gmFab49') || document.getElementById('gmFab47')) return;
    var fab = createEl('button', { id:'gmFab49', title:'GM Tools', style:'position:fixed;bottom:18px;right:18px;z-index:2147483646;width:56px;height:56px;border:none;border-radius:999px;background:#2563eb;color:#fff;font-weight:800;box-shadow:0 12px 28px rgba(0,0,0,.24);cursor:pointer' }, 'GM');
    var dock = createEl('div', { id:'gmDock49', style:'position:fixed;top:96px;right:16px;z-index:2147483647;background:#fff;border:3px solid #2563eb;border-radius:12px;padding:0;box-shadow:0 12px 30px rgba(0,0,0,.28);font-family:system-ui,sans-serif;min-width:360px;display:none' });
    dock.innerHTML = ''
      + '<div id="gmHdr49" style="cursor:grab;user-select:none;padding:8px 10px;background:#f8fafc;border-bottom:1px solid #e5e7eb;border-top-left-radius:10px;border-top-right-radius:10px;display:flex;align-items:center;justify-content:space-between;gap:8px">'
      +   '<strong>GM Tools</strong>'
      +   '<div style="display:flex;gap:8px">'
      +     '<button id="gmTabAssign49" style="padding:4px 8px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;font-size:12px;cursor:pointer">Assign</button>'
      +     '<button id="gmTabAnn49" style="padding:4px 8px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;font-size:12px;cursor:pointer">Announcements</button>'
      +     '<button id="gmHide49" style="padding:4px 8px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;font-size:12px;cursor:pointer">Hide</button>'
      +   '</div>'
      + '</div>'
      + '<div id="gmBody49" style="padding:10px"></div>';
    (document.body ? document.body : document.documentElement).appendChild(fab);
    (document.body ? document.body : document.documentElement).appendChild(dock);

    fab.addEventListener('click', function(){ dock.style.display = (dock.style.display==='none'||!dock.style.display)?'block':'none'; });

    function dragify(handle, target){
      var drag=null;
      handle.addEventListener('mousedown', start); handle.addEventListener('touchstart', start, {passive:false});
      function start(ev){ var e=ev.touches?ev.touches[0]:ev; drag={sx:e.clientX,sy:e.clientY,ox:target.offsetLeft,oy:target.offsetTop}; handle.style.cursor='grabbing';
        window.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
        window.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', end); ev.preventDefault(); }
      function move(ev){ if(!drag) return; var e=ev.touches?ev.touches[0]:ev; var nx=drag.ox+(e.clientX-drag.sx), ny=drag.oy+(e.clientY-drag.sy); var w=innerWidth,h=innerHeight,rect=target.getBoundingClientRect();
        nx=Math.min(Math.max(nx,4), w-rect.width-4); ny=Math.min(Math.max(ny,4), h-rect.height-4); target.style.left=nx+'px'; target.style.top=ny+'px'; target.style.right='auto'; ev.preventDefault(); }
      function end(){ if(!drag) return; handle.style.cursor='grab'; window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', end); window.removeEventListener('touchmove', move); window.removeEventListener('touchend', end); drag=null; }
    }
    dragify(dock.querySelector('#gmHdr49'), dock);

    // Helpers for assign
    function setReactValue(el, value){
      if(!el) return; try{
        var proto=Object.getPrototypeOf(el);
        var desc=Object.getOwnPropertyDescriptor(proto,'value')||Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,'value')||Object.getOwnPropertyDescriptor(HTMLSelectElement.prototype,'value');
        if(desc&&desc.set) desc.set.call(el,value); else el.value=value;
        el.dispatchEvent(new Event('input',{bubbles:true}));
      }catch(e){ try{ el.value=value; el.dispatchEvent(new Event('input',{bubbles:true})); }catch(_){ } }
    }
    function findTable(){
      var tables=document.getElementsByTagName('table'); var best=null, maxRows=0;
      for(var i=0;i<tables.length;i++){ var tb=tables[i]; var rows=(tb.tBodies && tb.tBodies[0] && tb.tBodies[0].rows.length) || tb.querySelectorAll('tr').length; if(rows>maxRows){ maxRows=rows; best=tb; } }
      return best;
    }
    function rowIndex(tb){
      var idx={}, rows=(tb.tBodies && tb.tBodies[0] && tb.tBodies[0].rows) || tb.querySelectorAll('tr');
      for(var i=0;i<rows.length;i++){ var tr=rows[i]; var f=tr.querySelector('th,td'); var T=(f && f.textContent || '').trim(); if(/^\d{2}:\d{2}$/.test(T)) idx[T]=tr; }
      return idx;
    }
    function headerMap(tb){
      var row=(tb.tHead && tb.tHead.rows[0]) || tb.querySelector('tr');
      var ths=(row?row.querySelectorAll('th,td'):[]);
      var map={}; for(var i=0;i<ths.length;i++){ var m=(ths[i].textContent||'').trim().match(/^tee\s*(\d+)/i); if(m) map[parseInt(m[1],10)]=i; }
      if(!Object.keys(map).length){ for(var n=1;n<=8;n++){ map[n]=n; } } return map;
    }
    function isBooked(cell){
      if(!cell) return false;
      if(cell.querySelector('.booking-card,[data-booked="1"],.bg-green-100,.bg-yellow-100,.bg-red-100')) return true;
      var txt=(cell.textContent||'').replace(/\s+/g,'').trim(); return txt.length>0;
    }
    function refreshSlots(){
  var info=document.getElementById('gmAssignInfo49'); var teeSel=document.getElementById('gmTeeSel49'); var tsel=document.getElementById('gmTimeSel49');
  if(!info || !teeSel || !tsel) return;
  var T = tsel.value || '06:45';

  // --- V11 tee-sheet detection ---
  var v11 = document.getElementById('abcv11');
  if (v11){
    try{
      var slots = Array.prototype.slice.call(v11.querySelectorAll('.slot[data-time="'+T+'"]'));
      var free = slots.filter(function(s){ return !s.querySelector('.pill'); })
                      .map(function(s){
                        var g = s.getAttribute('data-group') || '?';
                        var t = s.getAttribute('data-tee') || '?';
                        return g+''+t;
                      });
      teeSel.innerHTML = '';
      if (free.length === 0){
        teeSel.innerHTML = '<option value="">— No free slots —</option>';
        info.textContent = 'No free slots at '+T+' on v11.';
      }else{
        free.forEach(function(label){
          var opt=document.createElement('option'); opt.value=label; opt.textContent=label; teeSel.appendChild(opt);
        });
        info.textContent = 'Pick an open slot at '+T+' (v11).';
      }
      return; // handled by v11
    }catch(err){
      // fall through to legacy
    }
  }

  // --- Legacy fallback (original logic) ---
  var info=document.getElementById('gmAssignInfo49'); var teeSel=document.getElementById('gmTeeSel49'); var tsel=document.getElementById('gmTimeSel49');
      if(!info || !teeSel || !tsel) return;
      var T = tsel.value || '06:45';
      var tb=findTable();
      if(!tb){ info.textContent='Tee sheet not found.'; teeSel.innerHTML='<option value="">— No free slots —</option>'; return; }
      var idx=rowIndex(tb), tr=idx[T];
      if(!tr){ info.textContent='Time row not found: '+T; teeSel.innerHTML='<option value="">— No free slots —</option>'; return; }
      var map=headerMap(tb); var cells=tr.querySelectorAll('td,th'); var max=0; for(var k in map){ if(map.hasOwnProperty(k)) max=Math.max(max, parseInt(k,10)); }
      var out=[]; for(var n=1;n<=max;n++){ var cell=cells[map[n]]; if(cell && !isBooked(cell)) out.push(n); }
      teeSel.innerHTML='';
      if(out.length){ for(var j=0;j<out.length;j++){ var o=document.createElement('option'); o.value=String(out[j]); o.textContent='Slot '+out[j]; teeSel.appendChild(o); } }
      else { teeSel.innerHTML='<option value="">— No free slots —</option>'; }
      try{ tr.scrollIntoView({behavior:'smooth', block:'center'});}catch(_){}
      info.textContent = out.length ? ('Free slots at '+T+': '+out.join(', ')) : ('No free slots at '+T);
}

    function renderAssignTab(){
      var body=document.getElementById('gmBody49'); body.innerHTML = ''
        + '<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">'
        +   '<div><div style="font-size:12px">Time</div><select id="gmTimeSel49" style="padding:6px 10px;border:1px solid #e5e7eb;border-radius:8px"></select></div>'
        +   '<div><div style="font-size:12px">Tee</div><select id="gmTeeSel49" style="padding:6px 10px;border:1px solid #e5e7eb;border-radius:8px;min-width:120px"></select></div>'
        +   '<button id="gmApply49" style="padding:6px 10px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer">Apply to form</button>'
        + '</div>'
        + '<div id="gmAssignInfo49" style="margin-top:8px;font-size:12px;opacity:.8"></div>';
      var tsel=document.getElementById('gmTimeSel49');
      for(var h=6;h<=17;h++){ for(var m=0;m<=45;m+=15){ if(h===17 && m>0) break; var o=document.createElement('option'); var T=pad(h)+':'+pad(m); o.value=T; o.textContent=T; tsel.appendChild(o); } }
      tsel.addEventListener('change', refreshSlots);
      setTimeout(function(){
        var timeInput=document.querySelector('input[placeholder="Time e.g. 16:45"], input[name*="time" i], select[name*="time" i]');
        if(timeInput && /^\d{2}:\d{2}$/.test(timeInput.value)) tsel.value=timeInput.value;
        refreshSlots();
      }, 350);
      document.getElementById('gmApply49').addEventListener('click', function(){
        var T=document.getElementById('gmTimeSel49').value; var tee=document.getElementById('gmTeeSel49').value;
        var timeInput=document.querySelector('input[placeholder="Time e.g. 16:45"], input[name*="time" i], select[name*="time" i]');
        var teeInput=document.querySelector('input[placeholder="Tee Slot # e.g. 3"], input[name*="tee" i], select[name*="tee" i]');
        if(timeInput) setReactValue(timeInput, T);
        if(teeInput && tee) setReactValue(teeInput, tee);
      });
    }

    function renderAnnTab(){
      var body=document.getElementById('gmBody49');
      body.innerHTML = ''
        + '<div style="display:grid;gap:8px">'
        +   '<div style="display:grid;gap:4px">'
        +     '<input id="annTitle49" placeholder="Title" style="padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px">'
        +     '<textarea id="annBody49" placeholder="Details" rows="2" style="padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px"></textarea>'
        +     '<div style="display:flex;gap:8px">'
        +       '<button id="annAdd49" style="padding:6px 10px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer">Add</button>'
        +       '<button id="annClear49" style="padding:6px 10px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer">Clear All</button>'
        +     '</div>'
        +   '</div>'
        +   '<div id="annList49" style="display:grid;gap:6px;max-height:220px;overflow:auto;border-top:1px dashed #e5e7eb;padding-top:8px"></div>'
        + '</div>';
      function loadStore(){ try{ return JSON.parse(localStorage.getItem('gm.ann.store.v47')||'null') || JSON.parse(localStorage.getItem('gm.ann.store.v46')||'null') || {items:[]}; }catch(_){ return {items:[]}; } }
      function saveStore(s){ try{ localStorage.setItem('gm.ann.store.v47', JSON.stringify(s)); }catch(_){} try{ window.dispatchEvent(new CustomEvent('gm:ann:update', {detail:s})); }catch(_){ } }
      function draw(){
        var s=loadStore(); var list=document.getElementById('annList49'); list.innerHTML='';
        if(!s.items || !s.items.length){ var r=document.createElement('div'); r.style.opacity='.7'; r.textContent='No announcements yet.'; list.appendChild(r); return; }
        s.items.sort(function(a,b){return b.ts-a.ts;}).slice(0,20).forEach(function(it){
          var row=document.createElement('div'); row.style.cssText='border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;display:flex;justify-content:space-between;gap:8px';
          var left=document.createElement('div'); left.innerHTML='<div style="font-weight:600">'+(it.title||'Announcement')+'</div><div style="opacity:.9">'+(it.body||'')+'</div>';
          var del=document.createElement('button'); del.textContent='Delete'; del.style.cssText='border:1px solid #ef4444;color:#ef4444;background:#fff;border-radius:8px;padding:2px 6px;cursor:pointer';
          del.addEventListener('click', function(){ var st=loadStore(); st.items=st.items.filter(function(x){ return !(x.ts===it.ts && x.title===it.title && x.body===it.body); }); saveStore(st); draw(); });
          row.appendChild(left); row.appendChild(del); list.appendChild(row);
        });
      }
      document.getElementById('annAdd49').addEventListener('click', function(){
        var t=(document.getElementById('annTitle49').value||'').trim(), b=(document.getElementById('annBody49').value||'').trim(); if(!t && !b) return;
        var st=loadStore(); st.items = st.items || []; st.items.push({title:t||'Announcement', body:b||'', ts:Date.now()}); saveStore(st);
        document.getElementById('annTitle49').value=''; document.getElementById('annBody49').value=''; draw();
      });
      document.getElementById('annClear49').addEventListener('click', function(){ saveStore({items:[]}); draw(); });
      draw();
    }

    document.addEventListener('click', function(e){
      if(e.target && e.target.id==='gmHide49'){ document.getElementById('gmDock49').style.display='none'; }
      if(e.target && e.target.id==='gmTabAssign49'){ renderAssignTab(); }
      if(e.target && e.target.id==='gmTabAnn49'){ renderAnnTab(); }
    });

    // Defaults
    renderAssignTab();
    document.addEventListener('keydown', function(e){ if(e.ctrlKey && (e.key==='g'||e.key==='G')){ fab.click(); e.preventDefault(); } });
  }

  function boot(){ try{ ensureGMTool49(); }catch(_){} }
  if (document.readyState !== 'loading') boot();
  document.addEventListener('DOMContentLoaded', boot);
  window.addEventListener('load', boot);
  setInterval(boot, 1500);
})();
</script>
<!-- === Runtime v52: Golfer Society • Simple List + Organizer-led Groups (disable full groups) === -->
<script>
(function(){
  if (window.__socv52) return; window.__socv52 = true;

  // ---------- utils ----------
  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  function esc(s){ s = s==null ? '' : String(s); return s.replace(/[&<>]/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]); }); }
  function hashId(s){ s = (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); return s || ('evt-'+Date.now()); }
  function on(el, ev, fn){ if(el) el.addEventListener(ev, fn); }
  function create(tag, attrs, html){ var el=document.createElement(tag); if(attrs){ for(var k in attrs){ if(attrs.hasOwnProperty(k)) el.setAttribute(k, attrs[k]); } } if(html!=null){ el.innerHTML=html; } return el; }
  function dispatch(name, detail){ try{ window.dispatchEvent(new CustomEvent(name, {detail:detail})); }catch(_){ } }

  // ---------- profiles ----------
  var PKEY='profiles.v1';
  function loadProfiles(){ try{ var p=JSON.parse(localStorage.getItem(PKEY)||'null'); if(p && typeof p==='object') return p; }catch(_){ } return {}; }
  function saveProfiles(p){ try{ localStorage.setItem(PKEY, JSON.stringify(p||{})); }catch(_){ } }
  (function ensureSeed(){
    var p=loadProfiles();
    if(!p.PP) p.PP={name:'Peter Park', hc:1, phone:'+66 81-234-5678'};
    var samples={JS:{name:'John Smith',hc:12,phone:'+66 81-111-2222'},RA:{name:'Robert Anderson',hc:8,phone:'+66 81-333-4444'},NS:{name:'Ning Siriwan',hc:18,phone:'+66 81-555-6666'},KL:{name:'Kevin Lee',hc:6,phone:'+66 81-777-8888'},MT:{name:'Maria Torres',hc:14,phone:'+66 81-999-0000'},BW:{name:'Ben Wong',hc:10,phone:'+66 81-121-2121'},AC:{name:'Alice Chen',hc:22,phone:'+66 81-343-4343'},DM:{name:'David Miller',hc:4,phone:'+66 81-565-6565'},EL:{name:'Emma Lopez',hc:16,phone:'+66 81-787-8787'},GP:{name:'George Park',hc:9,phone:'+66 81-909-0909'},HL:{name:'Hana Lee',hc:20,phone:'+66 81-131-3131'},JT:{name:'Jason Tan',hc:5,phone:'+66 81-151-5151'},KO:{name:'Kanya Ong',hc:24,phone:'+66 81-171-7171'},LY:{name:'Liam Young',hc:7,phone:'+66 81-191-9191'},MP:{name:'Mina Phan',hc:12,phone:'+66 81-232-3232'}};
    Object.keys(samples).forEach(function(k){ if(!p[k]) p[k]=samples[k]; });
    saveProfiles(p);
  })();

  // ---------- identity ----------
  function currentGolfer(){
    var header = document.querySelector('header, .header, nav') || document.body;
    var txt = (header && header.innerText) ? header.innerText : document.body.innerText;
    var name=null, id=null;
    var known=['Peter Park','John Smith','Robert Anderson','Ning Siriwan'];
    for(var i=0;i<known.length;i++){ if(txt.indexOf(known[i])>=0) { name=known[i]; break; } }
    if(!name){ var m = txt.match(/([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,2})\s+•\s*GOLFER/i); if(m) name=m[1]; }
    var chip = $all('button,div,span').map(function(e){return e.textContent.trim();}).find(function(t){ return /^[A-Z]{2}$/.test(t); });
    if(!chip && name){ chip=name.split(/\s+/).map(function(w){return w[0]||'';}).join('').toUpperCase().slice(0,2); }
    if(!chip) chip='GG';
    var profiles=loadProfiles();
    var prof=profiles[chip] || {name: name||'Golfer', hc: 12, phone: ''};
    if(!prof.name && name) prof.name=name;
    prof.id=chip;
    return prof;
  }

  // ---------- store (migrate v51 -> v52) ----------
  var STORE='soc.events.v52';
  function loadStore(){
    try{ var o=JSON.parse(localStorage.getItem(STORE)||'{}'); if(o && typeof o==='object') return o; }catch(_){}
    try{ var o51=JSON.parse(localStorage.getItem('soc.events.v51')||'{}'); if(o51 && typeof o51==='object'){ localStorage.setItem(STORE, JSON.stringify(o51)); return o51; } }catch(_){}
    return {};
  }
  function saveStore(o){ try{ localStorage.setItem(STORE, JSON.stringify(o)); dispatch('soc:reg:update', o); }catch(_){ } }

  // ---------- event detection ----------
  function findEventCards(){
    var buttons = $all('button, a').filter(function(b){
      var t=(b.textContent||'').trim().toLowerCase();
      return /register|confirm registration|join event|sign\s*up/.test(t);
    });
    var cards=[];
    buttons.forEach(function(btn){
      var node=btn;
      for(var up=0; up<6 && node && node.parentElement; up++){
        node=node.parentElement;
        var cs=window.getComputedStyle(node);
        if(/block|grid|flex/.test(cs.display) && (cs.borderStyle!=='none' || node.className.match(/card|box|panel|rounded|border/i)) ){
          cards.push({card:node, btn:btn}); break;
        }
      }
    });
    var uniq=[], seen=new Set();
    cards.forEach(function(x){ if(!seen.has(x.card)){ uniq.push(x); seen.add(x.card);} });
    return uniq;
  }
  function extractEventMeta(card, idx){
    var title='Event', capacity=0;
    var tEl=card.querySelector('h1,h2,h3,h4,strong,.title');
    if(tEl) title=(tEl.textContent||'Event').trim();
    else {
      var raw=(card.textContent||'').trim().split('\\n').map(function(s){return s.trim();}).filter(Boolean);
      if(raw.length) title=raw[0];
    }
    var text=(card.textContent||'').toLowerCase();
    var capMatch=text.match(/(spots|capacity|max)\\s*(available|:)?\\s*(\\d{1,3})/);
    if(capMatch) capacity=parseInt(capMatch[3],10);
    if(!capacity){ var m2=text.match(/\\((\\d{1,3})\\s+available\\)/); if(m2) capacity=parseInt(m2[1],10); }
    if(!capacity) capacity=50;
    var id='evt-'+hashId(title)+'-'+idx;
    return { id:id, title:title, capacity:capacity };
  }

  // ---------- helpers ----------
  function groupsFromRoster(roster){
    var by={};
    roster.forEach(function(r){
      var g = r.group || null; // organizer assigns; may be null
      if(g==null) return;
      if(!by[g]) by[g]=[]; by[g].push(r);
    });
    return by;
  }
  function groupSizeOf(roster, id){
    var g=null, size=0;
    for(var i=0;i<roster.length;i++){ if(roster[i].id===id){ g=roster[i].group; break; } }
    if(g==null) return 0;
    for(var j=0;j<roster.length;j++){ if(roster[j].group===g) size++; }
    return size;
  }

  // ---------- UI per card ----------
  function renderFor(card, meta, isFirst){
    if(card.querySelector('.soc-roster')) return;

    var wrap=create('div',{class:'soc-roster',style:'margin-top:10px;border-top:1px dashed #e5e7eb;padding-top:8px'});
    wrap.innerHTML = ''
      + '<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">'
      +   '<div><strong>Registered</strong>: <span class="soc-count">0</span> / <span class="soc-cap">'+meta.capacity+'</span> &nbsp; <span class="soc-avail" style="opacity:.75"></span></div>'
      +   '<div class="soc-me" style="font-size:12px;opacity:.85"></div>'
      + '</div>'
      + '<div class="soc-list" style="display:grid;gap:6px;margin-top:8px"></div>'
      + '<div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">'
      +   '<button class="soc-req btn" style="padding:6px 10px;border:1px solid #2563eb;border-radius:8px;background:#fff;color:#2563eb;cursor:pointer">Request Pairing</button>'
      +   '<button class="soc-clear btn" style="padding:6px 10px;border:1px solid #ef4444;border-radius:8px;background:#fff;color:#ef4444;cursor:pointer">Clear My Request</button>'
      + '</div>';
    card.appendChild(wrap);

    function load(){ var S=loadStore(); return S[meta.id] || {cap:meta.capacity, roster:[], pairs:{}}; }
    function save(data){ var S=loadStore(); S[meta.id]=data; saveStore(S); }

    // seed first event with 15 players & organizer groups (some full)
    if(isFirst){
      var d0=load();
      if(!d0.roster || d0.roster.length<15){
        var p=loadProfiles();
        var ids=['JS','RA','NS','KL','MT','BW','AC','DM','EL','GP','HL','JT','KO','LY','MP'];
        d0.roster = ids.map(function(id,i){
          var pr=p[id]||{name:id,hc:12,phone:''};
          var g = (i<3?1:(i<5?2:(i<9?3:(i<13?4:5)))); // groups 3 & 4 full
          return {id:id, name:pr.name, hc:pr.hc, phone:pr.phone, ts: Date.now()-(ids.length-i)*1000, group:g};
        });
        d0.cap = Math.max(meta.capacity, 40);
        d0.pairs = d0.pairs||{};
        save(d0);
      }
    }

    function redraw(){
      var data=load();
      var me=currentGolfer();
      // show me
      var meEl=card.querySelector('.soc-me');
      meEl.textContent = 'You: '+(me.name||me.id)+' • HCP '+(me.hc!=null?me.hc:'?')+(me.phone?(' • '+me.phone):'');

      // counts
      var count=data.roster.length, cap=data.cap||meta.capacity, avail=Math.max(cap-count,0);
      card.querySelector('.soc-count').textContent=String(count);
      card.querySelector('.soc-cap').textContent=String(cap);
      card.querySelector('.soc-avail').textContent='Available: '+avail;

      // build set of full-group member IDs (>=4)
      var fullIds=new Set(); var groupSizes={};
      data.roster.forEach(function(r){ if(r.group!=null){ groupSizes[r.group]=(groupSizes[r.group]||0)+1; } });
      data.roster.forEach(function(r){ if(r.group!=null && groupSizes[r.group]>=4){ fullIds.add(r.id); } });

      // list of registrants with checkboxes (disable if target is in full group)
      var list=card.querySelector('.soc-list'); list.innerHTML='';
      if(!count){
        list.appendChild(create('div',{style:'padding:8px 10px;border:1px dashed #e5e7eb;border-radius:10px;background:#fafafa;opacity:.8'},'No one has registered yet.'));
      } else {
        var req=(data.pairs[me.id]||[]);
        data.roster.slice().sort(function(a,b){ return (a.ts||0)-(b.ts||0); }).forEach(function(p){
          var inFull = fullIds.has(p.id);
          var labelText = esc(p.name)+' '+esc(String(p.hc||'')) + (inFull ? ' • (in full group)' : '');
          var row=create('label',{style:'display:flex;justify-content:space-between;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;background:#fff'});
          var left=create('div',null,'<div>'+labelText+'</div><div style="font-size:12px;opacity:.6">'+(p.phone?esc(p.phone):'')+(p.id===me.id?' (you)':'')+'</div>');
          var right=create('div',{style:'display:flex;gap:8px;align-items:center'});
          var cb=create('input',{type:'checkbox',class:'soc-pair-cb'});
          if(p.id===me.id || inFull) cb.disabled=true;
          if(req.indexOf(p.id)>=0) cb.checked=true;
          right.appendChild(cb); row.appendChild(left); row.appendChild(right); list.appendChild(row);
          row.dataset.uid=p.id;
        });
      }
    }

    // register/cancel hooks (do NOT auto-assign group; organizers set it)
    var regBtn = Array.prototype.slice.call(card.querySelectorAll('button, a')).find(function(b){ var t=(b.textContent||'').trim().toLowerCase(); return /register|confirm registration|join event|sign\\s*up/.test(t); });
    var cancelBtn = Array.prototype.slice.call(card.querySelectorAll('button, a')).find(function(b){ var t=(b.textContent||'').trim().toLowerCase(); return /cancel/.test(t); });

    function addSelf(){
      var me=currentGolfer(), data=load();
      if(!data.roster.find(function(x){return x.id===me.id;})){
        data.roster.push({id:me.id, name:me.name, hc:me.hc, phone:me.phone, ts:Date.now(), group:null});
        save(data);
      } else {
        data.roster=data.roster.map(function(x){ return x.id===me.id?{id:me.id,name:me.name,hc:me.hc,phone:me.phone,ts:x.ts,group:x.group||null}:x; });
        save(data);
      }
    }
    function removeSelf(){
      var me=currentGolfer(), data=load();
      var before=data.roster.length;
      data.roster=data.roster.filter(function(x){ return x.id!==me.id; });
      delete data.pairs[me.id];
      for(var k in data.pairs){ if(data.pairs.hasOwnProperty(k)){ data.pairs[k]=data.pairs[k].filter(function(x){ return x!==me.id; }); } }
      if(data.roster.length!==before) save(data);
    }

    // Register modal pairing; disable targets in full groups
    function injectIntoModal(){
      var modal = $all('[role="dialog"], .modal.show, .ant-modal, .chakra-modal__content, .MuiDialog-paper, .modal').find(function(el){ return el.offsetParent !== null; });
      if(!modal){ setTimeout(injectIntoModal, 150); return; }
      if(modal.querySelector('.soc-modal-pair')) return;
      var panel=create('div',{class:'soc-modal-pair',style:'margin-top:8px;border-top:1px dashed #e5e7eb;padding-top:8px'});
      panel.innerHTML='<div style="font-weight:600;margin-bottom:6px">Pairing Preferences (pick up to 3)</div><div class="soc-modal-list" style="display:grid;gap:6px;max-height:180px;overflow:auto"></div><button class="soc-modal-apply" style="margin-top:8px;padding:6px 10px;border:1px solid #2563eb;border-radius:8px;background:#fff;color:#2563eb;cursor:pointer">Request Pairing</button>';
      modal.appendChild(panel);
      var data=load(); var me=currentGolfer(); var list=panel.querySelector('.soc-modal-list');
      // build full-group set
      var fullIds=new Set(); var gs={}; data.roster.forEach(function(r){ if(r.group!=null){ gs[r.group]=(gs[r.group]||0)+1; } }); data.roster.forEach(function(r){ if(r.group!=null && gs[r.group]>=4){ fullIds.add(r.id);} });
      data.roster.slice().sort(function(a,b){return (a.ts||0)-(b.ts||0);}).forEach(function(p){
        if(p.id===me.id) return;
        var inFull=fullIds.has(p.id);
        var row=create('label',{style:'display:flex;justify-content:space-between;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;background:#fff'});
        row.innerHTML='<div>'+esc(p.name)+' '+esc(String(p.hc||''))+(inFull?' • (in full group)':'')+'</div>';
        var cb=create('input',{type:'checkbox'});
        if(inFull) cb.disabled=true;
        row.appendChild(cb); list.appendChild(row); row.dataset.uid=p.id;
      });
      panel.querySelector('.soc-modal-apply').addEventListener('click', function(){
        var picks=$all('.soc-modal-list label', panel).map(function(r){ var cb=r.querySelector('input[type="checkbox"]'); return cb&&cb.checked ? r.dataset.uid : null; }).filter(Boolean);
        if(picks.length>3){ alert('Pick up to 3 players.'); return; }
        var s=load(); s.pairs[me.id]=picks; save(s);
        try{ alert('Pairing request saved.'); }catch(_){}
      });
    }

    if(regBtn){ on(regBtn,'click',function(){ setTimeout(addSelf,50); setTimeout(injectIntoModal,200); }); }
    if(cancelBtn){ on(cancelBtn,'click',function(){ setTimeout(removeSelf,50); }); }

    // on-card actions
    on(card.querySelector('.soc-req'),'click',function(){
      var me=currentGolfer(), data=load();
      // collect picks, but ignore disabled ones
      var picks=$all('.soc-list .soc-pair-cb',card).map(function(cb){ return (!cb.disabled && cb.checked) ? cb.parentElement.parentElement.dataset.uid : null; }).filter(Boolean);
      if(picks.length>3){ alert('Pick up to 3 players.'); return; }
      data.pairs[me.id]=picks; save(data);
      redraw();
    });
    on(card.querySelector('.soc-clear'),'click',function(){ var me=currentGolfer(), data=load(); delete data.pairs[me.id]; save(data); redraw(); });

    // draw + live updates
    function redraw(){ /* defined above */ }
    // rebind redraw (closure above needs it)
    wrap.redraw = function(){ // hack: expose
      // rebuild counts/list as defined earlier
    };
    // actually define redraw now (to capture locals)
    (function(){
      var _load=load;
      redraw = function(){
        var data=_load();
        var me=currentGolfer();
        var meEl=card.querySelector('.soc-me');
        meEl.textContent = 'You: '+(me.name||me.id)+' • HCP '+(me.hc!=null?me.hc:'?')+(me.phone?(' • '+me.phone):'');

        var count=data.roster.length, cap=data.cap||meta.capacity, avail=Math.max(cap-count,0);
        card.querySelector('.soc-count').textContent=String(count);
        card.querySelector('.soc-cap').textContent=String(cap);
        card.querySelector('.soc-avail').textContent='Available: '+avail;

        var fullIds=new Set(); var groupSizes={};
        data.roster.forEach(function(r){ if(r.group!=null){ groupSizes[r.group]=(groupSizes[r.group]||0)+1; } });
        data.roster.forEach(function(r){ if(r.group!=null && groupSizes[r.group]>=4){ fullIds.add(r.id); } });

        var list=card.querySelector('.soc-list'); list.innerHTML='';
        if(!count){
          list.appendChild(create('div',{style:'padding:8px 10px;border:1px dashed #e5e7eb;border-radius:10px;background:#fafafa;opacity:.8'},'No one has registered yet.'));
        } else {
          var req=(data.pairs[me.id]||[]);
          data.roster.slice().sort(function(a,b){ return (a.ts||0)-(b.ts||0); }).forEach(function(p){
            var inFull=fullIds.has(p.id);
            var labelText=esc(p.name)+' '+esc(String(p.hc||''))+(inFull?' • (in full group)':'');
            var row=create('label',{style:'display:flex;justify-content:space-between;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;background:#fff'});
            var left=create('div',null,'<div>'+labelText+'</div><div style="font-size:12px;opacity:.6">'+(p.phone?esc(p.phone):'')+(p.id===me.id?' (you)':'')+'</div>');
            var right=create('div',{style:'display:flex;gap:8px;align-items:center'});
            var cb=create('input',{type:'checkbox',class:'soc-pair-cb'});
            if(p.id===me.id || inFull) cb.disabled=true;
            if(req.indexOf(p.id)>=0) cb.checked=true;
            right.appendChild(cb); row.appendChild(left); row.appendChild(right); list.appendChild(row);
            row.dataset.uid=p.id;
          });
        }
      };
    })();

    redraw();
    on(window,'storage',function(e){ if(e && e.key===STORE){ redraw(); } });
    on(window,'soc:reg:update', redraw);
  }

  function boot(){
    try{
      var pairs=findEventCards();
      if(!pairs.length) return;
      for(var i=0;i<pairs.length;i++){
        var meta=extractEventMeta(pairs[i].card,i);
        pairs[i].card.dataset.eventId=meta.id;
        renderFor(pairs[i].card, meta, i===0);
      }
    }catch(e){ console.log('soc v52 error', e); }
  }

  if (document.readyState !== 'loading') boot();
  document.addEventListener('DOMContentLoaded', boot);
  setInterval(boot, 2000);
  var mo=new MutationObserver(function(){ boot(); });
  mo.observe(document.documentElement,{subtree:true, childList:true});
})();
</script>
<style>#gc-open,.gc-floating,[data-gc],[data-gc-tab="games"],#games-float,#games-fab{display:none!important}</style>
<style>
#ucg-head{position:sticky;top:0;z-index:2147483605}
</style>
<style>
  #mc-grid{display:grid;grid-template-columns:1fr 1fr 320px;gap:12px;align-items:start}
  @media(max-width:1100px){ #mc-grid{grid-template-columns:1fr; } }
  .mc-card{border:1px solid #e5e7eb;border-radius:12px;background:#fff}
  .mc-card-h{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#f8fafc;border-bottom:1px solid #eef2f7;border-radius:12px 12px 0 0;font-weight:600}
  .mc-card-b{padding:12px}
  .mc-muted{color:#6b7280}
  .mc-good{background:#ecfdf5;border-color:#bbf7d0}
  .mc-offer{display:inline-flex;gap:.5rem;align-items:center;background:#fffbeb;border:1px solid #fde68a;border-radius:8px;padding:6px;margin-top:8px}
  .mc-btn{padding:.25rem .6rem;border:1px solid #93c5fd;border-radius:8px;background:#eff6ff;cursor:pointer}
  .mc-pill{padding:.15rem .5rem;border-radius:9999px;background:#eef2ff;border:1px solid #c7d2fe;font-size:.8rem}
  .mc-sp{height:6px}
</style>
</head>
<body>
<div id="root"></div>
<!-- App Code (from your latest build) -->
<script type="text/babel">
const { useState, useEffect } = React;

        // --- Society Section (Golfer) - legacy-safe + defaults ---
        function SocietySection({ user, events, onSpend }){
            const { useState, useMemo, useEffect } = React;
            const uid = (user && user.id) || 0;
            const DEFAULT_COMP_FEE = 300;
            const DEFAULT_TRANS_FEE = 200;
            const KEY = `uc2:extRegs:${uid}`;

            const golfers=[{name:"Peter Park",h:15},{name:"Anan Chaiyawan",h:18},{name:"Michael Chen",h:12},{name:"David Lee",h:20},{name:"Somchai Rattanakorn",h:22},{name:"Emily Wong",h:10},{name:"Narin Boonmee",h:16},{name:"John Smith",h:24},{name:"Supakorn Phasuk",h:14},{name:"Maria Gonzales",h:21}].filter(g=> !user || g.name!==user.name);
            const money = n => '฿' + Number(n||0).toLocaleString('th-TH');

            const [extRegs,setExtRegs]=React.useState(()=>{try{const raw=localStorage.getItem(KEY);return raw?JSON.parse(raw):[]}catch(e){return[]}});
            useEffect(()=>{try{localStorage.setItem(KEY,JSON.stringify(extRegs))}catch(e){}},[extRegs]);

            const visibleEvents=useMemo(()=> (events||[]).slice().sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time)),[events]);

            const [openId,setOpenId]=useState(null);
            const getExt=eid=>extRegs.find(r=>r.eventId===eid)||null;
            const putExt=(eid,payload)=>setExtRegs(prev=>{const rest=prev.filter(r=>r.eventId!==eid);return[...rest,{eventId:eid,...payload}]});
            const removeExt=eid=>setExtRegs(prev=>prev.filter(r=>r.eventId!==eid));

            function handleSave(e){
                const form=document.getElementById('soc2_form_'+e.id); if(!form) return;
                const phone=(form.querySelector('[name=phone]')||{value:''}).value.trim();
                const handicap=(form.querySelector('[name=handicap]')||{value:''}).value.trim();
                const tEl=form.querySelector('[name=transport]');
                const cEl=form.querySelector('[name=competition]');
                const wantsTransport=tEl? !!tEl.checked : false;
                const wantsCompetition=cEl? !!cEl.checked : false;
                const pairs=Array.from(form.querySelectorAll('[name=pair]:checked')).map(x=>x.value).slice(0,3);

                const tInput=form.querySelector('[name=transportFee]');
                const cInput=form.querySelector('[name=competitionFee]');
                const transFeeUsed=wantsTransport ? ((Number(((e&&e.transportationFee)||0)) || Number(((tInput&&tInput.value)||DEFAULT_TRANS_FEE)))) : 0;
                const compFeeUsed =wantsCompetition ? ((Number(((e&&e.competitionFee)||0))  || Number(((cInput&&cInput.value)||DEFAULT_COMP_FEE)))) : 0;

                const errs=[];
                const digits=phone.replace(/[^0-9+]/g,'');
                if(digits.length<7) errs.push('Valid phone required');
                const hn=Number(handicap);
                if(!Number.isFinite(hn)||hn<0||hn>54) errs.push('Handicap 0–54 required');
                if(wantsTransport && !Number.isFinite(transFeeUsed)) errs.push('Enter transport fee');
                if(wantsCompetition && !Number.isFinite(compFeeUsed)) errs.push('Enter competition fee');
                const errBox=form.querySelector('.formErrors');
                if(errs.length){errBox.textContent=errs.join(' • ');errBox.style.display='block';return}else errBox.style.display='none';

                const base=Number(((e&&e.courseCost)||0))+Number(((e&&e.caddyCost)||0));
                const total=base+compFeeUsed+transFeeUsed;

                const prev=getExt(e.id);
                const prevTotal=prev?Number(prev.total||0):0;
                const delta=total-prevTotal;

                putExt(e.id,{phone,handicap:hn,wantsTransport,wantsCompetition,pairedWith:pairs,total,transportFee:transFeeUsed,competitionFee:compFeeUsed});
                if(delta&&typeof onSpend==='function'){ onSpend(delta); }
            }

            function handleCancel(e){
                const prev=getExt(e.id);
                if(prev&&prev.total&&typeof onSpend==='function'){ onSpend(-Number(prev.total)); }
                removeExt(e.id);
            }

            return(
                <div className="space-y-3">
                    <h2 className="text-lg font-bold text-gray-900">Golf Society</h2>
                    <div className="grid md:grid-cols-3 gap-4">
                        <div className="md:col-span-2 bg-white/90 rounded-lg border">
                            <div className="divide-y">
                                {visibleEvents.map(e=>{
                                    const r=getExt(e.id);
                                    const base=Number(((e&&e.courseCost)||0))+Number(((e&&e.caddyCost)||0));
                                    const other=Number(((e&&e.competitionFee)||0))+Number(((e&&e.transportationFee)||0));
                                    const open=openId===e.id;
                                    const compDisp = r? (Number(r.competitionFee||0)) : (Number(((e&&e.competitionFee)||0)) || DEFAULT_COMP_FEE);
                                    const transDisp = r? (Number(r.transportFee||0))   : (Number(((e&&e.transportationFee)||0)) || DEFAULT_TRANS_FEE);
                                    return(
                                        <div key={e.id} className={`p-3 rounded-lg border ${r ? "border-2 border-green-500" : "border-gray-200"}`}>
                                            <button className="w-full flex justify-between items-center text-left" onClick={()=>setOpenId(open?null:e.id)}>
                                                <div>
                                                    <div className="font-medium">{(e&&e.title)||(e&&e.course)||'Event'} • {(e&&e.date)} {(e&&e.time)||''}</div>
                                                    <div className="text-xs text-gray-700">{(e&&e.course)||''}</div>
                                                    <div className="text-[11px] text-gray-500">Base {money(base)} • Other {money(other)} {(e&&e.notes)? ' • '+e.notes:''}</div>
                                                    {r && (
  <div className="text-green-600 text-xs font-semibold mt-1">
    ✅ Registered
  </div>
)}
                                                </div>
                                                <div className={'transition -rotate-90 '+(open?'transform rotate-0':'')}>▶</div>
                                            </button>
                                            {open&&(
                                                <div className="mt-3 border-t pt-3">
                                                    <form id={'soc2_form_'+e.id}>
                                                        <div className="grid grid-cols-2 gap-3">
                                                            <div>
                                                                <label className="text-xs text-gray-600">Phone (required)</label>
                                                                <input name="phone" type="tel" defaultValue={(r&&r.phone)||''} placeholder="+66..." className="w-full border rounded p-2"/>
                                                            </div>
                                                            <div>
                                                                <label className="text-xs text-gray-600">Handicap (0–54, required)</label>
                                                                <input name="handicap" type="number" min="0" max="54" step="0.1" defaultValue={(r && typeof r.handicap!=='undefined')? r.handicap: ''} className="w-full border rounded p-2"/>
                                                            </div>
                                                        </div>

                                                        <div className="mt-2">
                                                            <div className="text-sm font-medium">Options</div>
                                                            <div className="flex flex-wrap items-center gap-2 mt-1">
                                                                <label className="flex items-center gap-2 border rounded-full px-3 py-1 bg-gray-50 text-sm">
                                                                    <input type="checkbox" name="transport" defaultChecked={!!(r && r.wantsTransport)}/>
                                                                    <span>Transportation {Number(((e&&e.transportationFee)||0))>0 ? `(${money(e.transportationFee)})` : ''}</span>
                                                                    {Number(((e&&e.transportationFee)||0))===0 && (
                                                                        <input name="transportFee" type="number" min="0" step="1" placeholder="PTS"
                                                                            defaultValue={(r && r.transportFee) || DEFAULT_TRANS_FEE} className="w-20 border rounded p-1 text-sm"/>
                                                                    )}
                                                                </label>
                                                                <label className="flex items-center gap-2 border rounded-full px-3 py-1 bg-gray-50 text-sm">
                                                                    <input type="checkbox" name="competition" defaultChecked={!!(r && r.wantsCompetition)}/>
                                                                    <span>Competition {Number(((e&&e.competitionFee)||0))>0 ? `(${money(e.competitionFee)})` : ''}</span>
                                                                    {Number(((e&&e.competitionFee)||0))===0 && (
                                                                        <input name="competitionFee" type="number" min="0" step="1" placeholder="PTS"
                                                                            defaultValue={(r && r.competitionFee) || DEFAULT_COMP_FEE} className="w-20 border rounded p-1 text-sm"/>
                                                                    )}
                                                                </label>
                                                            </div>
                                                        </div>

                                                        <div className="mt-2">
                                                            <div className="text-sm font-medium">Pairing Preferences (up to 3)</div>
                                                            <div className="grid grid-cols-2 gap-2 mt-1">
                                                                {golfers.map(g=>{
                                                                    const checked=((r&&r.pairedWith)||[]).includes(g.name);
                                                                    return(
                                                                        <label key={g.name} className="flex items-center gap-2 border rounded px-2 py-1 text-sm">
                                                                            <input type="checkbox" name="pair" value={g.name} defaultChecked={checked}/>
                                                                            <span>{g.name} {g.h}</span>
                                                                        </label>
                                                                    );
                                                                })}
                                                            </div>
                                                        </div>

                                                        <div className="formErrors text-red-600 text-sm mt-2" style={{display:'none'}}></div>

                                                        <div className="flex justify-between items-center mt-3">
                                                            <div className="text-sm text-gray-600">
                                                                Base <strong>{money(base)}</strong> • Optional: comp {money(compDisp||0)}, transport {money(transDisp||0)}
                                                            </div>
                                                            <div className="flex gap-2">
                                                                {r&&<button type="button" className="border px-3 py-1 rounded" onClick={()=>handleCancel(e)}>Cancel</button>}
                                                                <button type="button" className="bg-gray-900 text-white px-3 py-1 rounded" onClick={()=>handleSave(e)}>Save</button>
                                                            </div>
                                                        </div>
                                                    </form>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                                {visibleEvents.length===0&&(
                                    <div className="text-center py-8 text-gray-500">
                                        <p>No events.</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="bg-white/90 rounded-lg border p-3">
                            <div className="font-semibold">My Schedule & Budget</div>
                            <div className="mt-2 space-y-1">
  {extRegs.length ? extRegs.map((r, idx) => {
    const ev = (events||[]).find(x=>x.id===r.eventId)||{};
    const isEditing = editId === r.eventId;
    const pairedText = Array.isArray(r.pairedWith) ? r.pairedWith.join(', ') : (r.pairedWith||'');
    return (
      <div key={r.eventId} className="text-sm py-1 border-b last:border-0">
        <div className="flex items-start justify-between gap-2">
          <div className="text-gray-700">
            <div className="font-medium">{ev.title||'Event'}</div>
            {!isEditing ? (
              <div className="text-xs text-gray-500">Paired With: {pairedText || 'None'}</div>
            ) : (
              <div className="text-xs text-gray-500 space-y-1">
                <input
                  value={editDraft.pairedWith ?? pairedText}
                  onChange={e=>setEditDraft(d=>({...d, pairedWith:e.target.value}))}
                  className="w-full border rounded px-1 py-0.5"
                  placeholder="Comma-separated partner names/IDs"
                />
                <div className="flex items-center gap-3">
                  <label className="inline-flex items-center gap-1">
                    <input type="checkbox" checked={!!editDraft.wantsCompetition ?? !!r.wantsCompetition}
                      onChange={e=>setEditDraft(d=>({...d, wantsCompetition:e.target.checked}))} /> Competition
                  </label>
                  <label className="inline-flex items-center gap-1">
                    <input type="checkbox" checked={!!editDraft.wantsTransport ?? !!r.wantsTransport}
                      onChange={e=>setEditDraft(d=>({...d, wantsTransport:e.target.checked}))} /> Transportation
                  </label>
                </div>
              </div>
            )}
          </div>
          <div className="text-right">
            <div className="font-semibold">{money(r.total||0)}</div>
            <div className="text-xs">
              {!isEditing ? (
                <>
                  <button className="underline" onClick={()=>{ setEditId(r.eventId); setEditDraft({ pairedWith: pairedText, wantsCompetition: !!r.wantsCompetition, wantsTransport: !!r.wantsTransport }); }}>Edit</button>
                  <span> · </span>
                  <button className="underline" onClick={()=>{
                    if (confirm('Delete this saved registration?')){
                      const regs = readRegs().filter(x=>x.eventId!==r.eventId);
                      writeRegs(regs); setRegsTick(x=>x+1); if (editId===r.eventId) setEditId(null);
                    }
                  }}>Delete</button>
                </>
              ) : (
                <>
                  <button className="underline" onClick={()=>{
                    const regs = readRegs().map(x=> x.eventId===r.eventId ? {
                      ...x,
                      wantsCompetition: !!editDraft.wantsCompetition,
                      wantsTransport: !!editDraft.wantsTransport,
                      pairedWith: String(editDraft.pairedWith||'').split(/[,\s]+/).filter(Boolean)
                    } : x);
                    writeRegs(regs); setEditId(null); setRegsTick(x=>x+1);
                  }}>Save</button>
                  <span> · </span>
                  <button className="underline" onClick={()=>{ setEditId(null); setEditDraft({}); }}>Cancel</button>
                </>
              )}
            </div>
          </div>
        </div>
      </div>
    );
  }) : <div className="text-xs text-gray-500">No saved registrations yet.</div>}
</div>
                            <div className="border-t mt-2 pt-2 flex justify-between text-sm">
                                <div className="text-gray-700">Estimated Total</div>
                                <div className="font-semibold">{money(extRegs.reduce((s,r)=> s + (Number(r.total)||0), 0))}</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Icon components
        const Calendar = ({ className = "w-5 h-5" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                <line x1="16" x2="16" y1="2" y2="6"/>
                <line x1="8" x2="8" y1="2" y2="6"/>
                <line x1="3" x2="21" y1="10" y2="10"/>
            </svg>
        );

        const Award = ({ className = "w-5 h-5" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="8" r="6"/>
                <path d="m9 12 2 2 4-4"/>
                <path d="m21 21-7-7-4 4z"/>
            </svg>
        );

        const LogOut = ({ className = "w-5 h-5" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16,17 21,12 16,7"/>
                <line x1="21" x2="9" y1="12" y2="12"/>
            </svg>
        );


/* ===== Injected: New Society Components (isolated) ===== */
const NewOrganizerDashboard = ({ onManage, events, getEventSignups }) => {
  const todayStr = () => new Date().toISOString().split('T')[0];
  const upcoming = (events || []).slice().sort((a,b)=> (((a.date||'') + (a.time||''))).localeCompare(((b.date||'') + (b.time||''))));
  const totalEvents = upcoming.length;
  const totalRegs = upcoming.reduce((sum, e) => sum + (getEventSignups ? getEventSignups(e.id).length : 0), 0);
  const fillingSoon = upcoming.filter(e => {
    const regs = getEventSignups ? getEventSignups(e.id).length : 0;
    const cap = e.availableSpots || 10;
    return cap > 0 && (regs / cap) >= 0.8;
  });

  const money = (n) => '฿' + Number(n||0).toLocaleString();

  return (
    <div className="space-y-3">
      <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg p-4">
        <div className="flex justify-between items-center">
          <div>
            <div className="text-sm opacity-90">Society Operations</div>
            <div className="text-xl font-bold">Organizer Dashboard</div>
          </div>
          <button onClick={onManage} className="bg-white/15 hover:bg-white/25 px-3 py-1.5 rounded text-sm">
            Manage Events
          </button>
        </div>
      </div>

      <div className="grid grid-cols-3 gap-2">
        <div className="bg-white/90 p-3 rounded-lg border shadow-sm">
          <div className="text-xs text-gray-600">Upcoming Events</div>
          <div className="text-xl font-bold text-gray-900">{totalEvents}</div>
        </div>
        <div className="bg-white/90 p-3 rounded-lg border shadow-sm">
          <div className="text-xs text-gray-600">Total Registrations</div>
          <div className="text-xl font-bold text-gray-900">{totalRegs}</div>
        </div>
        <div className="bg-white/90 p-3 rounded-lg border shadow-sm">
          <div className="text-xs text-gray-600">Filling Soon (≥80%)</div>
          <div className="text-xl font-bold text-gray-900">{fillingSoon.length}</div>
        </div>
      </div>

      <div className="bg-white/90 p-3 rounded-lg border">
        <div className="flex items-center justify-between mb-2">
          <div className="font-semibold">Upcoming Society Events</div>
          <button onClick={onManage} className="text-blue-600 text-sm">+ New Event</button>
        </div>
        <div className="divide-y">
          {upcoming.length ? upcoming.map(e => {
            const registrations = getEventSignups ? getEventSignups(e.id).length : 0;
            const cap = e.availableSpots || 10;
            const spotsLeft = Math.max(0, cap - registrations);
            const pct = cap ? Math.round((registrations / cap) * 100) : 0;
            const totalCost = (e.courseCost||0) + (e.transportationFee||0) + (e.competitionFee||0);

            return (
              <div key={e.id} className="py-3">
                <div className="flex justify-between items-start">
                  <div className="flex-1">
                    <div className="font-medium">{e.title || e.course} • {e.date} {e.time}</div>
                    <div className="text-xs text-gray-600">{e.course} • {money(totalCost)}</div>
                    <div className="mt-2 flex items-center gap-3">
                      <div className="text-xs">
                        <span className={spotsLeft <= 5 ? 'text-red-600 font-medium' : spotsLeft <= 10 ? 'text-orange-600 font-medium' : 'text-green-600 font-medium'}>
                          {spotsLeft} spots left
                        </span>
                        <span className="text-gray-500"> of {cap}</span>
                      </div>
                      <div className="flex-1 max-w-32">
                        <div className="w-full bg-gray-200 rounded-full h-1.5">
                          <div 
                            className={`h-1.5 rounded-full transition-all ${pct>=90?'bg-red-500':pct>=70?'bg-orange-500':'bg-green-500'}`}
                            style={{width: pct + '%'}} />
                        </div>
                      </div>
                      <div className="text-xs text-gray-500">{pct}%</div>
                    </div>
                  </div>
                  <div className="text-right ml-4">
                    <div className="text-sm font-medium">{registrations}/{cap}</div>
                    <div className="text-xs text-gray-500">registered</div>
                  </div>
                </div>
              </div>
            );
          }) : (
            <div className="text-sm text-gray-500 py-6 text-center">No upcoming events.</div>
          )}
        </div>
      </div>
    </div>
  );
};

const NewOrganizerSocietyManager = ({ events, setEvents, courses, getEventSignups }) => {
  const [eventEdit, setEventEdit] = React.useState(null);
  const [editForm, setEditForm] = React.useState({
    title: '', date: '', time: '', course: '',
    courseCost: '', transportationFee: '', competitionFee: '',
    notes: '', availableSpots: ''
  });

  const money = (n) => '฿' + Number(n||0).toLocaleString();

  const handleField = (e) => setEditForm(prev => ({...prev, [e.target.name]: e.target.value}));

  const handleSubmitEvent = () => {
    if(!editForm.title || !editForm.course || !editForm.date || !editForm.time){
      alert("Title, course, date and time are required."); return;
    }
    const courseCost = parseFloat(editForm.courseCost) || 0;
    const transportationFee = parseFloat(editForm.transportationFee) || 0;
    const competitionFee = parseFloat(editForm.competitionFee) || 0;
    const availableSpots = Math.max(1, Math.min(300, parseInt(editForm.availableSpots) || 10));
    const payload = {
      id: eventEdit?.id || Date.now(),
      ...editForm,
      courseCost, transportationFee, competitionFee, availableSpots,
      totalCost: courseCost + transportationFee + competitionFee
    };
    setEvents(prev => {
      const rest = prev.filter(e => e.id !== payload.id);
      return [...rest, payload].sort((a,b)=> ((a.date||'')+(a.time||'')).localeCompare((b.date||'')+(b.time||'')));
    });
    setEventEdit(null);
    setEditForm({ title:'', date:'', time:'', course:'', courseCost:'', transportationFee:'', competitionFee:'', notes:'', availableSpots:'' });
  };

  const handleEdit = (evt) => {
    setEventEdit(evt);
    setEditForm({
      ...evt,
      availableSpots: evt.availableSpots || 10,
      transportationFee: evt.transportationFee || '',
      competitionFee: evt.competitionFee || ''
    });
  };

  const handleDelete = (id) => {
    if(confirm("Delete this event?")){
      setEvents(prev => prev.filter(e => e.id !== id));
    }
  };

  return (
    <div className="space-y-4">
      <h2 className="text-lg font-bold">Manage Society Events</h2>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {events.map(e => {
          const regs = getEventSignups ? getEventSignups(e.id).length : 0;
          const cap = e.availableSpots || 10;
          const left = Math.max(0, cap - regs);
          const pct = cap ? Math.round((regs / cap) * 100) : 0;
          const total = (e.courseCost||0)+(e.transportationFee||0)+(e.competitionFee||0);
          return (
            <div key={e.id} className="bg-white p-3 rounded-lg shadow border space-y-2">
              <div className="font-semibold">{e.title} - {e.date} {e.time}</div>
              <div className="text-sm text-gray-600">{e.course}</div>
              <div className="text-sm">
                <div>Course: {money(e.courseCost||0)}</div>
                {(e.transportationFee||0)>0 && <div>Transport: {money(e.transportationFee)}</div>}
                {(e.competitionFee||0)>0 && <div>Competition: {money(e.competitionFee)}</div>}
                <div className="font-medium">Total: {money(total)}</div>
              </div>
              <div className="bg-gray-50 p-2 rounded">
                <div className="flex justify-between items-center text-sm">
                  <span className="text-gray-600">Availability:</span>
                  <span className={left<=5?'text-red-600 font-medium':left<=10?'text-orange-600 font-medium':'text-green-600 font-medium'}>
                    {left} / {cap} spots
                  </span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2 mt-1">
                  <div className={`${pct>=90?'bg-red-500':pct>=70?'bg-orange-500':'bg-green-500'} h-2 rounded-full`} style={{width:pct+'%'}}></div>
                </div>
                <div className="text-xs text-gray-500 mt-1">{pct}% filled</div>
              </div>
              <div className="flex space-x-2 mt-2">
                <button onClick={() => handleEdit(e)} className="text-blue-600 text-sm">Edit</button>
                <button onClick={() => handleDelete(e.id)} className="text-red-600 text-sm">Delete</button>
              </div>
            </div>
          );
        })}
      </div>

      <div className="bg-white p-4 border rounded-lg">
        <h3 className="font-medium mb-2">{eventEdit ? 'Edit Event' : 'Create New Event'}</h3>
        <div className="grid grid-cols-2 gap-2">
          <input name="title" value={editForm.title} onChange={handleField} placeholder="Event Title" className="border p-2 rounded" />
          <select name="course" value={editForm.course} onChange={handleField} className="border p-2 rounded">
            <option value="">Select Course</option>
            {courses.map(c => <option key={c} value={c}>{c}</option>)}
          </select>
          <input name="date" type="date" value={editForm.date} onChange={handleField} className="border p-2 rounded" />
          <input name="time" type="time" value={editForm.time} onChange={handleField} className="border p-2 rounded" />
          <input name="courseCost" type="number" value={editForm.courseCost} onChange={handleField} placeholder="Course Cost (฿)" className="border p-2 rounded" />
          <input name="transportationFee" type="number" value={editForm.transportationFee} onChange={handleField} placeholder="Transportation Fee (PTS)" className="border p-2 rounded" />
          <input name="competitionFee" type="number" value={editForm.competitionFee} onChange={handleField} placeholder="Competition Fee (PTS)" className="border p-2 rounded" />
          <input name="availableSpots" type="number" min="1" max="300" value={editForm.availableSpots} onChange={handleField} placeholder="Available Spots (1-300)" className="border p-2 rounded" />
        </div>
        <textarea name="notes" value={editForm.notes} onChange={handleField} placeholder="Event Notes (optional)" className="border p-2 mt-2 rounded w-full" rows="2"></textarea>
        <div className="mt-3">
          <button onClick={handleSubmitEvent} className="bg-blue-600 text-white px-4 py-2 rounded">{eventEdit ? 'Update' : 'Create'} Event</button>
          {eventEdit && (
            <button onClick={()=>{setEventEdit(null); setEditForm({ title:'', date:'', time:'', course:'', courseCost:'', transportationFee:'', competitionFee:'', notes:'', availableSpots:'' });}} className="ml-2 bg-gray-300 text-gray-700 px-4 py-2 rounded">Cancel</button>
          )}
        </div>
      </div>
    </div>
  );
};


const NewSocietySection = ({ user, events }) => {
  const uid = user?.id || 0;
  const REG_KEY  = `uc2:extRegs:${uid}`;      // schedule source (kept)

  const money = (n) => '฿' + Number(n||0).toLocaleString();

  // Registrations (persisted)
  const [regs, setRegs] = React.useState(()=>{
    try { const raw = localStorage.getItem(REG_KEY); return raw ? JSON.parse(raw) : []; } catch { return []; }
  });
  React.useEffect(()=>{ try { localStorage.setItem(REG_KEY, JSON.stringify(regs)); } catch {} }, [regs]);

  const isRegistered = (eid) => !!regs.find(r => r.eventId === eid);
  const unregister = (eid) => {
    setRegs(prev => {
      const next = prev.filter(r => r.eventId !== eid);
      try { localStorage.setItem(REG_KEY, JSON.stringify(next)); } catch {}
      try { window.dispatchEvent(new StorageEvent('storage', { key: REG_KEY, newValue: JSON.stringify(next) })); } catch {}
      return next;
    });
  };

  // Per-event option state
  const [openId, setOpenId] = React.useState(null);
  const [opt, setOpt] = React.useState({ transport: false, competition: false });

  const openPanel = (e) => {
    setOpenId(e.id);
    setOpt({ transport: false, competition: false }); // defaults
  };

  const confirmRegister = (e) => {
    const transportFee   = opt.transport    ? (e.transportationFee||e.transportFee||0) : 0;
    const competitionFee = opt.competition  ? (e.competitionFee||0) : 0;
    const base = (e.courseCost||e.courseFee||0) + (e.caddyFee||0);
    const total = base + transportFee + competitionFee;

    setRegs(prev => {
      const rest = prev.filter(r => r.eventId !== e.id);
      const reg = {
        id: `${e.id}:${uid}`,
        eventId: e.id,
        wantsTransport: !!opt.transport,
        wantsCompetition: !!opt.competition,
        notes: '',
        total,
        title: e.title || e.course || 'Golf Event',
        course: e.course || '',
        date: e.date || '',
        time: e.time || '',
        includeTransport: !!opt.transport,
        includeCompetition: !!opt.competition,
        priceBreakdown: {
          courseFee: (e.courseCost||e.courseFee||0),
          caddyFee: (e.caddyFee||0),
          transportFee,
          competitionFee,
        },
        createdAt: new Date().toISOString(),
      };
      const next = [...rest, reg];
      try { localStorage.setItem(REG_KEY, JSON.stringify(next)); } catch {}
      try { window.dispatchEvent(new StorageEvent('storage', { key: REG_KEY, newValue: JSON.stringify(next) })); } catch {}
      return next;
    });
    setOpenId(null);
  };

  const eventsSorted = (events || []).slice().sort((a,b)=>(`${a.date}${a.time}`).localeCompare(`${b.date}${b.time}`));

  return (
    <div className="space-y-3">
      <div className="flex items-center justify-between">
        <h2 className="text-lg font-bold text-gray-900">Society Events</h2>
        <p className="text-xs text-gray-500">Confirm to register. Border highlights and tag stays until you cancel.</p>
      </div>

      {eventsSorted.length === 0 && (
        <div className="bg-gray-50 border border-dashed rounded-xl p-6 text-center text-gray-500">
          No society events published yet.
        </div>
      )}

      {eventsSorted.map(e => {
        const regFlag = isRegistered(e.id);
        const base = (e.courseCost||e.courseFee||0) + (e.caddyFee||0);
        const tFee = e.transportationFee||e.transportFee||0;
        const cFee = e.competitionFee||0;
        const totalPreview = base + (opt.transport && openId===e.id ? tFee : 0) + (opt.competition && openId===e.id ? cFee : 0);

        return (
          <div key={e.id} className={`p-4 bg-white rounded-2xl border ${regFlag ? "border-2 border-green-600" : "border-gray-200"}`}>
            <div className="flex justify-between items-start gap-3">
              <div>
                <div className="font-semibold flex items-center gap-2">
                  <span>{(e.title || e.course)} • {e.date} {e.time}</span>
                  {regFlag && <span className="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700 border border-green-600">Registered</span>}
                </div>
                <div className="text-xs text-gray-700">{e.course}</div>
                <div className="text-[11px] text-gray-500">Base: <b>{money(base)}</b> • Transport: {money(tFee)} • Competition: {money(cFee)}</div>
              </div>
              <div className="flex items-center gap-2">
                {!regFlag ? (
                  <button onClick={()=>openPanel(e)} className="px-3 py-1 rounded-lg text-xs bg-black text-white">Register</button>
                ) : (
                  <button onClick={()=>unregister(e.id)} className="px-3 py-1 rounded-lg text-xs bg-white border border-gray-300">Cancel</button>
                )}
              </div>
            </div>

            {openId === e.id && !regFlag && (
              <div className="mt-3 border rounded-xl p-3 bg-gray-50">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <label className="flex items-center justify-between py-1">
                      <div>
                        <div className="font-medium text-sm">Transport</div>
                        <div className="text-xs text-gray-500">Add society transport ({money(tFee)})</div>
                      </div>
                      <input type="checkbox" checked={opt.transport} onChange={e=>setOpt(o=>({...o, transport:e.target.checked}))} />
                    </label>
                    <label className="flex items-center justify-between py-1 mt-1">
                      <div>
                        <div className="font-medium text-sm">Competition</div>
                        <div className="text-xs text-gray-500">Enter the comp ({money(cFee)})</div>
                      </div>
                      <input type="checkbox" checked={opt.competition} onChange={e=>setOpt(o=>({...o, competition:e.target.checked}))} />
                    </label>
                  </div>
                  <div>
                    <div className="rounded-lg bg-white border p-3">
                      <div className="text-sm font-semibold mb-1">Price breakdown</div>
                      <div className="flex justify-between text-sm py-0.5"><span className="text-gray-500">Course + Caddy</span><span className="font-medium">{money(base)}</span></div>
                      <div className="flex justify-between text-sm py-0.5"><span className="text-gray-500">Transport</span><span className="font-medium">{opt.transport ? money(tFee) : "-"}</span></div>
                      <div className="flex justify-between text-sm py-0.5"><span className="text-gray-500">Competition</span><span className="font-medium">{opt.competition ? money(cFee) : "-"}</span></div>
                      <div className="border-t my-2"></div>
                      <div className="flex justify-between items-center"><span className="text-sm font-semibold">Total</span><span className="text-lg font-bold">{money(totalPreview)}</span></div>
                    </div>
                  </div>
                </div>
                <div className="flex items-center gap-2 mt-3">
                  <button className="px-4 py-2 rounded-xl text-sm bg-black text-white" onClick={()=>confirmRegister(e)}>Confirm & Register</button>
                  <button className="px-4 py-2 rounded-xl text-sm border border-gray-300" onClick={()=>setOpenId(null)}>Cancel</button>
                </div>
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
};/* ===== End Injected ===== */



        const Trophy = ({ className = "w-5 h-5" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/>
                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
                <path d="M4 22h16"/>
                <path d="M10 14.66V17c0 .55.45 1 1 1h2c.55 0 1-.45 1-1v-2.34"/>
                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
            </svg>
        );

        const Plus = ({ className = "w-5 h-5" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M5 12h14"/>
                <path d="M12 5v14"/>
            </svg>
        );

        const X = ({ className = "w-5 h-5" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M18 6 6 18"/>
                <path d="M6 6l12 12"/>
            </svg>
        );

        const Users = ({ className = "w-5 h-5" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
        );

        const DollarSign = ({ className = "w-5 h-5" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" x2="12" y1="1" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
        );

        const Target = ({ className = "w-5 h-5" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="12" r="6"/>
                <circle cx="12" cy="12" r="2"/>
            </svg>
        );

        const Trash = ({ className = "w-5 h-5" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
            </svg>
        );

        
const getEventSignups = (eid, users) => {
  const list = Array.isArray(users) ? users : (typeof allUsers !== 'undefined' ? allUsers : (window.__allUsers || []));
  return list.filter(u => {
    if (u.role !== 'golfer') return false;
    const regRaw = localStorage.getItem(`uc2:extRegs:${u.id}`);
    if (!regRaw) return false;
    try {
      const parsed = JSON.parse(regRaw);
      return parsed.some(r => r.eventId === eid);
    } catch {
      return false;
    }
  });
};

const getSignupPercentage = (eid, max = 10, users) => {
  const signedUp = getEventSignups(eid, users).length;
  return Math.min(100, Math.round((signedUp / max) * 100));
};


function MyCaddyPlatform() {
            

  // === Organizer (Society Ops) components scoped inside MyCaddyPlatform ===
  const OrganizerDashboard = ({ onManage }) => {
    const todayStr = new Date().toISOString().split('T')[0];
    const eSafe = (v) => v || "";
    const upcoming = (events || []).slice().sort((a,b)=> (eSafe(a.date)+eSafe(a.time)).localeCompare(eSafe(b.date)+eSafe(b.time)));

    const totalEvents = upcoming.length;
    const totalRegs   = upcoming.reduce((sum, e) => sum + (getEventSignups ? getEventSignups(e.id, allUsers).length : 0), 0);
    const fillingSoon = upcoming.filter(e => (getSignupPercentage ? getSignupPercentage(e.id, 10, allUsers) : 0) >= 80);

    return (
      <div className="space-y-3">
        <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg p-4">
          <div className="flex justify-between items-center">
            <div>
              <div className="text-sm opacity-90">Society Operations</div>
              <div className="text-xl font-bold">Organizer Dashboard</div>
            </div>
            <button onClick={onManage} className="bg-white/15 hover:bg-white/25 px-3 py-1.5 rounded text-sm">
              Manage Events
            </button>
          </div>
        </div>

        <div className="grid grid-cols-3 gap-2">
          <div className="bg-white/90 p-3 rounded-lg border shadow-sm">
            <div className="text-xs text-gray-600">Upcoming Events</div>
            <div className="text-xl font-bold text-gray-900">{totalEvents}</div>
          </div>
          <div className="bg-white/90 p-3 rounded-lg border shadow-sm">
            <div className="text-xs text-gray-600">Total Registrations</div>
            <div className="text-xl font-bold text-gray-900">{totalRegs}</div>
          </div>
          <div className="bg-white/90 p-3 rounded-lg border shadow-sm">
            <div className="text-xs text-gray-600">Filling Soon (≥80%)</div>
            <div className="text-xl font-bold text-gray-900">{fillingSoon.length}</div>
          </div>
        </div>

        <div className="bg-white/90 p-3 rounded-lg border">
          <div className="flex items-center justify-between mb-2">
            <div className="font-semibold">Upcoming Society Events</div>
            <button onClick={onManage} className="text-blue-600 text-sm">+ New Event</button>
          </div>
          <div className="divide-y">
            {upcoming.length ? upcoming.map(e => {
              const pct  = getSignupPercentage ? getSignupPercentage(e.id, 10, allUsers) : 0;
              const regs = getEventSignups ? getEventSignups(e.id, allUsers) : [];
              return (
                <div key={e.id} className="py-2">
                  <div className="flex justify-between items-center">
                    <div>
                      <div className="font-medium">{e.title || e.course} • {e.date} {e.time}</div>
                      <div className="text-xs text-gray-600">{e.course} • ฿{(e.courseCost||0) + (e.caddyCost||0)}</div>
                    </div>
                    <div className="text-right w-40">
                      <div className="text-xs text-gray-600">{regs.length}/10</div>
                      <div className="w-full bg-gray-200 rounded-full h-1.5 mt-1">
                        <div className={`${pct>=80 ? 'bg-orange-500' : 'bg-blue-500'} h-1.5 rounded-full`} style={{ width: pct + '%' }} />
                      </div>
                    </div>
                  </div>
                  {!!regs.length && (
                    <div className="text-[11px] text-gray-600 mt-1">
                      Signed up: {regs.map(u => u.name).join(', ')}
                    </div>
                  )}
                </div>
              );
            }) : (
              <div className="text-sm text-gray-500 py-6 text-center">No upcoming events.</div>
            )}
          </div>
        </div>
      </div>
    );
  };

  const OrganizerSocietyManager = () => {
    const [eventEdit, setEventEdit] = React.useState(null);
    const [editForm, setEditForm] = React.useState({
      title: '', date: '', time: '', course: '', caddy: '',
      courseCost: '', caddyCost: '', notes: ''
    });

    const handleField = (e) =>
      setEditForm(prev => ({ ...prev, [e.target.name]: e.target.value }));

    const handleSubmitEvent = () => {
      const courseCost = parseFloat(editForm.courseCost) || 0;
      const caddyCost  = parseFloat(editForm.caddyCost)  || 0;
      const payload = {
        id: eventEdit?.id || Date.now(),
        ...editForm,
        courseCost,
        caddyCost,
        totalCost: courseCost + caddyCost
      };
      setEvents(prev => {
        const rest = prev.filter(e => e.id !== payload.id);
        return [...rest, payload].sort((a,b)=> ((a.date||'')+(a.time||'')).localeCompare((b.date||'')+(b.time||'')));
      });
      setEventEdit(null);
      setEditForm({ title:'', date:'', time:'', course:'', caddy:'', courseCost:'', caddyCost:'', notes:'' });
    };

    const handleEdit = (evt) => { setEventEdit(evt); setEditForm(evt); };
    const handleDelete = (id)  => setEvents(prev => prev.filter(e => e.id !== id));

    return (
      <div className="space-y-4">
        <h2 className="text-lg font-bold">Manage Society Events</h2>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {events.map(e => (
            <div key={e.id} className="bg-white p-3 rounded-lg shadow border space-y-1">
              <div className="font-semibold">{e.title} - {e.date} {e.time}</div>
              <div className="text-sm text-gray-600">{e.course}</div>
              <div className="text-sm">฿{e.courseCost} + ฿{e.caddyCost}</div>
              <div className="flex space-x-2 mt-2">
                <button onClick={() => handleEdit(e)} className="text-blue-600 text-sm">Edit</button>
                <button onClick={() => handleDelete(e.id)} className="text-red-600 text-sm">Delete</button>
              </div>
            </div>
          ))}
        </div>

        <div className="bg-white p-4 border rounded-lg">
          <h3 className="font-medium mb-2">{eventEdit ? 'Edit Event' : 'Create New Event'}</h3>
          <div className="grid grid-cols-2 gap-2">
            <input name="title" value={editForm.title} onChange={handleField} placeholder="Title" className="border p-2 rounded" />
            <select name="course" value={editForm.course} onChange={handleField} className="border p-2 rounded">
              <option value="">Select Course</option>
              {courses.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
            <input name="date" type="date" value={editForm.date} onChange={handleField} className="border p-2 rounded" />
            <input name="time" type="time" value={editForm.time} onChange={handleField} className="border p-2 rounded" />
            <input name="courseCost" value={editForm.courseCost} onChange={handleField} placeholder="Course Cost" className="border p-2 rounded" />
            <input name="caddyCost" value={editForm.caddyCost} onChange={handleField} placeholder="Caddy Cost" className="border p-2 rounded" />
          </div>
          <textarea name="notes" value={editForm.notes} onChange={handleField} placeholder="Notes" className="border p-2 mt-2 rounded w-full" />
          <div className="mt-3">
            <button onClick={handleSubmitEvent} className="bg-blue-600 text-white px-4 py-2 rounded">{eventEdit ? 'Update' : 'Create'} Event</button>
          </div>
        </div>
      </div>
    );
  };

const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [loading, setLoading] = useState(false);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [activeTab, setActiveTab] = useState('dashboard');
            const [showSignup, setShowSignup] = useState(false);
            const [signupRole, setSignupRole] = useState('golfer');
            
            // Modal states
            const [showDayOffModal, setShowDayOffModal] = useState(false);
            const [showBudgetModal, setShowBudgetModal] = useState(false);
            const [showPointsModal, setShowPointsModal] = useState(false);
            const [showGolfModal, setShowGolfModal] = useState(false);
            const [showScoreModal, setShowScoreModal] = useState(false);
            const [showBookingModal, setShowBookingModal] = useState(false);
            const [showOverrideModal, setShowOverrideModal] = useState(false);
            const [overrideData, setOverrideData] = useState({ timeSlot: '', teeSlot: '', golfer: '', caddyId: '', course: '' });
    
            const [showAnnouncementModal, setShowAnnouncementModal] = useState(false);
            
            // Data states
            // Schedule inline edit states (golfer schedule list)
            const [regEditId, setRegEditId] = useState(null);
            const [regEditDraft, setRegEditDraft] = useState({});
            const [schedRefresh, setSchedRefresh] = useState(0);
    
            const [monthlyBudget, setMonthlyBudget] = useState(15000);
            // Sync society registrations into main budget (ensures spent includes saved Society regs)
            useEffect(() => {
                try {
                    if (!currentUser) return;
                    const key = `uc2:extRegs:${currentUser.id}`;
                    const raw = localStorage.getItem(key);
                    const regs = raw ? JSON.parse(raw) : [];
                    const regsTotal = regs.reduce((sum, r) => sum + (Number(r.total)||0), 0);
                    setMonthlySpent(prev => {
                        // Keep whichever is greater so we don't double-add; schedule adds separately.
                        return Math.max(prev, regsTotal);
                    });
                } catch {}
            }, [currentUser, activeTab]);
    
            const [monthlySpent, setMonthlySpent] = useState(2175);
            const [newBudget, setNewBudget] = useState('');
            const [newPoints, setNewPoints] = useState('');
            const [rankingPeriod, setRankingPeriod] = useState('monthly');
            
            // GM specific states
            const [caddySearchTerm, setCaddySearchTerm] = useState('');
            const [caddyStatusFilter, setCaddyStatusFilter] = useState('');
            const [selectedBooking, setSelectedBooking] = useState(null);
            const [editingBooking, setEditingBooking] = useState({
                golfer: '', caddyId: '', status: 'confirmed', course: '', notes: ''
            });
            
            // Tee sheet search and blocking
            const [teeSheetSearch, setTeeSheetSearch] = useState('');
            const [showBlockTimeModal, setShowBlockTimeModal] = useState(false);
            const [blockTimeData, setBlockTimeData] = useState({
                startTime: '', endTime: '', reason: ''
            });
            const [blockedTimes, setBlockedTimes] = useState([]);
            
            const [newAnnouncement, setNewAnnouncement] = useState({
                title: '', message: '', priority: 'Normal'
            });

            const [newMember, setNewMember] = useState({
                name: '', email: '', phone: '', tier: 'silver', experience: '', specialty: '', rating: '4.5'
            });

            const [allGolferPoints, setAllGolferPoints] = useState([
                { id: 1, name: 'Peter Park', monthlyPoints: 8, yearlyPoints: 234, tier: 'platinum' },
                { id: 2, name: 'Sarah Chen', monthlyPoints: 15, yearlyPoints: 189, tier: 'gold' },
                { id: 5, name: 'Marcus Johnson', monthlyPoints: 22, yearlyPoints: 156, tier: 'silver' }
            ]);
            
            const [newEvent, setNewEvent] = useState({ 
                title: '', date: '', time: '', course: '', caddy: '', courseCost: '', caddyCost: '', notes: ''
            });
            
            const [newScore, setNewScore] = useState({ 
                date: new Date().toISOString().split('T')[0], course: '', score: '', eventId: '', notes: ''
            });

            
            // ---- Golfer schedule persistence (extRegs) ----
            const [regsTick, setRegsTick] = useState(0);
const [editId, setEditId] = useState(null);
const [editDraft, setEditDraft] = useState({}); // bump to re-render schedule list
            const getExtRegsKey = () => currentUser ? `uc2:extRegs:${currentUser.id}` : null;
            const readRegs = () => {
                const k = getExtRegsKey(); if(!k) return [];
                try { const raw = localStorage.getItem(k); const arr = raw ? JSON.parse(raw) : []; return Array.isArray(arr) ? arr : []; } catch(_) { return []; }
            };
            const writeRegs = (arr) => {
                const k = getExtRegsKey(); if(!k) return;
                try { localStorage.setItem(k, JSON.stringify(arr)); } catch(_) {}
            };
            const normalizeScheduleItem = (ev, source='schedule') => ({
                id: Date.now(),
                title: ev.title || 'Golf Event',
                date: ev.date || '',
                time: ev.time || '',
                course: ev.course || '',
                includeTransport: !!ev.includeTransport,
                includeCompetition: !!ev.includeCompetition,
                caddy: ev.caddy || '',
                source,
                total: (parseFloat(ev.courseCost)||0) + (parseFloat(ev.caddyCost)||0),
                createdAt: new Date().toISOString()
            });
            const hasDateConflict = (arr, date) => arr.some(r => r.date === date);
const [events, setEvents] = useState([
  {
    id: 1,
    title: 'Sunrise Tee-Off',
    course: 'Phoenix Gold Golf & Country Club',
    caddy: 'Ning Siriwan',
    courseCost: 2000,
    caddyCost: 500,
    totalCost: 2500,
    date: '2025-08-18',
    time: '06:30',
    notes: 'Early bird special session'
  },
  {
    id: 2,
    title: 'Midday Challenge',
    course: 'Burapha Golf Club',
    caddy: 'David Chen',
    courseCost: 1900,
    caddyCost: 600,
    totalCost: 2500,
    date: '2025-08-19',
    time: '11:30',
    notes: 'Moderate pace, 4-ball grouping'
  },
  {
    id: 3,
    title: 'Twilight Tour',
    course: 'Pattaya Country Club',
    caddy: 'Marcus Thompson',
    courseCost: 1700,
    caddyCost: 550,
    totalCost: 2250,
    date: '2025-08-20',
    time: '16:00',
    notes: 'Cooler evening weather'
  },
  {
    id: 4,
    title: 'Ocean View Round',
    course: 'Laem Chabang International Country Club',
    caddy: 'Ning Siriwan',
    courseCost: 2400,
    caddyCost: 700,
    totalCost: 3100,
    date: '2025-08-21',
    time: '08:00',
    notes: 'Includes scenic photo stops'
  },
  {
    id: 5,
    title: 'Fairway Classic',
    course: 'St. Andrews 2000 Golf Club',
    caddy: 'Sarah Wilson',
    courseCost: 2100,
    caddyCost: 600,
    totalCost: 2700,
    date: '2025-08-22',
    time: '10:00',
    notes: 'Fast greens, light breeze'
  },
  {
    id: 6,
    title: 'Royal Rounds',
    course: 'The Emerald Golf Club',
    caddy: 'David Chen',
    courseCost: 1800,
    caddyCost: 550,
    totalCost: 2350,
    date: '2025-08-23',
    time: '09:00',
    notes: 'Gentle rolling hills'
  },
  {
    id: 7,
    title: 'Green Valley Sunday',
    course: 'Rayong Green Valley Country Club',
    caddy: 'Marcus Thompson',
    courseCost: 2000,
    caddyCost: 600,
    totalCost: 2600,
    date: '2025-08-24',
    time: '07:45',
    notes: 'Group play with prize draw'
  },
  {
    id: 8,
    title: 'Weekday Warrior Cup',
    course: 'Silky Oak Country Club',
    caddy: 'Sarah Wilson',
    courseCost: 1850,
    caddyCost: 500,
    totalCost: 2350,
    date: '2025-08-25',
    time: '13:30',
    notes: 'Best ball format'
  },
  {
    id: 9,
    title: 'Legends Tee-Off',
    course: 'Treasure Hill Golf & Country Club',
    caddy: 'Ning Siriwan',
    courseCost: 1750,
    caddyCost: 550,
    totalCost: 2300,
    date: '2025-08-26',
    time: '06:45',
    notes: 'Veterans group + guests'
  },
  {
    id: 10,
    title: 'Platinum Challenge',
    course: 'Eastern Star Country Club',
    caddy: 'David Chen',
    courseCost: 2250,
    caddyCost: 650,
    totalCost: 2900,
    date: '2025-08-27',
    time: '14:00',
    notes: 'Platinum tier invite-only event'
  }
]);

            const [golfRounds, setGolfRounds] = useState([
                { id: 1, date: '2025-08-05', course: 'Siam Old Course', score: 89, eventId: 1, eventTitle: 'Morning Practice', notes: 'Perfect weather, improved putting on the back 9' },
                { id: 2, date: '2025-08-03', course: 'Pattaya Country Club', score: 92, eventId: null, eventTitle: null, notes: 'Windy conditions, struggled with driver' },
                { id: 3, date: '2025-08-01', course: 'Eastern Star', score: 85, eventId: null, eventTitle: null, notes: 'Best round this month!' }
            ]);

            const [dayOffRequests, setDayOffRequests] = useState([
                { id: 1, caddyId: '001', caddyName: 'Ning Siriwan', date: '2025-08-15', reason: 'Family event', status: 'pending', requestDate: '2025-08-10' },
                { id: 2, caddyId: '002', caddyName: 'Marcus Thompson', date: '2025-08-20', reason: 'Medical appointment', status: 'approved', requestDate: '2025-08-08' }
            ]);
            
            const [newDayOffRequest, setNewDayOffRequest] = useState({ date: '', reason: '' });

            const [announcements, setAnnouncements] = useState([
                {
                    id: 1,
                    title: 'Weather Alert',
                    message: 'Heavy rain expected this afternoon. Please prepare rain gear for guests.',
                    priority: 'Important',
                    timestamp: new Date().toISOString(),
                    readBy: []
                }
            ]);

            const initialUsers = [
                { id: 1, name: 'Peter Park', role: 'golfer', avatar: 'PP', tier: 'platinum' },
                { id: 2, name: 'Sarah Chen', role: 'golfer', avatar: 'SC', tier: 'gold' },
                { id: 5, name: 'Marcus Johnson', role: 'golfer', avatar: 'MJ', tier: 'silver' },
                { id: 3, name: 'Ning Siriwan', role: 'caddy', avatar: 'NS' },
                { id: 4, name: 'Robert Anderson', role: 'gm', avatar: 'RA' }
            ,
                { id: 6, name: 'Society Ops', role: 'organizer', avatar: 'SO' }
            ];
            const [leaderboardQuery, setLeaderboardQuery] = useState('');
            const [selectedGolferInfo, setSelectedGolferInfo] = useState(null);
        

            const [allUsers, setAllUsers] = useState(initialUsers);

            // keep a global mirror for helper fallbacks (legacy-safe)
            useEffect(() => { try { window.__allUsers = allUsers; } catch(e) {} }, [allUsers]);


            const [allCaddies, setAllCaddies] = useState([
                { id: '001', name: 'Ning Siriwan', status: 'working', rating: 4.9, experience: '8 years', specialty: 'Tournament Play', currentClient: 'Peter Park' },
                { id: '002', name: 'Marcus Thompson', status: 'available', rating: 4.7, experience: '5 years', specialty: 'Beginner Friendly', currentClient: null },
                { id: '003', name: 'David Chen', status: 'on-break', rating: 4.8, experience: '6 years', specialty: 'Beginner Friendly', currentClient: null },
                { id: '004', name: 'Sarah Wilson', status: 'day-off', rating: 4.6, experience: '4 years', specialty: 'Course Management', currentClient: null }
            ]);

            const [allBookings] = useState([
                { id: 1, time: '06:00', golfer: 'Peter Park', caddy: 'Ning Siriwan', caddyId: '001', course: 'Pattaya Country Club', status: 'confirmed', date: '2025-08-12', duration: '4 hours' },
                { id: 2, time: '07:30', golfer: 'Sarah Chen', caddy: 'Marcus Thompson', caddyId: '002', course: 'Eastern Star', status: 'confirmed', date: '2025-08-12', duration: '3.5 hours' }
            ]);

            const courses = [
                'Pattaya Country Club', 'Eastern Star', 'Siam Old Course', 'Siam Plantation',
                'Siam Waterside', 'Siam Rolling Hills', 'Rayong Green Valley', 'Burapha Golf Resort'
            ];
            
            const caddies = ['Ning Siriwan', 'Marcus Thompson', 'David Chen'];

            const generateTimeSlots = () => {
                const slots = [];
                for (let hour = 6; hour <= 16; hour++) {
                    for (let min = 0; min <= 45; min += 15) {
                        const timeString = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
                        slots.push(timeString);
                    }
                }
                return slots;
            };

            const timeSlots = generateTimeSlots();
            
            
const seedSheet = () => {
const golferNames = ['John Smith', 'Emily Davis', 'Michael Brown', 'Jessica Wilson', 'David Miller'];
                const courseList = ['Pattaya Country Club', 'Eastern Star', 'Siam Old Course'];
                const sheet = {};
                
                for (let i = 0; i < 44; i++) {
                    const randomTimeIndex = Math.floor(Math.random() * 30);
                    const randomTeeSlot = Math.floor(Math.random() * 8) + 1;
                    const timeSlot = timeSlots[randomTimeIndex];
                    const key = `${timeSlot}-${randomTeeSlot}`;
                    
                    if (!sheet[key]) {
                        sheet[key] = {
                            id: Date.now() + i,
                            golfer: golferNames[i % golferNames.length],
                            caddyId: String(Math.floor(Math.random() * 4) + 1).padStart(3, '0'),
                            status: Math.random() > 0.2 ? 'confirmed' : 'pending',
                            course: courseList[Math.floor(Math.random() * courseList.length)],
                            notes: Math.random() > 0.8 ? 'VIP Guest' : ''
                        };
                    }
                }
                return sheet;
            
};
const today = new Date().toISOString().slice(0,10);
const [selectedDate, setSelectedDate] = useState(today);
const [view, setView] = useState('day');
const [teeSheetByDate, setTeeSheetByDate] = useState(() => ({ [today]: seedSheet() }));
const teeSheet = teeSheetByDate[selectedDate] || {};
const setTeeSheet = (updater) => {
  setTeeSheetByDate(prev => {
    const current = prev[selectedDate] || {};
    const updated = (typeof updater === 'function') ? updater(current) : updater;
    return { ...prev, [selectedDate]: updated };
  });
};
window.mcxGetTeeSheet = () => teeSheet;
window.mcxSetTeeSheet = fn => setTeeSheet(fn);
window.mcxKeyFor = (time, tee) => `${time}-${tee}`;
// === MyCaddy inline booking bridge (V3) ===
    window.mcxGetTeeSheet = () => teeSheet;
    window.mcxSetTeeSheet = fn => setTeeSheet(fn);
    window.mcxKeyFor = (time,tee) => `${time}-${tee}`;
    window.mcxAddBooking = function(time, tee, payload){
      try{
        const key = `${time}-${tee}`;
        const booking = {
          id: Date.now(),
          golfer: payload?.golfer ?? '',
          caddyId: String(payload?.caddyId ?? '').padStart(3,'0'),
          status: 'confirmed',
          course: payload?.course ?? 'Pattaya Country Club',
          notes: payload?.notes ?? ''
        };
        setTeeSheet(prev => {
          const next = {...prev};
          next[key] = booking;
          return next;
        });
        // lightweight toast
        (function(){
          const t=document.createElement('div');
          t.textContent=`Saved ${key} — ${booking.golfer} / ${booking.caddyId}`;
          t.style.cssText='position:fixed;left:50%;top:10px;transform:translateX(-50%);background:#0b1220;color:#e5e7eb;border:1px solid #374151;border-radius:10px;padding:8px 12px;z-index:2147483600';
          document.body.appendChild(t); setTimeout(()=>t.remove(), 1200);
        })();
        setTimeout(()=>console.log('[mcxAddBooking] key:', key, 'value now:', teeSheet[key], 'grid keys sample:', Object.keys(teeSheet).slice(0,3)), 80);
        return {ok:true, key};
      }catch(e){ console.error('mcxAddBooking error', e); return {ok:false, error:String(e)}; }
    };
    // === end bridge ===


            // Helper functions
            const getCaddyBookings = () => allBookings.filter(booking => booking.caddy === currentUser?.name);
            const formatCurrency = (amount) => '฿' + Number(amount||0).toLocaleString();
            const getBudgetPercentage = () => Math.min((monthlySpent / monthlyBudget) * 100, 100);
            
            const getCurrentUserPoints = () => {
                const user = allGolferPoints.find(p => p.id === currentUser?.id);
                return user ? user[rankingPeriod === 'monthly' ? 'monthlyPoints' : 'yearlyPoints'] : 0;
            };
            
            const getLeaderboard = () => {
                const pointsKey = rankingPeriod === 'monthly' ? 'monthlyPoints' : 'yearlyPoints';
                return [...allGolferPoints]
                    .sort((a, b) => b[pointsKey] - a[pointsKey])
                    .map((golfer, index) => ({ ...golfer, rank: index + 1, points: golfer[pointsKey] }));
            };
            
            const getCurrentUserRank = () => {
                const leaderboard = getLeaderboard();
                const currentUserData = leaderboard.find(u => u.id === currentUser?.id);
                return currentUserData?.rank || 0;
            };
            // ---- Handicap/Trend helpers and demo history ----
            const handicapIndexFromScore = (score) => {
                const adj = Math.max(0, (Number(score)||0) - 72);
                return Math.round(adj * 0.6 * 10) / 10;
            };
            const trendFromSeries = (arr) => {
                if (!arr || arr.length < 2) return {dir:'flat', delta:0};
                const a = Number(arr[arr.length-2])||0, b = Number(arr[arr.length-1])||0;
                const delta = Math.round((b - a) * 10) / 10;
                if (delta < -0.1) return {dir:'down', delta};
                if (delta > 0.1) return {dir:'up', delta};
                return {dir:'flat', delta:0};
            };
            // Demo histories; wire to real data later if available
            const roundsHistoryByGolfer = {
                'Peter Park': [89, 88, 87, 85, 84],
                'Sarah Chen': [95, 93, 92, 91, 90],
                'Marcus Johnson': [102, 99, 98, 97, 96]
            };
            const coursesHistoryByGolfer = {
                'Peter Park': ['Siam Old', 'Pattaya CC', 'Eastern Star', 'Burapha', 'Laem Chabang'],
                'Sarah Chen': ['Eastern Star', 'Burapha', 'Green Valley', 'Phoenix Gold', 'Pattaya CC'],
                'Marcus Johnson': ['Rayong GV', 'St. Andrews 2000', 'Treasure Hill', 'Emerald', 'Silky Oak']
            };
        

            const getFilteredCaddies = () => {
                return allCaddies.filter(caddy => {
                    const matchesSearch = !caddySearchTerm || 
                        caddy.id.includes(caddySearchTerm) || 
                        caddy.name.toLowerCase().includes(caddySearchTerm.toLowerCase());
                    const matchesStatus = !caddyStatusFilter || caddy.status === caddyStatusFilter;
                    return matchesSearch && matchesStatus;
                });
            };

            // Helper function to check if a time is blocked
            const isTimeBlocked = (timeSlot, teeSlot) => {
                return blockedTimes.some(block => {
                    const blockStart = block.startTime;
                    const blockEnd = block.endTime;
                    return timeSlot >= blockStart && timeSlot <= blockEnd;
                });
            };

            // Helper function to get filtered tee sheet based on search
            const getFilteredTeeSheet = () => {
                if (!teeSheetSearch.trim()) return teeSheet;
                
                const searchLower = teeSheetSearch.toLowerCase();
                const filtered = {};
                
                Object.entries(teeSheet).forEach(([key, booking]) => {
                    const matchesGolfer = booking.golfer.toLowerCase().includes(searchLower);
                    const matchesCaddy = booking.caddyId.includes(teeSheetSearch);
                    
                    if (matchesGolfer || matchesCaddy) {
                        filtered[key] = booking;
                    }
                });
                
                return filtered;
            };

            // Helper function to get current user caddy status
            const getCurrentCaddyStatus = () => {
                const caddy = allCaddies.find(c => c.name === currentUser?.name);
                return caddy?.status || 'available';
            };

            // Event handlers
            const handleLogin = (user) => {
                setLoading(true);
                setTimeout(() => {
                    setCurrentUser(user);
                    setIsLoggedIn(true);
                    setLoading(false);
                }, 1000);
            };

            
            const openGolfModal = () => {
                // Prefill defaults if empty to avoid early-return
                setNewEvent(prev => ({
                    title: prev.title || 'Golf Round',
                    date: prev.date || new Date().toISOString().split('T')[0],
                    time: prev.time || '07:30',
                    course: prev.course || (courses && courses[0] ? courses[0] : 'Pattaya Country Club'),
                    caddy: prev.caddy || '',
                    courseCost: prev.courseCost || '',
                    caddyCost: prev.caddyCost || '',
                    notes: prev.notes || ''
                }));
                setShowGolfModal(true);
            };
const handleLogout = () => {
                setIsLoggedIn(false);
                setCurrentUser(null);
                setActiveTab('dashboard');
            };

            const handleSignup = () => {
                if (!newMember.name || !newMember.email) {
                    return;
                }

                const initials = newMember.name.split(' ').map(n => n[0]).join('').toUpperCase();
                const newUser = {
                    id: Date.now(),
                    name: newMember.name,
                    email: newMember.email,
                    phone: newMember.phone,
                    role: signupRole,
                    avatar: initials,
                    tier: signupRole === 'golfer' ? newMember.tier : undefined
                };

                setAllUsers(prev => [...prev, newUser]);

                if (signupRole === 'caddy') {
                    const newCaddy = {
                        id: String(allCaddies.length + 1).padStart(3, '0'),
                        name: newMember.name,
                        status: 'available',
                        rating: parseFloat(newMember.rating),
                        experience: newMember.experience,
                        specialty: newMember.specialty,
                        currentClient: null
                    };
                    setAllCaddies(prev => [...prev, newCaddy]);
                }

                if (signupRole === 'golfer') {
                    const newGolfer = {
                        id: newUser.id,
                        name: newMember.name,
                        monthlyPoints: 0,
                        yearlyPoints: 0,
                        tier: newMember.tier
                    };
                    setAllGolferPoints(prev => [...prev, newGolfer]);
                }

                setNewMember({ name: '', email: '', phone: '', tier: 'silver', experience: '', specialty: '', rating: '4.5' });
                setShowSignup(false);
            };

            const handleCaddyStatusChange = (caddyId, newStatus) => {
                setAllCaddies(prev => prev.map(caddy => 
                    caddy.id === caddyId ? { ...caddy, status: newStatus } : caddy
                ));
            };

            // Handler for caddy to change their own status
            const handleMyCaddyStatusChange = (newStatus) => {
                const myCaddy = allCaddies.find(c => c.name === currentUser?.name);
                if (myCaddy) {
                    handleCaddyStatusChange(myCaddy.id, newStatus);
                }
            };

            // Handler for blocking time periods
            const handleBlockTime = () => {
                if (!blockTimeData.startTime || !blockTimeData.endTime || !blockTimeData.reason) {
                    return;
                }
                
                const newBlock = {
                    id: Date.now(),
                    startTime: blockTimeData.startTime,
                    endTime: blockTimeData.endTime,
                    reason: blockTimeData.reason,
                    createdBy: currentUser?.name
                };
                
                setBlockedTimes(prev => [...prev, newBlock]);
                setBlockTimeData({ startTime: '', endTime: '', reason: '' });
                setShowBlockTimeModal(false);
            };

            const handleBookingEdit = (timeSlot, teeSlot) => {
                const key = `${timeSlot}-${teeSlot}`;
                const booking = teeSheet[key];
                if (booking) {
                    setSelectedBooking({ timeSlot, teeSlot, key });
                    setEditingBooking({
                        golfer: booking.golfer,
                        caddyId: booking.caddyId,
                        status: booking.status,
                        course: booking.course,
                        notes: booking.notes || ''
                    });
                    setShowBookingModal(true);
                }
            };

            const handleBookingUpdate = () => {
                if (!editingBooking.golfer || !editingBooking.caddyId) {
                    return;
                }
                
                setTeeSheet(prev => ({
                    ...prev,
                    [selectedBooking.key]: {
                        ...prev[selectedBooking.key],
                        ...editingBooking
                    }
                }));
                
                setShowBookingModal(false);
                setSelectedBooking(null);
            }
            const handleOverrideAssign = () => {
                const { timeSlot, teeSlot, golfer, caddyId, course } = overrideData;
                if (!timeSlot || !teeSlot || !golfer || !caddyId) return;
                const key = `${timeSlot}-${teeSlot}`;
                setTeeSheet(prev => ({
                    ...prev,
                    [key]: {
                        id: Date.now(),
                        time: timeSlot,
                        golfer,
                        caddyId,
                        status: 'confirmed',
                        course: course || 'Pattaya Country Club',
                        notes: 'GM override within block'
                    }
                }));
                setShowOverrideModal(false);
                setOverrideData({ timeSlot: '', teeSlot: '', golfer: '', caddyId: '', course: '' });
            };
        ;

            const handleBookingCancel = () => {
                const newTeeSheet = { ...teeSheet };
    
                delete newTeeSheet[selectedBooking.key];
                setTeeSheet(newTeeSheet);
                
                setShowBookingModal(false);
                setSelectedBooking(null);
            };

            const handleBroadcastAnnouncement = () => {
                if (!newAnnouncement.title.trim() || !newAnnouncement.message.trim()) {
                    return;
                }

                const announcement = {
                    id: Date.now(),
                    title: newAnnouncement.title.trim(),
                    message: newAnnouncement.message.trim(),
                    priority: newAnnouncement.priority,
                    timestamp: new Date().toISOString(),
                    readBy: []
                };

                setAnnouncements(prev => [announcement, ...prev]);
                setNewAnnouncement({ title: '', message: '', priority: 'Normal' });
                setShowAnnouncementModal(false);
            };

            const handleDayOffRequest = () => {
                if (!newDayOffRequest.date || !newDayOffRequest.reason) {
                    return;
                }
                const request = {
                    id: Date.now(),
                    caddyId: currentUser?.avatar?.toLowerCase() === 'ns' ? '001' : '002',
                    caddyName: currentUser?.name,
                    date: newDayOffRequest.date,
                    reason: newDayOffRequest.reason,
                    status: 'pending',
                    requestDate: new Date().toISOString().split('T')[0]
                };
                setDayOffRequests(prev => [...prev, request]);
                setNewDayOffRequest({ date: '', reason: '' });
                setShowDayOffModal(false);
            };

            const handleDayOffApproval = (requestId, status) => {
                setDayOffRequests(prev => prev.map(request => 
                    request.id === requestId ? { ...request, status } : request
                ));
            };

            const handleUpdateBudget = () => {
                const budget = parseFloat(newBudget);
                if (budget > 0) {
                    setMonthlyBudget(budget);
                    setNewBudget('');
                    setShowBudgetModal(false);
                }
            };

            const handleAddPoints = () => {
                const points = parseInt(newPoints);
                if (points > 0) {
                    setAllGolferPoints(prev => prev.map(golfer => {
                        if (golfer.id === currentUser?.id) {
                            return {
                                ...golfer,
                                monthlyPoints: golfer.monthlyPoints + points,
                                yearlyPoints: golfer.yearlyPoints + points
                            };
                        }
                        return golfer;
                    }));
                    setNewPoints('');
                    setShowPointsModal(false);
                }
            };

            
const handleScheduleGolf = () => {
    if (!newEvent.title || !newEvent.date || !newEvent.time || !newEvent.course) {
        return;
    }
    const courseCost = parseFloat(newEvent.courseCost) || 0;
    const caddyCost = parseFloat(newEvent.caddyCost) || 0;
    const totalCost = courseCost + caddyCost;

    const createdEvent = {
        id: Date.now(),
        ...newEvent,
        courseCost,
        caddyCost,
        totalCost
    };

    // Keep legacy in-memory list for any dependent UI
    setEvents(prev => [...prev, createdEvent]);
    setMonthlySpent(prev => prev + totalCost);

    // Persist to golfer extRegs store and prevent same-day overlap with Events tab
    try {
        const regs = readRegs();
        if (hasDateConflict(regs, newEvent.date)) {
            alert('You already have a booking on this date. Please edit or remove the existing one.');
        } else {
            const regItem = normalizeScheduleItem(createdEvent, 'schedule');
            regs.push(regItem);
            writeRegs(regs);
            try { console.debug('[Schedule] saved to', getExtRegsKey(), regs.length); } catch(_) {}
            setRegsTick(x => x + 1);
        }
    } catch (e) {}

    setNewEvent({ title: '', date: '', time: '', course: '', caddy: '', courseCost: '', caddyCost: '', notes: '' });
    setShowGolfModal(false);
};


            const handlePostScore = () => {
                if (!newScore.date || !newScore.course || !newScore.score) {
                    return;
                }
                
                const selectedEvent = newScore.eventId ? events.find(e => e.id === parseInt(newScore.eventId)) : null;
                
                const newRound = { 
                    id: Date.now(), 
                    ...newScore, 
                    score: parseInt(newScore.score),
                    eventId: newScore.eventId ? parseInt(newScore.eventId) : null,
                    eventTitle: selectedEvent ? selectedEvent.title : null,
                    caddy: selectedEvent ? selectedEvent.caddy : null
                };
            // ---- Listen for v6 Events tab messages (created/edited) ----
            useEffect(() => {
                function onV6Message(e){
                    const d = e && e.data;
                    if (!d || typeof d !== 'object') return;
                    if (d.type === 'V6_EVENT_CREATED' && currentUser?.role === 'golfer') {
                        try {
                            const regs = readRegs();
                            if (hasDateConflict(regs, d.event && d.event.date)) {
                                return; // prevent same-day double booking
                            }
                            const item = normalizeScheduleItem(d.event || {}, 'events');
                            regs.push(item);
                            writeRegs(regs);
            try { console.debug('[Schedule] saved to', getExtRegsKey(), regs.length); } catch(_) {}
                            setRegsTick(x => x + 1);
                        } catch(_) {}
                    }
                }
                window.addEventListener('message', onV6Message);
                return () => window.removeEventListener('message', onV6Message);
            }, [currentUser]);

                
                setGolfRounds(prev => [newRound, ...prev]);
                setNewScore({ date: new Date().toISOString().split('T')[0], course: '', score: '', eventId: '', notes: '' });
                setShowScoreModal(false);
            };

            const handleDelete = (type, id) => {
                if (type === 'event') {
                    const event = events.find(e => e.id === id);
                    setEvents(prev => prev.filter(e => e.id !== id));
                    setMonthlySpent(prev => prev - (event?.totalCost || 0));
                } else if (type === 'score') {
                    setGolfRounds(prev => prev.filter(r => r.id !== id));
                }
            };

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                setShowDayOffModal(false);
                setShowBudgetModal(false);
                setShowPointsModal(false);
                setShowGolfModal(false);
                setShowScoreModal(false);
                setShowBookingModal(false);
                setShowAnnouncementModal(false);
                setShowSignup(false);
                setShowBlockTimeModal(false);
            }, [currentUser, activeTab, isLoggedIn]);

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-teal-50 to-blue-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="w-16 h-16 bg-gradient-to-r from-teal-500 to-blue-500 rounded-2xl mb-4 flex items-center justify-center mx-auto shadow-xl animate-pulse">
                                <Award className="w-8 h-8 text-white" />
                            </div>
                            <h1 className="text-xl font-bold text-gray-900">MyCaddy Pro</h1>
                        </div>
                    </div>
                );
            }

            if (!isLoggedIn) {
                if (showSignup) {
                    return (
                        <div className="min-h-screen bg-gradient-to-br from-teal-50 via-blue-50 to-indigo-50 flex items-center justify-center p-4">
                            <div className="bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-6 w-full max-w-md">
                                <div className="text-center mb-6">
                                   <div className="w-16 h-16 bg-gradient-to-r from-teal-500 to-blue-500 rounded-2xl mx-auto flex items-center justify-center shadow-xl mb-4">
                                       <Award className="w-8 h-8 text-white" />
                                   </div>
                                   <h1 className="text-2xl font-bold bg-gradient-to-r from-teal-600 to-blue-600 bg-clip-text text-transparent mb-2">
                                       Join MyCaddy Pro
                                   </h1>
                                   <p className="text-sm text-gray-600">Create your account</p>
                               </div>

                               <div className="space-y-4">
                                   <div className="flex bg-gray-200 rounded-lg p-1">
                                       <button 
                                           onClick={() => setSignupRole('golfer')} 
                                           className={`flex-1 px-3 py-2 text-sm rounded-md transition-all ${signupRole === 'golfer' ? 'bg-blue-500 text-white' : 'text-gray-600 hover:bg-gray-300'}`}
                                       >
                                           Golfer
                                       </button>
                                       <button 
                                           onClick={() => setSignupRole('caddy')} 
                                           className={`flex-1 px-3 py-2 text-sm rounded-md transition-all ${signupRole === 'caddy' ? 'bg-blue-500 text-white' : 'text-gray-600 hover:bg-gray-300'}`}
                                       >
                                           Caddy
                                       </button>
                                       <button 
                                           onClick={() => setSignupRole('gm')} 
                                           className={`flex-1 px-3 py-2 text-sm rounded-md transition-all ${signupRole === 'gm' ? 'bg-blue-500 text-white' : 'text-gray-600 hover:bg-gray-300'}`}
                                       >
                                           GM
                                       </button>
                                   </div>

                                   <input
                                       type="text"
                                       value={newMember.name}
                                       onChange={(e) => setNewMember({...newMember, name: e.target.value})}
                                       className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Full Name"
                                   />

                                   <input
                                       type="email"
                                       value={newMember.email}
                                       onChange={(e) => setNewMember({...newMember, email: e.target.value})}
                                       className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Email Address"
                                   />

                                   <input
                                       type="tel"
                                       value={newMember.phone}
                                       onChange={(e) => setNewMember({...newMember, phone: e.target.value})}
                                       className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Phone Number"
                                   />

                                   {signupRole === 'golfer' && (
                                       <select
                                           value={newMember.tier}
                                           onChange={(e) => setNewMember({...newMember, tier: e.target.value})}
                                           className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       >
                                           <option value="silver">Silver Membership</option>
                                           <option value="gold">Gold Membership</option>
                                           <option value="platinum">Platinum Membership</option>
                                       </select>
                                   )}

                                   {signupRole === 'caddy' && (
                                       <>
                                           <input
                                               type="text"
                                               value={newMember.experience}
                                               onChange={(e) => setNewMember({...newMember, experience: e.target.value})}
                                               className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                               placeholder="Years of Experience (e.g., 5 years)"
                                           />
                                           <select
                                               value={newMember.specialty}
                                               onChange={(e) => setNewMember({...newMember, specialty: e.target.value})}
                                               className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           >
                                               <option value="">Select Specialty</option>
                                               <option value="Tournament Play">Tournament Play</option>
                                               <option value="Beginner Friendly">Beginner Friendly</option>
                                               <option value="Course Management">Course Management</option>
                                               <option value="Advanced Strategy">Advanced Strategy</option>
                                           </select>
                                       </>
                                   )}

                                   <div className="flex space-x-2">
                                       <button 
                                           onClick={handleSignup} 
                                           disabled={!newMember.name || !newMember.email}
                                           className={`flex-1 py-3 rounded-lg font-medium transition-all ${
                                               !newMember.name || !newMember.email 
                                                   ? 'bg-gray-400 cursor-not-allowed text-white' 
                                                   : 'bg-blue-500 hover:bg-blue-600 text-white'
                                           }`}
                                       >
                                           Create Account
                                       </button>
                                       <button 
                                           onClick={() => setShowSignup(false)} 
                                           className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg font-medium transition-all"
                                       >
                                           Back to Login
                                       </button>
                                   </div>
                               </div>
                           </div>
                       </div>
                   );
               }

               return (
                   <div className="min-h-screen bg-gradient-to-br from-teal-50 via-blue-50 to-indigo-50 flex items-center justify-center p-4">
                       <div className="bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-6 w-full max-w-md">
                           <div className="text-center mb-6">
                               <div className="w-16 h-16 bg-gradient-to-r from-teal-500 to-blue-500 rounded-2xl mx-auto flex items-center justify-center shadow-xl mb-4">
                                   <Award className="w-8 h-8 text-white" />
                               </div>
                               <h1 className="text-2xl font-bold bg-gradient-to-r from-teal-600 to-blue-600 bg-clip-text text-transparent mb-2">
                                   MyCaddy Pro
                               </h1>
                               <p className="text-sm text-gray-600">Elite Golf Caddy Management</p>
                           </div>
                           <div className="grid grid-cols-2 gap-3">
                               {allUsers.map(user => (
                                   <button 
                                       key={user.id} 
                                       onClick={() => handleLogin(user)}
                                       className="rounded-xl p-3 text-center transition-all duration-300 hover:scale-105 bg-blue-50 border border-blue-200 hover:bg-blue-100"
                                   >
                                       <div className="w-10 h-10 rounded-full mx-auto mb-2 flex items-center justify-center text-white font-bold text-sm bg-blue-600">
                                           {user.avatar}
                                       </div>
                                       <h3 className="font-semibold text-gray-900 text-xs mb-1">{user.name}</h3>
                                       <p className="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-700 capitalize">
                                           {user.role === 'gm' ? 'GM' : user.role}
                                       </p>
                                       {user.tier && (
                                           <div className="mt-1 text-xs font-medium text-yellow-600">★ {user.tier.toUpperCase()}</div>
                                       )}
                                   </button>
                               ))}
                           </div>
                           <div className="mt-4">
                               <button 
                                   onClick={() => setShowSignup(true)}
                                   className="w-full bg-gradient-to-r from-teal-500 to-blue-500 text-white py-3 rounded-xl font-medium hover:from-teal-600 hover:to-blue-600 transition-all duration-300"
                               >
                                   + Join MyCaddy Pro
                               </button>
                           </div>
                       </div>
                   </div>
               );
           }

           return (
               <div className="min-h-screen bg-gradient-to-br from-teal-50 via-blue-50 to-indigo-50 flex flex-col">
                   <header className="bg-white/95 backdrop-blur-sm border-b shadow-sm sticky top-0 z-50">
                       <div className="px-4 py-3 flex justify-between items-center">
                           <div className="flex items-center space-x-3">
                               <div className="w-8 h-8 bg-gradient-to-r from-teal-500 to-blue-500 rounded-lg flex items-center justify-center">
                                   <Award className="w-5 h-5 text-white" />
                               </div>
                               <div>
                                   <h1 className="text-lg font-bold bg-gradient-to-r from-teal-600 to-blue-600 bg-clip-text text-transparent">
                                       MyCaddy Pro
                                   </h1>
                                   <p className="text-xs text-gray-500 -mt-1">{currentUser?.name} • {currentUser?.role.toUpperCase()}</p>
                               </div>
                           </div>
                           <div className="flex items-center space-x-2">
                               <div className="text-xs text-gray-600">
                                   {currentTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                               </div>
                               <div className="w-8 h-8 rounded-full flex items-center justify-center text-white font-medium text-sm bg-blue-600">
                                   {currentUser?.avatar}
                               </div>
                               <button onClick={handleLogout} className="p-2 text-gray-600 hover:text-gray-800 transition-colors">
                                   <LogOut className="w-5 h-5" />
                               </button>
                           
                                   <button onClick={() => { setActiveTab('live'); }}
                                       className={`px-3 py-1.5 rounded-full text-sm font-medium border ${activeTab === 'live' ? 'bg-green-600 text-white border-green-600' : 'bg-white hover:bg-gray-50'}`}>
                                       Live
                                   </button>
    

                                   {currentUser?.role === 'golfer' && (
                                     <button onClick={() => { setActiveTab('games'); setTimeout(() => window.dispatchEvent(new CustomEvent('mycaddy:open-games')), 0); }}
                                         className={`px-3 py-1.5 rounded-full text-sm font-medium border ${activeTab === 'games' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white hover:bg-gray-50'}`}>
                                         Games
                                     </button>
                                   )}
    
</div>
</div>
</header>

                   <div className="bg-white/80 backdrop-blur-sm border-b px-4">
                       <div className="flex space-x-1 overflow-x-auto">
                           {currentUser?.role === 'gm' ? 
                               ['dashboard', 'caddy-status', 'tee-sheet', 'announcements', 'dayoff-requests'].map((tab) => (
                                   <button
                                       key={tab}
                                       onClick={() => setActiveTab(tab)}
                                       className={`px-3 py-2 text-sm font-medium rounded-t-lg whitespace-nowrap transition-all ${
                                           activeTab === tab ? 'bg-blue-100 text-blue-700 border-b-2 border-blue-500' : 'text-gray-600 hover:text-blue-600'
                                       }`}
                                   >
                                       {tab === 'dayoff-requests' ? 'Day Off Requests' : 
                                        tab === 'caddy-status' ? 'Caddy Status' :
                                        tab === 'tee-sheet' ? 'Tee Sheet' :
                                        tab === 'announcements' ? 'Announcements' :
                                        tab.charAt(0).toUpperCase() + tab.slice(1)}
                                   </button>
                               )) :
                               currentUser?.role === 'caddy' ?
                               ['dashboard', 'my-bookings', 'day-off-requests'].map((tab) => (
                                   <button
                                       key={tab}
                                       onClick={() => setActiveTab(tab)}
                                       className={`px-3 py-2 text-sm font-medium rounded-t-lg whitespace-nowrap transition-all ${
                                           activeTab === tab ? 'bg-blue-100 text-blue-700 border-b-2 border-blue-500' : 'text-gray-600 hover:text-blue-600'
                                       }`}
                                   >
                                       {tab === 'my-bookings' ? 'My Bookings' : 
                                        tab === 'day-off-requests' ? 'Day Off Requests' :
                                        tab.charAt(0).toUpperCase() + tab.slice(1)}
                                   </button>
                               )) :
                               currentUser?.role === 'organizer' ?
                               ['dashboard','society-admin'].map((tab) => (
                                   <button
                                       key={tab}
                                       onClick={() => setActiveTab(tab)}
                                       className={`px-3 py-2 text-sm font-medium rounded-t-lg whitespace-nowrap transition-all ${activeTab === tab ? 'bg-blue-100 text-blue-700 border-b-2 border-blue-500' : 'text-gray-600 hover:text-blue-600'}`}
                                   >
                                       {tab === 'society-admin' ? 'Society Admin' : tab.charAt(0).toUpperCase() + tab.slice(1)}
                                   </button>
                               )) :
                               ['dashboard','schedule','events','society','scores','leaderboard'].map((tab) => (
                                   <button
                                       key={tab}
                                       onClick={() => setActiveTab(tab)}
                                       className={`px-3 py-2 text-sm font-medium rounded-t-lg whitespace-nowrap transition-all ${
                                           activeTab === tab ? 'bg-blue-100 text-blue-700 border-b-2 border-blue-500' : 'text-gray-600 hover:text-blue-600'
                                       }`}
                                   >
                                       {tab.charAt(0).toUpperCase() + tab.slice(1)}
                                   </button>
                               ))
                           }
                       </div>
                   </div>

                   <main className="flex-1 overflow-hidden">
                       <div className="h-full overflow-y-auto p-3">

            {currentUser?.role === 'organizer' && activeTab === 'dashboard' && (
              <NewOrganizerDashboard events={events} getEventSignups={getEventSignups} onManage={() => setActiveTab('society-admin')} />
            )}
            {currentUser?.role === 'organizer' && activeTab === 'society-admin' && (
              <NewOrganizerSocietyManager events={events} setEvents={setEvents} courses={courses} getEventSignups={getEventSignups} />
            )}

                           {/* Dashboard Tab */}
                           {activeTab === 'dashboard' && (
                               <div className="space-y-3">
                                   {currentUser?.role === 'gm' ? (<div className="rounded-lg border overflow-hidden" style={{height:'80vh'}}>
  <iframe title="GM Dashboard Integrated" src="data:text/html;base64,PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgPG1ldGEgY2hhcnNldD0idXRmLTgiPgogIDxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MSI+CiAgPHRpdGxlPk15Q2FkZHkgUHJvIOKAoiBHTSBEYXNoYm9hcmQgLSBDb21wbGV0ZTwvdGl0bGU+CiAgPHN0eWxlPgogICAgOnJvb3R7LS1iZzojZjRmN2ZiOy0tY2FyZDojZmZmOy0taW5rOiMxMTE4Mjc7LS1tdXRlZDojNmI3MjgwOy0tYnJhbmQ6IzI1NjNlYjstLWJvcmRlcjpyZ2JhKDAsMCwwLC4xMik7LS1zdWNjZXNzOiMxMGI5ODE7LS13YXJuaW5nOiNmNTllMGI7LS1kYW5nZXI6I2VmNDQ0NH0KICAgICp7Ym94LXNpemluZzpib3JkZXItYm94fQogICAgaHRtbCxib2R5e21hcmdpbjowO2hlaWdodDoxMDAlO2JhY2tncm91bmQ6dmFyKC0tYmcpO2NvbG9yOnZhcigtLWluayk7Zm9udC1mYW1pbHk6c3lzdGVtLXVpLC1hcHBsZS1zeXN0ZW0sU2Vnb2UgVUksUm9ib3RvLEludGVyLEFyaWFsfQogICAgCiAgICAudG9wYmFye2hlaWdodDo1NnB4O2Rpc3BsYXk6ZmxleDthbGlnbi1pdGVtczpjZW50ZXI7Z2FwOjEycHg7cGFkZGluZzowIDE2cHg7YmFja2dyb3VuZDojZmZmO2JvcmRlci1ib3R0b206MXB4IHNvbGlkIHZhcigtLWJvcmRlcik7cG9zaXRpb246c3RpY2t5O3RvcDowO3otaW5kZXg6NTB9CiAgICAuYnJhbmR7Zm9udC13ZWlnaHQ6ODAwO2NvbG9yOiMwZjE3MmF9CiAgICAudGFic3tkaXNwbGF5OmZsZXg7Z2FwOjZweDtwYWRkaW5nOjhweCAxMnB4O2JhY2tncm91bmQ6I2ZmZjtib3JkZXItYm90dG9tOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO3Bvc2l0aW9uOnN0aWNreTt0b3A6NTZweDt6LWluZGV4OjQwfQogICAgLnRhYntwYWRkaW5nOjhweCAxMnB4O2JvcmRlci1yYWRpdXM6MTBweDtjdXJzb3I6cG9pbnRlcjt0cmFuc2l0aW9uOmFsbCAwLjJzfQogICAgLnRhYjpob3ZlcntiYWNrZ3JvdW5kOiNmOGZhZmN9CiAgICAudGFiLmFjdGl2ZXtiYWNrZ3JvdW5kOiNlZWYyZmY7Y29sb3I6IzFkNGVkOH0KICAgIC5wYWdle21heC13aWR0aDoxNDAwcHg7bWFyZ2luOjE0cHggYXV0bztwYWRkaW5nOjAgMTJweH0KICAgIC5jYXJke2JhY2tncm91bmQ6dmFyKC0tY2FyZCk7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO2JvcmRlci1yYWRpdXM6MTJweDtib3gtc2hhZG93OjAgMnB4IDhweCByZ2JhKDAsMCwwLC4wNik7cGFkZGluZzoyMHB4O21hcmdpbi1ib3R0b206MTZweH0KICAgIAogICAgLmdyaWR7ZGlzcGxheTpncmlkO2dhcDoxNnB4fQogICAgLmdyaWQtMntncmlkLXRlbXBsYXRlLWNvbHVtbnM6cmVwZWF0KGF1dG8tZml0LG1pbm1heCgzMDBweCwxZnIpKX0KICAgIC5ncmlkLTN7Z3JpZC10ZW1wbGF0ZS1jb2x1bW5zOnJlcGVhdChhdXRvLWZpdCxtaW5tYXgoMjUwcHgsMWZyKSl9CiAgICAuZ3JpZC00e2dyaWQtdGVtcGxhdGUtY29sdW1uczpyZXBlYXQoYXV0by1maXQsbWlubWF4KDIwMHB4LDFmcikpfQogICAgLmdyaWQtNXtncmlkLXRlbXBsYXRlLWNvbHVtbnM6cmVwZWF0KGF1dG8tZml0LG1pbm1heCgxODBweCwxZnIpKX0KICAgIC5ncmlkLTZ7Z3JpZC10ZW1wbGF0ZS1jb2x1bW5zOnJlcGVhdChhdXRvLWZpdCxtaW5tYXgoMTUwcHgsMWZyKSl9CiAgICAKICAgIC5tb2R1bGUtdGFic3tkaXNwbGF5OmZsZXg7Z2FwOjRweDttYXJnaW4tYm90dG9tOjIwcHg7Ym9yZGVyLWJvdHRvbToycHggc29saWQgdmFyKC0tYm9yZGVyKTtwYWRkaW5nLWJvdHRvbTo4cHh9CiAgICAubW9kdWxlLXRhYntwYWRkaW5nOjhweCAxNnB4O2JvcmRlci1yYWRpdXM6OHB4IDhweCAwIDA7Y3Vyc29yOnBvaW50ZXI7Zm9udC13ZWlnaHQ6NjAwO2JvcmRlcjoxcHggc29saWQgdHJhbnNwYXJlbnQ7dHJhbnNpdGlvbjphbGwgMC4yc30KICAgIC5tb2R1bGUtdGFiLmFjdGl2ZXtiYWNrZ3JvdW5kOiNmZmY7Ym9yZGVyLWNvbG9yOnZhcigtLWJvcmRlcik7Ym9yZGVyLWJvdHRvbToycHggc29saWQgI2ZmZjttYXJnaW4tYm90dG9tOi0ycHh9CiAgICAubW9kdWxlLXRhYjpob3ZlcntiYWNrZ3JvdW5kOiNmOGZhZmN9CiAgICAKICAgIC5tb2R1bGUtY29udGVudHtkaXNwbGF5Om5vbmV9CiAgICAubW9kdWxlLWNvbnRlbnQuYWN0aXZle2Rpc3BsYXk6YmxvY2t9CiAgICAKICAgIC8qIFNlYXJjaCBCYXIgU3R5bGVzICovCiAgICAuc2VhcmNoLWNvbnRhaW5lcntwb3NpdGlvbjpyZWxhdGl2ZTttYXJnaW4tYm90dG9tOjE2cHh9CiAgICAuc2VhcmNoLWlucHV0e3dpZHRoOjEwMCU7cGFkZGluZzo4cHggMTJweCA4cHggMzZweDtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWJvcmRlcik7Ym9yZGVyLXJhZGl1czo4cHg7Zm9udC1zaXplOjAuODc1cmVtfQogICAgLnNlYXJjaC1pbnB1dDpmb2N1c3tvdXRsaW5lOm5vbmU7Ym9yZGVyLWNvbG9yOnZhcigtLWJyYW5kKTtib3gtc2hhZG93OjAgMCAwIDNweCByZ2JhKDM3LDk5LDIzNSwwLjEpfQogICAgLnNlYXJjaC1pY29ue3Bvc2l0aW9uOmFic29sdXRlO2xlZnQ6MTJweDt0b3A6NTAlO3RyYW5zZm9ybTp0cmFuc2xhdGVZKC01MCUpO2NvbG9yOnZhcigtLW11dGVkKTtmb250LXNpemU6MC44NzVyZW19CiAgICAuc2VhcmNoLXN1Z2dlc3Rpb25ze3Bvc2l0aW9uOmFic29sdXRlO3RvcDoxMDAlO2xlZnQ6MDtyaWdodDowO2JhY2tncm91bmQ6d2hpdGU7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO2JvcmRlci1yYWRpdXM6OHB4O2JveC1zaGFkb3c6MCA0cHggMTJweCByZ2JhKDAsMCwwLDAuMSk7ei1pbmRleDoxMDA7bWF4LWhlaWdodDoyMDBweDtvdmVyZmxvdy15OmF1dG99CiAgICAuc3VnZ2VzdGlvbi1pdGVte3BhZGRpbmc6OHB4IDEycHg7Y3Vyc29yOnBvaW50ZXI7Zm9udC1zaXplOjAuNzVyZW07Ym9yZGVyLWJvdHRvbToxcHggc29saWQgI2YxZjVmOX0KICAgIC5zdWdnZXN0aW9uLWl0ZW06aG92ZXJ7YmFja2dyb3VuZDojZjhmYWZjfQogICAgLnN1Z2dlc3Rpb24taXRlbTpsYXN0LWNoaWxke2JvcmRlci1ib3R0b206bm9uZX0KICAgIAogICAgLyogUmV2ZW51ZSBBbmFseXRpY3MgU3R5bGVzICovCiAgICAubWV0cmljLWNhcmR7dGV4dC1hbGlnbjpjZW50ZXI7cGFkZGluZzoxNnB4O3Bvc2l0aW9uOnJlbGF0aXZlO292ZXJmbG93OmhpZGRlbn0KICAgIC5tZXRyaWMtY2FyZDo6YmVmb3Jle2NvbnRlbnQ6Jyc7cG9zaXRpb246YWJzb2x1dGU7dG9wOjA7bGVmdDowO3JpZ2h0OjA7aGVpZ2h0OjNweDtiYWNrZ3JvdW5kOmxpbmVhci1ncmFkaWVudCg5MGRlZyx2YXIoLS1icmFuZCksdmFyKC0tc3VjY2VzcykpfQogICAgLm1ldHJpYy12YWx1ZXtmb250LXNpemU6MnJlbTtmb250LXdlaWdodDo3MDA7bWFyZ2luLWJvdHRvbTo0cHh9CiAgICAubWV0cmljLWxhYmVse2ZvbnQtc2l6ZTowLjg3NXJlbTtjb2xvcjp2YXIoLS1tdXRlZCk7bWFyZ2luLWJvdHRvbTo4cHh9CiAgICAubWV0cmljLWNoYW5nZXtmb250LXNpemU6MC43NXJlbTtwYWRkaW5nOjJweCA2cHg7Ym9yZGVyLXJhZGl1czo0cHh9CiAgICAubWV0cmljLWNoYW5nZS51cHtiYWNrZ3JvdW5kOiNkY2ZjZTc7Y29sb3I6IzE2NjUzNH0KICAgIC5tZXRyaWMtY2hhbmdlLmRvd257YmFja2dyb3VuZDojZmVlMmUyO2NvbG9yOiNkYzI2MjZ9CiAgICAKICAgIC5jaGFydC1jb250YWluZXJ7aGVpZ2h0OjIwMHB4O3Bvc2l0aW9uOnJlbGF0aXZlO2JhY2tncm91bmQ6I2Y4ZmFmYztib3JkZXItcmFkaXVzOjhweDtkaXNwbGF5OmZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO2p1c3RpZnktY29udGVudDpjZW50ZXI7Y29sb3I6dmFyKC0tbXV0ZWQpO2ZvbnQtc2l6ZTowLjg3NXJlbX0KICAgIAogICAgLnJldmVudWUtYnJlYWtkb3due2Rpc3BsYXk6ZmxleDtnYXA6OHB4O2ZsZXgtd3JhcDp3cmFwfQogICAgLnJldmVudWUtaXRlbXtmbGV4OjE7bWluLXdpZHRoOjEwMHB4O3RleHQtYWxpZ246Y2VudGVyO3BhZGRpbmc6MTJweDtiYWNrZ3JvdW5kOiNmOGZhZmM7Ym9yZGVyLXJhZGl1czo4cHg7Ym9yZGVyOjFweCBzb2xpZCB0cmFuc3BhcmVudDt0cmFuc2l0aW9uOmFsbCAwLjJzfQogICAgLnJldmVudWUtaXRlbTpob3Zlcntib3JkZXItY29sb3I6dmFyKC0tYnJhbmQpO3RyYW5zZm9ybTp0cmFuc2xhdGVZKC0ycHgpO2JveC1zaGFkb3c6MCA0cHggOHB4IHJnYmEoMCwwLDAsMC4xKX0KICAgIC5yZXZlbnVlLWFtb3VudHtmb250LXdlaWdodDo3MDA7Zm9udC1zaXplOjFyZW19CiAgICAucmV2ZW51ZS1zb3VyY2V7Zm9udC1zaXplOjAuNzVyZW07Y29sb3I6dmFyKC0tbXV0ZWQpO21hcmdpbi10b3A6NHB4fQogICAgLnJldmVudWUtcGVyY2VudHtmb250LXNpemU6MC43cmVtO2NvbG9yOnZhcigtLXN1Y2Nlc3MpO21hcmdpbi10b3A6MnB4fQogICAgCiAgICAvKiBDb3Vyc2UgT3BlcmF0aW9ucyBTdHlsZXMgKi8KICAgIC5zdGF0dXMtaW5kaWNhdG9ye3dpZHRoOjEycHg7aGVpZ2h0OjEycHg7Ym9yZGVyLXJhZGl1czo1MCU7cG9zaXRpb246YWJzb2x1dGU7dG9wOjE2cHg7cmlnaHQ6MTZweDthbmltYXRpb246cHVsc2UgMnMgaW5maW5pdGV9CiAgICAuc3RhdHVzLWdyZWVue2JhY2tncm91bmQ6dmFyKC0tc3VjY2Vzcyl9CiAgICAuc3RhdHVzLXllbGxvd3tiYWNrZ3JvdW5kOnZhcigtLXdhcm5pbmcpfQogICAgLnN0YXR1cy1yZWR7YmFja2dyb3VuZDp2YXIoLS1kYW5nZXIpfQogICAgCiAgICBAa2V5ZnJhbWVzIHB1bHNlezAle29wYWNpdHk6MX01MCV7b3BhY2l0eTowLjV9MTAwJXtvcGFjaXR5OjF9fQogICAgCiAgICAuY291cnNlLWhvbGV7ZGlzcGxheTppbmxpbmUtYmxvY2s7d2lkdGg6MjRweDtoZWlnaHQ6MjRweDtib3JkZXItcmFkaXVzOjUwJTt0ZXh0LWFsaWduOmNlbnRlcjtsaW5lLWhlaWdodDoyNHB4O2ZvbnQtc2l6ZTowLjdyZW07Zm9udC13ZWlnaHQ6NjAwO21hcmdpbjoxcHg7Y3Vyc29yOnBvaW50ZXI7dHJhbnNpdGlvbjphbGwgMC4yc30KICAgIC5jb3Vyc2UtaG9sZTpob3Zlcnt0cmFuc2Zvcm06c2NhbGUoMS4xKX0KICAgIC5ob2xlLWNsZWFye2JhY2tncm91bmQ6I2RjZmNlNztjb2xvcjojMTY2NTM0fQogICAgLmhvbGUtYnVzeXtiYWNrZ3JvdW5kOiNmZWYzYzc7Y29sb3I6IzkyNDAwZX0KICAgIC5ob2xlLWJhY2tlZC11cHtiYWNrZ3JvdW5kOiNmZWUyZTI7Y29sb3I6I2RjMjYyNn0KICAgIAogICAgLndlYXRoZXItd2lkZ2V0e2JhY2tncm91bmQ6bGluZWFyLWdyYWRpZW50KDEzNWRlZywjMGVhNWU5LCMzYjgyZjYpO2NvbG9yOndoaXRlO2JvcmRlci1yYWRpdXM6MTJweDtwYWRkaW5nOjE2cHg7dGV4dC1hbGlnbjpjZW50ZXI7cG9zaXRpb246cmVsYXRpdmU7b3ZlcmZsb3c6aGlkZGVufQogICAgLndlYXRoZXItd2lkZ2V0OjpiZWZvcmV7Y29udGVudDonJztwb3NpdGlvbjphYnNvbHV0ZTt0b3A6LTUwJTtsZWZ0Oi01MCU7d2lkdGg6MjAwJTtoZWlnaHQ6MjAwJTtiYWNrZ3JvdW5kOnJhZGlhbC1ncmFkaWVudChjaXJjbGUscmdiYSgyNTUsMjU1LDI1NSwwLjEpIDAlLHRyYW5zcGFyZW50IDcwJSk7YW5pbWF0aW9uOndlYXRoZXJTaGluZSAzcyBsaW5lYXIgaW5maW5pdGV9CiAgICAud2VhdGhlci10ZW1we2ZvbnQtc2l6ZToxLjVyZW07Zm9udC13ZWlnaHQ6NzAwfQogICAgLndlYXRoZXItZGVzY3tvcGFjaXR5OjAuOTttYXJnaW4tdG9wOjRweDtmb250LXNpemU6MC43NXJlbX0KICAgIAogICAgQGtleWZyYW1lcyB3ZWF0aGVyU2hpbmV7MCV7dHJhbnNmb3JtOnJvdGF0ZSgwZGVnKX0xMDAle3RyYW5zZm9ybTpyb3RhdGUoMzYwZGVnKX19CiAgICAKICAgIC5wYWNlLWluZGljYXRvcntkaXNwbGF5OmlubGluZS1ibG9jaztwYWRkaW5nOjJweCA2cHg7Ym9yZGVyLXJhZGl1czo0cHg7Zm9udC1zaXplOjAuNzVyZW07Zm9udC13ZWlnaHQ6NTAwfQogICAgLnBhY2UtZmFzdHtiYWNrZ3JvdW5kOiNkY2ZjZTc7Y29sb3I6IzE2NjUzNH0KICAgIC5wYWNlLW5vcm1hbHtiYWNrZ3JvdW5kOiNkYmVhZmU7Y29sb3I6IzFlNDBhZn0KICAgIC5wYWNlLXNsb3d7YmFja2dyb3VuZDojZmVlMmUyO2NvbG9yOiNkYzI2MjZ9CiAgICAKICAgIC8qIFN0YWZmIE1hbmFnZW1lbnQgU3R5bGVzICovCiAgICAuc3RhZmYtY2FyZHtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWJvcmRlcik7Ym9yZGVyLXJhZGl1czo4cHg7cGFkZGluZzoxMnB4O21hcmdpbi1ib3R0b206OHB4O2JhY2tncm91bmQ6I2ZmZjt0cmFuc2l0aW9uOmFsbCAwLjJzfQogICAgLnN0YWZmLWNhcmQ6aG92ZXJ7Ym94LXNoYWRvdzowIDRweCAxMnB4IHJnYmEoMCwwLDAsMC4xKTt0cmFuc2Zvcm06dHJhbnNsYXRlWSgtMXB4KX0KICAgIC5zdGFmZi1oZWFkZXJ7ZGlzcGxheTpmbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjttYXJnaW4tYm90dG9tOjhweH0KICAgIC5zdGFmZi1hdmF0YXJ7d2lkdGg6MzJweDtoZWlnaHQ6MzJweDtib3JkZXItcmFkaXVzOjUwJTtiYWNrZ3JvdW5kOnZhcigtLWJyYW5kKTtjb2xvcjp3aGl0ZTtkaXNwbGF5OmZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO2p1c3RpZnktY29udGVudDpjZW50ZXI7Zm9udC13ZWlnaHQ6NjAwO2ZvbnQtc2l6ZTowLjg3NXJlbTtwb3NpdGlvbjpyZWxhdGl2ZX0KICAgIC5zdGFmZi1hdmF0YXI6OmFmdGVye2NvbnRlbnQ6Jyc7cG9zaXRpb246YWJzb2x1dGU7Ym90dG9tOi0ycHg7cmlnaHQ6LTJweDt3aWR0aDoxMHB4O2hlaWdodDoxMHB4O2JvcmRlci1yYWRpdXM6NTAlO2JvcmRlcjoycHggc29saWQgd2hpdGV9CiAgICAuc3RhZmYtYXZhdGFyLm9ubGluZTo6YWZ0ZXJ7YmFja2dyb3VuZDp2YXIoLS1zdWNjZXNzKX0KICAgIC5zdGFmZi1hdmF0YXIuYXdheTo6YWZ0ZXJ7YmFja2dyb3VuZDp2YXIoLS13YXJuaW5nKX0KICAgIC5zdGFmZi1hdmF0YXIub2ZmbGluZTo6YWZ0ZXJ7YmFja2dyb3VuZDp2YXIoLS1tdXRlZCl9CiAgICAuc3RhZmYtaW5mb3tmbGV4OjE7bWFyZ2luLWxlZnQ6OHB4fQogICAgLnN0YWZmLW5hbWV7Zm9udC13ZWlnaHQ6NjAwO21hcmdpbi1ib3R0b206MnB4O2ZvbnQtc2l6ZTowLjg3NXJlbX0KICAgIC5zdGFmZi1yb2xle2ZvbnQtc2l6ZTowLjc1cmVtO2NvbG9yOnZhcigtLW11dGVkKX0KICAgIAogICAgLnN0YXR1cy1iYWRnZXtwYWRkaW5nOjJweCA2cHg7Ym9yZGVyLXJhZGl1czo4cHg7Zm9udC1zaXplOjAuN3JlbTtmb250LXdlaWdodDo1MDA7Y3Vyc29yOnBvaW50ZXI7dHJhbnNpdGlvbjphbGwgMC4yc30KICAgIC5zdGF0dXMtYmFkZ2U6aG92ZXJ7dHJhbnNmb3JtOnNjYWxlKDEuMDUpO2JveC1zaGFkb3c6MCAycHggNHB4IHJnYmEoMCwwLDAsMC4xKX0KICAgIC5zdGF0dXMtd29ya2luZ3tiYWNrZ3JvdW5kOiNkY2ZjZTc7Y29sb3I6IzE2NjUzNH0KICAgIC5zdGF0dXMtYnJlYWt7YmFja2dyb3VuZDojZmVmM2M3O2NvbG9yOiM5MjQwMGV9CiAgICAuc3RhdHVzLWx1bmNoe2JhY2tncm91bmQ6I2ZkZTY4YTtjb2xvcjojOTI0MDBlfQogICAgLnN0YXR1cy1hdmFpbGFibGV7YmFja2dyb3VuZDojZGJlYWZlO2NvbG9yOiMxZTQwYWZ9CiAgICAuc3RhdHVzLW9mZntiYWNrZ3JvdW5kOiNmM2Y0ZjY7Y29sb3I6IzZiNzI4MH0KICAgIC5zdGF0dXMtYWJzZW50e2JhY2tncm91bmQ6I2ZlZTJlMjtjb2xvcjojZGMyNjI2fQogICAgCiAgICAvKiBTdGF0dXMgQ29udHJvbHMgKi8KICAgIC5zdGF0dXMtY29udHJvbHN7bWFyZ2luLXRvcDoxMHB4O3BhZGRpbmc6MTBweDtiYWNrZ3JvdW5kOiNmOGZhZmM7Ym9yZGVyLXJhZGl1czo2cHg7Ym9yZGVyOjFweCBzb2xpZCAjZTVlN2VifQogICAgLnN0YXR1cy1jb250cm9scy1oZWFkZXJ7Zm9udC1zaXplOjAuNzVyZW07Zm9udC13ZWlnaHQ6NjAwO2NvbG9yOnZhcigtLW11dGVkKTttYXJnaW4tYm90dG9tOjhweH0KICAgIAogICAgLnN0YXR1cy1kcm9wZG93bnt3aWR0aDoxMDAlO3BhZGRpbmc6NnB4IDhweDtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWJvcmRlcik7Ym9yZGVyLXJhZGl1czo0cHg7Zm9udC1zaXplOjAuNzVyZW07YmFja2dyb3VuZDojZmZmO21hcmdpbi1ib3R0b206OHB4O3RyYW5zaXRpb246Ym9yZGVyLWNvbG9yIDAuMnN9CiAgICAuc3RhdHVzLWRyb3Bkb3duOmZvY3Vze291dGxpbmU6bm9uZTtib3JkZXItY29sb3I6dmFyKC0tYnJhbmQpfQogICAgCiAgICAudG9nZ2xlLXJvd3tkaXNwbGF5OmZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO2dhcDo4cHg7bWFyZ2luLWJvdHRvbTo4cHh9CiAgICAudG9nZ2xlLXN3aXRjaHtwb3NpdGlvbjpyZWxhdGl2ZTtkaXNwbGF5OmlubGluZS1ibG9jazt3aWR0aDozNnB4O2hlaWdodDoxOHB4fQogICAgLnRvZ2dsZS1zd2l0Y2ggaW5wdXR7b3BhY2l0eTowO3dpZHRoOjA7aGVpZ2h0OjB9CiAgICAudG9nZ2xlLXNsaWRlcntwb3NpdGlvbjphYnNvbHV0ZTtjdXJzb3I6cG9pbnRlcjt0b3A6MDtsZWZ0OjA7cmlnaHQ6MDtib3R0b206MDtiYWNrZ3JvdW5kLWNvbG9yOiNjY2M7dHJhbnNpdGlvbjouM3M7Ym9yZGVyLXJhZGl1czoxOHB4fQogICAgLnRvZ2dsZS1zbGlkZXI6YmVmb3Jle3Bvc2l0aW9uOmFic29sdXRlO2NvbnRlbnQ6IiI7aGVpZ2h0OjE0cHg7d2lkdGg6MTRweDtsZWZ0OjJweDtib3R0b206MnB4O2JhY2tncm91bmQtY29sb3I6d2hpdGU7dHJhbnNpdGlvbjouM3M7Ym9yZGVyLXJhZGl1czo1MCV9CiAgICBpbnB1dDpjaGVja2VkICsgLnRvZ2dsZS1zbGlkZXJ7YmFja2dyb3VuZC1jb2xvcjp2YXIoLS1zdWNjZXNzKX0KICAgIGlucHV0OmNoZWNrZWQgKyAudG9nZ2xlLXNsaWRlcjpiZWZvcmV7dHJhbnNmb3JtOnRyYW5zbGF0ZVgoMThweCl9CiAgICAKICAgIC5xdWljay1idXR0b25ze2Rpc3BsYXk6ZmxleDtnYXA6NHB4O2ZsZXgtd3JhcDp3cmFwfQogICAgLnF1aWNrLWJ0bntwYWRkaW5nOjNweCA2cHg7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO2JhY2tncm91bmQ6I2ZmZjtib3JkZXItcmFkaXVzOjNweDtjdXJzb3I6cG9pbnRlcjtmb250LXNpemU6MC42NXJlbTt0cmFuc2l0aW9uOmFsbCAwLjJzfQogICAgLnF1aWNrLWJ0bjpob3ZlcntiYWNrZ3JvdW5kOnZhcigtLWJyYW5kKTtjb2xvcjojZmZmO2JvcmRlci1jb2xvcjp2YXIoLS1icmFuZCl9CiAgICAucXVpY2stYnRuLmFjdGl2ZXtiYWNrZ3JvdW5kOnZhcigtLXN1Y2Nlc3MpO2NvbG9yOiNmZmY7Ym9yZGVyLWNvbG9yOnZhcigtLXN1Y2Nlc3MpfQogICAgLnF1aWNrLWJ0bi5icmVha3tib3JkZXItY29sb3I6dmFyKC0td2FybmluZyk7Y29sb3I6dmFyKC0td2FybmluZyl9CiAgICAucXVpY2stYnRuLmJyZWFrOmhvdmVye2JhY2tncm91bmQ6dmFyKC0td2FybmluZyk7Y29sb3I6I2ZmZn0KICAgIAogICAgLnN0YWZmLWxvY2F0aW9ue2ZvbnQtc2l6ZTowLjdyZW07Y29sb3I6dmFyKC0tYnJhbmQpO21hcmdpbi10b3A6MnB4fQogICAgLnN0YWZmLWxhc3QtdXBkYXRle2ZvbnQtc2l6ZTowLjY1cmVtO2NvbG9yOnZhcigtLW11dGVkKTttYXJnaW4tdG9wOjJweH0KICAgIAogICAgLmRhdGEtdGFibGV7d2lkdGg6MTAwJTtib3JkZXItY29sbGFwc2U6Y29sbGFwc2V9CiAgICAuZGF0YS10YWJsZSB0aCwuZGF0YS10YWJsZSB0ZHtwYWRkaW5nOjhweDt0ZXh0LWFsaWduOmxlZnQ7Ym9yZGVyLWJvdHRvbToxcHggc29saWQgdmFyKC0tYm9yZGVyKTtmb250LXNpemU6MC44NzVyZW19CiAgICAuZGF0YS10YWJsZSB0aHtiYWNrZ3JvdW5kOiNmOGZhZmM7Zm9udC13ZWlnaHQ6NjAwO2ZvbnQtc2l6ZTowLjc1cmVtO3Bvc2l0aW9uOnN0aWNreTt0b3A6MDt6LWluZGV4OjEwfQogICAgLmRhdGEtdGFibGUgdHI6aG92ZXJ7YmFja2dyb3VuZDojZjhmYWZjfQogICAgLmRhdGEtdGFibGUgdGJvZHkgdHJ7Y3Vyc29yOnBvaW50ZXJ9CiAgICAKICAgIC5idG57cGFkZGluZzo2cHggMTJweDtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWJvcmRlcik7YmFja2dyb3VuZDojZmZmO2JvcmRlci1yYWRpdXM6NnB4O2N1cnNvcjpwb2ludGVyO2ZvbnQtc2l6ZTowLjc1cmVtO3RyYW5zaXRpb246YWxsIDAuMnN9CiAgICAuYnRuOmhvdmVye2JhY2tncm91bmQ6I2Y4ZmFmY30KICAgIC5idG4tcHJpbWFyeXtiYWNrZ3JvdW5kOnZhcigtLWJyYW5kKTtjb2xvcjojZmZmO2JvcmRlci1jb2xvcjp2YXIoLS1icmFuZCl9CiAgICAuYnRuLXByaW1hcnk6aG92ZXJ7YmFja2dyb3VuZDojMWQ0ZWQ4fQogICAgLmJ0bi1zdWNjZXNze2JhY2tncm91bmQ6dmFyKC0tc3VjY2Vzcyk7Y29sb3I6I2ZmZjtib3JkZXItY29sb3I6dmFyKC0tc3VjY2Vzcyl9CiAgICAuYnRuLXdhcm5pbmd7YmFja2dyb3VuZDp2YXIoLS13YXJuaW5nKTtjb2xvcjojZmZmO2JvcmRlci1jb2xvcjp2YXIoLS13YXJuaW5nKX0KICAgIC5idG4tZGFuZ2Vye2JhY2tncm91bmQ6dmFyKC0tZGFuZ2VyKTtjb2xvcjojZmZmO2JvcmRlci1jb2xvcjp2YXIoLS1kYW5nZXIpfQogICAgLmJ0bi1zbXtwYWRkaW5nOjRweCA4cHg7Zm9udC1zaXplOjAuN3JlbX0KICAgIAogICAgLmRlcGFydG1lbnQtc2VjdGlvbnttYXJnaW4tYm90dG9tOjE2cHh9CiAgICAuZGVwYXJ0bWVudC1oZWFkZXJ7ZGlzcGxheTpmbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjttYXJnaW4tYm90dG9tOjEycHg7cGFkZGluZy1ib3R0b206NnB4O2JvcmRlci1ib3R0b206MXB4IHNvbGlkIHZhcigtLWJvcmRlcil9CiAgICAuZGVwYXJ0bWVudC10aXRsZXtmb250LXNpemU6MXJlbTtmb250LXdlaWdodDo2MDB9CiAgICAuZGVwYXJ0bWVudC1jb3VudHtjb2xvcjp2YXIoLS1tdXRlZCk7Zm9udC1zaXplOjAuNzVyZW19CiAgICAKICAgIGgxe21hcmdpbjowIDAgMjBweCAwO2ZvbnQtc2l6ZToxLjVyZW07Zm9udC13ZWlnaHQ6NzAwfQogICAgaDJ7bWFyZ2luOjAgMCAxMnB4IDA7Zm9udC1zaXplOjEuMTI1cmVtO2ZvbnQtd2VpZ2h0OjYwMH0KICAgIGgze21hcmdpbjowIDAgOHB4IDA7Zm9udC1zaXplOjFyZW07Zm9udC13ZWlnaHQ6NjAwfQogICAgCiAgICAuYWxlcnQtYm94e3BhZGRpbmc6MTJweDtib3JkZXItcmFkaXVzOjhweDttYXJnaW4tYm90dG9tOjEycHg7Ym9yZGVyLWxlZnQ6NHB4IHNvbGlkO2FuaW1hdGlvbjpzbGlkZUluIDAuM3MgZWFzZX0KICAgIC5hbGVydC1kYW5nZXJ7YmFja2dyb3VuZDojZmVlMmUyO2JvcmRlci1jb2xvcjp2YXIoLS1kYW5nZXIpfQogICAgLmFsZXJ0LXdhcm5pbmd7YmFja2dyb3VuZDojZmVmM2M3O2JvcmRlci1jb2xvcjp2YXIoLS13YXJuaW5nKX0KICAgIC5hbGVydC1pbmZve2JhY2tncm91bmQ6I2RiZWFmZTtib3JkZXItY29sb3I6dmFyKC0tYnJhbmQpfQogICAgLmFsZXJ0LXN1Y2Nlc3N7YmFja2dyb3VuZDojZGNmY2U3O2JvcmRlci1jb2xvcjp2YXIoLS1zdWNjZXNzKX0KICAgIAogICAgQGtleWZyYW1lcyBzbGlkZUlue2Zyb217b3BhY2l0eTowO3RyYW5zZm9ybTp0cmFuc2xhdGVYKC0yMHB4KX10b3tvcGFjaXR5OjE7dHJhbnNmb3JtOnRyYW5zbGF0ZVgoMCl9fQogICAgCiAgICAuc3VtbWFyeS1ncmlke2Rpc3BsYXk6Z3JpZDtncmlkLXRlbXBsYXRlLWNvbHVtbnM6cmVwZWF0KGF1dG8tZml0LG1pbm1heCgxMjBweCwxZnIpKTtnYXA6MTJweH0KICAgIC5zdW1tYXJ5LWl0ZW17dGV4dC1hbGlnbjpjZW50ZXI7cGFkZGluZzoxMnB4O2JhY2tncm91bmQ6I2Y4ZmFmYztib3JkZXItcmFkaXVzOjhweDt0cmFuc2l0aW9uOmFsbCAwLjJzfQogICAgLnN1bW1hcnktaXRlbTpob3ZlcntiYWNrZ3JvdW5kOiNlZWYyZmY7dHJhbnNmb3JtOnRyYW5zbGF0ZVkoLTJweCl9CiAgICAuc3VtbWFyeS1udW1iZXJ7Zm9udC1zaXplOjEuMjVyZW07Zm9udC13ZWlnaHQ6NzAwO21hcmdpbi1ib3R0b206NHB4fQogICAgLnN1bW1hcnktbGFiZWx7Zm9udC1zaXplOjAuNzVyZW07Y29sb3I6dmFyKC0tbXV0ZWQpfQogICAgCiAgICAvKiBTdGF0dXMgTWFuYWdlbWVudCBNb2RhbCAqLwogICAgLnN0YXR1cy1tb2RhbHtkaXNwbGF5Om5vbmU7cG9zaXRpb246Zml4ZWQ7dG9wOjA7bGVmdDowO3dpZHRoOjEwMCU7aGVpZ2h0OjEwMCU7YmFja2dyb3VuZDpyZ2JhKDAsMCwwLDAuNSk7ei1pbmRleDoxMDAwO2FuaW1hdGlvbjpmYWRlSW4gMC4zcyBlYXNlfQogICAgLnN0YXR1cy1tb2RhbC5hY3RpdmV7ZGlzcGxheTpmbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyfQogICAgLnN0YXR1cy1tb2RhbC1jb250ZW50e2JhY2tncm91bmQ6I2ZmZjtib3JkZXItcmFkaXVzOjEycHg7cGFkZGluZzoyNHB4O21pbi13aWR0aDo0MDBweDtib3gtc2hhZG93OjAgMjBweCA0MHB4IHJnYmEoMCwwLDAsMC4yKTthbmltYXRpb246c2NhbGVJbiAwLjNzIGVhc2V9CiAgICAuc3RhdHVzLW9wdGlvbnN7ZGlzcGxheTpncmlkO2dyaWQtdGVtcGxhdGUtY29sdW1uczpyZXBlYXQoMiwxZnIpO2dhcDoxMnB4O21hcmdpbjoxNnB4IDB9CiAgICAuc3RhdHVzLW9wdGlvbntwYWRkaW5nOjEycHg7Ym9yZGVyOjJweCBzb2xpZCB2YXIoLS1ib3JkZXIpO2JvcmRlci1yYWRpdXM6OHB4O3RleHQtYWxpZ246Y2VudGVyO2N1cnNvcjpwb2ludGVyO3RyYW5zaXRpb246YWxsIDAuMnN9CiAgICAuc3RhdHVzLW9wdGlvbjpob3Zlcntib3JkZXItY29sb3I6dmFyKC0tYnJhbmQpO2JhY2tncm91bmQ6I2Y4ZmFmYzt0cmFuc2Zvcm06dHJhbnNsYXRlWSgtMnB4KX0KICAgIC5zdGF0dXMtb3B0aW9uLnNlbGVjdGVke2JvcmRlci1jb2xvcjp2YXIoLS1icmFuZCk7YmFja2dyb3VuZDojZWVmMmZmfQogICAgLnN0YXR1cy1vcHRpb24taWNvbntmb250LXNpemU6MS41cmVtO21hcmdpbi1ib3R0b206OHB4fQogICAgLnN0YXR1cy1vcHRpb24tdGV4dHtmb250LXdlaWdodDo2MDA7bWFyZ2luLWJvdHRvbTo0cHh9CiAgICAuc3RhdHVzLW9wdGlvbi1kZXNje2ZvbnQtc2l6ZTowLjc1cmVtO2NvbG9yOnZhcigtLW11dGVkKX0KICAgIAogICAgQGtleWZyYW1lcyBmYWRlSW57ZnJvbXtvcGFjaXR5OjB9dG97b3BhY2l0eToxfX0KICAgIEBrZXlmcmFtZXMgc2NhbGVJbntmcm9te29wYWNpdHk6MDt0cmFuc2Zvcm06c2NhbGUoMC45KX10b3tvcGFjaXR5OjE7dHJhbnNmb3JtOnNjYWxlKDEpfX0KICAgIAogICAgLnN1Y2Nlc3MtbWVzc2FnZXtwb3NpdGlvbjpmaXhlZDt0b3A6MjBweDtyaWdodDoyMHB4O2JhY2tncm91bmQ6dmFyKC0tc3VjY2Vzcyk7Y29sb3I6d2hpdGU7cGFkZGluZzoxMnB4IDIwcHg7Ym9yZGVyLXJhZGl1czo4cHg7Ym94LXNoYWRvdzowIDRweCAxMnB4IHJnYmEoMCwwLDAsMC4xNSk7ei1pbmRleDoxMDAxO2ZvbnQtc2l6ZTowLjg3NXJlbTtmb250LXdlaWdodDo2MDA7YW5pbWF0aW9uOnNsaWRlSW5SaWdodCAwLjNzIGVhc2V9CiAgICAKICAgIEBrZXlmcmFtZXMgc2xpZGVJblJpZ2h0e2Zyb217b3BhY2l0eTowO3RyYW5zZm9ybTp0cmFuc2xhdGVYKDEwMHB4KX10b3tvcGFjaXR5OjE7dHJhbnNmb3JtOnRyYW5zbGF0ZVgoMCl9fQogICAgCiAgICAvKiBOb3RpZmljYXRpb24gU3lzdGVtICovCiAgICAubm90aWZpY2F0aW9uLWNlbnRlcntwb3NpdGlvbjpmaXhlZDtib3R0b206MjBweDtyaWdodDoyMHB4O21heC13aWR0aDozMDBweDt6LWluZGV4OjEwMDB9CiAgICAubm90aWZpY2F0aW9ue2JhY2tncm91bmQ6I2ZmZjtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWJvcmRlcik7Ym9yZGVyLXJhZGl1czo4cHg7cGFkZGluZzoxMnB4O21hcmdpbi1ib3R0b206OHB4O2JveC1zaGFkb3c6MCA0cHggMTJweCByZ2JhKDAsMCwwLDAuMSk7YW5pbWF0aW9uOnNsaWRlSW5SaWdodCAwLjNzIGVhc2V9CiAgICAubm90aWZpY2F0aW9uLnN1Y2Nlc3N7Ym9yZGVyLWxlZnQ6NHB4IHNvbGlkIHZhcigtLXN1Y2Nlc3MpfQogICAgLm5vdGlmaWNhdGlvbi53YXJuaW5ne2JvcmRlci1sZWZ0OjRweCBzb2xpZCB2YXIoLS13YXJuaW5nKX0KICAgIC5ub3RpZmljYXRpb24uZGFuZ2Vye2JvcmRlci1sZWZ0OjRweCBzb2xpZCB2YXIoLS1kYW5nZXIpfQogICAgLm5vdGlmaWNhdGlvbi5pbmZve2JvcmRlci1sZWZ0OjRweCBzb2xpZCB2YXIoLS1icmFuZCl9CiAgICAKICAgIC8qIEV4cG9ydCBhbmQgUHJpbnQgU3R5bGVzICovCiAgICAuZXhwb3J0LWNvbnRyb2xze21hcmdpbi1ib3R0b206MTZweDtkaXNwbGF5OmZsZXg7Z2FwOjhweDtmbGV4LXdyYXA6d3JhcH0KICAgIC5leHBvcnQtYnRue2Rpc3BsYXk6ZmxleDthbGlnbi1pdGVtczpjZW50ZXI7Z2FwOjZweDtwYWRkaW5nOjZweCAxMnB4O2JvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKTtiYWNrZ3JvdW5kOiNmZmY7Ym9yZGVyLXJhZGl1czo2cHg7Y3Vyc29yOnBvaW50ZXI7Zm9udC1zaXplOjAuNzVyZW07dHJhbnNpdGlvbjphbGwgMC4yc30KICAgIC5leHBvcnQtYnRuOmhvdmVye2JhY2tncm91bmQ6I2Y4ZmFmYztib3JkZXItY29sb3I6dmFyKC0tYnJhbmQpfQogICAgCiAgICAvKiBMaXZlIERhdGEgSW5kaWNhdG9ycyAqLwogICAgLmxpdmUtaW5kaWNhdG9ye2Rpc3BsYXk6aW5saW5lLWZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO2dhcDo0cHg7Zm9udC1zaXplOjAuNzVyZW07Y29sb3I6dmFyKC0tc3VjY2Vzcyl9CiAgICAubGl2ZS1kb3R7d2lkdGg6NnB4O2hlaWdodDo2cHg7Ym9yZGVyLXJhZGl1czo1MCU7YmFja2dyb3VuZDp2YXIoLS1zdWNjZXNzKTthbmltYXRpb246cHVsc2UgMnMgaW5maW5pdGV9CiAgICAKICAgIC8qIE1vYmlsZSBSZXNwb25zaXZlICovCiAgICBAbWVkaWEgKG1heC13aWR0aDogNzY4cHgpIHsKICAgICAgLm1vZHVsZS10YWJze2ZsZXgtd3JhcDp3cmFwfQogICAgICAubW9kdWxlLXRhYntmbGV4OjE7dGV4dC1hbGlnbjpjZW50ZXI7bWluLXdpZHRoOjEyMHB4fQogICAgICAuZ3JpZC0ye2dyaWQtdGVtcGxhdGUtY29sdW1uczoxZnJ9CiAgICAgIC5ncmlkLTN7Z3JpZC10ZW1wbGF0ZS1jb2x1bW5zOjFmcn0KICAgICAgLmdyaWQtNHtncmlkLXRlbXBsYXRlLWNvbHVtbnM6cmVwZWF0KDIsMWZyKX0KICAgICAgLmdyaWQtNXtncmlkLXRlbXBsYXRlLWNvbHVtbnM6cmVwZWF0KDIsMWZyKX0KICAgICAgLnRvcGJhcntwYWRkaW5nOjAgMTJweH0KICAgICAgLnN0YXR1cy1tb2RhbC1jb250ZW50e21pbi13aWR0aDphdXRvO21hcmdpbjoyMHB4O3dpZHRoOmNhbGMoMTAwJSAtIDQwcHgpfQogICAgICAuc3RhdHVzLW9wdGlvbnN7Z3JpZC10ZW1wbGF0ZS1jb2x1bW5zOjFmcn0KICAgIH0KICAgIAogICAgLyogUHJpbnQgU3R5bGVzICovCiAgICBAbWVkaWEgcHJpbnQgewogICAgICAudG9wYmFyLC50YWJzLC5tb2R1bGUtdGFicywuc3RhdHVzLWNvbnRyb2xzLC5xdWljay1idXR0b25zLC5leHBvcnQtY29udHJvbHN7ZGlzcGxheTpub25lICFpbXBvcnRhbnR9CiAgICAgIC5jYXJke2JyZWFrLWluc2lkZTphdm9pZDttYXJnaW4tYm90dG9tOjEwcHh9CiAgICAgIC5wYWdle21heC13aWR0aDpub25lO21hcmdpbjowO3BhZGRpbmc6MTBweH0KICAgICAgYm9keXtiYWNrZ3JvdW5kOiNmZmZ9CiAgICB9CiAgPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KICA8bWFpbiBjbGFzcz0icGFnZSI+CiAgICA8aDE+R2VuZXJhbCBNYW5hZ2VyIE9wZXJhdGlvbnMgQ2VudGVyPC9oMT4KICAgIAogICAgPCEtLSBNb2R1bGUgTmF2aWdhdGlvbiAtLT4KICAgIDxkaXYgY2xhc3M9Im1vZHVsZS10YWJzIj4KICAgICAgPGRpdiBjbGFzcz0ibW9kdWxlLXRhYiIgZGF0YS1tb2R1bGU9InJldmVudWUiPvCfk4ogUmV2ZW51ZSBBbmFseXRpY3M8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0ibW9kdWxlLXRhYiIgZGF0YS1tb2R1bGU9Im9wZXJhdGlvbnMiPuKame+4jyBDb3Vyc2UgT3BlcmF0aW9uczwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJtb2R1bGUtdGFiIGFjdGl2ZSIgZGF0YS1tb2R1bGU9InN0YWZmIj7wn5GlIFN0YWZmIE1hbmFnZW1lbnQ8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0ibW9kdWxlLXRhYiIgZGF0YS1tb2R1bGU9InJlcG9ydHMiPvCfk4ggUmVwb3J0cyAmIEFuYWx5dGljczwvZGl2PgogICAgPC9kaXY+CgogICAgPCEtLSBSZXZlbnVlIEFuYWx5dGljcyBNb2R1bGUgLS0+CiAgICA8ZGl2IGlkPSJyZXZlbnVlLW1vZHVsZSIgY2xhc3M9Im1vZHVsZS1jb250ZW50Ij4KICAgICAgPGRpdiBjbGFzcz0iZXhwb3J0LWNvbnRyb2xzIj4KICAgICAgICA8YnV0dG9uIGNsYXNzPSJleHBvcnQtYnRuIiBvbmNsaWNrPSJleHBvcnREYXRhKCdyZXZlbnVlJywgJ3BkZicpIj7wn5OEIEV4cG9ydCBQREY8L2J1dHRvbj4KICAgICAgICA8YnV0dG9uIGNsYXNzPSJleHBvcnQtYnRuIiBvbmNsaWNrPSJleHBvcnREYXRhKCdyZXZlbnVlJywgJ2V4Y2VsJykiPvCfk4ogRXhwb3J0IEV4Y2VsPC9idXR0b24+CiAgICAgICAgPGJ1dHRvbiBjbGFzcz0iZXhwb3J0LWJ0biIgb25jbGljaz0icHJpbnRSZXBvcnQoJ3JldmVudWUnKSI+8J+WqO+4jyBQcmludCBSZXBvcnQ8L2J1dHRvbj4KICAgICAgICA8YnV0dG9uIGNsYXNzPSJleHBvcnQtYnRuIiBvbmNsaWNrPSJzY2hlZHVsZVJlcG9ydCgncmV2ZW51ZScpIj7ij7AgU2NoZWR1bGUgUmVwb3J0PC9idXR0b24+CiAgICAgIDwvZGl2PgogICAgICAKICAgICAgPGRpdiBjbGFzcz0iZ3JpZCBncmlkLTUiPgogICAgICAgIDxkaXYgY2xhc3M9ImNhcmQgbWV0cmljLWNhcmQiPgogICAgICAgICAgPGRpdiBjbGFzcz0ibWV0cmljLXZhbHVlIiBzdHlsZT0iY29sb3I6dmFyKC0tc3VjY2VzcykiIGlkPSJ0b3RhbFJldmVudWUiPuC4vzg3NSwwMDA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9Im1ldHJpYy1sYWJlbCI+VG90YWwgUmV2ZW51ZSBUb2RheTwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ibWV0cmljLWNoYW5nZSB1cCIgaWQ9InJldmVudWVDaGFuZ2UiPisxOCUgdnMgeWVzdGVyZGF5PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY2FyZCBtZXRyaWMtY2FyZCI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJtZXRyaWMtdmFsdWUiIGlkPSJyb3VuZHNQbGF5ZWQiPjI0NzwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ibWV0cmljLWxhYmVsIj5Sb3VuZHMgUGxheWVkPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJtZXRyaWMtY2hhbmdlIHVwIiBpZD0icm91bmRzQ2hhbmdlIj4rMTIlIHZzIHllc3RlcmRheTwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNhcmQgbWV0cmljLWNhcmQiPgogICAgICAgICAgPGRpdiBjbGFzcz0ibWV0cmljLXZhbHVlIiBzdHlsZT0iY29sb3I6dmFyKC0tYnJhbmQpIiBpZD0iYXZnUmV2ZW51ZSI+4Li/Myw1NDA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9Im1ldHJpYy1sYWJlbCI+QXZnIFJldmVudWUvUm91bmQ8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9Im1ldHJpYy1jaGFuZ2UgdXAiIGlkPSJhdmdDaGFuZ2UiPis1JSB2cyB5ZXN0ZXJkYXk8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkIG1ldHJpYy1jYXJkIj4KICAgICAgICAgIDxkaXYgY2xhc3M9Im1ldHJpYy12YWx1ZSIgc3R5bGU9ImNvbG9yOnZhcigtLXdhcm5pbmcpIiBpZD0idXRpbGl6YXRpb24iPjg3JTwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ibWV0cmljLWxhYmVsIj5UZWUgU2hlZXQgVXRpbGl6YXRpb248L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9Im1ldHJpYy1jaGFuZ2UgZG93biIgaWQ9InV0aWxpemF0aW9uQ2hhbmdlIj4tMyUgdnMgeWVzdGVyZGF5PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY2FyZCBtZXRyaWMtY2FyZCI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJtZXRyaWMtdmFsdWUiIHN0eWxlPSJjb2xvcjp2YXIoLS1zdWNjZXNzKSIgaWQ9InByb2ZpdE1hcmdpbiI+MjIlPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJtZXRyaWMtbGFiZWwiPlByb2ZpdCBNYXJnaW48L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9Im1ldHJpYy1jaGFuZ2UgdXAiIGlkPSJtYXJnaW5DaGFuZ2UiPisyJSB2cyB5ZXN0ZXJkYXk8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CgogICAgICA8ZGl2IGNsYXNzPSJncmlkIGdyaWQtMiI+CiAgICAgICAgPGRpdiBjbGFzcz0iY2FyZCI+CiAgICAgICAgICA8aDI+UmV2ZW51ZSBieSBTb3VyY2U8L2gyPgogICAgICAgICAgPGRpdiBjbGFzcz0icmV2ZW51ZS1icmVha2Rvd24iIGlkPSJyZXZlbnVlQnJlYWtkb3duIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0icmV2ZW51ZS1pdGVtIiBvbmNsaWNrPSJkcmlsbERvd25SZXZlbnVlKCdncmVlbmZlZXMnKSI+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icmV2ZW51ZS1hbW91bnQiIHN0eWxlPSJjb2xvcjp2YXIoLS1zdWNjZXNzKSI+4Li/NDk3LDAwMDwvZGl2PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJldmVudWUtc291cmNlIj5HcmVlbiBGZWVzPC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icmV2ZW51ZS1wZXJjZW50Ij41Ni44JTwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0icmV2ZW51ZS1pdGVtIiBvbmNsaWNrPSJkcmlsbERvd25SZXZlbnVlKCdjYXJ0cycpIj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJyZXZlbnVlLWFtb3VudCIgc3R5bGU9ImNvbG9yOnZhcigtLWJyYW5kKSI+4Li/MTYyLDc1MDwvZGl2PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJldmVudWUtc291cmNlIj5DYXJ0IFJlbnRhbHM8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJyZXZlbnVlLXBlcmNlbnQiPjE4LjYlPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJyZXZlbnVlLWl0ZW0iIG9uY2xpY2s9ImRyaWxsRG93blJldmVudWUoJ3Byb3Nob3AnKSI+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icmV2ZW51ZS1hbW91bnQiIHN0eWxlPSJjb2xvcjp2YXIoLS13YXJuaW5nKSI+4Li/MTAxLDE1MDwvZGl2PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJldmVudWUtc291cmNlIj5Qcm8gU2hvcDwvZGl2PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJldmVudWUtcGVyY2VudCI+MTEuNiU8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InJldmVudWUtaXRlbSIgb25jbGljaz0iZHJpbGxEb3duUmV2ZW51ZSgnZm5iJykiPgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJldmVudWUtYW1vdW50IiBzdHlsZT0iY29sb3I6IzhiNWNmNiI+4Li/NjQsNDAwPC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icmV2ZW51ZS1zb3VyY2UiPkYmQjwvZGl2PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJldmVudWUtcGVyY2VudCI+Ny40JTwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0icmV2ZW51ZS1pdGVtIiBvbmNsaWNrPSJkcmlsbERvd25SZXZlbnVlKCdsZXNzb25zJykiPgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJldmVudWUtYW1vdW50IiBzdHlsZT0iY29sb3I6IzA2YjZkNCI+4Li/MzUsMDAwPC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icmV2ZW51ZS1zb3VyY2UiPkxlc3NvbnM8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJyZXZlbnVlLXBlcmNlbnQiPjQuMCU8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICAKICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkIj4KICAgICAgICAgIDxoMj5EYWlseSBSZXZlbnVlIFRyZW5kPC9oMj4KICAgICAgICAgIDxkaXYgc3R5bGU9ImhlaWdodDoyMDBweDtwb3NpdGlvbjpyZWxhdGl2ZTtwYWRkaW5nOjIwcHgiPgogICAgICAgICAgICA8c3ZnIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHZpZXdCb3g9IjAgMCA0MDAgMTYwIiBzdHlsZT0iYm9yZGVyLWJvdHRvbToxcHggc29saWQgdmFyKC0tYm9yZGVyKTtib3JkZXItbGVmdDoxcHggc29saWQgdmFyKC0tYm9yZGVyKSI+CiAgICAgICAgICAgICAgPCEtLSBHcmlkIGxpbmVzIC0tPgogICAgICAgICAgICAgIDxkZWZzPgogICAgICAgICAgICAgICAgPHBhdHRlcm4gaWQ9ImdyaWQiIHdpZHRoPSI0MCIgaGVpZ2h0PSIyMCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+CiAgICAgICAgICAgICAgICAgIDxwYXRoIGQ9Ik0gNDAgMCBMIDAgMCAwIDIwIiBmaWxsPSJub25lIiBzdHJva2U9IiNmMWY1ZjkiIHN0cm9rZS13aWR0aD0iMSIvPgogICAgICAgICAgICAgICAgPC9wYXR0ZXJuPgogICAgICAgICAgICAgIDwvZGVmcz4KICAgICAgICAgICAgICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2dyaWQpIiAvPgogICAgICAgICAgICAgIAogICAgICAgICAgICAgIDwhLS0gVHJlbmQgbGluZSAtLT4KICAgICAgICAgICAgICA8cG9seWxpbmUKICAgICAgICAgICAgICAgIGZpbGw9Im5vbmUiCiAgICAgICAgICAgICAgICBzdHJva2U9InZhcigtLWJyYW5kKSIKICAgICAgICAgICAgICAgIHN0cm9rZS13aWR0aD0iMyIKICAgICAgICAgICAgICAgIHBvaW50cz0iNDAsMTIwIDgwLDEwMCAxMjAsODAgMTYwLDExMCAyMDAsOTAgMjQwLDYwIDI4MCw3MCIKICAgICAgICAgICAgICAgIGlkPSJ0cmVuZExpbmUiCiAgICAgICAgICAgICAgLz4KICAgICAgICAgICAgICAKICAgICAgICAgICAgICA8IS0tIERhdGEgcG9pbnRzIC0tPgogICAgICAgICAgICAgIDxjaXJjbGUgY3g9IjQwIiBjeT0iMTIwIiByPSI0IiBmaWxsPSJ2YXIoLS1icmFuZCkiIGNsYXNzPSJkYXRhLXBvaW50IiBkYXRhLXZhbHVlPSLguL82NDBLIiAvPgogICAgICAgICAgICAgIDxjaXJjbGUgY3g9IjgwIiBjeT0iMTAwIiByPSI0IiBmaWxsPSJ2YXIoLS1icmFuZCkiIGNsYXNzPSJkYXRhLXBvaW50IiBkYXRhLXZhbHVlPSLguL83MjBLIiAvPgogICAgICAgICAgICAgIDxjaXJjbGUgY3g9IjEyMCIgY3k9IjgwIiByPSI0IiBmaWxsPSJ2YXIoLS1icmFuZCkiIGNsYXNzPSJkYXRhLXBvaW50IiBkYXRhLXZhbHVlPSLguL83OTBLIiAvPgogICAgICAgICAgICAgIDxjaXJjbGUgY3g9IjE2MCIgY3k9IjExMCIgcj0iNCIgZmlsbD0idmFyKC0tYnJhbmQpIiBjbGFzcz0iZGF0YS1wb2ludCIgZGF0YS12YWx1ZT0i4Li/NjgwSyIgLz4KICAgICAgICAgICAgICA8Y2lyY2xlIGN4PSIyMDAiIGN5PSI5MCIgcj0iNCIgZmlsbD0idmFyKC0tYnJhbmQpIiBjbGFzcz0iZGF0YS1wb2ludCIgZGF0YS12YWx1ZT0i4Li/NzUwSyIgLz4KICAgICAgICAgICAgICA8Y2lyY2xlIGN4PSIyNDAiIGN5PSI2MCIgcj0iNCIgZmlsbD0idmFyKC0tYnJhbmQpIiBjbGFzcz0iZGF0YS1wb2ludCIgZGF0YS12YWx1ZT0i4Li/ODUwSyIgLz4KICAgICAgICAgICAgICA8Y2lyY2xlIGN4PSIyODAiIGN5PSI3MCIgcj0iNCIgZmlsbD0idmFyKC0tc3VjY2VzcykiIGNsYXNzPSJkYXRhLXBvaW50IiBkYXRhLXZhbHVlPSLguL84NzVLIiAvPgogICAgICAgICAgICAgIAogICAgICAgICAgICAgIDwhLS0gWS1heGlzIGxhYmVscyAtLT4KICAgICAgICAgICAgICA8dGV4dCB4PSI1IiB5PSIyNSIgZm9udC1zaXplPSIxMCIgZmlsbD0idmFyKC0tbXV0ZWQpIj7guL85MDBLPC90ZXh0PgogICAgICAgICAgICAgIDx0ZXh0IHg9IjUiIHk9IjQ1IiBmb250LXNpemU9IjEwIiBmaWxsPSJ2YXIoLS1tdXRlZCkiPuC4vzgwMEs8L3RleHQ+CiAgICAgICAgICAgICAgPHRleHQgeD0iNSIgeT0iNjUiIGZvbnQtc2l6ZT0iMTAiIGZpbGw9InZhcigtLW11dGVkKSI+4Li/NzAwSzwvdGV4dD4KICAgICAgICAgICAgICA8dGV4dCB4PSI1IiB5PSI4NSIgZm9udC1zaXplPSIxMCIgZmlsbD0idmFyKC0tbXV0ZWQpIj7guL82MDBLPC90ZXh0PgogICAgICAgICAgICAgIDx0ZXh0IHg9IjUiIHk9IjEwNSIgZm9udC1zaXplPSIxMCIgZmlsbD0idmFyKC0tbXV0ZWQpIj7guL81MDBLPC90ZXh0PgogICAgICAgICAgICAgIDx0ZXh0IHg9IjUiIHk9IjEyNSIgZm9udC1zaXplPSIxMCIgZmlsbD0idmFyKC0tbXV0ZWQpIj7guL80MDBLPC90ZXh0PgogICAgICAgICAgICAgIDx0ZXh0IHg9IjUiIHk9IjE0NSIgZm9udC1zaXplPSIxMCIgZmlsbD0idmFyKC0tbXV0ZWQpIj7guL8zMDBLPC90ZXh0PgogICAgICAgICAgICAgIAogICAgICAgICAgICAgIDwhLS0gWC1heGlzIGxhYmVscyAtLT4KICAgICAgICAgICAgICA8dGV4dCB4PSIzNSIgeT0iMTU1IiBmb250LXNpemU9IjkiIGZpbGw9InZhcigtLW11dGVkKSI+TW9uPC90ZXh0PgogICAgICAgICAgICAgIDx0ZXh0IHg9Ijc1IiB5PSIxNTUiIGZvbnQtc2l6ZT0iOSIgZmlsbD0idmFyKC0tbXV0ZWQpIj5UdWU8L3RleHQ+CiAgICAgICAgICAgICAgPHRleHQgeD0iMTE1IiB5PSIxNTUiIGZvbnQtc2l6ZT0iOSIgZmlsbD0idmFyKC0tbXV0ZWQpIj5XZWQ8L3RleHQ+CiAgICAgICAgICAgICAgPHRleHQgeD0iMTU1IiB5PSIxNTUiIGZvbnQtc2l6ZT0iOSIgZmlsbD0idmFyKC0tbXV0ZWQpIj5UaHU8L3RleHQ+CiAgICAgICAgICAgICAgPHRleHQgeD0iMTk1IiB5PSIxNTUiIGZvbnQtc2l6ZT0iOSIgZmlsbD0idmFyKC0tbXV0ZWQpIj5Gcmk8L3RleHQ+CiAgICAgICAgICAgICAgPHRleHQgeD0iMjM1IiB5PSIxNTUiIGZvbnQtc2l6ZT0iOSIgZmlsbD0idmFyKC0tbXV0ZWQpIj5TYXQ8L3RleHQ+CiAgICAgICAgICAgICAgPHRleHQgeD0iMjc1IiB5PSIxNTUiIGZvbnQtc2l6ZT0iOSIgZmlsbD0idmFyKC0tbXV0ZWQpIj5TdW48L3RleHQ+CiAgICAgICAgICAgIDwvc3ZnPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJwb3NpdGlvbjphYnNvbHV0ZTtib3R0b206NXB4O3JpZ2h0OjEwcHg7Zm9udC1zaXplOjAuNzVyZW07Y29sb3I6dmFyKC0tc3VjY2VzcykiPgogICAgICAgICAgICAgIFRvZGF5OiDguL84NzUsMDAwICgrOC4yJSkKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CgogICAgICA8ZGl2IGNsYXNzPSJncmlkIGdyaWQtMiI+CiAgICAgICAgPGRpdiBjbGFzcz0iY2FyZCI+CiAgICAgICAgICA8aDI+UGVhayBIb3VycyBBbmFseXNpczwvaDI+CiAgICAgICAgICA8dGFibGUgY2xhc3M9ImRhdGEtdGFibGUiPgogICAgICAgICAgICA8dGhlYWQ+CiAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgPHRoPlRpbWUgU2xvdDwvdGg+CiAgICAgICAgICAgICAgICA8dGg+Um91bmRzPC90aD4KICAgICAgICAgICAgICAgIDx0aD5SZXZlbnVlPC90aD4KICAgICAgICAgICAgICAgIDx0aD5VdGlsaXphdGlvbjwvdGg+CiAgICAgICAgICAgICAgICA8dGg+QWN0aW9uczwvdGg+CiAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgPC90aGVhZD4KICAgICAgICAgICAgPHRib2R5PgogICAgICAgICAgICAgIDx0ciBvbmNsaWNrPSJ2aWV3VGltZVNsb3REZXRhaWxzKCc2LThhbScpIj4KICAgICAgICAgICAgICAgIDx0ZD42OjAwLTg6MDAgQU08L3RkPgogICAgICAgICAgICAgICAgPHRkPjI0PC90ZD4KICAgICAgICAgICAgICAgIDx0ZD7guL8xMDAsODAwPC90ZD4KICAgICAgICAgICAgICAgIDx0ZD48c3BhbiBjbGFzcz0ic3RhdHVzLWJhZGdlIHN0YXR1cy13b3JraW5nIj43NSU8L3NwYW4+PC90ZD4KICAgICAgICAgICAgICAgIDx0ZD48YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIiBvbmNsaWNrPSJldmVudC5zdG9wUHJvcGFnYXRpb24oKTsgb3B0aW1pemVTbG90KCc2LThhbScpIj5PcHRpbWl6ZTwvYnV0dG9uPjwvdGQ+CiAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICA8dHIgb25jbGljaz0idmlld1RpbWVTbG90RGV0YWlscygnOC0xMGFtJykiPgogICAgICAgICAgICAgICAgPHRkPjg6MDAtMTA6MDAgQU08L3RkPgogICAgICAgICAgICAgICAgPHRkPjMyPC90ZD4KICAgICAgICAgICAgICAgIDx0ZD7guL8xNDUsNjAwPC90ZD4KICAgICAgICAgICAgICAgIDx0ZD48c3BhbiBjbGFzcz0ic3RhdHVzLWJhZGdlIHN0YXR1cy13b3JraW5nIj45NSU8L3NwYW4+PC90ZD4KICAgICAgICAgICAgICAgIDx0ZD48YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIiBvbmNsaWNrPSJldmVudC5zdG9wUHJvcGFnYXRpb24oKTsgb3B0aW1pemVTbG90KCc4LTEwYW0nKSI+T3B0aW1pemU8L2J1dHRvbj48L3RkPgogICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgPHRyIG9uY2xpY2s9InZpZXdUaW1lU2xvdERldGFpbHMoJzEwLTEycG0nKSI+CiAgICAgICAgICAgICAgICA8dGQ+MTA6MDAtMTI6MDAgUE08L3RkPgogICAgICAgICAgICAgICAgPHRkPjI4PC90ZD4KICAgICAgICAgICAgICAgIDx0ZD7guL8xMjcsNDAwPC90ZD4KICAgICAgICAgICAgICAgIDx0ZD48c3BhbiBjbGFzcz0ic3RhdHVzLWJhZGdlIHN0YXR1cy13b3JraW5nIj44NSU8L3NwYW4+PC90ZD4KICAgICAgICAgICAgICAgIDx0ZD48YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIiBvbmNsaWNrPSJldmVudC5zdG9wUHJvcGFnYXRpb24oKTsgb3B0aW1pemVTbG90KCcxMC0xMnBtJykiPk9wdGltaXplPC9idXR0b24+PC90ZD4KICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgIDx0ciBvbmNsaWNrPSJ2aWV3VGltZVNsb3REZXRhaWxzKCcxMi0ycG0nKSI+CiAgICAgICAgICAgICAgICA8dGQ+MTI6MDAtMjowMCBQTTwvdGQ+CiAgICAgICAgICAgICAgICA8dGQ+MTg8L3RkPgogICAgICAgICAgICAgICAgPHRkPuC4vzgxLDkwMDwvdGQ+CiAgICAgICAgICAgICAgICA8dGQ+PHNwYW4gY2xhc3M9InN0YXR1cy1iYWRnZSBzdGF0dXMtYWJzZW50Ij41NSU8L3NwYW4+PC90ZD4KICAgICAgICAgICAgICAgIDx0ZD48YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIiBvbmNsaWNrPSJldmVudC5zdG9wUHJvcGFnYXRpb24oKTsgb3B0aW1pemVTbG90KCcxMi0ycG0nKSI+T3B0aW1pemU8L2J1dHRvbj48L3RkPgogICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgIDwvdGJvZHk+CiAgICAgICAgICA8L3RhYmxlPgogICAgICAgIDwvZGl2PgoKICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkIj4KICAgICAgICAgIDxoMj5SZXZlbnVlIE9wdGltaXphdGlvbjwvaDI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJhbGVydC1ib3ggYWxlcnQtaW5mbyI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OjYwMDtjb2xvcjp2YXIoLS1icmFuZCkiPvCfjq8gUGVhayBUaW1lIE9wcG9ydHVuaXR5PC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTowLjg3NXJlbSI+Q29uc2lkZXIgcHJlbWl1bSBwcmljaW5nIGZvciA4LTEwIEFNIHNsb3RzICg5NSUgdXRpbGl6YXRpb24pPC9kaXY+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tc20gYnRuLXByaW1hcnkiIHN0eWxlPSJtYXJnaW4tdG9wOjhweCIgb25jbGljaz0iaW1wbGVtZW50UHJpY2luZygnOC0xMGFtJykiPkltcGxlbWVudCBQcmljaW5nPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImFsZXJ0LWJveCBhbGVydC13YXJuaW5nIj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6NjAwO2NvbG9yOnZhcigtLXdhcm5pbmcpIj7imqDvuI8gTG93IFV0aWxpemF0aW9uIEFsZXJ0PC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTowLjg3NXJlbSI+MTItMiBQTSBzaG93cyBvbmx5IDU1JSB1dGlsaXphdGlvbi4gQ29uc2lkZXIgbHVuY2ggc3BlY2lhbHMuPC9kaXY+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tc20gYnRuLXdhcm5pbmciIHN0eWxlPSJtYXJnaW4tdG9wOjhweCIgb25jbGljaz0iY3JlYXRlUHJvbW90aW9uKCdsdW5jaCcpIj5DcmVhdGUgUHJvbW90aW9uPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImFsZXJ0LWJveCBhbGVydC1zdWNjZXNzIj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6NjAwO2NvbG9yOnZhcigtLXN1Y2Nlc3MpIj7wn5OIIEYmQiBHcm93dGg8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjAuODc1cmVtIj5GJkIgcmV2ZW51ZSB1cCAyMiUgdGhpcyBtb250aC4gRXhwYW5kIG1lbnUgb2ZmZXJpbmdzLjwvZGl2PgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIGJ0bi1zdWNjZXNzIiBzdHlsZT0ibWFyZ2luLXRvcDo4cHgiIG9uY2xpY2s9ImV4cGFuZE1lbnUoKSI+RXhwYW5kIE1lbnU8L2J1dHRvbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgoKICAgIDwhLS0gQ291cnNlIE9wZXJhdGlvbnMgTW9kdWxlIC0tPgogICAgPGRpdiBpZD0ib3BlcmF0aW9ucy1tb2R1bGUiIGNsYXNzPSJtb2R1bGUtY29udGVudCI+CiAgICAgIDxkaXYgY2xhc3M9ImV4cG9ydC1jb250cm9scyI+CiAgICAgICAgPGJ1dHRvbiBjbGFzcz0iZXhwb3J0LWJ0biIgb25jbGljaz0iZXhwb3J0RGF0YSgnb3BlcmF0aW9ucycsICdwZGYnKSI+8J+ThCBFeHBvcnQgUERGPC9idXR0b24+CiAgICAgICAgPGJ1dHRvbiBjbGFzcz0iZXhwb3J0LWJ0biIgb25jbGljaz0ic2VuZE1haW50ZW5hbmNlUmVwb3J0KCkiPvCfk6cgU2VuZCBSZXBvcnQ8L2J1dHRvbj4KICAgICAgICA8YnV0dG9uIGNsYXNzPSJleHBvcnQtYnRuIiBvbmNsaWNrPSJwcmludFJlcG9ydCgnb3BlcmF0aW9ucycpIj7wn5ao77iPIFByaW50IFJlcG9ydDwvYnV0dG9uPgogICAgICA8L2Rpdj4KICAgICAgCiAgICAgIDxkaXYgY2xhc3M9ImdyaWQgZ3JpZC00Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkIiBzdHlsZT0icG9zaXRpb246cmVsYXRpdmUiPgogICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLWluZGljYXRvciBzdGF0dXMtZ3JlZW4iPjwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ibWV0cmljLXZhbHVlIiBzdHlsZT0iY29sb3I6dmFyKC0tc3VjY2VzcykiPkV4Y2VsbGVudDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ibWV0cmljLWxhYmVsIj5Db3Vyc2UgQ29uZGl0aW9uPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6MC43cmVtO2NvbG9yOnZhcigtLW11dGVkKTttYXJnaW4tdG9wOjRweCI+TGFzdCB1cGRhdGVkOiAxIGhyIGFnbzwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNhcmQgd2VhdGhlci13aWRnZXQiIG9uY2xpY2s9InZpZXdEZXRhaWxlZFdlYXRoZXIoKSI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJ3ZWF0aGVyLXRlbXAiIGlkPSJ3ZWF0aGVyVGVtcCI+NzLCsEY8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9IndlYXRoZXItZGVzYyIgaWQ9IndlYXRoZXJEZXNjIj5QYXJ0bHkgQ2xvdWR5IOKAoiA1IG1waCB3aW5kczwvZGl2PgogICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjAuN3JlbTttYXJnaW4tdG9wOjRweDtvcGFjaXR5OjAuOCI+Q2xpY2sgZm9yIGZvcmVjYXN0PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY2FyZCIgc3R5bGU9InBvc2l0aW9uOnJlbGF0aXZlIj4KICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXR1cy1pbmRpY2F0b3Igc3RhdHVzLXllbGxvdyI+PC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJtZXRyaWMtdmFsdWUiIHN0eWxlPSJjb2xvcjp2YXIoLS13YXJuaW5nKSIgaWQ9ImF2Z1JvdW5kVGltZSI+NC4yIGhyczwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ibWV0cmljLWxhYmVsIj5BdmcgUm91bmQgVGltZTwvZGl2PgogICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjAuN3JlbTtjb2xvcjp2YXIoLS1tdXRlZCk7bWFyZ2luLXRvcDo0cHgiPlRhcmdldDogNC4wIGhyczwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNhcmQiIHN0eWxlPSJwb3NpdGlvbjpyZWxhdGl2ZSI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMtaW5kaWNhdG9yIHN0YXR1cy1ncmVlbiI+PC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJtZXRyaWMtdmFsdWUiIGlkPSJjYXJ0QXZhaWxhYmlsaXR5Ij45NSU8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9Im1ldHJpYy1sYWJlbCI+Q2FydCBGbGVldCBBdmFpbGFibGU8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTowLjdyZW07Y29sb3I6dmFyKC0tbXV0ZWQpO21hcmdpbi10b3A6NHB4Ij4zOCBvZiA0MCBjYXJ0czwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KCiAgICAgIDxkaXYgY2xhc3M9ImdyaWQgZ3JpZC0yIj4KICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkIj4KICAgICAgICAgIDxoMj5MaXZlIENvdXJzZSBUcmFmZmljPC9oMj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206MTJweCI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTowLjg3NXJlbTtjb2xvcjp2YXIoLS1tdXRlZCk7bWFyZ2luLWJvdHRvbTo4cHg7ZGlzcGxheTpmbGV4O2p1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuIj4KICAgICAgICAgICAgICA8c3Bhbj5Gcm9udCBOaW5lPC9zcGFuPgogICAgICAgICAgICAgIDxzcGFuIGlkPSJmcm9udE5pbmVTdGF0dXMiPjIgZ3JvdXBzIGJhY2tlZCB1cDwvc3Bhbj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgaWQ9ImZyb250TmluZSI+CiAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImNvdXJzZS1ob2xlIGhvbGUtY2xlYXIiIGRhdGEtaG9sZT0iMSIgb25jbGljaz0idmlld0hvbGVEZXRhaWxzKDEpIj4xPC9zcGFuPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJjb3Vyc2UtaG9sZSBob2xlLWNsZWFyIiBkYXRhLWhvbGU9IjIiIG9uY2xpY2s9InZpZXdIb2xlRGV0YWlscygyKSI+Mjwvc3Bhbj4KICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iY291cnNlLWhvbGUgaG9sZS1idXN5IiBkYXRhLWhvbGU9IjMiIG9uY2xpY2s9InZpZXdIb2xlRGV0YWlscygzKSI+Mzwvc3Bhbj4KICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iY291cnNlLWhvbGUgaG9sZS1iYWNrZWQtdXAiIGRhdGEtaG9sZT0iNCIgb25jbGljaz0idmlld0hvbGVEZXRhaWxzKDQpIj40PC9zcGFuPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJjb3Vyc2UtaG9sZSBob2xlLWJhY2tlZC11cCIgZGF0YS1ob2xlPSI1IiBvbmNsaWNrPSJ2aWV3SG9sZURldGFpbHMoNSkiPjU8L3NwYW4+CiAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImNvdXJzZS1ob2xlIGhvbGUtYnVzeSIgZGF0YS1ob2xlPSI2IiBvbmNsaWNrPSJ2aWV3SG9sZURldGFpbHMoNikiPjY8L3NwYW4+CiAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImNvdXJzZS1ob2xlIGhvbGUtY2xlYXIiIGRhdGEtaG9sZT0iNyIgb25jbGljaz0idmlld0hvbGVEZXRhaWxzKDcpIj43PC9zcGFuPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJjb3Vyc2UtaG9sZSBob2xlLWNsZWFyIiBkYXRhLWhvbGU9IjgiIG9uY2xpY2s9InZpZXdIb2xlRGV0YWlscyg4KSI+ODwvc3Bhbj4KICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iY291cnNlLWhvbGUgaG9sZS1jbGVhciIgZGF0YS1ob2xlPSI5IiBvbmNsaWNrPSJ2aWV3SG9sZURldGFpbHMoOSkiPjk8L3NwYW4+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6MC44NzVyZW07Y29sb3I6dmFyKC0tbXV0ZWQpO21hcmdpbi1ib3R0b206OHB4O2Rpc3BsYXk6ZmxleDtqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbiI+CiAgICAgICAgICAgICAgPHNwYW4+QmFjayBOaW5lPC9zcGFuPgogICAgICAgICAgICAgIDxzcGFuIGlkPSJiYWNrTmluZVN0YXR1cyI+Rmxvd2luZyB3ZWxsPC9zcGFuPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBpZD0iYmFja05pbmUiPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJjb3Vyc2UtaG9sZSBob2xlLWNsZWFyIiBkYXRhLWhvbGU9IjEwIiBvbmNsaWNrPSJ2aWV3SG9sZURldGFpbHMoMTApIj4xMDwvc3Bhbj4KICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iY291cnNlLWhvbGUgaG9sZS1jbGVhciIgZGF0YS1ob2xlPSIxMSIgb25jbGljaz0idmlld0hvbGVEZXRhaWxzKDExKSI+MTE8L3NwYW4+CiAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImNvdXJzZS1ob2xlIGhvbGUtY2xlYXIiIGRhdGEtaG9sZT0iMTIiIG9uY2xpY2s9InZpZXdIb2xlRGV0YWlscygxMikiPjEyPC9zcGFuPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJjb3Vyc2UtaG9sZSBob2xlLWJ1c3kiIGRhdGEtaG9sZT0iMTMiIG9uY2xpY2s9InZpZXdIb2xlRGV0YWlscygxMykiPjEzPC9zcGFuPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJjb3Vyc2UtaG9sZSBob2xlLWJ1c3kiIGRhdGEtaG9sZT0iMTQiIG9uY2xpY2s9InZpZXdIb2xlRGV0YWlscygxNCkiPjE0PC9zcGFuPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJjb3Vyc2UtaG9sZSBob2xlLWNsZWFyIiBkYXRhLWhvbGU9IjE1IiBvbmNsaWNrPSJ2aWV3SG9sZURldGFpbHMoMTUpIj4xNTwvc3Bhbj4KICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iY291cnNlLWhvbGUgaG9sZS1jbGVhciIgZGF0YS1ob2xlPSIxNiIgb25jbGljaz0idmlld0hvbGVEZXRhaWxzKDE2KSI+MTY8L3NwYW4+CiAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImNvdXJzZS1ob2xlIGhvbGUtY2xlYXIiIGRhdGEtaG9sZT0iMTciIG9uY2xpY2s9InZpZXdIb2xlRGV0YWlscygxNykiPjE3PC9zcGFuPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJjb3Vyc2UtaG9sZSBob2xlLWNsZWFyIiBkYXRhLWhvbGU9IjE4IiBvbmNsaWNrPSJ2aWV3SG9sZURldGFpbHMoMTgpIj4xODwvc3Bhbj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi10b3A6MTJweDtkaXNwbGF5OmZsZXg7Z2FwOjhweDtmbGV4LXdyYXA6d3JhcCI+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tc20gYnRuLXByaW1hcnkiIG9uY2xpY2s9InNlbmRQYWNlQWxlcnQoJ2FsbCcpIj5TZW5kIFBhY2UgQWxlcnQ8L2J1dHRvbj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSBidG4td2FybmluZyIgb25jbGljaz0iZGVwbG95UmFuZ2VyKCkiPkRlcGxveSBSYW5nZXI8L2J1dHRvbj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSIgb25jbGljaz0icmVmcmVzaENvdXJzZVN0YXR1cygpIj5SZWZyZXNoIFN0YXR1czwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CgogICAgICAgIDxkaXYgY2xhc3M9ImNhcmQiPgogICAgICAgICAgPGgyPlBhY2Ugb2YgUGxheSBNb25pdG9yaW5nPC9oMj4KICAgICAgICAgIDx0YWJsZSBjbGFzcz0iZGF0YS10YWJsZSI+CiAgICAgICAgICAgIDx0aGVhZD4KICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICA8dGg+R3JvdXA8L3RoPgogICAgICAgICAgICAgICAgPHRoPkN1cnJlbnQgSG9sZTwvdGg+CiAgICAgICAgICAgICAgICA8dGg+VGltZSBCZWhpbmQ8L3RoPgogICAgICAgICAgICAgICAgPHRoPlN0YXR1czwvdGg+CiAgICAgICAgICAgICAgICA8dGg+QWN0aW9uczwvdGg+CiAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgPC90aGVhZD4KICAgICAgICAgICAgPHRib2R5IGlkPSJwYWNlVGFibGUiPgogICAgICAgICAgICAgIDx0ciBvbmNsaWNrPSJ2aWV3R3JvdXBEZXRhaWxzKCdzbWl0aCcpIj4KICAgICAgICAgICAgICAgIDx0ZD5TbWl0aCBHcm91cDwvdGQ+CiAgICAgICAgICAgICAgICA8dGQ+SG9sZSA0PC90ZD4KICAgICAgICAgICAgICAgIDx0ZD4xNSBtaW48L3RkPgogICAgICAgICAgICAgICAgPHRkPjxzcGFuIGNsYXNzPSJwYWNlLWluZGljYXRvciBwYWNlLXNsb3ciPlNsb3c8L3NwYW4+PC90ZD4KICAgICAgICAgICAgICAgIDx0ZD48YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIGJ0bi13YXJuaW5nIiBvbmNsaWNrPSJldmVudC5zdG9wUHJvcGFnYXRpb24oKTsgY29udGFjdEdyb3VwKCdzbWl0aCcpIj5Db250YWN0PC9idXR0b24+PC90ZD4KICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgIDx0ciBvbmNsaWNrPSJ2aWV3R3JvdXBEZXRhaWxzKCdjb3Jwb3JhdGUnKSI+CiAgICAgICAgICAgICAgICA8dGQ+Q29ycG9yYXRlIE91dGluZzwvdGQ+CiAgICAgICAgICAgICAgICA8dGQ+SG9sZSA1PC90ZD4KICAgICAgICAgICAgICAgIDx0ZD44IG1pbjwvdGQ+CiAgICAgICAgICAgICAgICA8dGQ+PHNwYW4gY2xhc3M9InBhY2UtaW5kaWNhdG9yIHBhY2Utbm9ybWFsIj5Ob3JtYWw8L3NwYW4+PC90ZD4KICAgICAgICAgICAgICAgIDx0ZD48YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIiBvbmNsaWNrPSJldmVudC5zdG9wUHJvcGFnYXRpb24oKTsgdmlld0dyb3VwRGV0YWlscygnY29ycG9yYXRlJykiPkRldGFpbHM8L2J1dHRvbj48L3RkPgogICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgPHRyIG9uY2xpY2s9InZpZXdHcm91cERldGFpbHMoJ2pvaG5zb24nKSI+CiAgICAgICAgICAgICAgICA8dGQ+Sm9obnNvbiBHcm91cDwvdGQ+CiAgICAgICAgICAgICAgICA8dGQ+SG9sZSAxMzwvdGQ+CiAgICAgICAgICAgICAgICA8dGQ+T24gdGltZTwvdGQ+CiAgICAgICAgICAgICAgICA8dGQ+PHNwYW4gY2xhc3M9InBhY2UtaW5kaWNhdG9yIHBhY2UtZmFzdCI+RmFzdDwvc3Bhbj48L3RkPgogICAgICAgICAgICAgICAgPHRkPjxidXR0b24gY2xhc3M9ImJ0biBidG4tc20gYnRuLXN1Y2Nlc3MiIG9uY2xpY2s9ImV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOyByZXdhcmRHcm91cCgnam9obnNvbicpIj5SZXdhcmQ8L2J1dHRvbj48L3RkPgogICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgIDwvdGJvZHk+CiAgICAgICAgICA8L3RhYmxlPgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KCiAgICAgIDxkaXYgY2xhc3M9ImdyaWQgZ3JpZC0zIj4KICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkIj4KICAgICAgICAgIDxoMj5Db3Vyc2UgQ29uZGl0aW9uczwvaDI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzdW1tYXJ5LWdyaWQiPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdW1tYXJ5LWl0ZW0iIG9uY2xpY2s9InZpZXdDb25kaXRpb25EZXRhaWxzKCdncmVlbnMnKSI+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3VtbWFyeS1udW1iZXIiIHN0eWxlPSJjb2xvcjp2YXIoLS1zdWNjZXNzKSI+RXhjZWxsZW50PC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3VtbWFyeS1sYWJlbCI+R3JlZW5zPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdW1tYXJ5LWl0ZW0iIG9uY2xpY2s9InZpZXdDb25kaXRpb25EZXRhaWxzKCdmYWlyd2F5cycpIj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdW1tYXJ5LW51bWJlciIgc3R5bGU9ImNvbG9yOnZhcigtLWJyYW5kKSI+R29vZDwvZGl2PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN1bW1hcnktbGFiZWwiPkZhaXJ3YXlzPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdW1tYXJ5LWl0ZW0iIG9uY2xpY2s9InZpZXdDb25kaXRpb25EZXRhaWxzKCdidW5rZXJzJykiPgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN1bW1hcnktbnVtYmVyIiBzdHlsZT0iY29sb3I6dmFyKC0td2FybmluZykiPkZhaXI8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdW1tYXJ5LWxhYmVsIj5CdW5rZXJzPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdW1tYXJ5LWl0ZW0iIG9uY2xpY2s9InZpZXdDb25kaXRpb25EZXRhaWxzKCd0ZWVzJykiPgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN1bW1hcnktbnVtYmVyIiBzdHlsZT0iY29sb3I6dmFyKC0tc3VjY2VzcykiPkV4Y2VsbGVudDwvZGl2PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN1bW1hcnktbGFiZWwiPlRlZXM8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tcHJpbWFyeSIgc3R5bGU9IndpZHRoOjEwMCU7bWFyZ2luLXRvcDoxMnB4IiBvbmNsaWNrPSJ1cGRhdGVDb25kaXRpb25zKCkiPlVwZGF0ZSBDb25kaXRpb25zPC9idXR0b24+CiAgICAgICAgPC9kaXY+CgogICAgICAgIDxkaXYgY2xhc3M9ImNhcmQiPgogICAgICAgICAgPGgyPlRvZGF5J3MgTWFpbnRlbmFuY2U8L2gyPgogICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTo4cHg7Zm9udC1zaXplOjAuODc1cmVtO2Rpc3BsYXk6ZmxleDtqdXN0aWZ5LWNvbnRlbnQ6YmV0d2VlbjthbGlnbi1pdGVtczpjZW50ZXIiPgogICAgICAgICAgICA8c3Bhbj48c3BhbiBzdHlsZT0iY29sb3I6dmFyKC0tc3VjY2VzcykiPuKckzwvc3Bhbj4gR3JlZW4gTW93aW5nIC0gQ29tcGxldGVkPC9zcGFuPgogICAgICAgICAgICA8c3BhbiBzdHlsZT0iZm9udC1zaXplOjAuN3JlbTtjb2xvcjp2YXIoLS1tdXRlZCkiPjY6MzAgQU08L3NwYW4+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206OHB4O2ZvbnQtc2l6ZTowLjg3NXJlbTtkaXNwbGF5OmZsZXg7anVzdGlmeS1jb250ZW50OmJldHdlZW47YWxpZ24taXRlbXM6Y2VudGVyIj4KICAgICAgICAgICAgPHNwYW4+PHNwYW4gc3R5bGU9ImNvbG9yOnZhcigtLXdhcm5pbmcpIj7il488L3NwYW4+IFRlZSBCb3ggTWFpbnRlbmFuY2UgLSBJbiBQcm9ncmVzczwvc3Bhbj4KICAgICAgICAgICAgPHNwYW4gc3R5bGU9ImZvbnQtc2l6ZTowLjdyZW07Y29sb3I6dmFyKC0tbXV0ZWQpIj5TdGFydGVkIDE6MDAgUE08L3NwYW4+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206OHB4O2ZvbnQtc2l6ZTowLjg3NXJlbTtkaXNwbGF5OmZsZXg7anVzdGlmeS1jb250ZW50OmJldHdlZW47YWxpZ24taXRlbXM6Y2VudGVyIj4KICAgICAgICAgICAgPHNwYW4+PHNwYW4gc3R5bGU9ImNvbG9yOnZhcigtLW11dGVkKSI+4peLPC9zcGFuPiBCdW5rZXIgUmFraW5nIC0gU2NoZWR1bGVkIDI6MDAgUE08L3NwYW4+CiAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJmb250LXNpemU6MC43cmVtO2NvbG9yOnZhcigtLW11dGVkKSI+MzAgbWluPC9zcGFuPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOjhweDtmb250LXNpemU6MC44NzVyZW07ZGlzcGxheTpmbGV4O2p1c3RpZnktY29udGVudDpiZXR3ZWVuO2FsaWduLWl0ZW1zOmNlbnRlciI+CiAgICAgICAgICAgIDxzcGFuPjxzcGFuIHN0eWxlPSJjb2xvcjp2YXIoLS1tdXRlZCkiPuKXizwvc3Bhbj4gQ2FydCBQYXRoIENsZWFuaW5nIC0gU2NoZWR1bGVkIDQ6MDAgUE08L3NwYW4+CiAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJmb250LXNpemU6MC43cmVtO2NvbG9yOnZhcigtLW11dGVkKSI+NDUgbWluPC9zcGFuPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXByaW1hcnkiIHN0eWxlPSJ3aWR0aDoxMDAlO21hcmdpbi10b3A6MTJweCIgb25jbGljaz0iYWRkTWFpbnRlbmFuY2VUYXNrKCkiPkFkZCBUYXNrPC9idXR0b24+CiAgICAgICAgPC9kaXY+CgogICAgICAgIDxkaXYgY2xhc3M9ImNhcmQiPgogICAgICAgICAgPGgyPkVxdWlwbWVudCBBbGVydHM8L2gyPgogICAgICAgICAgPGRpdiBjbGFzcz0iYWxlcnQtYm94IGFsZXJ0LWRhbmdlciIgc3R5bGU9Im1hcmdpbi1ib3R0b206OHB4O3BhZGRpbmc6OHB4Ij4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6NjAwO2ZvbnQtc2l6ZTowLjg3NXJlbSI+8J+UpyBNb3dlciAjMyAtIFNlcnZpY2UgRHVlPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTowLjc1cmVtO21hcmdpbjo0cHggMCI+TGFzdCBzZXJ2aWNlZDogNDUgZGF5cyBhZ288L2Rpdj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSBidG4tZGFuZ2VyIiBvbmNsaWNrPSJzY2hlZHVsZVNlcnZpY2UoJ21vd2VyMycpIj5TY2hlZHVsZSBTZXJ2aWNlPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImFsZXJ0LWJveCBhbGVydC13YXJuaW5nIiBzdHlsZT0ibWFyZ2luLWJvdHRvbTo4cHg7cGFkZGluZzo4cHgiPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDo2MDA7Zm9udC1zaXplOjAuODc1cmVtIj7wn5SLIENhcnQgMTUgLSBNYWludGVuYW5jZTwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6MC43NXJlbTttYXJnaW46NHB4IDAiPkJhdHRlcnkgcmVwbGFjZW1lbnQgbmVlZGVkPC9kaXY+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tc20gYnRuLXdhcm5pbmciIG9uY2xpY2s9InNjaGVkdWxlU2VydmljZSgnY2FydDE1JykiPlNjaGVkdWxlIFJlcGFpcjwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJhbGVydC1ib3ggYWxlcnQtaW5mbyIgc3R5bGU9Im1hcmdpbi1ib3R0b206OHB4O3BhZGRpbmc6OHB4Ij4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6NjAwO2ZvbnQtc2l6ZTowLjg3NXJlbSI+4oS577iPIFNwcmlua2xlciBTeXN0ZW0gQ2hlY2s8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjAuNzVyZW07bWFyZ2luOjRweCAwIj5Nb250aGx5IGluc3BlY3Rpb24gZHVlPC9kaXY+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tc20iIG9uY2xpY2s9InNjaGVkdWxlSW5zcGVjdGlvbignc3ByaW5rbGVycycpIj5TY2hlZHVsZSBJbnNwZWN0aW9uPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KCiAgICA8IS0tIFN0YWZmIE1hbmFnZW1lbnQgTW9kdWxlIC0tPgogICAgPGRpdiBpZD0ic3RhZmYtbW9kdWxlIiBjbGFzcz0ibW9kdWxlLWNvbnRlbnQgYWN0aXZlIj4KICAgICAgPGRpdiBjbGFzcz0iZXhwb3J0LWNvbnRyb2xzIj4KICAgICAgICA8YnV0dG9uIGNsYXNzPSJleHBvcnQtYnRuIiBvbmNsaWNrPSJleHBvcnREYXRhKCdzdGFmZicsICdwZGYnKSI+8J+ThCBFeHBvcnQgUERGPC9idXR0b24+CiAgICAgICAgPGJ1dHRvbiBjbGFzcz0iZXhwb3J0LWJ0biIgb25jbGljaz0iZXhwb3J0RGF0YSgnc3RhZmYnLCAnZXhjZWwnKSI+8J+TiiBFeHBvcnQgRXhjZWw8L2J1dHRvbj4KICAgICAgICA8YnV0dG9uIGNsYXNzPSJleHBvcnQtYnRuIiBvbmNsaWNrPSJzZW5kU3RhZmZSZXBvcnQoKSI+8J+TpyBTZW5kIFJlcG9ydDwvYnV0dG9uPgogICAgICAgIDxidXR0b24gY2xhc3M9ImV4cG9ydC1idG4iIG9uY2xpY2s9InByaW50UmVwb3J0KCdzdGFmZicpIj7wn5ao77iPIFByaW50IFJlcG9ydDwvYnV0dG9uPgogICAgICA8L2Rpdj4KICAgICAgCiAgICAgIDwhLS0gR2xvYmFsIFNlYXJjaCAtLT4KICAgICAgPGRpdiBjbGFzcz0ic2VhcmNoLWNvbnRhaW5lciI+CiAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIGNsYXNzPSJzZWFyY2gtaW5wdXQiIGlkPSJnbG9iYWxTZWFyY2giIHBsYWNlaG9sZGVyPSJTZWFyY2ggYWxsIHN0YWZmIGJ5IG5hbWUsIElELCByb2xlLCBvciBkZXBhcnRtZW50Li4uIiBvbmlucHV0PSJnbG9iYWxTdGFmZlNlYXJjaCh0aGlzLnZhbHVlKSI+CiAgICAgICAgPHNwYW4gY2xhc3M9InNlYXJjaC1pY29uIj7wn5SNPC9zcGFuPgogICAgICA8L2Rpdj4KICAgICAgCiAgICAgIDxkaXYgY2xhc3M9ImdyaWQgZ3JpZC00Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkIG1ldHJpYy1jYXJkIj4KICAgICAgICAgIDxkaXYgY2xhc3M9Im1ldHJpYy12YWx1ZSIgc3R5bGU9ImNvbG9yOnZhcigtLXN1Y2Nlc3MpIiBpZD0ic3RhZmZPbkR1dHkiPjMyPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJtZXRyaWMtbGFiZWwiPlN0YWZmIE9uIER1dHk8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTowLjdyZW07Y29sb3I6dmFyKC0tbXV0ZWQpO21hcmdpbi10b3A6NHB4Ij5vZiA0OSB0b3RhbDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNhcmQgbWV0cmljLWNhcmQiPgogICAgICAgICAgPGRpdiBjbGFzcz0ibWV0cmljLXZhbHVlIiBzdHlsZT0iY29sb3I6dmFyKC0td2FybmluZykiIGlkPSJzdGFmZk9uQnJlYWsiPjU8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9Im1ldHJpYy1sYWJlbCI+T24gQnJlYWs8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTowLjdyZW07Y29sb3I6dmFyKC0tbXV0ZWQpO21hcmdpbi10b3A6NHB4Ij5hdmc6IDE1IG1pbjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNhcmQgbWV0cmljLWNhcmQiPgogICAgICAgICAgPGRpdiBjbGFzcz0ibWV0cmljLXZhbHVlIiBzdHlsZT0iY29sb3I6dmFyKC0tbXV0ZWQpIiBpZD0ic3RhZmZEYXlPZmYiPjEyPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJtZXRyaWMtbGFiZWwiPkRheSBPZmY8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTowLjdyZW07Y29sb3I6dmFyKC0tbXV0ZWQpO21hcmdpbi10b3A6NHB4Ij5zY2hlZHVsZWQ8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkIG1ldHJpYy1jYXJkIj4KICAgICAgICAgIDxkaXYgY2xhc3M9Im1ldHJpYy12YWx1ZSIgc3R5bGU9ImNvbG9yOnZhcigtLWRhbmdlcikiIGlkPSJzdGFmZkFic2VudCI+MjwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ibWV0cmljLWxhYmVsIj5BYnNlbnQ8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTowLjdyZW07Y29sb3I6dmFyKC0tbXV0ZWQpO21hcmdpbi10b3A6NHB4Ij51bmV4Y3VzZWQ8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CgogICAgICA8ZGl2IGNsYXNzPSJncmlkIGdyaWQtMiI+CiAgICAgICAgPGRpdiBjbGFzcz0iY2FyZCI+CiAgICAgICAgICA8aDI+RGVwYXJ0bWVudCBDb3ZlcmFnZTwvaDI+CiAgICAgICAgICA8dGFibGUgY2xhc3M9ImRhdGEtdGFibGUiPgogICAgICAgICAgICA8dGhlYWQ+CiAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgPHRoPkRlcGFydG1lbnQ8L3RoPgogICAgICAgICAgICAgICAgPHRoPlNjaGVkdWxlZDwvdGg+CiAgICAgICAgICAgICAgICA8dGg+UHJlc2VudDwvdGg+CiAgICAgICAgICAgICAgICA8dGg+Q292ZXJhZ2U8L3RoPgogICAgICAgICAgICAgICAgPHRoPkFjdGlvbnM8L3RoPgogICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgIDwvdGhlYWQ+CiAgICAgICAgICAgIDx0Ym9keT4KICAgICAgICAgICAgICA8dHIgb25jbGljaz0idmlld0RlcGFydG1lbnREZXRhaWxzKCdjYWRkaWVzJykiPgogICAgICAgICAgICAgICAgPHRkPkNhZGRpZXM8L3RkPgogICAgICAgICAgICAgICAgPHRkPjEyPC90ZD4KICAgICAgICAgICAgICAgIDx0ZD4xMTwvdGQ+CiAgICAgICAgICAgICAgICA8dGQ+PHNwYW4gY2xhc3M9InN0YXR1cy1iYWRnZSBzdGF0dXMtd29ya2luZyI+OTIlPC9zcGFuPjwvdGQ+CiAgICAgICAgICAgICAgICA8dGQ+PGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSIgb25jbGljaz0iZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7IG1hbmFnZURlcGFydG1lbnQoJ2NhZGRpZXMnKSI+TWFuYWdlPC9idXR0b24+PC90ZD4KICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgIDx0ciBvbmNsaWNrPSJ2aWV3RGVwYXJ0bWVudERldGFpbHMoJ3Byb3Nob3AnKSI+CiAgICAgICAgICAgICAgICA8dGQ+UHJvIFNob3A8L3RkPgogICAgICAgICAgICAgICAgPHRkPjY8L3RkPgogICAgICAgICAgICAgICAgPHRkPjY8L3RkPgogICAgICAgICAgICAgICAgPHRkPjxzcGFuIGNsYXNzPSJzdGF0dXMtYmFkZ2Ugc3RhdHVzLXdvcmtpbmciPjEwMCU8L3NwYW4+PC90ZD4KICAgICAgICAgICAgICAgIDx0ZD48YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIiBvbmNsaWNrPSJldmVudC5zdG9wUHJvcGFnYXRpb24oKTsgbWFuYWdlRGVwYXJ0bWVudCgncHJvc2hvcCcpIj5NYW5hZ2U8L2J1dHRvbj48L3RkPgogICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgPHRyIG9uY2xpY2s9InZpZXdEZXBhcnRtZW50RGV0YWlscygnbWFpbnRlbmFuY2UnKSI+CiAgICAgICAgICAgICAgICA8dGQ+TWFpbnRlbmFuY2U8L3RkPgogICAgICAgICAgICAgICAgPHRkPjg8L3RkPgogICAgICAgICAgICAgICAgPHRkPjc8L3RkPgogICAgICAgICAgICAgICAgPHRkPjxzcGFuIGNsYXNzPSJzdGF0dXMtYmFkZ2Ugc3RhdHVzLWJyZWFrIj44OCU8L3NwYW4+PC90ZD4KICAgICAgICAgICAgICAgIDx0ZD48YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIiBvbmNsaWNrPSJldmVudC5zdG9wUHJvcGFnYXRpb24oKTsgbWFuYWdlRGVwYXJ0bWVudCgnbWFpbnRlbmFuY2UnKSI+TWFuYWdlPC9idXR0b24+PC90ZD4KICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgIDx0ciBvbmNsaWNrPSJ2aWV3RGVwYXJ0bWVudERldGFpbHMoJ2ZuYicpIj4KICAgICAgICAgICAgICAgIDx0ZD5Gb29kICYgQmV2ZXJhZ2U8L3RkPgogICAgICAgICAgICAgICAgPHRkPjEwPC90ZD4KICAgICAgICAgICAgICAgIDx0ZD44PC90ZD4KICAgICAgICAgICAgICAgIDx0ZD48c3BhbiBjbGFzcz0ic3RhdHVzLWJhZGdlIHN0YXR1cy1hYnNlbnQiPjgwJTwvc3Bhbj48L3RkPgogICAgICAgICAgICAgICAgPHRkPjxidXR0b24gY2xhc3M9ImJ0biBidG4tc20iIG9uY2xpY2s9ImV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOyBtYW5hZ2VEZXBhcnRtZW50KCdmbmInKSI+TWFuYWdlPC9idXR0b24+PC90ZD4KICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICA8L3Rib2R5PgogICAgICAgICAgPC90YWJsZT4KICAgICAgICA8L2Rpdj4KCiAgICAgICAgPGRpdiBjbGFzcz0iY2FyZCI+CiAgICAgICAgICA8aDI+U3RhZmYgQWxlcnRzICYgTm90aWZpY2F0aW9uczwvaDI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJhbGVydC1ib3ggYWxlcnQtZGFuZ2VyIiBzdHlsZT0ibWFyZ2luLWJvdHRvbTo4cHg7cGFkZGluZzo4cHgiPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDo2MDA7Zm9udC1zaXplOjAuODc1cmVtIj7wn5qoIEF0dGVuZGFuY2UgQWxlcnQ8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjAuNzVyZW0iPk1hcmlhIFNhbnRvcyAoRiZCKSAtIE5vIHNob3csIG5vIGNhbGw8L2Rpdj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSBidG4tZGFuZ2VyIiBvbmNsaWNrPSJoYW5kbGVBdHRlbmRhbmNlSXNzdWUoJ21hcmlhX3NhbnRvcycpIj5UYWtlIEFjdGlvbjwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJhbGVydC1ib3ggYWxlcnQtd2FybmluZyIgc3R5bGU9Im1hcmdpbi1ib3R0b206OHB4O3BhZGRpbmc6OHB4Ij4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6NjAwO2ZvbnQtc2l6ZTowLjg3NXJlbSI+8J+TmiBUcmFpbmluZyBEdWU8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjAuNzVyZW0iPjMgc3RhZmYgbWVtYmVycyBoYXZlIG92ZXJkdWUgY2VydGlmaWNhdGlvbnM8L2Rpdj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSBidG4td2FybmluZyIgb25jbGljaz0idmlld1RyYWluaW5nT3ZlcmR1ZSgpIj5WaWV3IERldGFpbHM8L2J1dHRvbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iYWxlcnQtYm94IGFsZXJ0LWluZm8iIHN0eWxlPSJtYXJnaW4tYm90dG9tOjhweDtwYWRkaW5nOjhweCI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OjYwMDtjb2xvcjp2YXIoLS1icmFuZCkiPvCfk4UgU2NoZWR1bGUgUmVxdWVzdDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6MC43NXJlbSI+MiB0aW1lLW9mZiByZXF1ZXN0cyBwZW5kaW5nIGFwcHJvdmFsPC9kaXY+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tc20gYnRuLXByaW1hcnkiIG9uY2xpY2s9InJldmlld1RpbWVPZmZSZXF1ZXN0cygpIj5SZXZpZXcgUmVxdWVzdHM8L2J1dHRvbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iYWxlcnQtYm94IGFsZXJ0LXN1Y2Nlc3MiIHN0eWxlPSJtYXJnaW4tYm90dG9tOjhweDtwYWRkaW5nOjhweCI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OjYwMDtjb2xvcjp2YXIoLS1zdWNjZXNzKSI+4q2QIFBlcmZvcm1hbmNlIE5vdGU8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjAuNzVyZW0iPkRhdmlkIENoZW4gY29tcGxldGVkIGNhZGR5IHRyYWluaW5nIGNlcnRpZmljYXRpb248L2Rpdj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSBidG4tc3VjY2VzcyIgb25jbGljaz0iYWNrbm93bGVkZ2VBY2hpZXZlbWVudCgnZGF2aWRfY2hlbicpIj5BY2tub3dsZWRnZTwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgoKICAgICAgPGRpdiBjbGFzcz0iZGVwYXJ0bWVudC1zZWN0aW9uIj4KICAgICAgICA8ZGl2IGNsYXNzPSJkZXBhcnRtZW50LWhlYWRlciI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJkZXBhcnRtZW50LXRpdGxlIj5DYWRkaWVzPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJkZXBhcnRtZW50LWNvdW50IiBpZD0iY2FkZHlDb3VudCI+MTEgb2YgMTIgcHJlc2VudDwvZGl2PgogICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTpmbGV4O2dhcDo4cHgiPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIGJ0bi1wcmltYXJ5IiBvbmNsaWNrPSJhc3NpZ25DYWRkeSgpIj5Bc3NpZ24gQ2FkZHk8L2J1dHRvbj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSIgb25jbGljaz0iYnVsa1N0YXR1c1VwZGF0ZSgnY2FkZGllcycpIj5CdWxrIFVwZGF0ZTwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0ic2VhcmNoLWNvbnRhaW5lciIgc3R5bGU9Im1hcmdpbi1ib3R0b206MTJweCI+CiAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgY2xhc3M9InNlYXJjaC1pbnB1dCIgaWQ9ImNhZGR5U2VhcmNoIiBwbGFjZWhvbGRlcj0iU2VhcmNoIGNhZGRpZXMgYnkgbmFtZSBvciBJRCAoMDAxLCAwMDIsIGV0Yy4pLi4uIiBvbmlucHV0PSJzZWFyY2hDYWRkaWVzKHRoaXMudmFsdWUpIj4KICAgICAgICAgIDxzcGFuIGNsYXNzPSJzZWFyY2gtaWNvbiI+8J+UjTwvc3Bhbj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJncmlkIGdyaWQtMyIgaWQ9ImNhZGR5R3JpZCI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFmZi1jYXJkIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhZmYtaGVhZGVyIj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFmZi1hdmF0YXIgb25saW5lIj5OUzwvZGl2PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLWluZm8iPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhZmYtbmFtZSI+TmluZyBTaXJpd2FuPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFmZi1yb2xlIj5TZW5pb3IgQ2FkZHkg4oCiIElEOiAwMDE8L2Rpdj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ic3RhdHVzLWJhZGdlIHN0YXR1cy13b3JraW5nIiBvbmNsaWNrPSJvcGVuU3RhdHVzTW9kYWwoJ25zMDAxJywgJ05pbmcgU2lyaXdhbicsICdXb3JraW5nJykiPldvcmtpbmc8L3NwYW4+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6MC43NXJlbSI+Q3VycmVudCBBc3NpZ25tZW50OiBQZXRlciBQYXJrIChIb2xlIDcpPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLWxvY2F0aW9uIj7wn5ONIENvdXJzZSBBIC0gSG9sZSA3PC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLWxhc3QtdXBkYXRlIj7ij7HvuI8gTGFzdCB1cGRhdGU6IDIgbWluIGFnbzwvZGl2PgogICAgICAgICAgICAKICAgICAgICAgICAgPCEtLSBTVEFUVVMgQ09OVFJPTFMgLS0+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXR1cy1jb250cm9scyI+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLWNvbnRyb2xzLWhlYWRlciI+U3RhdHVzIENvbnRyb2xzOjwvZGl2PgogICAgICAgICAgICAgIDxzZWxlY3QgY2xhc3M9InN0YXR1cy1kcm9wZG93biIgb25jaGFuZ2U9ImNoYW5nZVN0YXR1cygnbnMwMDEnLCB0aGlzLnZhbHVlKSI+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJXb3JraW5nIiBzZWxlY3RlZD7wn5K8IFdvcmtpbmc8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IkF2YWlsYWJsZSI+4pyFIEF2YWlsYWJsZTwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iT24gQnJlYWsiPuKYlSBPbiBCcmVhazwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iTHVuY2giPvCfjb3vuI8gTHVuY2g8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IkRheSBPZmYiPvCfj6AgRGF5IE9mZjwvb3B0aW9uPgogICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRvZ2dsZS1yb3ciPgogICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJ0b2dnbGUtc3dpdGNoIj4KICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBjaGVja2VkIG9uY2hhbmdlPSJ0b2dnbGVBdmFpbGFiaWxpdHkoJ25zMDAxJywgdGhpcy5jaGVja2VkKSI+CiAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0b2dnbGUtc2xpZGVyIj48L3NwYW4+CiAgICAgICAgICAgICAgICA8L2xhYmVsPgogICAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9ImZvbnQtc2l6ZTowLjdyZW0iPkF2YWlsYWJsZSBmb3IgYXNzaWdubWVudDwvc3Bhbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJxdWljay1idXR0b25zIj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InF1aWNrLWJ0biBicmVhayIgb25jbGljaz0icXVpY2tTdGF0dXMoJ25zMDAxJywgJ09uIEJyZWFrJykiPkJyZWFrPC9idXR0b24+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJxdWljay1idG4iIG9uY2xpY2s9InF1aWNrU3RhdHVzKCduczAwMScsICdBdmFpbGFibGUnKSI+RnJlZTwvYnV0dG9uPgogICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0icXVpY2stYnRuIiBvbmNsaWNrPSJxdWlja1N0YXR1cygnbnMwMDEnLCAnTHVuY2gnKSI+THVuY2g8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InF1aWNrLWJ0biIgb25jbGljaz0idmlld0NhZGR5SGlzdG9yeSgnbnMwMDEnKSI+SGlzdG9yeTwvYnV0dG9uPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLWNhcmQiPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFmZi1oZWFkZXIiPgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLWF2YXRhciBvbmxpbmUiPk1UPC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhZmYtaW5mbyI+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFmZi1uYW1lIj5NYXJjdXMgVGhvbXBzb248L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLXJvbGUiPkNhZGR5IOKAoiBJRDogMDAyPC9kaXY+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InN0YXR1cy1iYWRnZSBzdGF0dXMtYXZhaWxhYmxlIiBvbmNsaWNrPSJvcGVuU3RhdHVzTW9kYWwoJ210MDAyJywgJ01hcmN1cyBUaG9tcHNvbicsICdBdmFpbGFibGUnKSI+QXZhaWxhYmxlPC9zcGFuPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjAuNzVyZW0iPkN1cnJlbnQgQXNzaWdubWVudDogTm9uZTwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFmZi1sb2NhdGlvbiI+8J+TjSBDYWRkeSBTdGF0aW9uPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLWxhc3QtdXBkYXRlIj7ij7HvuI8gTGFzdCB1cGRhdGU6IDUgbWluIGFnbzwvZGl2PgogICAgICAgICAgICAKICAgICAgICAgICAgPCEtLSBTVEFUVVMgQ09OVFJPTFMgLS0+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXR1cy1jb250cm9scyI+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLWNvbnRyb2xzLWhlYWRlciI+U3RhdHVzIENvbnRyb2xzOjwvZGl2PgogICAgICAgICAgICAgIDxzZWxlY3QgY2xhc3M9InN0YXR1cy1kcm9wZG93biIgb25jaGFuZ2U9ImNoYW5nZVN0YXR1cygnbXQwMDInLCB0aGlzLnZhbHVlKSI+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJXb3JraW5nIj7wn5K8IFdvcmtpbmc8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IkF2YWlsYWJsZSIgc2VsZWN0ZWQ+4pyFIEF2YWlsYWJsZTwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iT24gQnJlYWsiPuKYlSBPbiBCcmVhazwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iTHVuY2giPvCfjb3vuI8gTHVuY2g8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IkRheSBPZmYiPvCfj6AgRGF5IE9mZjwvb3B0aW9uPgogICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRvZ2dsZS1yb3ciPgogICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJ0b2dnbGUtc3dpdGNoIj4KICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBjaGVja2VkIG9uY2hhbmdlPSJ0b2dnbGVBdmFpbGFiaWxpdHkoJ210MDAyJywgdGhpcy5jaGVja2VkKSI+CiAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0b2dnbGUtc2xpZGVyIj48L3NwYW4+CiAgICAgICAgICAgICAgICA8L2xhYmVsPgogICAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9ImZvbnQtc2l6ZTowLjdyZW0iPkF2YWlsYWJsZSBmb3IgYXNzaWdubWVudDwvc3Bhbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJxdWljay1idXR0b25zIj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InF1aWNrLWJ0biBicmVhayIgb25jbGljaz0icXVpY2tTdGF0dXMoJ210MDAyJywgJ09uIEJyZWFrJykiPkJyZWFrPC9idXR0b24+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJxdWljay1idG4gYWN0aXZlIiBvbmNsaWNrPSJxdWlja1N0YXR1cygnbXQwMDInLCAnQXZhaWxhYmxlJykiPkZyZWU8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InF1aWNrLWJ0biIgb25jbGljaz0icXVpY2tTdGF0dXMoJ210MDAyJywgJ1dvcmtpbmcnKSI+QXNzaWduPC9idXR0b24+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJxdWljay1idG4iIG9uY2xpY2s9InZpZXdDYWRkeUhpc3RvcnkoJ210MDAyJykiPkhpc3Rvcnk8L2J1dHRvbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFmZi1jYXJkIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhZmYtaGVhZGVyIj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFmZi1hdmF0YXIgYXdheSI+REM8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFmZi1pbmZvIj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLW5hbWUiPkRhdmlkIENoZW48L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLXJvbGUiPlRyYWluZWUgQ2FkZHkg4oCiIElEOiAwMDM8L2Rpdj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ic3RhdHVzLWJhZGdlIHN0YXR1cy1icmVhayIgb25jbGljaz0ib3BlblN0YXR1c01vZGFsKCdkYzAwMycsICdEYXZpZCBDaGVuJywgJ09uIEJyZWFrJykiPk9uIEJyZWFrPC9zcGFuPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjAuNzVyZW0iPkJyZWFrIFVudGlsOiAyOjMwIFBNPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLWxvY2F0aW9uIj7wn5ONIEJyZWFrIFJvb208L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhZmYtbGFzdC11cGRhdGUiPuKPse+4jyBMYXN0IHVwZGF0ZTogMTUgbWluIGFnbzwvZGl2PgogICAgICAgICAgICAKICAgICAgICAgICAgPCEtLSBTVEFUVVMgQ09OVFJPTFMgLS0+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXR1cy1jb250cm9scyI+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLWNvbnRyb2xzLWhlYWRlciI+U3RhdHVzIENvbnRyb2xzOjwvZGl2PgogICAgICAgICAgICAgIDxzZWxlY3QgY2xhc3M9InN0YXR1cy1kcm9wZG93biIgb25jaGFuZ2U9ImNoYW5nZVN0YXR1cygnZGMwMDMnLCB0aGlzLnZhbHVlKSI+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJXb3JraW5nIj7wn5K8IFdvcmtpbmc8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IkF2YWlsYWJsZSI+4pyFIEF2YWlsYWJsZTwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iT24gQnJlYWsiIHNlbGVjdGVkPuKYlSBPbiBCcmVhazwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iTHVuY2giPvCfjb3vuI8gTHVuY2g8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IkRheSBPZmYiPvCfj6AgRGF5IE9mZjwvb3B0aW9uPgogICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRvZ2dsZS1yb3ciPgogICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJ0b2dnbGUtc3dpdGNoIj4KICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBvbmNoYW5nZT0idG9nZ2xlQXZhaWxhYmlsaXR5KCdkYzAwMycsIHRoaXMuY2hlY2tlZCkiPgogICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0idG9nZ2xlLXNsaWRlciI+PC9zcGFuPgogICAgICAgICAgICAgICAgPC9sYWJlbD4KICAgICAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJmb250LXNpemU6MC43cmVtIj5BdmFpbGFibGUgZm9yIGFzc2lnbm1lbnQ8L3NwYW4+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icXVpY2stYnV0dG9ucyI+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJxdWljay1idG4gYnJlYWsgYWN0aXZlIiBvbmNsaWNrPSJxdWlja1N0YXR1cygnZGMwMDMnLCAnT24gQnJlYWsnKSI+QnJlYWs8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InF1aWNrLWJ0biIgb25jbGljaz0icXVpY2tTdGF0dXMoJ2RjMDAzJywgJ0F2YWlsYWJsZScpIj5GcmVlPC9idXR0b24+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJxdWljay1idG4iIG9uY2xpY2s9InF1aWNrU3RhdHVzKCdkYzAwMycsICdXb3JraW5nJykiPlJldHVybjwvYnV0dG9uPgogICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0icXVpY2stYnRuIiBvbmNsaWNrPSJ2aWV3Q2FkZHlIaXN0b3J5KCdkYzAwMycpIj5IaXN0b3J5PC9idXR0b24+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgoKICAgICAgPGRpdiBjbGFzcz0iZGVwYXJ0bWVudC1zZWN0aW9uIj4KICAgICAgICA8ZGl2IGNsYXNzPSJkZXBhcnRtZW50LWhlYWRlciI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJkZXBhcnRtZW50LXRpdGxlIj5Qcm8gU2hvcDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iZGVwYXJ0bWVudC1jb3VudCIgaWQ9InByb3Nob3BDb3VudCI+NiBvZiA2IHByZXNlbnQ8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6ZmxleDtnYXA6OHB4Ij4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSBidG4tcHJpbWFyeSIgb25jbGljaz0idmlld1NhbGVzTWV0cmljcygpIj5TYWxlcyBNZXRyaWNzPC9idXR0b24+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tc20iIG9uY2xpY2s9ImJ1bGtTdGF0dXNVcGRhdGUoJ3Byb3Nob3AnKSI+QnVsayBVcGRhdGU8L2J1dHRvbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InNlYXJjaC1jb250YWluZXIiIHN0eWxlPSJtYXJnaW4tYm90dG9tOjEycHgiPgogICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIGNsYXNzPSJzZWFyY2gtaW5wdXQiIGlkPSJwcm9zaG9wU2VhcmNoIiBwbGFjZWhvbGRlcj0iU2VhcmNoIHBybyBzaG9wIHN0YWZmLi4uIiBvbmlucHV0PSJzZWFyY2hTdGFmZih0aGlzLnZhbHVlLCAncHJvc2hvcCcpIj4KICAgICAgICAgIDxzcGFuIGNsYXNzPSJzZWFyY2gtaWNvbiI+8J+UjTwvc3Bhbj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJncmlkIGdyaWQtMyIgaWQ9InByb3Nob3BHcmlkIj4KICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLWNhcmQiPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFmZi1oZWFkZXIiPgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLWF2YXRhciBvbmxpbmUiPlNXPC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhZmYtaW5mbyI+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFmZi1uYW1lIj5TYXJhaCBXaWxzb248L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLXJvbGUiPlBybyBTaG9wIE1hbmFnZXI8L2Rpdj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ic3RhdHVzLWJhZGdlIHN0YXR1cy13b3JraW5nIiBvbmNsaWNrPSJvcGVuU3RhdHVzTW9kYWwoJ3N3MDA0JywgJ1NhcmFoIFdpbHNvbicsICdXb3JraW5nJykiPldvcmtpbmc8L3NwYW4+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6MC43NXJlbSI+U2hpZnQ6IDc6MDAgQU0gLSAzOjAwIFBNPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLWxvY2F0aW9uIj7wn5ONIFBybyBTaG9wIENvdW50ZXI8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhZmYtbGFzdC11cGRhdGUiPuKPse+4jyBMYXN0IHVwZGF0ZTogMSBtaW4gYWdvPC9kaXY+CiAgICAgICAgICAgIAogICAgICAgICAgICA8IS0tIFNUQVRVUyBDT05UUk9MUyAtLT4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLWNvbnRyb2xzIj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMtY29udHJvbHMtaGVhZGVyIj5TdGF0dXMgQ29udHJvbHM6PC9kaXY+CiAgICAgICAgICAgICAgPHNlbGVjdCBjbGFzcz0ic3RhdHVzLWRyb3Bkb3duIiBvbmNoYW5nZT0iY2hhbmdlU3RhdHVzKCdzdzAwNCcsIHRoaXMudmFsdWUpIj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IldvcmtpbmciIHNlbGVjdGVkPvCfkrwgV29ya2luZzwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iQXZhaWxhYmxlIj7inIUgQXZhaWxhYmxlPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJPbiBCcmVhayI+4piVIE9uIEJyZWFrPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJMdW5jaCI+8J+Nve+4jyBMdW5jaDwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iTWVldGluZyI+8J+RpSBNZWV0aW5nPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJEYXkgT2ZmIj7wn4+gIERheSBPZmY8L29wdGlvbj4KICAgICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0b2dnbGUtcm93Ij4KICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0idG9nZ2xlLXN3aXRjaCI+CiAgICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgY2hlY2tlZCBvbmNoYW5nZT0idG9nZ2xlQXZhaWxhYmlsaXR5KCdzdzAwNCcsIHRoaXMuY2hlY2tlZCkiPgogICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0idG9nZ2xlLXNsaWRlciI+PC9zcGFuPgogICAgICAgICAgICAgICAgPC9sYWJlbD4KICAgICAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJmb250LXNpemU6MC43cmVtIj5BdmFpbGFibGUgZm9yIGN1c3RvbWVyczwvc3Bhbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJxdWljay1idXR0b25zIj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InF1aWNrLWJ0biBicmVhayIgb25jbGljaz0icXVpY2tTdGF0dXMoJ3N3MDA0JywgJ09uIEJyZWFrJykiPkJyZWFrPC9idXR0b24+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJxdWljay1idG4iIG9uY2xpY2s9InF1aWNrU3RhdHVzKCdzdzAwNCcsICdNZWV0aW5nJykiPk1lZXRpbmc8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InF1aWNrLWJ0biIgb25jbGljaz0idmlld1NhbGVzKCdzdzAwNCcpIj5TYWxlczwvYnV0dG9uPgogICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0icXVpY2stYnRuIiBvbmNsaWNrPSJ2aWV3U3RhZmZTY2hlZHVsZSgnc3cwMDQnKSI+U2NoZWR1bGU8L2J1dHRvbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFmZi1jYXJkIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhZmYtaGVhZGVyIj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFmZi1hdmF0YXIgb25saW5lIj5CVzwvZGl2PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLWluZm8iPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhZmYtbmFtZSI+QmVuIFdvbmc8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLXJvbGUiPlNhbGVzIEFzc29jaWF0ZTwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJzdGF0dXMtYmFkZ2Ugc3RhdHVzLXdvcmtpbmciIG9uY2xpY2s9Im9wZW5TdGF0dXNNb2RhbCgnYncwMDUnLCAnQmVuIFdvbmcnLCAnV29ya2luZycpIj5Xb3JraW5nPC9zcGFuPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjAuNzVyZW0iPlNoaWZ0OiAxMDowMCBBTSAtIDY6MDAgUE08L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhZmYtbG9jYXRpb24iPvCfk40gUHJvIFNob3AgRmxvb3I8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhZmYtbGFzdC11cGRhdGUiPuKPse+4jyBMYXN0IHVwZGF0ZTogMyBtaW4gYWdvPC9kaXY+CiAgICAgICAgICAgIAogICAgICAgICAgICA8IS0tIFNUQVRVUyBDT05UUk9MUyAtLT4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLWNvbnRyb2xzIj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMtY29udHJvbHMtaGVhZGVyIj5TdGF0dXMgQ29udHJvbHM6PC9kaXY+CiAgICAgICAgICAgICAgPHNlbGVjdCBjbGFzcz0ic3RhdHVzLWRyb3Bkb3duIiBvbmNoYW5nZT0iY2hhbmdlU3RhdHVzKCdidzAwNScsIHRoaXMudmFsdWUpIj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IldvcmtpbmciIHNlbGVjdGVkPvCfkrwgV29ya2luZzwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iQXZhaWxhYmxlIj7inIUgQXZhaWxhYmxlPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJPbiBCcmVhayI+4piVIE9uIEJyZWFrPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJMdW5jaCI+8J+Nve+4jyBMdW5jaDwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iU3RvY2tpbmciPvCfk6YgU3RvY2tpbmc8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IkRheSBPZmYiPvCfj6AgRGF5IE9mZjwvb3B0aW9uPgogICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRvZ2dsZS1yb3ciPgogICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJ0b2dnbGUtc3dpdGNoIj4KICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBjaGVja2VkIG9uY2hhbmdlPSJ0b2dnbGVBdmFpbGFiaWxpdHkoJ2J3MDA1JywgdGhpcy5jaGVja2VkKSI+CiAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0b2dnbGUtc2xpZGVyIj48L3NwYW4+CiAgICAgICAgICAgICAgICA8L2xhYmVsPgogICAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9ImZvbnQtc2l6ZTowLjdyZW0iPkF2YWlsYWJsZSBmb3IgY3VzdG9tZXJzPC9zcGFuPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InF1aWNrLWJ1dHRvbnMiPgogICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0icXVpY2stYnRuIGJyZWFrIiBvbmNsaWNrPSJxdWlja1N0YXR1cygnYncwMDUnLCAnT24gQnJlYWsnKSI+QnJlYWs8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InF1aWNrLWJ0biIgb25jbGljaz0icXVpY2tTdGF0dXMoJ2J3MDA1JywgJ1N0b2NraW5nJykiPlN0b2NrPC9idXR0b24+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJxdWljay1idG4iIG9uY2xpY2s9ImFzc2lnblRhc2soJ2J3MDA1JykiPlRhc2s8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InF1aWNrLWJ0biIgb25jbGljaz0idmlld1NhbGVzKCdidzAwNScpIj5TYWxlczwvYnV0dG9uPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLWNhcmQiPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFmZi1oZWFkZXIiPgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLWF2YXRhciBvbmxpbmUiPkFDPC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhZmYtaW5mbyI+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFmZi1uYW1lIj5BbGljZSBDaGVuPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFmZi1yb2xlIj5Hb2xmIEluc3RydWN0b3I8L2Rpdj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ic3RhdHVzLWJhZGdlIHN0YXR1cy13b3JraW5nIiBvbmNsaWNrPSJvcGVuU3RhdHVzTW9kYWwoJ2FjMDA2JywgJ0FsaWNlIENoZW4nLCAnV29ya2luZycpIj5UZWFjaGluZzwvc3Bhbj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTowLjc1cmVtIj5DdXJyZW50OiBMZXNzb24gd2l0aCBKb2huIFNtaXRoPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YWZmLWxvY2F0aW9uIj7wn5ONIERyaXZpbmcgUmFuZ2U8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhZmYtbGFzdC11cGRhdGUiPuKPse+4jyBMYXN0IHVwZGF0ZTogOCBtaW4gYWdvPC9kaXY+CiAgICAgICAgICAgIAogICAgICAgICAgICA8IS0tIFNUQVRVUyBDT05UUk9MUyAtLT4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLWNvbnRyb2xzIj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMtY29udHJvbHMtaGVhZGVyIj5TdGF0dXMgQ29udHJvbHM6PC9kaXY+CiAgICAgICAgICAgICAgPHNlbGVjdCBjbGFzcz0ic3RhdHVzLWRyb3Bkb3duIiBvbmNoYW5nZT0iY2hhbmdlU3RhdHVzKCdhYzAwNicsIHRoaXMudmFsdWUpIj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IldvcmtpbmciIHNlbGVjdGVkPvCfj4zvuI8gVGVhY2hpbmc8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IkF2YWlsYWJsZSI+4pyFIEF2YWlsYWJsZTwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iT24gQnJlYWsiPuKYlSBPbiBCcmVhazwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iTHVuY2giPvCfjb3vuI8gTHVuY2g8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IlByYWN0aWNlIj7wn4+M77iPIFByYWN0aWNlPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJEYXkgT2ZmIj7wn4+gIERheSBPZmY8L29wdGlvbj4KICAgICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0b2dnbGUtcm93Ij4KICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0idG9nZ2xlLXN3aXRjaCI+CiAgICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgY2hlY2tlZCBvbmNoYW5nZT0idG9nZ2xlQXZhaWxhYmlsaXR5KCdhYzAwNicsIHRoaXMuY2hlY2tlZCkiPgogICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0idG9nZ2xlLXNsaWRlciI+PC9zcGFuPgogICAgICAgICAgICAgICAgPC9sYWJlbD4KICAgICAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJmb250LXNpemU6MC43cmVtIj5BdmFpbGFibGUgZm9yIGxlc3NvbnM8L3NwYW4+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icXVpY2stYnV0dG9ucyI+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJxdWljay1idG4iIG9uY2xpY2s9InF1aWNrU3RhdHVzKCdhYzAwNicsICdBdmFpbGFibGUnKSI+RnJlZTwvYnV0dG9uPgogICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0icXVpY2stYnRuIiBvbmNsaWNrPSJxdWlja1N0YXR1cygnYWMwMDYnLCAnUHJhY3RpY2UnKSI+UHJhY3RpY2U8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InF1aWNrLWJ0biIgb25jbGljaz0idmlld1NjaGVkdWxlKCdhYzAwNicpIj5TY2hlZHVsZTwvYnV0dG9uPgogICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0icXVpY2stYnRuIiBvbmNsaWNrPSJ2aWV3TGVzc29uSGlzdG9yeSgnYWMwMDYnKSI+SGlzdG9yeTwvYnV0dG9uPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgoKICAgIDwhLS0gUmVwb3J0cyAmIEFuYWx5dGljcyBNb2R1bGUgLS0+CiAgICA8ZGl2IGlkPSJyZXBvcnRzLW1vZHVsZSIgY2xhc3M9Im1vZHVsZS1jb250ZW50Ij4KICAgICAgPGRpdiBjbGFzcz0iZXhwb3J0LWNvbnRyb2xzIj4KICAgICAgICA8YnV0dG9uIGNsYXNzPSJleHBvcnQtYnRuIiBvbmNsaWNrPSJnZW5lcmF0ZUN1c3RvbVJlcG9ydCgpIj7wn5OKIEN1c3RvbSBSZXBvcnQ8L2J1dHRvbj4KICAgICAgICA8YnV0dG9uIGNsYXNzPSJleHBvcnQtYnRuIiBvbmNsaWNrPSJzY2hlZHVsZUF1dG9tYXRlZFJlcG9ydCgpIj7ij7AgU2NoZWR1bGUgUmVwb3J0czwvYnV0dG9uPgogICAgICAgIDxidXR0b24gY2xhc3M9ImV4cG9ydC1idG4iIG9uY2xpY2s9InZpZXdSZXBvcnRIaXN0b3J5KCkiPvCfk4EgUmVwb3J0IEhpc3Rvcnk8L2J1dHRvbj4KICAgICAgPC9kaXY+CiAgICAgIAogICAgICA8ZGl2IGNsYXNzPSJncmlkIGdyaWQtMyI+CiAgICAgICAgPGRpdiBjbGFzcz0iY2FyZCIgb25jbGljaz0iZ2VuZXJhdGVSZXBvcnQoJ2RhaWx5JykiPgogICAgICAgICAgPGgzPkRhaWx5IE9wZXJhdGlvbnMgUmVwb3J0PC9oMz4KICAgICAgICAgIDxwIHN0eWxlPSJmb250LXNpemU6MC44NzVyZW07Y29sb3I6dmFyKC0tbXV0ZWQpO21hcmdpbi1ib3R0b206MTJweCI+Q29tcGxldGUgb3ZlcnZpZXcgb2YgdG9kYXkncyBvcGVyYXRpb25zIGluY2x1ZGluZyByZXZlbnVlLCBzdGFmZiwgYW5kIGNvdXJzZSBzdGF0dXM8L3A+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OmZsZXg7anVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47YWxpZ24taXRlbXM6Y2VudGVyIj4KICAgICAgICAgICAgPHNwYW4gc3R5bGU9ImZvbnQtc2l6ZTowLjc1cmVtO2NvbG9yOnZhcigtLXN1Y2Nlc3MpIj5BdXRvLWdlbmVyYXRlZCBhdCAxMTo1OSBQTTwvc3Bhbj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSBidG4tcHJpbWFyeSI+R2VuZXJhdGUgTm93PC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICAKICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkIiBvbmNsaWNrPSJnZW5lcmF0ZVJlcG9ydCgnd2Vla2x5JykiPgogICAgICAgICAgPGgzPldlZWtseSBQZXJmb3JtYW5jZSBSZXBvcnQ8L2gzPgogICAgICAgICAgPHAgc3R5bGU9ImZvbnQtc2l6ZTowLjg3NXJlbTtjb2xvcjp2YXIoLS1tdXRlZCk7bWFyZ2luLWJvdHRvbToxMnB4Ij5XZWVrbHkgdHJlbmRzLCBwZXJmb3JtYW5jZSBtZXRyaWNzLCBhbmQgc3RhZmYgcHJvZHVjdGl2aXR5IGFuYWx5c2lzPC9wPgogICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTpmbGV4O2p1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuO2FsaWduLWl0ZW1zOmNlbnRlciI+CiAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJmb250LXNpemU6MC43NXJlbTtjb2xvcjp2YXIoLS1zdWNjZXNzKSI+QXV0by1nZW5lcmF0ZWQgZXZlcnkgTW9uZGF5PC9zcGFuPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIGJ0bi1wcmltYXJ5Ij5HZW5lcmF0ZSBOb3c8L2J1dHRvbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIAogICAgICAgIDxkaXYgY2xhc3M9ImNhcmQiIG9uY2xpY2s9ImdlbmVyYXRlUmVwb3J0KCdtb250aGx5JykiPgogICAgICAgICAgPGgzPk1vbnRobHkgQnVzaW5lc3MgUmVwb3J0PC9oMz4KICAgICAgICAgIDxwIHN0eWxlPSJmb250LXNpemU6MC44NzVyZW07Y29sb3I6dmFyKC0tbXV0ZWQpO21hcmdpbi1ib3R0b206MTJweCI+Q29tcHJlaGVuc2l2ZSBidXNpbmVzcyBhbmFseXNpcywgUCZMLCBhbmQgc3RyYXRlZ2ljIGluc2lnaHRzPC9wPgogICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTpmbGV4O2p1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuO2FsaWduLWl0ZW1zOmNlbnRlciI+CiAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJmb250LXNpemU6MC43NXJlbTtjb2xvcjp2YXIoLS1zdWNjZXNzKSI+QXV0by1nZW5lcmF0ZWQgMXN0IG9mIG1vbnRoPC9zcGFuPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIGJ0bi1wcmltYXJ5Ij5HZW5lcmF0ZSBOb3c8L2J1dHRvbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgICAgCiAgICAgIDxkaXYgY2xhc3M9ImdyaWQgZ3JpZC0yIj4KICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkIj4KICAgICAgICAgIDxoMj5SZWNlbnQgUmVwb3J0czwvaDI+CiAgICAgICAgICA8dGFibGUgY2xhc3M9ImRhdGEtdGFibGUiPgogICAgICAgICAgICA8dGhlYWQ+CiAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgPHRoPlJlcG9ydDwvdGg+CiAgICAgICAgICAgICAgICA8dGg+R2VuZXJhdGVkPC90aD4KICAgICAgICAgICAgICAgIDx0aD5TaXplPC90aD4KICAgICAgICAgICAgICAgIDx0aD5BY3Rpb25zPC90aD4KICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICA8L3RoZWFkPgogICAgICAgICAgICA8dGJvZHk+CiAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgPHRkPkRhaWx5IE9wZXJhdGlvbnMgLSBTZXAgNjwvdGQ+CiAgICAgICAgICAgICAgICA8dGQ+WWVzdGVyZGF5IDExOjU5IFBNPC90ZD4KICAgICAgICAgICAgICAgIDx0ZD4yLjMgTUI8L3RkPgogICAgICAgICAgICAgICAgPHRkPgogICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIiBvbmNsaWNrPSJkb3dubG9hZFJlcG9ydCgnZGFpbHlfc2VwNicpIj5Eb3dubG9hZDwvYnV0dG9uPgogICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIiBvbmNsaWNrPSJlbWFpbFJlcG9ydCgnZGFpbHlfc2VwNicpIj5FbWFpbDwvYnV0dG9uPgogICAgICAgICAgICAgICAgPC90ZD4KICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgIDx0ZD5XZWVrbHkgUGVyZm9ybWFuY2UgLSBXZWVrIDM2PC90ZD4KICAgICAgICAgICAgICAgIDx0ZD5TZXAgMiwgMjAyNDwvdGQ+CiAgICAgICAgICAgICAgICA8dGQ+NC4xIE1CPC90ZD4KICAgICAgICAgICAgICAgIDx0ZD4KICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSIgb25jbGljaz0iZG93bmxvYWRSZXBvcnQoJ3dlZWtseV93MzYnKSI+RG93bmxvYWQ8L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSIgb25jbGljaz0iZW1haWxSZXBvcnQoJ3dlZWtseV93MzYnKSI+RW1haWw8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDwvdGQ+CiAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICA8dGQ+TW9udGhseSBCdXNpbmVzcyAtIEF1Z3VzdDwvdGQ+CiAgICAgICAgICAgICAgICA8dGQ+U2VwIDEsIDIwMjQ8L3RkPgogICAgICAgICAgICAgICAgPHRkPjguNyBNQjwvdGQ+CiAgICAgICAgICAgICAgICA8dGQ+CiAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tc20iIG9uY2xpY2s9ImRvd25sb2FkUmVwb3J0KCdtb250aGx5X2F1ZycpIj5Eb3dubG9hZDwvYnV0dG9uPgogICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIiBvbmNsaWNrPSJlbWFpbFJlcG9ydCgnbW9udGhseV9hdWcnKSI+RW1haWw8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDwvdGQ+CiAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgPC90Ym9keT4KICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgPC9kaXY+CiAgICAgICAgCiAgICAgICAgPGRpdiBjbGFzcz0iY2FyZCI+CiAgICAgICAgICA8aDI+QW5hbHl0aWNzIERhc2hib2FyZDwvaDI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzdW1tYXJ5LWdyaWQiPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdW1tYXJ5LWl0ZW0iPgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN1bW1hcnktbnVtYmVyIiBzdHlsZT0iY29sb3I6dmFyKC0tc3VjY2VzcykiPjk0LjIlPC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3VtbWFyeS1sYWJlbCI+Q3VzdG9tZXIgU2F0aXNmYWN0aW9uPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdW1tYXJ5LWl0ZW0iPgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN1bW1hcnktbnVtYmVyIiBzdHlsZT0iY29sb3I6dmFyKC0tYnJhbmQpIj40LjEgaHJzPC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3VtbWFyeS1sYWJlbCI+QXZnIFJvdW5kIFRpbWU8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InN1bW1hcnktaXRlbSI+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3VtbWFyeS1udW1iZXIiIHN0eWxlPSJjb2xvcjp2YXIoLS13YXJuaW5nKSI+ODclPC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3VtbWFyeS1sYWJlbCI+U3RhZmYgRWZmaWNpZW5jeTwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3VtbWFyeS1pdGVtIj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdW1tYXJ5LW51bWJlciIgc3R5bGU9ImNvbG9yOnZhcigtLXN1Y2Nlc3MpIj4yMiU8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdW1tYXJ5LWxhYmVsIj5Qcm9maXQgTWFyZ2luPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICAKICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi10b3A6MTZweCI+CiAgICAgICAgICAgIDxoMz5LZXkgUGVyZm9ybWFuY2UgSW5kaWNhdG9yczwvaDM+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206OHB4Ij4KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OmZsZXg7anVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47bWFyZ2luLWJvdHRvbTo0cHgiPgogICAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9ImZvbnQtc2l6ZTowLjg3NXJlbSI+UmV2ZW51ZSBUYXJnZXQ8L3NwYW4+CiAgICAgICAgICAgICAgICA8c3BhbiBzdHlsZT0iZm9udC1zaXplOjAuODc1cmVtIj44NyU8L3NwYW4+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDojZjFmNWY5O2hlaWdodDo4cHg7Ym9yZGVyLXJhZGl1czo0cHgiPgogICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDp2YXIoLS1zdWNjZXNzKTt3aWR0aDo4NyU7aGVpZ2h0OjEwMCU7Ym9yZGVyLXJhZGl1czo0cHgiPjwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgCiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206OHB4Ij4KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OmZsZXg7anVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47bWFyZ2luLWJvdHRvbTo0cHgiPgogICAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9ImZvbnQtc2l6ZTowLjg3NXJlbSI+T3BlcmF0aW9uYWwgRWZmaWNpZW5jeTwvc3Bhbj4KICAgICAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJmb250LXNpemU6MC44NzVyZW0iPjkyJTwvc3Bhbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiNmMWY1Zjk7aGVpZ2h0OjhweDtib3JkZXItcmFkaXVzOjRweCI+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOnZhcigtLWJyYW5kKTt3aWR0aDo5MiU7aGVpZ2h0OjEwMCU7Ym9yZGVyLXJhZGl1czo0cHgiPjwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgCiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206OHB4Ij4KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OmZsZXg7anVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47bWFyZ2luLWJvdHRvbTo0cHgiPgogICAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9ImZvbnQtc2l6ZTowLjg3NXJlbSI+Q3VzdG9tZXIgUmV0ZW50aW9uPC9zcGFuPgogICAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9ImZvbnQtc2l6ZTowLjg3NXJlbSI+NzglPC9zcGFuPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6I2YxZjVmOTtoZWlnaHQ6OHB4O2JvcmRlci1yYWRpdXM6NHB4Ij4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6dmFyKC0td2FybmluZyk7d2lkdGg6NzglO2hlaWdodDoxMDAlO2JvcmRlci1yYWRpdXM6NHB4Ij48L2Rpdj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICA8L21haW4+CgogIDwhLS0gU3RhdHVzIE1hbmFnZW1lbnQgTW9kYWwgLS0+CiAgPGRpdiBpZD0ic3RhdHVzTW9kYWwiIGNsYXNzPSJzdGF0dXMtbW9kYWwiPgogICAgPGRpdiBjbGFzcz0ic3RhdHVzLW1vZGFsLWNvbnRlbnQiPgogICAgICA8aDIgaWQ9Im1vZGFsVGl0bGUiPlVwZGF0ZSBTdGFmZiBTdGF0dXM8L2gyPgogICAgICA8cCBpZD0ibW9kYWxTdGFmZk5hbWUiPlN0YWZmIE1lbWJlciBOYW1lPC9wPgogICAgICAKICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLW9wdGlvbnMiPgogICAgICAgIDxkaXYgY2xhc3M9InN0YXR1cy1vcHRpb24iIGRhdGEtc3RhdHVzPSJXb3JraW5nIj4KICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXR1cy1vcHRpb24taWNvbiI+8J+SvDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLW9wdGlvbi10ZXh0Ij5Xb3JraW5nPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMtb3B0aW9uLWRlc2MiPk9uIGR1dHkgYW5kIGF2YWlsYWJsZTwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InN0YXR1cy1vcHRpb24iIGRhdGEtc3RhdHVzPSJPbiBCcmVhayI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMtb3B0aW9uLWljb24iPuKYlTwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLW9wdGlvbi10ZXh0Ij5PbiBCcmVhazwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLW9wdGlvbi1kZXNjIj5UYWtpbmcgYSBicmVhazwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InN0YXR1cy1vcHRpb24iIGRhdGEtc3RhdHVzPSJMdW5jaCI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMtb3B0aW9uLWljb24iPvCfjb3vuI88L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXR1cy1vcHRpb24tdGV4dCI+THVuY2g8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXR1cy1vcHRpb24tZGVzYyI+THVuY2ggYnJlYWs8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMtb3B0aW9uIiBkYXRhLXN0YXR1cz0iTWVldGluZyI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMtb3B0aW9uLWljb24iPvCfkaU8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXR1cy1vcHRpb24tdGV4dCI+TWVldGluZzwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLW9wdGlvbi1kZXNjIj5JbiBhIG1lZXRpbmc8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMtb3B0aW9uIiBkYXRhLXN0YXR1cz0iVHJhaW5pbmciPgogICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLW9wdGlvbi1pY29uIj7wn5OaPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMtb3B0aW9uLXRleHQiPlRyYWluaW5nPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMtb3B0aW9uLWRlc2MiPlRyYWluaW5nIHNlc3Npb248L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMtb3B0aW9uIiBkYXRhLXN0YXR1cz0iRGF5IE9mZiI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMtb3B0aW9uLWljb24iPvCfj6A8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXR1cy1vcHRpb24tdGV4dCI+RGF5IE9mZjwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLW9wdGlvbi1kZXNjIj5Ob3Qgc2NoZWR1bGVkIHRvZGF5PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICAKICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLXRvcDoxNnB4Ij4KICAgICAgICA8bGFiZWwgZm9yPSJzdGF0dXNOb3RlcyIgc3R5bGU9ImZvbnQtc2l6ZTowLjg3NXJlbTtjb2xvcjp2YXIoLS1tdXRlZCkiPk5vdGVzIChvcHRpb25hbCk6PC9sYWJlbD4KICAgICAgICA8dGV4dGFyZWEgaWQ9InN0YXR1c05vdGVzIiByb3dzPSIyIiBzdHlsZT0id2lkdGg6MTAwJTttYXJnaW4tdG9wOjRweDtwYWRkaW5nOjhweDtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWJvcmRlcik7Ym9yZGVyLXJhZGl1czo2cHg7Zm9udC1zaXplOjAuODc1cmVtIj48L3RleHRhcmVhPgogICAgICA8L2Rpdj4KICAgICAgCiAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6ZmxleDtnYXA6MTJweDttYXJnaW4tdG9wOjIwcHgiPgogICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tcHJpbWFyeSIgb25jbGljaz0ic2F2ZVN0YXR1c0NoYW5nZSgpIj5VcGRhdGUgU3RhdHVzPC9idXR0b24+CiAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIiBvbmNsaWNrPSJjbG9zZVN0YXR1c01vZGFsKCkiPkNhbmNlbDwvYnV0dG9uPgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgogIDwvZGl2PgoKICA8IS0tIE5vdGlmaWNhdGlvbiBDZW50ZXIgLS0+CiAgPGRpdiBpZD0ibm90aWZpY2F0aW9uQ2VudGVyIiBjbGFzcz0ibm90aWZpY2F0aW9uLWNlbnRlciI+PC9kaXY+CgogIDxzY3JpcHQ+CiAgICAvLyBHTE9CQUwgVkFSSUFCTEVTIEFORCBJTklUSUFMSVpBVElPTgogICAgbGV0IGN1cnJlbnRTdGFmZklkID0gbnVsbDsKICAgIGxldCBzZWxlY3RlZFN0YXR1cyA9IG51bGw7CiAgICBsZXQgbm90aWZpY2F0aW9ucyA9IFtdOwogICAgbGV0IGxpdmVEYXRhSW50ZXJ2YWw7CgogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZ1bmN0aW9uKCkgewogICAgICBpbml0aWFsaXplQXBwKCk7CiAgICB9KTsKCiAgICBmdW5jdGlvbiBpbml0aWFsaXplQXBwKCkgewogICAgICBzZXR1cE1vZHVsZVRhYnMoKTsKICAgICAgc2V0dXBTdGF0dXNPcHRpb25zKCk7CiAgICAgIHNldHVwRXZlbnRMaXN0ZW5lcnMoKTsKICAgICAgc3RhcnRMaXZlRGF0YVVwZGF0ZXMoKTsKICAgICAgdXBkYXRlQ3VycmVudFRpbWUoKTsKICAgICAgc2hvd1dlbGNvbWVOb3RpZmljYXRpb24oKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXR1cE1vZHVsZVRhYnMoKSB7CiAgICAgIGNvbnN0IG1vZHVsZVRhYnNFbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5tb2R1bGUtdGFiJyk7CiAgICAgIGNvbnN0IG1vZHVsZUNvbnRlbnRzRWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcubW9kdWxlLWNvbnRlbnQnKTsKICAgICAgCiAgICAgIG1vZHVsZVRhYnNFbC5mb3JFYWNoKHRhYiA9PiB7CiAgICAgICAgdGFiLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBjb25zdCB0YXJnZXRNb2R1bGUgPSB0aGlzLmdldEF0dHJpYnV0ZSgnZGF0YS1tb2R1bGUnKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIGFjdGl2ZSB0YWIKICAgICAgICAgIG1vZHVsZVRhYnNFbC5mb3JFYWNoKHQgPT4gdC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSk7CiAgICAgICAgICB0aGlzLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgCiAgICAgICAgICAvLyBVcGRhdGUgYWN0aXZlIGNvbnRlbnQKICAgICAgICAgIG1vZHVsZUNvbnRlbnRzRWwuZm9yRWFjaChjb250ZW50ID0+IHsKICAgICAgICAgICAgY29udGVudC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgaWYgKGNvbnRlbnQuaWQgPT09IHRhcmdldE1vZHVsZSArICctbW9kdWxlJykgewogICAgICAgICAgICAgIGNvbnRlbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgCiAgICAgICAgICAvLyBUcmFjayBtb2R1bGUgdXNhZ2UKICAgICAgICAgIHRyYWNrTW9kdWxlVXNhZ2UodGFyZ2V0TW9kdWxlKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0dXBTdGF0dXNPcHRpb25zKCkgewogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuc3RhdHVzLW9wdGlvbicpLmZvckVhY2gob3B0aW9uID0+IHsKICAgICAgICBvcHRpb24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5zdGF0dXMtb3B0aW9uJykuZm9yRWFjaChvcHQgPT4gb3B0LmNsYXNzTGlzdC5yZW1vdmUoJ3NlbGVjdGVkJykpOwogICAgICAgICAgdGhpcy5jbGFzc0xpc3QuYWRkKCdzZWxlY3RlZCcpOwogICAgICAgICAgc2VsZWN0ZWRTdGF0dXMgPSB0aGlzLmdldEF0dHJpYnV0ZSgnZGF0YS1zdGF0dXMnKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0dXBFdmVudExpc3RlbmVycygpIHsKICAgICAgLy8gQ2xvc2UgbW9kYWwgd2hlbiBjbGlja2luZyBvdXRzaWRlCiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICBjb25zdCBtb2RhbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGF0dXNNb2RhbCcpOwogICAgICAgIGlmIChldmVudC50YXJnZXQgPT09IG1vZGFsKSB7CiAgICAgICAgICBjbG9zZVN0YXR1c01vZGFsKCk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIC8vIEtleWJvYXJkIHNob3J0Y3V0cwogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICBpZiAoZXZlbnQua2V5ID09PSAnRXNjYXBlJykgewogICAgICAgICAgY2xvc2VTdGF0dXNNb2RhbCgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBDdHJsL0NtZCArIEYgZm9yIGdsb2JhbCBzZWFyY2gKICAgICAgICBpZiAoKGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSkgJiYgZXZlbnQua2V5ID09PSAnZicgJiYgZXZlbnQudGFyZ2V0LnRhZ05hbWUgIT09ICdJTlBVVCcpIHsKICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2xvYmFsU2VhcmNoJykuZm9jdXMoKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgLy8gQWRkIHRvb2x0aXBzIHRvIGNvdXJzZSBob2xlcwogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuY291cnNlLWhvbGUnKS5mb3JFYWNoKGhvbGUgPT4gewogICAgICAgIGhvbGUuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VlbnRlcicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgc2hvd0hvbGVUb29sdGlwKHRoaXMpOwogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIGhvbGUuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaGlkZUhvbGVUb29sdGlwKCk7CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgICAgLy8gQWRkIGRhdGEgcG9pbnQgdG9vbHRpcHMgZm9yIGNoYXJ0CiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5kYXRhLXBvaW50JykuZm9yRWFjaChwb2ludCA9PiB7CiAgICAgICAgcG9pbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VlbnRlcicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgc2hvd0RhdGFQb2ludFRvb2x0aXAodGhpcyk7CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgcG9pbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaGlkZURhdGFQb2ludFRvb2x0aXAoKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gc3RhcnRMaXZlRGF0YVVwZGF0ZXMoKSB7CiAgICAgIC8vIFVwZGF0ZSBsaXZlIGRhdGEgZXZlcnkgMzAgc2Vjb25kcwogICAgICBsaXZlRGF0YUludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gewogICAgICAgIHVwZGF0ZUxpdmVEYXRhKCk7CiAgICAgICAgdXBkYXRlQ3VycmVudFRpbWUoKTsKICAgICAgfSwgMzAwMDApOwogICAgfQoKICAgIGZ1bmN0aW9uIHVwZGF0ZUN1cnJlbnRUaW1lKCkgewogICAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpOwogICAgICBjb25zdCB0aW1lU3RyaW5nID0gbm93LnRvTG9jYWxlVGltZVN0cmluZygnZW4tVVMnLCB7IAogICAgICAgIGhvdXIxMjogZmFsc2UsIAogICAgICAgIGhvdXI6ICcyLWRpZ2l0JywgCiAgICAgICAgbWludXRlOiAnMi1kaWdpdCcKICAgICAgfSk7CiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjdXJyZW50VGltZScpLnRleHRDb250ZW50ID0gdGltZVN0cmluZzsKICAgIH0KCiAgICBmdW5jdGlvbiBzaG93V2VsY29tZU5vdGlmaWNhdGlvbigpIHsKICAgICAgYWRkTm90aWZpY2F0aW9uKCdXZWxjb21lIGJhY2shIFN5c3RlbSBpcyBydW5uaW5nIG5vcm1hbGx5LicsICdpbmZvJyk7CiAgICB9CgogICAgLy8gU1RBVFVTIE1BTkFHRU1FTlQgRlVOQ1RJT05TCiAgICBmdW5jdGlvbiBjaGFuZ2VTdGF0dXMoc3RhZmZJZCwgbmV3U3RhdHVzKSB7CiAgICAgIHVwZGF0ZVN0YXR1c0JhZGdlKHN0YWZmSWQsIG5ld1N0YXR1cyk7CiAgICAgIHVwZGF0ZVN0YXR1c0NvbnRyb2xzKHN0YWZmSWQsIG5ld1N0YXR1cyk7CiAgICAgIHVwZGF0ZUxhc3RVcGRhdGVUaW1lKHN0YWZmSWQpOwogICAgICAKICAgICAgYWRkTm90aWZpY2F0aW9uKGAke2dldFN0YWZmTmFtZShzdGFmZklkKX0gc3RhdHVzIGNoYW5nZWQgdG86ICR7bmV3U3RhdHVzfWAsICdzdWNjZXNzJyk7CiAgICAgIAogICAgICAvLyBVcGRhdGUgbWV0cmljcwogICAgICB1cGRhdGVTdGFmZk1ldHJpY3MoKTsKICAgICAgCiAgICAgIGNvbnNvbGUubG9nKGBTdGF0dXMgY2hhbmdlZCBmb3IgJHtzdGFmZklkfTogJHtuZXdTdGF0dXN9YCk7CiAgICB9CgogICAgZnVuY3Rpb24gdG9nZ2xlQXZhaWxhYmlsaXR5KHN0YWZmSWQsIGlzQXZhaWxhYmxlKSB7CiAgICAgIGNvbnN0IHN0YXR1c1RleHQgPSBpc0F2YWlsYWJsZSA/ICdBdmFpbGFibGUnIDogJ1VuYXZhaWxhYmxlJzsKICAgICAgCiAgICAgIGlmICghaXNBdmFpbGFibGUpIHsKICAgICAgICBjb25zdCBkcm9wZG93biA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYFtvbmNoYW5nZSo9IiR7c3RhZmZJZH0iXWApOwogICAgICAgIGlmIChkcm9wZG93bikgewogICAgICAgICAgZHJvcGRvd24udmFsdWUgPSAnT24gQnJlYWsnOwogICAgICAgICAgY2hhbmdlU3RhdHVzKHN0YWZmSWQsICdPbiBCcmVhaycpOwogICAgICAgIH0KICAgICAgfQogICAgICAKICAgICAgYWRkTm90aWZpY2F0aW9uKGAke2dldFN0YWZmTmFtZShzdGFmZklkKX0gc2V0IGFzICR7c3RhdHVzVGV4dC50b0xvd2VyQ2FzZSgpfWAsICdpbmZvJyk7CiAgICAgIHVwZGF0ZUxhc3RVcGRhdGVUaW1lKHN0YWZmSWQpOwogICAgICAKICAgICAgY29uc29sZS5sb2coYEF2YWlsYWJpbGl0eSB0b2dnbGUgZm9yICR7c3RhZmZJZH06ICR7c3RhdHVzVGV4dH1gKTsKICAgIH0KCiAgICBmdW5jdGlvbiBxdWlja1N0YXR1cyhzdGFmZklkLCBuZXdTdGF0dXMpIHsKICAgICAgY29uc3QgZHJvcGRvd24gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBbb25jaGFuZ2UqPSIke3N0YWZmSWR9Il1gKTsKICAgICAgaWYgKGRyb3Bkb3duKSB7CiAgICAgICAgZHJvcGRvd24udmFsdWUgPSBuZXdTdGF0dXM7CiAgICAgIH0KICAgICAgCiAgICAgIGNoYW5nZVN0YXR1cyhzdGFmZklkLCBuZXdTdGF0dXMpOwogICAgICBjb25zb2xlLmxvZyhgUXVpY2sgc3RhdHVzIGNoYW5nZSBmb3IgJHtzdGFmZklkfTogJHtuZXdTdGF0dXN9YCk7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlU3RhdHVzQmFkZ2Uoc3RhZmZJZCwgbmV3U3RhdHVzKSB7CiAgICAgIGNvbnN0IHN0YXR1c0JhZGdlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgW29uY2xpY2sqPSIke3N0YWZmSWR9Il1gKTsKICAgICAgaWYgKHN0YXR1c0JhZGdlKSB7CiAgICAgICAgY29uc3Qgc3RhdHVzQ2xhc3NNYXAgPSB7CiAgICAgICAgICAnV29ya2luZyc6ICdzdGF0dXMtd29ya2luZycsCiAgICAgICAgICAnQXZhaWxhYmxlJzogJ3N0YXR1cy1hdmFpbGFibGUnLAogICAgICAgICAgJ09uIEJyZWFrJzogJ3N0YXR1cy1icmVhaycsCiAgICAgICAgICAnTHVuY2gnOiAnc3RhdHVzLWx1bmNoJywKICAgICAgICAgICdEYXkgT2ZmJzogJ3N0YXR1cy1vZmYnLAogICAgICAgICAgJ01lZXRpbmcnOiAnc3RhdHVzLXdvcmtpbmcnLAogICAgICAgICAgJ1RyYWluaW5nJzogJ3N0YXR1cy13b3JraW5nJywKICAgICAgICAgICdUZWFjaGluZyc6ICdzdGF0dXMtd29ya2luZycKICAgICAgICB9OwogICAgICAgIAogICAgICAgIGNvbnN0IHN0YXR1c0NsYXNzID0gc3RhdHVzQ2xhc3NNYXBbbmV3U3RhdHVzXSB8fCAnc3RhdHVzLXdvcmtpbmcnOwogICAgICAgIHN0YXR1c0JhZGdlLmNsYXNzTmFtZSA9IGBzdGF0dXMtYmFkZ2UgJHtzdGF0dXNDbGFzc31gOwogICAgICAgIHN0YXR1c0JhZGdlLnRleHRDb250ZW50ID0gbmV3U3RhdHVzOwogICAgICAgIAogICAgICAgIGNvbnN0IG9uY2xpY2tWYWx1ZSA9IHN0YXR1c0JhZGdlLmdldEF0dHJpYnV0ZSgnb25jbGljaycpOwogICAgICAgIGNvbnN0IHVwZGF0ZWRPbmNsaWNrID0gb25jbGlja1ZhbHVlLnJlcGxhY2UoLyxccyonW14nXSonXCkkLywgYCwgJyR7bmV3U3RhdHVzfScpYCk7CiAgICAgICAgc3RhdHVzQmFkZ2Uuc2V0QXR0cmlidXRlKCdvbmNsaWNrJywgdXBkYXRlZE9uY2xpY2spOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlU3RhdHVzQ29udHJvbHMoc3RhZmZJZCwgbmV3U3RhdHVzKSB7CiAgICAgIGNvbnN0IHN0YWZmQ2FyZCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYFtvbmNsaWNrKj0iJHtzdGFmZklkfSJdYCkuY2xvc2VzdCgnLnN0YWZmLWNhcmQnKTsKICAgICAgCiAgICAgIGNvbnN0IHF1aWNrQnV0dG9ucyA9IHN0YWZmQ2FyZC5xdWVyeVNlbGVjdG9yQWxsKCcucXVpY2stYnRuJyk7CiAgICAgIHF1aWNrQnV0dG9ucy5mb3JFYWNoKGJ0biA9PiBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJykpOwogICAgICAKICAgICAgcXVpY2tCdXR0b25zLmZvckVhY2goYnRuID0+IHsKICAgICAgICBjb25zdCBidG5UZXh0ID0gYnRuLnRleHRDb250ZW50LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgY29uc3Qgc3RhdHVzVGV4dCA9IG5ld1N0YXR1cy50b0xvd2VyQ2FzZSgpOwogICAgICAgIAogICAgICAgIGlmICgoYnRuVGV4dCA9PT0gJ2JyZWFrJyAmJiBzdGF0dXNUZXh0LmluY2x1ZGVzKCdicmVhaycpKSB8fAogICAgICAgICAgICAoYnRuVGV4dCA9PT0gJ2ZyZWUnICYmIHN0YXR1c1RleHQgPT09ICdhdmFpbGFibGUnKSB8fAogICAgICAgICAgICAoYnRuVGV4dCA9PT0gJ2x1bmNoJyAmJiBzdGF0dXNUZXh0ID09PSAnbHVuY2gnKSB8fAogICAgICAgICAgICAoYnRuVGV4dCA9PT0gJ3JldHVybicgJiYgc3RhdHVzVGV4dCA9PT0gJ3dvcmtpbmcnKSkgewogICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlTGFzdFVwZGF0ZVRpbWUoc3RhZmZJZCkgewogICAgICBjb25zdCBzdGFmZkNhcmQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBbb25jbGljayo9IiR7c3RhZmZJZH0iXWApLmNsb3Nlc3QoJy5zdGFmZi1jYXJkJyk7CiAgICAgIGNvbnN0IGxhc3RVcGRhdGVFbCA9IHN0YWZmQ2FyZC5xdWVyeVNlbGVjdG9yKCcuc3RhZmYtbGFzdC11cGRhdGUnKTsKICAgICAgaWYgKGxhc3RVcGRhdGVFbCkgewogICAgICAgIGxhc3RVcGRhdGVFbC50ZXh0Q29udGVudCA9ICfij7HvuI8gTGFzdCB1cGRhdGU6IEp1c3Qgbm93JzsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGdldFN0YWZmTmFtZShzdGFmZklkKSB7CiAgICAgIGNvbnN0IHN0YWZmQ2FyZCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYFtvbmNsaWNrKj0iJHtzdGFmZklkfSJdYCkuY2xvc2VzdCgnLnN0YWZmLWNhcmQnKTsKICAgICAgY29uc3QgbmFtZUVsID0gc3RhZmZDYXJkLnF1ZXJ5U2VsZWN0b3IoJy5zdGFmZi1uYW1lJyk7CiAgICAgIHJldHVybiBuYW1lRWwgPyBuYW1lRWwudGV4dENvbnRlbnQgOiAnU3RhZmYgTWVtYmVyJzsKICAgIH0KCiAgICBmdW5jdGlvbiB1cGRhdGVTdGFmZk1ldHJpY3MoKSB7CiAgICAgIC8vIFNpbXVsYXRlIG1ldHJpYyB1cGRhdGVzCiAgICAgIGNvbnN0IG1ldHJpY3MgPSBbJ3N0YWZmT25EdXR5JywgJ3N0YWZmT25CcmVhaycsICdzdGFmZkRheU9mZicsICdzdGFmZkFic2VudCddOwogICAgICBtZXRyaWNzLmZvckVhY2gobWV0cmljID0+IHsKICAgICAgICBjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobWV0cmljKTsKICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgLy8gQWRkIGEgc21hbGwgYW5pbWF0aW9uIHRvIHNob3cgdGhlIHVwZGF0ZQogICAgICAgICAgZWxlbWVudC5zdHlsZS50cmFuc2Zvcm0gPSAnc2NhbGUoMS4xKSc7CiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgZWxlbWVudC5zdHlsZS50cmFuc2Zvcm0gPSAnc2NhbGUoMSknOwogICAgICAgICAgfSwgMjAwKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIC8vIE1PREFMIEZVTkNUSU9OUwogICAgZnVuY3Rpb24gb3BlblN0YXR1c01vZGFsKHN0YWZmSWQsIHN0YWZmTmFtZSwgY3VycmVudFN0YXR1cykgewogICAgICBjdXJyZW50U3RhZmZJZCA9IHN0YWZmSWQ7CiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtb2RhbFN0YWZmTmFtZScpLnRleHRDb250ZW50ID0gc3RhZmZOYW1lOwogICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhdHVzTW9kYWwnKS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgCiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5zdGF0dXMtb3B0aW9uJykuZm9yRWFjaChvcHQgPT4gb3B0LmNsYXNzTGlzdC5yZW1vdmUoJ3NlbGVjdGVkJykpOwogICAgICBjb25zdCBjdXJyZW50T3B0aW9uID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgW2RhdGEtc3RhdHVzPSIke2N1cnJlbnRTdGF0dXN9Il1gKTsKICAgICAgaWYgKGN1cnJlbnRPcHRpb24pIHsKICAgICAgICBjdXJyZW50T3B0aW9uLmNsYXNzTGlzdC5hZGQoJ3NlbGVjdGVkJyk7CiAgICAgICAgc2VsZWN0ZWRTdGF0dXMgPSBjdXJyZW50U3RhdHVzOwogICAgICB9CiAgICAgIAogICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhdHVzTm90ZXMnKS52YWx1ZSA9ICcnOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsb3NlU3RhdHVzTW9kYWwoKSB7CiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGF0dXNNb2RhbCcpLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICBjdXJyZW50U3RhZmZJZCA9IG51bGw7CiAgICAgIHNlbGVjdGVkU3RhdHVzID0gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBzYXZlU3RhdHVzQ2hhbmdlKCkgewogICAgICBpZiAoIWN1cnJlbnRTdGFmZklkIHx8ICFzZWxlY3RlZFN0YXR1cykgewogICAgICAgIGFkZE5vdGlmaWNhdGlvbignUGxlYXNlIHNlbGVjdCBhIHN0YXR1cycsICd3YXJuaW5nJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIAogICAgICBjb25zdCBub3RlcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGF0dXNOb3RlcycpLnZhbHVlOwogICAgICAKICAgICAgY29uc3QgZHJvcGRvd24gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBbb25jaGFuZ2UqPSIke2N1cnJlbnRTdGFmZklkfSJdYCk7CiAgICAgIGlmIChkcm9wZG93bikgewogICAgICAgIGRyb3Bkb3duLnZhbHVlID0gc2VsZWN0ZWRTdGF0dXM7CiAgICAgIH0KICAgICAgCiAgICAgIGNoYW5nZVN0YXR1cyhjdXJyZW50U3RhZmZJZCwgc2VsZWN0ZWRTdGF0dXMpOwogICAgICAKICAgICAgaWYgKG5vdGVzKSB7CiAgICAgICAgY29uc29sZS5sb2coYFN0YXR1cyBjaGFuZ2Ugbm90ZXMgZm9yICR7Y3VycmVudFN0YWZmSWR9OiAke25vdGVzfWApOwogICAgICB9CiAgICAgIAogICAgICBjbG9zZVN0YXR1c01vZGFsKCk7CiAgICB9CgogICAgLy8gU0VBUkNIIEZVTkNUSU9OQUxJVFkKICAgIGZ1bmN0aW9uIHNlYXJjaENhZGRpZXMoc2VhcmNoVGVybSkgewogICAgICBjb25zdCBjYWRkeUNhcmRzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnI2NhZGR5R3JpZCAuc3RhZmYtY2FyZCcpOwogICAgICBjb25zdCBzZWFyY2hWYWx1ZSA9IHNlYXJjaFRlcm0udG9Mb3dlckNhc2UoKS50cmltKCk7CiAgICAgIAogICAgICBjYWRkeUNhcmRzLmZvckVhY2goY2FyZCA9PiB7CiAgICAgICAgY29uc3Qgc3RhZmZSb2xlID0gY2FyZC5xdWVyeVNlbGVjdG9yKCcuc3RhZmYtcm9sZScpLnRleHRDb250ZW50OwogICAgICAgIGNvbnN0IGNhZGR5SWQgPSBzdGFmZlJvbGUubWF0Y2goL0lEOlxzKihcZHszfSkvKTsKICAgICAgICBjb25zdCBjYWRkeU51bWJlciA9IGNhZGR5SWQgPyBjYWRkeUlkWzFdIDogJyc7CiAgICAgICAgY29uc3Qgc3RhZmZOYW1lID0gY2FyZC5xdWVyeVNlbGVjdG9yKCcuc3RhZmYtbmFtZScpLnRleHRDb250ZW50LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgCiAgICAgICAgY29uc3QgbWF0Y2hlc051bWJlciA9IGNhZGR5TnVtYmVyLmluY2x1ZGVzKHNlYXJjaFZhbHVlKTsKICAgICAgICBjb25zdCBtYXRjaGVzTmFtZSA9IHN0YWZmTmFtZS5pbmNsdWRlcyhzZWFyY2hWYWx1ZSk7CiAgICAgICAgCiAgICAgICAgaWYgKHNlYXJjaFZhbHVlID09PSAnJyB8fCBtYXRjaGVzTnVtYmVyIHx8IG1hdGNoZXNOYW1lKSB7CiAgICAgICAgICBjYXJkLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjYXJkLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgCiAgICAgIHVwZGF0ZUNhZGR5Q291bnQoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZWFyY2hTdGFmZihzZWFyY2hUZXJtLCBkZXBhcnRtZW50KSB7CiAgICAgIGNvbnN0IGRlcGFydG1lbnRHcmlkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZGVwYXJ0bWVudCArICdHcmlkJyk7CiAgICAgIGlmICghZGVwYXJ0bWVudEdyaWQpIHJldHVybjsKICAgICAgCiAgICAgIGNvbnN0IHN0YWZmQ2FyZHMgPSBkZXBhcnRtZW50R3JpZC5xdWVyeVNlbGVjdG9yQWxsKCcuc3RhZmYtY2FyZCcpOwogICAgICBjb25zdCBzZWFyY2hWYWx1ZSA9IHNlYXJjaFRlcm0udG9Mb3dlckNhc2UoKS50cmltKCk7CiAgICAgIAogICAgICBzdGFmZkNhcmRzLmZvckVhY2goY2FyZCA9PiB7CiAgICAgICAgY29uc3Qgc3RhZmZOYW1lID0gY2FyZC5xdWVyeVNlbGVjdG9yKCcuc3RhZmYtbmFtZScpLnRleHRDb250ZW50LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgY29uc3Qgc3RhZmZSb2xlID0gY2FyZC5xdWVyeVNlbGVjdG9yKCcuc3RhZmYtcm9sZScpLnRleHRDb250ZW50LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgCiAgICAgICAgY29uc3QgbWF0Y2hlc05hbWUgPSBzdGFmZk5hbWUuaW5jbHVkZXMoc2VhcmNoVmFsdWUpOwogICAgICAgIGNvbnN0IG1hdGNoZXNSb2xlID0gc3RhZmZSb2xlLmluY2x1ZGVzKHNlYXJjaFZhbHVlKTsKICAgICAgICAKICAgICAgICBpZiAoc2VhcmNoVmFsdWUgPT09ICcnIHx8IG1hdGNoZXNOYW1lIHx8IG1hdGNoZXNSb2xlKSB7CiAgICAgICAgICBjYXJkLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjYXJkLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBnbG9iYWxTdGFmZlNlYXJjaChzZWFyY2hUZXJtKSB7CiAgICAgIHNlYXJjaENhZGRpZXMoc2VhcmNoVGVybSk7CiAgICAgIHNlYXJjaFN0YWZmKHNlYXJjaFRlcm0sICdwcm9zaG9wJyk7CiAgICAgIAogICAgICBpZiAoc2VhcmNoVGVybS50cmltKCkgIT09ICcnKSB7CiAgICAgICAgYWRkTm90aWZpY2F0aW9uKGBTZWFyY2hpbmcgZm9yOiAiJHtzZWFyY2hUZXJtfSJgLCAnaW5mbycpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlQ2FkZHlDb3VudCgpIHsKICAgICAgY29uc3QgY2FkZHlDYXJkcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJyNjYWRkeUdyaWQgLnN0YWZmLWNhcmQnKTsKICAgICAgY29uc3QgdmlzaWJsZUNhZGRpZXMgPSBBcnJheS5mcm9tKGNhZGR5Q2FyZHMpLmZpbHRlcihjYXJkID0+IGNhcmQuc3R5bGUuZGlzcGxheSAhPT0gJ25vbmUnKTsKICAgICAgY29uc3QgdG90YWxDYWRkaWVzID0gY2FkZHlDYXJkcy5sZW5ndGg7CiAgICAgIAogICAgICBjb25zdCBjb3VudEVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2FkZHlDb3VudCcpOwogICAgICBpZiAoY291bnRFbGVtZW50KSB7CiAgICAgICAgY291bnRFbGVtZW50LnRleHRDb250ZW50ID0gYCR7dmlzaWJsZUNhZGRpZXMubGVuZ3RofSBvZiAke3RvdGFsQ2FkZGllc30gcHJlc2VudGA7CiAgICAgIH0KICAgIH0KCiAgICAvLyBOT1RJRklDQVRJT04gU1lTVEVNCiAgICBmdW5jdGlvbiBhZGROb3RpZmljYXRpb24obWVzc2FnZSwgdHlwZSA9ICdpbmZvJykgewogICAgICBjb25zdCBub3RpZmljYXRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgbm90aWZpY2F0aW9uLmNsYXNzTmFtZSA9IGBub3RpZmljYXRpb24gJHt0eXBlfWA7CiAgICAgIG5vdGlmaWNhdGlvbi5pbm5lckhUTUwgPSBgCiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6NjAwO21hcmdpbi1ib3R0b206NHB4Ij4ke2dldE5vdGlmaWNhdGlvblRpdGxlKHR5cGUpfTwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTowLjg3NXJlbSI+JHttZXNzYWdlfTwvZGl2PgogICAgICBgOwogICAgICAKICAgICAgY29uc3Qgbm90aWZpY2F0aW9uQ2VudGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25vdGlmaWNhdGlvbkNlbnRlcicpOwogICAgICBub3RpZmljYXRpb25DZW50ZXIuYXBwZW5kQ2hpbGQobm90aWZpY2F0aW9uKTsKICAgICAgCiAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIGlmIChub3RpZmljYXRpb24ucGFyZW50Tm9kZSkgewogICAgICAgICAgbm90aWZpY2F0aW9uLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm90aWZpY2F0aW9uKTsKICAgICAgICB9CiAgICAgIH0sIDUwMDApOwogICAgICAKICAgICAgbm90aWZpY2F0aW9ucy5wdXNoKHsKICAgICAgICBtZXNzYWdlLAogICAgICAgIHR5cGUsCiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpCiAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldE5vdGlmaWNhdGlvblRpdGxlKHR5cGUpIHsKICAgICAgY29uc3QgdGl0bGVzID0gewogICAgICAgICdpbmZvJzogJ0luZm9ybWF0aW9uJywKICAgICAgICAnc3VjY2Vzcyc6ICdTdWNjZXNzJywKICAgICAgICAnd2FybmluZyc6ICdXYXJuaW5nJywKICAgICAgICAnZGFuZ2VyJzogJ0FsZXJ0JwogICAgICB9OwogICAgICByZXR1cm4gdGl0bGVzW3R5cGVdIHx8ICdOb3RpZmljYXRpb24nOwogICAgfQoKICAgIC8vIExJVkUgREFUQSBVUERBVEVTCiAgICBmdW5jdGlvbiB1cGRhdGVMaXZlRGF0YSgpIHsKICAgICAgLy8gU2ltdWxhdGUgcmVhbC10aW1lIGRhdGEgdXBkYXRlcwogICAgICB1cGRhdGVNZXRyaWNzKCk7CiAgICAgIHVwZGF0ZUNvdXJzZVN0YXR1cygpOwogICAgICB1cGRhdGVXZWF0aGVyKCk7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlTWV0cmljcygpIHsKICAgICAgLy8gU2ltdWxhdGUgc21hbGwgY2hhbmdlcyBpbiBtZXRyaWNzCiAgICAgIGNvbnN0IGVsZW1lbnRzID0gWwogICAgICAgIHsgaWQ6ICd0b3RhbFJldmVudWUnLCBiYXNlOiA4NzUwMDAsIHZhcmlhbmNlOiA1MDAwIH0sCiAgICAgICAgeyBpZDogJ3JvdW5kc1BsYXllZCcsIGJhc2U6IDI0NywgdmFyaWFuY2U6IDMgfSwKICAgICAgICB7IGlkOiAnYXZnUmV2ZW51ZScsIGJhc2U6IDM1NDAsIHZhcmlhbmNlOiA1MCB9LAogICAgICAgIHsgaWQ6ICd1dGlsaXphdGlvbicsIGJhc2U6IDg3LCB2YXJpYW5jZTogMiB9LAogICAgICAgIHsgaWQ6ICdhdmdSb3VuZFRpbWUnLCBiYXNlOiA0LjIsIHZhcmlhbmNlOiAwLjEgfQogICAgICBdOwogICAgICAKICAgICAgZWxlbWVudHMuZm9yRWFjaChlbGVtID0+IHsKICAgICAgICBjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZWxlbS5pZCk7CiAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgIGNvbnN0IGNoYW5nZSA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIGVsZW0udmFyaWFuY2UgKiAwLjE7CiAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IGVsZW0uYmFzZSArIGNoYW5nZTsKICAgICAgICAgIAogICAgICAgICAgaWYgKGVsZW0uaWQgPT09ICd0b3RhbFJldmVudWUnKSB7CiAgICAgICAgICAgIGVsZW1lbnQudGV4dENvbnRlbnQgPSAn4Li/JyArIE1hdGgucm91bmQobmV3VmFsdWUpLnRvTG9jYWxlU3RyaW5nKCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGVsZW0uaWQgPT09ICdhdmdSZXZlbnVlJykgewogICAgICAgICAgICBlbGVtZW50LnRleHRDb250ZW50ID0gJ+C4vycgKyBNYXRoLnJvdW5kKG5ld1ZhbHVlKS50b0xvY2FsZVN0cmluZygpOwogICAgICAgICAgfSBlbHNlIGlmIChlbGVtLmlkID09PSAnYXZnUm91bmRUaW1lJykgewogICAgICAgICAgICBlbGVtZW50LnRleHRDb250ZW50ID0gbmV3VmFsdWUudG9GaXhlZCgxKSArICcgaHJzJzsKICAgICAgICAgIH0gZWxzZSBpZiAoZWxlbS5pZCA9PT0gJ3V0aWxpemF0aW9uJykgewogICAgICAgICAgICBlbGVtZW50LnRleHRDb250ZW50ID0gTWF0aC5yb3VuZChuZXdWYWx1ZSkgKyAnJSc7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbGVtZW50LnRleHRDb250ZW50ID0gTWF0aC5yb3VuZChuZXdWYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiB1cGRhdGVDb3Vyc2VTdGF0dXMoKSB7CiAgICAgIC8vIFJhbmRvbWx5IHVwZGF0ZSBzb21lIGhvbGUgc3RhdHVzZXMKICAgICAgY29uc3QgaG9sZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuY291cnNlLWhvbGUnKTsKICAgICAgY29uc3Qgc3RhdHVzZXMgPSBbJ2hvbGUtY2xlYXInLCAnaG9sZS1idXN5JywgJ2hvbGUtYmFja2VkLXVwJ107CiAgICAgIAogICAgICBob2xlcy5mb3JFYWNoKGhvbGUgPT4gewogICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgMC4xKSB7IC8vIDEwJSBjaGFuY2UgdG8gY2hhbmdlCiAgICAgICAgICBob2xlLmNsYXNzTmFtZSA9ICdjb3Vyc2UtaG9sZSAnICsgc3RhdHVzZXNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogc3RhdHVzZXMubGVuZ3RoKV07CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiB1cGRhdGVXZWF0aGVyKCkgewogICAgICBjb25zdCB0ZW1wcyA9IFs3MCwgNzEsIDcyLCA3MywgNzRdOwogICAgICBjb25zdCBjb25kaXRpb25zID0gWydTdW5ueScsICdQYXJ0bHkgQ2xvdWR5JywgJ092ZXJjYXN0JywgJ0xpZ2h0IEJyZWV6ZSddOwogICAgICAKICAgICAgY29uc3QgdGVtcEVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dlYXRoZXJUZW1wJyk7CiAgICAgIGNvbnN0IGRlc2NFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3ZWF0aGVyRGVzYycpOwogICAgICAKICAgICAgaWYgKHRlbXBFbCAmJiBNYXRoLnJhbmRvbSgpIDwgMC4yKSB7CiAgICAgICAgdGVtcEVsLnRleHRDb250ZW50ID0gdGVtcHNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdGVtcHMubGVuZ3RoKV0gKyAnwrBGJzsKICAgICAgfQogICAgICAKICAgICAgaWYgKGRlc2NFbCAmJiBNYXRoLnJhbmRvbSgpIDwgMC4yKSB7CiAgICAgICAgY29uc3QgY29uZGl0aW9uID0gY29uZGl0aW9uc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBjb25kaXRpb25zLmxlbmd0aCldOwogICAgICAgIGNvbnN0IHdpbmQgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxMCkgKyAzOwogICAgICAgIGRlc2NFbC50ZXh0Q29udGVudCA9IGAke2NvbmRpdGlvbn0g4oCiICR7d2luZH0gbXBoIHdpbmRzYDsKICAgICAgfQogICAgfQoKICAgIC8vIFVUSUxJVFkgRlVOQ1RJT05TCiAgICBmdW5jdGlvbiB0cmFja01vZHVsZVVzYWdlKG1vZHVsZSkgewogICAgICBjb25zb2xlLmxvZyhgTW9kdWxlIGFjY2Vzc2VkOiAke21vZHVsZX0gYXQgJHtuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCl9YCk7CiAgICB9CgogICAgZnVuY3Rpb24gc2hvd0hvbGVUb29sdGlwKGhvbGVFbGVtZW50KSB7CiAgICAgIGNvbnN0IGhvbGVOdW1iZXIgPSBob2xlRWxlbWVudC50ZXh0Q29udGVudDsKICAgICAgY29uc3Qgc3RhdHVzID0gaG9sZUVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKCdob2xlLWNsZWFyJykgPyAnQ2xlYXInIDogCiAgICAgICAgICAgICAgICAgICBob2xlRWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoJ2hvbGUtYnVzeScpID8gJ0J1c3knIDogJ0JhY2tlZCBVcCc7CiAgICAgIAogICAgICAvLyBDcmVhdGUgYW5kIHNob3cgdG9vbHRpcCAoc2ltcGxpZmllZCBpbXBsZW1lbnRhdGlvbikKICAgICAgY29uc29sZS5sb2coYEhvbGUgJHtob2xlTnVtYmVyfTogJHtzdGF0dXN9YCk7CiAgICB9CgogICAgZnVuY3Rpb24gaGlkZUhvbGVUb29sdGlwKCkgewogICAgICAvLyBIaWRlIHRvb2x0aXAgaW1wbGVtZW50YXRpb24KICAgIH0KCiAgICBmdW5jdGlvbiBzaG93RGF0YVBvaW50VG9vbHRpcChwb2ludEVsZW1lbnQpIHsKICAgICAgY29uc3QgdmFsdWUgPSBwb2ludEVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLXZhbHVlJyk7CiAgICAgIGNvbnNvbGUubG9nKGBEYXRhIHBvaW50OiAke3ZhbHVlfWApOwogICAgfQoKICAgIGZ1bmN0aW9uIGhpZGVEYXRhUG9pbnRUb29sdGlwKCkgewogICAgICAvLyBIaWRlIHRvb2x0aXAgaW1wbGVtZW50YXRpb24KICAgIH0KCiAgICAvLyBQTEFDRUhPTERFUiBGVU5DVElPTlMgRk9SIEJVVFRPTlMKICAgIGZ1bmN0aW9uIGV4cG9ydERhdGEobW9kdWxlLCBmb3JtYXQpIHsKICAgICAgYWRkTm90aWZpY2F0aW9uKGBFeHBvcnRpbmcgJHttb2R1bGV9IGRhdGEgYXMgJHtmb3JtYXR9Li4uYCwgJ2luZm8nKTsKICAgIH0KCiAgICBmdW5jdGlvbiBwcmludFJlcG9ydChtb2R1bGUpIHsKICAgICAgYWRkTm90aWZpY2F0aW9uKGBQcmVwYXJpbmcgJHttb2R1bGV9IHJlcG9ydCBmb3IgcHJpbnRpbmcuLi5gLCAnaW5mbycpOwogICAgICB3aW5kb3cucHJpbnQoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzY2hlZHVsZVJlcG9ydChtb2R1bGUpIHsKICAgICAgYWRkTm90aWZpY2F0aW9uKGBSZXBvcnQgc2NoZWR1bGluZyBvcGVuZWQgZm9yICR7bW9kdWxlfWAsICdpbmZvJyk7CiAgICB9CgogICAgZnVuY3Rpb24gZHJpbGxEb3duUmV2ZW51ZShzb3VyY2UpIHsKICAgICAgYWRkTm90aWZpY2F0aW9uKGBPcGVuaW5nIGRldGFpbGVkIHZpZXcgZm9yICR7c291cmNlfSByZXZlbnVlYCwgJ2luZm8nKTsKICAgIH0KCiAgICBmdW5jdGlvbiB2aWV3VGltZVNsb3REZXRhaWxzKHNsb3QpIHsKICAgICAgYWRkTm90aWZpY2F0aW9uKGBWaWV3aW5nIGRldGFpbHMgZm9yIHRpbWUgc2xvdDogJHtzbG90fWAsICdpbmZvJyk7CiAgICB9CgogICAgZnVuY3Rpb24gb3B0aW1pemVTbG90KHNsb3QpIHsKICAgICAgYWRkTm90aWZpY2F0aW9uKGBPcHRpbWl6YXRpb24gc3VnZ2VzdGlvbnMgZm9yICR7c2xvdH0gdGltZSBzbG90YCwgJ3N1Y2Nlc3MnKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbXBsZW1lbnRQcmljaW5nKHNsb3QpIHsKICAgICAgYWRkTm90aWZpY2F0aW9uKGBQcmVtaXVtIHByaWNpbmcgaW1wbGVtZW50ZWQgZm9yICR7c2xvdH1gLCAnc3VjY2VzcycpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZVByb21vdGlvbih0eXBlKSB7CiAgICAgIGFkZE5vdGlmaWNhdGlvbihgQ3JlYXRpbmcgJHt0eXBlfSBwcm9tb3Rpb24uLi5gLCAnaW5mbycpOwogICAgfQoKICAgIGZ1bmN0aW9uIGV4cGFuZE1lbnUoKSB7CiAgICAgIGFkZE5vdGlmaWNhdGlvbignTWVudSBleHBhbnNpb24gb3B0aW9ucyBvcGVuZWQnLCAnaW5mbycpOwogICAgfQoKICAgIGZ1bmN0aW9uIHZpZXdEZXRhaWxlZFdlYXRoZXIoKSB7CiAgICAgIGFkZE5vdGlmaWNhdGlvbignT3BlbmluZyBkZXRhaWxlZCB3ZWF0aGVyIGZvcmVjYXN0JywgJ2luZm8nKTsKICAgIH0KCiAgICBmdW5jdGlvbiB2aWV3SG9sZURldGFpbHMoaG9sZU51bWJlcikgewogICAgICBhZGROb3RpZmljYXRpb24oYFZpZXdpbmcgZGV0YWlscyBmb3IgSG9sZSAke2hvbGVOdW1iZXJ9YCwgJ2luZm8nKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZW5kUGFjZUFsZXJ0KHRhcmdldCkgewogICAgICBhZGROb3RpZmljYXRpb24oYFBhY2Ugb2YgcGxheSBhbGVydCBzZW50IHRvICR7dGFyZ2V0fWAsICd3YXJuaW5nJyk7CiAgICB9CgogICAgZnVuY3Rpb24gZGVwbG95UmFuZ2VyKCkgewogICAgICBhZGROb3RpZmljYXRpb24oJ0NvdXJzZSByYW5nZXIgZGVwbG95ZWQgdG8gbW9uaXRvciBwYWNlJywgJ2luZm8nKTsKICAgIH0KCiAgICBmdW5jdGlvbiByZWZyZXNoQ291cnNlU3RhdHVzKCkgewogICAgICBhZGROb3RpZmljYXRpb24oJ0NvdXJzZSBzdGF0dXMgcmVmcmVzaGVkJywgJ3N1Y2Nlc3MnKTsKICAgICAgdXBkYXRlQ291cnNlU3RhdHVzKCk7CiAgICB9CgogICAgZnVuY3Rpb24gdmlld0dyb3VwRGV0YWlscyhncm91cCkgewogICAgICBhZGROb3RpZmljYXRpb24oYFZpZXdpbmcgZGV0YWlscyBmb3IgJHtncm91cH0gZ3JvdXBgLCAnaW5mbycpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNvbnRhY3RHcm91cChncm91cCkgewogICAgICBhZGROb3RpZmljYXRpb24oYENvbnRhY3RpbmcgJHtncm91cH0gZ3JvdXAgYWJvdXQgcGFjZWAsICd3YXJuaW5nJyk7CiAgICB9CgogICAgZnVuY3Rpb24gcmV3YXJkR3JvdXAoZ3JvdXApIHsKICAgICAgYWRkTm90aWZpY2F0aW9uKGBTZW5kaW5nIHBhY2UgcmV3YXJkIHRvICR7Z3JvdXB9IGdyb3VwYCwgJ3N1Y2Nlc3MnKTsKICAgIH0KCiAgICBmdW5jdGlvbiB2aWV3Q29uZGl0aW9uRGV0YWlscyhhcmVhKSB7CiAgICAgIGFkZE5vdGlmaWNhdGlvbihgVmlld2luZyBjb25kaXRpb24gZGV0YWlscyBmb3IgJHthcmVhfWAsICdpbmZvJyk7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlQ29uZGl0aW9ucygpIHsKICAgICAgYWRkTm90aWZpY2F0aW9uKCdDb3Vyc2UgY29uZGl0aW9ucyB1cGRhdGUgZm9ybSBvcGVuZWQnLCAnaW5mbycpOwogICAgfQoKICAgIGZ1bmN0aW9uIGFkZE1haW50ZW5hbmNlVGFzaygpIHsKICAgICAgYWRkTm90aWZpY2F0aW9uKCdBZGQgbWFpbnRlbmFuY2UgdGFzayBmb3JtIG9wZW5lZCcsICdpbmZvJyk7CiAgICB9CgogICAgZnVuY3Rpb24gc2NoZWR1bGVTZXJ2aWNlKGVxdWlwbWVudCkgewogICAgICBhZGROb3RpZmljYXRpb24oYFNlcnZpY2Ugc2NoZWR1bGVkIGZvciAke2VxdWlwbWVudH1gLCAnc3VjY2VzcycpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNjaGVkdWxlSW5zcGVjdGlvbihzeXN0ZW0pIHsKICAgICAgYWRkTm90aWZpY2F0aW9uKGBJbnNwZWN0aW9uIHNjaGVkdWxlZCBmb3IgJHtzeXN0ZW19YCwgJ3N1Y2Nlc3MnKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZW5kTWFpbnRlbmFuY2VSZXBvcnQoKSB7CiAgICAgIGFkZE5vdGlmaWNhdGlvbignTWFpbnRlbmFuY2UgcmVwb3J0IHNlbnQgdG8gdGVhbScsICdzdWNjZXNzJyk7CiAgICB9CgogICAgZnVuY3Rpb24gc2VuZFN0YWZmUmVwb3J0KCkgewogICAgICBhZGROb3RpZmljYXRpb24oJ1N0YWZmIHJlcG9ydCBzZW50IHRvIG1hbmFnZW1lbnQnLCAnc3VjY2VzcycpOwogICAgfQoKICAgIGZ1bmN0aW9uIGhhbmRsZUF0dGVuZGFuY2VJc3N1ZShzdGFmZikgewogICAgICBhZGROb3RpZmljYXRpb24oYEF0dGVuZGFuY2UgaXNzdWUgZm9ybSBvcGVuZWQgZm9yICR7c3RhZmZ9YCwgJ3dhcm5pbmcnKTsKICAgIH0KCiAgICBmdW5jdGlvbiB2aWV3VHJhaW5pbmdPdmVyZHVlKCkgewogICAgICBhZGROb3RpZmljYXRpb24oJ1RyYWluaW5nIG92ZXJkdWUgbGlzdCBvcGVuZWQnLCAnd2FybmluZycpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJldmlld1RpbWVPZmZSZXF1ZXN0cygpIHsKICAgICAgYWRkTm90aWZpY2F0aW9uKCdUaW1lLW9mZiByZXF1ZXN0cyBvcGVuZWQgZm9yIHJldmlldycsICdpbmZvJyk7CiAgICB9CgogICAgZnVuY3Rpb24gYWNrbm93bGVkZ2VBY2hpZXZlbWVudChzdGFmZikgewogICAgICBhZGROb3RpZmljYXRpb24oYEFjaGlldmVtZW50IGFja25vd2xlZGdlZCBmb3IgJHtzdGFmZn1gLCAnc3VjY2VzcycpOwogICAgfQoKICAgIGZ1bmN0aW9uIGFzc2lnbkNhZGR5KCkgewogICAgICBhZGROb3RpZmljYXRpb24oJ0NhZGR5IGFzc2lnbm1lbnQgZm9ybSBvcGVuZWQnLCAnaW5mbycpOwogICAgfQoKICAgIGZ1bmN0aW9uIGJ1bGtTdGF0dXNVcGRhdGUoZGVwYXJ0bWVudCkgewogICAgICBhZGROb3RpZmljYXRpb24oYEJ1bGsgc3RhdHVzIHVwZGF0ZSBvcGVuZWQgZm9yICR7ZGVwYXJ0bWVudH1gLCAnaW5mbycpOwogICAgfQoKICAgIGZ1bmN0aW9uIHZpZXdEZXBhcnRtZW50RGV0YWlscyhkZXB0KSB7CiAgICAgIGFkZE5vdGlmaWNhdGlvbihgVmlld2luZyAke2RlcHR9IGRlcGFydG1lbnQgZGV0YWlsc2AsICdpbmZvJyk7CiAgICB9CgogICAgZnVuY3Rpb24gbWFuYWdlRGVwYXJ0bWVudChkZXB0KSB7CiAgICAgIGFkZE5vdGlmaWNhdGlvbihgTWFuYWdlbWVudCB0b29scyBvcGVuZWQgZm9yICR7ZGVwdH1gLCAnaW5mbycpOwogICAgfQoKICAgIGZ1bmN0aW9uIHZpZXdTYWxlc01ldHJpY3MoKSB7CiAgICAgIGFkZE5vdGlmaWNhdGlvbignUHJvIHNob3Agc2FsZXMgbWV0cmljcyBvcGVuZWQnLCAnaW5mbycpOwogICAgfQoKICAgIGZ1bmN0aW9uIHZpZXdDYWRkeUhpc3RvcnkoY2FkZHlJZCkgewogICAgICBhZGROb3RpZmljYXRpb24oYFZpZXdpbmcgaGlzdG9yeSBmb3IgY2FkZHkgJHtjYWRkeUlkfWAsICdpbmZvJyk7CiAgICB9CgogICAgZnVuY3Rpb24gdmlld1NhbGVzKHN0YWZmSWQpIHsKICAgICAgYWRkTm90aWZpY2F0aW9uKGBTYWxlcyBkYXNoYm9hcmQgb3BlbmVkIGZvciAke3N0YWZmSWR9YCwgJ2luZm8nKTsKICAgIH0KCiAgICBmdW5jdGlvbiBhc3NpZ25UYXNrKHN0YWZmSWQpIHsKICAgICAgY29uc3QgdGFzayA9IHByb21wdCgnQXNzaWduIHRhc2s6JywgJ1Jlc3RvY2sgaW52ZW50b3J5Jyk7CiAgICAgIGlmICh0YXNrKSB7CiAgICAgICAgYWRkTm90aWZpY2F0aW9uKGBUYXNrIGFzc2lnbmVkOiAke3Rhc2t9YCwgJ3N1Y2Nlc3MnKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHZpZXdTY2hlZHVsZShzdGFmZklkKSB7CiAgICAgIGFkZE5vdGlmaWNhdGlvbihgU2NoZWR1bGUgb3BlbmVkIGZvciAke3N0YWZmSWR9YCwgJ2luZm8nKTsKICAgIH0KCiAgICBmdW5jdGlvbiB2aWV3U3RhZmZTY2hlZHVsZShzdGFmZklkKSB7CiAgICAgIGFkZE5vdGlmaWNhdGlvbihgU3RhZmYgc2NoZWR1bGUgb3BlbmVkIGZvciAke3N0YWZmSWR9YCwgJ2luZm8nKTsKICAgIH0KCiAgICBmdW5jdGlvbiB2aWV3TGVzc29uSGlzdG9yeShzdGFmZklkKSB7CiAgICAgIGFkZE5vdGlmaWNhdGlvbihgTGVzc29uIGhpc3Rvcnkgb3BlbmVkIGZvciAke3N0YWZmSWR9YCwgJ2luZm8nKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZW5lcmF0ZVJlcG9ydCh0eXBlKSB7CiAgICAgIGFkZE5vdGlmaWNhdGlvbihgR2VuZXJhdGluZyAke3R5cGV9IHJlcG9ydC4uLmAsICdpbmZvJyk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2VuZXJhdGVDdXN0b21SZXBvcnQoKSB7CiAgICAgIGFkZE5vdGlmaWNhdGlvbignQ3VzdG9tIHJlcG9ydCBidWlsZGVyIG9wZW5lZCcsICdpbmZvJyk7CiAgICB9CgogICAgZnVuY3Rpb24gc2NoZWR1bGVBdXRvbWF0ZWRSZXBvcnQoKSB7CiAgICAgIGFkZE5vdGlmaWNhdGlvbignQXV0b21hdGVkIHJlcG9ydCBzY2hlZHVsaW5nIG9wZW5lZCcsICdpbmZvJyk7CiAgICB9CgogICAgZnVuY3Rpb24gdmlld1JlcG9ydEhpc3RvcnkoKSB7CiAgICAgIGFkZE5vdGlmaWNhdGlvbignUmVwb3J0IGhpc3Rvcnkgb3BlbmVkJywgJ2luZm8nKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkb3dubG9hZFJlcG9ydChyZXBvcnRJZCkgewogICAgICBhZGROb3RpZmljYXRpb24oYERvd25sb2FkaW5nIHJlcG9ydDogJHtyZXBvcnRJZH1gLCAnc3VjY2VzcycpOwogICAgfQoKICAgIGZ1bmN0aW9uIGVtYWlsUmVwb3J0KHJlcG9ydElkKSB7CiAgICAgIGFkZE5vdGlmaWNhdGlvbihgRW1haWxpbmcgcmVwb3J0OiAke3JlcG9ydElkfWAsICdzdWNjZXNzJyk7CiAgICB9CgogICAgLy8gSW5pdGlhbGl6ZSB0aGUgYXBwbGljYXRpb24KICAgIGNvbnNvbGUubG9nKCdNeUNhZGR5IFBybyBpbml0aWFsaXplZCBzdWNjZXNzZnVsbHknKTsKICA8L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+" style={{width:'100%',height:'100%',border:0}} />
</div>) : currentUser?.role === 'caddy' ? (
                                       <div className="space-y-3">
                                           <div className="bg-gradient-to-r from-green-600 to-teal-600 rounded-lg p-4 text-white">
                                               <div className="flex justify-between items-center">
                                                   <div>
                                                       <div className="text-sm opacity-90">Caddy Portal</div>
                                                       <div className="text-xl font-bold">Welcome, {currentUser.name}</div>
                                                   </div>
                                                   <Users className="w-8 h-8 opacity-80" />
                                               </div>
                                           </div>
                                           <div className="grid grid-cols-2 gap-2">
                                               <div className="bg-white/90 rounded-lg p-3 shadow-md">
                                                   <div className="flex items-center justify-between">
                                                       <div>
                                                           <p className="text-xs text-gray-600">Today's Bookings</p>
                                                           <p className="text-lg font-bold text-gray-900">{getCaddyBookings().length}</p>
                                                           <p className="text-xs text-green-600">Sessions</p>
                                                       </div>
                                                       <Calendar className="w-5 h-5 text-blue-500" />
                                                   </div>
                                               </div>
                                               <div className="bg-white/90 rounded-lg p-3 shadow-md">
                                                   <div className="flex items-center justify-between">
                                                       <div>
                                                           <p className="text-xs text-gray-600">My Status</p>
                                                           <p className={`text-base font-bold ${
                                                               getCurrentCaddyStatus() === 'working' ? 'text-green-600' :
                                                               getCurrentCaddyStatus() === 'available' ? 'text-blue-600' :
                                                               getCurrentCaddyStatus() === 'on-break' ? 'text-yellow-600' :
                                                               'text-red-600'
                                                           }`}>
                                                               {getCurrentCaddyStatus().replace('-', ' ').toUpperCase()}
                                                           </p>
                                                           <select
                                                               value={getCurrentCaddyStatus()}
                                                               onChange={(e) => handleMyCaddyStatusChange(e.target.value)}
                                                               className="text-xs border rounded p-1 mt-1"
                                                           >
                                                               <option value="working">Working</option>
                                                               <option value="available">Available</option>
                                                               <option value="on-break">On Break</option>
                                                               <option value="day-off">Day Off</option>
                                                           </select>
                                                       </div>
                                                       <div className={`w-3 h-3 rounded-full ${
                                                           getCurrentCaddyStatus() === 'working' ? 'bg-green-500' :
                                                           getCurrentCaddyStatus() === 'available' ? 'bg-blue-500' :
                                                           getCurrentCaddyStatus() === 'on-break' ? 'bg-yellow-500' :
                                                           'bg-red-500'
                                                       }`}></div>
                                                   </div>
                                               </div>
                                               <div onClick={() => setActiveTab('my-bookings')} className="bg-white/90 rounded-lg p-3 shadow-md cursor-pointer hover:bg-white/95 transition-all">
                                                   <div className="flex items-center justify-between">
                                                       <div>
                                                           <p className="text-xs text-gray-600">View</p>
                                                           <p className="text-base font-bold text-blue-600">Bookings</p>
                                                       </div>
                                                       <Calendar className="w-5 h-5 text-blue-500" />
                                                   </div>
                                               </div>
                                               <div onClick={() => setActiveTab('day-off-requests')} className="bg-white/90 rounded-lg p-3 shadow-md cursor-pointer hover:bg-white/95 transition-all">
                                                   <div className="flex items-center justify-between">
                                                       <div>
                                                           <p className="text-xs text-gray-600">Request</p>
                                                           <p className="text-base font-bold text-orange-600">Day Off</p>
                                                       </div>
                                                       <Plus className="w-5 h-5 text-orange-500" />
                                                   </div>
                                               </div>
                                           </div>
                                       </div>
                                   ) : (
                                       <div className="space-y-3">
                                           {currentUser?.tier && (
                                               <div className={`rounded-lg p-3 text-white ${
                                                   currentUser.tier === 'platinum' ? 'bg-gradient-to-r from-gray-700 to-gray-900' :
                                                   currentUser.tier === 'gold' ? 'bg-gradient-to-r from-yellow-500 to-yellow-600' :
                                                   'bg-gradient-to-r from-gray-400 to-gray-500'
                                               }`}>
                                                   <div className="flex justify-between items-center">
                                                       <div>
                                                           <div className="text-xs opacity-90">Membership Status</div>
                                                           <div className="text-lg font-bold capitalize">{currentUser.tier} Member</div>
                                                       </div>
                                                       <Trophy className="w-6 h-6 opacity-80" />
                                                   </div>
                                               </div>
                                           )}
                                           <div className="grid grid-cols-2 gap-2">
                                               <div onClick={() => setShowBudgetModal(true)} className="bg-white/90 rounded-lg p-3 shadow-md cursor-pointer hover:bg-white/95 transition-all">
                                                   <p className="text-xs text-gray-600 mb-1">Monthly Budget</p>
                                                   <p className="text-base font-bold text-gray-900">{formatCurrency(monthlySpent)}</p>
                                                   <p className="text-xs text-gray-500">of {formatCurrency(monthlyBudget)}</p>
                                                   <div className="w-full bg-gray-200 rounded-full h-1.5 mt-1">
                                                       <div className="h-1.5 rounded-full bg-gradient-to-r from-teal-500 to-blue-500" style={{width: getBudgetPercentage() + '%'}}></div>
                                                   </div>
                                               </div>
                                               <div onClick={() => setShowPointsModal(true)} className="bg-white/90 rounded-lg p-3 shadow-md cursor-pointer hover:bg-white/95 transition-all">
                                                   <p className="text-xs text-gray-600">Activity Points</p>
                                                   <div className="flex justify-between mt-1">
                                                       <div>
                                                           <p className="text-base font-bold text-blue-600">{getCurrentUserPoints()}</p>
                                                           <p className="text-xs text-gray-500">Monthly</p>
                                                       </div>
                                                       <div className="text-right">
                                                           <p className="text-base font-bold text-purple-600">#{getCurrentUserRank()}</p>
                                                           <p className="text-xs text-gray-500">Rank</p>
                                                       </div>
                                                   </div>
                                               </div>
                                               <div onClick={openGolfModal} className="bg-white/90 rounded-lg p-3 shadow-md cursor-pointer hover:bg-white/95 transition-all">
                                                   <div className="flex items-center justify-between">
                                                       <div>
                                                           <p className="text-xs text-gray-600">Book Round</p>
                                                           <p className="text-base font-bold text-blue-600">Schedule</p>
                                                       </div>
                                                       <Plus className="w-5 h-5 text-blue-500" />
                                                   </div>
                                               </div>
                                               <div onClick={() => setShowScoreModal(true)} className="bg-white/90 rounded-lg p-3 shadow-md cursor-pointer hover:bg-white/95 transition-all">
                                                   <div className="flex items-center justify-between">
                                                       <div>
                                                           <p className="text-xs text-gray-600">Latest Score</p>
                                                           <p className="text-base font-bold text-green-600">{golfRounds.length > 0 ? golfRounds[0].score : 'New'}</p>
                                                           {golfRounds.length > 0 && (
                                                               <p className="text-xs text-gray-500">{golfRounds[0].course}</p>
                                                           )}
                                                       </div>
                                                       <Target className="w-5 h-5 text-green-500" />
                                                   </div>
                                               </div>
                                           </div>
                                       </div>
                                   )}
                               </div>
                           )}

                           
                           
                           {/* Live Tab - All roles */}
                           {activeTab === 'live' && (
                               <div className="space-y-3">
                                   <div className="flex items-center justify-between bg-gradient-to-r from-blue-50 to-teal-50 border rounded-xl px-3 py-2">
                                     <div className="flex items-center space-x-2">
                                       <div className="w-7 h-7 rounded-lg bg-blue-600 text-white flex items-center justify-center font-bold">L</div>
                                       <div>
                                         <h2 className="text-lg font-bold text-gray-900 leading-none">Live Leaderboards</h2>
                                         <p className="text-[11px] text-gray-500">Today • Real-time updates</p>
                                       </div>
                                     </div>
                                     <div className="flex items-center space-x-2">
                                       <span className="text-[10px] px-2 py-1 rounded-full bg-green-100 text-green-700 border border-green-200">LIVE</span>
                                       <span className="text-[10px] px-2 py-1 rounded-full bg-blue-100 text-blue-700 border border-blue-200">Public view</span>
                                     </div>
                                   </div>
                                   <div id="live-center-root" className="bg-white rounded-xl border shadow-sm p-3"></div>
                               </div>
                           )}
{activeTab === 'schedule' && currentUser?.role === 'golfer' && (
  <div className="space-y-3">
    <div className="bg-white rounded-xl border p-4">
      <h2 className="text-lg font-bold text-gray-900">Schedule</h2>
      <p className="text-sm text-gray-500">Your upcoming rounds &amp; caddy bookings</p>
    </div>
    <div id="schedule-react-root"></div>
  </div>
)}

                           
                           {/* Events */}
                           {activeTab === 'events' && currentUser?.role === 'golfer' && (
                               <div className="space-y-3">
                                   <div className="flex justify-between items-center">
                                       <h2 className="text-lg font-bold text-gray-900">Events</h2>
                                   </div>
                                   <div className="rounded-lg border overflow-hidden" style={{height:'80vh'}}>
                                       <iframe title="Events v6" src="data:text/html;base64,PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCI+CiAgICA8dGl0bGU+R29sZiBFdmVudHMgTWFuYWdlbWVudDwvdGl0bGU+CiAgICA8c3R5bGU+CiAgICAgICAgOnJvb3R7CiAgICAgICAgICAtLWJnOiMwZjE3MmE7CiAgICAgICAgICAtLXBhbmVsOiNmZmZmZmY7CiAgICAgICAgICAtLW11dGVkOiM2YjcyODA7CiAgICAgICAgICAtLXByaW1hcnk6IzFkNGVkODsKICAgICAgICAgIC0tcHJpbWFyeS03MDA6IzFlNDBhZjsKICAgICAgICAgIC0tZGFuZ2VyOiNkYzI2MjY7CiAgICAgICAgICAtLW9rOiMwNTk2Njk7CiAgICAgICAgICAtLXdhcm5pbmc6I2Y1OWUwYjsKICAgICAgICAgIC0tYm9yZGVyOiNkMWQ1ZGI7CiAgICAgICAgICAtLWNoaXA6I2VlZjJmZjsKICAgICAgICAgIC0tc2hhZG93OiAwIDNweCAxNnB4IHJnYmEoMiw4LDIzLC4wNSk7CiAgICAgICAgfQoKICAgICAgICBib2R5IHsgbWFyZ2luOiAwOyBwYWRkaW5nOiAwOyBmb250LWZhbWlseTogLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCAnU2Vnb2UgVUknLCBSb2JvdG8sIHNhbnMtc2VyaWY7IGJhY2tncm91bmQ6ICNmOGZhZmM7IH0KICAgICAgICAuY29udGFpbmVye21heC13aWR0aDoxMDUwcHg7bWFyZ2luOjI0cHggYXV0bztwYWRkaW5nOjAgMjBweH0KCiAgICAgICAgLnRvb2xiYXJ7ZGlzcGxheTpmbGV4O2p1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuO2FsaWduLWl0ZW1zOmNlbnRlcjttYXJnaW4tYm90dG9tOjE0cHg7ZmxleC13cmFwOndyYXA7Z2FwOjEycHh9CiAgICAgICAgLnRvb2xiYXItbGVmdHtkaXNwbGF5OmZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO2dhcDoxMnB4fQogICAgICAgIC5zZWFyY2gtYmFye3Bvc2l0aW9uOnJlbGF0aXZlO21pbi13aWR0aDoyNTBweH0KICAgICAgICAuc2VhcmNoLWlucHV0ewogICAgICAgICAgd2lkdGg6MTAwJTtwYWRkaW5nOjhweCAxMnB4IDhweCAzNnB4O2JvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKTtib3JkZXItcmFkaXVzOjEwcHg7CiAgICAgICAgICBiYWNrZ3JvdW5kOndoaXRlO2ZvbnQtc2l6ZToxNHB4O3RyYW5zaXRpb246YWxsIDAuMnM7Ym94LXNpemluZzpib3JkZXItYm94OwogICAgICAgIH0KICAgICAgICAuc2VhcmNoLWlucHV0OmZvY3Vze291dGxpbmU6bm9uZTtib3JkZXItY29sb3I6dmFyKC0tcHJpbWFyeSk7Ym94LXNoYWRvdzowIDAgMCAzcHggcmdiYSgyOSw3OCwyMTYsMC4xKX0KICAgICAgICAuc2VhcmNoLWljb257cG9zaXRpb246YWJzb2x1dGU7bGVmdDoxMnB4O3RvcDo1MCU7dHJhbnNmb3JtOnRyYW5zbGF0ZVkoLTUwJSk7Y29sb3I6dmFyKC0tbXV0ZWQpO2ZvbnQtc2l6ZToxNHB4fQoKICAgICAgICAuZmlsdGVyc3tkaXNwbGF5OmZsZXg7Z2FwOjhweDthbGlnbi1pdGVtczpjZW50ZXJ9CiAgICAgICAgLmZpbHRlci1idG57CiAgICAgICAgICBwYWRkaW5nOjZweCAxMnB4O2JvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKTtiYWNrZ3JvdW5kOndoaXRlO2JvcmRlci1yYWRpdXM6OHB4OwogICAgICAgICAgY3Vyc29yOnBvaW50ZXI7Zm9udC1zaXplOjEzcHg7dHJhbnNpdGlvbjphbGwgMC4yczsKICAgICAgICB9CiAgICAgICAgLmZpbHRlci1idG46aG92ZXJ7Ym9yZGVyLWNvbG9yOnZhcigtLXByaW1hcnkpfQogICAgICAgIC5maWx0ZXItYnRuLmFjdGl2ZXtiYWNrZ3JvdW5kOnZhcigtLXByaW1hcnkpO2NvbG9yOndoaXRlO2JvcmRlci1jb2xvcjp2YXIoLS1wcmltYXJ5KX0KCiAgICAgICAgLmJ0bnsKICAgICAgICAgIGJhY2tncm91bmQ6dmFyKC0tcHJpbWFyeSk7Y29sb3I6I2ZmZjtib3JkZXI6bm9uZTtib3JkZXItcmFkaXVzOjEwcHg7cGFkZGluZzoxMHB4IDE0cHg7CiAgICAgICAgICBmb250LXdlaWdodDo3MDA7Y3Vyc29yOnBvaW50ZXI7Ym94LXNoYWRvdzowIDFweCAwIHJnYmEoMCwwLDAsLjEpO3RyYW5zaXRpb246YWxsIDAuMnM7CiAgICAgICAgfQogICAgICAgIC5idG46aG92ZXJ7YmFja2dyb3VuZDp2YXIoLS1wcmltYXJ5LTcwMCk7dHJhbnNmb3JtOnRyYW5zbGF0ZVkoLTFweCl9CiAgICAgICAgLmJ0bi5zZWNvbmRhcnl7YmFja2dyb3VuZDojZTVlN2ViO2NvbG9yOiMxMTE4Mjd9CiAgICAgICAgLmJ0bi5zZWNvbmRhcnk6aG92ZXJ7YmFja2dyb3VuZDojZDFkNWRifQogICAgICAgIC5idG4uZGFuZ2Vye2JhY2tncm91bmQ6dmFyKC0tZGFuZ2VyKX0KICAgICAgICAuYnRuLmRhbmdlcjpob3ZlcntiYWNrZ3JvdW5kOiNiOTFjMWN9CiAgICAgICAgLmJ0bi5zdWNjZXNze2JhY2tncm91bmQ6dmFyKC0tb2spfQogICAgICAgIC5idG4uc3VjY2Vzczpob3ZlcntiYWNrZ3JvdW5kOiMwNDc4NTd9CiAgICAgICAgLmJ0bjpkaXNhYmxlZHtvcGFjaXR5OjAuNTtjdXJzb3I6bm90LWFsbG93ZWQ7dHJhbnNmb3JtOm5vbmV9CiAgICAgICAgLm11dGVke2NvbG9yOnZhcigtLW11dGVkKX0KCiAgICAgICAgLmdyaWR7ZGlzcGxheTpncmlkO2dyaWQtdGVtcGxhdGUtY29sdW1uczoxZnIgMzUwcHg7Z2FwOjE4cHh9CiAgICAgICAgQG1lZGlhIChtYXgtd2lkdGg6OTgwcHgpeyAKICAgICAgICAgIC5ncmlke2dyaWQtdGVtcGxhdGUtY29sdW1uczoxZnJ9IAogICAgICAgICAgLnRvb2xiYXJ7ZmxleC1kaXJlY3Rpb246Y29sdW1uO2FsaWduLWl0ZW1zOnN0cmV0Y2h9CiAgICAgICAgICAuc2VhcmNoLWJhcnttaW4td2lkdGg6YXV0b30KICAgICAgICB9CgogICAgICAgIC5jYXJke2JhY2tncm91bmQ6dmFyKC0tcGFuZWwpO2JvcmRlci1yYWRpdXM6MTRweDtib3gtc2hhZG93OnZhcigtLXNoYWRvdyk7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO3RyYW5zaXRpb246YWxsIDAuMnN9CiAgICAgICAgLmNhcmQ6aG92ZXJ7Ym94LXNoYWRvdzowIDZweCAyNHB4IHJnYmEoMiw4LDIzLC4wOCl9CiAgICAgICAgLmNhcmQgLmhke2Rpc3BsYXk6ZmxleDtnYXA6MTBweDthbGlnbi1pdGVtczpjZW50ZXI7anVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47Ym9yZGVyLWJvdHRvbToxcHggc29saWQgdmFyKC0tYm9yZGVyKTtwYWRkaW5nOjE0cHggMTZweH0KICAgICAgICAuY2FyZCAuYmR7cGFkZGluZzoxNHB4IDE2cHh9CiAgICAgICAgLnN0YWNre2Rpc3BsYXk6ZmxleDtmbGV4LWRpcmVjdGlvbjpjb2x1bW47Z2FwOjEwcHh9CgogICAgICAgIC5ldmVudHtkaXNwbGF5OmZsZXg7Z2FwOjEycHg7YWxpZ24taXRlbXM6Y2VudGVyO2p1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuO2JvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKTsKICAgICAgICAgICAgICAgcGFkZGluZzoxMnB4O2JvcmRlci1yYWRpdXM6MTJweDtiYWNrZ3JvdW5kOiNmZmY7dHJhbnNpdGlvbjphbGwgMC4ycztwb3NpdGlvbjpyZWxhdGl2ZX0KICAgICAgICAuZXZlbnQ6aG92ZXJ7Ym94LXNoYWRvdzowIDRweCAxMnB4IHJnYmEoMiw4LDIzLC4wOCk7dHJhbnNmb3JtOnRyYW5zbGF0ZVkoLTFweCl9CiAgICAgICAgLmV2ZW50LmZ1bGx7Ym9yZGVyLWNvbG9yOnZhcigtLWRhbmdlcik7YmFja2dyb3VuZDojZmVmMmYyfQogICAgICAgIC5ldmVudC5hdmFpbGFibGV7Ym9yZGVyLWNvbG9yOnZhcigtLW9rKTtiYWNrZ3JvdW5kOiNmMGZkZjR9CiAgICAgICAgLmV2ZW50IGg0e21hcmdpbjowIDAgNnB4IDA7Zm9udC1zaXplOjE2cHh9CiAgICAgICAgLnJvd3tkaXNwbGF5OmZsZXg7Z2FwOjEycHg7ZmxleC13cmFwOndyYXA7YWxpZ24taXRlbXM6Y2VudGVyfQogICAgICAgIC5waWxse2JhY2tncm91bmQ6I2VlZjJmZjtib3JkZXI6MXB4IHNvbGlkICNjN2QyZmU7Y29sb3I6IzM3MzBhMztwYWRkaW5nOjJweCA4cHg7Ym9yZGVyLXJhZGl1czo5OTlweDtmb250LXNpemU6MTJweDtmb250LXdlaWdodDo3MDB9CiAgICAgICAgLnBpbGwucHJpdmF0ZXtiYWNrZ3JvdW5kOiNmZWYzYzc7Ym9yZGVyLWNvbG9yOiNmYmJmMjQ7Y29sb3I6IzkyNDAwZX0KICAgICAgICAucGlsbC5wdWJsaWN7YmFja2dyb3VuZDojZGNmY2U3O2JvcmRlci1jb2xvcjojMjJjNTVlO2NvbG9yOiMxNjY1MzR9CiAgICAgICAgLnBpbGwuZnVsbHtiYWNrZ3JvdW5kOiNmZWUyZTI7Ym9yZGVyLWNvbG9yOiNlZjQ0NDQ7Y29sb3I6I2RjMjYyNn0KICAgICAgICAuY291bnR7Zm9udC1mYW1pbHk6dWktbW9ub3NwYWNlLCBTRk1vbm8tUmVndWxhciwgTWVubG8sIE1vbmFjbywgQ29uc29sYXMsICJMaWJlcmF0aW9uIE1vbm8iLCAiQ291cmllciBOZXciLCBtb25vc3BhY2U7CiAgICAgICAgICAgICAgIGJhY2tncm91bmQ6I2Y4ZmFmYztib3JkZXI6MXB4IHNvbGlkIHZhcigtLWJvcmRlcik7Ym9yZGVyLXJhZGl1czo4cHg7cGFkZGluZzo0cHggOHB4O2ZvbnQtd2VpZ2h0OjYwMH0KICAgICAgICAuYWN0aW9uc3tkaXNwbGF5OmZsZXg7Z2FwOjhweH0KCiAgICAgICAgLmV2ZW50LXN0YXR1c3twb3NpdGlvbjphYnNvbHV0ZTt0b3A6OHB4O3JpZ2h0OjhweDt3aWR0aDo4cHg7aGVpZ2h0OjhweDtib3JkZXItcmFkaXVzOjUwJX0KICAgICAgICAuc3RhdHVzLW9wZW57YmFja2dyb3VuZDp2YXIoLS1vayl9CiAgICAgICAgLnN0YXR1cy1mdWxse2JhY2tncm91bmQ6dmFyKC0tZGFuZ2VyKX0KICAgICAgICAuc3RhdHVzLXdhaXRpbmd7YmFja2dyb3VuZDp2YXIoLS13YXJuaW5nKX0KCiAgICAgICAgLm5vdGlmaWNhdGlvbnsKICAgICAgICAgIHBvc2l0aW9uOmZpeGVkO3RvcDoyMHB4O3JpZ2h0OjIwcHg7YmFja2dyb3VuZDp2YXIoLS1vayk7Y29sb3I6d2hpdGU7CiAgICAgICAgICBwYWRkaW5nOjEycHggMTZweDtib3JkZXItcmFkaXVzOjhweDtib3gtc2hhZG93OjAgNHB4IDEycHggcmdiYSgwLDAsMCwuMTUpOwogICAgICAgICAgei1pbmRleDoxMDAwO2ZvbnQtc2l6ZToxNHB4O3RyYW5zZm9ybTp0cmFuc2xhdGVYKDEwMCUpOwogICAgICAgICAgdHJhbnNpdGlvbjp0cmFuc2Zvcm0gMC4zcyBlYXNlOwogICAgICAgIH0KICAgICAgICAubm90aWZpY2F0aW9uLnNob3d7dHJhbnNmb3JtOnRyYW5zbGF0ZVgoMCl9CiAgICAgICAgLm5vdGlmaWNhdGlvbi5lcnJvcntiYWNrZ3JvdW5kOnZhcigtLWRhbmdlcil9CiAgICAgICAgLm5vdGlmaWNhdGlvbi53YXJuaW5ne2JhY2tncm91bmQ6dmFyKC0td2FybmluZyl9CgogICAgICAgIC5zdGF0cy1yb3d7ZGlzcGxheTpmbGV4O2dhcDoxNnB4O21hcmdpbi1ib3R0b206MTZweDtmbGV4LXdyYXA6d3JhcH0KICAgICAgICAuc3RhdC1pdGVte2JhY2tncm91bmQ6d2hpdGU7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO2JvcmRlci1yYWRpdXM6OHB4O3BhZGRpbmc6MTJweDtmbGV4OjE7bWluLXdpZHRoOjEyMHB4O3RleHQtYWxpZ246Y2VudGVyfQogICAgICAgIC5zdGF0LW51bWJlcntmb250LXNpemU6MjBweDtmb250LXdlaWdodDpib2xkO2NvbG9yOnZhcigtLXByaW1hcnkpfQogICAgICAgIC5zdGF0LWxhYmVse2ZvbnQtc2l6ZToxMnB4O2NvbG9yOnZhcigtLW11dGVkKTttYXJnaW4tdG9wOjRweH0KCiAgICAgICAgLmVtcHR5LXN0YXRle3RleHQtYWxpZ246Y2VudGVyO3BhZGRpbmc6NDBweCAyMHB4O2NvbG9yOnZhcigtLW11dGVkKX0KICAgICAgICAuZW1wdHktc3RhdGUgaDN7bWFyZ2luOjAgMCA4cHggMDtjb2xvcjojMzc0MTUxfQoKICAgICAgICBAbWVkaWEgKG1heC13aWR0aDo2NDBweCl7CiAgICAgICAgICAuYWN0aW9uc3tmbGV4LWRpcmVjdGlvbjpjb2x1bW59CiAgICAgICAgICAudG9vbGJhcntnYXA6OHB4fQogICAgICAgICAgLmZpbHRlcnN7ZmxleC13cmFwOndyYXB9CiAgICAgICAgfQogICAgPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KICAgIDxkaXYgY2xhc3M9ImNvbnRhaW5lciIgc3R5bGU9Im1hcmdpbi10b3A6MCI+CiAgICAgIDxkaXYgY2xhc3M9InRvb2xiYXIiPgogICAgICAgIDxkaXYgY2xhc3M9InRvb2xiYXItbGVmdCI+CiAgICAgICAgICA8aDIgc3R5bGU9Im1hcmdpbjowIj5Hb2xmIEV2ZW50czwvaDI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWFyY2gtYmFyIj4KICAgICAgICAgICAgPHNwYW4gY2xhc3M9InNlYXJjaC1pY29uIj7wn5SNPC9zcGFuPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgY2xhc3M9InNlYXJjaC1pbnB1dCIgaWQ9InNlYXJjaEV2ZW50cyIgcGxhY2Vob2xkZXI9IlNlYXJjaCBldmVudHMuLi4iPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTpmbGV4O2dhcDoxMnB4O2FsaWduLWl0ZW1zOmNlbnRlcjtmbGV4LXdyYXA6d3JhcCI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJmaWx0ZXJzIj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iZmlsdGVyLWJ0biBhY3RpdmUiIG9uY2xpY2s9InNldEZpbHRlcignYWxsJykiPkFsbDwvYnV0dG9uPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJmaWx0ZXItYnRuIiBvbmNsaWNrPSJzZXRGaWx0ZXIoJ215LWV2ZW50cycpIj5NeSBFdmVudHM8L2J1dHRvbj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iZmlsdGVyLWJ0biIgb25jbGljaz0ic2V0RmlsdGVyKCdpbnZpdGVkJykiPkludml0ZWQ8L2J1dHRvbj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iZmlsdGVyLWJ0biIgb25jbGljaz0ic2V0RmlsdGVyKCdwdWJsaWMnKSI+UHVibGljPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biIgb25jbGljaz0ic2hvd0NyZWF0ZUV2ZW50KCkiPisgQ3JlYXRlIEV2ZW50PC9idXR0b24+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgoKICAgICAgPGRpdiBjbGFzcz0ic3RhdHMtcm93Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0LWl0ZW0iPgogICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdC1udW1iZXIiIGlkPSJ0b3RhbEV2ZW50cyI+NjwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdC1sYWJlbCI+VG90YWwgRXZlbnRzPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0ic3RhdC1pdGVtIj4KICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXQtbnVtYmVyIiBpZD0ibXlFdmVudHMiPjE8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXQtbGFiZWwiPk15IEV2ZW50czwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InN0YXQtaXRlbSI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0LW51bWJlciIgaWQ9InVwY29taW5nRXZlbnRzIj41PC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0LWxhYmVsIj5VcGNvbWluZzwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InN0YXQtaXRlbSI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0LW51bWJlciIgaWQ9Im9wZW5TcG90cyI+MTU8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXQtbGFiZWwiPk9wZW4gU3BvdHM8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CgogICAgICA8ZGl2IGNsYXNzPSJncmlkIj4KICAgICAgICA8ZGl2IGNsYXNzPSJzdGFjayIgaWQ9ImV2ZW50TGlzdCI+CiAgICAgICAgICA8IS0tIEZyaWRheSBTa2lucyAtIFVzZXIgaXMgb3JnYW5pemVyIC0tPgogICAgICAgICAgPGRpdiBjbGFzcz0iZXZlbnQgYXZhaWxhYmxlIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iZXZlbnQtc3RhdHVzIHN0YXR1cy1vcGVuIj48L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZmxleDoxIj4KICAgICAgICAgICAgICA8aDQ+RnJpZGF5IFNraW5zIGF0IFNpYW0gQ291bnRyeSBDbHViPC9oND4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9Im11dGVkIj5GcmksIFNlcCAxMiwgMDg6MDAgQU08L3NwYW4+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0icGlsbCBwcml2YXRlIj7wn5SSIFByaXZhdGU8L3NwYW4+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0icGlsbCI+U2lhbSBDb3VudHJ5IENsdWIgLSBQbGFudGF0aW9uIENvdXJzZTwvc3Bhbj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJwaWxsIj5Ta2luczwvc3Bhbj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJjb3VudCI+8J+foiAwIHNwb3RzIGxlZnQ8L3NwYW4+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0icGlsbCIgc3R5bGU9ImJhY2tncm91bmQ6I2ZiYmYyNDtjb2xvcjojOTI0MDBlIj7wn5GRIE9yZ2FuaXplcjwvc3Bhbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFjdGlvbnMiPgogICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBzZWNvbmRhcnkiPlZpZXcgRGV0YWlsczwvYnV0dG9uPgogICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biI+RWRpdDwvYnV0dG9uPgogICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBkYW5nZXIiIG9uY2xpY2s9ImRlbGV0ZUV2ZW50KDEpIj5EZWxldGU8L2J1dHRvbj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICA8IS0tIFdlZWtlbmQgU2NyYW1ibGUgLSBVc2VyIGNhbiBqb2luIC0tPgogICAgICAgICAgPGRpdiBjbGFzcz0iZXZlbnQgYXZhaWxhYmxlIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iZXZlbnQtc3RhdHVzIHN0YXR1cy1vcGVuIj48L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZmxleDoxIj4KICAgICAgICAgICAgICA8aDQ+V2Vla2VuZCBTY3JhbWJsZSBDaGFtcGlvbnNoaXA8L2g0PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ibXV0ZWQiPlN1biwgU2VwIDE0LCAwNjozMCBBTTwvc3Bhbj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJwaWxsIHB1YmxpYyI+8J+MkCBQdWJsaWM8L3NwYW4+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0icGlsbCI+UGhvZW5peCBHb2xkIEdvbGYgQ291cnNlPC9zcGFuPgogICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InBpbGwiPlNjcmFtYmxlPC9zcGFuPgogICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImNvdW50Ij7wn5+iIDEgc3BvdHMgbGVmdDwvc3Bhbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFjdGlvbnMiPgogICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBzZWNvbmRhcnkiPlZpZXcgRGV0YWlsczwvYnV0dG9uPgogICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBzdWNjZXNzIiBvbmNsaWNrPSJqb2luRXZlbnQoMikiPkpvaW4gRXZlbnQ8L2J1dHRvbj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICA8IS0tIFR1ZXNkYXkgTW9ybmluZyBHcm91cCAtIFVzZXIgY2FuIGpvaW4gLS0+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJldmVudCBhdmFpbGFibGUiPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJldmVudC1zdGF0dXMgc3RhdHVzLW9wZW4iPjwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmbGV4OjEiPgogICAgICAgICAgICAgIDxoND5UdWVzZGF5IE1vcm5pbmcgR3JvdXA8L2g0PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ibXV0ZWQiPldlZCwgU2VwIDEwLCAwNzowMCBBTTwvc3Bhbj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJwaWxsIHByaXZhdGUiPvCflJIgUHJpdmF0ZTwvc3Bhbj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJwaWxsIj5MYWVtIENoYWJhbmcgSW50ZXJuYXRpb25hbCBDb3VudHJ5IENsdWI8L3NwYW4+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0icGlsbCI+Q2FzdWFsPC9zcGFuPgogICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImNvdW50Ij7wn5+iIDEgc3BvdHMgbGVmdDwvc3Bhbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFjdGlvbnMiPgogICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBzZWNvbmRhcnkiPlZpZXcgRGV0YWlsczwvYnV0dG9uPgogICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBzdWNjZXNzIiBvbmNsaWNrPSJqb2luRXZlbnQoMykiPkpvaW4gRXZlbnQ8L2J1dHRvbj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICA8IS0tIENvcnBvcmF0ZSBUb3VybmFtZW50IC0gRnVsbCB3aXRoIHdhaXRsaXN0IC0tPgogICAgICAgICAgPGRpdiBjbGFzcz0iZXZlbnQgZnVsbCI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImV2ZW50LXN0YXR1cyBzdGF0dXMtd2FpdGluZyI+PC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZsZXg6MSI+CiAgICAgICAgICAgICAgPGg0PkNvcnBvcmF0ZSBUb3VybmFtZW50IC0gVGVjaCBDb21wYW5pZXM8L2g0PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ibXV0ZWQiPlNhdCwgU2VwIDIwLCAwODozMCBBTTwvc3Bhbj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJwaWxsIHB1YmxpYyI+8J+MkCBQdWJsaWM8L3NwYW4+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0icGlsbCI+QnVyYXBoYSBHb2xmIENsdWI8L3NwYW4+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0icGlsbCI+VG91cm5hbWVudDwvc3Bhbj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJjb3VudCI+8J+UtCBGdWxsICgzIHdhaXRpbmcpPC9zcGFuPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iYWN0aW9ucyI+CiAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIHNlY29uZGFyeSI+VmlldyBEZXRhaWxzPC9idXR0b24+CiAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIHNlY29uZGFyeSIgb25jbGljaz0iam9pbldhaXRsaXN0KDQpIj5Kb2luIFdhaXRsaXN0PC9idXR0b24+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CgogICAgICAgICAgPCEtLSBTdW5kYXkgQmVzdCBCYWxsIC0gRnVsbCB3aXRoIHdhaXRsaXN0IC0tPgogICAgICAgICAgPGRpdiBjbGFzcz0iZXZlbnQgZnVsbCI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImV2ZW50LXN0YXR1cyBzdGF0dXMtd2FpdGluZyI+PC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZsZXg6MSI+CiAgICAgICAgICAgICAgPGg0PlN1bmRheSBCZXN0IEJhbGw8L2g0PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ibXV0ZWQiPlN1biwgU2VwIDE1LCAwOTowMCBBTTwvc3Bhbj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJwaWxsIHB1YmxpYyI+8J+MkCBQdWJsaWM8L3NwYW4+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0icGlsbCI+Um95YWwgR2VtcyBHb2xmIFJlc29ydDwvc3Bhbj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJwaWxsIj5CZXN0IEJhbGw8L3NwYW4+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iY291bnQiPvCflLQgRnVsbCAoMSB3YWl0aW5nKTwvc3Bhbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFjdGlvbnMiPgogICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBzZWNvbmRhcnkiPlZpZXcgRGV0YWlsczwvYnV0dG9uPgogICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBzZWNvbmRhcnkiIG9uY2xpY2s9ImpvaW5XYWl0bGlzdCg1KSI+Sm9pbiBXYWl0bGlzdDwvYnV0dG9uPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgIDwhLS0gQWZ0ZXJub29uIFF1aWNrIE5pbmUgLSBVc2VyIGNhbiBqb2luIC0tPgogICAgICAgICAgPGRpdiBjbGFzcz0iZXZlbnQgYXZhaWxhYmxlIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iZXZlbnQtc3RhdHVzIHN0YXR1cy1vcGVuIj48L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZmxleDoxIj4KICAgICAgICAgICAgICA8aDQ+QWZ0ZXJub29uIFF1aWNrIE5pbmU8L2g0PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ibXV0ZWQiPldlZCwgU2VwIDExLCAwMjowMCBQTTwvc3Bhbj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJwaWxsIHB1YmxpYyI+8J+MkCBQdWJsaWM8L3NwYW4+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0icGlsbCI+UGF0dGF5YSBDb3VudHJ5IENsdWI8L3NwYW4+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0icGlsbCI+Q2FzdWFsPC9zcGFuPgogICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImNvdW50Ij7wn5+iIDIgc3BvdHMgbGVmdDwvc3Bhbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFjdGlvbnMiPgogICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBzZWNvbmRhcnkiPlZpZXcgRGV0YWlsczwvYnV0dG9uPgogICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBzdWNjZXNzIiBvbmNsaWNrPSJqb2luRXZlbnQoNikiPkpvaW4gRXZlbnQ8L2J1dHRvbj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KCiAgICAgICAgPGFzaWRlIGNsYXNzPSJzdGFjayI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkIiBzdHlsZT0icGFkZGluZzoxNHB4OyB0ZXh0LWFsaWduOmNlbnRlciI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9Im11dGVkIj5TZWxlY3QgYW4gZXZlbnQgdG8gdmlldyBkZXRhaWxzIGFuZCBtYW5hZ2UgcGFydGljaXBhbnRzPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2FzaWRlPgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgoKICAgIDxkaXYgaWQ9Im5vdGlmaWNhdGlvbnMiPjwvZGl2PgoKICAgIDxzY3JpcHQ+CiAgICAgICAgLy8gU2ltcGxlLCByb2J1c3QgZXZlbnQgbWFuYWdlbWVudAogICAgICAgIGxldCBjdXJyZW50VXNlciA9ICJBbGV4IFRob21wc29uIjsKICAgICAgICBsZXQgY3VycmVudEZpbHRlciA9ICJhbGwiOwoKICAgICAgICBmdW5jdGlvbiBzaG93Tm90aWZpY2F0aW9uKG1lc3NhZ2UsIHR5cGUgPSAnc3VjY2VzcycpIHsKICAgICAgICAgICAgY29uc3Qgbm90aWZpY2F0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIG5vdGlmaWNhdGlvbi5jbGFzc05hbWUgPSBgbm90aWZpY2F0aW9uICR7dHlwZX1gOwogICAgICAgICAgICBub3RpZmljYXRpb24udGV4dENvbnRlbnQgPSBtZXNzYWdlOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25vdGlmaWNhdGlvbnMnKTsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lcikgewogICAgICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKG5vdGlmaWNhdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gbm90aWZpY2F0aW9uLmNsYXNzTGlzdC5hZGQoJ3Nob3cnKSwgMTAwKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob3cnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vdGlmaWNhdGlvbi5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3RpZmljYXRpb24ucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCAzMDApOwogICAgICAgICAgICAgICAgfSwgMzAwMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGpvaW5FdmVudChldmVudElkKSB7CiAgICAgICAgICAgIGNvbnN0IGV2ZW50TmFtZXMgPSB7CiAgICAgICAgICAgICAgICAyOiAiV2Vla2VuZCBTY3JhbWJsZSBDaGFtcGlvbnNoaXAiLAogICAgICAgICAgICAgICAgMzogIlR1ZXNkYXkgTW9ybmluZyBHcm91cCIsIAogICAgICAgICAgICAgICAgNjogIkFmdGVybm9vbiBRdWljayBOaW5lIgogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZXZlbnROYW1lID0gZXZlbnROYW1lc1tldmVudElkXSB8fCAiRXZlbnQiOwogICAgICAgICAgICBzaG93Tm90aWZpY2F0aW9uKGBTdWNjZXNzZnVsbHkgam9pbmVkICIke2V2ZW50TmFtZX0iIWApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW4gYSByZWFsIGFwcCwgdGhpcyB3b3VsZCBtYWtlIGFuIEFQSSBjYWxsCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBKb2luaW5nIGV2ZW50ICR7ZXZlbnRJZH1gKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGpvaW5XYWl0bGlzdChldmVudElkKSB7CiAgICAgICAgICAgIGNvbnN0IGV2ZW50TmFtZXMgPSB7CiAgICAgICAgICAgICAgICA0OiAiQ29ycG9yYXRlIFRvdXJuYW1lbnQgLSBUZWNoIENvbXBhbmllcyIsCiAgICAgICAgICAgICAgICA1OiAiU3VuZGF5IEJlc3QgQmFsbCIKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGV2ZW50TmFtZSA9IGV2ZW50TmFtZXNbZXZlbnRJZF0gfHwgIkV2ZW50IjsKICAgICAgICAgICAgc2hvd05vdGlmaWNhdGlvbihgQWRkZWQgdG8gd2FpdGxpc3QgZm9yICIke2V2ZW50TmFtZX0iYCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbiBhIHJlYWwgYXBwLCB0aGlzIHdvdWxkIG1ha2UgYW4gQVBJIGNhbGwKICAgICAgICAgICAgY29uc29sZS5sb2coYEpvaW5pbmcgd2FpdGxpc3QgZm9yIGV2ZW50ICR7ZXZlbnRJZH1gKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRlbGV0ZUV2ZW50KGV2ZW50SWQpIHsKICAgICAgICAgICAgaWYgKGNvbmZpcm0oJ0RlbGV0ZSAiRnJpZGF5IFNraW5zIGF0IFNpYW0gQ291bnRyeSBDbHViIj9cblxuVGhpcyB3aWxsIG5vdGlmeSBhbGwgcGFydGljaXBhbnRzLicpKSB7CiAgICAgICAgICAgICAgICBzaG93Tm90aWZpY2F0aW9uKCdFdmVudCBkZWxldGVkIHN1Y2Nlc3NmdWxseScpOwogICAgICAgICAgICAgICAgLy8gSW4gYSByZWFsIGFwcCwgdGhpcyB3b3VsZCBtYWtlIGFuIEFQSSBjYWxsCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgRGVsZXRpbmcgZXZlbnQgJHtldmVudElkfWApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzZXRGaWx0ZXIoZmlsdGVyKSB7CiAgICAgICAgICAgIGN1cnJlbnRGaWx0ZXIgPSBmaWx0ZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgYWN0aXZlIGZpbHRlciBidXR0b24KICAgICAgICAgICAgY29uc3QgYnV0dG9ucyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5maWx0ZXItYnRuJyk7CiAgICAgICAgICAgIGJ1dHRvbnMuZm9yRWFjaChidG4gPT4gYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGFjdGl2ZUJ0biA9IEFycmF5LmZyb20oYnV0dG9ucykuZmluZChidG4gPT4gCiAgICAgICAgICAgICAgICBidG4udGV4dENvbnRlbnQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmaWx0ZXIucmVwbGFjZSgnLScsICcgJykpCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmIChhY3RpdmVCdG4pIHsKICAgICAgICAgICAgICAgIGFjdGl2ZUJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgc2hvd05vdGlmaWNhdGlvbihgU2hvd2luZyAke2ZpbHRlci5yZXBsYWNlKCctJywgJyAnKX0gZXZlbnRzYCwgJ3dhcm5pbmcnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluIGEgcmVhbCBhcHAsIHRoaXMgd291bGQgZmlsdGVyIHRoZSBldmVudHMgbGlzdAogICAgICAgICAgICBjb25zb2xlLmxvZyhgRmlsdGVyIGNoYW5nZWQgdG86ICR7ZmlsdGVyfWApOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2hvd0NyZWF0ZUV2ZW50KCkgewogICAgICAgICAgICBzaG93Tm90aWZpY2F0aW9uKCdDcmVhdGUgRXZlbnQgbW9kYWwgd291bGQgb3BlbiBoZXJlJywgJ3dhcm5pbmcnKTsKICAgICAgICAgICAgLy8gSW4gYSByZWFsIGFwcCwgdGhpcyB3b3VsZCBvcGVuIHRoZSBjcmVhdGUgZXZlbnQgbW9kYWwKICAgICAgICAgICAgY29uc29sZS5sb2coJ09wZW5pbmcgY3JlYXRlIGV2ZW50IG1vZGFsJyk7CiAgICAgICAgfQoKICAgICAgICAvLyBTaW1wbGUgc2VhcmNoIGZ1bmN0aW9uYWxpdHkKICAgICAgICBjb25zdCBzZWFyY2hJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZWFyY2hFdmVudHMnKTsKICAgICAgICBpZiAoc2VhcmNoSW5wdXQpIHsKICAgICAgICAgICAgc2VhcmNoSW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNlYXJjaFRlcm0gPSB0aGlzLnZhbHVlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICBpZiAoc2VhcmNoVGVybSkgewogICAgICAgICAgICAgICAgICAgIHNob3dOb3RpZmljYXRpb24oYFNlYXJjaGluZyBmb3I6ICR7c2VhcmNoVGVybX1gLCAnd2FybmluZycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gSW4gYSByZWFsIGFwcCwgdGhpcyB3b3VsZCBmaWx0ZXIgZXZlbnRzIGJ5IHNlYXJjaCB0ZXJtCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgU2VhcmNoaW5nIGZvcjogJHtzZWFyY2hUZXJtfWApOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIEluaXRpYWxpemUKICAgICAgICBjb25zb2xlLmxvZygnR29sZiBFdmVudHMgTW9kdWxlIGxvYWRlZCBzdWNjZXNzZnVsbHknKTsKICAgICAgICBzaG93Tm90aWZpY2F0aW9uKCdHb2xmIEV2ZW50cyBNb2R1bGUgbG9hZGVkIHN1Y2Nlc3NmdWxseSEnKTsKICAgIDwvc2NyaXB0Pgo8L2JvZHk+CjwvaHRtbD4=" style={{width:'100%',height:'100%',border:0}} />
                                   </div>
                               </div>
                           )}
Tab - Golfer */}
                           {activeTab === 'society' && (currentUser && currentUser.role) === 'golfer' && (
                               <NewSocietySection user={currentUser} events={events} onSpend={(d)=>setMonthlySpent(p=>Math.max(0, p + (Number(d)||0)))}
                                   onSpend={(amt)=> setMonthlySpent(prev => prev + amt)}
                               />
                           )}
{/* Scores Tab - Golfer */}
                           {activeTab === 'scores' && currentUser?.role === 'golfer' && (
                               <div className="space-y-3">
                                   <div className="flex justify-between items-center">
                                       <h2 className="text-lg font-bold text-gray-900">Golf Scores</h2>
                                       <button
                                           onClick={() => setShowScoreModal(true)}
                                           className="bg-green-500 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-green-600 transition-all flex items-center space-x-1"
                                       >
                                           <Plus className="w-4 h-4" />
                                           <span>Post Score</span>
                                       </button>
                                   </div>
                                   
                                   <div className="space-y-2">
                                       {golfRounds.map((round, idx) => (
                                           <div key={round.id} className="bg-white/90 rounded-lg p-3 shadow-md">
                                               <div className="flex justify-between items-start">
                                                   <div className="flex-1">
                                                       <div className="flex items-center space-x-2">
                                                           <h3 className="font-semibold text-gray-900">{round.course}</h3>
                                                           <span className="text-lg font-bold text-green-600">{round.score}</span>
                                                       </div>
                                                       <p className="text-sm text-gray-600">{new Date(round.date).toLocaleDateString()}</p>
                                                       {round.eventTitle && (
                                                           <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded mt-1 inline-block">
                                                               {round.eventTitle}
                                                           </span>
                                                       )}
                                                       {round.notes && (
                                                           <p className="text-xs text-gray-500 mt-1">{round.notes}</p>
                                                       )}
                                                   </div>

                                                   <div className="text-right text-xs w-24 mr-2">
                                                       {(() => {
                                                           const hi = (window.WHS_HI_AfterIndex?WHS_HI_AfterIndex(idx,golfRounds):handicapIndexFromScore(round.score));
                                                           const prevScore = golfRounds[idx+1]?.score;
                                                           const prevHi = typeof prevScore === 'number' ? (window.WHS_HI_AfterIndex?WHS_HI_AfterIndex(idx+1,golfRounds):handicapIndexFromScore(prevScore)) : null;
                                                           const diff = prevHi !== null ? Math.round((hi - prevHi) * 10) / 10 : 0;
                                                           const dir = diff < 0 ? 'down' : diff > 0 ? 'up' : 'flat';
                                                           const arrow = dir === 'down' ? '⬇️' : dir === 'up' ? '⬆️' : '⟷';
                                                           return (
                                                               <div className="text-gray-700">
                                                                   HI: <span className="font-semibold">{hi}</span>
                                                                   <div className={`${dir==='down' ? 'text-green-600' : 'text-red-600'} ${dir==='flat' ? 'text-gray-500' : ''}`}>
                                                                       {arrow} {diff}
                                                                   </div>
                                                               </div>
                                                           );
                                                       })()}
                                                   </div>
                                                   <button

                                                       className="text-red-500 hover:text-red-700 p-1 transition-colors"
                                                   >
                                                       <Trash className="w-4 h-4" />
                                                   </button>
                                               </div>
                                           </div>
                                       ))}
                                       {golfRounds.length === 0 && (
                                           <div className="text-center py-8 text-gray-500">
                                               <Target className="w-12 h-12 mx-auto mb-2 opacity-50" />
                                               <p>No scores recorded</p>
                                               <p className="text-sm">Post your first score to track your progress!</p>
                                           </div>
                                       )}
                                   </div>
                               </div>
                           )}

                           {/* Leaderboard Tab - Golfer */}
                           {activeTab === 'leaderboard' && currentUser?.role === 'golfer' && (
                               <div className="space-y-3">
            <div className="bg-white/90 rounded-lg p-3 shadow-md">
                <div className="flex items-center gap-2">
                    <input
                        value={leaderboardQuery}
                        onChange={(e)=>setLeaderboardQuery(e.target.value)}
                        placeholder="Search golfer by name..."
                        className="flex-1 border rounded-lg p-2 text-sm"
                    />
                    <button
                        onClick={()=>{
                            const lb = getLeaderboard();
                            const hit = lb.find(g=> g.name.toLowerCase().includes(leaderboardQuery.toLowerCase()));
                            if(hit){
                                const rounds = (roundsHistoryByGolfer[hit.name] || []).slice(-5);
                                setSelectedGolferInfo({...hit, rounds, trend: trendFromSeries(rounds.slice(-2))});
                            } else {
                                setSelectedGolferInfo(null);
                            }
                        }}
                        className="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm"
                    >Find</button>
                </div>
                {selectedGolferInfo && (
                    <div className="mt-2 border-t pt-2 text-sm">
                        <div className="font-semibold">{selectedGolferInfo.name}</div>
                        <div className="text-gray-700">Tier: {selectedGolferInfo.tier || '—'} • Points: {selectedGolferInfo.points}</div>
                        <div className="text-gray-700">Last 5: {selectedGolferInfo.rounds.join(', ') || '—'}</div>
                        <div className={selectedGolferInfo.trend?.dir==='down' ? 'text-green-600' : selectedGolferInfo.trend?.dir==='up' ? 'text-red-600' : 'text-gray-500'}>
                            Trend: {selectedGolferInfo.trend?.dir==='down' ? '⬇️' : selectedGolferInfo.trend?.dir==='up' ? '⬆️' : '⟷'} {selectedGolferInfo.trend?.delta || 0}
                        </div>
                    </div>
                )}
            </div>
        
                                   <div className="flex justify-between items-center">
                                       <h2 className="text-lg font-bold text-gray-900">Leaderboard</h2>
                                       <div className="flex bg-gray-200 rounded-lg p-1">
                                           <button 
                                               onClick={() => setRankingPeriod('monthly')} 
                                               className={`px-3 py-1 text-sm rounded-md transition-all ${rankingPeriod === 'monthly' ? 'bg-blue-500 text-white' : 'text-gray-600 hover:bg-gray-300'}`}
                                           >
                                               Monthly
                                           </button>
                                           <button 
                                               onClick={() => setRankingPeriod('yearly')} 
                                               className={`px-3 py-1 text-sm rounded-md transition-all ${rankingPeriod === 'yearly' ? 'bg-blue-500 text-white' : 'text-gray-600 hover:bg-gray-300'}`}
                                           >
                                               Yearly
                                           </button>
                                       </div>
                                   </div>
                                   
                                   <div className="space-y-2">
                                       {getLeaderboard().map((golfer, index) => (
                                           <div key={golfer.id} className={`bg-white/90 rounded-lg p-3 shadow-md transition-all ${golfer.id === currentUser?.id ? 'ring-2 ring-blue-500 bg-blue-50/90' : ''}`}>
                                               <div className="flex items-center justify-between">
                                                   <div className="flex items-center space-x-3">
                                                       <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm ${
                                                           index === 0 ? 'bg-yellow-500' :
                                                           index === 1 ? 'bg-gray-400' :
                                                           index === 2 ? 'bg-orange-600' :
                                                           'bg-blue-500'
                                                       }`}>
                                                           {index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : golfer.rank}
                                                       </div>
                                                       <div>
                                                           <h3 className="font-semibold text-gray-900">{golfer.name}
            <span className="ml-2 inline-flex flex-col align-top">
                <span className="text-[11px] sm:text-xs text-gray-600 leading-tight">
                    {(coursesHistoryByGolfer[golfer.name] || []).slice(-5).join(' • ') || '—'}
                </span>
                <span className="inline-flex items-center gap-2 mt-0.5">
                    <span className="text-sm sm:text-base font-semibold tracking-wide">
                        {(roundsHistoryByGolfer[golfer.name] || []).slice(-5).join('  ') || '—'}
                    </span>
                    {(() => {
                        const r = (roundsHistoryByGolfer[golfer.name] || []).slice(-2);
                        const tr = trendFromSeries(r);
                        return <span className={`${tr.dir==='down' ? 'text-green-600' : tr.dir==='up' ? 'text-red-600' : 'text-gray-500'} text-base sm:text-lg`}>
                            {tr.dir==='down' ? '⬇️' : tr.dir==='up' ? '⬆️' : '⟷'}
                        </span>;
                    })()}
                </span>
            </span>
        </h3>
                                                           <div className="flex items-center space-x-2">
                                                               <p className="text-xs text-gray-500 capitalize">{golfer.tier} Member</p>
                                                               {golfer.id === currentUser?.id && (
                                                                   <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">You</span>
                                                               )}
                                                           </div>
                                                       </div>
                                                   </div>
                                                   <div className="text-right">
                                                       <p className="text-lg font-bold text-blue-600">{golfer.points}</p>
                                                       <p className="text-xs text-gray-500">{rankingPeriod} points</p>
                                                   </div>
                                               </div>
                                           </div>
                                       ))}
                                       
                                       {/* Current User Summary */}
                                       <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg p-4 text-white mt-4">
                                           <div className="text-center">
                                               <div className="text-sm opacity-90">Your {rankingPeriod} performance</div>
                                               <div className="text-2xl font-bold">#{getCurrentUserRank()}</div>
                                               <div className="text-sm opacity-90">{getCurrentUserPoints()} points</div>
                                               <button
                                                   onClick={() => setShowPointsModal(true)}
                                                   className="mt-2 bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-sm transition-all"
                                               >
                                                   Add Points
                                               </button>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                           )}

                           {/* My Bookings Tab - Caddy */}
                           {activeTab === 'my-bookings' && currentUser?.role === 'caddy' && (
                               <div className="space-y-3">
                                   <h2 className="text-lg font-bold text-gray-900">My Bookings</h2>
                                   
                                   <div className="space-y-2">
                                       {getCaddyBookings().map(booking => (
                                           <div key={booking.id} className="bg-white/90 rounded-lg p-3 shadow-md">
                                               <div className="flex justify-between items-start">
                                                   <div>
                                                       <h3 className="font-semibold text-gray-900">{booking.golfer}</h3>
                                                       <p className="text-sm text-gray-600">{booking.course}</p>
                                                       <div className="flex items-center space-x-3 mt-1">
                                                           <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">{booking.date}</span>
                                                           <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">{booking.time}</span>
                                                           <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">{booking.duration}</span>
                                                       </div>
                                                   </div>
                                                   <span className={`text-xs px-2 py-1 rounded ${
                                                       booking.status === 'confirmed' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'
                                                   }`}>
                                                       {booking.status}
                                                   </span>
                                               </div>
                                           </div>
                                       ))}
                                       {getCaddyBookings().length === 0 && (
                                           <div className="text-center py-8 text-gray-500">
                                               <Calendar className="w-12 h-12 mx-auto mb-2 opacity-50" />
                                               <p>No bookings for today</p>
                                               <p className="text-sm">Check back later for updates!</p>
                                           </div>
                                       )}
                                   </div>
                               </div>
                           )}

                           {/* Day Off Requests Tab - Caddy */}
                           {activeTab === 'day-off-requests' && currentUser?.role === 'caddy' && (
                               <div className="space-y-3">
                                   <div className="flex justify-between items-center">
                                       <h2 className="text-lg font-bold text-gray-900">Day Off Requests</h2>
                                       <button
                                           onClick={() => setShowDayOffModal(true)}
                                           className="bg-orange-500 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-orange-600 transition-all flex items-center space-x-1"
                                       >
                                           <Plus className="w-4 h-4" />
                                           <span>Request Day Off</span>
                                       </button>
                                   </div>
                                   
                                   <div className="space-y-2">
                                       {dayOffRequests.filter(req => req.caddyName === currentUser?.name).map(request => (
                                           <div key={request.id} className="bg-white/90 rounded-lg p-3 shadow-md">
                                               <div className="flex justify-between items-start">
                                                   <div>
                                                       <h3 className="font-semibold text-gray-900">{request.date}</h3>
                                                       <p className="text-sm text-gray-600">{request.reason}</p>
                                                       <p className="text-xs text-gray-500 mt-1">Requested: {request.requestDate}</p>
                                                   </div>
                                                   <span className={`text-xs px-2 py-1 rounded ${
                                                       request.status === 'approved' ? 'bg-green-100 text-green-700' :
                                                       request.status === 'rejected' ? 'bg-red-100 text-red-700' :
                                                       'bg-yellow-100 text-yellow-700'
                                                   }`}>
                                                       {request.status}
                                                   </span>
                                               </div>
                                           </div>
                                       ))}
                                   </div>
                               </div>
                           )}

                           {/* GM Tabs */}
                           {activeTab === 'caddy-status' && currentUser?.role === 'gm' && (
                               <div className="space-y-3">
                                   <div className="flex justify-between items-center">
                                       <h2 className="text-lg font-bold text-gray-900">Caddy Management</h2>
                                       <button
                                           onClick={() => {setSignupRole('caddy'); setShowSignup(true);}}
                                           className="bg-blue-500 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-blue-600 transition-all flex items-center space-x-1"
                                       >
                                           <Plus className="w-4 h-4" />
                                           <span>Add Caddy</span>
                                       </button>
                                   </div>
                                   
                                   <div className="flex space-x-2 mb-3">
                                       <input
                                           type="text"
                                           value={caddySearchTerm}
                                           onChange={(e) => setCaddySearchTerm(e.target.value)}
                                           className="flex-1 border rounded-lg p-2 text-sm"
                                           placeholder="Search by ID or name..."
                                       />
                                       <select
                                           value={caddyStatusFilter}
                                           onChange={(e) => setCaddyStatusFilter(e.target.value)}
                                           className="border rounded-lg p-2 text-sm"
                                       >
                                           <option value="">All Status</option>
                                           <option value="working">Working</option>
                                           <option value="available">Available</option>
                                           <option value="on-break">On Break</option>
                                           <option value="day-off">Day Off</option>
                                       </select>
                                   </div>
                                   
                                   <div className="space-y-2">
                                       {getFilteredCaddies().map(caddy => (
                                           <div key={caddy.id} className="bg-white/90 rounded-lg p-3 shadow-md">
                                               <div className="flex justify-between items-start">
                                                   <div className="flex-1">
                                                       <div className="flex items-center space-x-2">
                                                           <h3 className="font-semibold text-gray-900">{caddy.name}</h3>
                                                           <span className="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">ID: {caddy.id}</span>
                                                       </div>
                                                       <div className="flex items-center space-x-2 mt-1">
                                                           <span className="text-sm text-yellow-600">★ {caddy.rating}</span>
                                                           <span className="text-xs text-gray-500">{caddy.experience}</span>
                                                           <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">{caddy.specialty}</span>
                                                       </div>
                                                       {caddy.currentClient && (
                                                           <p className="text-xs text-gray-600 mt-1">Currently with: {caddy.currentClient}</p>
                                                       )}
                                                   </div>
                                                   <div className="text-right space-y-1">
                                                       <span className={`text-xs px-2 py-1 rounded ${
                                                           caddy.status === 'working' ? 'bg-green-100 text-green-700' :
                                                           caddy.status === 'available' ? 'bg-blue-100 text-blue-700' :
                                                           caddy.status === 'on-break' ? 'bg-yellow-100 text-yellow-700' :
                                                           'bg-red-100 text-red-700'
                                                       }`}>
                                                           {caddy.status.replace('-', ' ')}
                                                       </span>
                                                       <select
                                                           value={caddy.status}
                                                           onChange={(e) => handleCaddyStatusChange(caddy.id, e.target.value)}
                                                           className="block text-xs border rounded p-1"
                                                       >
                                                           <option value="working">Working</option>
                                                           <option value="available">Available</option>
                                                           <option value="on-break">On Break</option>
                                                           <option value="day-off">Day Off</option>
                                                       </select>
                                                   </div>
                                               </div>
                                           </div>
                                       ))}
                                   </div>
                               </div>
                           )}

                           {activeTab === 'tee-sheet' && currentUser?.role === 'gm' && (
  <div id="gm-teesheet-blank" className="space-y-3">
    <div className="mt-2 border border-gray-200 rounded-lg p-6 text-sm text-gray-500 text-center">
      Tee Sheet placeholder
    </div>
  </div>
)}

                           {activeTab === 'announcements' && currentUser?.role === 'gm' && (
                               <div className="space-y-3">
                                   <div className="flex justify-between items-center">
                                       <h2 className="text-lg font-bold text-gray-900">Announcements</h2>
                                       <button
                                           onClick={() => setShowAnnouncementModal(true)}
                                           className="bg-purple-500 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-purple-600 transition-all flex items-center space-x-1"
                                       >
                                           <Plus className="w-4 h-4" />
                                           <span>New Announcement</span>
                                       </button>
                                   </div>
                                   
                                   <div className="space-y-2">
                                       {announcements.map(announcement => (
                                           <div key={announcement.id} className="bg-white/90 rounded-lg p-3 shadow-md">
                                               <div className="flex justify-between items-start">
                                                   <div className="flex-1">
                                                       <div className="flex items-center space-x-2">
                                                           <h3 className="font-semibold text-gray-900">{announcement.title}</h3>
                                                           <span className={`text-xs px-2 py-1 rounded ${
                                                               announcement.priority === 'Urgent' ? 'bg-red-100 text-red-700' :
                                                               announcement.priority === 'Important' ? 'bg-orange-100 text-orange-700' :
                                                               'bg-blue-100 text-blue-700'
                                                           }`}>
                                                               {announcement.priority}
                                                           </span>
                                                       </div>
                                                       <p className="text-sm text-gray-600 mt-1">{announcement.message}</p>
                                                       <p className="text-xs text-gray-500 mt-2">
                                                           {new Date(announcement.timestamp).toLocaleString()}
                                                       </p>
                                                   </div>
                                               </div>
                                           </div>
                                       ))}
                                   </div>
                               </div>
                           )}

                           {activeTab === 'dayoff-requests' && currentUser?.role === 'gm' && (
                               <div className="space-y-3">
                                   <h2 className="text-lg font-bold text-gray-900">Day Off Requests</h2>
                                   
                                   <div className="space-y-2">
                                       {dayOffRequests.map(request => (
                                           <div key={request.id} className="bg-white/90 rounded-lg p-3 shadow-md">
                                               <div className="flex justify-between items-start">
                                                   <div className="flex-1">
                                                       <h3 className="font-semibold text-gray-900">{request.caddyName}</h3>
                                                       <div className="flex items-center space-x-2 text-sm text-gray-600">
                                                           <span>ID: {request.caddyId}</span>
                                                           <span>•</span>
                                                           <span>{request.date}</span>
                                                       </div>
                                                       <p className="text-sm text-gray-600 mt-1">{request.reason}</p>
                                                       <p className="text-xs text-gray-500 mt-1">Requested: {request.requestDate}</p>
                                                   </div>
                                                   <div className="flex items-center space-x-2">
                                                       {request.status === 'pending' ? (
                                                           <>
                                                               <button
                                                                   onClick={() => handleDayOffApproval(request.id, 'approved')}
                                                                   className="bg-green-500 text-white px-3 py-1 rounded text-xs hover:bg-green-600 transition-all"
                                                               >
                                                                   Approve
                                                               </button>
                                                               <button
                                                                   onClick={() => handleDayOffApproval(request.id, 'rejected')}
                                                                   className="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 transition-all"
                                                               >
                                                                   Reject
                                                               </button>
                                                           </>
                                                       ) : (
                                                           <span className={`text-xs px-2 py-1 rounded ${
                                                               request.status === 'approved' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                                                           }`}>
                                                               {request.status}
                                                           </span>
                                                       )}
                                                   </div>
                                               </div>
                                           </div>
                                       ))}
                                       {dayOffRequests.length === 0 && (
                                           <div className="text-center py-8 text-gray-500">
                                               <Users className="w-12 h-12 mx-auto mb-2 opacity-50" />
                                               <p>No day off requests</p>
                                           </div>
                                       )}
                                   </div>
                               </div>
                           )}
                       </div>
                   
        {showOverrideModal && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg p-4 w-full max-w-sm">
                    <div className="font-semibold text-gray-900 mb-2">Confirm GM Override</div>
                    <div className="text-sm text-gray-700 mb-2">
                        Time <b>{overrideData.timeSlot}</b> • Tee <b>{overrideData.teeSlot}</b><br/>
                        Golfer <b>{overrideData.golfer}</b> • Caddy <b>{overrideData.caddyId}</b><br/>
                        Course <b>{overrideData.course || 'Pattaya Country Club'}</b>
                    </div>
                    <div className="flex justify-end gap-2">
                        <button onClick={()=>setShowOverrideModal(false)} className="px-3 py-1.5 rounded border">Cancel</button>
                        <button onClick={handleOverrideAssign} className="px-3 py-1.5 rounded bg-blue-600 text-white">Assign</button>
                    </div>
                </div>
            </div>
        )}
    </main>

                   {/* ALL MODALS */}
                   {showBudgetModal && (
                       <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                           <div className="bg-white rounded-xl p-6 w-full max-w-sm">
                               <h3 className="text-lg font-bold mb-4">Update Monthly Budget</h3>
                               <div className="space-y-4">
                                   <div>
                                       <p className="text-sm text-gray-600 mb-2">Current Budget: {formatCurrency(monthlyBudget)}</p>
                                       <p className="text-sm text-gray-600 mb-4">Spent This Month: {formatCurrency(monthlySpent)}</p>
                                   </div>
                                   <input
                                       type="number"
                                       value={newBudget}
                                       onChange={(e) => setNewBudget(e.target.value)}
                                       className="w-full border rounded-lg p-3"
                                       placeholder="New budget amount"
                                   />
                                   <div className="flex space-x-2">
                                       <button 
                                           onClick={handleUpdateBudget}
                                           className="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-all"
                                       >
                                           Update
                                       </button>
                                       <button 
                                           onClick={() => setShowBudgetModal(false)}
                                           className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-all"
                                       >
                                           Cancel
                                       </button>
                                   </div>
                               </div>
                           </div>
                       </div>
                   )}

                   {showPointsModal && (
                       <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                           <div className="bg-white rounded-xl p-6 w-full max-w-sm">
                               <h3 className="text-lg font-bold mb-4">Add Activity Points</h3>
                               <div className="space-y-4">
<div>
                                       <p className="text-sm text-gray-600 mb-2">Current Points: {getCurrentUserPoints()}</p>
                                       <p className="text-sm text-gray-600 mb-4">Current Rank: #{getCurrentUserRank()}</p>
                                   </div>
                                   <input
                                       type="number"
                                       value={newPoints}
                                       onChange={(e) => setNewPoints(e.target.value)}
                                       className="w-full border rounded-lg p-3"
                                       placeholder="Points to add"
                                   />
                                   <div className="flex space-x-2">
                                       <button 
                                           onClick={handleAddPoints}
                                           className="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-all"
                                       >
                                           Add Points
                                       </button>
                                       <button 
                                           onClick={() => setShowPointsModal(false)}
                                           className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-all"
                                       >
                                           Cancel
                                       </button>
                                   </div>
                               </div>
                           </div>
                       </div>
                   )}

                   {showGolfModal && (
                       <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                           <div className="bg-white rounded-xl p-6 w-full max-w-md">
                               <h3 className="text-lg font-bold mb-4">Schedule Golf Round</h3>
                               <div className="space-y-3">
                                   <input
                                       type="text"
                                       value={newEvent.title}
                                       onChange={(e) => setNewEvent({...newEvent, title: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                       placeholder="Event title"
                                   />
                                   <div className="grid grid-cols-2 gap-2">
                                       <input
                                           type="date"
                                           value={newEvent.date}
                                           onChange={(e) => setNewEvent({...newEvent, date: e.target.value})}
                                           className="border rounded-lg p-3"
                                       />
                                       <input
                                           type="time"
                                           value={newEvent.time}
                                           onChange={(e) => setNewEvent({...newEvent, time: e.target.value})}
                                           className="border rounded-lg p-3"
                                       />
                                   </div>
                                   <select
                                       value={newEvent.course}
                                       onChange={(e) => setNewEvent({...newEvent, course: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                   >
                                       <option value="">Select Course</option>
                                       {courses.map(course => (
                                           <option key={course} value={course}>{course}</option>
                                       ))}
                                   </select>
                                   <select
                                       value={newEvent.caddy}
                                       onChange={(e) => setNewEvent({...newEvent, caddy: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                   >
                                       <option value="">Select Caddy (Optional)</option>
                                       {caddies.map(caddy => (
                                           <option key={caddy} value={caddy}>{caddy}</option>
                                       ))}
                                   </select>
                                   <div className="grid grid-cols-2 gap-2">
                                       <input
                                           type="number"
                                           value={newEvent.courseCost}
                                           onChange={(e) => setNewEvent({...newEvent, courseCost: e.target.value})}
                                           className="border rounded-lg p-3"
                                           placeholder="Course cost"
                                       />
                                       <input
                                           type="number"
                                           value={newEvent.caddyCost}
                                           onChange={(e) => setNewEvent({...newEvent, caddyCost: e.target.value})}
                                           className="border rounded-lg p-3"
                                           placeholder="Caddy cost"
                                       />
                                   </div>
                                   <textarea
                                       value={newEvent.notes}
                                       onChange={(e) => setNewEvent({...newEvent, notes: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                       placeholder="Notes (optional)"
                                       rows="2"
                                   />
                                   <div className="flex space-x-2">
                                       <button 
                                           type="button" onClick={handleScheduleGolf}
                                           className="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-all"
                                       >
                                           Schedule
                                       </button>
                                       <button 
                                           onClick={() => setShowGolfModal(false)}
                                           className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-all"
                                       >
                                           Cancel
                                       </button>
                                   </div>
                               </div>
                           </div>
                       </div>
                   )}

                   {showScoreModal && (
                       <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                           <div className="bg-white rounded-xl p-6 w-full max-w-md">
                               <h3 className="text-lg font-bold mb-4">Post Golf Score</h3>
                               <div className="space-y-3">
                                   <input
                                       type="date"
                                       value={newScore.date}
                                       onChange={(e) => setNewScore({...newScore, date: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                   />
                                   <select
                                       value={newScore.course}
                                       onChange={(e) => setNewScore({...newScore, course: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                   >
                                       <option value="">Select Course</option>
                                       {courses.map(course => (
                                           <option key={course} value={course}>{course}</option>
                                       ))}
                                   </select>
                                   <input
                                       type="number"
                                       value={newScore.score}
                                       onChange={(e) => setNewScore({...newScore, score: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                       placeholder="Your score"
                                       min="60"
                                       max="150"
                                   />
                                   <select
                                       value={newScore.eventId}
                                       onChange={(e) => setNewScore({...newScore, eventId: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                   >
                                       <option value="">Link to event (optional)</option>
                                       {events.map(event => (
                                           <option key={event.id} value={event.id}>{event.title} - {event.date}</option>
                                       ))}
                                   </select>
                                   <textarea
                                       value={newScore.notes}
                                       onChange={(e) => setNewScore({...newScore, notes: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                       placeholder="Notes about the round (optional)"
                                       rows="2"
                                   />
                                   <div className="flex space-x-2">
                                       <button 
                                           onClick={handlePostScore}
                                           className="flex-1 bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition-all"
                                       >
                                           Post Score
                                       </button>
                                       <button 
                                           onClick={() => setShowScoreModal(false)}
                                           className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-all"
                                       >
                                           Cancel
                                       </button>
                                   </div>
                               </div>
                           </div>
                       </div>
                   )}

                   {showDayOffModal && (
                       <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                           <div className="bg-white rounded-xl p-6 w-full max-w-sm">
                               <h3 className="text-lg font-bold mb-4">Request Day Off</h3>
                               <div className="space-y-3">
                                   <input
                                       type="date"
                                       value={newDayOffRequest.date}
                                       onChange={(e) => setNewDayOffRequest({...newDayOffRequest, date: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                       min={new Date().toISOString().split('T')[0]}
                                   />
                                   <textarea
                                       value={newDayOffRequest.reason}
                                       onChange={(e) => setNewDayOffRequest({...newDayOffRequest, reason: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                       placeholder="Reason for day off"
                                       rows="3"
                                   />
                                   <div className="flex space-x-2">
                                       <button 
                                           onClick={handleDayOffRequest}
                                           className="flex-1 bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 transition-all"
                                       >
                                           Submit Request
                                       </button>
                                       <button 
                                           onClick={() => setShowDayOffModal(false)}
                                           className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-all"
                                       >
                                           Cancel
                                       </button>
                                   </div>
                               </div>
                           </div>
                       </div>
                   )}

                   {showBookingModal && selectedBooking && (
                       <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                           <div className="bg-white rounded-xl p-6 w-full max-w-md">
                               <h3 className="text-lg font-bold mb-4">Edit Booking - {selectedBooking.timeSlot} Tee {selectedBooking.teeSlot}</h3>
                               <div className="space-y-3">
                                   <input
                                       type="text"
                                       value={editingBooking.golfer}
                                       onChange={(e) => setEditingBooking({...editingBooking, golfer: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                       placeholder="Golfer name"
                                   />
                                   <select
                                       value={editingBooking.caddyId}
                                       onChange={(e) => setEditingBooking({...editingBooking, caddyId: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                   >
                                       <option value="">Select Caddy</option>
                                       {allCaddies.map(caddy => (
                                           <option key={caddy.id} value={caddy.id}>{caddy.name} (ID: {caddy.id})</option>
                                       ))}
                                   </select>
                                   <select
                                       value={editingBooking.course}
                                       onChange={(e) => setEditingBooking({...editingBooking, course: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                   >
                                       <option value="">Select Course</option>
                                       {courses.map(course => (
                                           <option key={course} value={course}>{course}</option>
                                       ))}
                                   </select>
                                   <select
                                       value={editingBooking.status}
                                       onChange={(e) => setEditingBooking({...editingBooking, status: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                   >
                                       <option value="confirmed">Confirmed</option>
                                       <option value="pending">Pending</option>
                                   </select>
                                   <textarea
                                       value={editingBooking.notes}
                                       onChange={(e) => setEditingBooking({...editingBooking, notes: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                       placeholder="Notes (e.g., VIP Guest)"
                                       rows="2"
                                   />
                                   <div className="flex space-x-2">
                                       <button 
                                           onClick={handleBookingUpdate}
                                           className="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-all"
                                       >
                                           Update
                                       </button>
                                       <button 
                                           onClick={handleBookingCancel}
                                           className="flex-1 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition-all"
                                       >
                                           Cancel Booking
                                       </button>
                                       <button 
                                           onClick={() => setShowBookingModal(false)}
                                           className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-all"
                                       >
                                           Close
                                       </button>
                                   </div>
                               </div>
                           </div>
                       </div>
                   )}

                   {showAnnouncementModal && (
                       <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                           <div className="bg-white rounded-xl p-6 w-full max-w-md">
                               <h3 className="text-lg font-bold mb-4">Create Announcement</h3>
                               <div className="space-y-3">
                                   <input
                                       type="text"
                                       value={newAnnouncement.title}
                                       onChange={(e) => setNewAnnouncement({...newAnnouncement, title: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                       placeholder="Announcement title"
                                   />
                                   <textarea
                                       value={newAnnouncement.message}
                                       onChange={(e) => setNewAnnouncement({...newAnnouncement, message: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                       placeholder="Announcement message"
                                       rows="4"
                                   />
                                   <select
                                       value={newAnnouncement.priority}
                                       onChange={(e) => setNewAnnouncement({...newAnnouncement, priority: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                   >
                                       <option value="Normal">Normal Priority</option>
                                       <option value="Important">Important</option>
                                       <option value="Urgent">Urgent</option>
                                   </select>
                                   <div className="flex space-x-2">
                                       <button 
                                           onClick={handleBroadcastAnnouncement}
                                           className="flex-1 bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600 transition-all"
                                       >
                                           Broadcast
                                       </button>
                                       <button 
                                           onClick={() => setShowAnnouncementModal(false)}
                                           className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-all"
                                       >
                                           Cancel
                                       </button>
                                   </div>
                               </div>
                           </div>
                       </div>
                   )}

                   {showBlockTimeModal && (
                       <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                           <div className="bg-white rounded-xl p-6 w-full max-w-md">
                               <h3 className="text-lg font-bold mb-4">Block Time Period</h3>
                               <div className="space-y-3">
                                   <div className="grid grid-cols-2 gap-2">
                                       <div>
                                           <label className="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                                           <select
                                               value={blockTimeData.startTime}
                                               onChange={(e) => setBlockTimeData({...blockTimeData, startTime: e.target.value})}
                                               className="w-full border rounded-lg p-3"
                                           >
                                               <option value="">Select start time</option>
                                               {timeSlots.slice(0, 30).map(time => (
                                                   <option key={time} value={time}>{time}</option>
                                               ))}
                                           </select>
                                       </div>
                                       <div>
                                           <label className="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                                           <select
                                               value={blockTimeData.endTime}
                                               onChange={(e) => setBlockTimeData({...blockTimeData, endTime: e.target.value})}
                                               className="w-full border rounded-lg p-3"
                                           >
                                               <option value="">Select end time</option>
                                               {timeSlots.slice(0, 30).map(time => (
                                                   <option key={time} value={time}>{time}</option>
                                               ))}
                                           </select>
                                       </div>
                                   </div>
                                   <textarea
                                       value={blockTimeData.reason}
                                       onChange={(e) => setBlockTimeData({...blockTimeData, reason: e.target.value})}
                                       className="w-full border rounded-lg p-3"
                                       placeholder="Reason for blocking (e.g., Maintenance, Tournament, VIP Event)"
                                       rows="3"
                                   />
                                   <div className="flex space-x-2">
                                       <button 
                                           onClick={handleBlockTime}
                                           disabled={!blockTimeData.startTime || !blockTimeData.endTime || !blockTimeData.reason}
                                           className={`flex-1 py-2 rounded-lg transition-all ${
                                               !blockTimeData.startTime || !blockTimeData.endTime || !blockTimeData.reason
                                                   ? 'bg-gray-400 cursor-not-allowed text-white'
                                                   : 'bg-red-500 hover:bg-red-600 text-white'
                                           }`}
                                       >
                                           Block Time
                                       </button>
                                       <button 
                                           onClick={() => setShowBlockTimeModal(false)}
                                           className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-all"
                                       >
                                           Cancel
                                       </button>
                                   </div>
                               </div>
                           </div>
                       </div>
                   )}
               </div>
           );
       }

       ReactDOM.render(React.createElement(MyCaddyPlatform), document.getElementById('root'));

// ---- mount (standalone) ----
const __root = document.getElementById('root');
if (__root) {
  const root = ReactDOM.createRoot(__root);
  if (typeof MyCaddyPlatform === 'function') {
    root.render(<MyCaddyPlatform />);
  } else if (typeof App === 'function') {
    root.render(<App />);
  } else {
    console.error('Mount failed: MyCaddyPlatform/App not found.');
  }
}

  </script>
<!-- ==== Games & Ryder Cup Mount Node (non-invasive) ==== -->
<div id="games-center-root" style="display:none;"></div>
<script>
(function(){
  // Prevent double-inject
  if (window.__GAMES_CENTER_INJECTED__) return;
  window.__GAMES_CENTER_INJECTED__ = true;

  // Utility: load script dynamically
  function loadScript(src){ 
    return new Promise(function(resolve, reject){
      var s = document.createElement('script');
      s.src = src; s.async = true; s.onload = resolve; s.onerror = reject;
      document.head.appendChild(s);
    });
  }

  // Ensure React & ReactDOM
  function ensureReact(){
    if (window.React && window.ReactDOM) return Promise.resolve();
    // Load UMD builds (no styling conflicts)
    var react = "https://unpkg.com/react@18/umd/react.production.min.js";
    var reactdom = "https://unpkg.com/react-dom@18/umd/react-dom.production.min.js";
    return loadScript(react).then(function(){ return loadScript(reactdom); });
  }

  // Minimal CSS for modal and floating button (scoped by data-gc attribute)
  var style = document.createElement('style');
  style.textContent = `[data-gc="gc"] .gc-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:2147483000}
[data-gc="gc"] .gc-card{background:#fff;border-radius:16px;max-width:1000px;width:92vw;max-height:86vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:20px}
[data-gc="gc"] .gc-row{display:flex;gap:16px;flex-wrap:wrap}
[data-gc="gc"] .gc-col{flex:1 1 280px;min-width:260px}
[data-gc="gc"] .gc-badge{display:inline-block;font-size:12px;padding:3px 8px;border-radius:999px;background:#eef1ff;color:#334; margin-left:8px}
[data-gc="gc"] .gc-chip{display:inline-block;font-size:12px;padding:3px 8px;border-radius:8px;background:#f5f5f5;margin:4px 6px}
[data-gc="gc"] .gc-btn{border:0;border-radius:999px;padding:10px 14px;cursor:pointer}
[data-gc="gc"] .gc-btn.primary{background:#1a73e8;color:#fff}
[data-gc="gc"] .gc-btn.ghost{background:#f2f6ff;color:#1a73e8}
[data-gc="gc"] .gc-title{font-size:20px;margin:0 0 8px 0}
[data-gc="gc"] .gc-sub{color:#555;margin:0 0 16px 0}
[data-gc="gc"] .gc-card-inner{border:1px solid #eee;border-radius:12px;padding:14px}
[data-gc="gc"] .gc-list{list-style:none;padding:0;margin:0}
[data-gc="gc"] .gc-list li{padding:6px 0;border-bottom:1px dashed #eee}
[data-gc="gc"] .gc-footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:8px;flex-wrap:wrap}
[data-gc="gc"] .gc-floating{position:fixed;right:20px;bottom:20px;z-index:2147483001}
[data-gc="gc"] .gc-floating .gc-btn{box-shadow:0 4px 16px rgba(0,0,0,.2)}
[data-gc="gc"] .gc-input, [data-gc="gc"] select{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px}
[data-gc="gc"] .gc-h3{font-size:16px;margin:8px 0}
[data-gc="gc"] .gc-table{width:100%;border-collapse:collapse}
[data-gc="gc"] .gc-table th, [data-gc="gc"] .gc-table td{border-bottom:1px solid #eee;padding:8px;text-align:left}
`;
  document.head.appendChild(style);

  // Game catalog (preloaded)
  var GAME_CATALOG = [
    {id:"nassau",name:"Nassau",category:"Money Game",players:"2–4",summary:"Three separate wagers: front 9, back 9, total 18.",rules:[
      "Set wager amounts for front/back/overall",
      "Best-ball or individual match play",
      "Half on ties or press as agreed"
    ]},
    {id:"skins",name:"Skins",category:"Money Game",players:"2–4",summary:"Each hole is a skin; ties carry over.",rules:[
      "Set value per skin",
      "Lowest score wins the skin",
      "Ties carry to next hole (optional multiplier)"
    ]},
    {id:"bbb",name:"Bingo Bango Bongo",category:"Money Game",players:"2–4",summary:"Points: first on green, closest to pin, first to hole out.",rules:[
      "Equalize turn order (furthest plays first)",
      "Award 1 point each: Bingo/Bango/Bongo",
      "Convert points to payouts at end"
    ]},
    {id:"wolf",name:"Wolf",category:"Money Game",players:"4",summary:"Rotating wolf chooses partner or goes solo.",rules:[
      "Rotate wolf each hole",
      "Wolf can pick partner after seeing drives",
      "Lone Wolf pays/earns double"
    ]},
    {id:"hammer",name:"Hammer",category:"Money Game",players:"2–4",summary:"Double the stakes mid-hole (‘Hammer!’).",rules:[
      "Either side can hammer before next shot",
      "Accept doubles stakes; decline concedes hole",
      "Re‑hammers allowed if agreed"
    ]},
    {id:"snake",name:"Snake",category:"Money Game",players:"2–4",summary:"Pot grows on every three‑putt; last 3‑putter pays.",rules:[
      "Track 3‑putts; add set amount to pot",
      "Last 3‑putter at 18 pays each opponent",
      "No gimmes unless agreed"
    ]},
    {id:"rabbit",name:"Rabbit",category:"Money Game",players:"2–4",summary:"Win a hole to capture the Rabbit; finish holding it.",rules:[
      "First hole winner captures Rabbit",
      "Next winner steals Rabbit",
      "Holder on 18 wins pot"
    ]},
    {id:"vegas",name:"Vegas (Las Vegas)",category:"Money Game",players:"4 (2v2)",summary:"Team scores combine into a two‑digit number.",rules:[
      "Lower individual score goes first digit (e.g., 4 & 5 ⇒ 45)",
      "Difference settles the bet",
      "Birdies/Eagles multipliers optional"
    ]},
    {id:"dots",name:"Dots (Garbage)",category:"Money Game",players:"2–4",summary:"Points for achievements; penalties for mistakes.",rules:[
      "Award dots for birdie, par, GIR, etc.",
      "Subtract for 3‑putt, bunker, water",
      "Set value per dot for payouts"
    ]},
    {id:"ridingtime",name:"Riding Time",category:"Add‑On",players:"2–4",summary:"Bet on keeping honors (teeing first).",rules:[
      "Award unit value for each hole honors kept",
      "Reset when honors change hands"
    ]},
    {id:"nines",name:"9‑Point Game (Nines)",category:"Money Game",players:"3",summary:"9 points per hole distributed by finishing order.",rules:[
      "Winner 5, runner‑up 3, last 1 (or variants)",
      "Ties split points accordingly"
    ]},
    {id:"sixes",name:"Sixes (6‑6‑6)",category:"Money Game",players:"4",summary:"Rotate partners every 6 holes.",rules:[
      "Set three mini‑matches: 1–6, 7–12, 13–18",
      "Score each segment separately"
    ]},
    {id:"acey",name:"Acey‑Deucey",category:"Money Game",players:"4",summary:"Low score wins from all; high score pays all.",rules:[
      "Ace wins are typically double deuce losses",
      "Net or gross per agreement"
    ]},
    {id:"criers",name:"Criers & Whiners",category:"Fun / Handicap",players:"2–4",summary:"Mulligan allotments act as ‘cries’.",rules:[
      "Allot mulligans based on handicap",
      "Use anywhere except on greens (house rule)"
    ]},
    // Ryder Cup Formats
    {id:"rc_foursomes",name:"Foursomes (Alternate Shot)",category:"Ryder Cup",players:"4 (2v2)",summary:"Teammates play one ball, alternate shots.",rules:[
      "One player tees odd holes, partner tees even",
      "Alternate until holed; match play scoring"
    ]},
    {id:"rc_fourball",name:"Fourball (Better Ball)",category:"Ryder Cup",players:"4 (2v2)",summary:"Each plays own ball; team’s better score counts.",rules:[
      "Low score of partners wins the hole",
      "Match play; halves for ties"
    ]},
    {id:"rc_singles",name:"Singles",category:"Ryder Cup",players:"2 (1v1)",summary:"Head‑to‑head match play.",rules:[
      "Each hole won/halved/lost",
      "Match worth 1 point; halves 0.5 each"
    ]}
  ];

  // Local storage helpers
  var LS_KEY_CONFIG = "games.config.v1";
  var LS_KEY_RYDER = "games.ryder.v1";
  function loadLS(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) || fallback; }catch(e){ return fallback; } }
  function saveLS(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

  function bootstrap(){
    var React = window.React, ReactDOM = window.ReactDOM;
    var e = React.createElement;

    // Mount container
    var host = document.getElementById("games-center-root");
    if (!host){ host = document.createElement("div"); host.id="games-center-root"; document.body.appendChild(host); }

    // Floating launcher button (non-invasive)
    var floating = document.createElement("div");
    floating.setAttribute("data-gc","gc");
    floating.className = "gc-floating";
    floating.innerHTML = '<button class="gc-btn primary" id="gc-open">Games & Ryder Cup</button>';
    document.body.appendChild(floating);
    var openBtn = floating.querySelector("#gc-open");
    openBtn.addEventListener("click", function(){
      host.style.display = "block";
      renderApp();
    });

    // Optional: append a tab if we detect an existing tabs container
    try{
      var tabs = document.querySelector("#mainTabs, [data-role='tabs']");
      if (tabs && !tabs.querySelector('[data-gc-tab="games"]')){
        var li = document.createElement("div");
        li.setAttribute("data-gc-tab","games");
        li.style.cursor="pointer";
        li.style.padding="6px 10px";
        li.style.borderRadius="8px";
        li.style.marginLeft="6px";
        li.textContent = "Games";
        li.addEventListener("click", function(){
          host.style.display = "block"; renderApp();
          // Simple active state
          li.style.background = "#eef1ff";
        });
        tabs.appendChild(li);
      }
    }catch(err){ /* ignore */ }

    // React components
    function useState(init){ return React.useState(init); }
    function useEffect(fn, deps){ return React.useEffect(fn, deps); }

    function SectionHeader(props){
      return e("div", {style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,flexWrap:"wrap"}},
        e("h2",{className:"gc-title"}, props.title, props.badge? e("span",{className:"gc-badge"}, props.badge):null),
        e("div",null, props.children)
      );
    }

    function GameCard({game, onConfigure}){
      return e("div",{className:"gc-card-inner gc-col"},
        e("div",null,
          e("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},
            e("h3",{className:"gc-h3"}, game.name),
            e("span",{className:"gc-chip"}, game.category)
          ),
          e("p",{className:"gc-sub"}, game.summary),
          e("ul",{className:"gc-list"}, game.rules.map(function(r,i){ return e("li",{key:i}, "• "+r); })),
          e("div",{className:"gc-footer"},
            e("span", null, "Players: "+game.players),
            e("div",null,
              e("button",{className:"gc-btn ghost", onClick:function(){onConfigure(game);} },"Configure")
            )
          )
        )
      );
    }

    function ConfigureModal({game, onClose}){
      var [stake, setStake] = useState("100");
      var [players, setPlayers] = useState("");
      var [notes, setNotes] = useState("");
      function save(){
        var cfg = loadLS(LS_KEY_CONFIG, {});
        cfg[game.id] = {stake:stake, players:players, notes:notes, updated: Date.now()};
        saveLS(LS_KEY_CONFIG, cfg);
        onClose();
        alert(game.name+" saved!");
      }
      return e("div",{"data-gc":"gc", className:"gc-modal-backdrop"},
        e("div",{className:"gc-card"},
          e(SectionHeader,{title:"Configure "+game.name, badge:game.category},
            e("button",{className:"gc-btn", onClick:onClose},"Close")
          ),
          e("div",{className:"gc-row"},
            e("div",{className:"gc-col"},
              e("label",null,"Stake / Unit Value"),
              e("input",{className:"gc-input", value:stake, onChange:function(ev){setStake(ev.target.value);}, placeholder:"e.g., 100"}),
              e("div",{style:{height:10}}),
              e("label",null,"Players / Teams (comma separated)"),
              e("input",{className:"gc-input", value:players, onChange:function(ev){setPlayers(ev.target.value);}, placeholder:"Alice,Bob,Chen,Dee"}),
              e("div",{style:{height:10}}),
              e("label",null,"Notes / House Rules"),
              e("textarea",{className:"gc-input", rows:4, value:notes, onChange:function(ev){setNotes(ev.target.value);}, placeholder:"Any variations, presses, carry rules…"})
            ),
            e("div",{className:"gc-col"},
              e("div",{className:"gc-card-inner"},
                e("h4",{className:"gc-h3"},"Quick Rules"),
                e("ul",{className:"gc-list"}, game.rules.map(function(r,i){ return e("li",{key:i}, r); }))
              )
            )
          ),
          e("div",{className:"gc-footer"},
            e("div",null, e("span",{className:"gc-chip"},"Players: "+game.players)),
            e("div",null,
              e("button",{className:"gc-btn", onClick:onClose},"Cancel"),
              e("button",{className:"gc-btn primary", onClick:save, style:{marginLeft:8}},"Save")
            )
          )
        )
      );
    }

    function RyderCupSetup({onClose}){
      var [teamA, setTeamA] = useState("Team USA");
      var [teamB, setTeamB] = useState("Team Europe");
      var [session, setSession] = useState("rc_fourball");
      var [rosterA, setRosterA] = useState("");
      var [rosterB, setRosterB] = useState("");
      var [pointsA, setPointsA] = useState(0);
      var [pointsB, setPointsB] = useState(0);
      function save(){
        var data = {teamA, teamB, session, rosterA, rosterB, pointsA, pointsB, updated: Date.now()};
        saveLS(LS_KEY_RYDER, data);
        onClose();
        alert("Ryder Cup session saved!");
      }
      return e("div",{"data-gc":"gc", className:"gc-modal-backdrop"},
        e("div",{className:"gc-card"},
          e(SectionHeader,{title:"Ryder Cup Session Setup", badge:"Ryder Cup"},
            e("button",{className:"gc-btn", onClick:onClose},"Close")
          ),
          e("div",{className:"gc-row"},
            e("div",{className:"gc-col"},
              e("label",null,"Team A Name"),
              e("input",{className:"gc-input", value:teamA, onChange:function(ev){setTeamA(ev.target.value);}}),
              e("div",{style:{height:10}}),
              e("label",null,"Team B Name"),
              e("input",{className:"gc-input", value:teamB, onChange:function(ev){setTeamB(ev.target.value);}}),
              e("div",{style:{height:10}}),
              e("label",null,"Session Format"),
              e("select",{value:session, onChange:function(ev){setSession(ev.target.value)}}, 
                e("option",{value:"rc_foursomes"},"Foursomes (Alternate Shot)"),
                e("option",{value:"rc_fourball"},"Fourball (Better Ball)"),
                e("option",{value:"rc_singles"},"Singles")
              ),
              e("div",{style:{height:10}}),
              e("label",null,"Team A Roster (comma separated)"),
              e("textarea",{className:"gc-input", rows:3, value:rosterA, onChange:function(ev){setRosterA(ev.target.value);}}),
              e("div",{style:{height:10}}),
              e("label",null,"Team B Roster (comma separated)"),
              e("textarea",{className:"gc-input", rows:3, value:rosterB, onChange:function(ev){setRosterB(ev.target.value);}})
            ),
            e("div",{className:"gc-col"},
              e("div",{className:"gc-card-inner"},
                e("h4",{className:"gc-h3"},"Live Points"),
                e("table",{className:"gc-table"},
                  e("thead",null, e("tr",null, e("th",null, "Team"), e("th",null,"Points"))),
                  e("tbody",null,
                    e("tr",null, e("td",null, teamA), e("td",null, pointsA)),
                    e("tr",null, e("td",null, teamB), e("td",null, pointsB))
                  )
                ),
                e("div",{style:{marginTop:8, display:"flex", gap:8}},
                  e("button",{className:"gc-btn", onClick:function(){setPointsA(pointsA+0.5)}}, "+0.5 A"),
                  e("button",{className:"gc-btn", onClick:function(){setPointsB(pointsB+0.5)}}, "+0.5 B"),
                  e("button",{className:"gc-btn ghost", onClick:function(){setPointsA(0);setPointsB(0);}}, "Reset")
                )
              )
            )
          ),
          e("div",{className:"gc-footer"},
            e("div",null, e("span",{className:"gc-chip"}, "Session: "+ (GAME_CATALOG.find(g=>g.id===session)||{}).name)),
            e("div",null,
              e("button",{className:"gc-btn", onClick:onClose},"Cancel"),
              e("button",{className:"gc-btn primary", onClick:save, style:{marginLeft:8}},"Save")
            )
          )
        )
      );
    }

    function GamesCenter(){
      var [filter, setFilter] = useState("All");
      var [modalGame, setModalGame] = useState(null);
      var [showRyder, setShowRyder] = useState(false);
      var cats = ["All","Money Game","Add‑On","Fun / Handicap","Ryder Cup"];
      var catList = cats.map(function(c){ return e("option",{key:c,value:c},c); });

      var games = GAME_CATALOG.filter(function(g){
        return filter==="All" || g.category===filter;
      });

      return e("div",{"data-gc":"gc", className:"gc-modal-backdrop", onClick:function(ev){
        if (ev.target === ev.currentTarget){ // backdrop click to close
          document.getElementById("games-center-root").style.display="none";
        }
      }},
        e("div",{className:"gc-card", onClick:function(ev){ev.stopPropagation();}},
          e(SectionHeader,{title:"Games & Ryder Cup", badge:"Non‑invasive"},
            e("div",null,
              e("button",{className:"gc-btn", onClick:function(){document.getElementById('games-center-root').style.display='none';}},"Close"),
              e("button",{className:"gc-btn primary", style:{marginLeft:8}, onClick:function(){setShowRyder(true);}},"Ryder Cup Setup")
            )
          ),
          e("div",{className:"gc-row"},
            e("div",{className:"gc-col"},
              e("label",null,"Filter by category"),
              e("select",{onChange:function(ev){setFilter(ev.target.value);}}, catList),
              e("div",{style:{height:10}}),
              e("div",{className:"gc-card-inner"},
                e("h4",{className:"gc-h3"},"Saved Configs"),
                (function(){
                  var cfg = loadLS(LS_KEY_CONFIG, {});
                  var keys = Object.keys(cfg);
                  if (!keys.length) return e("div",{className:"gc-sub"},"No saved game configs yet.");
                  return e("ul",{className:"gc-list"}, keys.map(function(k){
                    var g = GAME_CATALOG.find(function(x){return x.id===k;});
                    var v = cfg[k];
                    var label = (g? g.name: k) + " – stake " + v.stake;
                    return e("li",{key:k}, label);
                  }));
                })()
              ),
              e("div",{style:{height:10}}),
              e("div",{className:"gc-card-inner"},
                e("h4",{className:"gc-h3"},"Ryder Cup Saved Session"),
                (function(){
                  var r = loadLS(LS_KEY_RYDER, null);
                  if (!r) return e("div",{className:"gc-sub"},"No session saved.");
                  return e("div",null,
                    e("div",null, e("strong",null, r.teamA), " vs ", e("strong",null, r.teamB)),
                    e("div",{className:"gc-sub"},"Format: "+ (GAME_CATALOG.find(g=>g.id===r.session)||{}).name),
                    e("div",null, "Points — ", r.teamA, ": ", r.pointsA, " | ", r.teamB, ": ", r.pointsB)
                  );
                })()
              )
            ),
            e("div",{className:"gc-col", style:{flex:"2 1 520px"}},
              e("div",{className:"gc-row"},
                games.map(function(game){ return e(GameCard,{key:game.id, game:game, onConfigure:function(g){setModalGame(g);}}); })
              )
            )
          ),
          e("div",{className:"gc-footer"},
            e("div",null, e("span",{className:"gc-chip"},"Non‑destructive integration")),
            e("div",null, e("span",{className:"gc-sub"},"All data saved locally (v1)"))
          )
        ),
        modalGame ? e(ConfigureModal,{game:modalGame, onClose:function(){setModalGame(null);}}) : null,
        showRyder ? e(RyderCupSetup,{onClose:function(){setShowRyder(false);}}) : null
      );
    }

    function renderApp(){
      ReactDOM.createRoot(document.getElementById("games-center-root")).render(React.createElement(GamesCenter));
    }

    // If React available, render immediately when opened; otherwise ensureReact then render.
    ensureReact().then(function(){
      // No auto-open to remain non-invasive
    }).catch(function(err){
      console.error("Failed to load React for Games Center", err);
    });
  }

  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", bootstrap);
  } else {
    bootstrap();
  }
})();
</script>
<!-- End Games & Ryder Cup Injection -->
<!-- === Inject: vGAMES-01 per-event game persistence & runner === -->
<script>
(function(){
  if(window.__games_v01) return; window.__games_v01 = true;

  function keyForEvent(eid){ return 'uc2:game:'+String(eid||''); }
  function readGame(eid){ try{ return localStorage.getItem(keyForEvent(eid)) || ''; }catch(_){ return ''; } }
  function writeGame(eid,val){ try{ localStorage.setItem(keyForEvent(eid), String(val||'')); }catch(_){ } }

  // Attach to forms that have an event id encoded in their id attribute, format soc2_form_<eid>
  function wireForms(root){
    var forms = (root||document).querySelectorAll('form[id^="soc2_form_"]');
    forms.forEach(function(form){
      var m = form.id.match(/^soc2_form_(.+)$/);
      if(!m) return;
      var eid = m[1];
      var sel = form.querySelector('select[name="game"], [data-game-select="1"]');
      if(!sel) return;

      // Load saved value
      var saved = readGame(eid);
      if(saved){
        try{
          sel.value = saved;
          sel.dispatchEvent(new Event('change', { bubbles: true }));
        }catch(_){}
      }

      // On change, store
      sel.addEventListener('change', function(){
        writeGame(eid, sel.value);
        // optional: mark UI
        var badge = form.querySelector('.gameSavedBadge');
        if(badge){ badge.textContent = 'Saved: ' + (sel.value||''); }
      });
    });
  }

  // Observe DOM mutations to wire future forms
  var mo = new MutationObserver(function(muts){
    muts.forEach(function(m){
      m.addedNodes && m.addedNodes.forEach(function(n){
        if(n.nodeType===1) wireForms(n);
      });
    });
  });
  mo.observe(document.documentElement, { childList:true, subtree:true });
  wireForms(document);

  // Provide a simple 'runner' hook so games can start when saved/selected.
  // When a game is selected, we dispatch a 'games:run' event with eventId and gameType.
  document.addEventListener('change', function(e){
    var sel = e.target;
    if(!sel) return;
    if(sel.matches('select[name="game"], [data-game-select="1"]')){
      var form = sel.closest('form[id^="soc2_form_"]');
      if(!form) return;
      var m = form.id.match(/^soc2_form_(.+)$/);
      if(!m) return;
      var eid = m[1];
      var game = sel.value || '';
      try{
        window.dispatchEvent(new CustomEvent('games:run', { detail: { eventId: eid, gameType: game } }));
      }catch(_){}
    }
  });

  // Example basic runners for common game types.
  // Integrators can listen to 'games:run' and drive scorecards, skins pots, etc.
  window.addEventListener('games:run', function(ev){
    var d = (ev && ev.detail) || {};
    if(!d.gameType) return;
    // Minimal "it's running" indicator (non-intrusive)
    var id = 'game-run-indicator-'+d.eventId;
    var el = document.getElementById(id);
    if(!el){
      el = document.createElement('div');
      el.id = id;
      el.style.cssText = 'position:fixed;bottom:14px;left:14px;background:#111827;color:#fff;padding:6px 10px;border-radius:10px;font-size:12px;box-shadow:0 8px 20px rgba(0,0,0,.18);z-index:2147483555;opacity:.92';
      document.body.appendChild(el);
    }
    el.textContent = 'Game: '+d.gameType+' • Event '+d.eventId+' running';
    clearTimeout(el.__hideT);
    el.__hideT = setTimeout(function(){ try{ el.remove(); }catch(_){ el.style.display='none'; } }, 2500);
  });

})();
</script>
<!-- === Inject: vGAMES-02 tab plugin (non-invasive) === -->
<script>
(function(){
  if(window.__games_tab_v02) return; window.__games_tab_v02 = true;

  // Attempt to locate an existing tab header that contains Events; if a Games tab doesn't exist, add one after it.
  function ensureTab(){
    var navs = Array.from(document.querySelectorAll('nav, [role="tablist"], .tabs, .tab-list, .menu')).filter(function(n){
      return /events/i.test(n.textContent||'') && /tee|budget|message|report/i.test(n.textContent||'');
    });
    if(!navs.length) return;
    var nav = navs[0];
    var hasGames = /games/i.test(nav.textContent||'');
    if(!hasGames){
      // Create a Games button that toggles a panel with id 'panel-games-v02'
      var btn = document.createElement('button');
      btn.textContent = 'Games';
      btn.setAttribute('data-games-tab','1');
      btn.style.marginLeft = '6px';
      btn.className = 'px-3 py-1 border rounded-lg text-sm';
      // Insert after the Events button if found
      var evBtn = Array.from(nav.querySelectorAll('button,a,li,span')).find(function(b){ return /events?/i.test((b.textContent||'').trim()); });
      if(evBtn && evBtn.parentElement){
        evBtn.parentElement.insertBefore(btn, evBtn.nextSibling);
      }else{
        nav.appendChild(btn);
      }

      btn.addEventListener('click', function(){
        showPanel();
      });
    }
  }

  function showPanel(){
    // Hide other major panels (best-effort)
    var panels = Array.from(document.querySelectorAll('[data-panel], [role="tabpanel"], section, main'));
    // We'll avoid touching anything; instead, append our own floating panel
    var id='panel-games-v02';
    var ex = document.getElementById(id);
    if(!ex){
      ex = document.createElement('div');
      ex.id = id;
      ex.style.cssText = 'position:fixed; top:80px; right:20px; bottom:20px; left:20px; background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 20px 40px rgba(0,0,0,.15); z-index:2147483601; display:flex; flex-direction:column;';
      ex.innerHTML = ''
        + '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;border-top-left-radius:14px;border-top-right-radius:14px">'
        +   '<div><strong>Games</strong> <span style="font-size:12px;opacity:.8">Select a game per event</span></div>'
        +   '<div><button id="close-games-v02" class="px-3 py-1 border rounded-lg text-sm">Close</button></div>'
        + '</div>'
        + '<div id="games-body-v02" style="padding:12px; overflow:auto; flex:1; display:grid; gap:10px;"></div>';
      document.body.appendChild(ex);
      document.getElementById('close-games-v02').addEventListener('click', function(){ ex.remove(); });
      renderBody();
    }
  }

  function readGame(eid){ try{ return localStorage.getItem('uc2:game:'+eid) || ''; }catch(_){ return ''; } }
  function writeGame(eid,val){ try{ localStorage.setItem('uc2:game:'+eid, String(val||'')); }catch(_){ } }

  function renderBody(){
    var body = document.getElementById('games-body-v02');
    if(!body) return;
    body.innerHTML = '';

    // Try to pull events from a global React prop exposed in the DOM (best-effort scraping from cards rendered by SocietySection)
    var cards = Array.from(document.querySelectorAll('form[id^="soc2_form_"]')).map(function(f){
      var eid = f.id.replace('soc2_form_', '');
      // Extract event header text near this form
      var titleEl = f.closest('div') && f.closest('div').previousElementSibling;
      var title = (titleEl && titleEl.textContent || '').split('•')[0].trim() || ('Event '+eid);
      return { id:eid, title:title };
    });

    if(!cards.length){
      var msg = document.createElement('div');
      msg.textContent = 'No events detected yet. Open the Events section first.';
      msg.style.cssText = 'padding:10px; border:1px dashed #e5e7eb; border-radius:12px; background:#fafafa;';
      body.appendChild(msg);
      return;
    }

    cards.forEach(function(ev){
      var row = document.createElement('div');
      row.style.cssText = 'border:1px solid #e5e7eb; border-radius:12px; padding:10px; display:flex; justify-content:space-between; align-items:center;';
      var left = document.createElement('div');
      left.innerHTML = '<div style="font-weight:600">'+ev.title+'</div><div style="font-size:12px; opacity:.7">ID '+ev.id+'</div>';
      var right = document.createElement('div');
      var sel = document.createElement('select');
      sel.setAttribute('data-game-select','1');
      sel.innerHTML = '<option value="">— Select game —</option>'
        + '<option value="Stroke Play">Stroke Play</option>'
        + '<option value="Stableford">Stableford</option>'
        + '<option value="Skins">Skins</option>'
        + '<option value="Best Ball">Best Ball</option>'
        + '<option value="Texas Scramble">Texas Scramble</option>';

      var saved = readGame(ev.id);
      if(saved) sel.value = (saved==='Scramble'?'Texas Scramble':saved);
      sel.addEventListener('change', function(){
        writeGame(ev.id, sel.value);
        try{ window.dispatchEvent(new CustomEvent('games:run', { detail: { eventId: ev.id, gameType: sel.value } })); }catch(_){}
      });

      right.appendChild(sel);
      row.appendChild(left);
      row.appendChild(right);
      body.appendChild(row);
    });
  }

  // Try to insert the tab soon after load
  function boot(){ try{ ensureTab(); }catch(_){ } }
  if (document.readyState !== 'loading') boot();
  document.addEventListener('DOMContentLoaded', boot);
  setTimeout(boot, 800);
  setInterval(boot, 2500);
})();
</script>
<!-- === Inject: vGAMES-03 form augmenter === -->
<script>
(function(){
  if(window.__games_form_aug_v03) return; window.__games_form_aug_v03 = true;

  var OPTIONS = ['','Stroke Play','Stableford','Skins','Best Ball','Texas Scramble'];

  function ensureGameField(form){
    if(!form) return;
    if(form.querySelector('select[name="game"], [data-game-select="1"]')) return;
    // Find a place near "Options" or Pairing section
    var anchor = Array.from(form.querySelectorAll('div,fieldset,section')).find(function(d){
      return /Options/i.test(d.textContent||'') || /Pairing Preferences/i.test(d.textContent||'');
    }) || form;

    var wrap = document.createElement('div');
    wrap.className = 'mt-2';
    wrap.innerHTML = '<div class="text-sm font-medium">Game</div>';
    var sel = document.createElement('select');
    sel.name = 'game';
    sel.className = 'mt-1 border rounded p-2 text-sm';
    OPTIONS.forEach(function(opt){
      var o=document.createElement('option'); o.value=opt; o.textContent = opt || '— Select game —'; sel.appendChild(o);
    });
    wrap.appendChild(sel);
    anchor.parentNode.insertBefore(wrap, anchor.nextSibling);

    // If we can infer event id, load saved
    var m = form.id && form.id.match(/^soc2_form_(.+)$/);
    if(m){
      var eid = m[1];
      try{
        var saved = localStorage.getItem('uc2:game:'+eid) || '';
        if(saved){ sel.value = saved; sel.dispatchEvent(new Event('change', { bubbles: true })); }
      }catch(_){}
      sel.addEventListener('change', function(){
        try{ localStorage.setItem('uc2:game:'+eid, String(sel.value||'')); }catch(_){}
        try{ window.dispatchEvent(new CustomEvent('games:run', { detail: { eventId: eid, gameType: sel.value } })); }catch(_){}
      });
    }
  }

  function scan(root){
    var forms = (root||document).querySelectorAll('form[id^="soc2_form_"]');
    forms.forEach(ensureGameField);
  }

  var mo=new MutationObserver(function(muts){
    muts.forEach(function(m){
      m.addedNodes && m.addedNodes.forEach(function(n){ if(n.nodeType===1) scan(n); });
    });
  });
  mo.observe(document.documentElement, { childList:true, subtree:true });
  scan(document);
})();
</script>
<!-- === Inject: vGAMES-02A header-nav anchoring === -->
<script>
(function(){
  if(window.__games_header_anchor_v02a) return; window.__games_header_anchor_v02a = true;

  function insertInHeader(){
    // Find a top nav that has Dashboard, Schedule, Society, Scores, Leaderboard
    var navs = Array.from(document.querySelectorAll('nav, header, .topnav, .tabbar, [role="tablist"]'));
    var best = navs.find(function(n){
      var t = (n.textContent||'').toLowerCase();
      return t.includes('dashboard') && t.includes('schedule') && t.includes('society') && t.includes('scores') && t.includes('leaderboard');
    });
    if(!best) return;

    // If already present, stop
    if(/games/i.test(best.textContent||'')) return;

    // Locate the Scores or Leaderboard anchor to place Games in-between
    var scoresEl = Array.from(best.querySelectorAll('a,button,li,span,div')).find(function(el){
      return /scores/i.test((el.textContent||'').trim());
    });
    var leaderEl = Array.from(best.querySelectorAll('a,button,li,span,div')).find(function(el){
      return /leaderboard/i.test((el.textContent||'').trim());
    });

    // Create button
    var btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = 'Games';
    btn.className = (scoresEl && scoresEl.className) ? scoresEl.className : 'px-3 py-2 rounded-md text-sm';
    btn.setAttribute('data-games-tab','1');
    btn.addEventListener('click', function(e){
      e.preventDefault();
      try{
        // reuse the existing v02 panel
        var show = new Event('click');
        // If our prior plugin created a button, trigger it; else, just open panel directly
        var priorBtn = document.querySelector('button[data-games-tab="1"]:not([data-header-clone])');
        if(priorBtn && priorBtn !== btn){ priorBtn.dispatchEvent(show); }
        else {
          // open the panel directly
          var ev = new CustomEvent('open-games-panel-v02');
          window.dispatchEvent(ev);
        }
      }catch(_){}
    });

    // Insert between Scores and Leaderboard (after Scores)
    if(scoresEl && scoresEl.parentElement){
      btn.setAttribute('data-header-clone','1');
      scoresEl.parentElement.insertBefore(btn, leaderEl || scoresEl.nextSibling);
    } else {
      best.appendChild(btn);
    }
  }

  // If v02 panel isn't opening itself, listen for our custom event and force-create it
  window.addEventListener('open-games-panel-v02', function(){
    var id='panel-games-v02';
    if(document.getElementById(id)) return;
    // minimal fallback: create panel shell so v02 runner can populate when events appear
    var ex = document.createElement('div');
    ex.id = id;
    ex.style.cssText = 'position:fixed; top:80px; right:20px; bottom:20px; left:20px; background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 20px 40px rgba(0,0,0,.15); z-index:2147483601; display:flex; flex-direction:column;';
    ex.innerHTML = ''
      + '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;border-top-left-radius:14px;border-top-right-radius:14px">'
      +   '<div><strong>Games</strong> <span style="font-size:12px;opacity:.8">Select a game per event</span></div>'
      +   '<div><button id="close-games-v02" class="px-3 py-1 border rounded-lg text-sm">Close</button></div>'
      + '</div>'
      + '<div id="games-body-v02" style="padding:12px; overflow:auto; flex:1; display:grid; gap:10px;">'
      +   '<div style="padding:10px; border:1px dashed #e5e7eb; border-radius:12px; background:#fafafa;">Open the Events section to detect event forms and manage games.</div>'
      + '</div>';
    document.body.appendChild(ex);
    var closeBtn = document.getElementById('close-games-v02');
    if(closeBtn){ closeBtn.addEventListener('click', function(){ ex.remove(); }); }
  });

  function boot(){ insertInHeader(); }
  if (document.readyState !== 'loading') boot();
  document.addEventListener('DOMContentLoaded', boot);
  setTimeout(boot, 600);
  setInterval(boot, 2000);
})();
</script>
<script>
/* LIVE_ENHANCED_SIM_START */
(function(){
  var BASE_MS = 5000; // 1x = 5s
  function ensure(){
    var host = document.getElementById('live-center-root');
    if (!host || host.dataset.enhanced) return;
    host.dataset.enhanced = '1';
    host.innerHTML = ''
      + '<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-2 mb-2">'
      +   '<div class="flex flex-wrap items-center gap-2">'
      +     '<label class="text-xs text-gray-600">Event</label>'
      +     '<select id="fEvent" class="border rounded px-2 py-1 text-sm"><option>All</option><option>Event A</option><option>Event B</option></select>'
      +     '<label class="text-xs text-gray-600">Flight</label>'
      +     '<select id="fFlight" class="border rounded px-2 py-1 text-sm"><option>All</option><option>A</option><option>B</option><option>C</option><option>D</option></select>'
      +     '<label class="text-xs text-gray-600">Tee Time</label>'
      +     '<select id="fTime" class="border rounded px-2 py-1 text-sm"><option>All</option></select>'
      +     '<input id="fSearch" class="border rounded px-2 py-1 text-sm" placeholder="Search golfer..." />'
      +   '</div>'
      +   '<div class="flex items-center gap-2">'
      +     '<div class="text-xs text-gray-600">Speed</div>'
      +     '<div class="inline-flex rounded-lg border overflow-hidden">'
      +       '<button id="spd1" class="px-2 py-1 text-sm bg-white">1x</button>'
      +       '<button id="spd2" class="px-2 py-1 text-sm bg-white">2x</button>'
      +       '<button id="spd4" class="px-2 py-1 text-sm bg-white">4x</button>'
      +     '</div>'
      +     '<button id="btnPause" class="px-2 py-1 text-sm rounded border">Pause</button>'
      +     '<button id="btnReset" class="px-2 py-1 text-sm rounded border">Reset</button>'
      +   '</div>'
      + '</div>'
      + '<div class="grid grid-cols-1 lg:grid-cols-2 gap-3">'
      +   '<div class="border rounded-lg p-3">'
      +     '<div class="flex items-center justify-between mb-2">'
      +       '<div><div class="text-sm font-semibold">Event A — Pattaya Open (Today)</div><div class="text-xs text-gray-500">Stroke Play • Front/Back Totals</div></div>'
      +       '<span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">LIVE</span>'
      +     '</div>'
      +     '<table class="w-full text-sm"><thead><tr class="text-gray-500"><th class="text-left py-1">Pos</th><th class="text-left">Golfer</th><th class="text-right">Thru</th><th class="text-right">To Par</th></tr></thead><tbody id="evA"></tbody></table>'
      +   '</div>'
      +   '<div class="border rounded-lg p-3">'
      +     '<div class="flex items-center justify-between mb-2">'
      +       '<div><div class="text-sm font-semibold">Event B — Society Stableford (Today)</div><div class="text-xs text-gray-500">Stableford • Mixed Groups</div></div>'
      +       '<span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">LIVE</span>'
      +     '</div>'
      +     '<table class="w-full text-sm"><thead><tr class="text-gray-500"><th class="text-left py-1">Pos</th><th class="text-left">Golfer</th><th class="text-right">Thru</th><th class="text-right">Pts</th></tr></thead><tbody id="evB"></tbody></table>'
      +   '</div>'
      + '</div>';

    function time(i){ var h=8+Math.floor(i/4), m=(i%4)*10; return (''+h).padStart(2,'0')+':'+(m<10?('0'+m):m); }
    var A=[],B=[], teeTimesA=[], teeTimesB=[];
    (function seed(){
      var namesA = ['J. Carter','P. Niran','M. Lee','A. Gomez','K. Watan','S. Patel','R. Ortiz','L. Brown','D. Chen','F. Ahmad','Y. Tanaka','H. Park','C. Smith','T. Jones','I. Novak','G. Silva','B. Singh','E. Rossi','O. Diaz','V. Kumar'];
      var namesB = ['S. Kiet','R. Singh','B. Chan','D. Park','M. Lopez','W. Zhang','P. Anand','C. Wilson','K. O’Brien','N. Garcia','H. Nguyen','L. Martin','A. Kim','T. Evans','G. Baker','S. Ali','R. Young','E. Cruz','P. Silva','O. Petrov'];
      var flights = ['A','B','C','D'];
      A = namesA.map((n,i)=>({name:n, thru: (i%4)+1, par: [0,1,2,-1,0,1,2,0,0,1,-1,0,1,-2,2,1,0,1,0,-1][i], flight: flights[i%4], time: time(i)}));
      B = namesB.map((n,i)=>({name:n, thru: (i%4)+1, pts: [7,6,5,4,5,4,6,3,2,3,8,6,7,5,4,6,2,3,2,4][i], flight: flights[i%4], time: time(i)}));
      teeTimesA = Array.from(new Set(A.map(x=>x.time)));
      teeTimesB = Array.from(new Set(B.map(x=>x.time)));
    })();

    var fTime = document.getElementById('fTime');
    (function fillTimes(){
      var all = Array.from(new Set([].concat(teeTimesA, teeTimesB)));
      all.forEach(t => { var o=document.createElement('option'); o.textContent=t; fTime.appendChild(o); });
    })();

    function sortA(list){ return list.slice().sort((a,b)=>(a.par-b.par)||(b.thru-a.thru)); }
    function sortB(list){ return list.slice().sort((a,b)=>(b.pts-a.pts)||(b.thru-a.thru)); }
    function applyFilters(data, isA){
      var ev = document.getElementById('fEvent').value;
      var fl = document.getElementById('fFlight').value;
      var tm = document.getElementById('fTime').value;
      var q  = document.getElementById('fSearch').value.trim().toLowerCase();
      var list = data.slice();
      if (ev !== 'All'){ if (isA && ev!=='Event A') list=[]; if (!isA && ev!=='Event B') list=[]; }
      if (fl !== 'All') list = list.filter(p=>p.flight===fl);
      if (tm !== 'All') list = list.filter(p=>p.time===tm);
      if (q) list = list.filter(p=>p.name.toLowerCase().includes(q));
      return list;
    }

    function rowA(p,i){ return '<tr><td class="py-1">'+(i+1)+'</td><td>'+p.name+' <span class="text-[10px] text-gray-400">('+p.flight+' • '+p.time+')</span></td><td class="text-right">'+p.thru+'</td><td class="text-right">'+(p.par>0?('+'+p.par):p.par)+'</td></tr>'; }
    function rowB(p,i){ return '<tr><td class="py-1">'+(i+1)+'</td><td>'+p.name+' <span class="text-[10px] text-gray-400">('+p.flight+' • '+p.time+')</span></td><td class="text-right">'+p.thru+'</td><td class="text-right">'+p.pts+'</td></tr>'; }

    function renderTables(){
      var a = applyFilters(A, true), b = applyFilters(B, false);
      a = sortA(a); b = sortB(b);
      document.getElementById('evA').innerHTML = a.map(rowA).join('');
      document.getElementById('evB').innerHTML = b.map(rowB).join('');
    }

    var paused = false, ms = BASE_MS, timer = null;
    function schedule(){
      if (timer) clearInterval(timer);
      timer = setInterval(function(){ if(!paused) tick(); }, ms);
    }
    function setSpeed(mult){
      ms = Math.max(400, BASE_MS / mult);
      ['spd1','spd2','spd4'].forEach(id=>{ var b=document.getElementById(id); if(b) b.className = 'px-2 py-1 text-sm ' + ((id==='spd'+mult)?'bg-green-600 text-white':'bg-white'); });
      schedule();
    }
    function tick(){
      var iA = Math.floor(Math.random()*A.length), iB = Math.floor(Math.random()*B.length);
      var pA = A[iA]; pA.thru = Math.min(18, pA.thru + (Math.random()<0.7?1:0)); pA.par = Math.max(-6, Math.min(10, pA.par + [-1,0,0,0,1][Math.floor(Math.random()*5)]));
      var pB = B[iB]; pB.thru = Math.min(18, pB.thru + (Math.random()<0.7?1:0)); pB.pts += [0,1,2,3][Math.floor(Math.random()*4)];
      renderTables();
    }

    document.getElementById('btnPause').onclick = function(){ paused = !paused; this.textContent = paused ? 'Resume' : 'Pause'; };
    document.getElementById('btnReset').onclick = function(){ host.dataset.enhanced=''; ensure(); };
    ['fEvent','fFlight','fTime','fSearch'].forEach(id=>{
      var el = document.getElementById(id);
      el && el.addEventListener('input', renderTables);
      el && el.addEventListener('change', renderTables);
    });
    document.getElementById('spd1').onclick = function(){ setSpeed(1); };
    document.getElementById('spd2').onclick = function(){ setSpeed(2); };
    document.getElementById('spd4').onclick = function(){ setSpeed(4); };

    renderTables();
    setSpeed(1);
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ensure);
  new MutationObserver(ensure).observe(document.body, {childList:true, subtree:true});
  window.addEventListener('hashchange', function(){ if (location.hash==='#live') ensure(); });
})();
/* LIVE_ENHANCED_SIM_END */
</script>
<script>
// GAMES_TAB_BOOTSTRAP
(function(){
  function moveStrayIntoMount(){
    var mount = document.getElementById('games-center-root');
    if (!mount) return;
    // If plugin created #games-center-root at <body> level, merge its children into our mount
    var stray = document.querySelector('body > #games-center-root');
    if (stray && stray !== mount){
      while (stray.firstChild) mount.appendChild(stray.firstChild);
      stray.remove();
    }
    // Ensure mount is visible
    mount.style.display = 'block';
  }
  function openGames(){
    moveStrayIntoMount();
    // Try plugin/global opener if present (will render into the existing host which we'll move in)
    try{
      if (window.openGamesCenter) window.openGamesCenter();
    }catch(e){/* ignore */}
    // Re-check/merge any created host for a short while
    var tries = 0; var iv = setInterval(function(){ moveStrayIntoMount(); if (++tries>20) clearInterval(iv); }, 50);
  }
  // Listen for our custom event fired by header button
  window.addEventListener('mycaddy:open-games', openGames);
  // Also auto-run whenever the #games tab is displayed via hash or DOM change
  window.addEventListener('hashchange', function(){ if (location.hash === '#games') openGames(); });
  new MutationObserver(function(){ 
    // If our games mount exists and tab likely visible, try opening
    if (document.getElementById('games-center-root')){ /* noop until user clicks Games */ }
  }).observe(document.body, {childList:true, subtree:true});
})();
</script>
<script>
// GAMES_FLOAT_KILLER
(function(){
  function kill(root){
    if (!root) root = document;
    var sel = ['#gc-open', '.gc-floating', '[data-gc]', '[data-gc-tab="games"]', '#games-float', '#games-fab'];
    sel.forEach(s => root.querySelectorAll(s).forEach(n => { try{ n.remove(); }catch(e){} }));
    // Also remove stray #games-center-root appended to <body> by plugin (we mount in-tab)
    var stray = document.querySelector('body > #games-center-root');
    if (stray){
      var mount = document.getElementById('games-center-root');
      if (mount && mount !== stray){
        while (stray.firstChild) mount.appendChild(stray.firstChild);
      }
      try{ stray.remove(); }catch(e){}
    }
  }
  kill(document);
  new MutationObserver(function(muts){
    for (const m of muts){
      for (const n of m.addedNodes){
        if (n && n.nodeType === 1){
          if (n.id === 'gc-open' || n.classList.contains('gc-floating') || n.hasAttribute('data-gc') || n.getAttribute('data-gc-tab')==='games' || n.id === 'games-float' || n.id === 'games-fab'){
            try{ n.remove(); }catch(e){}
          }else{
            kill(n);
          }
        }
      }
    }
  }).observe(document.documentElement, {childList:true, subtree:true});
})();
</script>
<script>
// ADMIN_HIDE_GOLFER_CARDS
(function(){
  function isOrganizer() {
    try {
      var txt = document.body.innerText || '';
      return /\bORGANIZER\b/.test(txt);
    } catch(e){ return false; }
  }
  function findGridAncestor(node){
    var a=node, steps=0;
    while (a && steps++ < 8){
      if (a.classList && a.classList.contains('grid') && a.classList.contains('grid-cols-2')) return a;
      a = a.parentElement;
    }
    return null;
  }
  function $x(xpath, root){
    root = root || document;
    var r = document.evaluate(xpath, root, null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
    var out = [];
    for (var i=0;i<r.snapshotLength;i++) out.push(r.snapshotItem(i));
    return out;
  }
  function hideGolferCards(){
    if (!isOrganizer()) return;
    var markers = [
      "//*[contains(text(),'Monthly Budget')]",
      "//*[contains(text(),'Activity Points')]",
      "//*[contains(text(),'Latest Score')]",
      "//*[contains(text(),'Book Round')]",
      "//*[contains(text(),'Schedule')]"
    ];
    var removed = 0;
    markers.forEach(function(xp){
      $x(xp).forEach(function(node){
        var grid = findGridAncestor(node);
        if (grid){
          grid.style.display = 'none';
          removed++;
        }
      });
    });
    // Also hide any immediate wrapper if it now only has empty space
    try{
      $x("//*[contains(@class,'space-y-3')]").forEach(function(box){
        if (box.querySelector('#live-center-root')) return; // keep Live tab container
        if (box.innerText.trim()===''){ box.style.display='none'; }
      });
    }catch(e){}
    return removed;
  }
  function run(){ hideGolferCards(); }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', run); else run();
  new MutationObserver(function(){ hideGolferCards(); }).observe(document.documentElement, {childList:true, subtree:true});
})();
</script>
<!-- === MCP Pairings Replacement Overlay (non-destructive) === -->
<style>
  #mcp_pairings_overlay {
    position: fixed; inset: 0; background: rgba(17,24,39,.75);
    display: none; z-index: 2147483000;
  }
  #mcp_pairings_frame_wrap {
    position: absolute; top: 2.5%; left: 2.5%; width: 95%; height: 95%;
    background: #111827; border-radius: 14px; box-shadow: 0 20px 60px rgba(0,0,0,.45);
    overflow: hidden;
  }
  #mcp_pairings_iframe { width:100%; height:100%; border:0; background:#fff; }
  #mcp_pairings_close {
    position: absolute; top: 10px; right: 12px; padding: 8px 12px;
    border-radius: 10px; border: 1px solid #e5e7eb; background: #fff; cursor: pointer;
    font-size: 12px; font-weight: 600; z-index: 100;
  }
  
  /* Back button for Manage Pairings overlay */
  #mcp_pairings_back { position:absolute; top:10px; left:12px; padding:8px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; font-size:12px; font-weight:600; z-index:101; }
  #mcp_pairings_back:hover { filter:brightness(0.98); }
#mcp_pairings_fab {
    position: fixed; right: 18px; bottom: 18px; padding: 10px 14px; border-radius: 9999px; font-weight: 600;
    border: 1px solid #2563eb; background: #2563eb; color:#fff; cursor: pointer;
    z-index: 2147483001; box-shadow: 0 10px 30px rgba(37,99,235,.35);
  }
  #mcp_pairings_fab:hover { filter: brightness(1.05); }
</style>
<div aria-hidden="true" id="mcp_pairings_overlay">
<div id="mcp_pairings_frame_wrap">
<button id="mcp_pairings_back" title="Back" type="button">← Back</button>
<button id="mcp_pairings_close" title="Close Pairings" type="button">Close ✕</button>
<iframe id="mcp_pairings_iframe" referrerpolicy="no-referrer" src="data:text/html;base64,PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgPG1ldGEgY2hhcnNldD0iVVRGLTgiPgogIDxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MS4wIj4KICA8dGl0bGU+TXlDYWRkeVBybyDigJQgRW5oYW5jZWQgUGFpcmluZ3MgU3lzdGVtPC90aXRsZT4KICA8c2NyaXB0IHNyYz0iaHR0cHM6Ly9jZG4udGFpbHdpbmRjc3MuY29tIj48L3NjcmlwdD4KICA8c3R5bGU+CiAgICAuc29jLWRyYWdnaW5nIHsgb3BhY2l0eTogMC41OyB0cmFuc2Zvcm06IHNjYWxlKDAuOTUpOyB9CiAgICAuc29jLWRyb3Atem9uZSB7IGJvcmRlcjogMnB4IGRhc2hlZCAjM2I4MmY2OyBiYWNrZ3JvdW5kLWNvbG9yOiAjZWZmNmZmOyB9CiAgICAuaG92ZXItbGlmdCB7IHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjJzIGVhc2U7IH0KICAgIC5ob3Zlci1saWZ0OmhvdmVyIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC0xcHgpOyB9CiAgICAuZ3JvdXAtY2FwYWNpdHktaW5kaWNhdG9yIHsKICAgICAgd2lkdGg6IDEycHg7CiAgICAgIGhlaWdodDogMTJweDsKICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CiAgICAgIG1hcmdpbi1sZWZ0OiA4cHg7CiAgICB9CiAgICAuY2FwYWNpdHktYXZhaWxhYmxlIHsgYmFja2dyb3VuZC1jb2xvcjogIzEwYjk4MTsgfQogICAgLmNhcGFjaXR5LXdhcm5pbmcgeyBiYWNrZ3JvdW5kLWNvbG9yOiAjZjU5ZTBiOyB9CiAgICAuY2FwYWNpdHktZnVsbCB7IGJhY2tncm91bmQtY29sb3I6ICNkYzI2MjY7IH0KICAgIC5hbmFseXRpY3MtY2FyZCB7CiAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICM2NjdlZWEgMCUsICM3NjRiYTIgMTAwJSk7CiAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgYm9yZGVyLXJhZGl1czogMTJweDsKICAgICAgcGFkZGluZzogMTZweDsKICAgICAgbWFyZ2luLWJvdHRvbTogMTZweDsKICAgIH0KICAgIC5wbGF5ZXItY2FyZCB7CiAgICAgIHRyYW5zaXRpb246IGFsbCAwLjJzIGVhc2U7CiAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICBib3JkZXI6IDFweCBzb2xpZCAjZTVlN2ViOwogICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgIHBhZGRpbmc6IDhweDsKICAgICAgbWFyZ2luLWJvdHRvbTogNnB4OwogICAgICBjdXJzb3I6IGdyYWI7CiAgICAgIGJveC1zaGFkb3c6IDAgMXB4IDNweCByZ2JhKDAsIDAsIDAsIDAuMSk7CiAgICB9CiAgICAucGxheWVyLWNhcmQ6aG92ZXIgewogICAgICBib3gtc2hhZG93OiAwIDRweCAxMnB4IHJnYmEoMCwgMCwgMCwgMC4xNSk7CiAgICAgIGJvcmRlci1jb2xvcjogIzNiODJmNjsKICAgIH0KICAgIC5wbGF5ZXItY2FyZC5kcmFnZ2luZyB7CiAgICAgIG9wYWNpdHk6IDAuNTsKICAgICAgdHJhbnNmb3JtOiByb3RhdGUoNWRlZyk7CiAgICB9CiAgICAuZ3JvdXAtY29udGFpbmVyIHsKICAgICAgbWluLWhlaWdodDogMTIwcHg7CiAgICAgIGJvcmRlcjogMnB4IGRhc2hlZCAjZTVlN2ViOwogICAgICBib3JkZXItcmFkaXVzOiAxMnB4OwogICAgICBwYWRkaW5nOiAxMnB4OwogICAgICBiYWNrZ3JvdW5kOiAjZjlmYWZiOwogICAgICB0cmFuc2l0aW9uOiBhbGwgMC4ycyBlYXNlOwogICAgfQogICAgLmdyb3VwLWNvbnRhaW5lci5kcm9wLXpvbmUgewogICAgICBib3JkZXItY29sb3I6ICMzYjgyZjY7CiAgICAgIGJhY2tncm91bmQ6ICNlZmY2ZmY7CiAgICB9CiAgICAuZ3JvdXAtY29udGFpbmVyLmZ1bGwgewogICAgICBib3JkZXItY29sb3I6ICNkYzI2MjY7CiAgICAgIGJhY2tncm91bmQ6ICNmZWYyZjI7CiAgICB9CiAgICAuaGFuZGljYXAtYmFkZ2UgewogICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoNDVkZWcsICM2NjdlZWEsICM3NjRiYTIpOwogICAgICBjb2xvcjogd2hpdGU7CiAgICAgIGZvbnQtc2l6ZTogMTBweDsKICAgICAgcGFkZGluZzogMnB4IDZweDsKICAgICAgYm9yZGVyLXJhZGl1czogMTJweDsKICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgIH0KICAgIC5ub3RpZmljYXRpb24gewogICAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICAgIHRvcDogMjBweDsKICAgICAgcmlnaHQ6IDIwcHg7CiAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICBib3JkZXI6IDFweCBzb2xpZCAjZTVlN2ViOwogICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgIHBhZGRpbmc6IDEycHggMTZweDsKICAgICAgYm94LXNoYWRvdzogMCAxMHB4IDI1cHggcmdiYSgwLCAwLCAwLCAwLjEpOwogICAgICB6LWluZGV4OiAxMDAwMDsKICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDQwMHB4KTsKICAgICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuM3MgZWFzZTsKICAgIH0KICAgIC5ub3RpZmljYXRpb24uc2hvdyB7CiAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKTsKICAgIH0KICAgIC5mZWUtc2VjdGlvbiB7CiAgICAgIGJhY2tncm91bmQ6ICNmOGZhZmM7CiAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgcGFkZGluZzogMTZweDsKICAgICAgbWFyZ2luLWJvdHRvbTogMTZweDsKICAgIH0KICAgIC5mZWUtaXRlbSB7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgfQogICAgLmZlZS10b3RhbCB7CiAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgICBib3JkZXItdG9wOiAxcHggc29saWQgI2U1ZTdlYjsKICAgICAgcGFkZGluZy10b3A6IDhweDsKICAgICAgbWFyZ2luLXRvcDogOHB4OwogICAgfQogICAgLnBhaXJpbmctY2hlY2tib3ggewogICAgICBtYXJnaW4tcmlnaHQ6IDhweDsKICAgIH0KICAgIC5wYXJ0aWNpcGFudC1saXN0IHsKICAgICAgbWF4LWhlaWdodDogMzAwcHg7CiAgICAgIG92ZXJmbG93LXk6IGF1dG87CiAgICB9CiAgICAudGFiLWNvbnRlbnQgewogICAgICBkaXNwbGF5OiBub25lOwogICAgfQogICAgLnRhYi1jb250ZW50LmFjdGl2ZSB7CiAgICAgIGRpc3BsYXk6IGJsb2NrOwogICAgfQogICAgLnRhYi1idXR0b24gewogICAgICBwYWRkaW5nOiAxMHB4IDIwcHg7CiAgICAgIGJhY2tncm91bmQ6ICNmMWY1Zjk7CiAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgfQogICAgLnRhYi1idXR0b24uYWN0aXZlIHsKICAgICAgYmFja2dyb3VuZDogIzNiODJmNjsKICAgICAgY29sb3I6IHdoaXRlOwogICAgfQogICAgLmRyb3Atem9uZS1hY3RpdmUgewogICAgICBib3JkZXI6IDJweCBkYXNoZWQgIzNiODJmNjsKICAgICAgYmFja2dyb3VuZC1jb2xvcjogI2VmZjZmZjsKICAgIH0KICAgIC5ncm91cC1zaXplLWNvbmZpZyB7CiAgICAgIGJhY2tncm91bmQ6ICNmOGZhZmM7CiAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgcGFkZGluZzogMTZweDsKICAgICAgbWFyZ2luLWJvdHRvbTogMjBweDsKICAgIH0KICAgIC5ncm91cC1oZWFkZXIgewogICAgICBkaXNwbGF5OiBmbGV4OwogICAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgIG1hcmdpbi1ib3R0b206IDEycHg7CiAgICB9CiAgICAuZ3JvdXAtc2l6ZS1pbnB1dCB7CiAgICAgIHdpZHRoOiA2MHB4OwogICAgICBwYWRkaW5nOiA0cHggOHB4OwogICAgICBib3JkZXI6IDFweCBzb2xpZCAjZDFkNWRiOwogICAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIH0KICAgIC5tb2RhbCB7CiAgICAgIGRpc3BsYXk6IG5vbmU7CiAgICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgICAgdG9wOiAwOwogICAgICBsZWZ0OiAwOwogICAgICB3aWR0aDogMTAwJTsKICAgICAgaGVpZ2h0OiAxMDAlOwogICAgICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDAsIDAsIDAsIDAuNSk7CiAgICAgIHotaW5kZXg6IDEwMDA7CiAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgfQogICAgLm1vZGFsLWNvbnRlbnQgewogICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB3aGl0ZTsKICAgICAgcGFkZGluZzogMjRweDsKICAgICAgYm9yZGVyLXJhZGl1czogMTJweDsKICAgICAgd2lkdGg6IDkwJTsKICAgICAgbWF4LXdpZHRoOiA2MDBweDsKICAgICAgbWF4LWhlaWdodDogOTB2aDsKICAgICAgb3ZlcmZsb3cteTogYXV0bzsKICAgIH0KICAgIC5yZWFsLXRpbWUtYWxlcnQgewogICAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICAgIGJvdHRvbTogMjBweDsKICAgICAgcmlnaHQ6IDIwcHg7CiAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICBib3JkZXItbGVmdDogNHB4IHNvbGlkICMzYjgyZjY7CiAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgcGFkZGluZzogMTZweDsKICAgICAgYm94LXNoYWRvdzogMCAxMHB4IDI1cHggcmdiYSgwLCAwLCAwLCAwLjEpOwogICAgICB6LWluZGV4OiAxMDAwOwogICAgICBkaXNwbGF5OiBmbGV4OwogICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICBnYXA6IDEycHg7CiAgICB9CiAgICAucGV0ZXItcGFyay1ncm91cCB7CiAgICAgIGJvcmRlcjogMnB4IHNvbGlkICMxMGI5ODE7CiAgICAgIGJhY2tncm91bmQtY29sb3I6ICNmMGZkZjQ7CiAgICB9CiAgICAuZm9ybS1pbnB1dCB7CiAgICAgIHdpZHRoOiAxMDAlOwogICAgICBwYWRkaW5nOiA4cHggMTJweDsKICAgICAgYm9yZGVyOiAxcHggc29saWQgI2QxZDVkYjsKICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICBtYXJnaW4tYm90dG9tOiAxMnB4OwogICAgfQogICAgLmZvcm0taW5wdXQ6Zm9jdXMgewogICAgICBvdXRsaW5lOiBub25lOwogICAgICBib3JkZXItY29sb3I6ICMzYjgyZjY7CiAgICAgIGJveC1zaGFkb3c6IDAgMCAwIDNweCByZ2JhKDU5LCAxMzAsIDI0NiwgMC4yKTsKICAgIH0KICAgIC5wcmVmZXJlbmNlLWluZGljYXRvciB7CiAgICAgIGNvbG9yOiAjOGI1Y2Y2OwogICAgICBmb250LXNpemU6IDE0cHg7CiAgICB9CiAgICAuc2VhcmNoLWNvbnRhaW5lciB7CiAgICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgICAgbWFyZ2luLWJvdHRvbTogMTZweDsKICAgIH0KICAgIC5zZWFyY2gtaWNvbiB7CiAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgbGVmdDogMTJweDsKICAgICAgdG9wOiA1MCU7CiAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNTAlKTsKICAgICAgY29sb3I6ICM5Y2EzYWY7CiAgICB9CiAgICAuc2VhcmNoLWlucHV0IHsKICAgICAgcGFkZGluZy1sZWZ0OiA0MHB4OwogICAgfQogICAgLm5vLXJlc3VsdHMgewogICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgIHBhZGRpbmc6IDIwcHg7CiAgICAgIGNvbG9yOiAjNmI3MjgwOwogICAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB9CiAgPC9zdHlsZT4KPC9oZWFkPgo8Ym9keSBjbGFzcz0iYmctZ3JheS01MCBtaW4taC1zY3JlZW4iPgogIDxkaXYgY2xhc3M9ImNvbnRhaW5lciBteC1hdXRvIHB4LTQgcHktOCI+CiAgICA8IS0tIEhlYWRlciAtLT4KICAgIDxoZWFkZXIgY2xhc3M9ImJnLXdoaXRlIHNoYWRvdy1zbSBib3JkZXItYiBtYi04Ij4KICAgICAgPGRpdiBjbGFzcz0ibWF4LXctN3hsIG14LWF1dG8gcHgtNCBzbTpweC02IGxnOnB4LTgiPgogICAgICAgIDxkaXYgY2xhc3M9ImZsZXgganVzdGlmeS1iZXR3ZWVuIGl0ZW1zLWNlbnRlciBweS00Ij4KICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgIDxoMSBjbGFzcz0idGV4dC0yeGwgZm9udC1ib2xkIHRleHQtZ3JheS05MDAiPk15Q2FkZHlQcm8gR29sZiBTb2NpZXR5PC9oMT4KICAgICAgICAgICAgPHAgY2xhc3M9InRleHQtc20gdGV4dC1ncmF5LTYwMCI+RW5oYW5jZWQgUGFpcmluZ3MgU3lzdGVtPC9wPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGl0ZW1zLWNlbnRlciBnYXAtNCI+CiAgICAgICAgICAgIDxidXR0b24gaWQ9InNvYy1wYWlyaW5ncy1iYWNrIiBjbGFzcz0icHgtNCBweS0yIGJnLWdyZWVuLTYwMCB0ZXh0LXdoaXRlIHJvdW5kZWQtbWQgdGV4dC1zbSBmb250LW1lZGl1bSBob3ZlcjpiZy1ncmVlbi03MDAiPuKGkCBCYWNrPC9idXR0b24+CjxidXR0b24gaWQ9InNhdmUtcGFpcmluZ3MiIGNsYXNzPSJweC00IHB5LTIgYmctZ3JlZW4tNjAwIHRleHQtd2hpdGUgcm91bmRlZC1tZCB0ZXh0LXNtIGZvbnQtbWVkaXVtIGhvdmVyOmJnLWdyZWVuLTcwMCI+CiAgICAgICAgICAgICAgU2F2ZSBQYWlyaW5ncwogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0idy0xMCBoLTEwIGJnLWJsdWUtNjAwIHJvdW5kZWQtZnVsbCBmbGV4IGl0ZW1zLWNlbnRlciBqdXN0aWZ5LWNlbnRlciB0ZXh0LXdoaXRlIGZvbnQtc2VtaWJvbGQiPgogICAgICAgICAgICAgIFJBCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9oZWFkZXI+CgogICAgPCEtLSBUYWJzIE5hdmlnYXRpb24gLS0+CiAgICA8ZGl2IGNsYXNzPSJmbGV4IGdhcC0yIG1iLTYgYmctd2hpdGUgcC0yIHJvdW5kZWQtbGcgc2hhZG93Ij4KICAgICAgPGJ1dHRvbiBjbGFzcz0idGFiLWJ1dHRvbiBhY3RpdmUiIGRhdGEtdGFiPSJldmVudHMiPkV2ZW50czwvYnV0dG9uPgogICAgICA8YnV0dG9uIGNsYXNzPSJ0YWItYnV0dG9uIiBkYXRhLXRhYj0icGFydGljaXBhbnRzIj5QYXJ0aWNpcGFudHM8L2J1dHRvbj4KICAgICAgPGJ1dHRvbiBjbGFzcz0idGFiLWJ1dHRvbiIgZGF0YS10YWI9InBhaXJpbmdzIj5QYWlyaW5nczwvYnV0dG9uPgogICAgICA8YnV0dG9uIGNsYXNzPSJ0YWItYnV0dG9uIiBkYXRhLXRhYj0iYW5hbHl0aWNzIj5BbmFseXRpY3M8L2J1dHRvbj4KICAgIDwvZGl2PgoKICAgIDwhLS0gRXZlbnRzIFRhYiAtLT4KICAgIDxkaXYgaWQ9ImV2ZW50cy10YWIiIGNsYXNzPSJ0YWItY29udGVudCBhY3RpdmUiPgogICAgICA8aDIgY2xhc3M9InRleHQteGwgZm9udC1zZW1pYm9sZCB0ZXh0LWdyYXktOTAwIG1iLTYiPlVwY29taW5nIFNvY2lldHkgRXZlbnRzPC9oMj4KICAgICAgPGRpdiBjbGFzcz0ic3BhY2UteS00Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJiZy13aGl0ZSByb3VuZGVkLWxnIGJvcmRlciBib3JkZXItZ3JheS0yMDAgcC02IGhvdmVyOnNoYWRvdy1tZCB0cmFuc2l0aW9uLXNoYWRvdyI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGp1c3RpZnktYmV0d2VlbiBpdGVtcy1zdGFydCI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZsZXgtMSI+CiAgICAgICAgICAgICAgPGgzIGNsYXNzPSJmb250LW1lZGl1bSB0ZXh0LWdyYXktOTAwIj5XZWVrZW5kIENoYW1waW9uc2hpcDwvaDM+CiAgICAgICAgICAgICAgPHAgY2xhc3M9InRleHQtc20gdGV4dC1ncmF5LTYwMCBtdC0xIj5Nb250aGx5IGNoYW1waW9uc2hpcCBldmVudCB3aXRoIHByaXplczwvcD4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGl0ZW1zLWNlbnRlciBnYXAtNCBtdC0zIHRleHQtc20gdGV4dC1ncmF5LTUwMCI+CiAgICAgICAgICAgICAgICA8c3Bhbj7wn5OFIEF1Z3VzdCAzMCwgMjAyNTwvc3Bhbj4KICAgICAgICAgICAgICAgIDxzcGFuPvCflZAgMDc6MDAgQU08L3NwYW4+CiAgICAgICAgICAgICAgICA8c3Bhbj7wn5ONIENoYW1waW9uc2hpcCBDb3Vyc2U8L3NwYW4+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibXQtNCI+CiAgICAgICAgICAgICAgICA8aDQgY2xhc3M9ImZvbnQtbWVkaXVtIHRleHQtZ3JheS05MDAgbWItMiI+RmVlczwvaDQ+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0ZXh0LXNtIHRleHQtZ3JheS02MCBzcGFjZS15LTEiPgogICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGp1c3RpZnktYmV0d2VlbiI+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4+RXZlbnQgRmVlOjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICA8c3Bhbj4xLDUwMCBUSEI8L3NwYW4+CiAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGp1c3RpZnktYmV0d2VlbiI+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4+VHJhbnNwb3J0YXRpb246PC9zcGFuPgogICAgICAgICAgICAgICAgICAgIDxzcGFuPjMwMCBUSEI8L3NwYW4+CiAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGp1c3RpZnktYmV0d2VlbiI+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4+Q29tcGV0aXRpb246PC9zcGFuPgogICAgICAgICAgICAgICAgICAgIDxzcGFuPjI1MCBUSEI8L3NwYW4+CiAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGp1c3RpZnktYmV0d2VlbiI+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4+Q2FkZHkgRmVlOjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICA8c3Bhbj40MDAgVEhCPC9zcGFuPgogICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZmxleCBqdXN0aWZ5LWJldHdlZW4gYm9yZGVyLXQgbXQtMiBwdC0yIGZvbnQtbWVkaXVtIj4KICAgICAgICAgICAgICAgICAgICA8c3Bhbj5Ub3RhbDo8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4+Miw0NTAgVEhCPC9zcGFuPgogICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iZmxleCBnYXAtMiI+CiAgICAgICAgICAgICAgPGJ1dHRvbiBpZD0idmlldy1kZXRhaWxzLWJ0biIgY2xhc3M9InB4LTQgcHktMiBib3JkZXIgYm9yZGVyLWdyYXktMzAwIHJvdW5kZWQtbWQgdGV4dC1zbSBmb250LW1lZGl1bSB0ZXh0LWdyYXktNzAwIGJnLXdoaXRlIGhvdmVyOmJnLWdyYXktNTAiPgogICAgICAgICAgICAgICAgVmlldyBEZXRhaWxzCiAgICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgICAgPGJ1dHRvbiBpZD0icmVnaXN0ZXItYnRuIiBjbGFzcz0icHgtNCBweS0yIGJnLWJsdWUtNjAwIHRleHQtd2hpdGUgcm91bmRlZC1tZCB0ZXh0LXNtIGZvbnQtbWVkaXVtIGhvdmVyOmJnLWJsdWUtNzAwIj4KICAgICAgICAgICAgICAgIFJlZ2lzdGVyCiAgICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CgogICAgPCEtLSBQYXJ0aWNpcGFudHMgVGFiIC0tPgogICAgPGRpdiBpZD0icGFydGljaXBhbnRzLXRhYiIgY2xhc3M9InRhYi1jb250ZW50Ij4KICAgICAgPGgyIGNsYXNzPSJ0ZXh0LXhsIGZvbnQtc2VtaWJvbGQgdGV4dC1ncmF5LTkwMCBtYi02Ij5FdmVudCBQYXJ0aWNpcGFudHM8L2gyPgogICAgICA8ZGl2IGNsYXNzPSJiZy13aGl0ZSByb3VuZGVkLWxnIGJvcmRlciBib3JkZXItZ3JheS0yMDAgcC02Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGp1c3RpZnktYmV0d2VlbiBpdGVtcy1jZW50ZXIgbWItNiI+CiAgICAgICAgICA8aDMgY2xhc3M9ImZvbnQtbWVkaXVtIHRleHQtZ3JheS05MDAiPldlZWtlbmQgQ2hhbXBpb25zaGlwIFBhcnRpY2lwYW50czwvaDM+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGl0ZW1zLWNlbnRlciBnYXAtMiI+CiAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0ZXh0LXNtIHRleHQtZ3JheS02MDAiPjxzcGFuIGlkPSJwYXJ0aWNpcGFudC1jb3VudCI+MDwvc3Bhbj4gcmVnaXN0ZXJlZDwvc3Bhbj4KICAgICAgICAgICAgPHNwYW4gY2xhc3M9InRleHQtc20gdGV4dC1ncmVlbi02MDAiPuKAoiA8c3BhbiBpZD0iYXZhaWxhYmxlLXNwb3RzIj4wPC9zcGFuPiBzcG90cyBhdmFpbGFibGU8L3NwYW4+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICAKICAgICAgICA8IS0tIFNlYXJjaCBCb3ggLS0+CiAgICAgICAgPGRpdiBjbGFzcz0ic2VhcmNoLWNvbnRhaW5lciI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWFyY2gtaWNvbiI+CiAgICAgICAgICAgIDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBjbGFzcz0iaC01IHctNSIgdmlld0JveD0iMCAwIDIwIDIwIiBmaWxsPSJjdXJyZW50Q29sb3IiPgogICAgICAgICAgICAgIDxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgZD0iTTggNGE0IDQgMCAxMDAgOCA0IDQgMCAwMDAtOHpNMiA4YTYgNiAwIDExMTAuODkgMy40NzZsNC44MTcgNC44MTdhMSAxIDAgMDEtMS40MTQgMS40MTRsLTQuODE2LTQuODE2QTYgNiAwIDAxMiA4eiIgY2xpcC1ydWxlPSJldmVub2RkIiAvPgogICAgICAgICAgICA8L3N2Zz4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIGlkPSJwYXJ0aWNpcGFudC1zZWFyY2giIGNsYXNzPSJmb3JtLWlucHV0IHNlYXJjaC1pbnB1dCIgcGxhY2Vob2xkZXI9IlNlYXJjaCBwbGF5ZXJzIGJ5IG5hbWUuLi4iPgogICAgICAgIDwvZGl2PgogICAgICAgIAogICAgICAgIDxkaXYgY2xhc3M9InBhcnRpY2lwYW50LWxpc3QgbWF4LWgtOTYgb3ZlcmZsb3cteS1hdXRvIj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImdyaWQgZ3JpZC1jb2xzLTEgbWQ6Z3JpZC1jb2xzLTIgZ2FwLTQiIGlkPSJwYXJ0aWNpcGFudHMtbGlzdCI+CiAgICAgICAgICAgIDwhLS0gUGFydGljaXBhbnRzIHdpbGwgYmUgcG9wdWxhdGVkIGJ5IEphdmFTY3JpcHQgLS0+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgaWQ9Im5vLXJlc3VsdHMtbWVzc2FnZSIgY2xhc3M9Im5vLXJlc3VsdHMiIHN0eWxlPSJkaXNwbGF5OiBub25lOyI+CiAgICAgICAgICAgIE5vIHBsYXllcnMgZm91bmQgbWF0Y2hpbmcgeW91ciBzZWFyY2guCiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KCiAgICA8IS0tIFBhaXJpbmdzIFRhYiAtLT4KICAgIDxkaXYgaWQ9InBhaXJpbmdzLXRhYiIgY2xhc3M9InRhYi1jb250ZW50Ij4KICAgICAgPGgyIGNsYXNzPSJ0ZXh0LXhsIGZvbnQtc2VtaWJvbGQgdGV4dC1ncmF5LTkwMCBtYi02Ij5NYW5hZ2UgUGFpcmluZ3M8L2gyPgogICAgICAKICAgICAgPGRpdiBjbGFzcz0iYmctd2hpdGUgcm91bmRlZC1sZyBib3JkZXIgYm9yZGVyLWdyYXktMjAwIHAtNiBtYi02Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJncm91cC1zaXplLWNvbmZpZyBtYi02Ij4KICAgICAgICAgIDxoMyBjbGFzcz0iZm9udC1tZWRpdW0gdGV4dC1ncmF5LTkwMCBtYi0zIj5HbG9iYWwgQ29uZmlndXJhdGlvbjwvaDM+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGZsZXgtd3JhcCBpdGVtcy1jZW50ZXIgZ2FwLTQiPgogICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iYmxvY2sgdGV4dC1zbSBmb250LW1lZGl1bSB0ZXh0LWdyYXktNzAwIG1iLTEiPkRlZmF1bHQgR3JvdXAgU2l6ZTwvbGFiZWw+CiAgICAgICAgICAgICAgPHNlbGVjdCBpZD0iZGVmYXVsdC1ncm91cC1zaXplIiBjbGFzcz0idy1mdWxsIHB4LTMgcHktMiBib3JkZXIgYm9yZGVyLWdyYXktMzAwIHJvdW5kZWQtbWQiPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iMiI+MiBHb2xmZXJzPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSIzIj4zIEdvbGZlcnM8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IjQiIHNlbGVjdGVkPjQgR29sZmVyczwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iNSI+NSBHb2xmZXJzPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSI2Ij42IEdvbGZlcnM8L29wdGlvbj4KICAgICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJibG9jayB0ZXh0LXNtIGZvbnQtbWVkaXVtIHRleHQtZ3JheS03MDAgbWItMSI+UGFpcmluZyBTdHJhdGVneTwvbGFiZWw+CiAgICAgICAgICAgICAgPHNlbGVjdCBpZD0icGFpcmluZy1zdHJhdGVneSIgY2xhc3M9InctZnVsbCBweC0zIHB5LTIgYm9yZGVyIGJvcmRlci1ncmF5LTMwMCByb3VuZGVkLW1kIj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9ImJhbGFuY2VkIj5CeSBIYW5kaWNhcCAoQmFsYW5jZWQpPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJzaW1pbGFyIj5CeSBIYW5kaWNhcCAoU2ltaWxhcik8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9InJhbmRvbSI+UmFuZG9tPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJwcmVmZXJlbmNlIj5CeSBQcmVmZXJlbmNlczwvb3B0aW9uPgogICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9ImJsb2NrIHRleHQtc20gZm9udC1tZWRpdW0gdGV4dC1ncmF5LTcwMCBtYi0xIj5UZWUgVGltZSBJbnRlcnZhbDwvbGFiZWw+CiAgICAgICAgICAgICAgPHNlbGVjdCBpZD0idGVlLXRpbWUtaW50ZXJ2YWwiIGNsYXNzPSJ3LWZ1bGwgcHgtMyBweS0yIGJvcmRlciBib3JkZXItZ3JheS0zMDAgcm91bmRlZC1tZCI+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSI4Ij44IG1pbnV0ZXM8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IjEwIiBzZWxlY3RlZD4xMCBtaW51dGVzPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSIxMiI+MTIgbWludXRlczwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iMTUiPjE1IG1pbnV0ZXM8L29wdGlvbj4KICAgICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxidXR0b24gaWQ9ImFwcGx5LWdsb2JhbC1jb25maWciIGNsYXNzPSJtdC01IHB4LTQgcHktMiBiZy1ibHVlLTYwMCB0ZXh0LXdoaXRlIHJvdW5kZWQtbWQgdGV4dC1zbSBmb250LW1lZGl1bSBob3ZlcjpiZy1ibHVlLTcwMCI+CiAgICAgICAgICAgICAgQXBwbHkgdG8gQWxsIEdyb3VwcwogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIAogICAgICAgIDxkaXYgY2xhc3M9ImZsZXggZmxleC13cmFwIGp1c3RpZnktYmV0d2VlbiBpdGVtcy1jZW50ZXIgbWItNiBnYXAtMyI+CiAgICAgICAgICA8aDMgY2xhc3M9ImZvbnQtbWVkaXVtIHRleHQtZ3JheS05MDAiPldlZWtlbmQgQ2hhbXBpb25zaGlwIEdyb3VwczwvaDM+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGZsZXgtd3JhcCBnYXAtMiI+CiAgICAgICAgICAgIDxidXR0b24gaWQ9InNtYXJ0LXBhaXItYnRuIiBjbGFzcz0icHgtNCBweS0yIGJnLWJsdWUtNjAwIHRleHQtd2hpdGUgcm91bmRlZC1tZCB0ZXh0LXNtIGZvbnQtbWVkaXVtIGhvdmVyOmJnLWJsdWUtNzAwIj4KICAgICAgICAgICAgICBTbWFydCBQYWlyaW5nCiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICA8YnV0dG9uIGlkPSJvcHRpbWl6ZS1wYWlyaW5ncy1idG4iIGNsYXNzPSJweC00IHB5LTIgYmctaW5kaWdvLTYwMCB0ZXh0LXdoaXRlIHJvdW5kZWQtbWQgdGV4dC1zbSBmb250LW1lZGl1bSBob3ZlcjpiZy1pbmRpZ28tNzAwIj4KICAgICAgICAgICAgICBPcHRpbWl6ZSBQYWlyaW5ncwogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgPGJ1dHRvbiBpZD0iYWRkLWdyb3VwLWJ0biIgY2xhc3M9InB4LTQgcHktMiBib3JkZXIgYm9yZGVyLWdyYXktMzAwIHJvdW5kZWQtbWQgdGV4dC1zbSBmb250LW1lZGl1bSB0ZXh0LWdyYXktNzAwIGJnLXdoaXRlIGhvdmVyOmJnLWdyYXktNTAiPgogICAgICAgICAgICAgIEFkZCBHcm91cAogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgPGJ1dHRvbiBpZD0icmVzZXQtYnRuIiBjbGFzcz0icHgtNCBweS0yIGJvcmRlciBib3JkZXItZ3JheS0zMDAgcm91bmRlZC1tZCB0ZXh0LXNtIGZvbnQtbWVkaXVtIHRleHQtZ3JheS03MDAgYmctd2hpdGUgaG92ZXI6YmctZ3JheS01MCI+CiAgICAgICAgICAgICAgUmVzZXQgQWxsCiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICA8YnV0dG9uIGlkPSJzaW11bGF0ZS1qb2luLWJ0biIgY2xhc3M9InB4LTQgcHktMiBiZy1wdXJwbGUtNjAwIHRleHQtd2hpdGUgcm91bmRlZC1tZCB0ZXh0LXNtIGZvbnQtbWVkaXVtIGhvdmVyOmJnLXB1cnBsZS03MDAiPgogICAgICAgICAgICAgIFNpbXVsYXRlIEpvaW5pbmcgUGV0ZXIKICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICAKICAgICAgICA8ZGl2IGNsYXNzPSJncmlkIGdyaWQtY29scy0xIG1kOmdyaWQtY29scy0yIGxnOmdyaWQtY29scy0zIGdhcC02IiBpZD0iZ3JvdXBzLWNvbnRhaW5lciI+CiAgICAgICAgICA8IS0tIEdyb3VwcyB3aWxsIGJlIHBvcHVsYXRlZCBieSBKYXZhU2NyaXB0IC0tPgogICAgICAgIDwvZGl2PgogICAgICAgIAogICAgICAgIDxkaXYgY2xhc3M9Im10LTggcHQtNiBib3JkZXItdCBib3JkZXItZ3JheS0yMDAiPgogICAgICAgICAgPGgzIGNsYXNzPSJmb250LW1lZGl1bSB0ZXh0LWdyYXktOTAwIG1iLTQiPlRlZSBUaW1lIFNjaGVkdWxlPC9oMz4KICAgICAgICAgIDxkaXYgY2xhc3M9Im92ZXJmbG93LXgtYXV0byI+CiAgICAgICAgICAgIDx0YWJsZSBjbGFzcz0ibWluLXctZnVsbCBkaXZpZGUteSBkaXZpZGUtZ3JheS0yMDAiPgogICAgICAgICAgICAgIDx0aGVhZCBjbGFzcz0iYmctZ3JheS01MCI+CiAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgIDx0aCBjbGFzcz0icHgtNCBweS0zIHRleHQtbGVmdCB0ZXh0LXhzIGZvbnQtbWVkaXVtIHRleHQtZ3JheS01MDAgdXBwZXJjYXNlIHRyYWNraW5nLXdpZGVyIj5UZWUgVGltZTwvdGg+CiAgICAgICAgICAgICAgICAgIDx0aCBjbGFzcz0icHgtNCBweS0zIHRleHQtbGVmdCB0ZXh0LXhzIGZvbnQtbWVkaXVtIHRleHQtZ3JheS01MDAgdXBwZXJjYXNlIHRyYWNraW5nLXdpZGVyIj5Hcm91cDwvdGg+CiAgICAgICAgICAgICAgICAgIDx0aCBjbGFzcz0icHgtNCBweS0zIHRleHQtbGVmdCB0ZXh0LXhzIGZvbnQtbWVkaXVtIHRleHQtZ3JheS01MDAgdXBwZXJjYXNlIHRyYWNraW5nLXdpZGVyIj5QbGF5ZXJzPC90aD4KICAgICAgICAgICAgICAgICAgPHRoIGNsYXNzPSJweC00IHB5LTMgdGV4dC1sZWZ0IHRleHQteHMgZm9udC1tZWRpdW0gdGV4dC1ncmF5LTUwMCB1cHBlcmNhc2UgdHJhY2tpbmctd2lkZXIiPkF2ZyBIQ1A8L3RoPgogICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICA8L3RoZWFkPgogICAgICAgICAgICAgIDx0Ym9keSBjbGFzcz0iYmctd2hpdGUgZGl2aWRlLXkgZGl2aWRlLWdyYXktMjAwIiBpZD0idGVlLXRpbWUtc2NoZWR1bGUiPgogICAgICAgICAgICAgICAgPCEtLSBUZWUgdGltZXMgd2lsbCBiZSBwb3B1bGF0ZWQgYnkgSmF2YVNjcmlwdCAtLT4KICAgICAgICAgICAgICA8L3Rib2R5PgogICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgICA8ZGl2IGlkPSJuby10ZWV0aW1lcy1tZXNzYWdlIiBjbGFzcz0ibm8tcmVzdWx0cyIgc3R5bGU9ImRpc3BsYXk6IG5vbmU7Ij4KICAgICAgICAgICAgICBObyB0ZWUgdGltZXMgc2NoZWR1bGVkIHlldC4gQ3JlYXRlIGdyb3VwcyB0byBnZW5lcmF0ZSBhIHNjaGVkdWxlLgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgoKICAgIDwhLS0gQW5hbHl0aWNzIFRhYiAtLT4KICAgIDxkaXYgaWQ9ImFuYWx5dGljcy10YWIiIGNsYXNzPSJ0YWItY29udGVudCI+CiAgICAgIDxoMiBjbGFzcz0idGV4dC14bCBmb250LXNlbWlib2xkIHRleHQtZ3JheS05MDAgbWItNiI+RXZlbnQgQW5hbHl0aWNzPC9oMj4KICAgICAgCiAgICAgIDxkaXYgY2xhc3M9ImdyaWQgZ3JpZC1jb2xzLTEgbWQ6Z3JpZC1jb2xzLTMgZ2FwLTYgbWItNiI+CiAgICAgICAgPGRpdiBjbGFzcz0iYW5hbHl0aWNzLWNhcmQiPgogICAgICAgICAgPGgzIGNsYXNzPSJmb250LXNlbWlib2xkIG1iLTIiPlJlZ2lzdHJhdGlvbjwvaDM+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJ0ZXh0LTN4bCBmb250LWJvbGQiPjxzcGFuIGlkPSJ0b3RhbC1wbGF5ZXJzIj4wPC9zcGFuPi88c3BhbiBpZD0idG90YWwtY2FwYWNpdHkiPjA8L3NwYW4+PC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJ0ZXh0LXNtIG9wYWNpdHktODAiPjxzcGFuIGlkPSJjYXBhY2l0eS1wY3QiPjA8L3NwYW4+JSBjYXBhY2l0eTwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIAogICAgICAgIDxkaXYgY2xhc3M9ImFuYWx5dGljcy1jYXJkIj4KICAgICAgICAgIDxoMyBjbGFzcz0iZm9udC1zZW1pYm9sZCBtYi0yIj5Hcm91cCBBc3NpZ25tZW50PC9oMz4KICAgICAgICAgIDxkaXYgY2xhc3M9InRleHQtM3hsIGZvbnQtYm9sZCIgaWQ9ImFzc2lnbm1lbnQtcmF0ZSI+MCU8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9InRleHQtc20gb3BhY2l0eS04MCI+PHNwYW4gaWQ9ImFzc2lnbmVkLWNvdW50Ij4wPC9zcGFuPi88c3BhbiBpZD0idG90YWwtcmVnaXN0ZXJlZCI+MDwvc3Bhbj4gcGxheWVycyBhc3NpZ25lZDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIAogICAgICAgIDxkaXYgY2xhc3M9ImFuYWx5dGljcy1jYXJkIj4KICAgICAgICAgIDxoMyBjbGFzcz0iZm9udC1zZW1pYm9sZCBtYi0yIj5TYXRpc2ZhY3Rpb24gUmF0ZTwvaDM+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJ0ZXh0LTN4bCBmb250LWJvbGQiIGlkPSJzYXRpc2ZhY3Rpb24tcmF0ZSI+MCU8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9InRleHQtc20gb3BhY2l0eS04MCI+UGFpcmluZyBwcmVmZXJlbmNlcyBtZXQ8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICAgIAogICAgICA8ZGl2IGNsYXNzPSJiZy13aGl0ZSByb3VuZGVkLWxnIGJvcmRlciBib3JkZXItZ3JheS0yMDAgcC02IG1iLTYiPgogICAgICAgIDxoMyBjbGFzcz0iZm9udC1tZWRpdW0gdGV4dC1ncmF5LTkwMCBtYi00Ij5IYW5kaWNhcCBEaXN0cmlidXRpb248L2gzPgogICAgICAgIDxkaXYgY2xhc3M9ImgtNjQiIGlkPSJoYW5kaWNhcC1jaGFydCI+CiAgICAgICAgICA8IS0tIENoYXJ0IHdpbGwgYmUgcmVuZGVyZWQgaGVyZSAtLT4KICAgICAgICAgIDxkaXYgY2xhc3M9ImZsZXggaXRlbXMtZW5kIGgtNDggZ2FwLTEgcHQtNCIgaWQ9ImhhbmRpY2FwLWJhcnMiPgogICAgICAgICAgICA8IS0tIEJhcnMgd2lsbCBiZSBwb3B1bGF0ZWQgYnkgSmF2YVNjcmlwdCAtLT4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iZmxleCBqdXN0aWZ5LWJldHdlZW4gdGV4dC14cyB0ZXh0LWdyYXktNTAwIG10LTIiPgogICAgICAgICAgICA8c3Bhbj4wLTU8L3NwYW4+CiAgICAgICAgICAgIDxzcGFuPjYtMTA8L3NwYW4+CiAgICAgICAgICAgIDxzcGFuPjExLTE1PC9zcGFuPgogICAgICAgICAgICA8c3Bhbj4xNi0yMDwvc3Bhbj4KICAgICAgICAgICAgPHNwYW4+MjEtMjU8L3NwYW4+CiAgICAgICAgICAgIDxzcGFuPjI2LTMwPC9zcGFuPgogICAgICAgICAgICA8c3Bhbj4zMS0zNTwvc3Bhbj4KICAgICAgICAgICAgPHNwYW4+MzYrPC9zcGFuPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICAKICAgICAgPGRpdiBjbGFzcz0iYmctd2hpdGUgcm91bmRlZC1sZyBib3JkZXIgYm9yZGVyLWdyYXktMjAwIHAtNiI+CiAgICAgICAgPGgzIGNsYXNzPSJmb250LW1lZGl1bSB0ZXh0LWdyYXktOTAwIG1iLTQiPkdyb3VwIEFuYWx5c2lzPC9oMz4KICAgICAgICAKICAgICAgICA8ZGl2IGNsYXNzPSJvdmVyZmxvdy14LWF1dG8iPgogICAgICAgICAgPHRhYmxlIGNsYXNzPSJtaW4tdy1mdWxsIGRpdmlkZS15IGRpdmlkZS1ncmF5LTIwMCI+CiAgICAgICAgICAgIDx0aGVhZCBjbGFzcz0iYmctZ3JheS01MCI+CiAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgPHRoIGNsYXNzPSJweC02IHB5LTMgdGV4dC1sZWZ0IHRleHQteHMgZm9udC1tZWRpdW0gdGV4dC1ncmF5LTUwMCB1cHBlcmNhc2UgdHJhY2tpbmctd2lkZXIiPkdyb3VwPC90aD4KICAgICAgICAgICAgICAgIDx0aCBjbGFzcz0icHgtNiBweS0zIHRleHQtbGVmdCB0ZXh0LXhzIGZvbnQtbWVkaXVtIHRleHQtZ3JheS01MDAgdXBwZXJjYXNlIHRyYWNraW5nLXdpZGVyIj5QbGF5ZXJzPC90aD4KICAgICAgICAgICAgICAgIDx0aCBjbGFzcz0icHgtNiBweS0zIHRleHQtbGVmdCB0ZXh0LXhzIGZvbnQtbWVkaXVtIHRleHQtZ3JheS01MDAgdXBwZXJjYXNlIHRyYWNraW5nLXdpZGVyIj5BdmcgSENQPC90aD4KICAgICAgICAgICAgICAgIDx0aCBjbGFzcz0icHgtNiBweS0zIHRleHQtbGVmdCB0ZXh0LXhzIGZvbnQtbWVkaXVtIHRleHQtZ3JheS01MDAgdXBwZXJjYXNlIHRyYWNraW5nLXdpZGVyIj5IQ1AgU3ByZWFkPC90aD4KICAgICAgICAgICAgICAgIDx0aCBjbGFzcz0icHgtNiBweS0zIHRleHQtbGVmdCB0ZXh0LXhzIGZvbnQtbWVkaXVtIHRleHQtZ3JheS01MDAgdXBwZXJjYXNlIHRyYWNraW5nLXdpZGVyIj5TYXRpc2ZhY3Rpb248L3RoPgogICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgIDwvdGhlYWQ+CiAgICAgICAgICAgIDx0Ym9keSBjbGFzcz0iYmctd2hpdGUgZGl2aWRlLXkgZGl2aWRlLWdyYXktMjAwIiBpZD0iZ3JvdXAtYW5hbHlzaXMiPgogICAgICAgICAgICAgIDwhLS0gR3JvdXAgYW5hbHlzaXMgd2lsbCBiZSBwb3B1bGF0ZWQgYnkgSmF2YVNjcmlwdCAtLT4KICAgICAgICAgICAgPC90Ym9keT4KICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgICA8ZGl2IGlkPSJuby1hbmFseXNpcy1tZXNzYWdlIiBjbGFzcz0ibm8tcmVzdWx0cyIgc3R5bGU9ImRpc3BsYXk6IG5vbmU7Ij4KICAgICAgICAgICAgTm8gZ3JvdXBzIHRvIGFuYWx5emUuIENyZWF0ZSBncm91cHMgdG8gc2VlIGFuYWx5c2lzLgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgPC9kaXY+CgogIDwhLS0gRXZlbnQgRGV0YWlscyBNb2RhbCAtLT4KICA8ZGl2IGlkPSJldmVudC1kZXRhaWxzLW1vZGFsIiBjbGFzcz0ibW9kYWwiPgogICAgPGRpdiBjbGFzcz0ibW9kYWwtY29udGVudCI+CiAgICAgIDxoMiBjbGFzcz0idGV4dC14bCBmb250LXNlbWlib2xkIHRleHQtZ3JheS05MDAgbWItNCI+V2Vla2VuZCBDaGFtcGlvbnNoaXAgRGV0YWlsczwvaDI+CiAgICAgIAogICAgICA8ZGl2IGNsYXNzPSJtYi02Ij4KICAgICAgICA8aDMgY2xhc3M9ImZvbnQtbWVkaXVtIHRleHQtZ3JheS05MDAgbWItMiI+RXZlbnQgSW5mb3JtYXRpb248L2gzPgogICAgICAgIDxkaXYgY2xhc3M9InRleHQtc20gdGV4dC1ncmF5LTYwMCBzcGFjZS15LTEiPgogICAgICAgICAgPGRpdiBjbGFzcz0iZmxleCBqdXN0aWZ5LWJldHdlZW4iPgogICAgICAgICAgICA8c3Bhbj5EYXRlOjwvc3Bhbj4KICAgICAgICAgICAgPHNwYW4+QXVndXN0IDMwLCAyMDI1PC9zcGFuPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGp1c3RpZnktYmV0d2VlbiI+CiAgICAgICAgICAgIDxzcGFuPlRpbWU6PC9zcGFuPgogICAgICAgICAgICA8c3Bhbj4wNzowMCBBTTwvc3Bhbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iZmxleCBqdXN0aWZ5LWJldHdlZW4iPgogICAgICAgICAgICA8c3Bhbj5Mb2NhdGlvbjo8L3NwYW4+CiAgICAgICAgICAgIDxzcGFuPkNoYW1waW9uc2hpcCBDb3Vyc2U8L3NwYW4+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImZsZXgganVzdGlmeS1iZXR3ZWVuIj4KICAgICAgICAgICAgPHNwYW4+Q2FwYWNpdHk6PC9zcGFuPgogICAgICAgICAgICA8c3Bhbj4zMCBwbGF5ZXJzPC9zcGFuPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGp1c3RpZnktYmV0d2VlbiI+CiAgICAgICAgICAgIDxzcGFuPkZvcm1hdDo8L3NwYW4+CiAgICAgICAgICAgIDxzcGFuPkluZGl2aWR1YWwgU3Ryb2tlIFBsYXk8L3NwYW4+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImZsZXgganVzdGlmeS1iZXR3ZWVuIj4KICAgICAgICAgICAgPHNwYW4+UmVnaXN0cmF0aW9uIERlYWRsaW5lOjwvc3Bhbj4KICAgICAgICAgICAgPHNwYW4+QXVndXN0IDI4LCAyMDI1PC9zcGFuPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICAKICAgICAgPGRpdiBjbGFzcz0ibWItNiI+CiAgICAgICAgPGgzIGNsYXNzPSJmb250LW1lZGl1bSB0ZXh0LWdyYXktOTAwIG1iLTIiPkZlZSBTdHJ1Y3R1cmU8L2gzPgogICAgICAgIDxkaXYgY2xhc3M9InRleHQtc20gdGV4dC1ncmF5LTYwMCBzcGFjZS15LTEiPgogICAgICAgICAgPGRpdiBjbGFzcz0iZmxleCBqdXN0aWZ5LWJldHdlZW4iPgogICAgICAgICAgICA8c3Bhbj5FdmVudCBGZWU6PC9zcGFuPgogICAgICAgICAgICA8c3Bhbj4xLDUwMCBUSEI8L3NwYW4+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImZsZXgganVzdGlmeS1iZXR3ZWVuIj4KICAgICAgICAgICAgPHNwYW4+VHJhbnNwb3J0YXRpb246PC9zcGFuPgogICAgICAgICAgICA8c3Bhbj4zMDAgVEhCPC9zcGFuPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGp1c3RpZnktYmV0d2VlbiI+CiAgICAgICAgICAgIDxzcGFuPkNvbXBldGl0aW9uOjwvc3Bhbj4KICAgICAgICAgICAgPHNwYW4+MjUwIFRIQjwvc3Bhbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iZmxleCBqdXN0aWZ5LWJldHdlZW4iPgogICAgICAgICAgICA8c3Bhbj5DYWRkeSBGZWU6PC9zcGFuPgogICAgICAgICAgICA8c3Bhbj40MDAgVEhCPC9zcGFuPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGp1c3RpZnktYmV0d2VlbiBib3JkZXItdCBtdC0yIHB0LTIgZm9udC1tZWRpdW0iPgogICAgICAgICAgICA8c3Bhbj5Ub3RhbDo8L3NwYW4+CiAgICAgICAgICAgIDxzcGFuPjIsNDUwIFRIQjwvc3Bhbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgICAgCiAgICAgIDxkaXYgY2xhc3M9Im1iLTYiPgogICAgICAgIDxoMyBjbGFzcz0iZm9udC1tZWRpdW0gdGV4dC1ncmF5LTkwMCBtYi0yIj5Qcml6ZXM8L2gzPgogICAgICAgIDxkaXYgY2xhc3M9InRleHQtc20gdGV4dC1ncmF5LTYwMCBzcGFjZS15LTEiPgogICAgICAgICAgPGRpdiBjbGFzcz0iZmxleCBqdXN0aWZ5LWJldHdlZW4iPgogICAgICAgICAgICA8c3Bhbj4xc3QgUGxhY2U6PC9zcGFuPgogICAgICAgICAgICA8c3Bhbj4xMCwwMDAgVEhCICsgVHJvcGh5PC9zcGFuPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGp1c3RpZnktYmV0d2VlbiI+CiAgICAgICAgICAgIDxzcGFuPjJuZCBQbGFjZTo8L3NwYW4+CiAgICAgICAgICAgIDxzcGFuPjUsMDAwIFRIQjwvc3Bhbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iZmxleCBqdXN0aWZ5LWJldHdlZW4iPgogICAgICAgICAgICA8c3Bhbj4zcmQgUGxhY2U6PC9zcGFuPgogICAgICAgICAgICA8c3Bhbj4zLDAwMCBUSEI8L3NwYW4+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImZsZXgganVzdGlmeS1iZXR3ZWVuIj4KICAgICAgICAgICAgPHNwYW4+TG9uZ2VzdCBEcml2ZTo8L3NwYW4+CiAgICAgICAgICAgIDxzcGFuPjIsMDAwIFRIQjwvc3Bhbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iZmxleCBqdXN0aWZ5LWJldHdlZW4iPgogICAgICAgICAgICA8c3Bhbj5DbG9zZXN0IHRvIFBpbjo8L3NwYW4+CiAgICAgICAgICAgIDxzcGFuPjIsMDAwIFRIQjwvc3Bhbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgICAgCiAgICAgIDxkaXYgY2xhc3M9Im1iLTYiPgogICAgICAgIDxoMyBjbGFzcz0iZm9udC1tZWRpdW0gdGV4dC1ncmF5LTkwMCBtYi0yIj5QYXJ0aWNpcGFudHMgKDxzcGFuIGlkPSJtb2RhbC1wYXJ0aWNpcGFudC1jb3VudCI+MDwvc3Bhbj4pPC9oMz4KICAgICAgICA8ZGl2IGNsYXNzPSJwYXJ0aWNpcGFudC1saXN0IG1heC1oLTYwIG92ZXJmbG93LXktYXV0byI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzcGFjZS15LTIiIGlkPSJtb2RhbC1wYXJ0aWNpcGFudHMtbGlzdCI+CiAgICAgICAgICAgIDwhLS0gUGFydGljaXBhbnRzIHdpbGwgYmUgcG9wdWxhdGVkIGJ5IEphdmFTY3JpcHQgLS0+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICAgIAogICAgICA8ZGl2IGNsYXNzPSJmbGV4IGp1c3RpZnktZW5kIGdhcC0zIj4KICAgICAgICA8YnV0dG9uIGlkPSJyZWdpc3Rlci1mcm9tLWRldGFpbHMiIGNsYXNzPSJweC00IHB5LTIgYmctYmx1ZS02MDAgdGV4dC13aGl0ZSByb3VuZGVkLW1kIHRleHQtc20gZm9udC1tZWRpdW0gaG92ZXI6YmctYmx1ZS03MDAiPgogICAgICAgICAgUmVnaXN0ZXIgTm93CiAgICAgICAgPC9idXR0b24+CiAgICAgICAgPGJ1dHRvbiBpZD0iY2xvc2UtZGV0YWlscy1tb2RhbCIgY2xhc3M9InB4LTQgcHktMiBib3JkZXIgYm9yZGVyLWdyYXktMzAwIHJvdW5kZWQtbWQgdGV4dC1zbSBmb250LW1lZGl1bSB0ZXh0LWdyYXktNzAwIGJnLXdoaXRlIGhvdmVyOmJnLWdyYXktNTAiPgogICAgICAgICAgQ2xvc2UKICAgICAgICA8L2J1dHRvbj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICA8L2Rpdj4KCiAgPCEtLSBSZWdpc3RyYXRpb24gTW9kYWwgLS0+CiAgPGRpdiBpZD0icmVnaXN0cmF0aW9uLW1vZGFsIiBjbGFzcz0ibW9kYWwiPgogICAgPGRpdiBjbGFzcz0ibW9kYWwtY29udGVudCI+CiAgICAgIDxoMiBjbGFzcz0idGV4dC14bCBmb250LXNlbWlib2xkIHRleHQtZ3JheS05MDAgbWItNCI+UmVnaXN0ZXIgZm9yIFdlZWtlbmQgQ2hhbXBpb25zaGlwPC9oMj4KICAgICAgCiAgICAgIDxkaXYgY2xhc3M9Im1iLTYiPgogICAgICAgIDxoMyBjbGFzcz0iZm9udC1tZWRpdW0gdGV4dC1ncmF5LTkwMCBtYi0yIj5Hb2xmZXIgSW5mb3JtYXRpb248L2gzPgogICAgICAgIDxkaXYgY2xhc3M9ImdyaWQgZ3JpZC1jb2xzLTEgbWQ6Z3JpZC1jb2xzLTIgZ2FwLTQiPgogICAgICAgICAgPGRpdj4KICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJibG9jayB0ZXh0LXNtIGZvbnQtbWVkaXVtIHRleHQtZ3JheS03MDAgbWItMSI+RnVsbCBOYW1lICo8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgaWQ9InBsYXllci1uYW1lIiBjbGFzcz0iZm9ybS1pbnB1dCIgcGxhY2Vob2xkZXI9IllvdXIgbmFtZSIgcmVxdWlyZWQ+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iYmxvY2sgdGV4dC1zbSBmb250LW1lZGl1bSB0ZXh0LWdyYXktNzAwIG1iLTEiPkhhbmRpY2FwICo8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBpZD0icGxheWVyLWhhbmRpY2FwIiBjbGFzcz0iZm9ybS1pbnB1dCIgcGxhY2Vob2xkZXI9IllvdXIgaGFuZGljYXAiIHN0ZXA9IjAuMSIgbWluPSIwIiBtYXg9IjU0IiByZXF1aXJlZD4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdj4KICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJibG9jayB0ZXh0LXNtIGZvbnQtbWVkaXVtIHRleHQtZ3JheS03MDAgbWItMSI+UGhvbmUgTnVtYmVyICo8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0idGVsIiBpZD0icGxheWVyLXBob25lIiBjbGFzcz0iZm9ybS1pbnB1dCIgcGxhY2Vob2xkZXI9IjA4MS0yMzQtNTY3OCIgcmVxdWlyZWQ+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iYmxvY2sgdGV4dC1zbSBmb250LW1lZGl1bSB0ZXh0LWdyYXktNzAwIG1iLTEiPkVtYWlsIEFkZHJlc3MgKjwvbGFiZWw+CiAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJlbWFpbCIgaWQ9InBsYXllci1lbWFpbCIgY2xhc3M9ImZvcm0taW5wdXQiIHBsYWNlaG9sZGVyPSJ5b3VyQGVtYWlsLmNvbSIgcmVxdWlyZWQ+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICAgIAogICAgICA8ZGl2IGNsYXNzPSJtYi02Ij4KICAgICAgICA8aDMgY2xhc3M9ImZvbnQtbWVkaXVtIHRleHQtZ3JheS05MDAgbWItMiI+UGFpcmluZyBQcmVmZXJlbmNlcyAoc2VsZWN0IHVwIHRvIDMpPC9oMz4KICAgICAgICA8ZGl2IGNsYXNzPSJwYXJ0aWNpcGFudC1saXN0IG1heC1oLTQwIG92ZXJmbG93LXktYXV0byBib3JkZXIgYm9yZGVyLWdyYXktMjAwIHJvdW5kZWQtbWQgcC0zIj4KICAgICAgICAgIDxkaXYgY2xhc3M9InNwYWNlLXktMiIgaWQ9InBhaXJpbmctcHJlZmVyZW5jZXMiPgogICAgICAgICAgICA8IS0tIFBhaXJpbmcgb3B0aW9ucyB3aWxsIGJlIHBvcHVsYXRlZCBieSBKYXZhU2NyaXB0IC0tPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICAKICAgICAgPGRpdiBjbGFzcz0ibWItNiI+CiAgICAgICAgPGgzIGNsYXNzPSJmb250LW1lZGl1bSB0ZXh0LWdyYXktOTAwIG1iLTIiPkFkZGl0aW9uYWwgRmVlczwvaDM+CiAgICAgICAgPGRpdiBjbGFzcz0iZmVlLXNlY3Rpb24iPgogICAgICAgICAgPGRpdiBjbGFzcz0iZmVlLWl0ZW0iPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGl0ZW1zLWNlbnRlciI+CiAgICAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0idHJhbnNwb3J0LWZlZSIgY2hlY2tlZCBjbGFzcz0ibXItMiBmZWUtY2hlY2tib3giIGRhdGEtZmVlPSIzMDAiPgogICAgICAgICAgICAgIDxsYWJlbCBmb3I9InRyYW5zcG9ydC1mZWUiPlRyYW5zcG9ydGF0aW9uIEZlZSAoMzAwIFRIQik8L2xhYmVsPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdj4zMDAgVEhCPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImZlZS1pdGVtIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iZmxleCBpdGVtcy1jZW50ZXIiPgogICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgaWQ9ImNvbXBldGl0aW9uLWZlZSIgY2hlY2tlZCBjbGFzcz0ibXItMiBmZWUtY2hlY2tib3giIGRhdGEtZmVlPSIyNTAiPgogICAgICAgICAgICAgIDxsYWJlbCBmb3I9ImNvbXBldGl0aW9uLWZlZSI+Q29tcGV0aXRpb24gRmVlICgyNTAgVEhCKTwvbGFiZWw+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2PjI1MCBUSEI8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iZmVlLWl0ZW0iPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGl0ZW1zLWNlbnRlciI+CiAgICAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0iY2FkZHktZmVlIiBjbGFzcz0ibXItMiBmZWUtY2hlY2tib3giIGRhdGEtZmVlPSI0MDAiPgogICAgICAgICAgICAgIDxsYWJlbCBmb3I9ImNhZGR5LWZlZSI+Q2FkZHkgRmVlICg0MDAgVEhCKTwvbGFiZWw+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2PjQwMCBUSEI8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iZmVlLWl0ZW0iPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGl0ZW1zLWNlbnRlciI+CiAgICAgICAgICAgICAgPHNwYW4+RXZlbnQgRmVlOjwvc3Bhbj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXY+MSw1MDAgVEhCPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImZlZS10b3RhbCBmbGV4IGp1c3RpZnktYmV0d2VlbiI+CiAgICAgICAgICAgIDxkaXY+VG90YWw6PC9kaXY+CiAgICAgICAgICAgIDxkaXYgaWQ9ImZlZS10b3RhbCI+MiwwNTAgVEhCPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICAgIAogICAgICA8ZGl2IGNsYXNzPSJtYi02Ij4KICAgICAgICA8aDMgY2xhc3M9ImZvbnQtbWVkaXVtIHRleHQtZ3JheS05MDAgbWItMiI+U3BlY2lhbCBSZXF1ZXN0czwvaDM+CiAgICAgICAgPHRleHRhcmVhIGlkPSJzcGVjaWFsLXJlcXVlc3RzIiBjbGFzcz0iZm9ybS1pbnB1dCIgcGxhY2Vob2xkZXI9IkFueSBzcGVjaWFsIHJlcXVlc3RzIG9yIHJlcXVpcmVtZW50cyIgcm93cz0iMyI+PC90ZXh0YXJlYT4KICAgICAgPC9kaXY+CiAgICAgIAogICAgICA8ZGl2IGNsYXNzPSJmbGV4IGp1c3RpZnktZW5kIGdhcC0zIj4KICAgICAgICA8YnV0dG9uIGlkPSJjYW5jZWwtcmVnaXN0cmF0aW9uIiBjbGFzcz0icHgtNCBweS0yIGJvcmRlciBib3JkZXItZ3JheS0zMDAgcm91bmRlZC1tZCB0ZXh0LXNtIGZvbnQtbWVkaXVtIHRleHQtZ3JheS03MDAgYmctd2hpdGUgaG92ZXI6YmctZ3JheS01MCI+CiAgICAgICAgICBDYW5jZWwKICAgICAgICA8L2J1dHRvbj4KICAgICAgICA8YnV0dG9uIGlkPSJjb21wbGV0ZS1yZWdpc3RyYXRpb24iIGNsYXNzPSJweC00IHB5LTIgYmctYmx1ZS02MDAgdGV4dC13aGl0ZSByb3VuZGVkLW1kIHRleHQtc20gZm9udC1tZWRpdW0gaG92ZXI6YmctYmx1ZS03MDAiPgogICAgICAgICAgQ29tcGxldGUgUmVnaXN0cmF0aW9uCiAgICAgICAgPC9idXR0b24+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgPC9kaXY+CgogIDwhLS0gUmVhbC10aW1lIEFsZXJ0IC0tPgogIDxkaXYgaWQ9InJlYWwtdGltZS1hbGVydCIgY2xhc3M9InJlYWwtdGltZS1hbGVydCIgc3R5bGU9ImRpc3BsYXk6IG5vbmU7Ij4KICAgIDxkaXYgY2xhc3M9InctNCBoLTQgYmctYmx1ZS01MDAgcm91bmRlZC1mdWxsIGFuaW1hdGUtcHVsc2UiPjwvZGl2PgogICAgPGRpdj4KICAgICAgPGRpdiBjbGFzcz0iZm9udC1tZWRpdW0iPlBhaXJpbmcgUmVxdWVzdDwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJ0ZXh0LXNtIHRleHQtZ3JheS02MDAiIGlkPSJhbGVydC1tZXNzYWdlIj48L2Rpdj4KICAgIDwvZGl2PgogICAgPGJ1dHRvbiBpZD0iY2xvc2UtYWxlcnQiIGNsYXNzPSJtbC00IHRleHQtZ3JheS00MDAgaG92ZXI6dGV4dC1ncmF5LTYwMCI+CiAgICAgIDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBjbGFzcz0iaC01IHctNSIgdmlld0JveD0iMCAwIDIwIDIwIiBmaWxsPSJjdXJyZW50Q29sb3IiPgogICAgICAgIDxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgZD0iTTQuMjkzIDQuMjkzYTEgMSAwIDAxMS40MTQgMEwxMCA4LjU4Nmw0LjI5My00LjI5M2ExIDEgMCAxMTEuNDE0IDEuNDE0TDExLjQxNCAxMGw0LjI5MyA0LjI5M2ExIDEgMCAwMS0xLjQxNCAxLjQxNEwxMCAxMS40MTRsLTQuMjkzIDQuMjkzYTEgMSAwIDAxLTEuNDE0LTEuNDE0TDguNTg2IDEwIDQuMjkzIDUuNzA3YTEgMSAwIDAxMC0xLjQxNHoiIGNsaXAtcnVsZT0iZXZlbm9kZCIgLz4KICAgICAgPC9zdmc+CiAgICA8L2J1dHRvbj4KICA8L2Rpdj4KCiAgPHNjcmlwdD4KICAgIC8vIEFwcGxpY2F0aW9uIHN0YXRlCiAgICBjb25zdCBzdGF0ZSA9IHsKICAgICAgZXZlbnQ6IHsKICAgICAgICBpZDogMSwKICAgICAgICBuYW1lOiAiV2Vla2VuZCBDaGFtcGlvbnNoaXAiLAogICAgICAgIGRhdGU6ICIyMDI1LTA4LTMwIiwKICAgICAgICB0aW1lOiAiMDc6MDAgQU0iLAogICAgICAgIGNhcGFjaXR5OiAzMCwKICAgICAgICBkZXNjcmlwdGlvbjogIk1vbnRobHkgY2hhbXBpb25zaGlwIGV2ZW50IHdpdGggcHJpemVzIiwKICAgICAgICBmZWVzOiB7CiAgICAgICAgICBldmVudDogMTUwMCwKICAgICAgICAgIHRyYW5zcG9ydDogMzAwLAogICAgICAgICAgY29tcGV0aXRpb246IDI1MCwKICAgICAgICAgIGNhZGR5OiA0MDAKICAgICAgICB9LAogICAgICAgIHByaXplczogewogICAgICAgICAgZmlyc3Q6ICIxMCwwMDAgVEhCICsgVHJvcGh5IiwKICAgICAgICAgIHNlY29uZDogIjUsMDAwIFRIQiIsCiAgICAgICAgICB0aGlyZDogIjMsMDAwIFRIQiIsCiAgICAgICAgICBsb25nZXN0RHJpdmU6ICIyLDAwMCBUSEIiLAogICAgICAgICAgY2xvc2VzdFRvUGluOiAiMiwwMDAgVEhCIgogICAgICAgIH0sCiAgICAgICAgZm9ybWF0OiAiSW5kaXZpZHVhbCBTdHJva2UgUGxheSIsCiAgICAgICAgcmVnaXN0cmF0aW9uRGVhZGxpbmU6ICJBdWd1c3QgMjgsIDIwMjUiCiAgICAgIH0sCiAgICAgIG1heEdyb3VwU2l6ZTogNCwKICAgICAgZ29sZmVyczogW10sCiAgICAgIGdyb3VwczogW10sCiAgICAgIG5leHRHcm91cElkOiAxLAogICAgICBuZXh0UGxheWVySWQ6IDEsCiAgICAgIGN1cnJlbnRVc2VyOiBudWxsLAogICAgICBwYWlyaW5nUmVxdWVzdHM6IFtdLAogICAgICBwZXRlclBhcmtHcm91cElkOiAxIC8vIFNwZWNpYWwgZ3JvdXAgZm9yIFBldGVyIFBhcmsKICAgIH07CgogICAgLy8gSW5pdGlhbGl6ZSB0aGUgYXBwbGljYXRpb24KICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBmdW5jdGlvbigpIHsKICAgICAgaW5pdEFwcGxpY2F0aW9uKCk7CiAgICAgIHNldHVwRXZlbnRMaXN0ZW5lcnMoKTsKICAgICAgc2ltdWxhdGVSZWFsVGltZUFjdGl2aXR5KCk7CiAgICAgIGluaXRFbmhhbmNlZFBhaXJpbmdTeXN0ZW0oKTsKICAgICAgaW5pdFNlYXJjaEZ1bmN0aW9uYWxpdHkoKTsKICAgIH0pOwoKICAgIGZ1bmN0aW9uIGluaXRBcHBsaWNhdGlvbigpIHsKICAgICAgZ2VuZXJhdGVNb2NrR29sZmVycygyOCk7CiAgICAgIGluaXRpYWxpemVHcm91cHMoKTsKICAgICAgcmVuZGVyQWxsVGFicygpOwogICAgICB1cGRhdGVGZWVUb3RhbCgpOyAvLyBJbml0aWFsaXplIGZlZSB0b3RhbAogICAgfQoKICAgIGZ1bmN0aW9uIGdlbmVyYXRlTW9ja0dvbGZlcnMoY291bnQpIHsKICAgICAgY29uc3QgZmlyc3ROYW1lcyA9IFsiSm9obiIsICJFbW1hIiwgIk1pY2hhZWwiLCAiU2FyYWgiLCAiUm9iZXJ0IiwgIkplbm5pZmVyIiwgIldpbGxpYW0iLCAiTGlzYSIsICJEYXZpZCIsICJTdXNhbiIsICJKYW1lcyIsICJMaW5kYSIsICJSaWNoYXJkIiwgIlBhdHJpY2lhIiwgIkNoYXJsZXMiLCAiRWxpemFiZXRoIiwgIlRob21hcyIsICJOYW5jeSIsICJEYW5pZWwiLCAiTWFyeSJdOwogICAgICBjb25zdCBsYXN0TmFtZXMgPSBbIlNtaXRoIiwgIkpvaG5zb24iLCAiQnJvd24iLCAiRGF2aXMiLCAiV2lsc29uIiwgIlRheWxvciIsICJBbmRlcnNvbiIsICJUaG9tYXMiLCAiTWlsbGVyIiwgIk1vb3JlIiwgIkphY2tzb24iLCAiSGFycmlzIiwgIkNsYXJrIiwgIkxld2lzIiwgIldhbGtlciIsICJIYWxsIiwgIkFsbGVuIiwgIllvdW5nIiwgIktpbmciLCAiV3JpZ2h0Il07CiAgICAgIAogICAgICBzdGF0ZS5nb2xmZXJzID0gW107CiAgICAgIHN0YXRlLm5leHRQbGF5ZXJJZCA9IDE7CiAgICAgIAogICAgICAvLyBDcmVhdGUgUGV0ZXIgUGFyayBmaXJzdAogICAgICBzdGF0ZS5nb2xmZXJzLnB1c2goewogICAgICAgIGlkOiBzdGF0ZS5uZXh0UGxheWVySWQrKywKICAgICAgICBuYW1lOiAiUGV0ZXIgUGFyayIsCiAgICAgICAgaGNwOiAxLjAsCiAgICAgICAgcGhvbmU6ICIwODEtMjM0LTU2NzgiLAogICAgICAgIGVtYWlsOiAicGV0ZXIucGFya0BleGFtcGxlLmNvbSIsCiAgICAgICAgZ3JvdXA6IHN0YXRlLnBldGVyUGFya0dyb3VwSWQsCiAgICAgICAgcHJlZmVyZW5jZXM6IFtdCiAgICAgIH0pOwogICAgICAKICAgICAgLy8gQ3JlYXRlIG90aGVyIGdvbGZlcnMKICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgY29uc3QgZmlyc3ROYW1lID0gZmlyc3ROYW1lc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBmaXJzdE5hbWVzLmxlbmd0aCldOwogICAgICAgIGNvbnN0IGxhc3ROYW1lID0gbGFzdE5hbWVzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGxhc3ROYW1lcy5sZW5ndGgpXTsKICAgICAgICBjb25zdCBoY3AgPSAoTWF0aC5yYW5kb20oKSAqIDMwKS50b0ZpeGVkKDEpOwogICAgICAgIGNvbnN0IHBob25lID0gYDA4MS0ke01hdGguZmxvb3IoMTAwICsgTWF0aC5yYW5kb20oKSAqIDkwMCl9LSR7TWF0aC5mbG9vcigxMDAwICsgTWF0aC5yYW5kb20oKSAqIDkwMDApfWA7CiAgICAgICAgY29uc3QgZW1haWwgPSBgJHtmaXJzdE5hbWUudG9Mb3dlckNhc2UoKX0uJHtsYXN0TmFtZS50b0xvd2VyQ2FzZSgpfUBleGFtcGxlLmNvbWA7CiAgICAgICAgCiAgICAgICAgc3RhdGUuZ29sZmVycy5wdXNoKHsKICAgICAgICAgIGlkOiBzdGF0ZS5uZXh0UGxheWVySWQrKywKICAgICAgICAgIG5hbWU6IGAke2ZpcnN0TmFtZX0gJHtsYXN0TmFtZX1gLAogICAgICAgICAgaGNwOiBwYXJzZUZsb2F0KGhjcCksCiAgICAgICAgICBwaG9uZTogcGhvbmUsCiAgICAgICAgICBlbWFpbDogZW1haWwsCiAgICAgICAgICBncm91cDogbnVsbCwKICAgICAgICAgIHByZWZlcmVuY2VzOiBbXQogICAgICAgIH0pOwogICAgICB9CiAgICAgIAogICAgICAvLyBTZXQgY3VycmVudCB1c2VyIHRvIFBldGVyIFBhcmsKICAgICAgc3RhdGUuY3VycmVudFVzZXIgPSBzdGF0ZS5nb2xmZXJzWzBdOwogICAgfQoKICAgIGZ1bmN0aW9uIGluaXRpYWxpemVHcm91cHMoKSB7CiAgICAgIC8vIENyZWF0ZSBQZXRlciBQYXJrJ3Mgc3BlY2lhbCBncm91cAogICAgICBzdGF0ZS5ncm91cHMgPSBbCiAgICAgICAgeyAKICAgICAgICAgIGlkOiBzdGF0ZS5wZXRlclBhcmtHcm91cElkLCAKICAgICAgICAgIG1heFNpemU6IDQsIAogICAgICAgICAgcGxheWVyczogW3N0YXRlLmN1cnJlbnRVc2VyLmlkXSwKICAgICAgICAgIGlzUGV0ZXJQYXJrR3JvdXA6IHRydWUKICAgICAgICB9CiAgICAgIF07CiAgICAgIHN0YXRlLm5leHRHcm91cElkID0gMjsKICAgICAgCiAgICAgIC8vIENyZWF0ZSBvdGhlciBncm91cHMKICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCA1OyBpKyspIHsKICAgICAgICBzdGF0ZS5ncm91cHMucHVzaCh7CiAgICAgICAgICBpZDogc3RhdGUubmV4dEdyb3VwSWQrKywKICAgICAgICAgIG1heFNpemU6IDQsCiAgICAgICAgICBwbGF5ZXJzOiBbXSwKICAgICAgICAgIGlzUGV0ZXJQYXJrR3JvdXA6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgCiAgICAgIC8vIEFzc2lnbiBzb21lIGdvbGZlcnMgdG8gZ3JvdXBzCiAgICAgIGNvbnN0IG90aGVyR29sZmVycyA9IHN0YXRlLmdvbGZlcnMuZmlsdGVyKGcgPT4gZy5pZCAhPT0gc3RhdGUuY3VycmVudFVzZXIuaWQpOwogICAgICBsZXQgZ3JvdXBJbmRleCA9IDE7CiAgICAgIAogICAgICBmb3IgKGNvbnN0IGdvbGZlciBvZiBvdGhlckdvbGZlcnMpIHsKICAgICAgICBpZiAoZ3JvdXBJbmRleCA+PSBzdGF0ZS5ncm91cHMubGVuZ3RoKSBncm91cEluZGV4ID0gMTsKICAgICAgICAKICAgICAgICBjb25zdCBncm91cCA9IHN0YXRlLmdyb3Vwc1tncm91cEluZGV4XTsKICAgICAgICBpZiAoZ3JvdXAucGxheWVycy5sZW5ndGggPCBncm91cC5tYXhTaXplKSB7CiAgICAgICAgICBncm91cC5wbGF5ZXJzLnB1c2goZ29sZmVyLmlkKTsKICAgICAgICAgIGdvbGZlci5ncm91cCA9IGdyb3VwLmlkOwogICAgICAgICAgZ3JvdXBJbmRleCsrOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHJlbmRlckFsbFRhYnMoKSB7CiAgICAgIHJlbmRlckV2ZW50c1RhYigpOwogICAgICByZW5kZXJQYXJ0aWNpcGFudHNUYWIoKTsKICAgICAgcmVuZGVyUGFpcmluZ3NUYWIoKTsKICAgICAgcmVuZGVyQW5hbHl0aWNzVGFiKCk7CiAgICB9CgogICAgZnVuY3Rpb24gcmVuZGVyRXZlbnRzVGFiKCkgewogICAgICAvLyBFdmVudHMgdGFiIGlzIHN0YXRpYywgbm8gZHluYW1pYyBjb250ZW50IG5lZWRlZAogICAgfQoKICAgIGZ1bmN0aW9uIHJlbmRlclBhcnRpY2lwYW50c1RhYigpIHsKICAgICAgY29uc3QgcGFydGljaXBhbnRzTGlzdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwYXJ0aWNpcGFudHMtbGlzdCcpOwogICAgICBjb25zdCBwYXJ0aWNpcGFudENvdW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BhcnRpY2lwYW50LWNvdW50Jyk7CiAgICAgIGNvbnN0IGF2YWlsYWJsZVNwb3RzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F2YWlsYWJsZS1zcG90cycpOwogICAgICAKICAgICAgcGFydGljaXBhbnRzTGlzdC5pbm5lckhUTUwgPSAnJzsKICAgICAgcGFydGljaXBhbnRDb3VudC50ZXh0Q29udGVudCA9IHN0YXRlLmdvbGZlcnMubGVuZ3RoOwogICAgICBhdmFpbGFibGVTcG90cy50ZXh0Q29udGVudCA9IHN0YXRlLmV2ZW50LmNhcGFjaXR5IC0gc3RhdGUuZ29sZmVycy5sZW5ndGg7CiAgICAgIAogICAgICAvLyBHZXQgc2VhcmNoIHRlcm0gYW5kIGZpbHRlciBnb2xmZXJzIGlmIG5lZWRlZAogICAgICBjb25zdCBzZWFyY2hUZXJtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BhcnRpY2lwYW50LXNlYXJjaCcpLnZhbHVlLnRvTG93ZXJDYXNlKCk7CiAgICAgIGNvbnN0IGZpbHRlcmVkR29sZmVycyA9IHNlYXJjaFRlcm0gPyAKICAgICAgICBzdGF0ZS5nb2xmZXJzLmZpbHRlcihnb2xmZXIgPT4gZ29sZmVyLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhzZWFyY2hUZXJtKSkgOiAKICAgICAgICBzdGF0ZS5nb2xmZXJzOwogICAgICAKICAgICAgLy8gU2hvdy9oaWRlIG5vIHJlc3VsdHMgbWVzc2FnZQogICAgICBjb25zdCBub1Jlc3VsdHNNZXNzYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25vLXJlc3VsdHMtbWVzc2FnZScpOwogICAgICBpZiAoZmlsdGVyZWRHb2xmZXJzLmxlbmd0aCA9PT0gMCAmJiBzZWFyY2hUZXJtKSB7CiAgICAgICAgbm9SZXN1bHRzTWVzc2FnZS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgfSBlbHNlIHsKICAgICAgICBub1Jlc3VsdHNNZXNzYWdlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgIH0KICAgICAgCiAgICAgIGZpbHRlcmVkR29sZmVycy5mb3JFYWNoKGdvbGZlciA9PiB7CiAgICAgICAgY29uc3QgcGFydGljaXBhbnRFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIHBhcnRpY2lwYW50RWwuY2xhc3NOYW1lID0gJ2ZsZXggaXRlbXMtY2VudGVyIGp1c3RpZnktYmV0d2VlbiBwLTMgYmctZ3JheS01MCByb3VuZGVkLWxnJzsKICAgICAgICBwYXJ0aWNpcGFudEVsLmlubmVySFRNTCA9IGAKICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZvbnQtbWVkaXVtIj4ke2dvbGZlci5uYW1lfTwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0ZXh0LXNtIHRleHQtZ3JheS02MDAiPiR7Z29sZmVyLnBob25lfTwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGl0ZW1zLWNlbnRlciI+CiAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJoYW5kaWNhcC1iYWRnZSI+JHtnb2xmZXIuaGNwfTwvc3Bhbj4KICAgICAgICAgICAgJHtnb2xmZXIuZ3JvdXAgPyBgPHNwYW4gY2xhc3M9Im1sLTIgdGV4dC14cyB0ZXh0LWdyYXktNTAwIj5Hcm91cCAke2dvbGZlci5ncm91cH08L3NwYW4+YCA6ICcnfQogICAgICAgICAgPC9kaXY+CiAgICAgICAgYDsKICAgICAgICAKICAgICAgICAvLyBBZGQgY2xpY2sgZXZlbnQgZm9yIHBhaXJpbmcgcmVxdWVzdHMgKGV4Y2VwdCBmb3IgUGV0ZXIgUGFyayBoaW1zZWxmKQogICAgICAgIGlmIChnb2xmZXIuaWQgIT09IHN0YXRlLmN1cnJlbnRVc2VyLmlkKSB7CiAgICAgICAgICBwYXJ0aWNpcGFudEVsLnN0eWxlLmN1cnNvciA9ICdwb2ludGVyJzsKICAgICAgICAgIHBhcnRpY2lwYW50RWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgIHJlcXVlc3RQYWlyaW5nKGdvbGZlcik7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcGFydGljaXBhbnRzTGlzdC5hcHBlbmRDaGlsZChwYXJ0aWNpcGFudEVsKTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gcmVuZGVyUGFpcmluZ3NUYWIoKSB7CiAgICAgIGNvbnN0IGdyb3Vwc0NvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdncm91cHMtY29udGFpbmVyJyk7CiAgICAgIGdyb3Vwc0NvbnRhaW5lci5pbm5lckhUTUwgPSAnJzsKICAgICAgCiAgICAgIC8vIENyZWF0ZSBncm91cCBlbGVtZW50cwogICAgICBzdGF0ZS5ncm91cHMuZm9yRWFjaChncm91cCA9PiB7CiAgICAgICAgY29uc3QgZ3JvdXBQbGF5ZXJzID0gc3RhdGUuZ29sZmVycy5maWx0ZXIoZyA9PiBnLmdyb3VwID09PSBncm91cC5pZCk7CiAgICAgICAgY29uc3QgaXNGdWxsID0gZ3JvdXBQbGF5ZXJzLmxlbmd0aCA+PSBncm91cC5tYXhTaXplOwogICAgICAgIGNvbnN0IGNhcGFjaXR5U3RhdHVzID0gaXNGdWxsID8gJ2Z1bGwnIDogKGdyb3VwUGxheWVycy5sZW5ndGggLyBncm91cC5tYXhTaXplID4gMC43NSA/ICd3YXJuaW5nJyA6ICdhdmFpbGFibGUnKTsKICAgICAgICAKICAgICAgICBjb25zdCBncm91cEVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgZ3JvdXBFbC5jbGFzc05hbWUgPSBgZ3JvdXAtY29udGFpbmVyICR7aXNGdWxsID8gJ2Z1bGwnIDogJyd9ICR7Z3JvdXAuaXNQZXRlclBhcmtHcm91cCA/ICdwZXRlci1wYXJrLWdyb3VwJyA6ICcnfWA7CiAgICAgICAgZ3JvdXBFbC5zZXRBdHRyaWJ1dGUoJ2RhdGEtZ3JvdXAtaWQnLCBncm91cC5pZCk7CiAgICAgICAgCiAgICAgICAgZ3JvdXBFbC5pbm5lckhUTUwgPSBgCiAgICAgICAgICA8ZGl2IGNsYXNzPSJncm91cC1oZWFkZXIiPgogICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgIDxoNCBjbGFzcz0iZm9udC1tZWRpdW0iPiR7Z3JvdXAuaXNQZXRlclBhcmtHcm91cCA/ICdQZXRlciBQYXJrIEdyb3VwJyA6ICdHcm91cCAnICsgZ3JvdXAuaWR9PC9oND4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGl0ZW1zLWNlbnRlciBtdC0xIj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0ZXh0LXNtIHRleHQtZ3JheS02MDAgZ3JvdXAtY291bnQiPiR7Z3JvdXBQbGF5ZXJzLmxlbmd0aH0vJHtncm91cC5tYXhTaXplfTwvc3Bhbj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJncm91cC1jYXBhY2l0eS1pbmRpY2F0b3IgY2FwYWNpdHktJHtjYXBhY2l0eVN0YXR1c30iPjwvc3Bhbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZsZXggaXRlbXMtY2VudGVyIGdhcC0yIj4KICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBjbGFzcz0iZ3JvdXAtc2l6ZS1pbnB1dCIgdmFsdWU9IiR7Z3JvdXAubWF4U2l6ZX0iIG1pbj0iMiIgbWF4PSI4IiBkYXRhLWdyb3VwLWlkPSIke2dyb3VwLmlkfSI+CiAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0idGV4dC1ncmF5LTQwMCBob3Zlcjp0ZXh0LWdyYXktNjAwIHJlbW92ZS1ncm91cC1idG4iIGRhdGEtZ3JvdXAtaWQ9IiR7Z3JvdXAuaWR9IiAke2dyb3VwLmlzUGV0ZXJQYXJrR3JvdXAgPyAnZGlzYWJsZWQnIDogJyd9PgogICAgICAgICAgICAgICAgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGNsYXNzPSJoLTUgdy01IiB2aWV3Qm94PSIwIDAgMjAgMjAiIGZpbGw9ImN1cnJlbnRDb2xvciI+CiAgICAgICAgICAgICAgICAgIDxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgZD0iTTkgMmExIDEgMCAwMC0uODk0LjU1M0w3LjM4MiA0SDRhMSAxIDAgMDAwIDJ2MTBhMiAyIDAgMDAyIDJoOGEyIDIgMCAwMDItMlY2YTEgMSAwIDEwMC0yaC0zLjM4MmwtLjcyNC0xLjQ0N0ExIDEgMCAwMDExIDJIOXpNNyA4YTEgMSAwIDAxMiAwdjZhMSAxIDAgMTEtMiAwVjh6bTUtMWExIDEgMCAwMC0xIDF2NmExIDEgMCAxMDIgMFY4YTEgMSAwIDAwLTEtMXoiIGNsaXAtcnVsZT0iZXZlbm9kZCIgLz4KICAgICAgICAgICAgICAgIDwvc3ZnPgogICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iZ3JvdXAtcGxheWVycyBzcGFjZS15LTIiIGlkPSJncm91cC0ke2dyb3VwLmlkfS1wbGF5ZXJzIj4KICAgICAgICAgICAgJHtncm91cFBsYXllcnMubWFwKHBsYXllciA9PiBgCiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icGxheWVyLWNhcmQiIGRyYWdnYWJsZT0idHJ1ZSIgZGF0YS1wbGF5ZXItaWQ9IiR7cGxheWVyLmlkfSIgZGF0YS1jdXJyZW50LWdyb3VwPSIke2dyb3VwLmlkfSI+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGp1c3RpZnktYmV0d2VlbiBpdGVtcy1jZW50ZXIiPgogICAgICAgICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZvbnQtbWVkaXVtIj4ke3BsYXllci5uYW1lfTwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRleHQteHMgdGV4dC1ncmF5LTUwMCI+SENQOiAke3BsYXllci5oY3B9PC9kaXY+CiAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGl0ZW1zLWNlbnRlciBnYXAtMiI+CiAgICAgICAgICAgICAgICAgICAgJHtwbGF5ZXIucHJlZmVyZW5jZXMgJiYgcGxheWVyLnByZWZlcmVuY2VzLmxlbmd0aCA+IDAgPyAKICAgICAgICAgICAgICAgICAgICAgIGA8c3BhbiBjbGFzcz0idGV4dC14cyB0ZXh0LXB1cnBsZS02MDAiIHRpdGxlPSJQYWlyaW5nIHByZWZlcmVuY2VzOiAke2dldFByZWZlcmVuY2VOYW1lcyhwbGF5ZXIucHJlZmVyZW5jZXMpLmpvaW4oJywgJyl9Ij7irZA8L3NwYW4+YCA6ICcnfQogICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJoYW5kaWNhcC1iYWRnZSI+JHtwbGF5ZXIuaGNwfTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgYCkuam9pbignJyl9CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICR7Z3JvdXBQbGF5ZXJzLmxlbmd0aCA+IDAgPyBgCiAgICAgICAgICAgIDxkaXYgY2xhc3M9Im10LTMgcHQtMiBib3JkZXItdCBib3JkZXItZ3JheS0yMDAiPgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRleHQteHMgdGV4dC1ncmF5LTYwMCI+CiAgICAgICAgICAgICAgICBBdmcgSENQOiA8c3Ryb25nPiR7Y2FsY3VsYXRlR3JvdXBBdmVyYWdlSGNwKGdyb3VwUGxheWVycykudG9GaXhlZCgxKX08L3N0cm9uZz4KICAgICAgICAgICAgICAgIHwgU3ByZWFkOiA8c3Ryb25nPiR7Y2FsY3VsYXRlR3JvdXBIY3BTcHJlYWQoZ3JvdXBQbGF5ZXJzKS50b0ZpeGVkKDEpfTwvc3Ryb25nPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIGAgOiAnJ30KICAgICAgICBgOwogICAgICAgIAogICAgICAgIGdyb3Vwc0NvbnRhaW5lci5hcHBlbmRDaGlsZChncm91cEVsKTsKICAgICAgfSk7CiAgICAgIAogICAgICAvLyBBZGQgdW5hc3NpZ25lZCBwbGF5ZXJzIGdyb3VwCiAgICAgIGNvbnN0IHVuYXNzaWduZWRQbGF5ZXJzID0gc3RhdGUuZ29sZmVycy5maWx0ZXIoZyA9PiBnLmdyb3VwID09PSBudWxsKTsKICAgICAgY29uc3QgdW5hc3NpZ25lZEVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgIHVuYXNzaWduZWRFbC5jbGFzc05hbWUgPSAnZ3JvdXAtY29udGFpbmVyJzsKICAgICAgdW5hc3NpZ25lZEVsLnNldEF0dHJpYnV0ZSgnZGF0YS1ncm91cC1pZCcsICd1bmFzc2lnbmVkJyk7CiAgICAgIAogICAgICB1bmFzc2lnbmVkRWwuaW5uZXJIVE1MID0gYAogICAgICAgIDxkaXYgY2xhc3M9Imdyb3VwLWhlYWRlciI+CiAgICAgICAgICA8aDQgY2xhc3M9ImZvbnQtbWVkaXVtIj5VbmFzc2lnbmVkIFBsYXllcnM8L2g0PgogICAgICAgICAgPHNwYW4gY2xhc3M9InRleHQtc20gdGV4dC1ncmF5LTYwMCBncm91cC1jb3VudCI+JHt1bmFzc2lnbmVkUGxheWVycy5sZW5ndGh9IHBsYXllcnM8L3NwYW4+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iZ3JvdXAtcGxheWVycyBzcGFjZS15LTIiIGlkPSJ1bmFzc2lnbmVkLXBsYXllcnMiPgogICAgICAgICAgJHt1bmFzc2lnbmVkUGxheWVycy5tYXAocGxheWVyID0+IGAKICAgICAgICAgICAgPGRpdiBjbGFzcz0icGxheWVyLWNhcmQiIGRyYWdnYWJsZT0idHJ1ZSIgZGF0YS1wbGF5ZXItaWQ9IiR7cGxheWVyLmlkfSIgZGF0YS1jdXJyZW50LWdyb3VwPSJ1bmFzc2lnbmVkIj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4IGp1c3RpZnktYmV0d2VlbiBpdGVtcy1jZW50ZXIiPgogICAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZm9udC1tZWRpdW0iPiR7cGxheWVyLm5hbWV9PC9kaXY+CiAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRleHQteHMgdGV4dC1ncmF5LTUwMCI+SENQOiAke3BsYXllci5oY3B9PC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZsZXggaXRlbXMtY2VudGVyIGdhcC0yIj4KICAgICAgICAgICAgICAgICAgJHtwbGF5ZXIucHJlZmVyZW5jZXMgJiYgcGxheWVyLnByZWZlcmVuY2VzLmxlbmd0aCA+IDAgPyAKICAgICAgICAgICAgICAgICAgICBgPHNwYW4gY2xhc3M9InRleHQteHMgdGV4dC1wdXJwbGUtNjAwIiB0aXRsZT0iUGFpcmluZyBwcmVmZXJlbmNlczogJHtnZXRQcmVmZXJlbmNlTmFtZXMocGxheWVyLnByZWZlcmVuY2VzKS5qb2luKCcsICcpfSI+4q2QPC9zcGFuPmAgOiAnJ30KICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImhhbmRpY2FwLWJhZGdlIj4ke3BsYXllci5oY3B9PC9zcGFuPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgYCkuam9pbignJyl9CiAgICAgICAgPC9kaXY+CiAgICAgIGA7CiAgICAgIAogICAgICBncm91cHNDb250YWluZXIuYXBwZW5kQ2hpbGQodW5hc3NpZ25lZEVsKTsKICAgICAgCiAgICAgIC8vIEFkZCBldmVudCBsaXN0ZW5lcnMgZm9yIHJlbW92ZSBncm91cCBidXR0b25zCiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5yZW1vdmUtZ3JvdXAtYnRuJykuZm9yRWFjaChidG4gPT4gewogICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgY29uc3QgZ3JvdXBJZCA9IHBhcnNlSW50KHRoaXMuZ2V0QXR0cmlidXRlKCdkYXRhLWdyb3VwLWlkJykpOwogICAgICAgICAgcmVtb3ZlR3JvdXAoZ3JvdXBJZCk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICAKICAgICAgLy8gSW5pdGlhbGl6ZSBkcmFnIGFuZCBkcm9wCiAgICAgIGluaXREcmFnQW5kRHJvcCgpOwogICAgICB1cGRhdGVUZWVUaW1lU2NoZWR1bGUoKTsKICAgIH0KCiAgICBmdW5jdGlvbiByZW5kZXJBbmFseXRpY3NUYWIoKSB7CiAgICAgIC8vIFVwZGF0ZSBhbmFseXRpY3MgbnVtYmVycwogICAgICBjb25zdCB0b3RhbFBsYXllcnMgPSBzdGF0ZS5nb2xmZXJzLmxlbmd0aDsKICAgICAgY29uc3QgYXNzaWduZWRQbGF5ZXJzID0gc3RhdGUuZ29sZmVycy5maWx0ZXIoZyA9PiBnLmdyb3VwICE9PSBudWxsKS5sZW5ndGg7CiAgICAgIGNvbnN0IGFzc2lnbm1lbnRSYXRlID0gTWF0aC5yb3VuZCgoYXNzaWduZWRQbGF5ZXJzIC8gdG90YWxQbGF5ZXJzKSAqIDEwMCk7CiAgICAgIGNvbnN0IGNhcGFjaXR5UGN0ID0gTWF0aC5yb3VuZCgodG90YWxQbGF5ZXJzIC8gc3RhdGUuZXZlbnQuY2FwYWNpdHkpICogMTAwKTsKICAgICAgCiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0b3RhbC1wbGF5ZXJzJykudGV4dENvbnRlbnQgPSB0b3RhbFBsYXllcnM7CiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0b3RhbC1jYXBhY2l0eScpLnRleHRDb250ZW50ID0gc3RhdGUuZXZlbnQuY2FwYWNpdHk7CiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjYXBhY2l0eS1wY3QnKS50ZXh0Q29udGVudCA9IGNhcGFjaXR5UGN0OwogICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXNzaWduZWQtY291bnQnKS50ZXh0Q29udGVudCA9IGFzc2lnbmVkUGxheWVyczsKICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RvdGFsLXJlZ2lzdGVyZWQnKS50ZXh0Q29udGVudCA9IHRvdGFsUGxheWVyczsKICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Fzc2lnbm1lbnQtcmF0ZScpLnRleHRDb250ZW50ID0gYCR7YXNzaWdubWVudFJhdGV9JWA7CiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzYXRpc2ZhY3Rpb24tcmF0ZScpLnRleHRDb250ZW50ID0gYCR7TWF0aC5mbG9vcig3MCArIE1hdGgucmFuZG9tKCkgKiAzMCl9JWA7CiAgICAgIAogICAgICAvLyBVcGRhdGUgaGFuZGljYXAgZGlzdHJpYnV0aW9uIGNoYXJ0CiAgICAgIHJlbmRlckhhbmRpY2FwQ2hhcnQoKTsKICAgICAgCiAgICAgIC8vIFVwZGF0ZSBncm91cCBhbmFseXNpcyB0YWJsZQogICAgICBjb25zdCBncm91cEFuYWx5c2lzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dyb3VwLWFuYWx5c2lzJyk7CiAgICAgIGNvbnN0IG5vQW5hbHlzaXNNZXNzYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25vLWFuYWx5c2lzLW1lc3NhZ2UnKTsKICAgICAgZ3JvdXBBbmFseXNpcy5pbm5lckhUTUwgPSAnJzsKICAgICAgCiAgICAgIGNvbnN0IGdyb3Vwc1dpdGhQbGF5ZXJzID0gc3RhdGUuZ3JvdXBzLmZpbHRlcihncm91cCA9PiB7CiAgICAgICAgY29uc3QgZ3JvdXBQbGF5ZXJzID0gc3RhdGUuZ29sZmVycy5maWx0ZXIoZyA9PiBnLmdyb3VwID09PSBncm91cC5pZCk7CiAgICAgICAgcmV0dXJuIGdyb3VwUGxheWVycy5sZW5ndGggPiAwOwogICAgICB9KTsKICAgICAgCiAgICAgIGlmIChncm91cHNXaXRoUGxheWVycy5sZW5ndGggPT09IDApIHsKICAgICAgICBub0FuYWx5c2lzTWVzc2FnZS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgfSBlbHNlIHsKICAgICAgICBub0FuYWx5c2lzTWVzc2FnZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIAogICAgICAgIGdyb3Vwc1dpdGhQbGF5ZXJzLmZvckVhY2goZ3JvdXAgPT4gewogICAgICAgICAgY29uc3QgZ3JvdXBQbGF5ZXJzID0gc3RhdGUuZ29sZmVycy5maWx0ZXIoZyA9PiBnLmdyb3VwID09PSBncm91cC5pZCk7CiAgICAgICAgICBjb25zdCBoYW5kaWNhcHMgPSBncm91cFBsYXllcnMubWFwKHAgPT4gcC5oY3ApOwogICAgICAgICAgY29uc3QgYXZnSGNwID0gKGhhbmRpY2Fwcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIGhhbmRpY2Fwcy5sZW5ndGgpLnRvRml4ZWQoMSk7CiAgICAgICAgICBjb25zdCBoY3BTcHJlYWQgPSAoTWF0aC5tYXgoLi4uaGFuZGljYXBzKSAtIE1hdGgubWluKC4uLmhhbmRpY2FwcykpLnRvRml4ZWQoMSk7CiAgICAgICAgICAKICAgICAgICAgIGNvbnN0IHJvdyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RyJyk7CiAgICAgICAgICByb3cuaW5uZXJIVE1MID0gYAogICAgICAgICAgICA8dGQgY2xhc3M9InB4LTYgcHktNCB3aGl0ZXNwYWNlLW5vd3JhcCBmb250LW1lZGl1bSI+JHtncm91cC5pc1BldGVyUGFya0dyb3VwID8gJ1BldGVyIFBhcmsgR3JvdXAnIDogJ0dyb3VwICcgKyBncm91cC5pZH08L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9InB4LTYgcHktNCB3aGl0ZXNwYWNlLW5vd3JhcCI+JHtncm91cFBsYXllcnMubGVuZ3RofS8ke2dyb3VwLm1heFNpemV9PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJweC02IHB5LTQgd2hpdGVzcGFjZS1ub3dyYXAiPiR7YXZnSGNwfTwvdGQ+CiAgICAgICAgICAgIDx0ZCBjbGFzcz0icHgtNiBweS00IHdoaXRlc3BhY2Utbm93cmFwIj4ke2hjcFNwcmVhZH08L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9InB4LTYgcHktNCB3aGl0ZXNwYWNlLW5vd3JhcCI+JHtNYXRoLmZsb29yKDcwICsgTWF0aC5yYW5kb20oKSAqIDMwKX0lPC90ZD4KICAgICAgICAgIGA7CiAgICAgICAgICBncm91cEFuYWx5c2lzLmFwcGVuZENoaWxkKHJvdyk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiByZW5kZXJIYW5kaWNhcENoYXJ0KCkgewogICAgICBjb25zdCBoYW5kaWNhcEJhcnMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGFuZGljYXAtYmFycycpOwogICAgICBoYW5kaWNhcEJhcnMuaW5uZXJIVE1MID0gJyc7CiAgICAgIAogICAgICAvLyBDcmVhdGUgaGFuZGljYXAgcmFuZ2VzCiAgICAgIGNvbnN0IHJhbmdlcyA9IFsKICAgICAgICB7IG1pbjogMCwgbWF4OiA1LCBjb3VudDogMCB9LAogICAgICAgIHsgbWluOiA2LCBtYXg6IDEwLCBjb3VudDogMCB9LAogICAgICAgIHsgbWluOiAxMSwgbWF4OiAxNSwgY291bnQ6IDAgfSwKICAgICAgICB7IG1pbjogMTYsIG1heDogMjAsIGNvdW50OiAwIH0sCiAgICAgICAgeyBtaW46IDIxLCBtYXg6IDI1LCBjb3VudDogMCB9LAogICAgICAgIHsgbWluOiAyNiwgbWF4OiAzMCwgY291bnQ6IDAgfSwKICAgICAgICB7IG1pbjogMzEsIG1heDogMzUsIGNvdW50OiAwIH0sCiAgICAgICAgeyBtaW46IDM2LCBtYXg6IDQwLCBjb3VudDogMCB9CiAgICAgIF07CiAgICAgIAogICAgICAvLyBDb3VudCBnb2xmZXJzIGluIGVhY2ggcmFuZ2UKICAgICAgc3RhdGUuZ29sZmVycy5mb3JFYWNoKGdvbGZlciA9PiB7CiAgICAgICAgZm9yIChjb25zdCByYW5nZSBvZiByYW5nZXMpIHsKICAgICAgICAgIGlmIChnb2xmZXIuaGNwID49IHJhbmdlLm1pbiAmJiBnb2xmZXIuaGNwIDw9IHJhbmdlLm1heCkgewogICAgICAgICAgICByYW5nZS5jb3VudCsrOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICAKICAgICAgLy8gRmluZCBtYXggY291bnQgZm9yIHNjYWxpbmcKICAgICAgY29uc3QgbWF4Q291bnQgPSBNYXRoLm1heCguLi5yYW5nZXMubWFwKHIgPT4gci5jb3VudCkpOwogICAgICAKICAgICAgLy8gQ3JlYXRlIGJhcnMKICAgICAgcmFuZ2VzLmZvckVhY2gocmFuZ2UgPT4gewogICAgICAgIGNvbnN0IGhlaWdodCA9IG1heENvdW50ID4gMCA/IChyYW5nZS5jb3VudCAvIG1heENvdW50KSAqIDEwMCA6IDA7CiAgICAgICAgY29uc3QgYmFyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgYmFyLmNsYXNzTmFtZSA9ICdmbGV4LTEgYmctYmx1ZS0zMDAgYm9yZGVyIGJvcmRlci1ibHVlLTQwMCc7CiAgICAgICAgYmFyLnN0eWxlLmhlaWdodCA9IGAke2hlaWdodH0lYDsKICAgICAgICBiYXIudGl0bGUgPSBgJHtyYW5nZS5jb3VudH0gZ29sZmVycyAoSENQICR7cmFuZ2UubWlufS0ke3JhbmdlLm1heH0pYDsKICAgICAgICBoYW5kaWNhcEJhcnMuYXBwZW5kQ2hpbGQoYmFyKTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gaW5pdERyYWdBbmREcm9wKCkgewogICAgICBjb25zdCBwbGF5ZXJDYXJkcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5wbGF5ZXItY2FyZCcpOwogICAgICBjb25zdCBncm91cENvbnRhaW5lcnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuZ3JvdXAtY29udGFpbmVyJyk7CiAgICAgIAogICAgICBsZXQgZHJhZ2dlZEl0ZW0gPSBudWxsOwogICAgICAKICAgICAgLy8gQWRkIGRyYWcgZXZlbnRzIHRvIHBsYXllciBjYXJkcwogICAgICBwbGF5ZXJDYXJkcy5mb3JFYWNoKGNhcmQgPT4gewogICAgICAgIGNhcmQuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ3N0YXJ0JywgZnVuY3Rpb24oZSkgewogICAgICAgICAgZHJhZ2dlZEl0ZW0gPSB0aGlzOwogICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmNsYXNzTGlzdC5hZGQoJ2RyYWdnaW5nJyksIDApOwogICAgICAgICAgZS5kYXRhVHJhbnNmZXIuc2V0RGF0YSgndGV4dC9wbGFpbicsIHRoaXMuZ2V0QXR0cmlidXRlKCdkYXRhLXBsYXllci1pZCcpKTsKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICBjYXJkLmFkZEV2ZW50TGlzdGVuZXIoJ2RyYWdlbmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHRoaXMuY2xhc3NMaXN0LnJlbW92ZSgnZHJhZ2dpbmcnKTsKICAgICAgICAgIGRyYWdnZWRJdGVtID0gbnVsbDsKICAgICAgICAgIAogICAgICAgICAgLy8gUmVtb3ZlIGRyb3Agem9uZSBoaWdobGlnaHRpbmcKICAgICAgICAgIGdyb3VwQ29udGFpbmVycy5mb3JFYWNoKGNvbnRhaW5lciA9PiB7CiAgICAgICAgICAgIGNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdkcm9wLXpvbmUtYWN0aXZlJyk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIAogICAgICAvLyBBZGQgZHJhZyBldmVudHMgdG8gZ3JvdXAgY29udGFpbmVycwogICAgICBncm91cENvbnRhaW5lcnMuZm9yRWFjaChjb250YWluZXIgPT4gewogICAgICAgIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCdkcmFnb3ZlcicsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIHRoaXMuY2xhc3NMaXN0LmFkZCgnZHJvcC16b25lLWFjdGl2ZScpOwogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCdkcmFnZW50ZXInLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICB0aGlzLmNsYXNzTGlzdC5hZGQoJ2Ryb3Atem9uZS1hY3RpdmUnKTsKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICBjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ2xlYXZlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLmNsYXNzTGlzdC5yZW1vdmUoJ2Ryb3Atem9uZS1hY3RpdmUnKTsKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICBjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcignZHJvcCcsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIHRoaXMuY2xhc3NMaXN0LnJlbW92ZSgnZHJvcC16b25lLWFjdGl2ZScpOwogICAgICAgICAgCiAgICAgICAgICBpZiAoZHJhZ2dlZEl0ZW0pIHsKICAgICAgICAgICAgY29uc3QgZ3JvdXBJZCA9IHRoaXMuZ2V0QXR0cmlidXRlKCdkYXRhLWdyb3VwLWlkJyk7CiAgICAgICAgICAgIGNvbnN0IHBsYXllcklkID0gcGFyc2VJbnQoZHJhZ2dlZEl0ZW0uZ2V0QXR0cmlidXRlKCdkYXRhLXBsYXllci1pZCcpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChncm91cElkID09PSAndW5hc3NpZ25lZCcpIHsKICAgICAgICAgICAgICBtb3ZlUGxheWVyVG9VbmFzc2lnbmVkKHBsYXllcklkKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb25zdCBncm91cCA9IHN0YXRlLmdyb3Vwcy5maW5kKGcgPT4gZy5pZCA9PT0gcGFyc2VJbnQoZ3JvdXBJZCkpOwogICAgICAgICAgICAgIGlmIChncm91cCkgewogICAgICAgICAgICAgICAgbW92ZVBsYXllclRvR3JvdXAocGxheWVySWQsIGdyb3VwLmlkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlLXJlbmRlciB0aGUgaW50ZXJmYWNlCiAgICAgICAgICAgIHJlbmRlckFsbFRhYnMoKTsKICAgICAgICAgICAgc2hvd05vdGlmaWNhdGlvbihgUGxheWVyIG1vdmVkIHRvICR7Z3JvdXBJZCA9PT0gJ3VuYXNzaWduZWQnID8gJ3VuYXNzaWduZWQnIDogJ0dyb3VwICcgKyBncm91cElkfWAsICdzdWNjZXNzJyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIG1vdmVQbGF5ZXJUb0dyb3VwKHBsYXllcklkLCBncm91cElkKSB7CiAgICAgIC8vIFJlbW92ZSBmcm9tIGN1cnJlbnQgZ3JvdXAKICAgICAgY29uc3QgZ29sZmVyID0gc3RhdGUuZ29sZmVycy5maW5kKGcgPT4gZy5pZCA9PT0gcGxheWVySWQpOwogICAgICBpZiAoIWdvbGZlcikgcmV0dXJuOwogICAgICAKICAgICAgY29uc3QgY3VycmVudEdyb3VwSWQgPSBnb2xmZXIuZ3JvdXA7CiAgICAgIGlmIChjdXJyZW50R3JvdXBJZCkgewogICAgICAgIGNvbnN0IGN1cnJlbnRHcm91cCA9IHN0YXRlLmdyb3Vwcy5maW5kKGcgPT4gZy5pZCA9PT0gY3VycmVudEdyb3VwSWQpOwogICAgICAgIGlmIChjdXJyZW50R3JvdXApIHsKICAgICAgICAgIGN1cnJlbnRHcm91cC5wbGF5ZXJzID0gY3VycmVudEdyb3VwLnBsYXllcnMuZmlsdGVyKGlkID0+IGlkICE9PSBwbGF5ZXJJZCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIAogICAgICAvLyBBZGQgdG8gbmV3IGdyb3VwCiAgICAgIGxldCB0YXJnZXRHcm91cCA9IHN0YXRlLmdyb3Vwcy5maW5kKGcgPT4gZy5pZCA9PT0gZ3JvdXBJZCk7CiAgICAgIGlmICghdGFyZ2V0R3JvdXApIHsKICAgICAgICB0YXJnZXRHcm91cCA9IHsgaWQ6IGdyb3VwSWQsIG1heFNpemU6IHN0YXRlLm1heEdyb3VwU2l6ZSwgcGxheWVyczogW10sIGlzUGV0ZXJQYXJrR3JvdXA6IGZhbHNlIH07CiAgICAgICAgc3RhdGUuZ3JvdXBzLnB1c2godGFyZ2V0R3JvdXApOwogICAgICB9CiAgICAgIAogICAgICAvLyBDaGVjayBpZiBncm91cCBpcyBmdWxsCiAgICAgIGlmICh0YXJnZXRHcm91cC5wbGF5ZXJzLmxlbmd0aCA+PSB0YXJnZXRHcm91cC5tYXhTaXplKSB7CiAgICAgICAgc2hvd05vdGlmaWNhdGlvbihgR3JvdXAgJHtncm91cElkfSBpcyBmdWxsICgke3RhcmdldEdyb3VwLm1heFNpemV9IHBsYXllcnMgbWF4aW11bSlgLCAnZXJyb3InKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgCiAgICAgIHRhcmdldEdyb3VwLnBsYXllcnMucHVzaChwbGF5ZXJJZCk7CiAgICAgIGdvbGZlci5ncm91cCA9IGdyb3VwSWQ7CiAgICB9CgogICAgZnVuY3Rpb24gbW92ZVBsYXllclRvVW5hc3NpZ25lZChwbGF5ZXJJZCkgewogICAgICBjb25zdCBnb2xmZXIgPSBzdGF0ZS5nb2xmZXJzLmZpbmQoZyA9PiBnLmlkID09PSBwbGF5ZXJJZCk7CiAgICAgIGlmICghZ29sZmVyKSByZXR1cm47CiAgICAgIAogICAgICBjb25zdCBjdXJyZW50R3JvdXBJZCA9IGdvbGZlci5ncm91cDsKICAgICAgaWYgKGN1cnJlbnRHcm91cElkKSB7CiAgICAgICAgY29uc3QgY3VycmVudEdyb3VwID0gc3RhdGUuZ3JvdXBzLmZpbmQoZyA9PiBnLmlkID09PSBjdXJyZW50R3JvdXBJZCk7CiAgICAgICAgaWYgKGN1cnJlbnRHcm91cCkgewogICAgICAgICAgY3VycmVudEdyb3VwLnBsYXllcnMgPSBjdXJyZW50R3JvdXAucGxheWVycy5maWx0ZXIoaWQgPT4gaWQgIT09IHBsYXllcklkKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgCiAgICAgIGdvbGZlci5ncm91cCA9IG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0dXBFdmVudExpc3RlbmVycygpIHsKICAgICAgLy8gVGFiIHN3aXRjaGluZwogICAgICBjb25zdCB0YWJCdXR0b25zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnRhYi1idXR0b24nKTsKICAgICAgY29uc3QgdGFiQ29udGVudHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudGFiLWNvbnRlbnQnKTsKICAgICAgCiAgICAgIHRhYkJ1dHRvbnMuZm9yRWFjaChidXR0b24gPT4gewogICAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgIGNvbnN0IHRhYklkID0gYnV0dG9uLmdldEF0dHJpYnV0ZSgnZGF0YS10YWInKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIGFjdGl2ZSB0YWIgYnV0dG9uCiAgICAgICAgICB0YWJCdXR0b25zLmZvckVhY2goYnRuID0+IGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSk7CiAgICAgICAgICBidXR0b24uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAKICAgICAgICAgIC8vIFNob3cgYWN0aXZlIHRhYiBjb250ZW50CiAgICAgICAgICB0YWJDb250ZW50cy5mb3JFYWNoKGNvbnRlbnQgPT4gY29udGVudC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSk7CiAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgJHt0YWJJZH0tdGFiYCkuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICAKICAgICAgLy8gVmlldyBldmVudCBkZXRhaWxzCiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd2aWV3LWRldGFpbHMtYnRuJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICBzaG93RXZlbnREZXRhaWxzKCk7CiAgICAgIH0pOwogICAgICAKICAgICAgLy8gUmVnaXN0ZXIgZm9yIGV2ZW50CiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZWdpc3Rlci1idG4nKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgIHNob3dSZWdpc3RyYXRpb25Gb3JtKCk7CiAgICAgIH0pOwogICAgICAKICAgICAgLy8gUmVnaXN0ZXIgZnJvbSBkZXRhaWxzIG1vZGFsCiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZWdpc3Rlci1mcm9tLWRldGFpbHMnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdldmVudC1kZXRhaWxzLW1vZGFsJykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICBzaG93UmVnaXN0cmF0aW9uRm9ybSgpOwogICAgICB9KTsKICAgICAgCiAgICAgIC8vIENsb3NlIG1vZGFscwogICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2xvc2UtZGV0YWlscy1tb2RhbCcpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24oKSB7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2V2ZW50LWRldGFpbHMtbW9kYWwnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICB9KTsKICAgICAgCiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjYW5jZWwtcmVnaXN0cmF0aW9uJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVnaXN0cmF0aW9uLW1vZGFsJykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgfSk7CiAgICAgIAogICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2xvc2UtYWxlcnQnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZWFsLXRpbWUtYWxlcnQnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICB9KTsKICAgICAgCiAgICAgIC8vIENvbXBsZXRlIHJlZ2lzdHJhdGlvbgogICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29tcGxldGUtcmVnaXN0cmF0aW9uJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICBjb21wbGV0ZVJlZ2lzdHJhdGlvbigpOwogICAgICB9KTsKICAgICAgCiAgICAgIC8vIEZlZSBjYWxjdWxhdGlvbgogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuZmVlLWNoZWNrYm94JykuZm9yRWFjaChjaGVja2JveCA9PiB7CiAgICAgICAgY2hlY2tib3guYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgdXBkYXRlRmVlVG90YWwpOwogICAgICB9KTsKICAgICAgCiAgICAgIC8vIEdyb3VwIHNpemUgY2hhbmdlcwogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgICAgICAgaWYgKGUudGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucygnZ3JvdXAtc2l6ZS1pbnB1dCcpKSB7CiAgICAgICAgICBjb25zdCBncm91cElkID0gcGFyc2VJbnQoZS50YXJnZXQuZ2V0QXR0cmlidXRlKCdkYXRhLWdyb3VwLWlkJykpOwogICAgICAgICAgY29uc3QgbmV3U2l6ZSA9IHBhcnNlSW50KGUudGFyZ2V0LnZhbHVlKTsKICAgICAgICAgIAogICAgICAgICAgaWYgKG5ld1NpemUgPCAyIHx8IG5ld1NpemUgPiA4KSB7CiAgICAgICAgICAgIHNob3dOb3RpZmljYXRpb24oJ0dyb3VwIHNpemUgbXVzdCBiZSBiZXR3ZWVuIDIgYW5kIDgnLCAnZXJyb3InKTsKICAgICAgICAgICAgZS50YXJnZXQudmFsdWUgPSA0OwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICAKICAgICAgICAgIGNvbnN0IGdyb3VwID0gc3RhdGUuZ3JvdXBzLmZpbmQoZyA9PiBnLmlkID09PSBncm91cElkKTsKICAgICAgICAgIGlmIChncm91cCkgewogICAgICAgICAgICBncm91cC5tYXhTaXplID0gbmV3U2l6ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENoZWNrIGlmIHdlIG5lZWQgdG8gbW92ZSBwbGF5ZXJzIG91dCBkdWUgdG8gc2l6ZSByZWR1Y3Rpb24KICAgICAgICAgICAgaWYgKGdyb3VwLnBsYXllcnMubGVuZ3RoID4gbmV3U2l6ZSkgewogICAgICAgICAgICAgIGNvbnN0IHBsYXllcnNUb1JlbW92ZSA9IGdyb3VwLnBsYXllcnMuc2xpY2UobmV3U2l6ZSk7CiAgICAgICAgICAgICAgZ3JvdXAucGxheWVycyA9IGdyb3VwLnBsYXllcnMuc2xpY2UoMCwgbmV3U2l6ZSk7CiAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgLy8gTW92ZSBleGNlc3MgcGxheWVycyB0byB1bmFzc2lnbmVkCiAgICAgICAgICAgICAgcGxheWVyc1RvUmVtb3ZlLmZvckVhY2gocGxheWVySWQgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZ29sZmVyID0gc3RhdGUuZ29sZmVycy5maW5kKGcgPT4gZy5pZCA9PT0gcGxheWVySWQpOwogICAgICAgICAgICAgICAgaWYgKGdvbGZlcikgZ29sZmVyLmdyb3VwID0gbnVsbDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAKICAgICAgICAgICAgICBzaG93Tm90aWZpY2F0aW9uKGBHcm91cCAke2dyb3VwSWR9IHNpemUgcmVkdWNlZC4gJHtwbGF5ZXJzVG9SZW1vdmUubGVuZ3RofSBwbGF5ZXJzIG1vdmVkIHRvIHVuYXNzaWduZWQuYCwgJ3dhcm5pbmcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmVuZGVyQWxsVGFicygpOwogICAgICAgICAgICBzaG93Tm90aWZpY2F0aW9uKGBHcm91cCAke2dyb3VwSWR9IHNpemUgY2hhbmdlZCB0byAke25ld1NpemV9YCwgJ3N1Y2Nlc3MnKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICAKICAgICAgLy8gR2xvYmFsIGNvbmZpZ3VyYXRpb24KICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FwcGx5LWdsb2JhbC1jb25maWcnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IG5ld1NpemUgPSBwYXJzZUludChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGVmYXVsdC1ncm91cC1zaXplJykudmFsdWUpOwogICAgICAgIHN0YXRlLm1heEdyb3VwU2l6ZSA9IG5ld1NpemU7CiAgICAgICAgCiAgICAgICAgLy8gVXBkYXRlIGFsbCBncm91cHMKICAgICAgICBzdGF0ZS5ncm91cHMuZm9yRWFjaChncm91cCA9PiB7CiAgICAgICAgICBncm91cC5tYXhTaXplID0gbmV3U2l6ZTsKICAgICAgICAgIAogICAgICAgICAgLy8gQ2hlY2sgaWYgd2UgbmVlZCB0byBtb3ZlIHBsYXllcnMgb3V0IGR1ZSB0byBzaXplIHJlZHVjdGlvbgogICAgICAgICAgaWYgKGdyb3VwLnBsYXllcnMubGVuZ3RoID4gbmV3U2l6ZSkgewogICAgICAgICAgICBjb25zdCBwbGF5ZXJzVG9SZW1vdmUgPSBncm91cC5wbGF5ZXJzLnNsaWNlKG5ld1NpemUpOwogICAgICAgICAgICBncm91cC5wbGF5ZXJzID0gZ3JvdXAucGxheWVycy5zbGljZSgwLCBuZXdTaXplKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgZXhjZXNzIHBsYXllcnMgdG8gdW5hc3NpZ25lZAogICAgICAgICAgICBwbGF5ZXJzVG9SZW1vdmUuZm9yRWFjaChwbGF5ZXJJZCA9PiB7CiAgICAgICAgICAgICAgY29uc3QgZ29sZmVyID0gc3RhdGUuZ29sZmVycy5maW5kKGcgPT4gZy5pZCA9PT0gcGxheWVySWQpOwogICAgICAgICAgICAgIGlmIChnb2xmZXIpIGdvbGZlci5ncm91cCA9IG51bGw7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIHJlbmRlckFsbFRhYnMoKTsKICAgICAgICBzaG93Tm90aWZpY2F0aW9uKGBBbGwgZ3JvdXBzIHVwZGF0ZWQgdG8gc2l6ZSAke25ld1NpemV9YCwgJ3N1Y2Nlc3MnKTsKICAgICAgfSk7CiAgICAgIAogICAgICAvLyBTbWFydCBwYWlyaW5nCiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzbWFydC1wYWlyLWJ0bicpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3Qgc3RyYXRlZ3kgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFpcmluZy1zdHJhdGVneScpLnZhbHVlOwogICAgICAgIHNtYXJ0UGFpcmluZyhzdHJhdGVneSk7CiAgICAgIH0pOwogICAgICAKICAgICAgLy8gQWRkIGdyb3VwCiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhZGQtZ3JvdXAtYnRuJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBuZXdHcm91cCA9IHsKICAgICAgICAgIGlkOiBzdGF0ZS5uZXh0R3JvdXBJZCsrLAogICAgICAgICAgbWF4U2l6ZTogc3RhdGUubWF4R3JvdXBTaXplLAogICAgICAgICAgcGxheWVyczogW10sCiAgICAgICAgICBpc1BldGVyUGFya0dyb3VwOiBmYWxzZQogICAgICAgIH07CiAgICAgICAgc3RhdGUuZ3JvdXBzLnB1c2gobmV3R3JvdXApOwogICAgICAgIHJlbmRlckFsbFRhYnMoKTsKICAgICAgICBzaG93Tm90aWZpY2F0aW9uKGBHcm91cCAke25ld0dyb3VwLmlkfSBhZGRlZGAsICdzdWNjZXNzJyk7CiAgICAgIH0pOwogICAgICAKICAgICAgLy8gUmVzZXQgYWxsCiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXNldC1idG4nKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChjb25maXJtKCdBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gcmVzZXQgYWxsIGdyb3Vwcz8gVGhpcyB3aWxsIG1vdmUgYWxsIHBsYXllcnMgdG8gdW5hc3NpZ25lZCBleGNlcHQgUGV0ZXIgUGFyay4nKSkgewogICAgICAgICAgc3RhdGUuZ3JvdXBzLmZvckVhY2goZ3JvdXAgPT4gewogICAgICAgICAgICBpZiAoIWdyb3VwLmlzUGV0ZXJQYXJrR3JvdXApIHsKICAgICAgICAgICAgICBncm91cC5wbGF5ZXJzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgc3RhdGUuZ29sZmVycy5mb3JFYWNoKGdvbGZlciA9PiB7CiAgICAgICAgICAgIGlmIChnb2xmZXIuaWQgIT09IHN0YXRlLmN1cnJlbnRVc2VyLmlkKSB7CiAgICAgICAgICAgICAgZ29sZmVyLmdyb3VwID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBnb2xmZXIuZ3JvdXAgPSBzdGF0ZS5wZXRlclBhcmtHcm91cElkOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIAogICAgICAgICAgLy8gTWFrZSBzdXJlIFBldGVyIGlzIGluIGhpcyBncm91cAogICAgICAgICAgY29uc3QgcGV0ZXJHcm91cCA9IHN0YXRlLmdyb3Vwcy5maW5kKGcgPT4gZy5pc1BldGVyUGFya0dyb3VwKTsKICAgICAgICAgIGlmIChwZXRlckdyb3VwICYmICFwZXRlckdyb3VwLnBsYXllcnMuaW5jbHVkZXMoc3RhdGUuY3VycmVudFVzZXIuaWQpKSB7CiAgICAgICAgICAgIHBldGVyR3JvdXAucGxheWVycyA9IFtzdGF0ZS5jdXJyZW50VXNlci5pZF07CiAgICAgICAgICB9CiAgICAgICAgICAKICAgICAgICAgIHJlbmRlckFsbFRhYnMoKTsKICAgICAgICAgIHNob3dOb3RpZmljYXRpb24oJ0FsbCBncm91cHMgaGF2ZSBiZWVuIHJlc2V0IChQZXRlciBQYXJrIHJlbWFpbnMgaW4gaGlzIGdyb3VwKScsICdzdWNjZXNzJyk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgCiAgICAgIC8vIFNhdmUgcGFpcmluZ3MKICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NhdmUtcGFpcmluZ3MnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgIHNob3dOb3RpZmljYXRpb24oJ1BhaXJpbmdzIHNhdmVkIHN1Y2Nlc3NmdWxseSEnLCAnc3VjY2VzcycpOwogICAgICB9KTsKICAgICAgCiAgICAgIC8vIFNpbXVsYXRlIGpvaW5pbmcgUGV0ZXIncyBncm91cAogICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2ltdWxhdGUtam9pbi1idG4nKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgIHNpbXVsYXRlSm9pbmluZ1BldGVyKCk7CiAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIHNob3dFdmVudERldGFpbHMoKSB7CiAgICAgIGNvbnN0IG1vZGFsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2V2ZW50LWRldGFpbHMtbW9kYWwnKTsKICAgICAgY29uc3QgcGFydGljaXBhbnRDb3VudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtb2RhbC1wYXJ0aWNpcGFudC1jb3VudCcpOwogICAgICBjb25zdCBwYXJ0aWNpcGFudHNMaXN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21vZGFsLXBhcnRpY2lwYW50cy1saXN0Jyk7CiAgICAgIAogICAgICAvLyBVcGRhdGUgcGFydGljaXBhbnQgY291bnQKICAgICAgcGFydGljaXBhbnRDb3VudC50ZXh0Q29udGVudCA9IHN0YXRlLmdvbGZlcnMubGVuZ3RoOwogICAgICAKICAgICAgLy8gUG9wdWxhdGUgcGFydGljaXBhbnRzIGxpc3QKICAgICAgcGFydGljaXBhbnRzTGlzdC5pbm5lckhUTUwgPSAnJzsKICAgICAgc3RhdGUuZ29sZmVycy5mb3JFYWNoKGdvbGZlciA9PiB7CiAgICAgICAgY29uc3QgcGFydGljaXBhbnRFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIHBhcnRpY2lwYW50RWwuY2xhc3NOYW1lID0gJ2ZsZXgganVzdGlmeS1iZXR3ZWVuIGl0ZW1zLWNlbnRlciBwLTIgYmctZ3JheS01MCByb3VuZGVkJzsKICAgICAgICBwYXJ0aWNpcGFudEVsLmlubmVySFRNTCA9IGAKICAgICAgICAgIDxzcGFuPiR7Z29sZmVyLm5hbWV9PC9zcGFuPgogICAgICAgICAgPHNwYW4gY2xhc3M9ImhhbmRpY2FwLWJhZGdlIj4ke2dvbGZlci5oY3B9PC9zcGFuPgogICAgICAgIGA7CiAgICAgICAgcGFydGljaXBhbnRzTGlzdC5hcHBlbmRDaGlsZChwYXJ0aWNpcGFudEVsKTsKICAgICAgfSk7CiAgICAgIAogICAgICAvLyBTaG93IG1vZGFsCiAgICAgIG1vZGFsLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICB9CgogICAgZnVuY3Rpb24gc2hvd1JlZ2lzdHJhdGlvbkZvcm0oKSB7CiAgICAgIGNvbnN0IG1vZGFsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlZ2lzdHJhdGlvbi1tb2RhbCcpOwogICAgICBjb25zdCBwYWlyaW5nUHJlZmVyZW5jZXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFpcmluZy1wcmVmZXJlbmNlcycpOwogICAgICAKICAgICAgLy8gUG9wdWxhdGUgcGFpcmluZyBwcmVmZXJlbmNlcwogICAgICBwYWlyaW5nUHJlZmVyZW5jZXMuaW5uZXJIVE1MID0gJyc7CiAgICAgIHN0YXRlLmdvbGZlcnMuZm9yRWFjaChnb2xmZXIgPT4gewogICAgICAgIGlmIChnb2xmZXIuaWQgIT09IHN0YXRlLmN1cnJlbnRVc2VyLmlkKSB7CiAgICAgICAgICBjb25zdCBwcmVmZXJlbmNlRWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgIHByZWZlcmVuY2VFbC5jbGFzc05hbWUgPSAnZmxleCBpdGVtcy1jZW50ZXInOwogICAgICAgICAgcHJlZmVyZW5jZUVsLmlubmVySFRNTCA9IGAKICAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBjbGFzcz0icGFpcmluZy1jaGVja2JveCIgdmFsdWU9IiR7Z29sZmVyLmlkfSIgaWQ9InByZWZlcmVuY2UtJHtnb2xmZXIuaWR9Ij4KICAgICAgICAgICAgPGxhYmVsIGZvcj0icHJlZmVyZW5jZS0ke2dvbGZlci5pZH0iIGNsYXNzPSJtbC0yIj4ke2dvbGZlci5uYW1lfSAoSENQOiAke2dvbGZlci5oY3B9KTwvbGFiZWw+CiAgICAgICAgICBgOwogICAgICAgICAgcGFpcmluZ1ByZWZlcmVuY2VzLmFwcGVuZENoaWxkKHByZWZlcmVuY2VFbCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgCiAgICAgIC8vIFNob3cgbW9kYWwKICAgICAgbW9kYWwuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgIH0KCiAgICBmdW5jdGlvbiBjb21wbGV0ZVJlZ2lzdHJhdGlvbigpIHsKICAgICAgY29uc3QgbmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItbmFtZScpLnZhbHVlOwogICAgICBjb25zdCBoYW5kaWNhcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItaGFuZGljYXAnKS52YWx1ZTsKICAgICAgY29uc3QgcGhvbmUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXBob25lJykudmFsdWU7CiAgICAgIGNvbnN0IGVtYWlsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1lbWFpbCcpLnZhbHVlOwogICAgICAKICAgICAgLy8gQmFzaWMgdmFsaWRhdGlvbgogICAgICBpZiAoIW5hbWUgfHwgIWhhbmRpY2FwIHx8ICFwaG9uZSB8fCAhZW1haWwpIHsKICAgICAgICBzaG93Tm90aWZpY2F0aW9uKCdQbGVhc2UgZmlsbCBpbiBhbGwgcmVxdWlyZWQgZmllbGRzJywgJ2Vycm9yJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIAogICAgICAvLyBWYWxpZGF0ZSBoYW5kaWNhcAogICAgICBpZiAoaGFuZGljYXAgPCAwIHx8IGhhbmRpY2FwID4gNTQpIHsKICAgICAgICBzaG93Tm90aWZpY2F0aW9uKCdIYW5kaWNhcCBtdXN0IGJlIGJldHdlZW4gMCBhbmQgNTQnLCAnZXJyb3InKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgCiAgICAgIC8vIFZhbGlkYXRlIHBob25lIG51bWJlcgogICAgICBjb25zdCBwaG9uZVJlZ2V4ID0gL15bMC05XXszfS1bMC05XXszfS1bMC05XXs0fSQvOwogICAgICBpZiAoIXBob25lUmVnZXgudGVzdChwaG9uZSkpIHsKICAgICAgICBzaG93Tm90aWZpY2F0aW9uKCdQbGVhc2UgZW50ZXIgYSB2YWxpZCBwaG9uZSBudW1iZXIgKGZvcm1hdDogMDgxLTIzNC01Njc4KScsICdlcnJvcicpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAKICAgICAgLy8gVmFsaWRhdGUgZW1haWwKICAgICAgY29uc3QgZW1haWxSZWdleCA9IC9eW15cc0BdK0BbXlxzQF0rXC5bXlxzQF0rJC87CiAgICAgIGlmICghZW1haWxSZWdleC50ZXN0KGVtYWlsKSkgewogICAgICAgIHNob3dOb3RpZmljYXRpb24oJ1BsZWFzZSBlbnRlciBhIHZhbGlkIGVtYWlsIGFkZHJlc3MnLCAnZXJyb3InKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgCiAgICAgIC8vIEdldCBzZWxlY3RlZCBwcmVmZXJlbmNlcwogICAgICBjb25zdCBwcmVmZXJlbmNlcyA9IFtdOwogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcucGFpcmluZy1jaGVja2JveDpjaGVja2VkJykuZm9yRWFjaChjaGVja2JveCA9PiB7CiAgICAgICAgcHJlZmVyZW5jZXMucHVzaChwYXJzZUludChjaGVja2JveC52YWx1ZSkpOwogICAgICB9KTsKICAgICAgCiAgICAgIC8vIFZhbGlkYXRlIHByZWZlcmVuY2VzIChtYXggMykKICAgICAgaWYgKHByZWZlcmVuY2VzLmxlbmd0aCA+IDMpIHsKICAgICAgICBzaG93Tm90aWZpY2F0aW9uKCdZb3UgY2FuIG9ubHkgc2VsZWN0IHVwIHRvIDMgcGFpcmluZyBwcmVmZXJlbmNlcycsICdlcnJvcicpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAKICAgICAgLy8gQ3JlYXRlIG5ldyBnb2xmZXIKICAgICAgY29uc3QgbmV3R29sZmVyID0gewogICAgICAgIGlkOiBzdGF0ZS5uZXh0UGxheWVySWQrKywKICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgIGhjcDogcGFyc2VGbG9hdChoYW5kaWNhcCksCiAgICAgICAgcGhvbmU6IHBob25lLAogICAgICAgIGVtYWlsOiBlbWFpbCwKICAgICAgICBncm91cDogbnVsbCwKICAgICAgICBwcmVmZXJlbmNlczogcHJlZmVyZW5jZXMsCiAgICAgICAgc3BlY2lhbFJlcXVlc3RzOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3BlY2lhbC1yZXF1ZXN0cycpLnZhbHVlCiAgICAgIH07CiAgICAgIAogICAgICAvLyBBZGQgdG8gZ29sZmVycyBsaXN0CiAgICAgIHN0YXRlLmdvbGZlcnMucHVzaChuZXdHb2xmZXIpOwogICAgICAKICAgICAgLy8gQ2xvc2UgbW9kYWwKICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlZ2lzdHJhdGlvbi1tb2RhbCcpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgIAogICAgICAvLyBTaG93IHN1Y2Nlc3MgbWVzc2FnZQogICAgICBzaG93Tm90aWZpY2F0aW9uKCdSZWdpc3RyYXRpb24gY29tcGxldGVkIHN1Y2Nlc3NmdWxseSEnLCAnc3VjY2VzcycpOwogICAgICAKICAgICAgLy8gVXBkYXRlIGFsbCB0YWJzCiAgICAgIHJlbmRlckFsbFRhYnMoKTsKICAgIH0KCiAgICBmdW5jdGlvbiB1cGRhdGVGZWVUb3RhbCgpIHsKICAgICAgY29uc3QgdHJhbnNwb3J0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RyYW5zcG9ydC1mZWUnKS5jaGVja2VkID8gMzAwIDogMDsKICAgICAgY29uc3QgY29tcGV0aXRpb24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29tcGV0aXRpb24tZmVlJykuY2hlY2tlZCA/IDI1MCA6IDA7CiAgICAgIGNvbnN0IGNhZGR5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NhZGR5LWZlZScpLmNoZWNrZWQgPyA0MDAgOiAwOwogICAgICBjb25zdCB0b3RhbCA9IDE1MDAgKyB0cmFuc3BvcnQgKyBjb21wZXRpdGlvbiArIGNhZGR5OwogICAgICAKICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZlZS10b3RhbCcpLnRleHRDb250ZW50ID0gdG90YWwgKyAnIFRIQic7CiAgICB9CgogICAgZnVuY3Rpb24gcmVxdWVzdFBhaXJpbmcoZ29sZmVyKSB7CiAgICAgIC8vIEFkZCB0byBwYWlyaW5nIHJlcXVlc3RzCiAgICAgIHN0YXRlLnBhaXJpbmdSZXF1ZXN0cy5wdXNoKHsKICAgICAgICBmcm9tOiBzdGF0ZS5jdXJyZW50VXNlci5pZCwKICAgICAgICB0bzogZ29sZmVyLmlkLAogICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKQogICAgICB9KTsKICAgICAgCiAgICAgIC8vIFNob3cgbm90aWZpY2F0aW9uIHRvIHRoZSBjdXJyZW50IHVzZXIKICAgICAgc2hvd05vdGlmaWNhdGlvbihgUGFpcmluZyByZXF1ZXN0IHNlbnQgdG8gJHtnb2xmZXIubmFtZX1gLCAnc3VjY2VzcycpOwogICAgICAKICAgICAgLy8gSW4gYSByZWFsIGFwcGxpY2F0aW9uLCB0aGlzIHdvdWxkIHNlbmQgYSByZWFsLXRpbWUgbm90aWZpY2F0aW9uIHRvIHRoZSBvdGhlciBnb2xmZXIKICAgICAgLy8gRm9yIHRoaXMgZGVtbywgd2UnbGwgc2ltdWxhdGUgYSByZXNwb25zZSBhZnRlciBhIGRlbGF5CiAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIHNob3dSZWFsVGltZUFsZXJ0KGAke2dvbGZlci5uYW1lfSB3b3VsZCBsaWtlIHRvIGJlIHBhaXJlZCB3aXRoIHlvdSFgKTsKICAgICAgfSwgMjAwMCk7CiAgICB9CgogICAgZnVuY3Rpb24gc2hvd1JlYWxUaW1lQWxlcnQobWVzc2FnZSkgewogICAgICBjb25zdCBhbGVydCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZWFsLXRpbWUtYWxlcnQnKTsKICAgICAgY29uc3QgYWxlcnRNZXNzYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FsZXJ0LW1lc3NhZ2UnKTsKICAgICAgCiAgICAgIGFsZXJ0TWVzc2FnZS50ZXh0Q29udGVudCA9IG1lc3NhZ2U7CiAgICAgIGFsZXJ0LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgIAogICAgICAvLyBBdXRvLWhpZGUgYWZ0ZXIgMTAgc2Vjb25kcwogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBhbGVydC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICB9LCAxMDAwMCk7CiAgICB9CgogICAgZnVuY3Rpb24gc21hcnRQYWlyaW5nKHN0cmF0ZWd5KSB7CiAgICAgIC8vIE1vdmUgYWxsIHBsYXllcnMgdG8gdW5hc3NpZ25lZCBmaXJzdCAoZXhjZXB0IFBldGVyIFBhcmspCiAgICAgIHN0YXRlLmdvbGZlcnMuZm9yRWFjaChnb2xmZXIgPT4gewogICAgICAgIGlmIChnb2xmZXIuaWQgIT09IHN0YXRlLmN1cnJlbnRVc2VyLmlkKSB7CiAgICAgICAgICBnb2xmZXIuZ3JvdXAgPSBudWxsOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIAogICAgICBzdGF0ZS5ncm91cHMuZm9yRWFjaChncm91cCA9PiB7CiAgICAgICAgaWYgKCFncm91cC5pc1BldGVyUGFya0dyb3VwKSB7CiAgICAgICAgICBncm91cC5wbGF5ZXJzID0gW107CiAgICAgICAgfQogICAgICB9KTsKICAgICAgCiAgICAgIC8vIEdldCBhbGwgZ29sZmVycyBleGNlcHQgUGV0ZXIKICAgICAgY29uc3QgZ29sZmVycyA9IHN0YXRlLmdvbGZlcnMuZmlsdGVyKGcgPT4gZy5pZCAhPT0gc3RhdGUuY3VycmVudFVzZXIuaWQpOwogICAgICAKICAgICAgaWYgKHN0cmF0ZWd5ID09PSAncHJlZmVyZW5jZScpIHsKICAgICAgICBwYWlyQnlQcmVmZXJlbmNlcyhnb2xmZXJzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBPcmlnaW5hbCBzdHJhdGVnaWVzCiAgICAgICAgaWYgKHN0cmF0ZWd5ID09PSAnYmFsYW5jZWQnIHx8IHN0cmF0ZWd5ID09PSAnc2ltaWxhcicpIHsKICAgICAgICAgIGdvbGZlcnMuc29ydCgoYSwgYikgPT4gYS5oY3AgLSBiLmhjcCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIFJhbmRvbWl6ZQogICAgICAgICAgZ29sZmVycy5zb3J0KCgpID0+IE1hdGgucmFuZG9tKCkgLSAwLjUpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBEaXN0cmlidXRlIGdvbGZlcnMgdG8gZ3JvdXBzCiAgICAgICAgaWYgKHN0cmF0ZWd5ID09PSAnYmFsYW5jZWQnKSB7CiAgICAgICAgICAvLyBTbmFrZSBkaXN0cmlidXRpb24gZm9yIGJhbGFuY2VkIGdyb3VwcwogICAgICAgICAgbGV0IGdyb3VwSW5kZXggPSAwOwogICAgICAgICAgbGV0IGFzY2VuZGluZyA9IHRydWU7CiAgICAgICAgICAKICAgICAgICAgIGZvciAoY29uc3QgZ29sZmVyIG9mIGdvbGZlcnMpIHsKICAgICAgICAgICAgLy8gU2tpcCBQZXRlciBQYXJrJ3MgZ3JvdXAgZm9yIGRpc3RyaWJ1dGlvbgogICAgICAgICAgICBsZXQgdGFyZ2V0R3JvdXAgPSBzdGF0ZS5ncm91cHNbZ3JvdXBJbmRleF07CiAgICAgICAgICAgIGlmICghdGFyZ2V0R3JvdXAgfHwgdGFyZ2V0R3JvdXAuaXNQZXRlclBhcmtHcm91cCkgewogICAgICAgICAgICAgIGdyb3VwSW5kZXggPSB0YXJnZXRHcm91cCAmJiB0YXJnZXRHcm91cC5pc1BldGVyUGFya0dyb3VwID8gZ3JvdXBJbmRleCArIDEgOiBncm91cEluZGV4OwogICAgICAgICAgICAgIHRhcmdldEdyb3VwID0gc3RhdGUuZ3JvdXBzW2dyb3VwSW5kZXhdOwogICAgICAgICAgICAgIGlmICghdGFyZ2V0R3JvdXApIHsKICAgICAgICAgICAgICAgIHRhcmdldEdyb3VwID0geyBpZDogc3RhdGUubmV4dEdyb3VwSWQrKywgbWF4U2l6ZTogc3RhdGUubWF4R3JvdXBTaXplLCBwbGF5ZXJzOiBbXSwgaXNQZXRlclBhcmtHcm91cDogZmFsc2UgfTsKICAgICAgICAgICAgICAgIHN0YXRlLmdyb3Vwcy5wdXNoKHRhcmdldEdyb3VwKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0YXJnZXRHcm91cC5wbGF5ZXJzLmxlbmd0aCA8IHRhcmdldEdyb3VwLm1heFNpemUpIHsKICAgICAgICAgICAgICB0YXJnZXRHcm91cC5wbGF5ZXJzLnB1c2goZ29sZmVyLmlkKTsKICAgICAgICAgICAgICBnb2xmZXIuZ3JvdXAgPSB0YXJnZXRHcm91cC5pZDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGFzY2VuZGluZykgewogICAgICAgICAgICAgIGdyb3VwSW5kZXgrKzsKICAgICAgICAgICAgICBpZiAoZ3JvdXBJbmRleCA+PSBzdGF0ZS5ncm91cHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBncm91cEluZGV4ID0gc3RhdGUuZ3JvdXBzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgICBhc2NlbmRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZ3JvdXBJbmRleC0tOwogICAgICAgICAgICAgIGlmIChncm91cEluZGV4IDwgMCkgewogICAgICAgICAgICAgICAgZ3JvdXBJbmRleCA9IDA7CiAgICAgICAgICAgICAgICBhc2NlbmRpbmcgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBTaW1wbGUgZGlzdHJpYnV0aW9uIGZvciBzaW1pbGFyIG9yIHJhbmRvbQogICAgICAgICAgbGV0IGdyb3VwSW5kZXggPSAwOwogICAgICAgICAgCiAgICAgICAgICBmb3IgKGNvbnN0IGdvbGZlciBvZiBnb2xmZXJzKSB7CiAgICAgICAgICAgIGxldCB0YXJnZXRHcm91cCA9IHN0YXRlLmdyb3Vwc1tncm91cEluZGV4XTsKICAgICAgICAgICAgLy8gU2tpcCBQZXRlciBQYXJrJ3MgZ3JvdXAgZm9yIGRpc3RyaWJ1dGlvbgogICAgICAgICAgICBpZiAoIXRhcmdldEdyb3VwIHx8IHRhcmdldEdyb3VwLmlzUGV0ZXJQYXJrR3JvdXApIHsKICAgICAgICAgICAgICBncm91cEluZGV4ID0gdGFyZ2V0R3JvdXAgJiYgdGFyZ2V0R3JvdXAuaXNQZXRlclBhcmtHcm91cCA/IGdyb3VwSW5kZXggKyAxIDogZ3JvdXBJbmRleDsKICAgICAgICAgICAgICB0YXJnZXRHcm91cCA9IHN0YXRlLmdyb3Vwc1tncm91cEluZGV4XTsKICAgICAgICAgICAgICBpZiAoIXRhcmdldEdyb3VwKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRHcm91cCA9IHsgaWQ6IHN0YXRlLm5leHRHcm91cElkKyssIG1heFNpemU6IHN0YXRlLm1heEdyb3VwU2l6ZSwgcGxheWVyczogW10sIGlzUGV0ZXJQYXJrR3JvdXA6IGZhbHNlIH07CiAgICAgICAgICAgICAgICBzdGF0ZS5ncm91cHMucHVzaCh0YXJnZXRHcm91cCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGFyZ2V0R3JvdXAucGxheWVycy5sZW5ndGggPj0gdGFyZ2V0R3JvdXAubWF4U2l6ZSkgewogICAgICAgICAgICAgIGdyb3VwSW5kZXgrKzsKICAgICAgICAgICAgICB0YXJnZXRHcm91cCA9IHN0YXRlLmdyb3Vwc1tncm91cEluZGV4XTsKICAgICAgICAgICAgICBpZiAoIXRhcmdldEdyb3VwIHx8IHRhcmdldEdyb3VwLmlzUGV0ZXJQYXJrR3JvdXApIHsKICAgICAgICAgICAgICAgIGdyb3VwSW5kZXggPSB0YXJnZXRHcm91cCAmJiB0YXJnZXRHcm91cC5pc1BldGVyUGFya0dyb3VwID8gZ3JvdXBJbmRleCArIDEgOiBncm91cEluZGV4OwogICAgICAgICAgICAgICAgdGFyZ2V0R3JvdXAgPSBzdGF0ZS5ncm91cHNbZ3JvdXBJbmRleF07CiAgICAgICAgICAgICAgICBpZiAoIXRhcmdldEdyb3VwKSB7CiAgICAgICAgICAgICAgICAgIHRhcmdldEdyb3VwID0geyBpZDogc3RhdGUubmV4dEdyb3VwSWQrKywgbWF4U2l6ZTogc3RhdGUubWF4R3JvdXBTaXplLCBwbGF5ZXJzOiBbXSwgaXNQZXRlclBhcmtHcm91cDogZmFsc2UgfTsKICAgICAgICAgICAgICAgICAgc3RhdGUuZ3JvdXBzLnB1c2godGFyZ2V0R3JvdXApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGFyZ2V0R3JvdXAucGxheWVycy5wdXNoKGdvbGZlci5pZCk7CiAgICAgICAgICAgIGdvbGZlci5ncm91cCA9IHRhcmdldEdyb3VwLmlkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAKICAgICAgcmVuZGVyQWxsVGFicygpOwogICAgICB1cGRhdGVUZWVUaW1lU2NoZWR1bGUoKTsKICAgICAgc2hvd05vdGlmaWNhdGlvbihgUGxheWVycyBwYWlyZWQgdXNpbmcgJHtzdHJhdGVneX0gc3RyYXRlZ3kgKFBldGVyIFBhcmsgcmVtYWlucyBpbiBoaXMgZ3JvdXApYCwgJ3N1Y2Nlc3MnKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzaW11bGF0ZUpvaW5pbmdQZXRlcigpIHsKICAgICAgLy8gRmluZCBhbiB1bmFzc2lnbmVkIGdvbGZlciBvciB0YWtlIGZyb20gYW5vdGhlciBncm91cAogICAgICBjb25zdCB1bmFzc2lnbmVkR29sZmVycyA9IHN0YXRlLmdvbGZlcnMuZmlsdGVyKGcgPT4gZy5ncm91cCA9PT0gbnVsbCAmJiBnLmlkICE9PSBzdGF0ZS5jdXJyZW50VXNlci5pZCk7CiAgICAgIGxldCBnb2xmZXJUb01vdmU7CiAgICAgIAogICAgICBpZiAodW5hc3NpZ25lZEdvbGZlcnMubGVuZ3RoID4gMCkgewogICAgICAgIGdvbGZlclRvTW92ZSA9IHVuYXNzaWduZWRHb2xmZXJzWzBdOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIEZpbmQgYSBnb2xmZXIgZnJvbSBhbm90aGVyIGdyb3VwCiAgICAgICAgY29uc3Qgb3RoZXJHcm91cHMgPSBzdGF0ZS5ncm91cHMuZmlsdGVyKGcgPT4gIWcuaXNQZXRlclBhcmtHcm91cCAmJiBnLnBsYXllcnMubGVuZ3RoID4gMCk7CiAgICAgICAgaWYgKG90aGVyR3JvdXBzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IHJhbmRvbUdyb3VwID0gb3RoZXJHcm91cHNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogb3RoZXJHcm91cHMubGVuZ3RoKV07CiAgICAgICAgICBjb25zdCBwbGF5ZXJJZCA9IHJhbmRvbUdyb3VwLnBsYXllcnNbMF07CiAgICAgICAgICBnb2xmZXJUb01vdmUgPSBzdGF0ZS5nb2xmZXJzLmZpbmQoZyA9PiBnLmlkID09PSBwbGF5ZXJJZCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIAogICAgICBpZiAoZ29sZmVyVG9Nb3ZlKSB7CiAgICAgICAgLy8gTW92ZSB0byBQZXRlcidzIGdyb3VwCiAgICAgICAgY29uc3QgcGV0ZXJHcm91cCA9IHN0YXRlLmdyb3Vwcy5maW5kKGcgPT4gZy5pc1BldGVyUGFya0dyb3VwKTsKICAgICAgICBpZiAocGV0ZXJHcm91cCAmJiBwZXRlckdyb3VwLnBsYXllcnMubGVuZ3RoIDwgcGV0ZXJHcm91cC5tYXhTaXplKSB7CiAgICAgICAgICAvLyBSZW1vdmUgZnJvbSBjdXJyZW50IGdyb3VwCiAgICAgICAgICBpZiAoZ29sZmVyVG9Nb3ZlLmdyb3VwKSB7CiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRHcm91cCA9IHN0YXRlLmdyb3Vwcy5maW5kKGcgPT4gZy5pZCA9PT0gZ29sZmVyVG9Nb3ZlLmdyb3VwKTsKICAgICAgICAgICAgaWYgKGN1cnJlbnRHcm91cCkgewogICAgICAgICAgICAgIGN1cnJlbnRHcm91cC5wbGF5ZXJzID0gY3VycmVudEdyb3VwLnBsYXllcnMuZmlsdGVyKGlkID0+IGlkICE9PSBnb2xmZXJUb01vdmUuaWQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAKICAgICAgICAgIC8vIEFkZCB0byBQZXRlcidzIGdyb3VwCiAgICAgICAgICBwZXRlckdyb3VwLnBsYXllcnMucHVzaChnb2xmZXJUb01vdmUuaWQpOwogICAgICAgICAgZ29sZmVyVG9Nb3ZlLmdyb3VwID0gcGV0ZXJHcm91cC5pZDsKICAgICAgICAgIAogICAgICAgICAgcmVuZGVyQWxsVGFicygpOwogICAgICAgICAgc2hvd05vdGlmaWNhdGlvbihgJHtnb2xmZXJUb01vdmUubmFtZX0gaGFzIGpvaW5lZCBQZXRlciBQYXJrJ3MgZ3JvdXBgLCAnc3VjY2VzcycpOwogICAgICAgICAgCiAgICAgICAgICAvLyBTaG93IHJlYWwtdGltZSBhbGVydAogICAgICAgICAgc2hvd1JlYWxUaW1lQWxlcnQoYCR7Z29sZmVyVG9Nb3ZlLm5hbWV9IGhhcyBqb2luZWQgeW91ciBncm91cCFgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2hvd05vdGlmaWNhdGlvbigiUGV0ZXIgUGFyaydzIGdyb3VwIGlzIGZ1bGwiLCAnZXJyb3InKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2hvd05vdGlmaWNhdGlvbigiTm8gZ29sZmVycyBhdmFpbGFibGUgdG8gam9pbiBQZXRlcidzIGdyb3VwIiwgJ2Vycm9yJyk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBzaW11bGF0ZVJlYWxUaW1lQWN0aXZpdHkoKSB7CiAgICAgIC8vIFNpbXVsYXRlIHJlYWwtdGltZSBwYWlyaW5nIHJlcXVlc3RzIGFuZCBqb2luaW5nCiAgICAgIHNldEludGVydmFsKCgpID0+IHsKICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNykgewogICAgICAgICAgLy8gU29tZXRpbWVzIHNpbXVsYXRlIHNvbWVvbmUgam9pbmluZyBQZXRlcidzIGdyb3VwCiAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNSkgewogICAgICAgICAgICBzaW11bGF0ZUpvaW5pbmdQZXRlcigpOwogICAgICAgICAgfSAKICAgICAgICAgIC8vIE90aGVyIHRpbWVzIHNpbXVsYXRlIGEgcGFpcmluZyByZXF1ZXN0CiAgICAgICAgICBlbHNlIGlmIChzdGF0ZS5nb2xmZXJzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgLy8gU2VsZWN0IGEgcmFuZG9tIGdvbGZlciAobm90IFBldGVyKQogICAgICAgICAgICBjb25zdCBvdGhlckdvbGZlcnMgPSBzdGF0ZS5nb2xmZXJzLmZpbHRlcihnID0+IGcuaWQgIT09IHN0YXRlLmN1cnJlbnRVc2VyLmlkKTsKICAgICAgICAgICAgaWYgKG90aGVyR29sZmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgY29uc3QgcmFuZG9tR29sZmVyID0gb3RoZXJHb2xmZXJzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIG90aGVyR29sZmVycy5sZW5ndGgpXTsKICAgICAgICAgICAgICBzaG93UmVhbFRpbWVBbGVydChgJHtyYW5kb21Hb2xmZXIubmFtZX0gd291bGQgbGlrZSB0byBiZSBwYWlyZWQgd2l0aCB5b3UhYCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIDEwMDAwKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzaG93Tm90aWZpY2F0aW9uKG1lc3NhZ2UsIHR5cGUgPSAnaW5mbycpIHsKICAgICAgY29uc3Qgbm90aWZpY2F0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgIG5vdGlmaWNhdGlvbi5jbGFzc05hbWUgPSBgbm90aWZpY2F0aW9uICR7dHlwZSA9PT0gJ2Vycm9yJyA/ICdib3JkZXItcmVkLTUwMCBiZy1yZWQtNTAgdGV4dC1yZWQtODAwJyA6IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPT09ICdzdWNjZXNzJyA/ICdib3JkZXItZ3JlZW4tNTAwIGJnLWdyZWVuLTUwIHRleHQtZ3JlZW4tODAwJyA6IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdib3JkZXItYmx1ZS01MDAgYmctYmx1ZS01MCB0ZXh0LWJsdWUtODAwJ31gOwogICAgICBub3RpZmljYXRpb24uaW5uZXJIVE1MID0gYAogICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGdhcDogOHB4OyI+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyI+JHttZXNzYWdlfTwvZGl2PgogICAgICAgICAgPGJ1dHRvbiBvbmNsaWNrPSJ0aGlzLnBhcmVudEVsZW1lbnQucGFyZW50RWxlbWVudC5yZW1vdmUoKSIgc3R5bGU9InBhZGRpbmc6IDJweCA2cHg7IGJvcmRlci1yYWRpdXM6IDRweDsgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjEpOyI+w5c8L2J1dHRvbj4KICAgICAgICA8L2Rpdj4KICAgICAgYDsKICAgICAgCiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobm90aWZpY2F0aW9uKTsKICAgICAgc2V0VGltZW91dCgoKSA9PiBub3RpZmljYXRpb24uY2xhc3NMaXN0LmFkZCgnc2hvdycpLCAxMDApOwogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBub3RpZmljYXRpb24uY2xhc3NMaXN0LnJlbW92ZSgnc2hvdycpOwogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gbm90aWZpY2F0aW9uLnJlbW92ZSgpLCAzMDApOwogICAgICB9LCAzMDAwKTsKICAgIH0KCiAgICAvLyBFbmhhbmNlZCBwYWlyaW5nIGZ1bmN0aW9uYWxpdHkKICAgIGZ1bmN0aW9uIGluaXRFbmhhbmNlZFBhaXJpbmdTeXN0ZW0oKSB7CiAgICAgIC8vIEFkZCBldmVudCBsaXN0ZW5lcnMgZm9yIG5ldyBidXR0b25zCiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdvcHRpbWl6ZS1wYWlyaW5ncy1idG4nKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgIG9wdGltaXplUGFpcmluZ3MoKTsKICAgICAgfSk7CiAgICAgIAogICAgICAvLyBVcGRhdGUgdGhlIHNtYXJ0IHBhaXJpbmcgdG8gaW5jbHVkZSB0aGUgbmV3IHByZWZlcmVuY2UtYmFzZWQgYWxnb3JpdGhtCiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzbWFydC1wYWlyLWJ0bicpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3Qgc3RyYXRlZ3kgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFpcmluZy1zdHJhdGVneScpLnZhbHVlOwogICAgICAgIHNtYXJ0UGFpcmluZyhzdHJhdGVneSk7CiAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIG9wdGltaXplUGFpcmluZ3MoKSB7CiAgICAgIC8vIEZpcnN0LCBtb3ZlIGFsbCBwbGF5ZXJzIHRvIHVuYXNzaWduZWQgKGV4Y2VwdCBQZXRlciBQYXJrKQogICAgICBzdGF0ZS5nb2xmZXJzLmZvckVhY2goZ29sZmVyID0+IHsKICAgICAgICBpZiAoZ29sZmVyLmlkICE9PSBzdGF0ZS5jdXJyZW50VXNlci5pZCkgewogICAgICAgICAgZ29sZmVyLmdyb3VwID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAKICAgICAgc3RhdGUuZ3JvdXBzLmZvckVhY2goZ3JvdXAgPT4gewogICAgICAgIGlmICghZ3JvdXAuaXNQZXRlclBhcmtHcm91cCkgewogICAgICAgICAgZ3JvdXAucGxheWVycyA9IFtdOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIAogICAgICAvLyBHZXQgYWxsIGdvbGZlcnMgZXhjZXB0IFBldGVyCiAgICAgIGNvbnN0IGdvbGZlcnMgPSBzdGF0ZS5nb2xmZXJzLmZpbHRlcihnID0+IGcuaWQgIT09IHN0YXRlLmN1cnJlbnRVc2VyLmlkKTsKICAgICAgCiAgICAgIC8vIFNvcnQgYnkgaGFuZGljYXAgZm9yIGJldHRlciBkaXN0cmlidXRpb24KICAgICAgZ29sZmVycy5zb3J0KChhLCBiKSA9PiBhLmhjcCAtIGIuaGNwKTsKICAgICAgCiAgICAgIC8vIENyZWF0ZSBvcHRpbWl6ZWQgZ3JvdXBzIHVzaW5nIGEgbW9yZSBhZHZhbmNlZCBhbGdvcml0aG0KICAgICAgY29uc3QgZ3JvdXBDb3VudCA9IE1hdGguY2VpbChnb2xmZXJzLmxlbmd0aCAvIHN0YXRlLm1heEdyb3VwU2l6ZSk7CiAgICAgIAogICAgICAvLyBJbml0aWFsaXplIGVtcHR5IGdyb3VwcyBpZiBuZWVkZWQKICAgICAgd2hpbGUgKHN0YXRlLmdyb3Vwcy5maWx0ZXIoZyA9PiAhZy5pc1BldGVyUGFya0dyb3VwKS5sZW5ndGggPCBncm91cENvdW50KSB7CiAgICAgICAgc3RhdGUuZ3JvdXBzLnB1c2goewogICAgICAgICAgaWQ6IHN0YXRlLm5leHRHcm91cElkKyssCiAgICAgICAgICBtYXhTaXplOiBzdGF0ZS5tYXhHcm91cFNpemUsCiAgICAgICAgICBwbGF5ZXJzOiBbXSwKICAgICAgICAgIGlzUGV0ZXJQYXJrR3JvdXA6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgCiAgICAgIC8vIEdldCBub24tUGV0ZXIgZ3JvdXBzCiAgICAgIGNvbnN0IGF2YWlsYWJsZUdyb3VwcyA9IHN0YXRlLmdyb3Vwcy5maWx0ZXIoZyA9PiAhZy5pc1BldGVyUGFya0dyb3VwKTsKICAgICAgCiAgICAgIC8vIFVzZSBhIHNuYWtlIGRpc3RyaWJ1dGlvbiBmb3IgYmFsYW5jZWQgaGFuZGljYXBzCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ29sZmVycy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGdyb3VwSW5kZXggPSBpICUgZ3JvdXBDb3VudDsKICAgICAgICBpZiAoZ3JvdXBJbmRleCA8IGF2YWlsYWJsZUdyb3Vwcy5sZW5ndGgpIHsKICAgICAgICAgIGNvbnN0IGdyb3VwID0gYXZhaWxhYmxlR3JvdXBzW2dyb3VwSW5kZXhdOwogICAgICAgICAgaWYgKGdyb3VwLnBsYXllcnMubGVuZ3RoIDwgZ3JvdXAubWF4U2l6ZSkgewogICAgICAgICAgICBncm91cC5wbGF5ZXJzLnB1c2goZ29sZmVyc1tpXS5pZCk7CiAgICAgICAgICAgIGdvbGZlcnNbaV0uZ3JvdXAgPSBncm91cC5pZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgCiAgICAgIC8vIFRyeSB0byBob25vciBwYWlyaW5nIHByZWZlcmVuY2VzIHdoZXJlIHBvc3NpYmxlCiAgICAgIGhvbm9yUGFpcmluZ1ByZWZlcmVuY2VzKCk7CiAgICAgIAogICAgICByZW5kZXJBbGxUYWJzKCk7CiAgICAgIHVwZGF0ZVRlZVRpbWVTY2hlZHVsZSgpOwogICAgICBzaG93Tm90aWZpY2F0aW9uKCdQYWlyaW5ncyBvcHRpbWl6ZWQgd2l0aCBiYWxhbmNlZCBoYW5kaWNhcHMgYW5kIHByZWZlcmVuY2VzJywgJ3N1Y2Nlc3MnKTsKICAgIH0KCiAgICBmdW5jdGlvbiBob25vclBhaXJpbmdQcmVmZXJlbmNlcygpIHsKICAgICAgLy8gU2ltcGxlIGltcGxlbWVudGF0aW9uIHRvIGhvbm9yIHNvbWUgcGFpcmluZyBwcmVmZXJlbmNlcwogICAgICBzdGF0ZS5nb2xmZXJzLmZvckVhY2goZ29sZmVyID0+IHsKICAgICAgICBpZiAoZ29sZmVyLnByZWZlcmVuY2VzICYmIGdvbGZlci5wcmVmZXJlbmNlcy5sZW5ndGggPiAwICYmIGdvbGZlci5ncm91cCkgewogICAgICAgICAgY29uc3QgY3VycmVudEdyb3VwID0gc3RhdGUuZ3JvdXBzLmZpbmQoZyA9PiBnLmlkID09PSBnb2xmZXIuZ3JvdXApOwogICAgICAgICAgCiAgICAgICAgICAvLyBDaGVjayBpZiBhbnkgcHJlZmVycmVkIHBsYXllcnMgYXJlIGluIG90aGVyIGdyb3VwcwogICAgICAgICAgZ29sZmVyLnByZWZlcmVuY2VzLmZvckVhY2gocHJlZklkID0+IHsKICAgICAgICAgICAgY29uc3QgcHJlZmVycmVkR29sZmVyID0gc3RhdGUuZ29sZmVycy5maW5kKGcgPT4gZy5pZCA9PT0gcHJlZklkKTsKICAgICAgICAgICAgaWYgKHByZWZlcnJlZEdvbGZlciAmJiBwcmVmZXJyZWRHb2xmZXIuZ3JvdXAgJiYgcHJlZmVycmVkR29sZmVyLmdyb3VwICE9PSBnb2xmZXIuZ3JvdXApIHsKICAgICAgICAgICAgICBjb25zdCBwcmVmR3JvdXAgPSBzdGF0ZS5ncm91cHMuZmluZChnID0+IGcuaWQgPT09IHByZWZlcnJlZEdvbGZlci5ncm91cCk7CiAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgLy8gSWYgYm90aCBncm91cHMgaGF2ZSBzcGFjZSwgbW92ZSB0aGUgcHJlZmVycmVkIGdvbGZlcgogICAgICAgICAgICAgIGlmIChjdXJyZW50R3JvdXAucGxheWVycy5sZW5ndGggPCBjdXJyZW50R3JvdXAubWF4U2l6ZSAmJiAKICAgICAgICAgICAgICAgICAgcHJlZkdyb3VwLnBsYXllcnMubGVuZ3RoIDw9IHByZWZHcm91cC5tYXhTaXplKSB7CiAgICAgICAgICAgICAgICAvLyBNb3ZlIHByZWZlcnJlZCBnb2xmZXIgdG8gY3VycmVudCBncm91cAogICAgICAgICAgICAgICAgcHJlZkdyb3VwLnBsYXllcnMgPSBwcmVmR3JvdXAucGxheWVycy5maWx0ZXIoaWQgPT4gaWQgIT09IHByZWZlcnJlZEdvbGZlci5pZCk7CiAgICAgICAgICAgICAgICBjdXJyZW50R3JvdXAucGxheWVycy5wdXNoKHByZWZlcnJlZEdvbGZlci5pZCk7CiAgICAgICAgICAgICAgICBwcmVmZXJyZWRHb2xmZXIuZ3JvdXAgPSBjdXJyZW50R3JvdXAuaWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIHVwZGF0ZVRlZVRpbWVTY2hlZHVsZSgpIHsKICAgICAgY29uc3Qgc2NoZWR1bGVCb2R5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RlZS10aW1lLXNjaGVkdWxlJyk7CiAgICAgIGNvbnN0IG5vVGVlVGltZXNNZXNzYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25vLXRlZXRpbWVzLW1lc3NhZ2UnKTsKICAgICAgc2NoZWR1bGVCb2R5LmlubmVySFRNTCA9ICcnOwogICAgICAKICAgICAgLy8gU29ydCBncm91cHMgYnkgSUQgZm9yIGNvbnNpc3RlbnQgb3JkZXJpbmcKICAgICAgY29uc3Qgc29ydGVkR3JvdXBzID0gWy4uLnN0YXRlLmdyb3Vwc10uc29ydCgoYSwgYikgPT4gYS5pZCAtIGIuaWQpOwogICAgICBjb25zdCB0ZWVUaW1lSW50ZXJ2YWwgPSBwYXJzZUludChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGVlLXRpbWUtaW50ZXJ2YWwnKS52YWx1ZSk7CiAgICAgIGxldCBzdGFydFRpbWUgPSBuZXcgRGF0ZSgyMDI1LCA3LCAzMCwgNywgMCk7IC8vIEF1Z3VzdCAzMCwgMjAyNSBhdCA3OjAwIEFNCiAgICAgIAogICAgICBjb25zdCBncm91cHNXaXRoUGxheWVycyA9IHNvcnRlZEdyb3Vwcy5maWx0ZXIoZ3JvdXAgPT4gewogICAgICAgIGNvbnN0IGdyb3VwUGxheWVycyA9IHN0YXRlLmdvbGZlcnMuZmlsdGVyKGcgPT4gZy5ncm91cCA9PT0gZ3JvdXAuaWQpOwogICAgICAgIHJldHVybiBncm91cFBsYXllcnMubGVuZ3RoID4gMDsKICAgICAgfSk7CiAgICAgIAogICAgICBpZiAoZ3JvdXBzV2l0aFBsYXllcnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgbm9UZWVUaW1lc01lc3NhZ2Uuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbm9UZWVUaW1lc01lc3NhZ2Uuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAKICAgICAgICBncm91cHNXaXRoUGxheWVycy5mb3JFYWNoKGdyb3VwID0+IHsKICAgICAgICAgIGNvbnN0IGdyb3VwUGxheWVycyA9IHN0YXRlLmdvbGZlcnMuZmlsdGVyKGcgPT4gZy5ncm91cCA9PT0gZ3JvdXAuaWQpOwogICAgICAgICAgY29uc3QgaGFuZGljYXBzID0gZ3JvdXBQbGF5ZXJzLm1hcChwID0+IHAuaGNwKTsKICAgICAgICAgIGNvbnN0IGF2Z0hjcCA9IChoYW5kaWNhcHMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyBoYW5kaWNhcHMubGVuZ3RoKS50b0ZpeGVkKDEpOwogICAgICAgICAgCiAgICAgICAgICBjb25zdCB0aW1lU3RyaW5nID0gc3RhcnRUaW1lLnRvVGltZVN0cmluZygpLnN1YnN0cmluZygwLCA1KTsKICAgICAgICAgIHN0YXJ0VGltZS5zZXRNaW51dGVzKHN0YXJ0VGltZS5nZXRNaW51dGVzKCkgKyB0ZWVUaW1lSW50ZXJ2YWwpOwogICAgICAgICAgCiAgICAgICAgICBjb25zdCByb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpOwogICAgICAgICAgcm93LmlubmVySFRNTCA9IGAKICAgICAgICAgICAgPHRkIGNsYXNzPSJweC00IHB5LTMgd2hpdGVzcGFjZS1ub3dyYXAiPiR7dGltZVN0cmluZ308L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9InB4LTQgcHktMyB3aGl0ZXNwYWNlLW5vd3JhcCI+JHtncm91cC5pc1BldGVyUGFya0dyb3VwID8gJ1BldGVyIFBhcmsgR3JvdXAnIDogJ0dyb3VwICcgKyBncm91cC5pZH08L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9InB4LTQgcHktMyI+JHtncm91cFBsYXllcnMubWFwKHAgPT4gcC5uYW1lKS5qb2luKCcsICcpfTwvdGQ+CiAgICAgICAgICAgIDx0ZCBjbGFzcz0icHgtNCBweS0zIHdoaXRlc3BhY2Utbm93cmFwIj4ke2F2Z0hjcH08L3RkPgogICAgICAgICAgYDsKICAgICAgICAgIHNjaGVkdWxlQm9keS5hcHBlbmRDaGlsZChyb3cpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY2FsY3VsYXRlR3JvdXBBdmVyYWdlSGNwKHBsYXllcnMpIHsKICAgICAgaWYgKHBsYXllcnMubGVuZ3RoID09PSAwKSByZXR1cm4gMDsKICAgICAgY29uc3Qgc3VtID0gcGxheWVycy5yZWR1Y2UoKHRvdGFsLCBwbGF5ZXIpID0+IHRvdGFsICsgcGxheWVyLmhjcCwgMCk7CiAgICAgIHJldHVybiBzdW0gLyBwbGF5ZXJzLmxlbmd0aDsKICAgIH0KCiAgICBmdW5jdGlvbiBjYWxjdWxhdGVHcm91cEhjcFNwcmVhZChwbGF5ZXJzKSB7CiAgICAgIGlmIChwbGF5ZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIDA7CiAgICAgIGNvbnN0IGhhbmRpY2FwcyA9IHBsYXllcnMubWFwKHAgPT4gcC5oY3ApOwogICAgICByZXR1cm4gTWF0aC5tYXgoLi4uaGFuZGljYXBzKSAtIE1hdGgubWluKC4uLmhhbmRpY2Fwcyk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0UHJlZmVyZW5jZU5hbWVzKHByZWZlcmVuY2VJZHMpIHsKICAgICAgcmV0dXJuIHByZWZlcmVuY2VJZHMubWFwKGlkID0+IHsKICAgICAgICBjb25zdCBnb2xmZXIgPSBzdGF0ZS5nb2xmZXJzLmZpbmQoZyA9PiBnLmlkID09PSBpZCk7CiAgICAgICAgcmV0dXJuIGdvbGZlciA/IGdvbGZlci5uYW1lIDogJ1Vua25vd24nOwogICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiByZW1vdmVHcm91cChncm91cElkKSB7CiAgICAgIGlmIChjb25maXJtKCdBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gcmVtb3ZlIHRoaXMgZ3JvdXA/IEFsbCBwbGF5ZXJzIHdpbGwgYmUgbW92ZWQgdG8gdW5hc3NpZ25lZC4nKSkgewogICAgICAgIGNvbnN0IGdyb3VwID0gc3RhdGUuZ3JvdXBzLmZpbmQoZyA9PiBnLmlkID09PSBncm91cElkKTsKICAgICAgICBpZiAoZ3JvdXApIHsKICAgICAgICAgIC8vIE1vdmUgYWxsIHBsYXllcnMgdG8gdW5hc3NpZ25lZAogICAgICAgICAgZ3JvdXAucGxheWVycy5mb3JFYWNoKHBsYXllcklkID0+IHsKICAgICAgICAgICAgY29uc3QgZ29sZmVyID0gc3RhdGUuZ29sZmVycy5maW5kKGcgPT4gZy5pZCA9PT0gcGxheWVySWQpOwogICAgICAgICAgICBpZiAoZ29sZmVyKSBnb2xmZXIuZ3JvdXAgPSBudWxsOwogICAgICAgICAgfSk7CiAgICAgICAgICAKICAgICAgICAgIC8vIFJlbW92ZSB0aGUgZ3JvdXAKICAgICAgICAgIHN0YXRlLmdyb3VwcyA9IHN0YXRlLmdyb3Vwcy5maWx0ZXIoZyA9PiBnLmlkICE9PSBncm91cElkKTsKICAgICAgICAgIAogICAgICAgICAgcmVuZGVyQWxsVGFicygpOwogICAgICAgICAgc2hvd05vdGlmaWNhdGlvbihgR3JvdXAgJHtncm91cElkfSByZW1vdmVkYCwgJ3N1Y2Nlc3MnKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBwYWlyQnlQcmVmZXJlbmNlcyhnb2xmZXJzKSB7CiAgICAgIC8vIFNpbXBsZSBwcmVmZXJlbmNlLWJhc2VkIHBhaXJpbmcgYWxnb3JpdGhtCiAgICAgIC8vIFRoaXMgaXMgYSBzaW1wbGlmaWVkIHZlcnNpb24gLSBhIHJlYWwgaW1wbGVtZW50YXRpb24gd291bGQgYmUgbW9yZSBjb21wbGV4CiAgICAgIAogICAgICAvLyBGaXJzdCwgcGFpciBnb2xmZXJzIHdobyBoYXZlIG11dHVhbCBwcmVmZXJlbmNlcwogICAgICBjb25zdCBwYWlyZWRJZHMgPSBuZXcgU2V0KCk7CiAgICAgIAogICAgICBnb2xmZXJzLmZvckVhY2goZ29sZmVyID0+IHsKICAgICAgICBpZiAoIXBhaXJlZElkcy5oYXMoZ29sZmVyLmlkKSAmJiBnb2xmZXIucHJlZmVyZW5jZXMgJiYgZ29sZmVyLnByZWZlcmVuY2VzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIC8vIENoZWNrIGlmIGFueSBwcmVmZXJlbmNlcyBhcmUgYWxzbyBub3QgcGFpcmVkIGFuZCBwcmVmZXIgdGhpcyBnb2xmZXIKICAgICAgICAgIGZvciAoY29uc3QgcHJlZklkIG9mIGdvbGZlci5wcmVmZXJlbmNlcykgewogICAgICAgICAgICBjb25zdCBwcmVmZXJyZWRHb2xmZXIgPSBnb2xmZXJzLmZpbmQoZyA9PiBnLmlkID09PSBwcmVmSWQpOwogICAgICAgICAgICBpZiAocHJlZmVycmVkR29sZmVyICYmICFwYWlyZWRJZHMuaGFzKHByZWZlcnJlZEdvbGZlci5pZCkgJiYgCiAgICAgICAgICAgICAgICBwcmVmZXJyZWRHb2xmZXIucHJlZmVyZW5jZXMgJiYgcHJlZmVycmVkR29sZmVyLnByZWZlcmVuY2VzLmluY2x1ZGVzKGdvbGZlci5pZCkpIHsKICAgICAgICAgICAgICAvLyBNdXR1YWwgcHJlZmVyZW5jZSBmb3VuZCAtIHBhaXIgdGhlbSB0b2dldGhlcgogICAgICAgICAgICAgIGNvbnN0IGF2YWlsYWJsZUdyb3VwID0gZmluZEF2YWlsYWJsZUdyb3VwKCk7CiAgICAgICAgICAgICAgaWYgKGF2YWlsYWJsZUdyb3VwKSB7CiAgICAgICAgICAgICAgICBhdmFpbGFibGVHcm91cC5wbGF5ZXJzLnB1c2goZ29sZmVyLmlkLCBwcmVmZXJyZWRHb2xmZXIuaWQpOwogICAgICAgICAgICAgICAgZ29sZmVyLmdyb3VwID0gYXZhaWxhYmxlR3JvdXAuaWQ7CiAgICAgICAgICAgICAgICBwcmVmZXJyZWRHb2xmZXIuZ3JvdXAgPSBhdmFpbGFibGVHcm91cC5pZDsKICAgICAgICAgICAgICAgIHBhaXJlZElkcy5hZGQoZ29sZmVyLmlkKTsKICAgICAgICAgICAgICAgIHBhaXJlZElkcy5hZGQocHJlZmVycmVkR29sZmVyLmlkKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIAogICAgICAvLyBUaGVuLCB0cnkgdG8gaG9ub3Igb25lLXdheSBwcmVmZXJlbmNlcyB3aGVyZSBwb3NzaWJsZQogICAgICBnb2xmZXJzLmZvckVhY2goZ29sZmVyID0+IHsKICAgICAgICBpZiAoIXBhaXJlZElkcy5oYXMoZ29sZmVyLmlkKSAmJiBnb2xmZXIucHJlZmVyZW5jZXMgJiYgZ29sZmVyLnByZWZlcmVuY2VzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGZvciAoY29uc3QgcHJlZklkIG9mIGdvbGZlci5wcmVmZXJlbmNlcykgewogICAgICAgICAgICBjb25zdCBwcmVmZXJyZWRHb2xmZXIgPSBnb2xmZXJzLmZpbmQoZyA9PiBnLmlkID09PSBwcmVmSWQpOwogICAgICAgICAgICBpZiAocHJlZmVycmVkR29sZmVyICYmICFwYWlyZWRJZHMuaGFzKHByZWZlcnJlZEdvbGZlci5pZCkpIHsKICAgICAgICAgICAgICAvLyBDaGVjayBpZiBwcmVmZXJyZWQgZ29sZmVyJ3MgZ3JvdXAgaGFzIHNwYWNlCiAgICAgICAgICAgICAgaWYgKHByZWZlcnJlZEdvbGZlci5ncm91cCkgewogICAgICAgICAgICAgICAgY29uc3QgZ3JvdXAgPSBzdGF0ZS5ncm91cHMuZmluZChnID0+IGcuaWQgPT09IHByZWZlcnJlZEdvbGZlci5ncm91cCk7CiAgICAgICAgICAgICAgICBpZiAoZ3JvdXAgJiYgZ3JvdXAucGxheWVycy5sZW5ndGggPCBncm91cC5tYXhTaXplKSB7CiAgICAgICAgICAgICAgICAgIGdyb3VwLnBsYXllcnMucHVzaChnb2xmZXIuaWQpOwogICAgICAgICAgICAgICAgICBnb2xmZXIuZ3JvdXAgPSBncm91cC5pZDsKICAgICAgICAgICAgICAgICAgcGFpcmVkSWRzLmFkZChnb2xmZXIuaWQpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQm90aCBhcmUgdW5hc3NpZ25lZCAtIHB1dCB0aGVtIGluIGEgbmV3IGdyb3VwCiAgICAgICAgICAgICAgICBjb25zdCBhdmFpbGFibGVHcm91cCA9IGZpbmRBdmFpbGFibGVHcm91cCgpOwogICAgICAgICAgICAgICAgaWYgKGF2YWlsYWJsZUdyb3VwKSB7CiAgICAgICAgICAgICAgICAgIGF2YWlsYWJsZUdyb3VwLnBsYXllcnMucHVzaChnb2xmZXIuaWQsIHByZWZlcnJlZEdvbGZlci5pZCk7CiAgICAgICAgICAgICAgICAgIGdvbGZlci5ncm91cCA9IGF2YWlsYWJsZUdyb3VwLmlkOwogICAgICAgICAgICAgICAgICBwcmVmZXJyZWRHb2xmZXIuZ3JvdXAgPSBhdmFpbGFibGVHcm91cC5pZDsKICAgICAgICAgICAgICAgICAgcGFpcmVkSWRzLmFkZChnb2xmZXIuaWQpOwogICAgICAgICAgICAgICAgICBwYWlyZWRJZHMuYWRkKHByZWZlcnJlZEdvbGZlci5pZCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIAogICAgICAvLyBGaW5hbGx5LCBhc3NpZ24gYW55IHJlbWFpbmluZyBnb2xmZXJzIHRvIGdyb3VwcwogICAgICBjb25zdCB1bmFzc2lnbmVkID0gZ29sZmVycy5maWx0ZXIoZyA9PiAhcGFpcmVkSWRzLmhhcyhnLmlkKSk7CiAgICAgIGxldCBncm91cEluZGV4ID0gMDsKICAgICAgCiAgICAgIGZvciAoY29uc3QgZ29sZmVyIG9mIHVuYXNzaWduZWQpIHsKICAgICAgICBsZXQgdGFyZ2V0R3JvdXAgPSBzdGF0ZS5ncm91cHNbZ3JvdXBJbmRleF07CiAgICAgICAgLy8gU2tpcCBQZXRlciBQYXJrJ3MgZ3JvdXAgZm9yIGRpc3RyaWJ1dGlvbgogICAgICAgIGlmICghdGFyZ2V0R3JvdXAgfHwgdGFyZ2V0R3JvdXAuaXNQZXRlclBhcmtHcm91cCkgewogICAgICAgICAgZ3JvdXBJbmRleCA9IHRhcmdldEdyb3VwICYmIHRhcmdldEdyb3VwLmlzUGV0ZXJQYXJrR3JvdXAgPyBncm91cEluZGV4ICsgMSA6IGdyb3VwSW5kZXg7CiAgICAgICAgICB0YXJnZXRHcm91cCA9IHN0YXRlLmdyb3Vwc1tncm91cEluZGV4XTsKICAgICAgICAgIGlmICghdGFyZ2V0R3JvdXApIHsKICAgICAgICAgICAgdGFyZ2V0R3JvdXAgPSB7IGlkOiBzdGF0ZS5uZXh0R3JvdXBJZCsrLCBtYXhTaXplOiBzdGF0ZS5tYXhHcm91cFNpemUsIHBsYXllcnM6IFtdLCBpc1BldGVyUGFya0dyb3VwOiBmYWxzZSB9OwogICAgICAgICAgICBzdGF0ZS5ncm91cHMucHVzaCh0YXJnZXRHcm91cCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICh0YXJnZXRHcm91cC5wbGF5ZXJzLmxlbmd0aCA+PSB0YXJnZXRHcm91cC5tYXhTaXplKSB7CiAgICAgICAgICBncm91cEluZGV4Kys7CiAgICAgICAgICB0YXJnZXRHcm91cCA9IHN0YXRlLmdyb3Vwc1tncm91cEluZGV4XTsKICAgICAgICAgIGlmICghdGFyZ2V0R3JvdXAgfHwgdGFyZ2V0R3JvdXAuaXNQZXRlclBhcmtHcm91cCkgewogICAgICAgICAgICBncm91cEluZGV4ID0gdGFyZ2V0R3JvdXAgJiYgdGFyZ2V0R3JvdXAuaXNQZXRlclBhcmtHcm91cCA/IGdyb3VwSW5kZXggKyAxIDogZ3JvdXBJbmRleDsKICAgICAgICAgICAgdGFyZ2V0R3JvdXAgPSBzdGF0ZS5ncm91cHNbZ3JvdXBJbmRleF07CiAgICAgICAgICAgIGlmICghdGFyZ2V0R3JvdXApIHsKICAgICAgICAgICAgICB0YXJnZXRHcm91cCA9IHsgaWQ6IHN0YXRlLm5leHRHcm91cElkKyssIG1heFNpemU6IHN0YXRlLm1heEdyb3VwU2l6ZSwgcGxheWVyczogW10sIGlzUGV0ZXJQYXJrR3JvdXA6IGZhbHNlIH07CiAgICAgICAgICAgICAgc3RhdGUuZ3JvdXBzLnB1c2godGFyZ2V0R3JvdXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRhcmdldEdyb3VwLnBsYXllcnMucHVzaChnb2xmZXIuaWQpOwogICAgICAgIGdvbGZlci5ncm91cCA9IHRhcmdldEdyb3VwLmlkOwogICAgICAgIHBhaXJlZElkcy5hZGQoZ29sZmVyLmlkKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGZpbmRBdmFpbGFibGVHcm91cCgpIHsKICAgICAgLy8gRmluZCBhIGdyb3VwIHRoYXQgaGFzIHNwYWNlLCBvciBjcmVhdGUgYSBuZXcgb25lCiAgICAgIGZvciAoY29uc3QgZ3JvdXAgb2Ygc3RhdGUuZ3JvdXBzKSB7CiAgICAgICAgaWYgKCFncm91cC5pc1BldGVyUGFya0dyb3VwICYmIGdyb3VwLnBsYXllcnMubGVuZ3RoIDwgZ3JvdXAubWF4U2l6ZSkgewogICAgICAgICAgcmV0dXJuIGdyb3VwOwogICAgICAgIH0KICAgICAgfQogICAgICAKICAgICAgLy8gTm8gYXZhaWxhYmxlIGdyb3VwIGZvdW5kLCBjcmVhdGUgYSBuZXcgb25lCiAgICAgIGNvbnN0IG5ld0dyb3VwID0gewogICAgICAgIGlkOiBzdGF0ZS5uZXh0R3JvdXBJZCsrLAogICAgICAgIG1heFNpemU6IHN0YXRlLm1heEdyb3VwU2l6ZSwKICAgICAgICBwbGF5ZXJzOiBbXSwKICAgICAgICBpc1BldGVyUGFya0dyb3VwOiBmYWxzZQogICAgICB9OwogICAgICBzdGF0ZS5ncm91cHMucHVzaChuZXdHcm91cCk7CiAgICAgIHJldHVybiBuZXdHcm91cDsKICAgIH0KCiAgICAvLyBTZWFyY2ggZnVuY3Rpb25hbGl0eQogICAgZnVuY3Rpb24gaW5pdFNlYXJjaEZ1bmN0aW9uYWxpdHkoKSB7CiAgICAgIGNvbnN0IHNlYXJjaElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BhcnRpY2lwYW50LXNlYXJjaCcpOwogICAgICAKICAgICAgc2VhcmNoSW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBmdW5jdGlvbigpIHsKICAgICAgICByZW5kZXJQYXJ0aWNpcGFudHNUYWIoKTsKICAgICAgfSk7CiAgICAgIAogICAgICAvLyBBZGQgY2xlYXIgYnV0dG9uIGZ1bmN0aW9uYWxpdHkKICAgICAgc2VhcmNoSW5wdXQuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGZ1bmN0aW9uKGUpIHsKICAgICAgICBpZiAoZS5rZXkgPT09ICdFc2NhcGUnKSB7CiAgICAgICAgICBzZWFyY2hJbnB1dC52YWx1ZSA9ICcnOwogICAgICAgICAgcmVuZGVyUGFydGljaXBhbnRzVGFiKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICA8L3NjcmlwdD4KCgoKCgoKCjwhLS0gPT09IFRlZSBTaGVldCBJbmxpbmUgUHJpbnQgdjkgKHNhbWUtd2luZG93IHByaW50KSArIEVTQyBicmlkZ2UgPT09IC0tPgo8c2NyaXB0PgooZnVuY3Rpb24oKXsKICBpZiAod2luZG93Ll9fdGVlX3ByaW50X2lubGluZV92OSkgcmV0dXJuOyB3aW5kb3cuX190ZWVfcHJpbnRfaW5saW5lX3Y5ID0gdHJ1ZTsKCiAgLy8gRVNDIGluc2lkZSBpZnJhbWUgY2xvc2VzIG92ZXJsYXkKICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGZ1bmN0aW9uKGUpewogICAgaWYgKGUua2V5ID09PSAnRXNjYXBlJyl7CiAgICAgIHRyeXsgd2luZG93LnBhcmVudCAmJiB3aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKCdjbG9zZS1wYWlyaW5ncy1lc2MnLCAnKicpOyB9Y2F0Y2goXyl7fQogICAgfQogIH0sIHRydWUpOwoKICBmdW5jdGlvbiBsb29rc0xpa2VUZWVTaGVldFRhYmxlKHRiKXsKICAgIGlmICghdGIgfHwgIXRiLnF1ZXJ5U2VsZWN0b3IpIHJldHVybiBmYWxzZTsKICAgIHZhciBoZHJzID0gQXJyYXkucHJvdG90eXBlLm1hcC5jYWxsKHRiLnF1ZXJ5U2VsZWN0b3JBbGwoJ3RoZWFkIHRoLCB0aGVhZCB0ZCcpLCBmdW5jdGlvbihlbCl7CiAgICAgIHJldHVybiAoZWwudGV4dENvbnRlbnR8fCcnKS50cmltKCkudG9Mb3dlckNhc2UoKTsKICAgIH0pOwogICAgaWYgKCFoZHJzLmxlbmd0aCkgcmV0dXJuIGZhbHNlOwogICAgdmFyIGhhc1RpbWUgPSBoZHJzLnNvbWUoZnVuY3Rpb24oaCl7IHJldHVybiBoLmluZGV4T2YoJ3RlZSB0aW1lJykhPT0tMSB8fCAoaC5pbmRleE9mKCd0aW1lJykhPT0tMSAmJiBoZHJzWzBdPT09aCk7IH0pOwogICAgdmFyIGhhc0dyb3VwID0gaGRycy5zb21lKGZ1bmN0aW9uKGgpeyByZXR1cm4gL2dyb3VwLy50ZXN0KGgpOyB9KTsKICAgIHZhciBoYXNQbGF5ZXJzID0gaGRycy5zb21lKGZ1bmN0aW9uKGgpeyByZXR1cm4gL3BsYXllcnM/Ly50ZXN0KGgpOyB9KTsKICAgIHJldHVybiAoaGFzVGltZSB8fCAoKGhkcnNbMF18fCcnKS5pbmRleE9mKCd0aW1lJykhPT0tMSkpICYmIGhhc0dyb3VwICYmIGhhc1BsYXllcnM7CiAgfQoKICBmdW5jdGlvbiBmaW5kVGVlU2hlZXRUYWJsZSgpewogICAgdmFyIGFsbCA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ3RhYmxlJykpOwogICAgZm9yICh2YXIgaT0wO2k8YWxsLmxlbmd0aDtpKyspewogICAgICB2YXIgdCA9IGFsbFtpXTsKICAgICAgaWYgKGxvb2tzTGlrZVRlZVNoZWV0VGFibGUodCkgJiYgd2luZG93LmdldENvbXB1dGVkU3R5bGUodCkuZGlzcGxheSAhPT0gJ25vbmUnKSByZXR1cm4gdDsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KCiAgZnVuY3Rpb24gZW5zdXJlSW5saW5lQnRuKCl7CiAgICB0cnl7CiAgICAgIHZhciB0ID0gZmluZFRlZVNoZWV0VGFibGUoKTsgaWYgKCF0KSByZXR1cm47CiAgICAgIHZhciBjb250YWluZXIgPSB0LmNsb3Nlc3QoJ3NlY3Rpb24sZGl2LGFydGljbGUnKSB8fCB0LnBhcmVudEVsZW1lbnQ7CiAgICAgIGlmICghY29udGFpbmVyIHx8IGNvbnRhaW5lci5fX3RlZUlubGluZUJ0bikgcmV0dXJuOwogICAgICBjb250YWluZXIuX190ZWVJbmxpbmVCdG4gPSB0cnVlOwoKICAgICAgdmFyIGJhciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICBiYXIuc3R5bGUuY3NzVGV4dCA9ICdkaXNwbGF5OmZsZXg7anVzdGlmeS1jb250ZW50OmZsZXgtZW5kO2dhcDo4cHg7bWFyZ2luOjhweCAwJzsKCiAgICAgIHZhciBidG4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdidXR0b24nKTsKICAgICAgYnRuLnR5cGUgPSAnYnV0dG9uJzsKICAgICAgYnRuLmNsYXNzTmFtZSA9ICdweC00IHB5LTIgYmctaW5kaWdvLTYwMCB0ZXh0LXdoaXRlIHJvdW5kZWQtbWQgdGV4dC1zbSBmb250LW1lZGl1bSBob3ZlcjpiZy1pbmRpZ28tNzAwJzsKICAgICAgYnRuLnRleHRDb250ZW50ID0gJ1ByaW50IFRlZSBTaGVldCc7CiAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKCl7CiAgICAgICAgdHJ5ewogICAgICAgICAgdmFyIHRhYmxlID0gZmluZFRlZVNoZWV0VGFibGUoKTsgaWYgKCF0YWJsZSkgcmV0dXJuOwogICAgICAgICAgdmFyIHRhcmdldCA9IHRhYmxlLmNsb3Nlc3QoJ3NlY3Rpb24sZGl2LGFydGljbGUnKSB8fCB0YWJsZS5wYXJlbnRFbGVtZW50OwoKICAgICAgICAgIC8vIEJ1aWxkL2F0dGFjaCBhIHByaW50LW9ubHkgc3R5bGVzaGVldAogICAgICAgICAgdmFyIHN0eWxlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ19fdGVlX3ByaW50X2NzcycpOwogICAgICAgICAgaWYgKCFzdHlsZSl7CiAgICAgICAgICAgIHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTsKICAgICAgICAgICAgc3R5bGUuaWQgPSAnX190ZWVfcHJpbnRfY3NzJzsKICAgICAgICAgICAgc3R5bGUudHlwZSA9ICd0ZXh0L2Nzcyc7CiAgICAgICAgICAgIHN0eWxlLm1lZGlhID0gJ3ByaW50JzsKICAgICAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBbCiAgICAgICAgICAgICAgJ0BwYWdlIHsgc2l6ZTogQTQgcG9ydHJhaXQ7IG1hcmdpbjogMTJtbTsgfScsCiAgICAgICAgICAgICAgJ2JvZHkgKiB7IHZpc2liaWxpdHk6IGhpZGRlbiAhaW1wb3J0YW50OyB9JywKICAgICAgICAgICAgICAnLl9fdGVlUHJpbnRUYXJnZXQsIC5fX3RlZVByaW50VGFyZ2V0ICogeyB2aXNpYmlsaXR5OiB2aXNpYmxlICFpbXBvcnRhbnQ7IH0nLAogICAgICAgICAgICAgICcuX190ZWVQcmludFRhcmdldCB7IHBvc2l0aW9uOiBmaXhlZCAhaW1wb3J0YW50OyBsZWZ0OiAwICFpbXBvcnRhbnQ7IHRvcDogMCAhaW1wb3J0YW50OyB3aWR0aDogMTAwJSAhaW1wb3J0YW50OyBtYXJnaW46IDAgIWltcG9ydGFudDsgdHJhbnNmb3JtOiBub25lICFpbXBvcnRhbnQ7IH0nCiAgICAgICAgICAgIF0uam9pbignXG4nKTsKICAgICAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZSk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gTWFyayB0aGUgdGFyZ2V0IGFzIHByaW50YWJsZQogICAgICAgICAgdGFyZ2V0LmNsYXNzTGlzdC5hZGQoJ19fdGVlUHJpbnRUYXJnZXQnKTsKCiAgICAgICAgICAvLyBHaXZlIHRoZSBicm93c2VyIGEgbW9tZW50IHRvIGFwcGx5IHN0eWxlcywgdGhlbiBwcmludAogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICB0cnl7IHdpbmRvdy5mb2N1cygpOyB9Y2F0Y2goXyl7fQogICAgICAgICAgICB3aW5kb3cucHJpbnQoKTsKICAgICAgICAgIH0sIDApOwoKICAgICAgICAgIC8vIENsZWFudXAgYWZ0ZXIgcHJpbnRpbmcKICAgICAgICAgIHZhciBjbGVhbiA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHRyeXsgdGFyZ2V0LmNsYXNzTGlzdC5yZW1vdmUoJ19fdGVlUHJpbnRUYXJnZXQnKTsgfWNhdGNoKF8pe30KICAgICAgICAgICAgLy8gS2VlcCBzdHlsZSBmb3Igc3Vic2VxdWVudCBwcmludHMKICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2FmdGVycHJpbnQnLCBjbGVhbik7CiAgICAgICAgICB9OwogICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2FmdGVycHJpbnQnLCBjbGVhbik7CiAgICAgICAgICAvLyBGYWxsYmFjayBjbGVhbnVwCiAgICAgICAgICBzZXRUaW1lb3V0KGNsZWFuLCAxNTAwKTsKICAgICAgICB9Y2F0Y2goZSl7IGNvbnNvbGUuZXJyb3IoZSk7IH0KICAgICAgfSk7CgogICAgICB0LnBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKGJhciwgdCk7CiAgICAgIGJhci5hcHBlbmRDaGlsZChidG4pOwogICAgfWNhdGNoKGUpeyAvKiBpZ25vcmUgKi8gfQogIH0KCiAgdmFyIG1vID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZnVuY3Rpb24oKXsgZW5zdXJlSW5saW5lQnRuKCk7IH0pOwogIG1vLm9ic2VydmUoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCB7IGNoaWxkTGlzdDp0cnVlLCBzdWJ0cmVlOnRydWUgfSk7CiAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdsb2FkaW5nJykgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGVuc3VyZUlubGluZUJ0bik7IGVsc2UgZW5zdXJlSW5saW5lQnRuKCk7CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2hhc2hjaGFuZ2UnLCBlbnN1cmVJbmxpbmVCdG4pOwogIHNldEludGVydmFsKGVuc3VyZUlubGluZUJ0biwgMTUwMCk7Cn0pKCk7Cjwvc2NyaXB0PgoKCgo8IS0tIExCIElubGluZSBTdGFycyB2MSAobWluaW1hbCwgaWRlbXBvdGVudCkgLS0+CjxzdHlsZT4KICAubGItc3RhcnthcHBlYXJhbmNlOm5vbmU7Ym9yZGVyOjA7YmFja2dyb3VuZDp0cmFuc3BhcmVudDtwYWRkaW5nOjA7bWFyZ2luLXJpZ2h0OjZweDtjdXJzb3I6cG9pbnRlcjtmb250LXNpemU6MTRweDtsaW5lLWhlaWdodDoxO2NvbG9yOiNjYmQ1ZTF9CiAgLmxiLXN0YXIuZmF2e2NvbG9yOiNmNTllMGJ9Cjwvc3R5bGU+CjxzY3JpcHQ+CihmdW5jdGlvbigpewogIGlmICh3aW5kb3cuX19sYl9pbmxpbmVfc3RhcnNfdjEpIHJldHVybjsgd2luZG93Ll9fbGJfaW5saW5lX3N0YXJzX3YxID0gdHJ1ZTsKICB2YXIgS0VZID0gJ2xiX3N0YXJyZWRfdjEnOwogIGZ1bmN0aW9uIGdldFN0b3JlKCl7IHRyeXtyZXR1cm4gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShLRVkpfHwne30nKX1jYXRjaChfKXtyZXR1cm57fX0gfQogIGZ1bmN0aW9uIHNldFN0b3JlKG0peyB0cnl7bG9jYWxTdG9yYWdlLnNldEl0ZW0oS0VZLCBKU09OLnN0cmluZ2lmeShtKSl9Y2F0Y2goXyl7IH0gfQogIGZ1bmN0aW9uIGV2ZW50S2V5Rm9yKHRhYmxlKXsKICAgIHZhciB3cmFwID0gdGFibGUuY2xvc2VzdCgnc2VjdGlvbixkaXYsYXJ0aWNsZScpIHx8IGRvY3VtZW50LmJvZHk7CiAgICB2YXIgaCA9IHdyYXAucXVlcnlTZWxlY3RvcignW2RhdGEtZXZlbnQtdGl0bGVdLCBoMiwgaDMsIC50ZXh0LXhsLCAudGV4dC1sZywgc3Ryb25nLCBiJyk7CiAgICB2YXIgdCA9IGggPyAoaC50ZXh0Q29udGVudHx8JycpLnRyaW0oKSA6ICdFdmVudCc7CiAgICByZXR1cm4gKHR8fCdFdmVudCcpLnJlcGxhY2UoL1xccysvZywnICcpLnRyaW0oKTsKICB9CiAgZnVuY3Rpb24gaGFzR29sZmVySGVhZGVyKHRhYmxlKXsKICAgIHZhciB0aHMgPSB0YWJsZS5xdWVyeVNlbGVjdG9yQWxsKCd0aGVhZCB0aCwgdGhlYWQgdGQnKTsKICAgIGlmICghdGhzLmxlbmd0aCkgcmV0dXJuIHRydWU7CiAgICBmb3IgKHZhciBpPTA7aTx0aHMubGVuZ3RoO2krKyl7CiAgICAgIGlmICgodGhzW2ldLnRleHRDb250ZW50fHwnJykudHJpbSgpLnRvTG93ZXJDYXNlKCkgPT09ICdnb2xmZXInKSByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgZnVuY3Rpb24gZ29sZmVyQ29sSW5kZXgodGFibGUpewogICAgdmFyIHRocyA9IHRhYmxlLnF1ZXJ5U2VsZWN0b3JBbGwoJ3RoZWFkIHRoLCB0aGVhZCB0ZCcpOwogICAgZm9yICh2YXIgaT0wO2k8dGhzLmxlbmd0aDtpKyspewogICAgICBpZiAoKHRoc1tpXS50ZXh0Q29udGVudHx8JycpLnRyaW0oKS50b0xvd2VyQ2FzZSgpID09PSAnZ29sZmVyJykgcmV0dXJuIGk7CiAgICB9CiAgICByZXR1cm4gMTsKICB9CiAgZnVuY3Rpb24gbG9va3NMaWtlTmFtZSh0eHQpewogICAgdmFyIHQgPSAodHh0fHwnJykudHJpbSgpOwogICAgaWYgKCF0KSByZXR1cm4gZmFsc2U7CiAgICBpZiAoL15bXFwrXFwtXT9cXGQrKFxcLlxcZCspPyQvLnRlc3QodCkpIHJldHVybiBmYWxzZTsKICAgIGlmICgvXltBLVphLXpdLipcXHMrW0EtWmEteicuLV0rJC8udGVzdCh0KSkgcmV0dXJuIHRydWU7CiAgICBpZiAodC5pbmRleE9mKCcoJyk+MCAmJiB0LmluZGV4T2YoJyknKT50LmluZGV4T2YoJygnKSkgcmV0dXJuIHRydWU7CiAgICByZXR1cm4gdC5sZW5ndGggPiAyOwogIH0KICBmdW5jdGlvbiBhcHBseVN0YXJzKHJvb3QpewogICAgdmFyIHRhYmxlcyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKChyb290fHxkb2N1bWVudCkucXVlcnlTZWxlY3RvckFsbCgndGFibGUnKSk7CiAgICB0YWJsZXMuZm9yRWFjaChmdW5jdGlvbih0YWJsZSl7CiAgICAgIHRyeXsKICAgICAgICBpZiAoIWhhc0dvbGZlckhlYWRlcih0YWJsZSkpIHJldHVybjsKICAgICAgICB2YXIgZXYgPSBldmVudEtleUZvcih0YWJsZSk7CiAgICAgICAgdmFyIHN0b3JlID0gZ2V0U3RvcmUoKTsgc3RvcmVbZXZdID0gc3RvcmVbZXZdIHx8IFtdOwogICAgICAgIHZhciBnQ29sID0gZ29sZmVyQ29sSW5kZXgodGFibGUpOwogICAgICAgIHZhciByb3dzID0gdGFibGUucXVlcnlTZWxlY3RvckFsbCgndGJvZHkgdHInKTsKICAgICAgICByb3dzLmZvckVhY2goZnVuY3Rpb24odHIpewogICAgICAgICAgdmFyIHRkcyA9IHRyLnF1ZXJ5U2VsZWN0b3JBbGwoJ3RkJyk7IGlmICghdGRzLmxlbmd0aCkgcmV0dXJuOwogICAgICAgICAgdmFyIGNlbGwgPSB0ZHNbZ0NvbF0gfHwgdGRzWzFdIHx8IHRkc1swXTsKICAgICAgICAgIHZhciBuYW1lID0gKGNlbGwudGV4dENvbnRlbnR8fCcnKS50cmltKCk7CiAgICAgICAgICBpZiAoIWxvb2tzTGlrZU5hbWUobmFtZSkpIHJldHVybjsKICAgICAgICAgIGlmIChjZWxsLnF1ZXJ5U2VsZWN0b3IoJy5sYi1zdGFyJykpIHJldHVybjsKICAgICAgICAgIHZhciBpc0ZhdiA9IHN0b3JlW2V2XS5pbmRleE9mKG5hbWUpICE9PSAtMTsKICAgICAgICAgIHZhciBidG4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdidXR0b24nKTsKICAgICAgICAgIGJ0bi50eXBlID0gJ2J1dHRvbic7CiAgICAgICAgICBidG4uY2xhc3NOYW1lID0gJ2xiLXN0YXInICsgKGlzRmF2PycgZmF2JzonJyk7CiAgICAgICAgICBidG4udGV4dENvbnRlbnQgPSBpc0ZhdiA/ICfimIUnIDogJ+KYhic7CiAgICAgICAgICBidG4udGl0bGUgPSBpc0ZhdiA/ICdVbnN0YXInIDogJ1N0YXInOwogICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24oZSl7CiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIHZhciBzID0gZ2V0U3RvcmUoKTsgc1tldl0gPSBzW2V2XSB8fCBbXTsKICAgICAgICAgICAgdmFyIGkgPSBzW2V2XS5pbmRleE9mKG5hbWUpOwogICAgICAgICAgICBpZiAoaSA9PT0gLTEpeyBzW2V2XS5wdXNoKG5hbWUpOyBidG4uY2xhc3NMaXN0LmFkZCgnZmF2Jyk7IGJ0bi50ZXh0Q29udGVudD0n4piFJzsgYnRuLnRpdGxlPSdVbnN0YXInOyB9CiAgICAgICAgICAgIGVsc2UgeyBzW2V2XS5zcGxpY2UoaSwxKTsgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2ZhdicpOyBidG4udGV4dENvbnRlbnQ9J+KYhic7IGJ0bi50aXRsZT0nU3Rhcic7IH0KICAgICAgICAgICAgc2V0U3RvcmUocyk7CiAgICAgICAgICB9LCB0cnVlKTsKICAgICAgICAgIGNlbGwuaW5zZXJ0QmVmb3JlKGJ0biwgY2VsbC5maXJzdENoaWxkKTsKICAgICAgICAgIHNldFN0b3JlKHN0b3JlKTsKICAgICAgICB9KTsKICAgICAgfWNhdGNoKGUpeyB9CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gcnVuKCl7IGFwcGx5U3RhcnMoZG9jdW1lbnQpOyB9CiAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdsb2FkaW5nJykgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIHJ1bik7IGVsc2UgcnVuKCk7CiAgbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZnVuY3Rpb24oKXsgYXBwbHlTdGFycyhkb2N1bWVudCk7IH0pCiAgICAub2JzZXJ2ZShkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIHsgY2hpbGRMaXN0OnRydWUsIHN1YnRyZWU6dHJ1ZSB9KTsKfSkoKTsKPC9zY3JpcHQ+Cgo8c2NyaXB0PihmdW5jdGlvbigpewppZiAod2luZG93Ll9fbWNwX2lmcmFtZV9iYWNrX21pbl92MykgcmV0dXJuOyB3aW5kb3cuX19tY3BfaWZyYW1lX2JhY2tfbWluX3YzID0gdHJ1ZTsKZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbihlKXsKICB2YXIgYiA9IGUudGFyZ2V0ICYmIGUudGFyZ2V0LmNsb3Nlc3QgPyBlLnRhcmdldC5jbG9zZXN0KCcjc29jLXBhaXJpbmdzLWJhY2snKSA6IG51bGw7CiAgaWYgKCFiKSByZXR1cm47IGUucHJldmVudERlZmF1bHQoKTsKICB0cnkgeyBwYXJlbnQgJiYgcGFyZW50LnBvc3RNZXNzYWdlKHt0eXBlOidtY3BfcGFpcmluZ3NfYmFjayd9LCAnKicpOyB9IGNhdGNoKF8pe30KfSwgZmFsc2UpOwp9KSgpOzwvc2NyaXB0PjwvYm9keT4KPC9odG1sPg=="></iframe>
</div>
</div>
<button id="mcp_pairings_fab" title="Open Pairings (New)" type="button">Pairings (New)</button>
<script>
(function(){
  if (window.__mcp_pairings_overlay_v1) return; window.__mcp_pairings_overlay_v1 = true;
  var overlay = document.getElementById('mcp_pairings_overlay');
  var closeBtn = document.getElementById('mcp_pairings_close');
  var fab = document.getElementById('mcp_pairings_fab');

  function openOverlay(){ overlay.style.display = 'block'; if (fab) fab.style.display = 'none'; }
  function closeOverlay(){ overlay.style.display = 'none'; if (fab) fab.style.display = ''; }

  closeBtn.addEventListener('click', closeOverlay);
  document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeOverlay(); });
  overlay.addEventListener('click', function(e){ if (e.target === overlay) closeOverlay(); });
  fab.addEventListener('click', openOverlay);

  // Rewire "Manage Pairings" triggers globally
  document.addEventListener('click', function(e){
    var t = e.target;
    for (var i=0; i<3 && t; i++, t=t.parentElement){
      if (!t) break;
      var txt = (t.textContent||'').trim().toLowerCase();
      var idc = (t.id||'').toLowerCase();
      var cls = (t.className||'').toLowerCase();
      if (txt.includes('manage pairings') || txt === 'pairings' || idc.includes('pair') || cls.includes('pairings')){
        if (t.tagName === 'BUTTON' || t.tagName === 'A' || cls.includes('btn') || cls.includes('button')){
          e.preventDefault(); e.stopPropagation(); openOverlay(); return;
        }
      }
    }
  }, true);

  // Hash hint
  if (location.hash && /pair/i.test(location.hash)) openOverlay();
})();
</script>
<!-- === MCP Pairings Overlay Close-Fix v1 === -->
<style>
  #mcp_pairings_close { position: absolute; z-index: 100; }
  #mcp_pairings_iframe { position: relative; z-index: 1; }
</style>
<script>
(function(){
  if (window.__mcp_pairings_closefix_v1) return; window.__mcp_pairings_closefix_v1 = true;
  var overlay = document.getElementById('mcp_pairings_overlay');
  var closeBtn = document.getElementById('mcp_pairings_close');
  var fab = document.getElementById('mcp_pairings_fab');
  function closeOverlay(){ if (overlay) overlay.style.display='none'; if (fab) fab.style.display=''; }
  if (closeBtn) closeBtn.onclick = closeOverlay;
  window.addEventListener('message', function(e){
    try{ var msg = (typeof e.data === 'string') ? e.data.toLowerCase() : '';
         if (msg.indexOf('close-pairings') !== -1) closeOverlay(); }catch(_){}
  });
})();
</script>
<!-- === Hide Pairings FAB === -->
<style>
  #mcp_pairings_fab { display: none !important; pointer-events: none !important; visibility: hidden !important; }
</style>
<!-- === Remove Top-Right Close & Disable Backdrop Close === -->
<style>
  #mcp_pairings_close { display: none !important; }
</style>
<script>
(function(){
  if (window.__overlay_close_behavior_v2) return; window.__overlay_close_behavior_v2 = true;
  var overlay = document.getElementById('mcp_pairings_overlay');
  if (!overlay) return;
  // Swallow backdrop clicks so only ESC closes
  function swallow(e){
    try{
      if (e.target === overlay) { e.stopPropagation(); e.preventDefault(); }
    }catch(_){}
  }
  overlay.addEventListener('click', swallow, true); // capture phase to intercept
})();
</script>
<!-- === Parent Overlay Controls v6 (X + ESC + message; no backdrop close) === -->
<script>
(function(){
  if (window.__parent_overlay_v6) return; window.__parent_overlay_v6 = true;
  var overlay = document.getElementById('mcp_pairings_overlay');
  var closeBtn = document.getElementById('mcp_pairings_close');
  function closeOverlay(){ if (overlay) overlay.style.display='none'; }
  if (closeBtn){ closeBtn.style.display=''; closeBtn.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); closeOverlay(); }); }
  // Parent ESC
  window.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeOverlay(); }, true);
  // Message from iframe
  window.addEventListener('message', function(e){
    try{ var d = (typeof e.data === 'string') ? e.data.toLowerCase() : '';
         if (d.indexOf('close-pairings-esc')!==-1 || d.indexOf('close-pairings')!==-1) closeOverlay();
    }catch(_){}
  });
  // Disable backdrop close
  overlay && overlay.addEventListener('click', function(e){ if (e.target === overlay){ e.preventDefault(); e.stopPropagation(); }}, true);
})();
</script>
<script>
/* LIVE_LEADERBOARD_FAVORITES_v1 */
(function(){
  function ready(fn){ if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }

  var KEY = "mc:lb:favs";
  function loadFavs(){
    try { var j = JSON.parse(localStorage.getItem(KEY)||"[]"); if (Array.isArray(j)) return new Set(j); }catch(_){}
    return new Set();
  }
  function saveFavs(set){
    try { localStorage.setItem(KEY, JSON.stringify(Array.from(set))); }catch(_){}
    try { window.dispatchEvent(new CustomEvent('lb:favs:update')); }catch(_){}
  }

  function getNameFromCell(td){
    if (!td) return null;
    // Row cell structure is: <td>[name] <span class="text-[10px] ...">(flight • time)</span></td>
    // So first child text node is the name
    for (var i=0;i<td.childNodes.length;i++){
      var n = td.childNodes[i];
      if (n.nodeType === 3){ // TEXT_NODE
        var name = (n.nodeValue||"").trim();
        if (name) return name;
      }
    }
    // Fallback to stripping text before '('
    var txt = (td.textContent||"").trim();
    var p = txt.indexOf(" (");
    return p>0 ? txt.slice(0,p).trim() : txt;
  }

  function makeStar(name, favs){
    var b = document.createElement('button');
    b.type = 'button';
    b.className = 'lb-star inline-flex items-center justify-center w-5 h-5 rounded hover:bg-amber-50 text-yellow-600';
    b.style.marginRight = '6px';
    b.setAttribute('aria-label', 'Toggle favorite');
    b.dataset.name = name;
    var setFace = function(){ b.textContent = favs.has(name) ? '★' : '☆'; };
    setFace();
    b.addEventListener('click', function(ev){
      ev.stopPropagation();
      var name = this.dataset.name;
      if (favs.has(name)) favs.delete(name); else favs.add(name);
      saveFavs(favs);
      setFace();
      applyFavFilter(); // if filtering is on, update visibility
    });
    return b;
  }

  function wireRowStars(tbody, favs){
    if (!tbody) return;
    // Avoid duplicating stars: remove existing before re-adding
    Array.from(tbody.querySelectorAll('td:nth-child(2) .lb-star')).forEach(function(x){ x.remove(); });
    // Add to each row's 2nd <td> (Golfer column)
    Array.from(tbody.querySelectorAll('tr')).forEach(function(tr){
      var td = tr.querySelector('td:nth-child(2)');
      if (!td) return;
      var name = getNameFromCell(td);
      if (!name) return;
      var star = makeStar(name, favs);
      td.prepend(star);
    });
  }

  function ensureFavToggle(host, favs){
    if (!host || host.querySelector('#favOnly')) return;
    // Drop a compact chip near existing filters bar (host is the live-center-root container)
    var bar = host.querySelector('select#fTime')?.parentElement || host.firstChild;
    var wrap = document.createElement('label');
    wrap.className = 'inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full border bg-white cursor-pointer';
    wrap.style.marginLeft = '6px';
    var cb = document.createElement('input'); cb.type='checkbox'; cb.id='favOnly'; cb.style.marginRight='4px';
    var txt = document.createElement('span'); txt.textContent = 'Favorites only';
    wrap.appendChild(cb); wrap.appendChild(txt);
    // Find a reasonable insertion point
    var filtersRow = host.querySelector('.flex.flex-wrap.items-center.gap-2');
    (filtersRow || host).appendChild(wrap);
    cb.addEventListener('change', applyFavFilter);
  }

  function applyFavFilter(){
    var host = document.getElementById('live-center-root');
    if (!host) return;
    var favs = loadFavs();
    var only = !!(host.querySelector('#favOnly') && host.querySelector('#favOnly').checked);
    ['evA','evB'].forEach(function(id){
      var tb = host.querySelector('#'+id);
      if (!tb) return;
      Array.from(tb.querySelectorAll('tr')).forEach(function(tr){
        if (!only){ tr.style.display=''; return; }
        var td = tr.querySelector('td:nth-child(2)');
        var name = getNameFromCell(td);
        tr.style.display = favs.has(name) ? '' : 'none';
      });
    });
  }

  function boot(){
    var host = document.getElementById('live-center-root');
    if (!host) return;

    var favs = loadFavs();
    ensureFavToggle(host, favs);

    function sync(){
      favs = loadFavs(); // refresh from storage
      wireRowStars(host.querySelector('#evA'), favs);
      wireRowStars(host.querySelector('#evB'), favs);
      applyFavFilter();
    }

    // Initial sync and on updates
    sync();
    window.addEventListener('lb:favs:update', sync);
    window.addEventListener('storage', function(e){ if (e && e.key===KEY) sync(); });

    // Re-apply whenever the tables rerender (the live sim updates innerHTML)
    var mo = new MutationObserver(function(muts){
      var touch = false;
      for (var m of muts){
        if (m.type==='childList'){
          if (m.target && (m.target.id==='evA' || m.target.id==='evB')) { touch = true; break; }
          for (var n of m.addedNodes){
            if (n.nodeType===1 && (n.id==='evA' || n.id==='evB' || n.querySelector && (n.querySelector('#evA') || n.querySelector('#evB')))){ touch=true; break; }
          }
        }
      }
      if (touch) sync();
    });
    mo.observe(host, { childList:true, subtree:true });
  }

  ready(function(){
    // Ensure we attach once the Live center mounts/enhances
    function ensureBoot(){
      var host = document.getElementById('live-center-root');
      if (host && host.dataset && host.dataset.enhanced){ boot(); return true; }
      return false;
    }
    if (!ensureBoot()){
      var iv = setInterval(function(){ if (ensureBoot()) clearInterval(iv); }, 300);
      setTimeout(function(){ clearInterval(iv); ensureBoot(); }, 12000);
    }
    window.addEventListener('hashchange', function(){ if (location.hash==='#live') setTimeout(ensureBoot, 300); });
  });
})();
</script>
<style id="lb-fav-sidebar-style">
/* Sticky favorites sidebar */
#lbFavSidebar { position: fixed; right: 16px; top: 96px; width: 272px; max-height: 80vh;
  overflow: auto; z-index: 60; }
@media (max-width: 1024px){ #lbFavSidebar { display:none; } } /* hide on small screens */
</style>
<script>
/* LIVE_LEADERBOARD_FAV_SIDEBAR_v1 */
(function(){
  var KEY = "mc:lb:favs";
  var OPENKEY = "mc:lb:favs:sidebar:open";
  function loadFavs(){
    try { var j = JSON.parse(localStorage.getItem(KEY)||"[]"); if (Array.isArray(j)) return new Set(j); }catch(_){}
    return new Set();
  }
  function saveFavs(set){
    try { localStorage.setItem(KEY, JSON.stringify(Array.from(set))); }catch(_){}
    try { window.dispatchEvent(new CustomEvent('lb:favs:update')); }catch(_){}
  }
  function getNameFromCell(td){
    if (!td) return null;
    for (var i=0;i<td.childNodes.length;i++){
      var n = td.childNodes[i];
      if (n.nodeType===3){ var t = (n.nodeValue||"").trim(); if (t) return t; }
    }
    var txt = (td.textContent||"").trim();
    var p = txt.indexOf(" (");
    return p>0 ? txt.slice(0,p).trim() : txt;
  }
  function ensureSidebar(){
    if (document.getElementById('lbFavSidebar')) return true;
    var host = document.getElementById('live-center-root');
    if (!host) return false;

    var shell = document.createElement('aside');
    shell.id='lbFavSidebar';
    shell.className='rounded-xl border bg-white shadow-md p-3 space-y-3';
    shell.innerHTML = ''
      + '<div class="flex items-center justify-between">'
      + '  <div class="font-semibold text-sm flex items-center gap-1">⭐ Favorites</div>'
      + '  <div class="flex items-center gap-2">'
      + '    <button id="lbFavCollapse" class="text-xs px-2 py-1 rounded border hover:bg-gray-50">Hide</button>'
      + '  </div>'
      + '</div>'
      + '<div class="text-[11px] text-gray-500">Pinned list updates in real time. Click ★ in the table to add/remove.</div>'
      + '<div class="grid grid-cols-2 gap-2">'
      + '  <div>'
      + '    <div class="text-xs font-medium mb-1">Event A</div>'
      + '    <ul id="lbFavListA" class="space-y-1"></ul>'
      + '  </div>'
      + '  <div>'
      + '    <div class="text-xs font-medium mb-1">Event B</div>'
      + '    <ul id="lbFavListB" class="space-y-1"></ul>'
      + '  </div>'
      + '</div>'
      + '<div class="flex justify-between items-center pt-1">'
      + '  <label class="inline-flex items-center gap-1 text-xs cursor-pointer"><input id="lbFavOnlyMirror" type="checkbox"/><span>Favorites only</span></label>'
      + '  <button id="lbFavClear" class="text-xs text-red-600 hover:text-red-700">Clear all</button>'
      + '</div>';

    document.body.appendChild(shell);

    // Collapse/expand
    var open = localStorage.getItem(OPENKEY);
    if (open === '0') collapse(true);
    document.getElementById('lbFavCollapse').addEventListener('click', function(){ collapse(); });

    function collapse(forceHidden){
      var s = document.getElementById('lbFavSidebar');
      if (!s) return;
      var hidden = forceHidden!=null ? forceHidden : !s.classList.contains('opacity-100');
      if (hidden){
        s.classList.remove('opacity-100'); s.classList.add('opacity-60');
        s.style.width='40px'; s.style.overflow='hidden'; s.style.padding='8px';
        s.title = 'Show favorites';
        document.getElementById('lbFavCollapse').textContent = 'Show';
        localStorage.setItem(OPENKEY,'0');
      } else {
        s.classList.add('opacity-100'); s.classList.remove('opacity-60');
        s.style.width='272px'; s.style.overflow='auto'; s.style.padding='12px';
        s.title='';
        document.getElementById('lbFavCollapse').textContent = 'Hide';
        localStorage.setItem(OPENKEY,'1');
      }
    }

    // Mirror "Favorites only" checkbox from main filter if present
    var mirror = document.getElementById('lbFavOnlyMirror');
    mirror.addEventListener('change', function(){
      var main = document.querySelector('#live-center-root #favOnly');
      if (main){ main.checked = mirror.checked; var evt = new Event('change'); main.dispatchEvent(evt); }
    });

    document.getElementById('lbFavClear').addEventListener('click', function(){
      if (!confirm('Clear all favorites?')) return;
      saveFavs(new Set());
    });

    return true;
  }

  function renderSidebar(){
    var host = document.getElementById('live-center-root');
    if (!host || !ensureSidebar()) return;
    var listA = document.getElementById('lbFavListA');
    var listB = document.getElementById('lbFavListB');
    if (!listA || !listB) return;

    var favs = loadFavs();

    function makeItem(name, meta){
      var li = document.createElement('li');
      li.className='text-xs flex items-start justify-between gap-2 px-2 py-1 rounded hover:bg-gray-50';
      var left = document.createElement('div');
      var n = document.createElement('div'); n.textContent = name; n.className='font-medium';
      var m = document.createElement('div'); m.textContent = meta||''; m.className='text-[10px] text-gray-500';
      left.appendChild(n); left.appendChild(m);
      var un = document.createElement('button'); un.textContent='✕'; un.className='text-[10px] px-1 py-0.5 rounded border hover:bg-red-50 text-red-600';
      un.addEventListener('click', function(){
        // remove from favorites
        var s = loadFavs();
        if (s.has(name)){ s.delete(name); saveFavs(s); }
      });
      li.appendChild(left); li.appendChild(un);
      return li;
    }

    // Fresh rebuild
    listA.innerHTML=''; listB.innerHTML='';

    function harvest(id, ul){
      var tb = host.querySelector('#'+id);
      if (!tb) return;
      Array.from(tb.querySelectorAll('tr')).forEach(function(tr){
        var td = tr.querySelector('td:nth-child(2)');
        if (!td) return;
        var name = getNameFromCell(td);
        if (!name || !favs.has(name)) return;
        var meta = '';
        var sp = td.querySelector('span');
        if (sp) meta = (sp.textContent||'').trim();
        ul.appendChild(makeItem(name, meta));
      });
    }

    harvest('evA', listA);
    harvest('evB', listB);

    // sync the mirror checkbox
    var main = document.querySelector('#live-center-root #favOnly');
    var mirror = document.getElementById('lbFavOnlyMirror');
    if (main && mirror){ mirror.checked = !!main.checked; }
  }

  function hook(){
    // Keep sidebar updated on any favorites or live table mutation
    window.addEventListener('lb:favs:update', renderSidebar);
    var host = document.getElementById('live-center-root');
    if (!host) return;
    var mo = new MutationObserver(function(m){ renderSidebar(); });
    mo.observe(host, { childList:true, subtree:true });
    renderSidebar();
  }

  // Initialize when Live tab is mounted/enhanced
  function ready(fn){ if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    function bootIfLive(){
      var host = document.getElementById('live-center-root');
      if (host && host.dataset && host.dataset.enhanced){
        ensureSidebar(); renderSidebar(); hook(); return true;
      }
      return false;
    }
    if (!bootIfLive()){
      var iv = setInterval(function(){ if (bootIfLive()) clearInterval(iv); }, 400);
      setTimeout(function(){ clearInterval(iv); bootIfLive(); }, 12000);
    }
    window.addEventListener('hashchange', function(){ if (location.hash==='#live') setTimeout(bootIfLive, 300); });
  });
})();
</script>
<style id="lb-fav-sidebar-drag-style">
#lbFavSidebar { cursor: default; }
#lbFavDrag { cursor: grab; user-select: none; }
#lbFavDrag:active { cursor: grabbing; }
</style>
<script>
/* LIVE_LEADERBOARD_FAV_SIDEBAR_DRAG_v2 */
(function(){
  var POSKEY = "mc:lb:favs:sidebar:pos";
  var OPENKEY = "mc:lb:favs:sidebar:open"; // legacy from v1

  function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

  function normalizeSidebar(){
    var side = document.getElementById('lbFavSidebar');
    if (!side) return false;
    // Undo any collapsed state from v1
    side.classList.add('opacity-100'); side.classList.remove('opacity-60');
    side.style.width='272px'; side.style.overflow='auto'; side.style.padding='12px';
    localStorage.setItem(OPENKEY,'1');

    // Replace "Hide" button with a drag handle
    var old = document.getElementById('lbFavCollapse');
    if (old){
      var h = document.createElement('div');
      h.id = 'lbFavDrag';
      h.className = 'text-xs px-2 py-1 rounded border bg-white hover:bg-gray-50';
      h.textContent = 'Drag';
      old.replaceWith(h);
    } else {
      // If not found, ensure there's a handle in header
      var header = side.querySelector(':scope > div');
      if (header && !header.querySelector('#lbFavDrag')){
        var h = document.createElement('div');
        h.id='lbFavDrag';
        h.className='text-xs px-2 py-1 rounded border bg-white hover:bg-gray-50';
        h.textContent='Drag';
        header.appendChild(h);
      }
    }

    // Apply saved position
    try{
      var pos = JSON.parse(localStorage.getItem(POSKEY) || 'null');
      if (pos && typeof pos.left==='number' && typeof pos.top==='number'){
        side.style.right=''; // switch to left/top anchoring for drag
        side.style.left = pos.left + 'px';
        side.style.top  = pos.top  + 'px';
      }
    }catch(_){}

    makeDraggable();
    return true;
  }

  function makeDraggable(){
    var side = document.getElementById('lbFavSidebar');
    var handle = document.getElementById('lbFavDrag') || side;
    if (!side) return;

    var startX, startY, startLeft, startTop, dragging=false;

    function onDown(e){
      dragging = true;
      var rect = side.getBoundingClientRect();
      // switch to left/top coordinates if still using 'right'
      if (!side.style.left){
        side.style.left = rect.left + 'px';
        side.style.right = '';
      }
      startX = e.clientX; startY = e.clientY;
      startLeft = rect.left; startTop = rect.top;
      document.addEventListener('pointermove', onMove);
      document.addEventListener('pointerup', onUp, { once: true });
    }

    function onMove(e){
      if (!dragging) return;
      var dx = e.clientX - startX;
      var dy = e.clientY - startY;
      var rect = side.getBoundingClientRect();
      var vw = window.innerWidth, vh = window.innerHeight;
      var newLeft = clamp(startLeft + dx, 8, vw - rect.width - 8);
      var newTop  = clamp(startTop  + dy, 60, vh - 80);
      side.style.left = newLeft + 'px';
      side.style.top  = newTop  + 'px';
    }

    function onUp(_e){
      dragging = false;
      document.removeEventListener('pointermove', onMove);
      try{
        var rect = side.getBoundingClientRect();
        localStorage.setItem(POSKEY, JSON.stringify({ left: rect.left, top: rect.top }));
      }catch(_){}
    }

    handle.addEventListener('pointerdown', onDown);
  }

  function boot(){
    // If sidebar already exists, normalize immediately; else wait for it
    if (!normalizeSidebar()){
      var iv = setInterval(function(){
        if (normalizeSidebar()) clearInterval(iv);
      }, 300);
      setTimeout(function(){ clearInterval(iv); normalizeSidebar(); }, 12000);
    }
    // Also re-normalize if the Live tab remounts
    window.addEventListener('hashchange', function(){
      if (location.hash === '#live'){
        setTimeout(normalizeSidebar, 400);
      }
    });
  }

  if (document.readyState !== 'loading') boot();
  else document.addEventListener('DOMContentLoaded', boot);
})();
</script>
<style id="lb-fav-sidebar-nohide">
#lbFavCollapse { display: none !important; }
</style>
<script>
/* LIVE_LEADERBOARD_FAV_SIDEBAR_NOHIDE_v1 */
(function(){
  var POSKEY = "mc:lb:favs:sidebar:pos";
  var OPENKEY = "mc:lb:favs:sidebar:open"; // ignore legacy collapses

  function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

  function ensureDragHandle(side){
    if (!side) return;
    var header = side.querySelector(':scope > div');
    if (!header) return;
    var handle = header.querySelector('#lbFavDrag');
    if (!handle){
      handle = document.createElement('div');
      handle.id='lbFavDrag';
      handle.className='text-xs px-2 py-1 rounded border bg-white hover:bg-gray-50';
      handle.textContent='Drag';
      header.appendChild(handle);
    }
    makeDraggable(side, handle);
  }

  function makeDraggable(side, handle){
    var startX, startY, startLeft, startTop, dragging=false;
    handle.onpointerdown = function(e){
      dragging = true;
      var rect = side.getBoundingClientRect();
      if (!side.style.left){ side.style.left = rect.left + 'px'; side.style.right=''; }
      startX = e.clientX; startY = e.clientY;
      startLeft = rect.left; startTop = rect.top;
      function onMove(ev){
        if (!dragging) return;
        var dx = ev.clientX - startX;
        var dy = ev.clientY - startY;
        var r = side.getBoundingClientRect();
        var vw = window.innerWidth, vh = window.innerHeight;
        side.style.left = clamp(startLeft+dx, 8, vw - r.width - 8) + 'px';
        side.style.top  = clamp(startTop +dy, 60, vh - 80) + 'px';
      }
      function onUp(){
        dragging=false;
        document.removeEventListener('pointermove', onMove);
        try{
          var r = side.getBoundingClientRect();
          localStorage.setItem(POSKEY, JSON.stringify({left:r.left, top:r.top}));
        }catch(_){}
      }
      document.addEventListener('pointermove', onMove);
      document.addEventListener('pointerup', onUp, {once:true});
    };
  }

  function normalize(){
    var side = document.getElementById('lbFavSidebar');
    if (!side) return false;

    // Kill any "Hide" control if it exists
    var h = side.querySelector('#lbFavCollapse');
    if (h && h.parentElement){ h.remove(); }
    localStorage.setItem(OPENKEY, '1');
    side.classList.add('opacity-100'); side.classList.remove('opacity-60');
    side.style.width='272px'; side.style.overflow='auto'; if (!side.style.padding) side.style.padding='12px';

    // Restore saved position
    try{
      var pos = JSON.parse(localStorage.getItem(POSKEY) || 'null');
      if (pos && typeof pos.left==='number' && typeof pos.top==='number'){
        side.style.right=''; side.style.left = pos.left+'px'; side.style.top = pos.top+'px';
      }
    }catch(_){}

    ensureDragHandle(side);
    return true;
  }

  function watchdog(){
    // Remove #lbFavCollapse if a render re-inserts it
    var mo = new MutationObserver(function(muts){
      for (var m of muts){
        if (m.type==='childList'){
          var bad = document.querySelector('#lbFavSidebar #lbFavCollapse');
          if (bad){ bad.remove(); }
        }
      }
    });
    mo.observe(document.body, {subtree:true, childList:true});
  }

  function boot(){
    if (!normalize()){
      var iv=setInterval(function(){ if (normalize()){ clearInterval(iv); watchdog(); } }, 300);
      setTimeout(function(){ clearInterval(iv); normalize(); watchdog(); }, 12000);
    } else {
      watchdog();
    }
    window.addEventListener('hashchange', function(){ if (location.hash==='#live') setTimeout(function(){ normalize(); }, 400); });
  }

  if (document.readyState!=='loading') boot(); else document.addEventListener('DOMContentLoaded', boot);
})();
</script>
<style id="lb-scoretracker-styles">
/* Score tracker visuals */
#lbFavSidebar .lb-st-controls{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
#lbFavSidebar .lb-st-select{ font-size:11px; padding:2px 6px; border:1px solid #e5e7eb; border-radius:6px; }
#lbFavSidebar .lb-st-chip{ font-size:11px; padding:2px 6px; border:1px solid #e5e7eb; border-radius:9999px; background:#fff; cursor:pointer; }
#lbFavSidebar .lb-st-list .item{ padding:8px; border:1px solid #f1f5f9; border-radius:10px; display:flex; flex-direction:column; gap:4px; background:#fff; }
#lbFavSidebar .lb-st-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
#lbFavSidebar .lb-st-name{ font-weight:600; font-size:12px; }
#lbFavSidebar .lb-st-meta{ font-size:10px; color:#64748b; }
#lbFavSidebar .lb-st-metrics{ display:flex; gap:8px; font-size:11px; }
#lbFavSidebar .lb-st-metrics .pill{ padding:2px 6px; border-radius:9999px; background:#f8fafc; border:1px solid #eef2f7; }
#lbFavSidebar .lb-st-bar{ height:6px; background:#f1f5f9; border-radius:9999px; overflow:hidden; }
#lbFavSidebar .lb-st-bar>span{ display:block; height:100%; width:0%; }
#lbFavSidebar .lb-st-evt{ font-size:10px; color:#0ea5e9; font-weight:600; }
#lbFavSidebar .lb-st-actions{ display:flex; gap:6px; }
#lbFavSidebar .lb-st-btn{ font-size:10px; padding:2px 6px; border-radius:6px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
#lbFavSidebar .flash{ animation: lbFlash 0.75s ease-out; }
@keyframes lbFlash{ 0%{ box-shadow:0 0 0 0 rgba(59,130,246,.5);} 100%{ box-shadow:0 0 0 0 rgba(59,130,246,0);} }
</style>
<script>
/* LIVE_LEADERBOARD_SCORETRACKER_SIDEBAR_v1 */
(function(){
  var KEY = "mc:lb:favs"; // favorites list
  var POSKEY = "mc:lb:favs:sidebar:pos"; // position persists from previous patch

  function loadFavs(){ try{ var j=JSON.parse(localStorage.getItem(KEY)||"[]"); if(Array.isArray(j)) return new Set(j);}catch(_){ } return new Set(); }
  function getNameFromCell(td){
    if (!td) return null;
    for (var i=0;i<td.childNodes.length;i++){
      var n = td.childNodes[i];
      if (n.nodeType===3){ var t=(n.nodeValue||'').trim(); if (t) return t; }
    }
    var txt=(td.textContent||'').trim(); var p=txt.indexOf(' (');
    return p>0 ? txt.slice(0,p).trim() : txt;
  }
  function parseRow(tr){
    if (!tr) return null;
    var tds = tr.querySelectorAll('td');
    if (!tds || tds.length<4) return null;
    var pos  = (tds[0].textContent||'').trim();
    var name = getNameFromCell(tds[1]);
    var thru = (tds[2].textContent||'').trim();
    var toPar= (tds[3].textContent||'').trim();
    var meta = '';
    var sp = tds[1].querySelector('span'); if (sp) meta = (sp.textContent||'').trim();
    return { pos:pos, name:name, thru:thru, toPar:toPar, meta:meta };
  }
  function rowsFor(id){
    var host = document.getElementById('live-center-root');
    if (!host) return [];
    var tb = host.querySelector('#'+id);
    if (!tb) return [];
    var arr=[];
    Array.from(tb.querySelectorAll('tr')).forEach(function(tr){
      var row = parseRow(tr);
      if (row && row.name) arr.push(row);
    });
    return arr;
  }
  function ensureControls(){
    var side = document.getElementById('lbFavSidebar');
    if (!side) return;
    var header = side.querySelector(':scope > div');
    var ctrl = side.querySelector('#lbSTControls');
    if (!ctrl){
      ctrl = document.createElement('div');
      ctrl.id='lbSTControls';
      ctrl.className='lb-st-controls';
      ctrl.innerHTML = ''
        + '<div class="flex items-center gap-2">'
        + '  <span class="text-xs font-semibold">Tracker</span>'
        + '  <button id="lbSTCombined" class="lb-st-chip" data-on="1">Combined</button>'
        + '</div>'
        + '<select id="lbSTSort" class="lb-st-select">'
        + '  <option value="pos">Sort: Position</option>'
        + '  <option value="par">Sort: To Par</option>'
        + '  <option value="thru">Sort: Thru</option>'
        + '  <option value="name">Sort: Name</option>'
        + '</select>';
      header.after(ctrl);
    }
    if (!document.getElementById('lbSTList')){
      var list = document.createElement('div');
      list.id='lbSTList';
      list.className='lb-st-list space-y-2';
      ctrl.after(list);
    }
  }
  function numeric(v, def){
    var n = parseFloat((v||'').replace(/[^\d.-]/g,''));
    return isNaN(n) ? (def==null?0:def) : n;
  }
  function normalizeThru(v){
    if (!v) return 0;
    if (/^f/i.test(v)) return 18;
    return numeric(v, 0);
  }
  function normalizePar(v){
    if (!v) return 0;
    if (v==='E' || /^EVEN$/i.test(v)) return 0;
    return numeric(v, 0);
  }
  function keyFor(it){ return it.name + '|' + it.event; }

  var prev = {}; // previous stats by key

  function render(){
    var side = document.getElementById('lbFavSidebar');
    if (!side) return;
    ensureControls();
    var list = document.getElementById('lbSTList');
    if (!list) return;

    var favs = loadFavs();
    var a = rowsFor('evA').map(function(x){ x.event='A'; return x; });
    var b = rowsFor('evB').map(function(x){ x.event='B'; return x; });

    var combined = document.getElementById('lbSTCombined');
    var isCombined = combined && combined.getAttribute('data-on')==='1';
    var rows = isCombined ? a.concat(b) : a.concat(b); // still show both, but we'll label

    // filter to favorites
    rows = rows.filter(function(x){ return favs.has(x.name); });

    // sorting
    var sortBy = (document.getElementById('lbSTSort')||{}).value || 'pos';
    rows.sort(function(r1, r2){
      if (sortBy==='par') return normalizePar(r1.toPar) - normalizePar(r2.toPar);
      if (sortBy==='thru') return normalizeThru(r2.thru) - normalizeThru(r1.thru);
      if (sortBy==='name') return r1.name.localeCompare(r2.name);
      // default pos: numeric asc, non-numeric push back
      var p1 = numeric(r1.pos, 9999), p2 = numeric(r2.pos, 9999);
      return p1 - p2;
    });

    // build
    list.innerHTML = '';
    rows.forEach(function(r){
      var itKey = keyFor(r);
      var card = document.createElement('div');
      card.className='item';

      var head = document.createElement('div');
      head.className='lb-st-head';
      var tl = document.createElement('div');
      var nm = document.createElement('div'); nm.className='lb-st-name'; nm.textContent = r.name;
      var meta = document.createElement('div'); meta.className='lb-st-meta'; meta.textContent = r.meta;
      tl.appendChild(nm); tl.appendChild(meta);
      var tr = document.createElement('div');
      tr.className='lb-st-actions';
      var evt = document.createElement('span'); evt.className='lb-st-evt'; evt.textContent = 'Event ' + r.event;
      var jump = document.createElement('button'); jump.className='lb-st-btn'; jump.textContent='Jump';
      jump.addEventListener('click', function(){
        try{
          var host = document.getElementById('live-center-root');
          var table = host.querySelector('#ev'+r.event);
          var rows = Array.from(table.querySelectorAll('tr'));
          var row = rows.find(function(t){ var td=t.querySelector('td:nth-child(2)'); return td && (td.textContent||'').includes(r.name); });
          if (row){ row.scrollIntoView({behavior:'smooth', block:'center'}); row.classList.add('ring-2','ring-sky-400'); setTimeout(function(){ row.classList.remove('ring-2','ring-sky-400'); }, 1200); }
        }catch(_){}
      });
      tr.appendChild(evt); tr.appendChild(jump);
      head.appendChild(tl); head.appendChild(tr);
      card.appendChild(head);

      var metrics = document.createElement('div');
      metrics.className='lb-st-metrics';
      var pillPos = document.createElement('div'); pillPos.className='pill'; pillPos.textContent = 'Pos ' + (r.pos||'-');
      var pillThru = document.createElement('div'); pillThru.className='pill'; pillThru.textContent = 'Thru ' + (r.thru||'0');
      var pillPar = document.createElement('div'); pillPar.className='pill'; pillPar.textContent = 'To Par ' + (r.toPar||'E');
      metrics.appendChild(pillPos); metrics.appendChild(pillThru); metrics.appendChild(pillPar);
      card.appendChild(metrics);

      var prog = document.createElement('div'); prog.className='lb-st-bar';
      var fill = document.createElement('span');
      fill.style.width = Math.max(0, Math.min(100, (normalizeThru(r.thru)/18)*100)) + '%';
      prog.appendChild(fill);
      card.appendChild(prog);

      // change flash
      var p = prev[itKey];
      if (p && (p.pos!==r.pos || p.toPar!==r.toPar || p.thru!==r.thru)){
        card.classList.add('flash');
        setTimeout(function(){ card.classList.remove('flash'); }, 900);
      }
      prev[itKey] = { pos:r.pos, toPar:r.toPar, thru:r.thru };

      list.appendChild(card);
    });
  }

  function boot(){
    var host = document.getElementById('live-center-root');
    if (!host) return;
    // Restore sidebar pos so it doesn't overlap controls
    try{
      var side = document.getElementById('lbFavSidebar');
      var pos = JSON.parse(localStorage.getItem(POSKEY)||'null');
      if (side && pos){ side.style.left = pos.left+'px'; side.style.top = pos.top+'px'; side.style.right=''; }
    }catch(_){}
    // Hook controls
    document.addEventListener('change', function(e){
      if (e.target && e.target.id==='lbSTSort') render();
    });
    var comb = document.getElementById('lbSTCombined');
    if (comb){ comb.addEventListener('click', function(){
      var v = this.getAttribute('data-on')==='1' ? '0' : '1';
      this.setAttribute('data-on', v);
      this.style.background = v==='1' ? '#eef2ff' : '#fff';
      render();
    }); }

    // Initial and reactive renders
    render();
    window.addEventListener('lb:favs:update', render);
    var mo = new MutationObserver(function(m){ render(); });
    mo.observe(host, { childList:true, subtree:true });
  }

  function ready(fn){ if (document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    function tryBoot(){
      var host = document.getElementById('live-center-root');
      if (host && host.dataset && host.dataset.enhanced){ boot(); return true; }
      return false;
    }
    if (!tryBoot()){
      var iv=setInterval(function(){ if (tryBoot()) clearInterval(iv); }, 400);
      setTimeout(function(){ clearInterval(iv); tryBoot(); }, 12000);
    }
    window.addEventListener('hashchange', function(){ if (location.hash==='#live') setTimeout(tryBoot, 300); });
  });
})();
</script>
<style id="lb-hole-mini-style">
.lb-mini-row td{ background:#fff; }
.lb-mini-wrap{ padding:8px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; }
.lb-mini-grid{ display:grid; grid-template-columns: repeat(18, 1fr); gap:4px; }
.lb-mini-cell{ font-size:11px; text-align:center; padding:4px 0; border:1px solid #e5e7eb; border-radius:6px; background:#f8fafc; }
.lb-mini-cell.on{ outline:2px solid rgba(14,165,233,.5); }
.lb-mini-cell.par{ background:#ecfeff; }        /* light cyan */
.lb-mini-cell.birdie{ background:#dcfce7; }     /* light green */
.lb-mini-cell.eagle{ background:#bbf7d0; }      /* brighter green */
.lb-mini-cell.bogey{ background:#fee2e2; }      /* light red */
.lb-mini-cell.double{ background:#fecaca; }     /* stronger red */
.lb-mini-legend{ margin-top:6px; font-size:10px; color:#64748b; display:flex; gap:8px; flex-wrap:wrap;}
.lb-mini-legend span{ display:inline-flex; align-items:center; gap:4px; }
.lb-mini-dot{ width:10px; height:10px; border-radius:50%; display:inline-block; background:#e5e7eb; }
</style>
<script>
/* LIVE_LEADERBOARD_HOLE_MINI_v1 */
(function(){
  var state = {
    prev: new Map(),  // key -> {thru, par}
    book: new Map(),  // key -> Array(18) of deltas (-2 .. +3), null unknown
    open: new Set()   // keys with mini-row open
  };

  function parsePar(v){
    if (!v) return 0;
    v = (''+v).trim();
    if (v.toUpperCase()==='E' || v.toUpperCase()==='EVEN') return 0;
    var n = parseInt(v.replace(/[^\d\-\+]/g, ''), 10);
    return isNaN(n) ? 0 : n;
  }
  function parseThru(v){
    if (!v) return 0;
    v = (''+v).trim();
    if (/^f/i.test(v)) return 18;
    var n = parseInt(v.replace(/[^\d]/g,''), 10);
    return isNaN(n) ? 0 : n;
  }
  function getNameFromCell(td){
    if (!td) return null;
    for (var i=0;i<td.childNodes.length;i++){
      var n = td.childNodes[i];
      if (n.nodeType===3){
        var t=(n.nodeValue||'').trim();
        if (t) return t;
      }
    }
    var txt=(td.textContent||'').trim();
    var p=txt.indexOf(' (');
    return p>0 ? txt.slice(0,p).trim() : txt;
  }
  function parseRow(tr){
    var tds = tr.querySelectorAll('td');
    if (!tds || tds.length<4) return null;
    var pos = (tds[0].textContent||'').trim();
    var name = getNameFromCell(tds[1]);
    var thru = parseThru((tds[2].textContent||'').trim());
    var par = parsePar((tds[3].textContent||'').trim());
    return { pos, name, thru, par };
  }
  function keyFor(ev, name){ return ev + '|' + name; }

  function ensureBook(key){
    if (!state.book.has(key)){
      var arr = new Array(18).fill(null);
      state.book.set(key, arr);
    }
    return state.book.get(key);
  }

  function updateBooks(){
    var host = document.getElementById('live-center-root');
    if (!host) return;
    [['A','#evA'], ['B','#evB']].forEach(function(pair){
      var ev = pair[0], sel = pair[1];
      var tb = host.querySelector(sel);
      if (!tb) return;
      Array.from(tb.querySelectorAll('tr')).forEach(function(tr){
        var row = parseRow(tr);
        if (!row || !row.name) return;
        var key = keyFor(ev, row.name);
        var prev = state.prev.get(key);
        if (prev){
          // normal step: thru increment by 1 -> record delta as the per-hole score vs par
          if (row.thru > prev.thru){
            var steps = row.thru - prev.thru;
            var delta = row.par - prev.par;
            if (steps === 1){
              var idx = row.thru - 1; // 0-based hole index
              var book = ensureBook(key);
              book[idx] = delta; // -2 eagle, -1 birdie, 0 par, +1 bogey, etc.
            } else {
              // if we jumped multiple holes, assign the total delta to the last hole, others unknown
              var idx2 = row.thru - 1;
              var book2 = ensureBook(key);
              book2[idx2] = typeof book2[idx2]==='number' ? book2[idx2] : delta;
            }
          } else if (row.thru < prev.thru){
            // table likely refreshed/reset -> don't overwrite, but resync baseline
          }
        }
        state.prev.set(key, { thru: row.thru, par: row.par });
      });
    });
  }

  function colorClass(val){
    if (val === null || typeof val === 'undefined') return '';
    if (val <= -2) return 'eagle';
    if (val === -1) return 'birdie';
    if (val === 0) return 'par';
    if (val === 1) return 'bogey';
    return 'double';
  }
  function cellLabel(val){
    if (val === null || typeof val === 'undefined') return '–';
    if (val === 0) return 'E';
    if (val > 0) return '+' + val;
    return '' + val;
  }

  function ensureClickWiring(){
    var host = document.getElementById('live-center-root');
    if (!host) return;
    [['A','#evA'], ['B','#evB']].forEach(function(pair){
      var ev = pair[0], sel = pair[1];
      var tb = host.querySelector(sel);
      if (!tb) return;
      Array.from(tb.querySelectorAll('tr')).forEach(function(tr){
        var row = parseRow(tr);
        if (!row || !row.name) return;
        var key = keyFor(ev, row.name);
        tr.dataset.lbKey = key;
        // prevent duplicate listeners
        if (tr.dataset.lbMiniWired === '1') return;
        tr.dataset.lbMiniWired = '1';
        tr.addEventListener('click', function(e){
          // ignore clicks on star/favorite buttons or buttons inside the row
          if (e.target.closest('.lb-star') || e.target.closest('button')) return;
          toggleMini(this);
        });
      });
    });
  }

  function toggleMini(tr){
    var key = tr.dataset.lbKey;
    var open = state.open;
    var tb = tr.parentElement;
    // If already open, close
    var next = tr.nextElementSibling;
    if (next && next.classList.contains('lb-mini-row')){
      next.remove();
      open.delete(key);
      return;
    }
    // Otherwise open
    open.add(key);
    var colSpan = (tr.children.length || 4);
    var wrapTr = document.createElement('tr');
    wrapTr.className = 'lb-mini-row';
    wrapTr.dataset.key = key;
    var td = document.createElement('td');
    td.colSpan = colSpan;
    td.innerHTML = '<div class="lb-mini-wrap">'
      + '<div class="lb-mini-grid"></div>'
      + '<div class="lb-mini-legend">'
      + '<span><span class="lb-mini-dot" style="background:#bbf7d0"></span> Eagle (−2)</span>'
      + '<span><span class="lb-mini-dot" style="background:#dcfce7"></span> Birdie (−1)</span>'
      + '<span><span class="lb-mini-dot" style="background:#ecfeff"></span> Par (E)</span>'
      + '<span><span class="lb-mini-dot" style="background:#fee2e2"></span> Bogey (+1)</span>'
      + '<span><span class="lb-mini-dot" style="background:#fecaca"></span> Double (+2+)</span>'
      + '</div>'
      + '</div>';
    wrapTr.appendChild(td);
    tr.after(wrapTr);
    renderMiniFor(key);
  }

  function renderMiniFor(key){
    var host = document.getElementById('live-center-root');
    if (!host) return;
    var mini = host.querySelector('.lb-mini-row[data-key="'+key+'"] .lb-mini-grid');
    if (!mini) return;

    // find latest thru
    var parts = key.split('|');
    var ev = parts[0], name = parts.slice(1).join('|');
    var tb = host.querySelector(ev==='A' ? '#evA' : '#evB');
    var rows = Array.from(tb.querySelectorAll('tr'));
    var thru = 0;
    rows.forEach(function(tr){
      var r = parseRow(tr);
      if (r && r.name===name) thru = r.thru;
    });

    var book = ensureBook(key);
    mini.innerHTML = '';
    for (var i=0;i<18;i++){
      var val = book[i];
      var cell = document.createElement('div');
      cell.className = 'lb-mini-cell ' + colorClass(val) + ( (i+1)===thru+1 ? ' on' : '');
      cell.textContent = (i+1) + ' ' + cellLabel(val);
      mini.appendChild(cell);
    }
  }

  function refreshOpenMinis(){
    state.open.forEach(function(key){ renderMiniFor(key); });
  }

  function sync(){
    updateBooks();
    ensureClickWiring();
    refreshOpenMinis();
  }

  function boot(){
    var host = document.getElementById('live-center-root');
    if (!host) return;
    // Initial sweep
    sync();
    // Keep in sync with live updates
    var mo = new MutationObserver(function(m){ sync(); });
    mo.observe(host, { childList:true, subtree:true });
    // Also respond to window resizes (layout)
    window.addEventListener('resize', refreshOpenMinis);
  }

  if (document.readyState!=='loading') boot();
  else document.addEventListener('DOMContentLoaded', boot);
})();
</script>
<script>
/* LIVE_LEADERBOARD_HOLE_MINI_v2_DELEGATE */
(function(){
  // If v2 already present, skip
  if (window.__lbMiniDelegateBound) return;

  function parsePar(v){
    if (!v) return 0;
    v=(''+v).trim(); if (v.toUpperCase()==='E' || v.toUpperCase()==='EVEN') return 0;
    var n=parseInt(v.replace(/[^\d\-\+]/g,''),10); return isNaN(n)?0:n;
  }
  function parseThru(v){
    if (!v) return 0;
    v=(''+v).trim(); if (/^f/i.test(v)) return 18;
    var n=parseInt(v.replace(/[^\d]/g,''),10); return isNaN(n)?0:n;
  }
  function getNameFromCell(td){
    if (!td) return null;
    for (var i=0;i<td.childNodes.length;i++){
      var n=td.childNodes[i];
      if (n.nodeType===3){ var t=(n.nodeValue||'').trim(); if (t) return t; }
    }
    var txt=(td.textContent||'').trim(); var p=txt.indexOf(' (');
    return p>0? txt.slice(0,p).trim(): txt;
  }
  function parseRow(tr){
    var tds = tr && tr.querySelectorAll ? tr.querySelectorAll('td') : null;
    if (!tds || tds.length<4) return null;
    return {
      pos: (tds[0].textContent||'').trim(),
      name: getNameFromCell(tds[1]),
      thru: parseThru((tds[2].textContent||'').trim()),
      par:  parsePar((tds[3].textContent||'').trim())
    };
  }
  function keyFor(ev, name){ return ev + '|' + name; }

  // Share state with v1 if exists; else init a new bag on window
  var bag = window.__lbMiniState = window.__lbMiniState || {
    prev: new Map(),
    book: new Map(),
    open: new Set()
  };
  function ensureBook(key){
    if (!bag.book.has(key)){ bag.book.set(key, new Array(18).fill(null)); }
    return bag.book.get(key);
  }
  function updateBooks(){
    var host=document.getElementById('live-center-root'); if (!host) return;
    [['A','#evA'],['B','#evB']].forEach(function([ev,sel]){
      var tb = host.querySelector(sel); if (!tb) return;
      Array.from(tb.querySelectorAll('tr')).forEach(function(tr){
        var row = parseRow(tr); if (!row || !row.name) return;
        var key = keyFor(ev,row.name);
        var prev = bag.prev.get(key);
        if (prev){
          if (row.thru > prev.thru){
            var steps = row.thru - prev.thru;
            var delta = row.par - prev.par;
            var idx = row.thru - 1;
            var book = ensureBook(key);
            book[idx] = (steps===1) ? delta : (book[idx] ?? delta);
          }
        }
        bag.prev.set(key, {thru:row.thru, par:row.par});
      });
    });
  }
  function renderMiniFor(key){
    var host=document.getElementById('live-center-root'); if (!host) return;
    var mini = host.querySelector('.lb-mini-row[data-key="'+key+'"] .lb-mini-grid'); if (!mini) return;
    var parts=key.split('|'); var ev=parts[0], name=parts.slice(1).join('|');
    var tb = host.querySelector(ev==='A'?'#evA':'#evB'); if (!tb) return;
    var rows = Array.from(tb.querySelectorAll('tr'));
    var thru=0;
    rows.forEach(function(tr){ var r=parseRow(tr); if(r && r.name===name) thru=r.thru; });
    var book = ensureBook(key);
    mini.innerHTML='';
    function color(val){ if(val==null) return ''; if(val<=-2) return 'eagle'; if(val===-1) return 'birdie'; if(val===0) return 'par'; if(val===1) return 'bogey'; return 'double'; }
    function label(val){ if(val==null) return '–'; if(val===0) return 'E'; return (val>0? '+'+val: ''+val); }
    for (var i=0;i<18;i++){
      var val = book[i];
      var d = document.createElement('div');
      d.className = 'lb-mini-cell '+color(val)+( (i+1)===thru+1 ? ' on':'');
      d.textContent = (i+1)+' '+label(val);
      mini.appendChild(d);
    }
  }
  function toggleMiniFor(tr, evKey){
    var host=document.getElementById('live-center-root'); if (!host) return;
    var row = parseRow(tr); if (!row || !row.name) return;
    var key = keyFor(evKey, row.name);
    var next = tr.nextElementSibling;
    if (next && next.classList && next.classList.contains('lb-mini-row')){
      next.remove(); bag.open.delete(key); return;
    }
    bag.open.add(key);
    var wrapTr = document.createElement('tr'); wrapTr.className='lb-mini-row'; wrapTr.dataset.key = key;
    var td = document.createElement('td'); td.colSpan = tr.children.length || 4;
    td.innerHTML = '<div class="lb-mini-wrap"><div class="lb-mini-grid"></div>'
      + '<div class="lb-mini-legend">'
      + '<span><span class="lb-mini-dot" style="background:#bbf7d0"></span> Eagle (−2)</span>'
      + '<span><span class="lb-mini-dot" style="background:#dcfce7"></span> Birdie (−1)</span>'
      + '<span><span class="lb-mini-dot" style="background:#ecfeff"></span> Par (E)</span>'
      + '<span><span class="lb-mini-dot" style="background:#fee2e2"></span> Bogey (+1)</span>'
      + '<span><span class="lb-mini-dot" style="background:#fecaca"></span> Double (+2+)</span>'
      + '</div></div>';
    wrapTr.appendChild(td);
    tr.after(wrapTr);
    renderMiniFor(key);
  }
  function bindDelegates(){
    var host=document.getElementById('live-center-root'); if (!host) return;
    [['A','evA'],['B','evB']].forEach(function([ev, id]){
      var tb = document.getElementById(id);
      if (!tb || tb.dataset.lbMiniDelegate==='1') return;
      tb.dataset.lbMiniDelegate='1';
      tb.addEventListener('click', function(e){
        // ignore star/button clicks
        if (e.target.closest('.lb-star') || e.target.closest('button')) return;
        var tr = e.target.closest('tr');
        if (!tr) return;
        toggleMiniFor(tr, ev);
      });
    });
  }
  function refreshOpen(){
    var host=document.getElementById('live-center-root'); if (!host) return;
    bag.open.forEach(function(key){ renderMiniFor(key); });
  }

  function tick(){
    updateBooks(); refreshOpen(); bindDelegates();
  }

  function boot(){
    bindDelegates(); tick();
    var host=document.getElementById('live-center-root'); if (!host) return;
    var mo = new MutationObserver(function(){ tick(); });
    mo.observe(host, { childList:true, subtree:true });
  }

  window.__lbMiniDelegateBound = true;
  if (document.readyState!=='loading') boot(); else document.addEventListener('DOMContentLoaded', boot);
})();
</script>
<style id="lb-mini-v3-style">
.lb-mini-btn{ font-size:10px; padding:2px 6px; border:1px solid #e5e7eb; border-radius:6px; margin-left:6px; background:#fff; }
#lbFavDock{ position:fixed; z-index:61; left:auto; right:16px; top:96px; padding:6px 8px; border:1px solid #e5e7eb; background:#fff; border-radius:9999px; box-shadow:0 6px 20px rgba(2,6,23,.08); display:none; align-items:center; gap:6px; cursor:grab; }
#lbFavDock.grabbing{ cursor:grabbing; }
#lbFavDock .dot{ width:8px; height:8px; border-radius:50%; background:#f59e0b; }
#lbFavDock .txt{ font-size:12px; font-weight:600; }
</style>
<script>
/* LIVE_LEADERBOARD_MINIROWS_v3 + SIDEBAR_COLLAPSIBLE_DOCK */
(function(){
  if (window.__lbMiniV3) return; window.__lbMiniV3 = true;

  var POSKEY = "mc:lb:favs:sidebar:pos";
  var DOCKPOS = "mc:lb:favs:dock:pos";
  var COLLAPSED = "mc:lb:favs:sidebar:collapsed";

  // ---------- utils ----------
  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
  function onDocReady(fn){ if (document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  function getNameFromCell(td){
    if (!td) return null;
    for (var i=0;i<td.childNodes.length;i++){ var n=td.childNodes[i]; if (n.nodeType===3){ var t=(n.nodeValue||'').trim(); if (t) return t; } }
    var txt=(td.textContent||'').trim(); var p=txt.indexOf(' (');
    return p>0 ? txt.slice(0,p).trim() : txt;
  }
  function parseThru(v){ if(!v) return 0; v=(''+v).trim(); if(/^f/i.test(v)) return 18; var n=parseInt(v.replace(/[^\d]/g,''),10); return isNaN(n)?0:n; }
  function parseNum(v){ var n=parseFloat((''+(v||'')).replace(/[^\d\-\+\.]/g,'')); return isNaN(n)?0:n; }

  // ---------- add inline "Holes" buttons beside names ----------
  function ensureMiniButtons(){
    var host = document.getElementById('live-center-root'); if (!host) return;
    ['#evA','#evB'].forEach(function(sel){
      var tb = host.querySelector(sel); if (!tb) return;
      Array.from(tb.querySelectorAll('tr')).forEach(function(tr){
        var td = tr.querySelector('td:nth-child(2)'); if (!td) return;
        if (td.querySelector('.lb-mini-btn')) return;
        var btn = document.createElement('button');
        btn.type='button'; btn.className='lb-mini-btn'; btn.textContent='Holes';
        btn.addEventListener('click', function(e){ e.stopPropagation(); toggleMiniFor(tr, sel==='#evA'?'A':'B'); });
        td.appendChild(btn);
      });
    });
  }

  // ---------- state & mode ----------
  var bag = window.__lbMiniState = window.__lbMiniState || { prev:new Map(), book:new Map(), open:new Set(), mode:{A:'stroke', B:'points'} };

  function detectModes(){
    var host = document.getElementById('live-center-root'); if (!host) return;
    [['A','#evA'],['B','#evB']].forEach(function([ev, id]){
      var th = host.querySelector(id.replace('tbody','table') + ' thead'); // may not resolve
      // Fallback: look for header text near table markup we injected
      var headerRow = host.querySelector(id)?.previousElementSibling?.querySelector?.('th:last-child');
      var label = (headerRow && headerRow.textContent || '').trim().toLowerCase();
      if (label.indexOf('pts') !== -1) bag.mode[ev] = 'points';
      else bag.mode[ev] = 'stroke';
    });
  }

  function keyFor(ev, name){ return ev + '|' + name; }
  function ensureBook(key){ if (!bag.book.has(key)) bag.book.set(key, new Array(18).fill(null)); return bag.book.get(key); }

  function updateBooks(){
    var host = document.getElementById('live-center-root'); if (!host) return;
    [['A','#evA'],['B','#evB']].forEach(function([ev, sel]){
      var tb = host.querySelector(sel); if (!tb) return;
      Array.from(tb.querySelectorAll('tr')).forEach(function(tr){
        var tds = tr.querySelectorAll('td'); if (!tds || tds.length<2) return;
        var name = getNameFromCell(tds[1]); if (!name) return;
        var thru = parseThru((tds[2] && tds[2].textContent) || '');
        var metric = parseNum((tds[3] && tds[3].textContent) || '0'); // To Par or Pts
        var key = keyFor(ev, name);
        var prev = bag.prev.get(key);
        if (prev){
          if (thru > prev.thru){
            var delta = metric - prev.metric;
            var idx = thru - 1;
            var book = ensureBook(key);
            book[idx] = delta;
          }
        }
        bag.prev.set(key, { thru: thru, metric: metric });
      });
    });
  }

  function colorClass(ev, val){
    if (val == null) return '';
    var mode = bag.mode[ev] || 'stroke';
    if (mode === 'points'){
      // stableford-ish: more points better
      if (val >= 4) return 'eagle';
      if (val === 3) return 'birdie';
      if (val === 2) return 'par';
      if (val === 1) return 'bogey';
      return 'double';
    } else {
      // stroke play: negative better
      if (val <= -2) return 'eagle';
      if (val === -1) return 'birdie';
      if (val === 0) return 'par';
      if (val === 1) return 'bogey';
      return 'double';
    }
  }
  function cellText(ev, i, val){
    if (val == null) return (i+1)+' –';
    var mode = bag.mode[ev] || 'stroke';
    if (mode === 'points'){
      return (i+1)+' '+val; // show points delta
    } else {
      if (val === 0) return (i+1)+' E';
      return (i+1)+' '+(val>0?('+'+val):val);
    }
  }

  // ---------- mini toggle & rendering ----------
  function renderMiniFor(key){
    var host = document.getElementById('live-center-root'); if (!host) return;
    var mini = host.querySelector('.lb-mini-row[data-key="'+key+'"] .lb-mini-grid'); if (!mini) return;
    var parts = key.split('|'); var ev = parts[0], name = parts.slice(1).join('|');
    var tb = host.querySelector(ev==='A'?'#evA':'#evB'); if (!tb) return;

    // current thru
    var thru = 0;
    Array.from(tb.querySelectorAll('tr')).forEach(function(tr){
      var td = tr.querySelector('td:nth-child(2)'); if (!td) return;
      var nm = getNameFromCell(td); if (nm === name){
        var t3 = tr.querySelector('td:nth-child(3)'); thru = parseThru(t3 ? t3.textContent : '0');
      }
    });

    var book = ensureBook(key);
    mini.innerHTML = '';
    for (var i=0;i<18;i++){
      var val = book[i];
      var d = document.createElement('div');
      d.className = 'lb-mini-cell '+colorClass(ev, val) + ((i+1)===thru+1 ? ' on' : '');
      d.textContent = cellText(ev, i, val);
      mini.appendChild(d);
    }
  }

  function toggleMiniFor(tr, ev){
    var rowTds = tr.querySelectorAll('td'); if (!rowTds || rowTds.length<2) return;
    var name = getNameFromCell(rowTds[1]); if (!name) return;
    var key = keyFor(ev, name);
    var next = tr.nextElementSibling;
    if (next && next.classList && next.classList.contains('lb-mini-row')){
      next.remove(); bag.open.delete(key); return;
    }
    bag.open.add(key);
    var wrap = document.createElement('tr'); wrap.className='lb-mini-row'; wrap.dataset.key=key;
    var td = document.createElement('td'); td.colSpan = tr.children.length || 4;
    td.innerHTML = '<div class="lb-mini-wrap"><div class="lb-mini-grid"></div>'
      + '<div class="lb-mini-legend">'
      + '<span><span class="lb-mini-dot" style="background:#bbf7d0"></span> Better</span>'
      + '<span><span class="lb-mini-dot" style="background:#dcfce7"></span> Good</span>'
      + '<span><span class="lb-mini-dot" style="background:#ecfeff"></span> Even</span>'
      + '<span><span class="lb-mini-dot" style="background:#fee2e2"></span> Over</span>'
      + '<span><span class="lb-mini-dot" style="background:#fecaca"></span> High</span>'
      + '</div></div>';
    wrap.appendChild(td);
    tr.after(wrap);
    renderMiniFor(key);
  }

  // global delegated clicks (works even if tbodies are replaced)
  function bindGlobalClicks(){
    if (window.__lbMiniV3ClickBound) return; window.__lbMiniV3ClickBound = true;
    document.addEventListener('click', function(e){
      if (!document.getElementById('live-center-root')) return;
      if (e.target.closest('.lb-star') || e.target.closest('.lb-mini-btn') || e.target.closest('#lbFavSidebar') || e.target.closest('#lbFavDock')) return; // handled elsewhere
      var tr = e.target.closest('#evA tr, #evB tr');
      if (!tr) return;
      var ev = tr.closest('#evA') ? 'A' : 'B';
      toggleMiniFor(tr, ev);
    }, true); // capture phase to be extra robust
  }

  // track books on every mutation + ensure "Holes" buttons
  function observeLive(){
    var host = document.getElementById('live-center-root'); if (!host) return;
    var mo = new MutationObserver(function(){ detectModes(); updateBooks(); ensureMiniButtons(); bag.open.forEach(renderMiniFor); });
    mo.observe(host, { childList:true, subtree:true });
    detectModes(); updateBooks(); ensureMiniButtons();
  }

  // ---------- collapsible dock for the sidebar ----------
  function ensureDock(){
    var side = document.getElementById('lbFavSidebar');
    if (!side) return;
    var dock = document.getElementById('lbFavDock');
    if (!dock){
      dock = document.createElement('div');
      dock.id='lbFavDock';
      dock.innerHTML = '<span class="dot"></span><span class="txt">Tracker</span>';
      document.body.appendChild(dock);
    }

    function setDockPos(x,y){
      dock.style.left = x+'px'; dock.style.top = y+'px'; dock.style.right='';
      try{ localStorage.setItem(DOCKPOS, JSON.stringify({left:x, top:y})); }catch(_){}
    }
    function getSidePos(){
      var r = side.getBoundingClientRect();
      return { left:r.left, top:r.top };
    }
    function drag(el){
      var sx, sy, ox, oy, dragging=false;
      el.addEventListener('pointerdown', function(e){
        dragging=true; dock.classList.add('grabbing');
        sx=e.clientX; sy=e.clientY;
        var rect = dock.getBoundingClientRect(); ox=rect.left; oy=rect.top;
        function move(ev){
          if (!dragging) return;
          var nx = ox + (ev.clientX - sx);
          var ny = oy + (ev.clientY - sy);
          nx = clamp(nx, 8, window.innerWidth - dock.offsetWidth - 8);
          ny = clamp(ny, 60, window.innerHeight - dock.offsetHeight - 8);
          setDockPos(nx, ny);
        }
        function up(){ dragging=false; dock.classList.remove('grabbing'); document.removeEventListener('pointermove', move); document.removeEventListener('pointerup', up); }
        document.addEventListener('pointermove', move);
        document.addEventListener('pointerup', up, {once:true});
      });
    }

    // collapse/expand
    function collapse(){
      side.style.display='none';
      var pos = getSidePos();
      setDockPos(pos.left, pos.top);
      dock.style.display='inline-flex';
      localStorage.setItem(COLLAPSED,'1');
    }
    function expand(){
      dock.style.display='none';
      side.style.display='block';
      // restore sidebar pos
      try{
        var p = JSON.parse(localStorage.getItem(POSKEY) || 'null');
        if (p && typeof p.left==='number' && typeof p.top==='number'){
          side.style.left = p.left+'px'; side.style.top = p.top+'px'; side.style.right='';
        }
      }catch(_){}
      localStorage.setItem(COLLAPSED,'0');
    }

    // ensure collapse button in sidebar header
    var header = side.querySelector(':scope > div');
    if (header && !header.querySelector('#lbFavCollapse2')){
      var b = document.createElement('button');
      b.id='lbFavCollapse2';
      b.className='text-xs px-2 py-1 rounded border hover:bg-gray-50';
      b.textContent='Collapse';
      b.addEventListener('click', function(e){ e.stopPropagation(); collapse(); });
      header.appendChild(b);
    }

    // clicking dock expands
    dock.onclick = function(){ expand(); };

    // restore collapsed state
    if (localStorage.getItem(COLLAPSED)==='1'){
      side.style.display='none';
      dock.style.display='inline-flex';
      try{
        var d = JSON.parse(localStorage.getItem(DOCKPOS)||'null'); if (d){ dock.style.left=d.left+'px'; dock.style.top=d.top+'px'; dock.style.right=''; }
      }catch(_){}
    } else {
      dock.style.display='none';
    }

    drag(dock);
  }

  function boot(){
    bindGlobalClicks();
    observeLive();
    ensureDock();
    // also re-ensure dock after live mounts
    var iv = setInterval(function(){ ensureDock(); }, 1000);
    setTimeout(function(){ clearInterval(iv); }, 10000);
  }

  onDocReady(boot);
  window.addEventListener('hashchange', function(){ if (location.hash==='#live') setTimeout(boot, 300); });
})();
</script>
<!-- ===== CW CORE + IDENTITY (golfer-only popup infra) ===== -->
<script>
window.CW = window.CW || {};

// Simple event bus
CW.Events = {
  on(type, fn){ window.addEventListener(type, fn); },
  off(type, fn){ window.removeEventListener(type, fn); },
  emit(type, detail){ window.dispatchEvent(new CustomEvent(type, { detail })); }
};

// Identity helpers (demo mapping)
CW.identity = {
  GOLFERS: {
    "Sarah Chen": "GOLF-SARAH",
    "Peter Park": "GOLF-PETER",
    "Marcus Johnson": "GOLF-MARCUS"
  },
  CADDIES: {
    "Ning Siriwan": "CADDY-NING",
    "Ning": "CADDY-NING"
  },
  setGolfer(name){
    localStorage.setItem('cw:me:role','golfer');
    localStorage.setItem('cw:me:golfer', this.GOLFERS[name] || name);
  },
  setCaddy(name){
    localStorage.setItem('cw:me:role','caddy');
    localStorage.setItem('cw:me:caddy', this.CADDIES[name] || name);
  },
  clear(){
    ['cw:me:role','cw:me:golfer','cw:me:caddy'].forEach(k=>localStorage.removeItem(k));
  },
  role(){ return localStorage.getItem('cw:me:role'); },
  gid(){ return localStorage.getItem('cw:me:golfer'); },
  cid(){ return localStorage.getItem('cw:me:caddy'); }
};
// Default identity (first load): Peter as golfer
try{
  if(!localStorage.getItem('cw:me:role')){
    localStorage.setItem('cw:me:role','golfer');
    localStorage.setItem('cw:me:golfer','GOLF-PETER');
  }
}catch(_){}


function CW_isGolferSession(){
  return CW.identity.role()==='golfer' && !!CW.identity.gid();
}

// Storage helpers
CW.safeJSON = {
  get(key, def){
    try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : (def ?? null); }
    catch(e){ return def ?? null; }
  },
  set(key, val){
    localStorage.setItem(key, JSON.stringify(val));
    window.dispatchEvent(new StorageEvent('storage'));
  }
};

// Queue/Booking/Offer stores
CW.Queues = {
  key:'cw:queues',
  get(slot){ const m=CW.safeJSON.get(this.key,{})||{}; return m[slot]||[]; },
  set(slot, arr){ const m=CW.safeJSON.get(this.key,{})||{}; m[slot]=Array.from(arr||[]); CW.safeJSON.set(this.key,m); CW.Events.emit('cw:queue:updated',{slot}); },
  all(){ return CW.safeJSON.get(this.key,{})||{}; },
  popHead(slot){ const q=this.get(slot); if(!q.length) return null; const h=q.shift(); this.set(slot,q); return h; },
  moveHeadToTail(slot){ const q=this.get(slot); if(!q.length) return; const h=q.shift(); q.push(h); this.set(slot,q); }
};

CW.Bookings = {
  key:'cw:bookings',
  get(slot){ const m=CW.safeJSON.get(this.key,{})||{}; return m[slot]||null; },
  set(slot, rec){ const m=CW.safeJSON.get(this.key,{})||{}; if(rec){ m[slot]=rec; } else { delete m[slot]; } CW.safeJSON.set(this.key,m); CW.Events.emit('cw:booking:updated',{slot}); },
  isFilled(slot){ return !!this.get(slot); },
  assign(slot, rec){ this.set(slot, rec); }
};

CW.Offers = {
  key:'cw:offers',
  all(){ return CW.safeJSON.get(this.key,{})||{}; },
  save(map){ CW.safeJSON.set(this.key,map||{}); },
  get(slot){ return (this.all())[slot]||null; },
  hasActive(slot){ return !!this.get(slot); },
  clear(slot){ const m=this.all(); delete m[slot]; this.save(m); },
  create(slot, gid, ttlMs){ const m=this.all(); m[slot]={slot,gid,ttlMs,createdAt:Date.now()}; this.save(m); return m[slot]; }
};
// Vacancy trigger -> create offer for queue head
CW.onBookingVacated = function(slot){
  const q = CW.Queues.get(slot);
  if (!q.length) return;
  if (CW.Offers.hasActive(slot)) return;
  const head = q[0];
  // infer caddy from last booking at this slot or default demo caddy
  const last = CW.Bookings.get(slot);
  const cid = (last && last.cid) || 'CADDY-NING';
  CW.Offers.create({ slot, gid: head, cid, createdAt: Date.now(), ttlMs: 15*60*1000 });
};

// Accept / Pass / Rotate
CW.acceptOffer = function(slot, gid){
  const of = CW.Offers.get(slot);
  if (!of || of.gid !== gid) return false;
  if (CW.Bookings.isFilled(slot)) { CW.Offers.clear(slot); return false; }
  CW.Bookings.assign(slot, { gid: of.gid, cid: of.cid });
  try{ localStorage.setItem('cw:lastSlot', slot); }catch(_){}
  CW.Events.emit('cw:booking:confirmed',{slot, gid: of.gid, cid: of.cid});
  // remove head of queue
  const q = CW.Queues.get(slot);
  if (q.length && q[0]===gid){ q.shift(); CW.Queues.set(slot,q); }
  CW.Offers.clear(slot);
  CW.Events.emit('cw:toast', { type:'success', text:'Booking accepted' });
  return true;
};

CW.passOffer = function(slot, gid){
  const of = CW.Offers.get(slot);
  if (!of || of.gid !== gid) return false;
  // rotate
  CW.Queues.moveHeadToTail(slot);
  CW.Offers.clear(slot);
  CW.onBookingVacated(slot);
  return true;
};

// Heartbeat to expire offers
setInterval(() => {
  const map = CW.Offers.all();
  const now = Date.now();
  let changed = false;
  Object.keys(map).forEach(slot => {
    const of = map[slot];
    if (now > of.createdAt + of.ttlMs){
      // timeout -> rotate
      CW.Queues.moveHeadToTail(slot);
      delete map[slot];
      // re-issue to new head if exists
      const q = CW.Queues.get(slot);
      if (q.length){
        map[slot] = { slot, gid: q[0], cid: of.cid, createdAt: Date.now(), ttlMs: 15*60*1000 };
      }
      changed = true;
    }
  });
  if (changed){ CW.Offers.save(map); CW.Events.emit('cw:offer:ticked',{}); }
}, 1000);

// Bind login cards by visible names (non-destructive)
document.addEventListener('click', (e) => {
  const t = e.target.closest('[data-role-card], .role-card, button, a, div');
  if (!t) return;
  const txt = (t.innerText||'').trim();
  if (/Sarah\s+Chen/i.test(txt)) { CW.identity.setGolfer('Sarah Chen'); }
  if (/Peter\s+Park/i.test(txt)) { CW.identity.setGolfer('Peter Park'); }
  if (/Marcus\s+Johnson/i.test(txt)) { CW.identity.setGolfer('Marcus Johnson'); }
  if (/Ning\s+Siriwan/i.test(txt) || /\bNing\b/i.test(txt)) { CW.identity.setCaddy('Ning'); }
}, true);

</script>
<!-- ===== CW OFFER MODAL (golfer-only, global) ===== -->
<div aria-hidden="true" class="fixed inset-0 z-[9999] hidden" id="cw-offer-modal">
<div class="absolute inset-0 bg-black/50"></div>
<div class="absolute inset-0 flex items-center justify-center p-4">
<div aria-labelledby="cw-offer-title" aria-modal="true" class="w-full max-w-md rounded-2xl bg-white shadow-xl ring-1 ring-black/5" role="dialog">
<div class="p-5">
<h2 class="text-lg font-semibold" id="cw-offer-title">Booking Offer</h2>
<p class="mt-1 text-sm text-gray-600">
          A slot just opened with <span class="font-medium" id="cw-offer-caddy"></span>.
        </p>
<div class="mt-4 grid grid-cols-2 gap-3">
<div class="rounded-xl bg-gray-50 p-3">
<div class="text-xs text-gray-500">Date</div>
<div class="font-medium" id="cw-offer-date"></div>
</div>
<div class="rounded-xl bg-gray-50 p-3">
<div class="text-xs text-gray-500">Time</div>
<div class="font-medium" id="cw-offer-time"></div>
</div>
</div>
<div class="mt-4 flex items-center justify-between rounded-xl bg-gray-100 px-4 py-3">
<div class="text-sm">Expires in</div>
<div class="tabular-nums font-semibold" id="cw-offer-countdown">15:00</div>
</div>
<div class="mt-5 flex gap-3">
<button class="flex-1 rounded-xl border border-gray-300 px-4 py-2 text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500" id="cw-offer-pass">
            Pass
          </button>
<button class="flex-1 rounded-xl bg-indigo-600 px-4 py-2 font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" id="cw-offer-accept">
            Accept
          </button>
</div>
</div>
</div>
</div>
</div>
<script>
// ===== Modal controller (golfer-only, scoped to Schedule tab) =====
(function(){
  // Helper: detect if Schedule tab/section is currently visible
  function scheduleVisible(){
    // heuristic 1: a nav/tab with text 'Schedule' and aria-selected or active class
    const tabs = Array.from(document.querySelectorAll('a,button,li'));
    const hit = tabs.find(el => /schedule/i.test(el.textContent||'') && (el.getAttribute('aria-selected')==='true' || /\b(active|selected|current)\b/i.test(el.className||'')));
    if (hit) return true;
    // heuristic 2: section heading present
    const headers = Array.from(document.querySelectorAll('h1,h2,h3,h4'));
    if (headers.some(h => /golf\s*schedule/i.test(h.textContent||''))) return true;
    // heuristic 3: container with id/class schedule
    if (document.querySelector('#schedule, .schedule, [data-section="schedule"]')) return true;
    return false;
  }

  // Controller instance (created on demand once golfer session is active)
  let started = false;
  function startController(){
    if (started) return;
    if (!(window.CW && CW.identity && CW.identity.role()==='golfer')) return;
    started = true;

    const modal = document.getElementById('cw-offer-modal');
    const elCaddy = document.getElementById('cw-offer-caddy');
    const elDate  = document.getElementById('cw-offer-date');
    const elTime  = document.getElementById('cw-offer-time');
    const elCd    = document.getElementById('cw-offer-countdown');
    const btnAccept = document.getElementById('cw-offer-accept');
    const btnPass   = document.getElementById('cw-offer-pass');

    let offer=null, tick=null, lastFocus=null;

    function gid(){ return CW.identity.gid(); }
    function fmt(ms){ const s=Math.max(0,Math.floor(ms/1000)), m=(s/60)|0, r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }

    function openModal(of){
      // only on Schedule
      if (!scheduleVisible()) return;
      offer = of;
      const [d,t] = of.slot.split(' ');
      elDate.textContent = d; elTime.textContent = t;
      elCaddy.textContent = of.cid || 'Caddy';
      lastFocus = document.activeElement;
      modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false');
      setTimeout(()=>btnAccept.focus(),0);
      if (tick) clearInterval(tick);
      tick = setInterval(update,1000);
      update();
      window.addEventListener('keydown', escPass, { once:true });
    }
    function closeModal(){
      if (tick) clearInterval(tick), tick=null;
      modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true');
      if (lastFocus && lastFocus.focus) lastFocus.focus();
      offer = null;
    }
    function update(){
      if (!offer) return;
      const remain = offer.createdAt + offer.ttlMs - Date.now();
      elCd.textContent = fmt(remain);
      if (remain<=0) closeModal();
    }
    function escPass(e){ if (e.key==='Escape' && offer){ CW.passOffer(offer.slot, gid()); closeModal(); } }

    btnAccept.addEventListener('click', ()=>{ if(!offer) return; const ok=CW.acceptOffer(offer.slot, gid()); closeModal(); if(!ok) console.log('Offer no longer available'); });
    btnPass.addEventListener('click',   ()=>{ if(!offer) return; CW.passOffer(offer.slot, gid()); closeModal(); });

    function scanMine(){
      // if user navigates away from Schedule while open, close
      if (!scheduleVisible()){ if (offer) closeModal(); return; }
      if (CW.identity.role()!=='golfer'){ if (offer) closeModal(); return; }
      const mine = CW.Offers.mineFor(gid());
      if (!mine){ if (offer) closeModal(); return; }
      if (!offer || offer.slot !== mine.slot) openModal(mine);
    }

    // initial and watchers
    scanMine();
    CW.Events.on('cw:offer:new', scanMine);
    CW.Events.on('cw:offer:clear', scanMine);
    CW.Events.on('cw:booking:updated', scanMine);
    window.addEventListener('storage', scanMine);
    // Poll for schedule tab visibility changes
    setInterval(scanMine, 800);
  }

  // Start immediately if already golfer
  startController();

  // Late-init when identity changes to golfer
  window.addEventListener('storage', () => {
    if (localStorage.getItem('cw:me:role')==='golfer') startController();
  });
  // Also attempt after clicks (useful when login cards are clicked)
  document.addEventListener('click', () => {
    if (localStorage.getItem('cw:me:role')==='golfer') startController();
  }, true);
})();
</script>
<script>
// ===== DEMO SEED</script>
<script>
// ===== DEMO SEED (Sarah booked, Peter #1, Marcus #2; Ning only caddy) =====
(function demoSeed(){
  const SLOT = '2025-09-05 07:30';

  // names for display elsewhere (optional)
  const names = Object.assign({}, CW.safeJSON.get('cw:gid:names', {}), {
    'GOLF-SARAH':'Sarah Chen',
    'GOLF-PETER':'Peter Park',
    'GOLF-MARCUS':'Marcus Johnson'
  });
  CW.safeJSON.set('cw:gid:names', names);

  // prebook Sarah with Ning
  const bookings = CW.safeJSON.get('cw:bookings', {});
  bookings[SLOT] = { gid:'GOLF-SARAH', cid:'CADDY-NING' };
  CW.safeJSON.set('cw:bookings', bookings);

  // queue Peter -> Marcus
  const queues = CW.safeJSON.get('cw:queues', {});
  queues[SLOT] = ['GOLF-PETER','GOLF-MARCUS'];
  CW.safeJSON.set('cw:queues', queues);

  // clear offers
  CW.safeJSON.set('cw:offers', {});

  // DEMO helper
  window.DEMO = {
    loginSarah(){ CW.identity.setGolfer('Sarah Chen'); },
    loginPeter(){ CW.identity.setGolfer('Peter Park'); },
    loginMarcus(){ CW.identity.setGolfer('Marcus Johnson'); },
    loginNing(){  CW.identity.setCaddy('Ning'); },
    dropSarah(){
      const SLOT='2025-09-05 07:30';
      const b = CW.safeJSON.get('cw:bookings',{});
      if (b[SLOT] && b[SLOT].gid==='GOLF-SARAH'){
        delete b[SLOT];
        CW.safeJSON.set('cw:bookings', b);
        // trigger vacancy -> offer to queue head
        CW.onBookingVacated(SLOT);
      }
    }
  };
})();
</script>
<script>
// ===== Smart identity + Book Round hook (golfer-only) =====
(function(){
  // map visible names -> IDs
  const NAME_TO_GID = {
    "Sarah Chen": "GOLF-SARAH",
    "Peter Park": "GOLF-PETER",
    "Marcus Johnson": "GOLF-MARCUS"
  };

  function tryAutoSetGolferFromHeader(){
    if (localStorage.getItem('cw:me:role') === 'golfer') return; // don't override
    const text = (document.body.innerText || '').trim();
    for (const name of Object.keys(NAME_TO_GID)){
      const rx = new RegExp(name.replace(' ', '\\s+'), 'i');
      if (rx.test(text) && /GOLFER/i.test(text)){
        if (window.CW?.identity?.setGolfer){
          CW.identity.setGolfer(name);
          break;
        }
      }
    }
  }

  // When Schedule tab or Book Round is used, make sure role is set to golfer if name is present
  function onNavOrClick(e){
    const t = e ? e.target : null;
    const label = (t && (t.innerText || t.textContent) || '').trim();
    if (/schedule/i.test(label) || /\bbook\s*round\b/i.test(label)){
      tryAutoSetGolferFromHeader();
      // If Book Round was clicked in a golfer session, trigger demo vacancy to generate offer
      if (/\bbook\s*round\b/i.test(label) && localStorage.getItem('cw:me:role')==='golfer'){
        // Only if Sarah is holding the demo slot and no active offer
        const SLOT='2025-09-05 07:30';
        const offers = JSON.parse(localStorage.getItem('cw:offers')||'{}');
        const bookings = JSON.parse(localStorage.getItem('cw:bookings')||'{}');
        if ((!offers[SLOT]) && bookings[SLOT] && bookings[SLOT].gid === 'GOLF-SARAH'){
          // Simulate Sarah cancelling as you begin booking -> offer to queue head (Peter)
          if (window.CW?.onBookingVacated){
            // Vacate
            delete bookings[SLOT];
            localStorage.setItem('cw:bookings', JSON.stringify(bookings));
            CW.onBookingVacated(SLOT);
          }
        }
      }
    }
  }

  // run on load & bind listeners
  document.addEventListener('DOMContentLoaded', tryAutoSetGolferFromHeader);
  // clicks on nav/buttons
  document.addEventListener('click', onNavOrClick, true);
  // also when hash or history changes (if your tabs use routing)
  window.addEventListener('hashchange', tryAutoSetGolferFromHeader);
  window.addEventListener('popstate', tryAutoSetGolferFromHeader);
})();
</script>
<script>
// ===== Queue Panel + 30s delayed demo trigger + DOM sync =====
(function(){
  const SLOT = '2025-09-05 07:30';

  // Render a simple queue panel on the Schedule page for golfers
  function ensureScheduleQueuePanel(){
    if (!(CW && CW.identity)) return;
    // Find Schedule main container by heading text
    const h = Array.from(document.querySelectorAll('h1,h2,h3'))
      .find(x => /golf\s*schedule/i.test(x.textContent||''));
    if (!h) return;
    // Insert panel after the header once
    if (document.getElementById('cw-queue-panel')) return;
    const panel = document.createElement('div');
    panel.id = 'cw-queue-panel';
    panel.className = 'mt-3 mb-3 rounded-xl border border-indigo-100 bg-indigo-50/50 p-4 shadow-sm';
    panel.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold">Waitlist for ${SLOT} (Ning)</div>
        <div id="cw-queue-me" class="text-xs text-indigo-700"></div>
      </div>
      <ol id="cw-queue-list" class="mt-2 space-y-1 text-sm"></ol>
      <div id="cw-queue-hint" class="mt-2 text-xs text-gray-600"></div>
    `;
    h.parentElement.insertBefore(panel, h.nextSibling);
    updateQueuePanel();
  }

  function updateQueuePanel(){
    const q = CW.Queues.get(SLOT);
    const me = CW.identity.gid && CW.identity.gid();
    const list = document.getElementById('cw-queue-list');
    const meEl = document.getElementById('cw-queue-me');
    const hint = document.getElementById('cw-queue-hint');
    if (!list || !meEl) return;
    list.innerHTML='';
    q.forEach((gid, i)=>{
      const li = document.createElement('li');
      const pos = i+1;
      const name = (CW.safeJSON.get('cw:gid:names',{})[gid]||gid);
      li.innerHTML = `<span class="inline-flex w-6 h-6 items-center justify-center rounded-full bg-white shadow ring-1 ring-indigo-200 mr-2">${pos}</span> ${name}`;
      list.appendChild(li);
    });
    const myPos = q.indexOf(me);
    meEl.textContent = myPos >= 0 ? `You are #${myPos+1} in queue` : 'You are not in this queue';
    hint.textContent = 'An offer will appear if the slot becomes vacant. For the demo, that vacancy will happen ~30s after you enter Schedule.';
  }

  // Start a 30s demo timer when the user navigates to Schedule or clicks "Book Round"
  let demoTimer = null;
  function armDemoIfNeeded(e){
    if (!(CW && CW.identity)) return;
    // Only arm for Peter to mirror your scenario
    const gid = CW.identity.gid();
    if (gid !== 'GOLF-PETER') return;

    // If already armed, skip
    if (localStorage.getItem('cw:demo:armed')==='1') return;

    // Confirm demo state: Sarah booked, Peter->Marcus queue
    const bookings = CW.safeJSON.get('cw:bookings',{});
    const queues = CW.safeJSON.get('cw:queues',{});
    if (!(bookings[SLOT] && bookings[SLOT].gid==='GOLF-SARAH')) return; // ensure seed
    if (!queues[SLOT] || queues[SLOT][0] !== 'GOLF-PETER') return;

    // Arm
    localStorage.setItem('cw:demo:armed','1');
    localStorage.setItem('cw:demo:startAt', String(Date.now()));
    if (demoTimer) clearTimeout(demoTimer);
    demoTimer = setTimeout(()=>{
      // If still armed and no offer yet, vacate Sarah -> create offer for Peter
      const offers = CW.safeJSON.get('cw:offers',{});
      if (!offers[SLOT]){
        const b = CW.safeJSON.get('cw:bookings',{});
        if (b[SLOT] && b[SLOT].gid==='GOLF-SARAH'){
          delete b[SLOT];
          CW.safeJSON.set('cw:bookings', b);
          CW.onBookingVacated(SLOT);
        }
      }
    }, 30000); // 30 seconds
  }

  // DOM sync for bookings after accept (Golfer schedule + Caddy My Bookings)
  
function syncGolferSchedule(){
    // Guard: skip ONLY when the visible "Schedule Golf Round" dialog/overlay is open (incl. Tailwind fixed overlays)
    try{
      var __schedDlg = (function(){
        try{
          var root = null;
          // Find an element that contains the exact title text
          var marker = Array.from(document.querySelectorAll('*')).find(function(el){
            try{
              if(!el || !el.textContent) return false;
              if(!/Schedule\s+Golf\s+Round/i.test(el.textContent)) return false;
              // Candidate overlay root is any ancestor that either:
              //  - is [role=dialog]/[aria-modal] OR
              //  - has a class hinting overlay (fixed|inset-0|z-50|backdrop) OR
              //  - has computedStyle.position === 'fixed'
              var anc = el.closest('[role="dialog"],[aria-modal="true"],.modal,[data-modal],[class*="fixed"],[class*="inset-0"],[class*="z-50"],[class*="backdrop"]');
              if (!anc){
                // fallback: walk up and find any ancestor with position:fixed
                var p = el;
                while(p && p !== document.body){
                  var cs = window.getComputedStyle(p); if (cs && cs.position === 'fixed'){ anc = p; break; }
                  p = p.parentElement;
                }
              }
              if (!anc) return false;
              var cs2 = window.getComputedStyle(anc);
              if (cs2 && (cs2.display==='none' || cs2.visibility==='hidden' || Number(cs2.opacity||'1')===0)) return false;
              var r = anc.getBoundingClientRect(); if (!r || r.width<10 || r.height<10) return false;
              root = anc; return true;
            }catch(_){ return false; }
          });
          return root;
        }catch(_){ return null; }
      })();
      if (__schedDlg) { return; }
    }catch(_){}
    
  // Only render on Schedule tab
  const btns = Array.from(document.querySelectorAll('a,button,[role=button]'));
  const schedBtn = btns.find(el => (el.textContent||'').replace(/\s+/g,' ').trim().toLowerCase()==='schedule');
  const active = !!(schedBtn && (schedBtn.getAttribute('aria-current')==='page' || /active|border-b|text-blue-700/.test(schedBtn.className||'')));
  // Remove panel if we are not on Schedule
  if (!active){
    const p = document.getElementById('cw-queue-panel'); if (p) p.remove();
    return;
  }
  // Find the "Golf Schedule" header
  const h = Array.from(document.querySelectorAll('h1,h2,h3'))
      .find(x => /golf\s*schedule/i.test(x.textContent||''));
  if (!h) return;
  // Insert panel after the header once
  if (!document.getElementById('cw-queue-panel')){
    const panel = document.createElement('div');
    panel.id = 'cw-queue-panel';
    panel.className = 'mt-3 mb-3 rounded-xl border border-indigo-100 bg-indigo-50/50 p-4 shadow-sm';
    panel.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold">Waitlist for ${SLOT} (Ning)</div>
        <div id="cw-queue-me" class="text-xs text-indigo-700"></div>
      </div>
      <ol id="cw-queue-list" class="mt-2 space-y-1 text-sm"></ol>
      <div id="cw-queue-hint" class="mt-2 text-xs text-gray-600"></div>
    `;
    h.parentElement.insertBefore(panel, h.nextSibling);
  }
  updateQueuePanel();
}
function updateQueuePanel(){
    const q = CW.Queues.get(SLOT);
    const me = CW.identity.gid && CW.identity.gid();
    const list = document.getElementById('cw-queue-list');
    const meEl = document.getElementById('cw-queue-me');
    const hint = document.getElementById('cw-queue-hint');
    if (!list || !meEl) return;
    list.innerHTML='';
    q.forEach((gid, i)=>{
      const li = document.createElement('li');
      const pos = i+1;
      const name = (CW.safeJSON.get('cw:gid:names',{})[gid]||gid);
      li.innerHTML = `<span class="inline-flex w-6 h-6 items-center justify-center rounded-full bg-white shadow ring-1 ring-indigo-200 mr-2">${pos}</span> ${name}`;
      list.appendChild(li);
    });
    const myPos = q.indexOf(me);
    meEl.textContent = myPos >= 0 ? `You are #${myPos+1} in queue` : 'You are not in this queue';
    hint.textContent = 'An offer will appear if the slot becomes vacant. For the demo, that vacancy will happen ~30s after you enter Schedule.';
  }

  // Start a 30s demo timer when the user navigates to Schedule or clicks "Book Round"
  // demoTimer declared earlier

  function armDemoIfNeeded(e){
    if (!(CW && CW.identity)) return;
    // Only arm for Peter to mirror your scenario
    const gid = CW.identity.gid();
    if (gid !== 'GOLF-PETER') return;

    // If already armed, skip
    if (localStorage.getItem('cw:demo:armed')==='1') return;

    // Confirm demo state: Sarah booked, Peter->Marcus queue
    const bookings = CW.safeJSON.get('cw:bookings',{});
    const queues = CW.safeJSON.get('cw:queues',{});
    if (!(bookings[SLOT] && bookings[SLOT].gid==='GOLF-SARAH')) return; // ensure seed
    if (!queues[SLOT] || queues[SLOT][0] !== 'GOLF-PETER') return;

    // Arm
    localStorage.setItem('cw:demo:armed','1');
    localStorage.setItem('cw:demo:startAt', String(Date.now()));
    if (demoTimer) clearTimeout(demoTimer);
    demoTimer = setTimeout(()=>{
      // If still armed and no offer yet, vacate Sarah -> create offer for Peter
      const offers = CW.safeJSON.get('cw:offers',{});
      if (!offers[SLOT]){
        const b = CW.safeJSON.get('cw:bookings',{});
        if (b[SLOT] && b[SLOT].gid==='GOLF-SARAH'){
          delete b[SLOT];
          CW.safeJSON.set('cw:bookings', b);
          CW.onBookingVacated(SLOT);
        }
      }
    }, 30000); // 30 seconds
  }

  // DOM sync for bookings after accept (Golfer schedule + Caddy My Bookings)
  /* duplicate syncGolferSchedule removed */
function syncCaddyMyBookings(){
    // Only when viewing Caddy -> My Bookings
    const header = Array.from(document.querySelectorAll('h1,h2')).find(h=>/my\s*bookings/i.test(h.textContent||''));
    if (!header) return;
    const b = CW.Bookings.get(SLOT);
    let row = document.getElementById('cw-caddy-booked-row');
    if (b && b.cid === 'CADDY-NING'){
      if (!row){
        row = document.createElement('div');
        row.id = 'cw-caddy-booked-row';
        row.className = 'mt-3 rounded-2xl bg-white ring-1 ring-gray-200 shadow p-4 flex items-center justify-between';
        const name = (CW.safeJSON.get('cw:gid:names',{})[b.gid]||'Golfer');
        row.innerHTML = `<div><div class="font-medium">${name}</div><div class="text-xs text-gray-500">Pattaya Country Club • ${SLOT}</div></div><span class="px-2 py-1 text-xs rounded bg-green-100 text-green-700">confirmed</span>`;
        header.parentElement.appendChild(row);
      } else {
        const name = (CW.safeJSON.get('cw:gid:names',{})[b.gid]||'Golfer');
        row.querySelector('.font-medium').textContent = name;
      }
    } else {
      if (row) row.remove();
    }
  }

  // React to state changes
  CW.Events.on('cw:queue:updated', ()=>{ updateQueuePanel(); });
  CW.Events.on('cw:booking:updated', ()=>{ updateQueuePanel(); syncGolferSchedule(); syncCaddyMyBookings(); });
  CW.Events.on('cw:offer:new', ()=>{ updateQueuePanel(); });
  window.addEventListener('storage', ()=>{ updateQueuePanel(); syncGolferSchedule(); syncCaddyMyBookings(); });

  // Schedule tab detection: when active, render panel and arm demo timer
  function onClick(e){
    const t = e.target;
    const label = (t && (t.innerText||t.textContent)||'').trim();
    if (/schedule/i.test(label) || /\bbook\s*round\b/i.test(label)){
      setTimeout(()=>{ ensureScheduleQueuePanel(); updateQueuePanel(); armDemoIfNeeded(); }, 0);
    }
  }
  document.addEventListener('click', onClick, true);

  // On load (if already on Schedule due to deep link), render panel + maybe arm
  document.addEventListener('DOMContentLoaded', ()=>{ try{ if(typeof armDemoIfNeeded==='function') armDemoIfNeeded(); }catch(_){};
    ensureScheduleQueuePanel();
    updateQueuePanel();
  });

  // Also poll a bit to catch SPA navigation
  setInterval(()=>{
    ensureScheduleQueuePanel();
    syncGolferSchedule();
    syncCaddyMyBookings();
  }, 1000);

})();
</script>
<!-- === UC Games Engine v3 (Full Suite + hook only on "Games" button) === -->
<style>
  #uc-games-panel, #uc-games-backdrop { display: none; }
  #uc-games-panel.open, #uc-games-backdrop.open { display: block; }
  #uc-games-backdrop { z-index: 2147483600; }
  #uc-games-panel { z-index: 2147483601; }
  #ucg table input[type="number"] { width: 64px; }
  #ucg table input[type="text"]   { width: 128px; }
  #ucg .chip { border:1px solid #e5e7eb; padding:2px 8px; border-radius:999px; font-size:12px; }
  #ucg .kbd { border:1px solid #e5e7eb; padding:0 6px; border-radius:6px; background:#f8fafc; }
  #ucg-tabbar button[aria-selected="true"]{ background:#111827; color:white; }
  #ucg .subtle { color:#6b7280; font-size:12px; }
  #ucg .card  { background:white; border:1px solid #e5e7eb; border-radius:0.75rem; padding:0.75rem; }
  .ucg-scroll { overflow:auto; }
  .ucg-grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:0.5rem; }
  .ucg-grid-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:0.5rem; }
</style>
<div class="fixed inset-0 bg-black/20" id="uc-games-backdrop"></div>
<div class="fixed right-0 top-0 h-full w-full md:w-[1180px] bg-white shadow-2xl border-l rounded-none md:rounded-l-2xl overflow-hidden" id="uc-games-panel">
<div class="flex items-center justify-between px-4 py-3 border-b bg-gradient-to-r from-blue-700 to-blue-500 text-white" id="ucg-head">
<div class="flex items-center gap-2">
<span class="font-semibold">Games</span>
<span class="chip bg-white/10 text-white" id="ucg-course-chip"></span>
</div>
<div class="flex items-center gap-2">
<button class="px-3 py-1 rounded border border-white/60 bg-white/10 hover:bg-white/20" id="ucg-dir">Course Directory</button>
<button class="px-3 py-1 rounded border border-white/60 bg-white/10 hover:bg-white/20" id="ucg-ocr-open">Scan Card</button>
<button class="px-3 py-1 rounded border border-white/60 bg-white/10 hover:bg-white/20" id="ucg-save">Save</button>
<button class="px-3 py-1 rounded border border-white/60 bg-white/10 hover:bg-white/20" id="ucg-close">Close</button>
</div>
</div>
<div class="h-[calc(100%-52px)] overflow-auto p-3 text-sm" id="ucg">
<div class="flex gap-2 mb-3" id="ucg-tabbar">
<button aria-selected="true" class="px-3 py-1 border rounded" data-tab="play">Play</button>
<button class="px-3 py-1 border rounded" data-tab="ryder">Ryder Cup</button>
<button class="px-3 py-1 border rounded" data-tab="config">Config</button>
<button class="px-3 py-1 border rounded" data-tab="leader">Leaderboard</button>
</div>
<!-- PLAY TAB -->
<div class="space-y-3" id="ucg-tab-play">
<div class="grid md:grid-cols-3 gap-3">
<div class="card space-y-2">
<div class="font-semibold text-gray-900">Course &amp; Tees (WHS)</div>
<div class="ucg-grid-3">
<label class="col-span-3">Tee Name
              <input class="w-full border rounded p-2" id="ucg-tee" placeholder="Blue / White / Black" type="text"/>
</label>
<label>Par (18)<input class="w-full border rounded p-2" id="ucg-par-total" step="1" type="number" value="72"/></label>
<label>Course Rating<input class="w-full border rounded p-2" id="ucg-cr" step="0.1" type="number" value="72.0"/></label>
<label>Slope<input class="w-full border rounded p-2" id="ucg-slope" step="1" type="number" value="120"/></label>
<label class="col-span-3">Stroke Index (1–18, commas)<input class="w-full border rounded p-2" id="ucg-si" type="text" value="1,7,15,3,13,9,17,5,11,2,8,16,4,14,10,18,6,12"/></label>
<label class="col-span-3">Par by Hole (18 commas)<input class="w-full border rounded p-2" id="ucg-pars" type="text" value="4,4,3,4,4,5,3,4,4,4,4,3,5,4,4,3,5,4"/></label>
</div>
<div class="subtle">CH = round( HI × Slope / 113 + (CR − Par) ), PH = round(CH × allowance).</div>
</div>
<div class="card space-y-2">
<div class="flex items-center justify-between">
<div class="font-semibold text-gray-900">Players</div>
<button class="px-2 py-1 border rounded" id="ucg-add-player">+ Add</button>
</div>
<div class="space-y-2" id="ucg-players"></div>
<div class="subtle">Assign Team A / B for team games.</div>
</div>
<div class="card space-y-2">
<div class="font-semibold text-gray-900">Games</div>
<label class="flex items-center gap-2"><input checked="" id="ucg-game-nassau" type="checkbox"/> Nassau</label>
<div class="pl-5 ucg-grid-2" id="ucg-nassau-opts">
<label>Stake <input class="w-full border rounded p-1" id="ucg-nassau-stake" type="number" value="100"/></label>
<label>Auto-press <select class="w-full border rounded p-1" id="ucg-nassau-press"><option value="off">Off</option><option selected="" value="2down">2-down</option></select></label>
<label>Allowance <input class="w-full border rounded p-1" id="ucg-nassau-allow" step="0.05" type="number" value="1.00"/></label>
</div>
<label class="flex items-center gap-2 mt-2"><input checked="" id="ucg-game-skins" type="checkbox"/> Skins (net)</label>
<div class="pl-5 ucg-grid-2" id="ucg-skins-opts">
<label>PTS / skin <input class="w-full border rounded p-1" id="ucg-skins-stake" type="number" value="10"/></label>
</div>
<label class="flex items-center gap-2 mt-2"><input checked="" id="ucg-game-stb" type="checkbox"/> Stableford</label>
<div class="pl-5 ucg-grid-2" id="ucg-stb-opts">
<label>Table
              <select class="w-full border rounded p-1" id="ucg-stb-table">
<option value="standard">Standard (0/1/2/3/4/5/6)</option>
<option value="modified">Modified (Barracuda)</option>
<option value="custom">Custom</option>
</select>
</label>
<label>Allowance <input class="w-full border rounded p-1" id="ucg-stb-allow" step="0.05" type="number" value="0.95"/></label>
<label class="col-span-2" id="ucg-stb-custom-wrap" style="display:none;">Custom Table JSON
              <input class="w-full border rounded p-1" id="ucg-stb-custom" type="text" value='{"dbl+":0,"bogey":1,"par":2,"birdie":3,"eagle":5,"albatross":8}'/>
</label>
</div>
<hr class="my-2"/>
<label class="flex items-center gap-2"><input id="ucg-game-vegas" type="checkbox"/> Vegas (2v2)</label>
<div class="pl-5 ucg-grid-2" id="ucg-vegas-opts">
<label>PTS / point <input class="w-full border rounded p-1" id="ucg-vegas-stake" type="number" value="1"/></label>
<label>Tens as 0 <select class="w-full border rounded p-1" id="ucg-vegas-ten0"><option value="off">Off</option><option value="on">On</option></select></label>
<label>Flip on birdie <select class="w-full border rounded p-1" id="ucg-vegas-flip"><option value="off">Off</option><option value="on">On</option></select></label>
</div>
<label class="flex items-center gap-2 mt-2"><input id="ucg-game-wolf" type="checkbox"/> Wolf</label>
<div class="pl-5 ucg-grid-2" id="ucg-wolf-opts">
<label>Rotation start index <input class="w-full border rounded p-1" id="ucg-wolf-start" type="number" value="0"/></label>
<label>Lone Wolf on birdie <select class="w-full border rounded p-1" id="ucg-wolf-lone"><option value="off">Off</option><option value="on">On</option></select></label>
<label>Pts: team win <input class="w-full border rounded p-1" id="ucg-wolf-teamwin" type="number" value="2"/></label>
<label>Pts: solo win <input class="w-full border rounded p-1" id="ucg-wolf-solowin" type="number" value="4"/></label>
<label>Pts: others <input class="w-full border rounded p-1" id="ucg-wolf-others" type="number" value="1"/></label>
</div>
<label class="flex items-center gap-2 mt-2"><input id="ucg-game-531" type="checkbox"/> 5-3-1 (Threesomes)</label>
<div class="pl-5 ucg-grid-3" id="ucg-531-opts">
<label>P1 <select class="w-full border rounded p-1" id="ucg-531-p1"></select></label>
<label>P2 <select class="w-full border rounded p-1" id="ucg-531-p2"></select></label>
<label>P3 <select class="w-full border rounded p-1" id="ucg-531-p3"></select></label>
</div>
<label class="flex items-center gap-2 mt-2"><input id="ucg-game-sixes" type="checkbox"/> Sixes / Round Robin</label>
<div class="pl-5 ucg-grid-2" id="ucg-sixes-opts">
<label>P1 <select class="w-full border rounded p-1" id="ucg-sixes-p1"></select></label>
<label>P2 <select class="w-full border rounded p-1" id="ucg-sixes-p2"></select></label>
<label>P3 <select class="w-full border rounded p-1" id="ucg-sixes-p3"></select></label>
<label>P4 <select class="w-full border rounded p-1" id="ucg-sixes-p4"></select></label>
</div>
<label class="flex items-center gap-2 mt-2"><input id="ucg-game-quota" type="checkbox"/> Quota / Chicago</label>
<div class="pl-5 ucg-grid-3" id="ucg-quota-opts">
<label>Quota base <select class="w-full border rounded p-1" id="ucg-quota-base">
<option value="36">36 - HI</option>
<option value="39">39 - HI</option>
</select></label>
<label>Par pts <input class="w-full border rounded p-1" id="ucg-quota-par" type="number" value="2"/></label>
<label>Birdie pts <input class="w-full border rounded p-1" id="ucg-quota-birdie" type="number" value="4"/></label>
<label>Eagle pts <input class="w-full border rounded p-1" id="ucg-quota-eagle" type="number" value="8"/></label>
<label>Bogey pts <input class="w-full border rounded p-1" id="ucg-quota-bogey" type="number" value="1"/></label>
<label>Albatross pts <input class="w-full border rounded p-1" id="ucg-quota-ala" type="number" value="10"/></label>
</div>
<label class="flex items-center gap-2 mt-2"><input id="ucg-game-junk" type="checkbox"/> Dots / Junk</label>
<div class="pl-5 ucg-grid-2" id="ucg-junk-opts">
<label>PTS per dot <input class="w-full border rounded p-1" id="ucg-junk-stake" type="number" value="10"/></label>
</div>
<label class="flex items-center gap-2 mt-2"><input id="ucg-game-rabbit" type="checkbox"/> Rabbit</label>
<div class="pl-5 ucg-grid-2" id="ucg-rabbit-opts">
<label>PTS per 9 <input class="w-full border rounded p-1" id="ucg-rabbit-stake" type="number" value="20"/></label>
</div>
</div>
</div>
<div class="card">
<div class="flex items-center justify-between">
<div class="font-semibold text-gray-900">Score Entry (Gross)</div>
<div class="flex items-center gap-2"><div class="subtle hidden sm:block">Tip: Use <span class="kbd">Tab</span> to move across holes.</div><button class="px-2 py-1 border rounded" id="ucg-ocr-open2">Scan Card</button></div>
</div>
<div class="ucg-scroll">
<table class="min-w-full mt-2 border-collapse" id="ucg-score">
<thead>
<tr class="text-xs text-gray-500">
<th class="px-2 py-1 border text-left">Player</th>
<th class="px-2 py-1 border">H1</th><th class="px-2 py-1 border">H2</th><th class="px-2 py-1 border">H3</th><th class="px-2 py-1 border">H4</th><th class="px-2 py-1 border">H5</th><th class="px-2 py-1 border">H6</th><th class="px-2 py-1 border">H7</th><th class="px-2 py-1 border">H8</th><th class="px-2 py-1 border">H9</th><th class="px-2 py-1 border">H10</th><th class="px-2 py-1 border">H11</th><th class="px-2 py-1 border">H12</th><th class="px-2 py-1 border">H13</th><th class="px-2 py-1 border">H14</th><th class="px-2 py-1 border">H15</th><th class="px-2 py-1 border">H16</th><th class="px-2 py-1 border">H17</th><th class="px-2 py-1 border">H18</th>
<th class="px-2 py-1 border">F9</th>
<th class="px-2 py-1 border">B9</th>
<th class="px-2 py-1 border">Total</th>
</tr>
</thead>
<tbody id="ucg-score-body"></tbody>
</table>
</div>
</div>
<div class="grid md:grid-cols-3 gap-3">
<div class="card"><div class="font-semibold text-gray-900">Nassau</div><div class="text-sm text-gray-800 mt-2" id="ucg-out-nassau">—</div></div>
<div class="card"><div class="font-semibold text-gray-900">Skins</div><div class="text-sm text-gray-800 mt-2" id="ucg-out-skins">—</div></div>
<div class="card"><div class="font-semibold text-gray-900">Stableford</div><div class="text-sm text-gray-800 mt-2" id="ucg-out-stb">—</div></div>
<div class="card"><div class="font-semibold text-gray-900">Vegas</div><div class="text-sm text-gray-800 mt-2" id="ucg-out-vegas">—</div></div>
<div class="card"><div class="font-semibold text-gray-900">Wolf</div><div class="text-sm text-gray-800 mt-2" id="ucg-out-wolf">—</div></div>
<div class="card"><div class="font-semibold text-gray-900">5-3-1</div><div class="text-sm text-gray-800 mt-2" id="ucg-out-531">—</div></div>
<div class="card"><div class="font-semibold text-gray-900">Sixes</div><div class="text-sm text-gray-800 mt-2" id="ucg-out-sixes">—</div></div>
<div class="card"><div class="font-semibold text-gray-900">Quota</div><div class="text-sm text-gray-800 mt-2" id="ucg-out-quota">—</div></div>
<div class="card"><div class="font-semibold text-gray-900">Junk</div><div class="text-sm text-gray-800 mt-2" id="ucg-out-junk">—</div></div>
<div class="card"><div class="font-semibold text-gray-900">Rabbit</div><div class="text-sm text-gray-800 mt-2" id="ucg-out-rabbit">—</div></div>
</div>
</div>
<!-- RYDER TAB (placeholder to keep existing module consumers happy) -->
<div class="space-y-3" id="ucg-tab-ryder" style="display:none;"></div>
<!-- CONFIG TAB -->
<div class="space-y-3" id="ucg-tab-config" style="display:none;"></div>
<!-- SCHEDULE SANDBOX -->
<div class="space-y-3" id="cw-schedule-sandbox" style="display:none;">
<div class="card">
<div class="font-semibold text-gray-900 text-lg">Golf Schedule</div>
<div class="mt-3" id="cw-booked-inline-host"></div>
<div class="mt-3 mb-3 rounded-xl border border-indigo-100 bg-indigo-50/50 p-4 shadow-sm" id="cw-queue-panel">
<div class="flex items-center justify-between">
<div class="text-sm font-semibold">Waitlist for <span id="cw-slot-label"></span> (<span id="cw-caddy-name">Ning</span>)</div>
<div class="text-xs text-indigo-700" id="cw-queue-me"></div>
</div>
<ol class="mt-2 space-y-1 text-sm" id="cw-queue-list"></ol>
<div class="mt-2 text-xs text-gray-600" id="cw-queue-hint"></div>
<div class="mt-2" id="cw-offer-inline"></div>
</div>
</div>
</div>
<!-- LEADERBOARD TAB -->
<div class="space-y-3" id="ucg-tab-leader" style="display:none;">
<div class="card">
<div class="flex items-center justify-between">
<div class="font-semibold text-gray-900">Side Games Leaderboard</div>
<div class="flex items-center gap-2">
<label class="text-sm">Ranking metric
              <select class="border rounded p-1" id="ucg-leader-metric">
<option value="payout">Net payout (PTS)</option>
<option value="stb">Stableford pts</option>
<option value="quota">Quota net</option>
<option value="wolf">Wolf pts</option>
<option value="531">5-3-1 pts</option>
<option value="skins">Skins</option>
<option value="junk">Dots</option>
</select>
</label>
<button class="px-2 py-1 border rounded" id="ucg-export-csv">Export Payout CSV</button>
</div>
</div>
<div class="mt-2" id="ucg-leader-table"></div>
</div>
<div class="card"><div class="font-semibold text-gray-900">Payout Ledger (net between players)</div><div class="mt-2 text-sm" id="ucg-ledger"></div></div>
</div>
</div>
</div>
<script>
(function(){
  if (window.__ucg_v3) return; window.__ucg_v3 = true;
  const LSKEY = "uc.games.v3";

  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
  function num(v, d){ const n = Number(v); return Number.isFinite(n) ? n : (d ?? 0); }
  function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }
  function sum(arr){ return arr.reduce((s,v)=>s+num(v,0),0); }
  function range(n){ return Array.from({length:n},(_,i)=>i); }
  function parseCSVNums(s, count){ let out=(s||"").split(/[,\\s]+/).map(x=>{ const n=Number(x); return Number.isFinite(n)?n:null; }).filter(x=>x!==null); if(count&&out.length!==count) return null; return out; }

  function save(obj){ try{ localStorage.setItem(LSKEY, JSON.stringify(obj)); }catch(_){} }
  function load(){ try{ const v = JSON.parse(localStorage.getItem(LSKEY)||"null"); return v||null; }catch(_){ return null; } }

  // WHS helpers
  function calcCH(hi, slope, cr, par){ return Math.round( hi * (slope/113) + (cr - par) ); }
  function strokesPerHoleFromCH(ch, si){
    const strokes = new Array(18).fill(0);
    if (!ch) return strokes;
    const sign = ch>0 ? 1 : -1; const abs = Math.abs(ch);
    const base = Math.floor(abs/18), extra = abs%18;
    for (let i=0;i<18;i++) strokes[i]=base*sign;
    const order = si.map((v,idx)=>({v,idx})).sort((a,b)=>a.v-b.v);
    for (let k=0;k<extra;k++) strokes[order[k].idx]+=1*sign;
    return strokes;
  }
  function classifyVsPar(vs){ if (vs<=-3) return "albatross"; if (vs===-2) return "eagle"; if (vs===-1) return "birdie"; if (vs===0) return "par"; if (vs===1) return "bogey"; return "dbl+"; }
  function stbTable(kind, custom){
    if (kind==="modified") return {"albatross":8,"eagle":5,"birdie":2,"par":0,"bogey":-1,"dbl+":-3};
    if (kind==="custom"){ try{ const o=JSON.parse(custom||"{}"); return o; }catch(_){ return {"dbl+":0,"bogey":1,"par":2,"birdie":3,"eagle":4,"albatross":5}; } }
    return {"dbl+":0,"bogey":1,"par":2,"birdie":3,"eagle":4,"albatross":5};
  }

  const defaultState = {
    course: { tee:"", parTotal:72, cr:72.0, slope:120, si:[1,7,15,3,13,9,17,5,11,2,8,16,4,14,10,18,6,12], pars:[4,4,3,4,4,5,3,4,4,4,4,3,5,4,4,3,5,4] },
    players: [
      {id:"p1", name:"Player 1", hi:12.0, team:"A", gross:Array(18).fill(null)},
      {id:"p2", name:"Player 2", hi:14.0, team:"B", gross:Array(18).fill(null)}
    ],
    games: {
      nassau:{enabled:true, stake:100, autoPress:"2down", allow:1.00},
      skins:{enabled:true, stake:10},
      stb:{enabled:true, table:"standard", custom:'{"dbl+":0,"bogey":1,"par":2,"birdie":3,"eagle":4,"albatross":5}', allow:0.95},
      vegas:{enabled:false, stake:1, ten0:"off", flip:"off"},
      wolf:{enabled:false, start:0, lone:"off", teamwin:2, solowin:4, others:1},
      x531:{enabled:false, p1:"", p2:"", p3:""},
      sixes:{enabled:false, p1:"", p2:"", p3:"", p4:""},
      quota:{enabled:false, base:36, pts:{par:2,birdie:4,eagle:8,bogey:1,ala:10}},
      junk:{enabled:false, stake:10, counts:{}},
      rabbit:{enabled:false, stake:20}
    }
  };

  const state = load() || defaultState;

  // expose state (read-only clone) for extensions
  window.__ucg_get_state = () => JSON.parse(JSON.stringify(state));
  window.__ucg_set_state = (patch)=>{ Object.assign(state, patch||{}); save(state); computeAll(); };



  // DOM binds
  const courseChip = $("#ucg-course-chip");
  function bindVal(id, path, coerce){
    const el = document.getElementById(id);
    const parts = path.split(".");
    function getRef(){ let o=state; for (let i=0;i<parts.length-1;i++) o=o[parts[i]]; return [o, parts[parts.length-1]]; }
    function updateFromState(){ const [o,k] = getRef(); el.value = o[k]; }
    function updateToState(){ const [o,k] = getRef(); o[k] = coerce ? coerce(el.value) : el.value; save(state); computeAll(); }
    updateFromState(); el.addEventListener("input", updateToState); return el;
  }
  bindVal("ucg-tee","course.tee");
  bindVal("ucg-par-total","course.parTotal", v=>num(v,72));
  bindVal("ucg-cr","course.cr", v=>num(v,72));
  bindVal("ucg-slope","course.slope", v=>num(v,120));
  const elSI=$("#ucg-si"), elPars=$("#ucg-pars"); elSI.value=state.course.si.join(","); elPars.value=state.course.pars.join(",");
  elSI.addEventListener("input", ()=>{ const arr=parseCSVNums(elSI.value,18); if (arr){ state.course.si = arr.map(x=>clamp(Math.round(num(x,1)),1,18)); save(state); computeAll(); } });
  elPars.addEventListener("input", ()=>{ const arr=parseCSVNums(elPars.value,18); if (arr){ state.course.pars = arr.map(x=>clamp(Math.round(num(x,4)),3,6)); save(state); computeAll(); } });

  function bindChk(id, path){
    const el = document.getElementById(id); const parts = path.split(".");
    el.checked = parts.reduce((o,k)=>o[k], state);
    el.addEventListener("change", ()=>{ let o=state; for (let i=0;i<parts.length-1;i++) o=o[parts[i]]; o[parts[parts.length-1]] = el.checked; save(state); computeAll(); });
  }
  function bindSimple(id, path, coerce){
    const el = document.getElementById(id); const parts = path.split(".");
    el.value = parts.reduce((o,k)=>o[k], state);
    el.addEventListener("input", ()=>{ let o=state; for (let i=0;i<parts.length-1;i++) o=o[parts[i]]; o[parts[parts.length-1]] = coerce ? coerce(el.value) : el.value; save(state); computeAll(); });
  }

  // Bind games configs
  bindChk("ucg-game-nassau","games.nassau.enabled");
  bindSimple("ucg-nassau-stake","games.nassau.stake", v=>num(v,0));
  bindSimple("ucg-nassau-press","games.nassau.autoPress", v=>v);
  bindSimple("ucg-nassau-allow","games.nassau.allow", v=>num(v,1));

  bindChk("ucg-game-skins","games.skins.enabled");
  bindSimple("ucg-skins-stake","games.skins.stake", v=>num(v,0));

  bindChk("ucg-game-stb","games.stb.enabled");
  bindSimple("ucg-stb-table","games.stb.table", v=>v);
  bindSimple("ucg-stb-allow","games.stb.allow", v=>num(v,1));
  bindSimple("ucg-stb-custom","games.stb.custom", v=>v);
  (function(){ const sel=$("#ucg-stb-table"); const wrap=$("#ucg-stb-custom-wrap"); const toggle=()=> wrap.style.display = (sel.value==="custom")?"block":"none"; sel.addEventListener("input",toggle); toggle(); })();

  bindChk("ucg-game-vegas","games.vegas.enabled");
  bindSimple("ucg-vegas-stake","games.vegas.stake", v=>num(v,1));
  bindSimple("ucg-vegas-ten0","games.vegas.ten0", v=>v);
  bindSimple("ucg-vegas-flip","games.vegas.flip", v=>v);

  bindChk("ucg-game-wolf","games.wolf.enabled");
  bindSimple("ucg-wolf-start","games.wolf.start", v=>num(v,0));
  bindSimple("ucg-wolf-lone","games.wolf.lone", v=>v);
  bindSimple("ucg-wolf-teamwin","games.wolf.teamwin", v=>num(v,2));
  bindSimple("ucg-wolf-solowin","games.wolf.solowin", v=>num(v,4));
  bindSimple("ucg-wolf-others","games.wolf.others", v=>num(v,1));

  bindChk("ucg-game-531","games.x531.enabled");
  bindChk("ucg-game-sixes","games.sixes.enabled");
  bindChk("ucg-game-quota","games.quota.enabled");
  bindChk("ucg-game-junk","games.junk.enabled");
  bindChk("ucg-game-rabbit","games.rabbit.enabled");
  bindSimple("ucg-quota-base","games.quota.base", v=>num(v,36));
  bindSimple("ucg-quota-par","games.quota.pts.par", v=>num(v,2));
  bindSimple("ucg-quota-birdie","games.quota.pts.birdie", v=>num(v,4));
  bindSimple("ucg-quota-eagle","games.quota.pts.eagle", v=>num(v,8));
  bindSimple("ucg-quota-bogey","games.quota.pts.bogey", v=>num(v,1));
  bindSimple("ucg-quota-ala","games.quota.pts.ala", v=>num(v,10));
  bindSimple("ucg-junk-stake","games.junk.stake", v=>num(v,10));
  bindSimple("ucg-rabbit-stake","games.rabbit.stake", v=>num(v,20));

  // Players UI
  const playersWrap = $("#ucg-players");
  function ensureGross(){ state.players.forEach(p=>{ if (!Array.isArray(p.gross)||p.gross.length!==18) p.gross = Array(18).fill(null); }); }
  function playerRow(p, idx){
    const row = document.createElement("div");
    row.className = "border rounded-lg p-2 flex items-center gap-2";
    row.innerHTML = `
      <input data-k="name" type="text" class="border rounded p-1 flex-1" placeholder="Name" value="${p.name||""}"/>
      <label class="text-xs">HI <input data-k="hi" type="number" step="0.1" class="border rounded p-1 w-20" value="${p.hi||0}"/></label>
      <label class="text-xs">Team <select data-k="team" class="border rounded p-1">
        <option value="A"${p.team==="A"?" selected":""}>A</option>
        <option value="B"${p.team==="B"?" selected":""}>B</option>
      </select></label>
      <label class="text-xs">CR <input data-k="teeCR" type="number" step="0.1" class="border rounded p-1 w-20" value="${p.teeCR||''}" placeholder="${state.course.cr}"/></label>
      <label class="text-xs">Slope <input data-k="teeSlope" type="number" step="1" class="border rounded p-1 w-20" value="${p.teeSlope||''}" placeholder="${state.course.slope}"/></label>
      <button data-act="dots" class="px-2 py-1 border rounded">Dots</button>
      <button data-act="del" class="px-2 py-1 border rounded">Delete</button>
    `;
    row.querySelector('[data-act="del"]').addEventListener("click", ()=>{ state.players.splice(idx,1); renderPlayers(); renderScoreRows(); computeAll(); save(state); });
    row.querySelector('[data-act="dots"]').addEventListener("click", ()=>{ editJunk(p.id); });
    $all("input,select", row).forEach(el=>{
      el.addEventListener("input", ()=>{
        const k = el.getAttribute("data-k");
        state.players[idx][k] = (k==="name") ? el.value : (k==="team"?el.value : num(el.value,0));
        renderScoreRows(); syncSelectors(); computeAll(); save(state);
      });
    });
    return row;
  }
  function renderPlayers(){ playersWrap.innerHTML=""; state.players.forEach((p,i)=> playersWrap.appendChild(playerRow(p,i))); syncSelectors(); }
  document.getElementById("ucg-add-player").addEventListener("click", ()=>{
    const id = "p"+(1+Math.random()).toString(36).slice(2,6);
    state.players.push({id, name:"Player "+(state.players.length+1), hi:12, team:(state.players.length%2===0?"A":"B"), gross:Array(18).fill(null)});
    renderPlayers(); renderScoreRows(); computeAll(); save(state);
  });

  // Score grid
  const scoreBody = $("#ucg-score-body");
  function sumRange(arr, a,b){ return arr.slice(a,b).reduce((s,v)=>s+(v||0),0); }
  function scoreRow(p, idx){
    const tr = document.createElement("tr");
    tr.innerHTML = '<td class="px-2 py-1 border text-sm text-gray-700 font-medium">'+(p.name||("Player "+(idx+1)))+'</td>';
    for (let h=0; h<18; h++){
      const td = document.createElement("td"); td.className="px-1 py-1 border";
      const inp = document.createElement("input"); inp.type="number"; inp.step="1"; inp.min="1"; inp.className="border rounded p-1";
      const v = (p.gross && p.gross[h]!=null) ? p.gross[h] : "";
      if (v!=="") inp.value=v;
      inp.addEventListener("input", ()=>{ const val = inp.value===""? null : num(inp.value, null); state.players[idx].gross[h]=val; computeAll(); save(state); });
      td.appendChild(inp); tr.appendChild(td);
    }
    const f9 = sumRange(p.gross||[],0,9), b9 = sumRange(p.gross||[],9,18), tot=f9+b9;
    tr.innerHTML += '<td class="px-2 py-1 border text-center">'+(f9||"")+'</td>';
    tr.innerHTML += '<td class="px-2 py-1 border text-center">'+(b9||"")+'</td>';
    tr.innerHTML += '<td class="px-2 py-1 border text-center font-semibold">'+(tot||"")+'</td>';
    return tr;
  }
  function renderScoreRows(){ ensureGross(); scoreBody.innerHTML=""; state.players.forEach((p,i)=> scoreBody.appendChild(scoreRow(p,i))); }

  // Utility player maps
  function playerOptions(){ return state.players.map(p=>`<option value="${p.id}">${p.name}</option>`).join(""); }
  function syncSelectors(){
    ["ucg-531-p1","ucg-531-p2","ucg-531-p3","ucg-sixes-p1","ucg-sixes-p2","ucg-sixes-p3","ucg-sixes-p4"].forEach(id=>{
      const el=document.getElementById(id); if(!el) return;
      const cur=el.value;
      el.innerHTML = '<option value=""></option>'+playerOptions();
      el.value = cur && state.players.find(p=>p.id===cur) ? cur : "";
      el.addEventListener("input", ()=>{
        if(id.startsWith("ucg-531-")){ const k=id.split("-").pop(); state.games.x531[k]=el.value; }
        else { const k=id.split("-").pop(); state.games.sixes[k]=el.value; }
        save(state); computeAll();
      });
    });
  }

  // Junk editor
  function editJunk(pid){
    const p = state.players.find(x=>x.id===pid); if (!p) return;
    const cur = (state.games.junk.counts[pid]||{greenies:0,sandies:0,chippies:0,barkies:0});
    const str = prompt(`Dots for ${p.name} (format: greenies,sandies,chippies,barkies)`, [cur.greenies||0,cur.sandies||0,cur.chippies||0,cur.barkies||0].join(","));
    if (str==null) return;
    const parts = (str||"").split(",").map(x=>num(x,0));
    state.games.junk.counts[pid] = {greenies:parts[0]||0, sandies:parts[1]||0, chippies:parts[2]||0, barkies:parts[3]||0};
    save(state); computeAll();
  }

  // Compute
  function computeAll(){
    const cc=state.course, si=cc.si, pars=cc.pars;
    courseChip.textContent = (cc.tee?cc.tee+" • ":"")+"CR "+cc.cr+" / Slope "+cc.slope+" • Par "+cc.parTotal;

    const pcalc = state.players.map(p=>{
      const usedSlope = (p.teeSlope!=null && p.teeSlope!=="") ? num(p.teeSlope, cc.slope) : cc.slope;
      const usedCR = (p.teeCR!=null && p.teeCR!=="") ? num(p.teeCR, cc.cr) : cc.cr;
      const ch = calcCH(num(p.hi,0), usedSlope, usedCR, cc.parTotal);
      const phN = Math.round(ch * (state.games.nassau.allow||1));
      const phS = Math.round(ch * (state.games.stb.allow||1));
      const strokesN = strokesPerHoleFromCH(phN, si);
      const strokesS = strokesPerHoleFromCH(phS, si);
      return {...p, ch, phN, phS, strokesN, strokesS};
    });

    function net(p,h,scheme){ const g=(p.gross||[])[h]; if(g==null) return null; const s = (scheme==="S"?p.strokesS[h]:p.strokesN[h])||0; return g - s; }
    function sideLow(list,h,scheme){ const vals=list.map(p=>net(p,h,scheme)).filter(v=>v!=null); if(!vals.length) return null; return Math.min(...vals); }

    // Nassau
    (function(){
      const out=$("#ucg-out-nassau"); if(!state.games.nassau.enabled){ out.textContent="Disabled"; return; }
      const A=pcalc.filter(p=>p.team==="A"), B=pcalc.filter(p=>p.team==="B");
      const holes = range(18).map(h=>{ const a=sideLow(A,h,"N"), b=sideLow(B,h,"N"); if(a==null||b==null) return 0; return a<b?1:(b<a?-1:0); });
      const seg = arr=> arr.reduce((m,v)=>m+(v>0?1:(v<0?-1:0)),0);
      const f=seg(holes.slice(0,9)), b=seg(holes.slice(9)), t=seg(holes);
      function label(s){ if(s>0) return {txt:`Team A +${s}`, val: state.games.nassau.stake}; if(s<0) return {txt:`Team B +${-s}`, val: state.games.nassau.stake}; return {txt:"Halved", val:0}; }
      const F=label(f), Bv=label(b), T=label(t), netPay=F.val+Bv.val+T.val;
      out.innerHTML = `<div>Front 9: <strong>${F.txt}</strong></div><div>Back 9: <strong>${Bv.txt}</strong></div><div>Overall: <strong>${T.txt}</strong></div><div class="subtle mt-1">Allowance ${Math.round((state.games.nassau.allow||1)*100)}%</div><div class="mt-2">Net payout: <strong>${netPay} PTS</strong></div>`;
    })();

    // Skins
    (function(){
      const out=$("#ucg-out-skins"); if(!state.games.skins.enabled){ out.textContent="Disabled"; return; }
      const nets = pcalc.map(p=> range(18).map(h=> net(p,h,"N")) );
      let carry=0, wins=pcalc.map(_=>0);
      for(let h=0;h<18;h++){ const vals=nets.map(n=>n[h]).filter(v=>v!=null); if(vals.length<pcalc.length) continue; const low=Math.min(...vals); const w=[]; nets.forEach((n,i)=>{ if(n[h]===low) w.push(i); }); if(w.length===1){ wins[w[0]] += 1+carry; carry=0; } else { carry+=1; } }
      const lines=pcalc.map((p,i)=>`${p.name}: ${wins[i]} skin(s) • ${wins[i]*(state.games.skins.stake||0)} PTS`);
      out.innerHTML = "<div>"+lines.join("</div><div>")+"</div>"+(carry?(`<div class="subtle mt-1">Carryover left: ${carry}</div>`):"");
    })();

    // Stableford
    (function(){
      const out=$("#ucg-out-stb"); if(!state.games.stb.enabled){ out.textContent="Disabled"; return; }
      const tbl = stbTable(state.games.stb.table, state.games.stb.custom);
      const rows = pcalc.map(p=>{
        let f9=0,b9=0,tot=0;
        for(let h=0;h<18;h++){ const g=(p.gross||[])[h]; if(g==null) continue; const vs=(g - (p.strokesS[h]||0)) - (state.course.pars[h]||4); const cls=classifyVsPar(vs); const pt = (cls in tbl)? tbl[cls] : 0; tot+=pt; if(h<9) f9+=pt; else b9+=pt; }
        return {name:p.name, f9,b9,total:tot};
      }).sort((a,b)=>b.total-a.total);
      out.innerHTML = rows.map((r,i)=> `<div>${i===0?"🏆 ":""}${r.name}: ${r.total} pts (F9 ${r.f9} / B9 ${r.b9})</div>`).join("");
    })();

    // Vegas
    (function(){
      const out=$("#ucg-out-vegas"); if(!state.games.vegas.enabled){ out.textContent="Disabled"; return; }
      const stake = state.games.vegas.stake||0; const ten0=state.games.vegas.ten0==="on"; const flip=state.games.vegas.flip==="on";
      const A=pcalc.filter(p=>p.team==="A"), B=pcalc.filter(p=>p.team==="B");
      function teamNum(side,h){
        const vals = side.map(p=> net(p,h,"N") ).filter(v=>v!=null).sort((a,b)=>a-b).slice(0,2);
        if (vals.length<2) return null;
        let d1=vals[0], d2=vals[1];
        function digit(x){ return ten0 ? (x%10) : Math.max(0, Math.min(9, x)); }
        let n = 10*digit(Math.min(d1,d2)) + digit(Math.max(d1,d2));
        if (flip){
          const par = state.course.pars[h]||4;
          const birdie = side.some(p=>{ const g=(p.gross||[])[h]; if(g==null) return false; return (g - (p.strokesN[h]||0)) <= par-1; });
          if (birdie){
            const nrev = 10*digit(Math.max(d1,d2)) + digit(Math.min(d1,d2));
            n = Math.min(n, nrev);
          }
        }
        return n;
      }
      let payA=0, payB=0;
      for(let h=0;h<18;h++){
        const a=teamNum(A,h), b=teamNum(B,h); if(a==null||b==null) continue;
        const delta = (b - a);
        if (delta>0) payA += delta*stake; else if (delta<0) payB += (-delta)*stake;
      }
      out.innerHTML = `<div>Team A: <strong>${payA} PTS</strong></div><div>Team B: <strong>${payB} PTS</strong></div><div class="subtle mt-1">${ten0?"10→0, ":""}${flip?"flip-on-birdie":""}</div>`;
    })();

    // Wolf
    (function(){
      const out=$("#ucg-out-wolf"); if(!state.games.wolf.enabled){ out.textContent="Disabled"; return; }
      const start = state.games.wolf.start||0; const loneOnBirdie = state.games.wolf.lone==="on";
      const pts = {teamwin:state.games.wolf.teamwin||2, solowin:state.games.wolf.solowin||4, others:state.games.wolf.others||1};
      let score = {}; pcalc.forEach(p=>score[p.id]=0);
      const order = pcalc.map(p=>p.id);
      function pid(i){ return order[i % order.length]; }
      for(let h=0; h<18; h++){
        const wolfId = pid(start + h);
        const wolf = pcalc.find(p=>p.id===wolfId); if(!wolf) continue;
        const others = pcalc.filter(p=>p.id!==wolfId);
        const wolfNet = net(wolf,h,"N"); if (wolfNet==null) continue;
        let lone = false;
        if (loneOnBirdie){ const par = state.course.pars[h]||4; if (wolfNet <= par-1) lone = true; }
        const othersNet = others.map(p=>({p, n: net(p,h,"N")})).filter(x=>x.n!=null);
        if (!othersNet.length) continue;
        const best = othersNet.sort((a,b)=>a.n-b.n)[0];
        let teamWolf = [wolf], teamOpp = others;
        if (!lone) teamWolf.push(best.p), teamOpp = others.filter(x=>x.id!==best.p.id);
        function sideLowArr(arr){ const vals = arr.map(pp=>net(pp,h,"N")).filter(v=>v!=null); if(!vals.length) return null; return Math.min(...vals); }
        const a = sideLowArr(teamWolf), b = sideLowArr(teamOpp); if (a==null||b==null) continue;
        if (a<b){ const add = lone ? pts.solowin : pts.teamwin; teamWolf.forEach(p=> score[p.id] += add); }
        else if (b<a){ teamOpp.forEach(p=> score[p.id] += pts.others); }
        else { pcalc.forEach(p=> score[p.id] += 1); }
      }
      const rows = pcalc.map(p=>({name:p.name, pts: score[p.id]||0})).sort((a,b)=>b.pts-a.pts);
      out.innerHTML = rows.map((r,i)=>`<div>${i===0?"🏆 ":""}${r.name}: ${r.pts} pts</div>`).join("");
    })();

    // 5-3-1
    (function(){
      const out=$("#ucg-out-531"); if(!state.games.x531.enabled){ out.textContent="Disabled"; return; }
      const ids=[state.games.x531.p1,state.games.x531.p2,state.games.x531.p3].filter(Boolean);
      const group = ids.map(id=> pcalc.find(p=>p.id===id) ).filter(Boolean);
      if (group.length!==3){ out.textContent="Select exactly 3 players."; return; }
      let pts = {}; group.forEach(p=>pts[p.id]=0);
      for(let h=0; h<18; h++){
        const arr = group.map(p=>({p, n: net(p,h,"N")})).filter(x=>x.n!=null);
        if (arr.length<3) continue;
        arr.sort((a,b)=>a.n-b.n);
        const vals={}; arr.forEach((x,i)=>{ (vals[x.n]=vals[x.n]||[]).push(i); });
        const uniq = Object.keys(vals).map(Number).sort((a,b)=>a-b);
        if (uniq.length===3){ pts[arr[0].p.id]+=5; pts[arr[1].p.id]+=3; pts[arr[2].p.id]+=1; }
        else if (uniq.length===2){
          const lowGroup = vals[uniq[0]]; const hiGroup = vals[uniq[1]];
          if (lowGroup.length===2){ const share=(5+3)/2; lowGroup.forEach(i=> pts[arr[i].p.id]+=share); pts[arr[hiGroup[0]].p.id]+=1; }
          else { pts[arr[lowGroup[0]].p.id]+=5; const share=(3+1)/2; hiGroup.forEach(i=> pts[arr[i].p.id]+=share); }
        } else { group.forEach(p=> pts[p.id]+=3); }
      }
      const rows = group.map(p=>({name:p.name, pt:pts[p.id]||0})).sort((a,b)=>b.pt-a.pt);
      out.innerHTML = rows.map((r,i)=>`<div>${i===0?"🏆 ":""}${r.name}: ${r.pt} pts</div>`).join("");
    })();

    // Sixes
    (function(){
      const out=$("#ucg-out-sixes"); if(!state.games.sixes.enabled){ out.textContent="Disabled"; return; }
      const ids=[state.games.sixes.p1,state.games.sixes.p2,state.games.sixes.p3,state.games.sixes.p4].filter(Boolean);
      if (ids.length!==4){ out.textContent="Select 4 players."; return; }
      const P = ids.map(id=> pcalc.find(p=>p.id===id) );
      const pairs = [ [ [P[0],P[1]], [P[2],P[3]] ], [ [P[0],P[2]], [P[1],P[3]] ], [ [P[0],P[3]], [P[1],P[2]] ] ];
      const segHoles = [ [0,6], [6,12], [12,18] ];
      let lines = [];
      for (let s=0; s<3; s++){
        let up=0;
        for(let h=segHoles[s][0]; h<segHoles[s][1]; h++){
          function low(side){ const vals=side.map(p=>net(p,h,"N")).filter(v=>v!=null); if(!vals.length) return null; return Math.min(...vals); }
          const a=low(pairs[s][0]), b=low(pairs[s][1]); if(a==null||b==null) continue;
          if (a<b) up+=1; else if (b<a) up-=1;
        }
        const txt = up>0 ? `Segment ${s+1}: First pair wins +${up}` : (up<0 ? `Segment ${s+1}: Second pair wins +${-up}` : `Segment ${s+1}: Halved`);
        lines.push(txt);
      }
      out.innerHTML = lines.map(l=>`<div>${l}</div>`).join("");
    })();

    // Quota
    (function(){
      const out=$("#ucg-out-quota"); if(!state.games.quota.enabled){ out.textContent="Disabled"; return; }
      const base = state.games.quota.base||36; const Pts=state.games.quota.pts;
      function holePts(p,h){
        const g=(p.gross||[])[h]; if(g==null) return 0; const vs=(g - (p.strokesS[h]||0)) - (state.course.pars[h]||4);
        const cls = classifyVsPar(vs);
        if (cls==="albatross") return Pts.ala||10;
        if (cls==="eagle") return Pts.eagle||8;
        if (cls==="birdie") return Pts.birdie||4;
        if (cls==="par") return Pts.par||2;
        if (cls==="bogey") return Pts.bogey||1;
        return 0;
      }
      const rows = pcalc.map(p=>{
        const quota = Math.max(0, Math.round(base - num(p.hi,0)));
        let pts=0; for(let h=0;h<18;h++) pts += holePts(p,h);
        return {name:p.name, quota, pts, net: pts - quota};
      }).sort((a,b)=> b.net - a.net);
      out.innerHTML = rows.map((r,i)=> `<div>${i===0?"🏆 ":""}${r.name}: ${r.pts} pts (quota ${r.quota}, net ${r.net>=0?"+":""}${r.net})</div>`).join("");
    })();

    // Junk
    (function(){
      const out=$("#ucg-out-junk"); if(!state.games.junk.enabled){ out.textContent="Disabled"; return; }
      const stake = state.games.junk.stake||0; const counts=state.games.junk.counts||{};
      const rows = pcalc.map(p=>{
        const c = counts[p.id]||{greenies:0,sandies:0,chippies:0,barkies:0};
        const total = (c.greenies||0)+(c.sandies||0)+(c.chippies||0)+(c.barkies||0);
        const owed = total * stake;
        return {name:p.name, c, total, owed};
      }).sort((a,b)=> b.total-a.total);
      out.innerHTML = rows.map(r=> `<div>${r.name}: ${r.total} dots → ${r.owed} PTS <span class="subtle">(G${r.c.greenies||0} S${r.c.sandies||0} C${r.c.chippies||0} B${r.c.barkies||0})</span></div>`).join("");
    })();

    // Rabbit
    (function(){
      const out=$("#ucg-out-rabbit"); if(!state.games.rabbit.enabled){ out.textContent="Disabled"; return; }
      const stake = state.games.rabbit.stake||0;
      function run(start,end){
        let owner=null;
        for(let h=start; h<end; h++){
          const arr = pcalc.map(p=>({p, n: net(p,h,"N")})).filter(x=>x.n!=null);
          if (arr.length<state.players.length) continue;
          arr.sort((a,b)=>a.n-b.n);
          if (arr[0].n < arr[1].n){ owner = arr[0].p; }
        }
        return {owner};
      }
      const f9=run(0,9), b9=run(9,18);
      function line(seg,res){
        if (!res.owner) return `${seg}: no owner`;
        const others = pcalc.filter(p=>p.id!==res.owner.id).map(p=>p.name).join(", ");
        return `${seg}: ${res.owner.name} owns rabbit • ${stake} PTS from each of ${others}`;
      }
      out.innerHTML = `<div>${line("Front 9",f9)}</div><div>${line("Back 9",b9)}</div>`;
    })();

    // Leaderboard render & event hook
    try{ renderLeaderboards(pcalc); }catch(_){}
    save(state);
    try{ window.dispatchEvent(new Event('ucg-after-compute')); }catch(_){}
  }

  // Initial render
  function init(){ renderPlayers(); renderScoreRows(); computeAll(); }
  init();

  // Hook "Games" button by label; do NOT auto-open.
  function attachGamesButton(){
    const btns = $all("button, a, [role=button], .cursor-pointer, .btn");
    const gamesBtn = btns.find(b=> (b.textContent||"").replace(/\s+/g," ").trim().toLowerCase()==="games");
    if (!gamesBtn) return false;
    if (gamesBtn.__ucgBound) return true;
    gamesBtn.__ucgBound = true;
    gamesBtn.addEventListener("click", (e)=>{
      try{ e.preventDefault(); }catch(_){}
      $("#uc-games-panel").classList.add("open"); $("#uc-games-backdrop").classList.add("open");
    });
    // Close button
    document.getElementById("ucg-close").addEventListener("click", ()=>{
      $("#uc-games-panel").classList.remove("open"); $("#uc-games-backdrop").classList.remove("open");
    });
    // Temporary directory/save placeholders
    document.getElementById("ucg-dir").addEventListener("click", ()=> alert("Course Directory stub — import coming."));
    document.getElementById("ucg-save").addEventListener("click", ()=> alert("Saved."));
    return true;
  }
  attachGamesButton();
  setInterval(attachGamesButton, 1500);

  // Simple cross-component recompute hook
  window.addEventListener("ucg-recompute", ()=>{ try{ computeAll(); }catch(_){ } });

  // Tabs
  $all("#ucg-tabbar button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      $all("#ucg-tabbar button").forEach(b=>b.setAttribute("aria-selected","false"));
      btn.setAttribute("aria-selected","true");
      const t=btn.getAttribute("data-tab");
      $("#ucg-tab-play").style.display = (t==="play")?"block":"none";
      $("#ucg-tab-ryder").style.display = (t==="ryder")?"block":"none";
      $("#ucg-tab-config").style.display = (t==="config")?"block":"none";
      const L=document.getElementById("ucg-tab-leader"); if(L) L.style.display = (t==="leader")?"block":"none";
    });
  });

})();
</script>
<script>
(function(){
  // Ensure a "Scan Card" button exists in the Games header; if missing, create it.
  function ensureHeaderScanButton(){
    var header = document.querySelector('#uc-games-panel .border-b'); // top bar container
    if(!header) return;
    var btn = document.getElementById('ucg-ocr-open');
    if(!btn){
      btn = document.createElement('button');
      btn.id = 'ucg-ocr-open';
      btn.textContent = 'Scan Card';
      btn.className = 'px-3 py-1 rounded border border-white/60 bg-white/10 hover:bg-white/20';
      header.querySelector('.flex.items-center.gap-2:last-child')?.appendChild(btn);
    }
  }

  // Wire buttons by ID and the floating FAB
  function wireScanButtons(){
    function clickHandler(e){
      try{ e.preventDefault(); }catch(_){}
      // Defer to the lazy loader already included on the page
      if(window.__uc_ocr_loaded || window.__uc_ocr_lazy){
        // Find the lazy binder function via synthetic click: the lazy script listens for "Scan Card" button clicks,
        // but we call its internal ensureOCR/open sequence if available.
        if (typeof window.ensureOCR === 'function' && typeof window.openOCR === 'function' && typeof window.__ucWireOCR === 'function'){
          // older versions won't have __ucWireOCR; fall back to dispatching a click on a fake "Scan Card" text node
        }
      }
    }
    var headerBtn = document.getElementById('ucg-ocr-open');
    var fabBtn = document.getElementById('ucg-ocr-fab');
    if (fabBtn && !fabBtn.__wired){
      fabBtn.__wired = true;
      fabBtn.addEventListener('click', async function(e){
        try{e.preventDefault();}catch(_){}
        // If the lazy loader defined helpers, call them; otherwise simulate the text-search path
        if (window.__uc_ocr_lazy && !window.__uc_ocr_loaded) {
          // Find the lazy script block's ensure function by scanning globals created there.
        }
      });
    }
    if (headerBtn && !headerBtn.__wired){
      headerBtn.__wired = true;
      headerBtn.addEventListener('click', function(){ /* noop: lazy loader already binds by label */ });
    }
  }

  // Fallback: if the lazy loader is searching by label and misses our buttons,
  // proactively dispatch a click on a fake button with the right label after attaching Games.
  function pokeLazyLoader(){
    var fake = Array.from(document.querySelectorAll('button,a')).find(b => (b.textContent||'').trim().toLowerCase()==='scan card');
    if(!fake){
      var headerBtn = document.getElementById('ucg-ocr-open');
      if(headerBtn) headerBtn.setAttribute('data-scan','true');
    }
  }

  function boot(){
    ensureHeaderScanButton();
    wireScanButtons();
    pokeLazyLoader();
  }
  document.addEventListener('DOMContentLoaded', boot);
  setInterval(boot, 1200); // keep wiring in case panel gets re-rendered
})();
</script>
<script>
(function(){
  function hook(id){
    var b=document.getElementById(id); if(!b||b.__ocrhook) return;
    b.__ocrhook=true;
    b.addEventListener('click', async function(e){
      try{e.preventDefault();}catch(_){}
      // The lazy loader watches for 'Scan Card' text buttons and wires them.
      // Trigger a synthetic click so its handler runs even if it missed initial bind.
      const labelBtn = Array.from(document.querySelectorAll('button,a')).find(x=> (x.textContent||'').trim().toLowerCase()==='scan card');
      if(labelBtn && labelBtn!==b){ labelBtn.click(); return; }
    });
  }
  function init(){ hook('ucg-ocr-open'); hook('ucg-ocr-open2'); }
  document.addEventListener('DOMContentLoaded', init);
  setInterval(init, 1200);
})();
</script>
<!-- === UC OCR Lazy Loader v2 (Brave/Chrome safe) === -->
<script>
(function(){
  if (window.__uc_ocr_lazy_v2) return; window.__uc_ocr_lazy_v2 = true;

  function injectOCRShell(){
    if (document.getElementById("uc-ocr-panel")) return;
    const css = document.createElement("style");
    css.textContent = `#uc-ocr-backdrop, #uc-ocr-panel { display:none; }
#uc-ocr-backdrop.open { display:block; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:2147483602; }
#uc-ocr-panel.open { display:flex; }
#uc-ocr-panel { position:fixed; inset:0; background:#fff; z-index:2147483603; flex-direction:column; }
#uc-ocr-head { display:flex; align-items:center; justify-content:space-between; padding:.75rem; background:#0f172a; color:#fff; }
#uc-ocr-body { flex:1; overflow:auto; padding:.75rem; }
#uc-ocr-foot { padding:.75rem; display:flex; gap:.5rem; border-top:1px solid #e5e7eb; }
#uc-ocr-canvas-wrap { position:relative; border:1px solid #e5e7eb; border-radius:.5rem; overflow:hidden; }
#uc-ocr-canvas { width:100%; touch-action:none; }
.ocr-handle { position:absolute; width:20px; height:20px; border:2px solid #fff; background:#2563eb; border-radius:4px; transform:translate(-50%,-50%); touch-action:none; }
#ocr-rect { position:absolute; border:2px dashed #2563eb; background:rgba(37,99,235,.08); }
.ocr-grid { display:grid; grid-template-columns:1fr 1fr; gap:.5rem; }
.ocr-grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:.5rem; }
.ocr-input, .ocr-select, .ocr-btn { width:100%; padding:.6rem .7rem; border:1px solid #e5e7eb; border-radius:.5rem; font-size:16px; }
.ocr-btn.primary { background:#2563eb; color:#fff; border-color:#2563eb; }
.ocr-btn.ghost { background:#fff; color:#111827; }
table.ocr-preview { width:100%; border-collapse:collapse; }
table.ocr-preview th, table.ocr-preview td { border:1px solid #e5e7eb; padding:.25rem; text-align:center; }
@media(min-width:768px){ .ocr-grid { grid-template-columns:1fr 1fr 1fr; } }`;
    document.head.appendChild(css);

    const wrap = document.createElement("div");
    wrap.innerHTML = `<div id="uc-ocr-backdrop"></div>
<div id="uc-ocr-panel" aria-hidden="true">
  <div id="uc-ocr-head"><div>Scan Scorecard (Mobile)</div><div><button id="uc-ocr-close" class="ocr-btn ghost">Close</button></div></div>
  <div id="uc-ocr-body">
    <div class="ocr-grid">
      <label>Photo / Image<input id="uc-ocr-file" class="ocr-input" type="file" accept="image/*" capture="environment"></label>
      <label>Rotate<select id="uc-ocr-rot" class="ocr-select"><option value="0">0°</option><option value="90">90°</option><option value="180">180°</option><option value="270">270°</option></select></label>
      <label>Segment<select id="uc-ocr-seg" class="ocr-select"><option value="f9">Front 9 (1–9)</option><option value="b9">Back 9 (10–18)</option><option value="18">Full 18</option></select></label>
      <label>Layout<select id="uc-ocr-layout" class="ocr-select"><option value="prow-hcol" selected>Players = Rows, Holes = Columns</option><option value="hrow-pcol">Holes = Rows, Players = Columns</option></select></label>
      <label># Rows (players or holes)<input id="uc-ocr-rows" class="ocr-input" type="number" value="4" min="1" max="16"></label>
      <label># Cols (holes or players)<input id="uc-ocr-cols" class="ocr-input" type="number" value="9" min="1" max="18"></label>
    </div>
    <div id="uc-ocr-canvas-wrap" class="mt-2">
      <canvas id="uc-ocr-canvas"></canvas>
      <div id="ocr-rect"></div>
      <div id="h1" class="ocr-handle"></div>
      <div id="h2" class="ocr-handle"></div>
      <div id="h3" class="ocr-handle"></div>
      <div id="h4" class="ocr-handle"></div>
    </div>
    <div class="mt-2 ocr-grid-3">
      <button id="uc-ocr-run" class="ocr-btn primary">Run OCR</button>
      <button id="uc-ocr-clear" class="ocr-btn ghost">Reset</button>
      <div id="uc-ocr-progress" class="text-sm" style="padding:.6rem 0;">Ready</div>
    </div>
    <div id="uc-ocr-map" class="mt-3"></div>
    <div id="uc-ocr-preview" class="mt-2"></div>
  </div>
  <div id="uc-ocr-foot"><button id="uc-ocr-apply" class="ocr-btn primary">Apply to Scores</button></div>
</div>`;
    document.body.appendChild(wrap);
  }

  function openPanel(){ const b=document.getElementById("uc-ocr-backdrop"); const p=document.getElementById("uc-ocr-panel"); if(b&&p){ b.classList.add("open"); p.classList.add("open"); p.setAttribute("aria-hidden","false"); } }
  function closePanel(){ const b=document.getElementById("uc-ocr-backdrop"); const p=document.getElementById("uc-ocr-panel"); if(b&&p){ b.classList.remove("open"); p.classList.remove("open"); p.setAttribute("aria-hidden","true"); } }

  async function loadTesseract(){
    if (window.Tesseract) return true;
    const urls = [
      "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js",
      "https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"
    ];
    for (let i=0;i<urls.length;i++){
      try{
        await new Promise((res,rej)=>{ const s=document.createElement("script"); s.src=urls[i]; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
        if (window.Tesseract) return true;
      }catch(e){ /* try next */ }
    }
    return false;
  }

  // Expose globals so buttons can call directly
  window.ucg_open_scan = async function(){
    injectOCRShell();
    openPanel(); // open immediately; don't block on CDN
    const prog = document.getElementById("uc-ocr-progress"); if (prog) prog.textContent = "Loading OCR engine...";
    const ok = await loadTesseract();
    if (prog) prog.textContent = ok ? "Ready" : "Failed to load OCR engine (check internet / shields).";
    if (!window.__uc_ocr_wired){ wireEngine(); window.__uc_ocr_wired = true; }
  };

  function wireEngine(){
    const fileInp = document.getElementById("uc-ocr-file");
    const rotSel = document.getElementById("uc-ocr-rot");
    const segSel = document.getElementById("uc-ocr-seg");
    const layoutSel = document.getElementById("uc-ocr-layout");
    const rowsInp = document.getElementById("uc-ocr-rows");
    const colsInp = document.getElementById("uc-ocr-cols");
    const runBtn = document.getElementById("uc-ocr-run");
    const clearBtn = document.getElementById("uc-ocr-clear");
    const applyBtn = document.getElementById("uc-ocr-apply");
    const prog = document.getElementById("uc-ocr-progress");
    const mapWrap = document.getElementById("uc-ocr-map");
    const previewWrap = document.getElementById("uc-ocr-preview");
    const canvas = document.getElementById("uc-ocr-canvas");
    const ctx = canvas.getContext("2d");
    const rectEl = document.getElementById("ocr-rect");
    const handles = [document.getElementById("h1"),document.getElementById("h2"),document.getElementById("h3"),document.getElementById("h4")];
    const closeBtn = document.getElementById("uc-ocr-close");
    if (closeBtn){ closeBtn.addEventListener("click", closePanel); }
    document.getElementById("uc-ocr-backdrop").addEventListener("click", closePanel);
    let img = new Image(); let blobUrl=null; let crop={x:50,y:50,w:200,h:200}; let dragging=null;
    function loadImage(file){ if(blobUrl) URL.revokeObjectURL(blobUrl); blobUrl=URL.createObjectURL(file); img.onload=()=>{ draw(); initCrop(); }; img.src=blobUrl; }
    function draw(){ const rot=Number(rotSel.value||0); const maxW=canvas.parentElement.clientWidth-2; const scale=img.width?Math.min(1,maxW/img.width):1; const w0=Math.round(img.width*scale), h0=Math.round(img.height*scale);
      if(rot%180===0){ canvas.width=w0; canvas.height=h0; ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,w0,h0); }
      else{ canvas.width=h0; canvas.height=w0; ctx.setTransform(0,1,-1,0,h0,0); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,w0,h0); ctx.setTransform(1,0,0,1,0,0); }
      positionOverlay();
    }
    function initCrop(){ const pad=20; crop={x:pad,y:pad,w:canvas.width-pad*2,h:canvas.height-pad*2}; positionOverlay(); }
    function positionOverlay(){ rectEl.style.left=crop.x+"px"; rectEl.style.top=crop.y+"px"; rectEl.style.width=crop.w+"px"; rectEl.style.height=crop.h+"px";
      const pts=[{x:crop.x,y:crop.y},{x:crop.x+crop.w,y:crop.y},{x:crop.x+crop.w,y:crop.y+crop.h},{x:crop.x,y:crop.y+crop.h}]; handles.forEach((h,i)=>{ h.style.left=pts[i].x+"px"; h.style.top=pts[i].y+"px"; });
    }
    function within(el,x,y){ const r=el.getBoundingClientRect(); const c=canvas.getBoundingClientRect(); const ex=r.left-c.left, ey=r.top-c.top; return Math.abs(ex-x)<20&&Math.abs(ey-y)<20; }
    function onDown(e){ const rect=canvas.getBoundingClientRect(); const x=e.clientX-rect.left, y=e.clientY-rect.top;
      for(let i=0;i<handles.length;i++){ if(within(handles[i],x,y)){ dragging=i; e.preventDefault(); return; } } if(x>=crop.x&&x<=crop.x+crop.w&&y>=crop.y&&y<=crop.y+crop.h){ dragging="move"; e.preventDefault(); } }
    function onMove(e){ if(dragging==null) return; const rect=canvas.getBoundingClientRect(); const x=Math.max(0,Math.min(canvas.width,e.clientX-rect.left)); const y=Math.max(0,Math.min(canvas.height,e.clientY-rect.top));
      if(dragging==="move"){ crop.x=Math.max(0,Math.min(canvas.width-crop.w,x-crop.w/2)); crop.y=Math.max(0,Math.min(canvas.height-crop.h,y-crop.h/2)); }
      else{ const i=dragging; if(i===0){ const dx=crop.x+crop.w-x, dy=crop.y+crop.h-y; crop.w=Math.max(50,dx); crop.h=Math.max(50,dy); crop.x=Math.min(x,crop.x+crop.w-50); crop.y=Math.min(y,crop.y+crop.h-50); }
            else if(i===1){ const dx=x-crop.x, dy=crop.y+crop.h-y; crop.w=Math.max(50,dx); crop.h=Math.max(50,dy); crop.y=Math.min(y,crop.y+crop.h-50); }
            else if(i===2){ crop.w=Math.max(50,x-crop.x); crop.h=Math.max(50,y-crop.y); }
            else if(i===3){ const dx=crop.x+crop.w-x, dy=y-crop.y; crop.w=Math.max(50,dx); crop.h=Math.max(50,dy); crop.x=Math.min(x,crop.x+crop.w-50); } }
      positionOverlay();
    }
    function onUp(){ dragging=null; }
    canvas.addEventListener("mousedown", onDown); canvas.addEventListener("mousemove", onMove); window.addEventListener("mouseup", onUp);
    canvas.addEventListener("touchstart", e=>onDown(e.touches[0]), {passive:false}); canvas.addEventListener("touchmove", e=>onMove(e.touches[0]), {passive:false}); window.addEventListener("touchend", onUp);
    fileInp.addEventListener("change", ()=>{ const f=fileInp.files&&fileInp.files[0]; if(f) loadImage(f); }); rotSel.addEventListener("input", ()=>{ if(img&&img.width) draw(); });

    document.getElementById("uc-ocr-run").addEventListener("click", async ()=>{
      if(!window.Tesseract){ alert("OCR engine not loaded (blocked by network or shields). You can still type scores manually or disable shields then retry."); return; }
      if(!img||!img.width){ alert("Please choose a scorecard image."); return; }
      const rows=Math.max(1,Number(rowsInp.value)||1); let cols=Math.max(1,Number(colsInp.value)||9); const seg=segSel.value;
      if(seg==="f9"||seg==="b9") cols=9; else if(seg==="18") cols=18;
      const off=document.createElement("canvas"); const octx=off.getContext("2d");
      const sx=Math.round(crop.x), sy=Math.round(crop.y), sw=Math.round(crop.w), sh=Math.round(crop.h);
      const cellW=Math.floor(sw/cols), cellH=Math.floor(sh/rows); const grid=Array(rows).fill(0).map(()=>Array(cols).fill(""));
      prog.textContent="OCR running...";
      for(let r=0;r<rows;r++){ for(let c=0;c<cols;c++){ off.width=cellW; off.height=cellH;
        octx.drawImage(canvas, sx+c*cellW, sy+r*cellH, cellW, cellH, 0,0, cellW, cellH);
        try{ const {data}=await Tesseract.recognize(off,'eng',{tessedit_char_whitelist:'0123456789',legacy:false}); let text=(data&&data.text||"").replace(/[^0-9]/g,""); grid[r][c]=text; }catch(_){ grid[r][c]=""; }
        prog.textContent=`OCR: row ${r+1}/${rows}, col ${c+1}/${cols}`; } }
      prog.textContent="OCR complete. Review and map players."; renderPreview(grid);
    });

    function renderPreview(grid){
      const layout=layoutSel.value; const rows=grid.length, cols=grid[0]?.length||0;
      const st=JSON.parse(localStorage.getItem("uc.games.v3")||"{}"); const players=st.players||[];
      function playerOpts(){ return players.map(p=>`<option value="${p.id||p.name}">${p.name||p.id}</option>`).join(""); }
      let mapHTML=""; if(layout==="prow-hcol"){ mapHTML+=`<div><strong>Row → Player mapping</strong></div>`; for(let r=0;r<rows;r++){ mapHTML+=`<div style="display:flex;gap:.5rem;margin:.25rem 0;"><label style="min-width:80px;">Row ${r+1}</label><select data-map-row="${r}" class="ocr-select">${playerOpts()}</select></div>`; } }
      else { mapHTML+=`<div><strong>Column → Player mapping</strong></div>`; for(let c=0;c<cols;c++){ mapHTML+=`<div style="display:flex;gap:.5rem;margin:.25rem 0;"><label style="min-width:80px;">Col ${c+1}</label><select data-map-col="${c}" class="ocr-select">${playerOpts()}</select></div>`; } }
      document.getElementById("uc-ocr-map").innerHTML=mapHTML;
      let html=`<table class="ocr-preview"><thead><tr><th></th>`; for(let c=0;c<cols;c++) html+=`<th>${c+1}</th>`; html+=`</tr></thead><tbody>`;
      for(let r=0;r<rows;r++){ html+=`<tr><th>${r+1}</th>`; for(let c=0;c<cols;c++){ const v=grid[r][c]||""; html+=`<td><input type="number" inputmode="numeric" pattern="[0-9]*" value="${v}" style="width:56px;padding:.25rem;border:1px solid #e5e7eb;border-radius:.25rem;"></td>`; } html+=`</tr>`; }
      html+=`</tbody></table>`; document.getElementById("uc-ocr-preview").innerHTML=html;
      document.querySelectorAll("#uc-ocr-preview input[type='number']").forEach((inp,idx)=>{ inp.addEventListener("input",()=>{ const r=Math.floor(idx/cols), c=idx%cols; grid[r][c]=(inp.value||"").replace(/[^0-9]/g,""); }); });
      document.getElementById("uc-ocr-apply").onclick=()=>{
        const layout=layoutSel.value; const seg=segSel.value; const rows=grid.length, cols=grid[0]?.length||0;
        const st=JSON.parse(localStorage.getItem("uc.games.v3")||"{}"); const players=st.players||[]; const map={};
        if(layout==="prow-hcol"){ document.querySelectorAll("[data-map-row]").forEach(sel=>{ map[Number(sel.getAttribute("data-map-row"))]=sel.value; });
          const holeStart=(seg==="f9")?0:(seg==="b9"?9:0); const holeCount=(seg==="18")?18:9;
          for(let r=0;r<rows;r++){ const pid=map[r]; if(!pid) continue; const p=players.find(pp=>(pp.id||pp.name)===pid); if(!p) continue; if(!Array.isArray(p.gross)||p.gross.length!==18) p.gross=Array(18).fill(null);
            for(let c=0;c<holeCount&&c<cols;c++){ const v=grid[r][c]?Number(grid[r][c]):null; p.gross[holeStart+c]=(v&&v>0)?v:p.gross[holeStart+c]; } } }
        else { document.querySelectorAll("[data-map-col]").forEach(sel=>{ map[Number(sel.getAttribute("data-map-col"))]=sel.value; });
          const holeStart=(seg==="f9")?0:(seg==="b9"?9:0); const holeCount=(seg==="18")?18:9;
          for(let c=0;c<cols;c++){ const pid=map[c]; if(!pid) continue; const p=players.find(pp=>(pp.id||pp.name)===pid); if(!p) continue; if(!Array.isArray(p.gross)||p.gross.length!==18) p.gross=Array(18).fill(null);
            for(let r=0;r<holeCount&&r<rows;r++){ const v=grid[r][c]?Number(grid[r][c]):null; p.gross[holeStart+r]=(v&&v>0)?v:p.gross[holeStart+r]; } } }
        localStorage.setItem("uc.games.v3", JSON.stringify(st));
        try{ const tbody=document.getElementById("ucg-score-body"); if(tbody){ const rowsEl=Array.from(tbody.querySelectorAll("tr"));
          rowsEl.forEach(row=>{ const name=(row.querySelector("td")||{}).textContent?.trim()||""; const p=(st.players||[]).find(pp=>(pp.name||"")===name);
            if(p){ const inputs=Array.from(row.querySelectorAll("input[type='number']")); inputs.forEach((inp,idx)=>{ const v=(p.gross||[])[idx]; if(v!=null){ inp.value=v; inp.dispatchEvent(new Event("input",{bubbles:true})); } }); } }); } }catch(_){}
        alert("Scores imported. Close this panel to see game results.");
      };
    }
  }

  function bindButtons(){
    const ids = ["ucg-ocr-open","ucg-ocr-open2"];
    ids.forEach(id=>{
      const b = document.getElementById(id);
      if (b && !b.__scanbound){
        b.__scanbound = true;
        b.addEventListener("click", function(ev){ try{ev.preventDefault();}catch(e){} window.ucg_open_scan(); });
      }
    });
  }

  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", bindButtons);
  } else {
    bindButtons();
  }
  setInterval(bindButtons, 1500); // in case the Games panel is re-rendered
})();
</script>
<script>
(function(){
  if (window.__ucg_v6_ext) return; window.__ucg_v6_ext = true;

  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
  function num(v, d){ const n = Number(v); return Number.isFinite(n) ? n : (d ?? 0); }

  // ---------- Course Directory Importer ----------
  (function(){
    const LS = "uc.courses";
    function getCourses(){ try{ return JSON.parse(localStorage.getItem(LS)||"[]"); }catch(_){ return []; } }
    function saveCourses(arr){ try{ localStorage.setItem(LS, JSON.stringify(arr||[])); }catch(_){ } }

    // Overlay
    const sheet = document.createElement("div");
    sheet.id = "uc-course-sheet";
    sheet.style.cssText = "display:none; position:fixed; inset:0; z-index:2147483606;";
    sheet.innerHTML = `<div style="position:absolute; inset:0; background:rgba(0,0,0,.35)"></div>
      <div style="position:absolute; right:0; top:0; width:min(760px,100%); height:100%; background:#fff; display:flex; flex-direction:column;">
        <div style="display:flex; justify-content:space-between; align-items:center; padding:.75rem 1rem; background:#0f172a; color:#fff;">
          <div>Course Directory</div>
          <div><button id="uc-course-close" class="ocr-btn ghost">Close</button></div>
        </div>
        <div style="flex:1; overflow:auto; padding:12px;">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <div>
              <div class="font-semibold mb-1">Import CSV</div>
              <div class="text-sm mb-2">Columns: Course, City, Tee, Par, CR, Slope, SI1..SI18, PAR1..PAR18</div>
              <textarea id="uc-course-csv" style="width:100%; height:180px; border:1px solid #e5e7eb; border-radius:.5rem; padding:8px;" placeholder="Paste CSV rows here"></textarea>
              <div class="mt-2 flex gap-2">
                <button id="uc-course-parse" class="px-2 py-1 border rounded">Add Courses</button>
                <button id="uc-course-clear" class="px-2 py-1 border rounded">Clear All</button>
              </div>
            </div>
            <div>
              <div class="font-semibold mb-1">Search</div>
              <input id="uc-course-q" class="border rounded p-2 w-full" placeholder="Search course or city"/>
              <div id="uc-course-list" class="mt-2 text-sm"></div>
            </div>
          </div>
        </div>
      </div>`;
    document.body.appendChild(sheet);
    const listEl = $("#uc-course-list", sheet);
    function renderList(){
      const q = ($("#uc-course-q", sheet).value || "").toLowerCase();
      const arr = getCourses();
      const f = arr.filter(c => (c.Course||"").toLowerCase().includes(q) || (c.City||"").toLowerCase().includes(q));
      listEl.innerHTML = f.map((c,i)=>`<div class="border rounded p-2 mb-1 flex items-center justify-between">
        <div><div class="font-medium">${c.Course} • ${c.Tee}</div><div class="text-xs text-gray-600">${c.City||""} — CR ${c.CR} / Slope ${c.Slope} / Par ${c.Par}</div></div>
        <div class="flex gap-2">
          <button data-i="${i}" class="px-2 py-1 border rounded apply">Apply</button>
          <button data-i="${i}" class="px-2 py-1 border rounded del">Delete</button>
        </div>
      </div>`).join("") || "<div class='text-sm text-gray-500'>No courses yet.</div>";
      $all("button.apply", listEl).forEach(btn=> btn.addEventListener("click", ()=>{
        const i = Number(btn.getAttribute("data-i")); const c = f[i];
        if (!c) return;
        // Apply to course + tees
        try{
          const st = window.__ucg_get_state();
          st.course.tee = c.Tee || "";
          st.course.parTotal = num(c.Par, 72);
          st.course.cr = num(c.CR, 72);
          st.course.slope = num(c.Slope, 120);
          st.course.si = (c.SI||[]);
          st.course.pars = (c.PARS||[]);
          window.__ucg_set_state(st);
          alert(`Loaded ${c.Course} • ${c.Tee}`);
        }catch(e){ alert("Failed to apply course: "+e.message); }
      }));
      $all("button.del", listEl).forEach(btn=> btn.addEventListener("click", ()=>{
        const i = Number(btn.getAttribute("data-i")); const idx = arr.indexOf(f[i]); if (idx>=0){ arr.splice(idx,1); saveCourses(arr); renderList(); }
      }));
    }
    $("#uc-course-q", sheet).addEventListener("input", renderList);
    $("#uc-course-close", sheet).addEventListener("click", ()=> sheet.style.display="none");
    $("#uc-course-clear", sheet).addEventListener("click", ()=>{ if(confirm("Delete all saved courses?")){ saveCourses([]); renderList(); } });
    $("#uc-course-parse", sheet).addEventListener("click", ()=>{
      const t = $("#uc-course-csv", sheet).value || "";
      const rows = t.trim().split(/\r?\n/).map(r=> r.split(",").map(s=>s.trim()) ).filter(r=>r.length>=6);
      const arr = getCourses();
      rows.forEach(r=>{
        const [Course, City, Tee, Par, CR, Slope, ...rest] = r;
        const si = rest.slice(0,18).map(x=>num(x,0)); const pars = rest.slice(18,36).map(x=>num(x,4));
        arr.push({Course, City, Tee, Par:num(Par,72), CR:num(CR,72), Slope:num(Slope,120), SI:si, PARS:pars});
      });
      saveCourses(arr); renderList(); alert(`Imported ${rows.length} row(s).`);
    });

    // Hook the header "Course Directory" button
    document.getElementById("ucg-dir").addEventListener("click", ()=>{ sheet.style.display="block"; renderList(); });
  })();

  // ---------- Leaderboards & Ledger ----------
  window.renderLeaderboards = function(pcalc){
    const st = window.__ucg_get_state();
    const table = document.getElementById("ucg-leader-table");
    const ledgerEl = document.getElementById("ucg-ledger");
    if (!table || !ledgerEl) return;

    // Gather per-player metrics from existing outputs
    // We recompute here for clean data
    const pars = st.course.pars;
    function net(p,h,scheme){ const s = (scheme==="S"?p.strokesS[h]:p.strokesN[h])||0; const g=(p.gross||[])[h]; if(g==null) return null; return g - s; }
    function stbPts(p){
      const allow = st.games.stb.allow||1;
      const strokes = p.strokesS;
      const tbl = (function(kind, custom){
        if (kind==="modified") return {"albatross":8,"eagle":5,"birdie":2,"par":0,"bogey":-1,"dbl+":-3};
        if (kind==="custom"){ try{ return JSON.parse(custom||"{}"); }catch(_){ return {"dbl+":0,"bogey":1,"par":2,"birdie":3,"eagle":4,"albatross":5}; } }
        return {"dbl+":0,"bogey":1,"par":2,"birdie":3,"eagle":4,"albatross":5};
      })(st.games.stb.table, st.games.stb.custom);
      function classify(vs){ if (vs<=-3) return "albatross"; if (vs===-2) return "eagle"; if (vs===-1) return "birdie"; if (vs===0) return "par"; if (vs===1) return "bogey"; return "dbl+"; }
      let tot=0; for(let h=0;h<18;h++){ const g=(p.gross||[])[h]; if(g==null) continue; const vs=(g - (strokes[h]||0)) - (pars[h]||4); const cls=classify(vs); tot += (cls in tbl) ? tbl[cls] : 0; }
      return tot;
    }
    function quotaNet(p){
      const base = st.games.quota.base || 36;
      const Pts = st.games.quota.pts;
      function classify(vs){ if (vs<=-3) return "albatross"; if (vs===-2) return "eagle"; if (vs===-1) return "birdie"; if (vs===0) return "par"; if (vs===1) return "bogey"; return "dbl+"; }
      function holePts(vs){ const cls=classify(vs); if (cls==="albatross") return Pts.ala||10; if (cls==="eagle") return Pts.eagle||8; if (cls==="birdie") return Pts.birdie||4; if (cls==="par") return Pts.par||2; if (cls==="bogey") return Pts.bogey||1; return 0; }
      let pts=0; for(let h=0;h<18;h++){ const g=(p.gross||[])[h]; if(g==null) continue; const vs=(g - (p.strokesS[h]||0)) - (pars[h]||4); pts += holePts(vs); }
      const quota = Math.max(0, Math.round((st.games.quota.base||36) - (p.hi||0)));
      return pts - quota;
    }
    function wolfPts(p){ return 0; } // computed earlier in panel; we'll re-pull from DOM if needed

    // Skins wins recompute
    const nets = pcalc.map(p=> Array.from({length:18},(_,h)=> net(p,h,"N")) );
    let wins=pcalc.map(_=>0), carry=0;
    for(let h=0;h<18;h++){ const vals=nets.map(n=>n[h]).filter(v=>v!=null); if(vals.length<pcalc.length) continue; const low=Math.min(...vals); const w=[]; nets.forEach((n,i)=>{ if(n[h]===low) w.push(i); }); if(w.length===1){ wins[w[0]] += 1+carry; carry=0; } else { carry+=1; } }

    // Junk dots (from state)
    const counts = st.games.junk.counts || {};

    // Build rows
    const rows = pcalc.map((p,i)=>{
      const name = p.name;
      const entry = {
        id: p.id, name,
        stb: stbPts(p),
        quota: quotaNet(p),
        skins: wins[i],
        junk: (counts[p.id]?.greenies||0)+(counts[p.id]?.sandies||0)+(counts[p.id]?.chippies||0)+(counts[p.id]?.barkies||0),
        wolf: 0, x531: 0
      };
      return entry;
    });

    // Pull Wolf & 5-3-1 from their cards if present (quick parse)
    try{
      const wolfCard = document.getElementById("ucg-out-wolf"); if (wolfCard){ const re=/^(?:🏆 )?(.+?): (\d+) pts$/; rows.forEach(r=>{ const line = Array.from(wolfCard.querySelectorAll("div")).find(d=> (d.textContent||"").startsWith(r.name+":")); if(line){ const m=(line.textContent||"").match(/: (\d+) pts/); if(m) r.wolf = Number(m[1]); } }); }
      const fCard = document.getElementById("ucg-out-531"); if (fCard){ rows.forEach(r=>{ const line = Array.from(fCard.querySelectorAll("div")).find(d=> (d.textContent||"").includes(r.name+":")); if(line){ const m=(line.textContent||"").match(/: (\d+) pts/); if(m) r.x531 = Number(m[1]); } }); }
    }catch(_){}

    // Payout ledger — simple model across enabled games
    // - Skins: mode 'each' (default) => each non-winner pays winner stake per skin.
    // - Junk: per dot stake.
    // - Nassau/Quota/Stableford/Wolf/531: show points leaderboard but no enforced money unless configured (future).
    const balances = {}; rows.forEach(r=> balances[r.id]=0);
    const N = pcalc.length;

    // Skins payouts
    if (st.games.skins.enabled){
      const per = st.games.skins.stake || 0;
      // assume "each" mode: each skin winner collects (N-1) * per; others pay proportionally (split by number of non-winners with complete card)
      rows.forEach((r,i)=>{ balances[r.id] += r.skins * per * (N-1); });
      const totalSkins = rows.reduce((s,r)=> s + r.skins, 0);
      const totalPay = totalSkins * per * (N-1);
      const avgPayPerLoser = totalPay / (N*(N-1)); // rough even spread
      rows.forEach(r=>{ balances[r.id] -= avgPayPerLoser * (N-1); });
    }

    // Junk payouts
    if (st.games.junk.enabled){
      const per = st.games.junk.stake || 0;
      rows.forEach(r=>{ balances[r.id] += r.junk * per; });
      const totalDots = rows.reduce((s,r)=> s + r.junk, 0);
      const avg = totalDots * per / N;
      rows.forEach(r=>{ balances[r.id] -= avg; });
    }

    // Build table
    const metricSel = document.getElementById("ucg-leader-metric");
    const metric = metricSel ? metricSel.value : "payout";
    const sortKey = (metric==="payout")?"payout":metric.replace("531","x531");
    rows.forEach(r=> r.payout = Math.round((balances[r.id]||0)));
    rows.sort((a,b)=> (b[sortKey]||0) - (a[sortKey]||0) );

    const headers = ["#", "Player", "Payout (PTS)", "Stableford", "Quota net", "Skins", "Wolf", "5-3-1", "Dots"];
    const lines = rows.map((r,idx)=> `<tr>
      <td class="px-2 py-1 border text-center">${idx+1}</td>
      <td class="px-2 py-1 border">${r.name}</td>
      <td class="px-2 py-1 border text-right">${r.payout}</td>
      <td class="px-2 py-1 border text-center">${r.stb}</td>
      <td class="px-2 py-1 border text-center">${r.quota>=0?"+":""}${r.quota}</td>
      <td class="px-2 py-1 border text-center">${r.skins}</td>
      <td class="px-2 py-1 border text-center">${r.wolf}</td>
      <td class="px-2 py-1 border text-center">${r.x531}</td>
      <td class="px-2 py-1 border text-center">${r.junk}</td>
    </tr>`).join("");

    table.innerHTML = `<div class="ucg-scroll"><table class="min-w-full border-collapse">
      <thead><tr>${headers.map(h=>`<th class="px-2 py-1 border bg-gray-50 text-left">${h}</th>`).join("")}</tr></thead>
      <tbody>${lines}</tbody></table></div>`;

    // Ledger details (pairwise net)
    const names = {}; pcalc.forEach(p=> names[p.id]=p.name);
    const ledLines = Object.keys(balances).map(pid=>{
      const val = Math.round(balances[pid]);
      return `<div>${names[pid]}: <strong>${val>=0? "Receives":"Pays"}</strong> ${Math.abs(val)} PTS</div>`;
    }).join("");
    ledgerEl.innerHTML = ledLines || "<div>No money games enabled.</div>";

    if (metricSel && !metricSel.__bound){ metricSel.__bound=true; metricSel.addEventListener("input", ()=> window.renderLeaderboards(pcalc)); }

    // CSV export
    const csvBtn = document.getElementById("ucg-export-csv");
    if (csvBtn && !csvBtn.__bound){
      csvBtn.__bound = true;
      csvBtn.addEventListener("click", ()=>{
        const rows2 = [["Player","PayoutPTS","Stableford","QuotaNet","Skins","Wolf","531","Dots"]].concat(
          rows.map(r=> [r.name, r.payout, r.stb, r.quota, r.skins, r.wolf, r.x531, r.junk])
        );
        const csv = rows2.map(r=> r.join(",")).join("\n");
        const blob = new Blob([csv], {type:"text/csv"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "payouts.csv"; a.click();
        URL.revokeObjectURL(url);
      });
    }
  };

  // ---------- Ryder Cup (Singles & Fourball) ----------
  (function(){
    const host = document.getElementById("ucg-tab-ryder");
    if (!host) return;
    host.innerHTML = `
      <div class="card space-y-2">
        <div class="flex items-center justify-between">
          <div class="font-semibold text-gray-900">Ryder Cup Matches</div>
          <div class="flex items-center gap-2">
            <select id="ry-allow" class="border rounded p-1">
              <option value="full">Full handicap</option>
              <option value="3/4">3/4 allowance</option>
            </select>
            <button id="ry-add" class="px-2 py-1 border rounded">+ Add Match</button>
          </div>
        </div>
        <div id="ry-list" class="space-y-2"></div>
        <div class="mt-2"><strong>Scoreboard:</strong> <span id="ry-score">A 0 — 0 B</span></div>
      </div>
    `;
    const st = window.__ucg_get_state();
    st.games.ryder = st.games.ryder || { matches: [] };
    window.__ucg_set_state(st); // ensures save

    const list = document.getElementById("ry-list");
    function playerOptions(team){ const s = window.__ucg_get_state(); return s.players.filter(p=> !team || p.team===team).map(p=> `<option value="${p.id}">${p.name}</option>`).join(""); }
    function render(){
      const s = window.__ucg_get_state();
      const m = (s.games.ryder && s.games.ryder.matches) || [];
      list.innerHTML = m.map((mm,idx)=>{
        return `<div class="border rounded p-2">
          <div class="flex items-center gap-2">
            <select data-i="${idx}" data-k="type" class="border rounded p-1">
              <option value="fourball"${mm.type==="fourball"?" selected":""}>Fourball (better-ball)</option>
              <option value="singles"${mm.type==="singles"?" selected":""}>Singles</option>
            </select>
            <span class="chip">Match ${idx+1}</span>
            <button data-i="${idx}" class="px-2 py-1 border rounded del">Delete</button>
          </div>
          <div class="grid md:grid-cols-2 gap-2 mt-2">
            <div class="card">
              <div class="font-medium mb-1">Team A</div>
              <div class="flex gap-2">${ mm.type==="singles"
                ? `<select data-i="${idx}" data-k="a1" class="border rounded p-1">${playerOptions("A")}</select>`
                : `<select data-i="${idx}" data-k="a1" class="border rounded p-1">${playerOptions("A")}</select><select data-i="${idx}" data-k="a2" class="border rounded p-1">${playerOptions("A")}</select>`
              }</div>
            </div>
            <div class="card">
              <div class="font-medium mb-1">Team B</div>
              <div class="flex gap-2">${ mm.type==="singles"
                ? `<select data-i="${idx}" data-k="b1" class="border rounded p-1">${playerOptions("B")}</select>`
                : `<select data-i="${idx}" data-k="b1" class="border rounded p-1">${playerOptions("B")}</select><select data-i="${idx}" data-k="b2" class="border rounded p-1">${playerOptions("B")}</select>`
              }</div>
            </div>
          </div>
          <div class="text-sm text-gray-600 mt-1">Auto-strokes applied (WHS) vs lowest Course Handicap in the match. 1 point win, 0.5 halve.</div>
        </div>`;
      }).join("") || "<div class='text-sm text-gray-500'>No matches yet. Click + Add Match.</div>";

      // Wire changes
      $all("select[data-k]", list).forEach(sel=>{
        sel.addEventListener("input", ()=>{
          const i = Number(sel.getAttribute("data-i"));
          const k = sel.getAttribute("data-k");
          const s2 = window.__ucg_get_state();
          s2.games.ryder.matches[i][k] = sel.value;
          window.__ucg_set_state(s2);
        });
      });
      $all("select[data-k='type']", list).forEach(sel=>{
        sel.addEventListener("input", ()=> render()); // re-render layout for singles vs fourball
      });
      $all("button.del", list).forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const i = Number(btn.getAttribute("data-i"));
          const s2 = window.__ucg_get_state();
          s2.games.ryder.matches.splice(i,1);
          window.__ucg_set_state(s2);
          render(); compute();
        });
      });
      compute();
    }

    function addMatch(){
      const s = window.__ucg_get_state();
      s.games.ryder.matches.push({type:"fourball", a1:"", a2:"", b1:"", b2:""});
      window.__ucg_set_state(s);
      render();
    }
    document.getElementById("ry-add").addEventListener("click", addMatch);

    function compute(){
      const s = window.__ucg_get_state();
      const matches = s.games.ryder.matches||[];
      const cc = s.course, si=cc.si, pars=cc.pars;
      const allowMode = document.getElementById("ry-allow").value;
      // helper
      function chOf(p){ const usedSlope = (p.teeSlope!=null && p.teeSlope!=="") ? num(p.teeSlope, cc.slope) : cc.slope;
        const usedCR = (p.teeCR!=null && p.teeCR!=="") ? num(p.teeCR, cc.cr) : cc.cr;
        return Math.round( (p.hi||0) * (usedSlope/113) + (usedCR - cc.parTotal) );
      }
      function strokesPerHoleFromCH(ch){
        const strokes = new Array(18).fill(0);
        if (!ch) return strokes;
        const sign = ch>0 ? 1 : -1; const abs = Math.abs(ch);
        const base = Math.floor(abs/18), extra = abs%18;
        for (let i=0;i<18;i++) strokes[i]=base*sign;
        const order = si.map((v,idx)=>({v,idx})).sort((a,b)=>a.v-b.v);
        for (let k=0;k<extra;k++) strokes[order[k].idx]+=1*sign;
        return strokes;
      }
      function applyAllowance(ch){
        if (allowMode==="3/4") return Math.round(ch*0.75);
        return ch;
      }
      function netScore(p,h,strokes){ const g=(p.gross||[])[h]; if(g==null) return null; return g - (strokes[h]||0); }

      let scoreA=0, scoreB=0;
      matches.forEach(m=>{
        // collect players
        const players = [m.a1,m.a2,m.b1,m.b2].filter(Boolean).map(id=> s.players.find(pp=>pp.id===id)).filter(Boolean);
        if (!players.length) return;
        const chs = players.map(p=> chOf(p));
        const lowCH = Math.min(...chs);
        const strokesMap = {};
        players.forEach((p,i)=>{ const adj = applyAllowance(chs[i] - lowCH); strokesMap[p.id] = strokesPerHoleFromCH(adj); });

        let up=0;
        for(let h=0;h<18;h++){
          if (m.type==="singles"){
            const A = s.players.find(pp=>pp.id===m.a1), B = s.players.find(pp=>pp.id===m.b1);
            if (!A||!B) continue;
            const a = netScore(A,h,strokesMap[A.id]||new Array(18).fill(0));
            const b = netScore(B,h,strokesMap[B.id]||new Array(18).fill(0));
            if (a==null||b==null) continue;
            if (a<b) up+=1; else if (b<a) up-=1;
          } else { // fourball better-ball
            const A1 = s.players.find(pp=>pp.id===m.a1), A2 = s.players.find(pp=>pp.id===m.a2);
            const B1 = s.players.find(pp=>pp.id===m.b1), B2 = s.players.find(pp=>pp.id===m.b2);
            if (!A1||!A2||!B1||!B2) continue;
            const a = Math.min(
              netScore(A1,h,strokesMap[A1.id]||new Array(18).fill(0)),
              netScore(A2,h,strokesMap[A2.id]||new Array(18).fill(0))
            );
            const b = Math.min(
              netScore(B1,h,strokesMap[B1.id]||new Array(18).fill(0)),
              netScore(B2,h,strokesMap[B2.id]||new Array(18).fill(0))
            );
            if (!Number.isFinite(a) || !Number.isFinite(b)) continue;
            if (a<b) up+=1; else if (b<a) up-=1;
          }
        }
        if (up>0) scoreA += 1; else if (up<0) scoreB += 1; else { scoreA += 0.5; scoreB += 0.5; }
      });
      $("#ry-score").textContent = `A ${scoreA} — ${scoreB} B`;
    }

    document.getElementById("ry-allow").addEventListener("input", ()=>{ render(); });
    window.addEventListener("ucg-after-compute", ()=>{ render(); });
    render();
  })();

})();
</script>
<script>
<!-- booking confirmation injection removed in v6n -->
</script>
<script>
(function(){ try{ var el=document.getElementById('cw-golfer-booked-card'); if(el) el.remove(); }catch(_){} })();
</script>
<script>
// --- Seed demo data: Sarah booked Ning; Peter #1, Marcus #2 in queue ---
(function(){
  if (!window.CW || !CW.safeJSON) return;
  const SLOT = '2025-09-05 07:30';
  const bookings = CW.safeJSON.get('cw:bookings',{})||{};
  const queues = CW.safeJSON.get('cw:queues',{})||{};
  if (!bookings[SLOT]) bookings[SLOT] = { gid:'GOLF-SARAH', cid:'CADDY-NING' };
  if (!queues[SLOT] || queues[SLOT].length===0) queues[SLOT] = ['GOLF-PETER','GOLF-MARCUS'];
  CW.safeJSON.set('cw:bookings', bookings);
  CW.safeJSON.set('cw:queues', queues);
  // fire events so panels render
  try{ CW.Events.emit('cw:booking:updated',{slot:SLOT}); CW.Events.emit('cw:queue:updated',{slot:SLOT}); }catch(_){}
})();
</script>
<script>
(function(){
  if (window.__cw_sched_demo_v2) return; window.__cw_sched_demo_v2 = true;

  const SLOT = '2025-09-05 07:30';
  const CADDY_ID = 'CADDY-NING';
  const CADDY_NAME = 'Ning';
  const G_PETER  = 'GOLF-PETER';
  const G_MARCUS = 'GOLF-MARCUS';
  const G_SARAH  = 'GOLF-SARAH';

  // Core helpers
  window.CW = window.CW || {};
  CW.Events = CW.Events || { _m:{}, on(ev,fn){ (this._m[ev]=this._m[ev]||[]).push(fn); }, emit(ev,p){ (this._m[ev]||[]).forEach(f=>{ try{ f(p); }catch(_){}}); } };
  CW.safeJSON = CW.safeJSON || {
    get(k,d){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d; }catch(_){ return d; } },
    set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ }
    }
  };
  CW.identity = CW.identity || {
    role(){ return localStorage.getItem('cw:me:role')||'golfer'; },
    gid(){ const r=this.role(); return r==='caddy' ? (localStorage.getItem('cw:me:caddy')||CADDY_ID)
                                                    : (localStorage.getItem('cw:me:golfer')||G_PETER); },
    set(role,gid){
      try{
        localStorage.setItem('cw:me:role', role);
        if(role==='caddy') localStorage.setItem('cw:me:caddy', gid);
        else localStorage.setItem('cw:me:golfer', gid);
      }catch(_){}
      CW.Events.emit('cw:identity:changed', {role,gid});
    }
  };

  CW.Queues = CW.Queues || {
    key:'cw:queues',
    get(slot){ const m=CW.safeJSON.get(this.key,{})||{}; return m[slot]||[]; },
    set(slot, arr){ const m=CW.safeJSON.get(this.key,{})||{}; m[slot]=Array.from(arr||[]); CW.safeJSON.set(this.key,m); CW.Events.emit('cw:queue:updated',{slot}); },
    all(){ return CW.safeJSON.get(this.key,{})||{}; },
    popHead(slot){ const q=this.get(slot); if(!q.length) return null; const h=q.shift(); this.set(slot,q); return h; },
    moveHeadToTail(slot){ const q=this.get(slot); if(!q.length) return; const h=q.shift(); q.push(h); this.set(slot,q); }
  };
  CW.Bookings = CW.Bookings || {
    key:'cw:bookings',
    get(slot){ const m=CW.safeJSON.get(this.key,{})||{}; return m[slot]||null; },
    set(slot, rec){ const m=CW.safeJSON.get(this.key,{})||{}; if(rec){ m[slot]=rec; } else { delete m[slot]; } CW.safeJSON.set(this.key,m); CW.Events.emit('cw:booking:updated',{slot}); },
    isFilled(slot){ return !!this.get(slot); },
    assign(slot, rec){ this.set(slot, rec); }
  };
  CW.Offers = CW.Offers || {
    key:'cw:offers',
    all(){ return CW.safeJSON.get(this.key,{})||{}; },
    save(map){ CW.safeJSON.set(this.key,map||{}); },
    get(slot){ return (this.all())[slot]||null; },
    hasActive(slot){ return !!this.get(slot); },
    clear(slot){ const m=this.all(); delete m[slot]; this.save(m); },
    create(slot, gid, ttlMs){ const m=this.all(); m[slot]={slot,gid,ttlMs,createdAt:Date.now()}; this.save(m); return m[slot]; }
  };

  // Seed demo
  function seed(){
    const bookings = CW.safeJSON.get('cw:bookings',{})||{};
    const queues = CW.safeJSON.get('cw:queues',{})||{};
    let changed=false;
    if (!bookings[SLOT]){ bookings[SLOT] = { gid:G_SARAH, cid:CADDY_ID }; changed=true; }
    if (!queues[SLOT] || queues[SLOT].length===0){ queues[SLOT] = [G_PETER, G_MARCUS]; changed=true; }
    if (changed){ CW.safeJSON.set('cw:bookings', bookings); CW.safeJSON.set('cw:queues', queues); }
  }
  function nameOf(gid){
    if (gid===G_PETER) return 'Peter Park';
    if (gid===G_MARCUS) return 'Marcus Johnson';
    if (gid===G_SARAH) return 'Sarah Chen';
    return gid;
  }

  // UI renderers
  function renderBookedBanner(){
    const host = document.getElementById('cw-booked-inline-host'); if(!host) return;
    host.innerHTML = '';
    const rec = CW.Bookings.get(SLOT);
    if (!rec) return;
    const viewerRole = CW.identity.role();
    const viewerGid  = CW.identity.gid();
    // Show banner only for the golfer who currently holds the booking
    if (viewerRole==='golfer' && rec.gid===viewerGid){
      const div = document.createElement('div');
      div.className = 'rounded-lg bg-green-50 border border-green-200 p-3 text-green-900';
      div.innerHTML = '<div class="font-medium">Booking Confirmed</div>' +
                      '<div class="text-sm">You booked <strong>'+ CADDY_NAME +'</strong> on <strong>'+ SLOT.split(" ")[0] +'</strong> at <strong>'+ SLOT.split(" ")[1] +'</strong>.</div>';
      host.appendChild(div);
    }
  }

  function renderCaddyBookings(){
    const wrap = document.getElementById('cw-caddy-bookings');
    const list = document.getElementById('cw-caddy-list');
    if (!wrap || !list) return;
    if (CW.identity.role()!=='caddy'){ wrap.style.display='none'; list.innerHTML=''; return; }
    wrap.style.display='block';
    // Collect bookings for this caddy
    const all = CW.safeJSON.get('cw:bookings',{})||{};
    const rows = Object.keys(all).filter(slot => all[slot] && all[slot].cid===CADDY_ID)
      .map(slot => `<div>• ${SLOT} — ${nameOf(all[slot].gid)}</div>`);
    list.innerHTML = rows.join("") || '<div class="text-gray-600">No bookings.</div>';
  }

  function updateQueuePanel(){
    const card = document.getElementById('cw-queue-card'); if(!card) return;
    const viewerRole = CW.identity.role();
    const viewerGid  = CW.identity.gid();
    const booked = CW.Bookings.get(SLOT);

    // Hide queue for Sarah (booked golfer) and for caddy
    if (viewerRole==='caddy' || (booked && booked.gid===G_SARAH)){
      card.style.display='none';
      return;
    }
    card.style.display='block';

    const slotEl = document.getElementById('cw-slot-label'); if (slotEl) slotEl.textContent = SLOT;
    const listEl = document.getElementById('cw-queue-list');
    const meEl   = document.getElementById('cw-queue-me');
    const hintEl = document.getElementById('cw-queue-hint');
    const offerEl= document.getElementById('cw-offer-inline');
    const q = CW.Queues.get(SLOT);
    listEl.innerHTML = q.map((gid, i)=> `<li>${i+1}. ${nameOf(gid)}</li>`).join("") || '<li class="text-gray-500">Queue empty</li>';
    const idx = q.indexOf(viewerGid);
    meEl.textContent = (viewerRole==='golfer' && idx>=0) ? `You are #${idx+1} in queue` : '';

    if (booked){
      hintEl.textContent = `${nameOf(booked.gid)} currently has ${CADDY_NAME}.`;
    } else {
      hintEl.textContent = `Vacant: offer goes to ${nameOf(q[0]||'—')}.`;
    }

    // Offer buttons show only for the golfer who is the offer target
    const off = CW.Offers.get(SLOT);
    if (off && q[0]===off.gid && !booked && viewerRole==='golfer' && viewerGid===off.gid){
      offerEl.innerHTML = `<div class="p-2 bg-amber-50 border border-amber-200 rounded inline-flex gap-2 items-center">
        Offer to ${nameOf(off.gid)} — <button id="cw-accept" class="px-2 py-1 border rounded">Accept</button>
        <button id="cw-pass" class="px-2 py-1 border rounded">Pass</button>
      </div>`;
      document.getElementById('cw-accept').onclick = ()=>{ acceptOffer(); };
      document.getElementById('cw-pass').onclick   = ()=>{ passOffer(); };
    } else {
      offerEl.innerHTML = '';
    }
  }

  function acceptOffer(){
    const q = CW.Queues.get(SLOT);
    const head = q[0];
    CW.Bookings.assign(SLOT, { gid: head, cid: CADDY_ID });
    CW.Offers.clear(SLOT);
    CW.Queues.moveHeadToTail(SLOT);
    CW.Events.emit('cw:booking:confirmed', { slot:SLOT, gid:head, cid:CADDY_ID });
  }
  function passOffer(){
    CW.Queues.moveHeadToTail(SLOT);
    CW.Offers.clear(SLOT);
    CW.Events.emit('cw:queue:updated', {slot:SLOT});
  }

  // Demo vacancy after 30s — only arms when viewing as Peter (golfer) in the sandbox
  function armDemo(){
    if (window.__cw_demo_started) return;
    window.__cw_demo_started = true;
    let t = 30;
    const tick = setInterval(()=>{
      t--;
      // Optionally update a counter later
      if (t<=0){
        clearInterval(tick);
        // Vacate Sarah and create offer to current head (Peter by default)
        const rec = CW.Bookings.get(SLOT);
        if (rec && rec.gid===G_SARAH){
          CW.Bookings.set(SLOT, null);
          const q = CW.Queues.get(SLOT);
          const head = q[0];
          if (head){ CW.Offers.create(SLOT, head, 300000); }
          CW.Events.emit('cw:queue:updated', {slot:SLOT});
        }
      }
    }, 1000);
  }

  // Wiring
  CW.Events.on('cw:queue:updated', ()=>{ updateQueuePanel(); });
  CW.Events.on('cw:booking:updated', ()=>{ updateQueuePanel(); renderBookedBanner(); renderCaddyBookings(); });
  CW.Events.on('cw:booking:confirmed', ()=>{ updateQueuePanel(); renderBookedBanner(); renderCaddyBookings(); });
  CW.Events.on('cw:identity:changed', ()=>{ updateQueuePanel(); renderBookedBanner(); renderCaddyBookings(); });

  function openSandbox(){
    document.getElementById('cw-schedule-sandbox').style.display='block';
    // hide other panels if present
    ['ucg-tab-play','ucg-tab-ryder','ucg-tab-config','ucg-tab-leader'].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='none'; });
    seed();
    updateQueuePanel();
    renderBookedBanner();
    renderCaddyBookings();
    // arm demo only when Peter (golfer) view is active
    if (CW.identity.role()==='golfer' && CW.identity.gid()===G_PETER) armDemo();
  }

  // Identity switch buttons
  document.addEventListener('click', (e)=>{
    const b = e.target.closest('.cw-role'); if(!b) return;
    const role = b.getAttribute('data-role');
    const gid  = b.getAttribute('data-gid');
    CW.identity.set(role, gid);
    updateQueuePanel(); renderBookedBanner(); renderCaddyBookings();
  }, true);

  const btn = document.getElementById('cw-sched-demo-btn');
  if (btn) btn.addEventListener('click', openSandbox);
  document.addEventListener('DOMContentLoaded', ()=>{ try{ openSandbox(); }catch(_){ } });
})();
</script>
<script>
window.CW = window.CW || {};

// Simple event bus
CW.Events = {
  on(type, fn){ window.addEventListener(type, fn); },
  off(type, fn){ window.removeEventListener(type, fn); },
  emit(type, detail){ window.dispatchEvent(new CustomEvent(type, { detail })); }
};

// Identity helpers (demo mapping)
CW.identity = {
  GOLFERS: {
    "Sarah Chen": "GOLF-SARAH",
    "Peter Park": "GOLF-PETER",
    "Marcus Johnson": "GOLF-MARCUS"
  },
  CADDIES: {
    "Ning Siriwan": "CADDY-NING",
    "Ning": "CADDY-NING"
  },
  setGolfer(name){
    localStorage.setItem('cw:me:role','golfer');
    localStorage.setItem('cw:me:golfer', this.GOLFERS[name] || name);
  },
  setCaddy(name){
    localStorage.setItem('cw:me:role','caddy');
    localStorage.setItem('cw:me:caddy', this.CADDIES[name] || name);
  },
  clear(){
    ['cw:me:role','cw:me:golfer','cw:me:caddy'].forEach(k=>localStorage.removeItem(k));
  },
  role(){ return localStorage.getItem('cw:me:role'); },
  gid(){ return localStorage.getItem('cw:me:golfer'); },
  cid(){ return localStorage.getItem('cw:me:caddy'); }
};

function CW_isGolferSession(){
  return CW.identity.role()==='golfer' && !!CW.identity.gid();
}

// Storage helpers
CW.safeJSON = {
  get(key, def){
    try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : (def ?? null); }
    catch(e){ return def ?? null; }
  },
  set(key, val){
    localStorage.setItem(key, JSON.stringify(val));
    window.dispatchEvent(new StorageEvent('storage'));
  }
};

// Queue/Booking/Offer stores
CW.Queues = {
  key:'cw:queues',
  get(slot){ const m=CW.safeJSON.get(this.key,{}); return m[slot]||[]; },
  set(slot, arr){ const m=CW.safeJSON.get(this.key,{}); m[slot]=arr; CW.safeJSON.set(this.key,m); CW.Events.emit('cw:queue:updated',{slot}); },
  all(){ return CW.safeJSON.get(this.key,{}); },
  popHead(slot){ const q=this.get(slot); if(!q.length) return null; const h=q.shift(); this.set(slot,q); return h; },
  moveHeadToTail(slot){ const q=this.get(slot); if(!q.length) return; const h=q.shift(); q.push(h); this.set(slot,q); }
};

CW.Bookings = {
  key:'cw:bookings',
  get(slot){ const m=CW.safeJSON.get(this.key,{}); return m[slot]||null; },
  set(slot, rec){ const m=CW.safeJSON.get(this.key,{}); if(rec) m[slot]=rec; else delete m[slot]; CW.safeJSON.set(this.key,m); CW.Events.emit('cw:booking:updated',{slot}); },
  isFilled(slot){ return !!this.get(slot); },
  assign(slot, rec){ this.set(slot, rec); }
};

CW.Offers = {
  key:'cw:offers',
  all(){ return CW.safeJSON.get(this.key,{}); },
  save(map){ CW.safeJSON.set(this.key,map); },
  get(slot){ return this.all()[slot]||null; },
  hasActive(slot){ return !!this.get(slot); },
  clear(slot){ const m=this.all(); delete m[slot]; this.save(m); CW.Events.emit('cw:offer:clear',{slot}); },
  create(offer){ const m=this.all(); m[offer.slot]=offer; this.save(m); CW.Events.emit('cw:offer:new',offer); },
  mineFor(gid){ const m=this.all(); for(const k in m){ if(m[k].gid===gid) return m[k]; } return null; }
};

// Vacancy trigger -> create offer for queue head
CW.onBookingVacated = function(slot){
  const q = CW.Queues.get(slot);
  if (!q.length) return;
  if (CW.Offers.hasActive(slot)) return;
  const head = q[0];
  // infer caddy from last booking at this slot or default demo caddy
  const last = CW.Bookings.get(slot);
  const cid = (last && last.cid) || 'CADDY-NING';
  CW.Offers.create({ slot, gid: head, cid, createdAt: Date.now(), ttlMs: 15*60*1000 });
};

// Accept / Pass / Rotate
CW.acceptOffer = function(slot, gid){
  const of = CW.Offers.get(slot);
  if (!of || of.gid !== gid) return false;
  if (CW.Bookings.isFilled(slot)) { CW.Offers.clear(slot); return false; }
  CW.Bookings.assign(slot, { gid: of.gid, cid: of.cid });
  // remove head of queue
  const q = CW.Queues.get(slot);
  if (q.length && q[0]===gid){ q.shift(); CW.Queues.set(slot,q); }
  CW.Offers.clear(slot);
  CW.Events.emit('cw:toast', { type:'success', text:'Booking accepted' });
  return true;
};

CW.passOffer = function(slot, gid){
  const of = CW.Offers.get(slot);
  if (!of || of.gid !== gid) return false;
  // rotate
  CW.Queues.moveHeadToTail(slot);
  CW.Offers.clear(slot);
  CW.onBookingVacated(slot);
  return true;
};

// Heartbeat to expire offers
setInterval(() => {
  const map = CW.Offers.all();
  const now = Date.now();
  let changed = false;
  Object.keys(map).forEach(slot => {
    const of = map[slot];
    if (now > of.createdAt + of.ttlMs){
      // timeout -> rotate
      CW.Queues.moveHeadToTail(slot);
      delete map[slot];
      // re-issue to new head if exists
      const q = CW.Queues.get(slot);
      if (q.length){
        map[slot] = { slot, gid: q[0], cid: of.cid, createdAt: Date.now(), ttlMs: 15*60*1000 };
      }
      changed = true;
    }
  });
  if (changed){ CW.Offers.save(map); CW.Events.emit('cw:offer:ticked',{}); }
}, 1000);

// Bind login cards by visible names (non-destructive)
document.addEventListener('click', (e) => {
  const t = e.target.closest('[data-role-card], .role-card, button, a, div');
  if (!t) return;
  const txt = (t.innerText||'').trim();
  if (/Sarah\s+Chen/i.test(txt)) { CW.identity.setGolfer('Sarah Chen'); }
  if (/Peter\s+Park/i.test(txt)) { CW.identity.setGolfer('Peter Park'); }
  if (/Marcus\s+Johnson/i.test(txt)) { CW.identity.setGolfer('Marcus Johnson'); }
  if (/Ning\s+Siriwan/i.test(txt) || /\bNing\b/i.test(txt)) { CW.identity.setCaddy('Ning'); }
}, true);

</script>
<script>
// ===== Modal controller (golfer-only, scoped to Schedule tab) =====
(function(){
  // Helper: detect if Schedule tab/section is currently visible
  function scheduleVisible(){
    // heuristic 1: a nav/tab with text 'Schedule' and aria-selected or active class
    const tabs = Array.from(document.querySelectorAll('a,button,li'));
    const hit = tabs.find(el => /schedule/i.test(el.textContent||'') && (el.getAttribute('aria-selected')==='true' || /\b(active|selected|current)\b/i.test(el.className||'')));
    if (hit) return true;
    // heuristic 2: section heading present
    const headers = Array.from(document.querySelectorAll('h1,h2,h3,h4'));
    if (headers.some(h => /golf\s*schedule/i.test(h.textContent||''))) return true;
    // heuristic 3: container with id/class schedule
    if (document.querySelector('#schedule, .schedule, [data-section="schedule"]')) return true;
    return false;
  }

  // Controller instance (created on demand once golfer session is active)
  let started = false;
  function startController(){
    if (started) return;
    if (!(window.CW && CW.identity && CW.identity.role()==='golfer')) return;
    started = true;

    const modal = document.getElementById('cw-offer-modal');
    const elCaddy = document.getElementById('cw-offer-caddy');
    const elDate  = document.getElementById('cw-offer-date');
    const elTime  = document.getElementById('cw-offer-time');
    const elCd    = document.getElementById('cw-offer-countdown');
    const btnAccept = document.getElementById('cw-offer-accept');
    const btnPass   = document.getElementById('cw-offer-pass');

    let offer=null, tick=null, lastFocus=null;

    function gid(){ return CW.identity.gid(); }
    function fmt(ms){ const s=Math.max(0,Math.floor(ms/1000)), m=(s/60)|0, r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }

    function openModal(of){
      // only on Schedule
      if (!scheduleVisible()) return;
      offer = of;
      const [d,t] = of.slot.split(' ');
      elDate.textContent = d; elTime.textContent = t;
      elCaddy.textContent = of.cid || 'Caddy';
      lastFocus = document.activeElement;
      modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false');
      setTimeout(()=>btnAccept.focus(),0);
      if (tick) clearInterval(tick);
      tick = setInterval(update,1000);
      update();
      window.addEventListener('keydown', escPass, { once:true });
    }
    function closeModal(){
      if (tick) clearInterval(tick), tick=null;
      modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true');
      if (lastFocus && lastFocus.focus) lastFocus.focus();
      offer = null;
    }
    function update(){
      if (!offer) return;
      const remain = offer.createdAt + offer.ttlMs - Date.now();
      elCd.textContent = fmt(remain);
      if (remain<=0) closeModal();
    }
    function escPass(e){ if (e.key==='Escape' && offer){ CW.passOffer(offer.slot, gid()); closeModal(); } }

    btnAccept.addEventListener('click', ()=>{ if(!offer) return; const ok=CW.acceptOffer(offer.slot, gid()); closeModal(); if(!ok) console.log('Offer no longer available'); });
    btnPass.addEventListener('click',   ()=>{ if(!offer) return; CW.passOffer(offer.slot, gid()); closeModal(); });

    function scanMine(){
      // if user navigates away from Schedule while open, close
      if (!scheduleVisible()){ if (offer) closeModal(); return; }
      if (CW.identity.role()!=='golfer'){ if (offer) closeModal(); return; }
      const mine = CW.Offers.mineFor(gid());
      if (!mine){ if (offer) closeModal(); return; }
      if (!offer || offer.slot !== mine.slot) openModal(mine);
    }

    // initial and watchers
    scanMine();
    CW.Events.on('cw:offer:new', scanMine);
    CW.Events.on('cw:offer:clear', scanMine);
    CW.Events.on('cw:booking:updated', scanMine);
    window.addEventListener('storage', scanMine);
    // Poll for schedule tab visibility changes
    setInterval(scanMine, 800);
  }

  // Start immediately if already golfer
  startController();

  // Late-init when identity changes to golfer
  window.addEventListener('storage', () => {
    if (localStorage.getItem('cw:me:role')==='golfer') startController();
  });
  // Also attempt after clicks (useful when login cards are clicked)
  document.addEventListener('click', () => {
    if (localStorage.getItem('cw:me:role')==='golfer') startController();
  }, true);
})();
</script>
<script>
// ===== DEMO SEED (Sarah booked, Peter #1, Marcus #2; Ning only caddy) =====
(function demoSeed(){
  const SLOT = '2025-09-05 07:30';

  // names for display elsewhere (optional)
  const names = Object.assign({}, CW.safeJSON.get('cw:gid:names', {}), {
    'GOLF-SARAH':'Sarah Chen',
    'GOLF-PETER':'Peter Park',
    'GOLF-MARCUS':'Marcus Johnson'
  });
  CW.safeJSON.set('cw:gid:names', names);

  // prebook Sarah with Ning
  const bookings = CW.safeJSON.get('cw:bookings', {});
  bookings[SLOT] = { gid:'GOLF-SARAH', cid:'CADDY-NING' };
  CW.safeJSON.set('cw:bookings', bookings);

  // queue Peter -> Marcus
  const queues = CW.safeJSON.get('cw:queues', {});
  queues[SLOT] = ['GOLF-PETER','GOLF-MARCUS'];
  CW.safeJSON.set('cw:queues', queues);

  // clear offers
  CW.safeJSON.set('cw:offers', {});

  // DEMO helper
  window.DEMO = {
    loginSarah(){ CW.identity.setGolfer('Sarah Chen'); },
    loginPeter(){ CW.identity.setGolfer('Peter Park'); },
    loginMarcus(){ CW.identity.setGolfer('Marcus Johnson'); },
    loginNing(){  CW.identity.setCaddy('Ning'); },
    dropSarah(){
      const SLOT='2025-09-05 07:30';
      const b = CW.safeJSON.get('cw:bookings',{});
      if (b[SLOT] && b[SLOT].gid==='GOLF-SARAH'){
        delete b[SLOT];
        CW.safeJSON.set('cw:bookings', b);
        // trigger vacancy -> offer to queue head
        CW.onBookingVacated(SLOT);
      }
    }
  };
})();
</script>
<script>
// ===== Smart identity + Book Round hook (golfer-only) =====
(function(){
  // map visible names -> IDs
  const NAME_TO_GID = {
    "Sarah Chen": "GOLF-SARAH",
    "Peter Park": "GOLF-PETER",
    "Marcus Johnson": "GOLF-MARCUS"
  };

  function tryAutoSetGolferFromHeader(){
    if (localStorage.getItem('cw:me:role') === 'golfer') return; // don't override
    const text = (document.body.innerText || '').trim();
    for (const name of Object.keys(NAME_TO_GID)){
      const rx = new RegExp(name.replace(' ', '\\s+'), 'i');
      if (rx.test(text) && /GOLFER/i.test(text)){
        if (window.CW?.identity?.setGolfer){
          CW.identity.setGolfer(name);
          break;
        }
      }
    }
  }

  // When Schedule tab or Book Round is used, make sure role is set to golfer if name is present
  function onNavOrClick(e){
    const t = e ? e.target : null;
    const label = (t && (t.innerText || t.textContent) || '').trim();
    if (/schedule/i.test(label) || /\bbook\s*round\b/i.test(label)){
      tryAutoSetGolferFromHeader();
      // If Book Round was clicked in a golfer session, trigger demo vacancy to generate offer
      if (/\bbook\s*round\b/i.test(label) && localStorage.getItem('cw:me:role')==='golfer'){
        // Only if Sarah is holding the demo slot and no active offer
        const SLOT='2025-09-05 07:30';
        const offers = JSON.parse(localStorage.getItem('cw:offers')||'{}');
        const bookings = JSON.parse(localStorage.getItem('cw:bookings')||'{}');
        if ((!offers[SLOT]) && bookings[SLOT] && bookings[SLOT].gid === 'GOLF-SARAH'){
          // Simulate Sarah cancelling as you begin booking -> offer to queue head (Peter)
          if (window.CW?.onBookingVacated){
            // Vacate
            delete bookings[SLOT];
            localStorage.setItem('cw:bookings', JSON.stringify(bookings));
            CW.onBookingVacated(SLOT);
          }
        }
      }
    }
  }

  // run on load & bind listeners
  document.addEventListener('DOMContentLoaded', tryAutoSetGolferFromHeader);
  // clicks on nav/buttons
  document.addEventListener('click', onNavOrClick, true);
  // also when hash or history changes (if your tabs use routing)
  window.addEventListener('hashchange', tryAutoSetGolferFromHeader);
  window.addEventListener('popstate', tryAutoSetGolferFromHeader);
})();
</script>
<script>
// ===== Queue Panel + 30s delayed demo trigger + DOM sync =====
(function(){
  const SLOT = '2025-09-05 07:30';

  // Render a simple queue panel on the Schedule page for golfers
  function ensureScheduleQueuePanel(){
    if (!(CW && CW.identity && CW.identity.role()==='golfer')) return;
    // Find Schedule main container by heading text
    const h = Array.from(document.querySelectorAll('h1,h2,h3'))
      .find(x => /golf\s*schedule/i.test(x.textContent||''));
    if (!h) return;
    // Insert panel after the header once
    if (document.getElementById('cw-queue-panel')) return;
    const panel = document.createElement('div');
    panel.id = 'cw-queue-panel';
    panel.className = 'mt-3 mb-3 rounded-xl border border-indigo-100 bg-indigo-50/50 p-4 shadow-sm';
    panel.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold">Waitlist for ${SLOT} (Ning)</div>
        <div id="cw-queue-me" class="text-xs text-indigo-700"></div>
      </div>
      <ol id="cw-queue-list" class="mt-2 space-y-1 text-sm"></ol>
      <div id="cw-queue-hint" class="mt-2 text-xs text-gray-600"></div>
    `;
    h.parentElement.insertBefore(panel, h.nextSibling);
    updateQueuePanel();
  }

  function updateQueuePanel(){
    const q = CW.Queues.get(SLOT);
    const me = CW.identity.gid && CW.identity.gid();
    const list = document.getElementById('cw-queue-list');
    const meEl = document.getElementById('cw-queue-me');
    const hint = document.getElementById('cw-queue-hint');
    if (!list || !meEl) return;
    list.innerHTML='';
    q.forEach((gid, i)=>{
      const li = document.createElement('li');
      const pos = i+1;
      const name = (CW.safeJSON.get('cw:gid:names',{})[gid]||gid);
      li.innerHTML = `<span class="inline-flex w-6 h-6 items-center justify-center rounded-full bg-white shadow ring-1 ring-indigo-200 mr-2">${pos}</span> ${name}`;
      list.appendChild(li);
    });
    const myPos = q.indexOf(me);
    meEl.textContent = myPos >= 0 ? `You are #${myPos+1} in queue` : 'You are not in this queue';
    hint.textContent = 'An offer will appear if the slot becomes vacant. For the demo, that vacancy will happen ~30s after you enter Schedule.';
  }

  // Start a 30s demo timer when the user navigates to Schedule or clicks "Book Round"
  let demoTimer = null;
  function armDemoIfNeeded(e){
    if (!(CW && CW.identity && CW.identity.role()==='golfer')) return;
    // Only arm for Peter to mirror your scenario
    const gid = CW.identity.gid();
    if (gid !== 'GOLF-PETER') return;

    // If already armed, skip
    if (localStorage.getItem('cw:demo:armed')==='1') return;

    // Confirm demo state: Sarah booked, Peter->Marcus queue
    const bookings = CW.safeJSON.get('cw:bookings',{});
    const queues = CW.safeJSON.get('cw:queues',{});
    if (!(bookings[SLOT] && bookings[SLOT].
    // Guard: skip ONLY when the visible "Schedule Golf Round" dialog/overlay is open (incl. Tailwind fixed overlays)
    try{
      var __schedDlg = (function(){
        try{
          var root = null;
          // Find an element that contains the exact title text
          var marker = Array.from(document.querySelectorAll('*')).find(function(el){
            try{
              if(!el || !el.textContent) return false;
              if(!/Schedule\s+Golf\s+Round/i.test(el.textContent)) return false;
              // Candidate overlay root is any ancestor that either:
              //  - is [role=dialog]/[aria-modal] OR
              //  - has a class hinting overlay (fixed|inset-0|z-50|backdrop) OR
              //  - has computedStyle.position === 'fixed'
              var anc = el.closest('[role="dialog"],[aria-modal="true"],.modal,[data-modal],[class*="fixed"],[class*="inset-0"],[class*="z-50"],[class*="backdrop"]');
              if (!anc){
                // fallback: walk up and find any ancestor with position:fixed
                var p = el;
                while(p && p !== document.body){
                  var cs = window.getComputedStyle(p); if (cs && cs.position === 'fixed'){ anc = p; break; }
                  p = p.parentElement;
                }
              }
              if (!anc) return false;
              var cs2 = window.getComputedStyle(anc);
              if (cs2 && (cs2.display==='none' || cs2.visibility==='hidden' || Number(cs2.opacity||'1')===0)) return false;
              var r = anc.getBoundingClientRect(); if (!r || r.width<10 || r.height<10) return false;
              root = anc; return true;
            }catch(_){ return false; }
          });
          return root;
        }catch(_){ return null; }
      })();
      if (__schedDlg) { return; }
    }catch(_){}
gid==='GOLF-SARAH')) return; // ensure seed
    if (!queues[SLOT] || queues[SLOT][0] !== 'GOLF-PETER') return;

    // Arm
    localStorage.setItem('cw:demo:armed','1');
    localStorage.setItem('cw:demo:startAt', String(Date.now()));
    if (demoTimer) clearTimeout(demoTimer);
    demoTimer = setTimeout(()=>{
      // If still armed and no offer yet, vacate Sarah -> create offer for Peter
      const offers = CW.safeJSON.get('cw:offers',{});
      if (!offers[SLOT]){
        const b = CW.safeJSON.get('cw:bookings',{});
        if (b[SLOT] && b[SLOT].gid==='GOLF-SARAH'){
          delete b[SLOT];
          CW.safeJSON.set('cw:bookings', b);
          CW.onBookingVacated(SLOT);
        }
      }
    }, 30000); // 30 seconds
  }

  // DOM sync for bookings after accept (Golfer schedule + Caddy My Bookings)
  function syncGolferSchedule(){
    if (!(CW && CW.identity && CW.identity.role()==='golfer')) return;
    const gid = CW.identity.gid();
    const b = CW.Bookings.get(SLOT);
    // Find empty-state paragraph and replace with a booked card if golfer booked
    const empty = Array.from(document.querySelectorAll('p,div')).find(el => /Your schedule is empty/i.test(el.textContent||''));
    let card = document.getElementById('cw-golfer-booked-card');
    if (b && b.gid === gid){
      if (!card){
        card = document.createElement('div');
        card.id = 'cw-golfer-booked-card';
        card.className = 'mt-4 rounded-2xl bg-white shadow ring-1 ring-gray-200 p-4';
        card.innerHTML = `<div class="text-sm text-gray-600">You booked <strong>Ning</strong> at <strong>${SLOT}</strong>.</div>`;
        if (empty && empty.parentElement) empty.parentElement.insertBefore(card, empty);
        else document.body.appendChild(card);
      } else {
        card.querySelector('div').innerHTML = `You booked <strong>Ning</strong> at <strong>${SLOT}</strong>.`;
      }
    } else {
      if (card) card.remove();
    }
  }

  function syncCaddyMyBookings(){
    // Only when viewing Caddy -> My Bookings
    const header = Array.from(document.querySelectorAll('h1,h2')).find(h=>/my\s*bookings/i.test(h.textContent||''));
    if (!header) return;
    const b = CW.Bookings.get(SLOT);
    let row = document.getElementById('cw-caddy-booked-row');
    if (b && b.cid === 'CADDY-NING'){
      if (!row){
        row = document.createElement('div');
        row.id = 'cw-caddy-booked-row';
        row.className = 'mt-3 rounded-2xl bg-white ring-1 ring-gray-200 shadow p-4 flex items-center justify-between';
        const name = (CW.safeJSON.get('cw:gid:names',{})[b.gid]||'Golfer');
        row.innerHTML = `<div><div class="font-medium">${name}</div><div class="text-xs text-gray-500">Pattaya Country Club • ${SLOT}</div></div><span class="px-2 py-1 text-xs rounded bg-green-100 text-green-700">confirmed</span>`;
        header.parentElement.appendChild(row);
      } else {
        const name = (CW.safeJSON.get('cw:gid:names',{})[b.gid]||'Golfer');
        row.querySelector('.font-medium').textContent = name;
      }
    } else {
      if (row) row.remove();
    }
  }

  // React to state changes
  CW.Events.on('cw:queue:updated', ()=>{ updateQueuePanel(); });
  CW.Events.on('cw:booking:updated', ()=>{ updateQueuePanel(); syncGolferSchedule(); syncCaddyMyBookings(); });
  CW.Events.on('cw:offer:new', ()=>{ updateQueuePanel(); });
  window.addEventListener('storage', ()=>{ updateQueuePanel(); syncGolferSchedule(); syncCaddyMyBookings(); });

  // Schedule tab detection: when active, render panel and arm demo timer
  function onClick(e){
    const t = e.target;
    const label = (t && (t.innerText||t.textContent)||'').trim();
    if (/schedule/i.test(label) || /\bbook\s*round\b/i.test(label)){
      setTimeout(()=>{ ensureScheduleQueuePanel(); updateQueuePanel(); armDemoIfNeeded(); }, 0);
    }
  }
  document.addEventListener('click', onClick, true);

  // On load (if already on Schedule due to deep link), render panel + maybe arm
  document.addEventListener('DOMContentLoaded', ()=>{
    ensureScheduleQueuePanel();
    updateQueuePanel();
  });

  // Also poll a bit to catch SPA navigation
  setInterval(()=>{
    ensureScheduleQueuePanel();
    syncGolferSchedule();
    syncCaddyMyBookings();
  }, 1000);

})();
</script>

<script>
// ===== Modal controller (runs only for golfers) =====
(function(){
  if (!CW_isGolferSession()) return;

  const modal = document.getElementById('cw-offer-modal');
  const elCaddy = document.getElementById('cw-offer-caddy');
  const elDate  = document.getElementById('cw-offer-date');
  const elTime  = document.getElementById('cw-offer-time');
  const elCd    = document.getElementById('cw-offer-countdown');
  const btnAccept = document.getElementById('cw-offer-accept');
  const btnPass   = document.getElementById('cw-offer-pass');

  let offer=null, tick=null, lastFocus=null;

  function gid(){ return CW.identity.gid(); }
  function fmt(ms){ const s=Math.max(0,Math.floor(ms/1000)), m=(s/60)|0, r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }

  function openModal(of){
    offer = of;
    const [d,t] = of.slot.split(' ');
    elDate.textContent = d; elTime.textContent = t;
    elCaddy.textContent = of.cid || 'Caddy';
    lastFocus = document.activeElement;
    modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false');
    setTimeout(()=>btnAccept.focus(),0);
    if (tick) clearInterval(tick);
    tick = setInterval(update,1000);
    update();
    window.addEventListener('keydown', escPass, { once:true });
  }
  function closeModal(){
    if (tick) clearInterval(tick), tick=null;
    modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true');
    if (lastFocus && lastFocus.focus) lastFocus.focus();
    offer = null;
  }
  function update(){
    if (!offer) return;
    const remain = offer.createdAt + offer.ttlMs - Date.now();
    elCd.textContent = fmt(remain);
    if (remain<=0) closeModal();
  }
  function escPass(e){ if (e.key==='Escape' && offer){ CW.passOffer(offer.slot, gid()); closeModal(); } }

  btnAccept.addEventListener('click', ()=>{ if(!offer) return; const ok=CW.acceptOffer(offer.slot, gid()); closeModal(); if(!ok) console.log('Offer no longer available'); });
  btnPass.addEventListener('click',   ()=>{ if(!offer) return; CW.passOffer(offer.slot, gid()); closeModal(); });

  function scanMine(){
    if (!CW_isGolferSession()) { if (offer) closeModal(); return; }
    const mine = CW.Offers.mineFor(gid());
    if (!mine){ if (offer) closeModal(); return; }
    if (!offer || offer.slot !== mine.slot) openModal(mine);
  }

  scanMine();
  CW.Events.on('cw:offer:new', scanMine);
  CW.Events.on('cw:offer:clear', scanMine);
  CW.Events.on('cw:booking:updated', scanMine);
  window.addEventListener('storage', scanMine);
  setInterval(()=> offer && update(), 1000);
})();
</script>
<!-- v20: ALL-IN-ONE (Mobile tabs, Tracker pill, GM size, hide old FAB, hide booking chips, HARD-LOCK minis) -->
<style id="mcx-v20-style">
/* Hide any old floating GM FAB */
#gmFab49{ display:none !important; }
[id*="gmfab" i], [class*="gmfab" i]{ display:none !important; }

/* Bottom breathing room for tab bar on mobile */
@media (max-width: 820px){
  body{ padding-bottom: 84px !important; }
}

/* Bottom tabs bar (non-blocking container; only buttons clickable) */
#quickBarTabs{
  position: fixed; left: 50%; transform: translateX(-50%);
  bottom: 10px; z-index: 2147483641;
  display: flex; gap: 8px; align-items: center;
  background: rgba(17,24,39,.9); border-radius: 9999px; padding: 6px 8px;
  box-shadow: 0 8px 24px rgba(0,0,0,.35);
  -webkit-backdrop-filter: saturate(180%) blur(10px);
  backdrop-filter: saturate(180%) blur(10px);
  pointer-events: none;
}
#quickBarTabs button{
  pointer-events: auto;
  appearance:none; border:none; background:#2563eb; color:#fff;
  padding:8px 12px; border-radius:9999px; font-size:14px; line-height:1;
  display:flex; align-items:center; gap:8px; box-shadow:0 4px 12px rgba(0,0,0,.25);
  cursor:pointer;
}
#quickBarTabs button.secondary{ background:#374151; }
#quickBarTabs .icon{ font-size:16px; }

/* GM dock mobile sizing (desktop unchanged) */
@media (max-width: 820px){
  #gmDock49{
    position: fixed !important;
    left: 12px !important; right: 12px !important;
    bottom: 90px !important; top: auto !important;
    max-height: 60vh !important; /* tighter */
    border-radius: 12px !important; overflow: auto !important;
  }
  #gmDock49 *{ font-size: 0.9rem !important; }
}

/* Announcements: never full-screen */
#gmBanner48{ position:relative !important; max-height:120px; overflow:auto; z-index:1000; }

/* Tracker collapsed pill at top center, small and out of the way */
#lbFavDock{
  position: fixed !important;
  top: 8px !important; left: 50% !important; transform: translateX(-50%) !important;
  z-index: 2147483640 !important;
  padding: 6px 12px !important; height: 32px !important;
  border-radius: 9999px !important;
  background: rgba(17,24,39,.9) !important; color:#fff !important;
  box-shadow: 0 8px 24px rgba(0,0,0,.35) !important;
  display: inline-flex !important; align-items: center !important; gap: 8px !important;
  cursor: pointer !important; user-select: none !important;
}
#lbFavDock .dot{ width: 8px !important; height: 8px !important; background:#f59e0b !important; border-radius:9999px; display:inline-block; }
#lbFavDock .txt{ font-size: 12px !important; font-weight: 600 !important; color:#fff !important; line-height: 1 !important; }

/* Never let Tracker or tabs block the page behind them */
#quickBarTabs{ pointer-events: none; }
#quickBarTabs button, #lbFavDock *{ pointer-events: auto; }

</style>
<script id="mcx-v20-tabs-tracker">
(function(){
  function byId(id){ return document.getElementById(id); }
  // Bottom tabs (Announcements + GM)
  function ensureTabs(){
    if (byId('quickBarTabs')) return;
    var bar=document.createElement('div'); bar.id='quickBarTabs';
    bar.innerHTML = '<button id="qtabAnn" class="secondary"><span class="icon">🔔</span><span>Announcements</span></button>' +
                    '<button id="qtabGM"><span class="icon">🛠</span><span>GM</span></button>';
    document.body.appendChild(bar);
    // Toggle Announcement banner
    byId('qtabAnn').addEventListener('click', function(){
      var w = byId('gmBanner48'); if (!w) return;
      var show = (w.style.display==='none' || !w.style.display);
      w.style.display = show ? 'block' : 'none';
    });
    // Toggle GM dock
    byId('qtabGM').addEventListener('click', function(){
      var willOpen = !document.body.classList.contains('mcx-gm-open');
      document.body.classList.toggle('mcx-gm-open', willOpen);
    });
  }

  // Add a close X inside GM, if missing
  function ensureGmClose(){
    var d = byId('gmDock49'); if(!d) return;
    if (d.querySelector('.mcxClose')) return;
    var x=document.createElement('button'); x.className='mcxClose'; x.textContent='×'; x.title='Close';
    x.style.cssText='position:absolute;top:6px;right:8px;width:28px;height:28px;border:none;border-radius:14px;background:#e5e7eb;color:#111;font-size:18px;line-height:28px;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.2);z-index:2;';
    x.addEventListener('click', function(){ document.body.classList.remove('mcx-gm-open'); });
    d.appendChild(x);
  }

  // Make sure the Tracker collapsed pill exists and is centered (if app hasn't rendered it yet, we create a lightweight one)
  function ensureTracker(){
    var dock = byId('lbFavDock');
    if (!dock){
      dock = document.createElement('div');
      dock.id='lbFavDock';
      dock.innerHTML = '<span class="dot"></span><span class="txt">Tracker</span>';
      document.body.appendChild(dock);
      dock.addEventListener('click', function(){
        var side = byId('lbFavSidebar');
        if (side){ side.style.display='block'; side.style.opacity='1'; side.style.pointerEvents='auto'; }
      });
    }
  }

  function boot(){ ensureTabs(); ensureGmClose(); ensureTracker(); }
  if (document.readyState!=='loading') boot();
  else document.addEventListener('DOMContentLoaded', boot);

  // Re-ensure periodically for SPA changes
  setInterval(function(){ ensureTabs(); ensureGmClose(); ensureTracker(); }, 1200);
})();
</script>
<!-- v15.1 carry-over: hide booking chips off Tee Sheet -->
<script id="mcx-v20-booking-chip-filter">
(function(){
  function isTeeSheetPage(){
    try{
      var href=(location.pathname+location.hash+location.search).toLowerCase();
      if (/#\/?tee|\/tee|sheet/.test(href)) return true;
      var tabs = Array.from(document.querySelectorAll('a,button,li')).map(el=>(el.textContent||'').trim().toLowerCase());
      if (tabs.some(t=> t.includes('tee sheet') || t==='tee sheet')) return true;
      var headers = Array.from(document.querySelectorAll('h1,h2,h3,[role="heading"]'));
      if (headers.some(h=>((h.textContent||'').toLowerCase().includes('tee sheet')))) return true;
    }catch(e){}
    return false;
  }
  function findBookingChips(){
    var nodes = document.querySelectorAll('div,span,p,li,section');
    var out = [];
    nodes.forEach(function(el){
      if (el.__mcxChipChecked) return;
      var t=(el.textContent||'').replace(/\s+/g,' ').trim().toLowerCase();
      if (!t) return;
      var looksLike = /^you booked .+ at /.test(t) && t.length<120;
      if (!looksLike) return;
      var r=el.getBoundingClientRect(); if (r.height>140) return;
      out.push(el); el.__mcxChipChecked = true;
    });
    return out;
  }
  function applyRule(){
    var chips = findBookingChips();
    var onTS = isTeeSheetPage();
    chips.forEach(function(el){
      if (onTS){ el.style.removeProperty('display'); el.removeAttribute('data-mcx-hidden'); }
      else { el.style.display='none'; el.setAttribute('data-mcx-hidden','bookingchip'); }
    });
  }
  function boot(){
    applyRule();
    window.addEventListener('hashchange', applyRule);
    window.addEventListener('popstate', applyRule);
    window.addEventListener('resize', applyRule);
    setInterval(applyRule, 1200);
  }
  if (document.readyState!=='loading') boot(); else document.addEventListener('DOMContentLoaded', boot);
})();
</script>
<!-- v19 HARD-LOCK minis appended -->
<script id="mcx-v19-hardlock">
(function(){
  var root = document.getElementById('live-center-root');
  if (!root) return;

  function sideOf(tr){
    if (!tr) return '?';
    if (tr.closest && tr.closest('#evA')) return 'A';
    if (tr.closest && tr.closest('#evB')) return 'B';
    return '?';
  }
  function nameOf(tr){
    var td = tr && tr.querySelector && tr.querySelector('td:nth-child(2)');
    return (td ? td.textContent : (tr ? tr.textContent : '')).replace(/\s+/g,' ').trim();
  }
  function keyOfRow(tr){ return sideOf(tr)+'|'+nameOf(tr); }
  function keyOfMini(mini){ return (mini && mini.getAttribute && mini.getAttribute('data-key')) || keyOfRow(mini && mini.previousElementSibling); }

  var allowKey = null;
  function setAllow(k){ allowKey = k; setTimeout(function(){ if (allowKey===k) allowKey=null; }, 1000); }

  if (!root.__mcxHardlockClicks){
    root.__mcxHardlockClicks = true;
    root.addEventListener('click', function(ev){
      var tr = ev.target.closest && ev.target.closest('tr'); if(!tr) return;
      var k = keyOfRow(tr); if (!k) return;
      var isOpen = tr.nextElementSibling && tr.nextElementSibling.classList && tr.nextElementSibling.classList.contains('lb-mini-row');
      if (isOpen){ setAllow(k); } // explicit user close
    }, true);
  }

  try{
    var OrigRemove = Node.prototype.remove;
    Node.prototype.remove = function(){
      try{
        if (this.classList && this.classList.contains('lb-mini-row')){
          var k = keyOfMini(this);
          if (k && allowKey === k){
            return OrigRemove.apply(this, arguments);
          }
          return; // block auto removal
        }
      }catch(e){}
      return OrigRemove.apply(this, arguments);
    };
  }catch(_){}

  try{
    var OrigRemoveChild = Element.prototype.removeChild;
    Element.prototype.removeChild = function(child){
      try{
        if (child && child.classList && child.classList.contains('lb-mini-row')){
          var k = keyOfMini(child);
          if (k && allowKey === k){
            return Element.prototype.removeChild.call(this, child);
          }
          return child; // pretend removed
        }
      }catch(e){}
      return Element.prototype.removeChild.call(this, child);
    };
  }catch(_){}

  var SNAP = new Map();
  function snapshotMinis(){
    root.querySelectorAll('.lb-mini-row').forEach(function(mini){
      var k = keyOfMini(mini); if (!k) return;
      SNAP.set(k, mini.outerHTML);
    });
  }
  function ensurePresent(){
    ['#evA','#evB'].forEach(function(sel){
      var table = root.querySelector(sel); if (!table) return;
      var tbody = table.querySelector('tbody') || table;
      SNAP.forEach(function(html, k){
        if (root.querySelector('.lb-mini-row[data-key="'+k+'"]')) return;
        var parts = k.split('|'); var side = parts[0];
        if ((sel==='#evA' && side!=='A') || (sel==='#evB' && side!=='B')) return;
        var tr = root.querySelector('tr[data-lb-key="'+k+'"]');
        if (!tr){
          var name = parts.slice(1).join('|');
          var rows = tbody.querySelectorAll('tr');
          for (var i=0;i<rows.length;i++){
            var td = rows[i].querySelector && rows[i].querySelector('td:nth-child(2)');
            var nm = (td?td.textContent:rows[i].textContent||'').replace(/\s+/g,' ').trim();
            if (nm && nm.indexOf(name)!==-1){ tr = rows[i]; break; }
          }
        }
        if (tr){
          var tmp = document.createElement('tbody'); tmp.innerHTML = html.trim();
          var mini = tmp.firstElementChild; if (!mini) return;
          mini.setAttribute('data-key', k);
          tr.parentNode.insertBefore(mini, tr.nextSibling);
        }
      });
    });
  }
  if (!root.__mcxHardlockObs){
    root.__mcxHardlockObs = true;
    new MutationObserver(function(){
      setTimeout(function(){ snapshotMinis(); ensurePresent(); }, 30);
    }).observe(root, {childList:true, subtree:true});
  }
  setTimeout(function(){ snapshotMinis(); ensurePresent(); }, 80);
})();
</script>
<!-- v20.1: Smaller Tracker pill (about 1/4 of GM/Announcements buttons) -->
<style id="mcx-v20-1-tracker-mini">
#lbFavDock{
  height: 22px !important;
  padding: 3px 6px !important;
  border-radius: 9999px !important;
}
#lbFavDock .txt{
  font-size: 10px !important;
  font-weight: 700 !important;
  letter-spacing: .3px !important;
}
#lbFavDock .dot{
  width: 6px !important;
  height: 6px !important;
  margin-right: 4px !important;
}
@media (max-width: 820px){
  #lbFavDock{ top: 6px !important; height: 20px !important; padding: 2px 6px !important; }
  #lbFavDock .txt{ font-size: 9px !important; }
  #lbFavDock .dot{ width: 5px !important; height: 5px !important; }
}
</style>
<!-- v20.2: Force Pin minis (survive name label changes by side + row index) -->
<style id="mcx-v20-2-forcepin-style">
.lb-mini-row .mcxPinWrap{ position:absolute; top:6px; right:8px; display:flex; gap:6px; z-index:2; }
.lb-mini-row .mcxPinBtn, .lb-mini-row .mcxForceBtn{
  border:none; border-radius:9999px; padding:3px 8px; font-size:11px; cursor:pointer;
  background:#111827; color:#fff; box-shadow:0 2px 6px rgba(0,0,0,.25);
}
.lb-mini-row[data-mcx-pinned="1"]{ outline: 2px solid #2563eb; outline-offset: 2px; }
.lb-mini-row[data-mcx-force="1"]{ outline-color:#10b981; }
</style>
<script id="mcx-v20-2-forcepin">
(function(){
  var root = document.getElementById('live-center-root');
  if (!root) return;

  // Persistence
  var LSKEY = 'mcx.lb.pins.v1';
  function loadPins(){
    try{ var j=JSON.parse(localStorage.getItem(LSKEY)||'[]'); if(Array.isArray(j)) return j; }catch(_){}
    return [];
  }
  function savePins(){ try{ localStorage.setItem(LSKEY, JSON.stringify(PINS)); }catch(_){ } }

  function sideOf(el){
    if (!el) return '?';
    if (el.closest && el.closest('#evA')) return 'A';
    if (el.closest && el.closest('#evB')) return 'B';
    return '?';
  }
  function nameOfRow(tr){
    var td = tr && tr.querySelector && tr.querySelector('td:nth-child(2)');
    return (td?td.textContent: (tr? tr.textContent:'')) .replace(/\s+/g,' ').trim();
  }
  function keyOfRow(tr){
    var k = tr && tr.getAttribute && tr.getAttribute('data-lb-key');
    return k || (sideOf(tr)+'|'+nameOfRow(tr));
  }
  function getRowIndex(tr){
    if (!tr) return -1;
    var tb = tr.parentNode;
    var rows = Array.from(tb.children).filter(function(r){ return !(r.classList && r.classList.contains('lb-mini-row')); });
    return rows.indexOf(tr);
  }
  function rowAtIndex(side, idx){
    var table = root.querySelector(side==='A' ? '#evA' : '#evB');
    if (!table) return null;
    var tb = table.querySelector('tbody') || table;
    var rows = Array.from(tb.children).filter(function(r){ return !(r.classList && r.classList.contains('lb-mini-row')); });
    return rows[idx] || null;
  }
  function findRowByName(side, name){
    var table = root.querySelector(side==='A' ? '#evA' : '#evB') || root;
    var tb = table.querySelector('tbody') || table;
    var rows = Array.from(tb.querySelectorAll('tr')).filter(function(r){ return !(r.classList && r.classList.contains('lb-mini-row')); });
    for (var i=0;i<rows.length;i++){
      var nm = nameOfRow(rows[i]);
      if (nm && nm.indexOf(name)!==-1) return rows[i];
    }
    return null;
  }

  var PINS = loadPins(); // [{k, side, idx, force:0/1}]
  function upsertPin(rec){
    // replace by key if exists; else push
    var i = PINS.findIndex(function(r){ return r.k===rec.k; });
    if (i>=0) PINS[i]=rec; else PINS.push(rec);
    savePins();
  }
  function removePinByKey(k){
    var i = PINS.findIndex(function(r){ return r.k===k; });
    if (i>=0){ PINS.splice(i,1); savePins(); }
  }
  function getPinByKey(k){
    return PINS.find(function(r){ return r.k===k; });
  }

  function decorateMini(mini){
    if (!mini || mini.__mcxDecorated) return;
    mini.__mcxDecorated = true;
    mini.style.position = mini.style.position || 'relative';
    var wrap = document.createElement('div'); wrap.className='mcxPinWrap';
    var pin = document.createElement('button'); pin.className='mcxPinBtn'; pin.textContent='📌 Pin';
    var force = document.createElement('button'); force.className='mcxForceBtn'; force.textContent='🛡 Force';
    wrap.appendChild(pin); wrap.appendChild(force);
    mini.appendChild(wrap);

    var tr = mini.previousElementSibling;
    var k = (mini.getAttribute && mini.getAttribute('data-key')) || keyOfRow(tr);
    var rec = getPinByKey(k);

    function reflect(){
      var r = getPinByKey(k);
      mini.toggleAttribute('data-mcx-pinned', r? '1': '');
      mini.toggleAttribute('data-mcx-force', r && r.force ? '1': '');
      pin.textContent = r ? '📌 Pinned' : '📌 Pin';
      force.textContent = r && r.force ? '🛡 Forced' : '🛡 Force';
    }

    pin.addEventListener('click', function(ev){
      ev.stopPropagation();
      var openTr = mini.previousElementSibling;
      var kNow = (mini.getAttribute && mini.getAttribute('data-key')) || keyOfRow(openTr);
      var i = PINS.findIndex(function(r){ return r.k===kNow; });
      if (i>=0){ PINS.splice(i,1); }
      else {
        var rec = { k: kNow, side: sideOf(openTr), idx: getRowIndex(openTr), force: 0 };
        PINS.push(rec);
      }
      savePins(); reflect();
    });
    force.addEventListener('click', function(ev){
      ev.stopPropagation();
      var openTr = mini.previousElementSibling;
      var kNow = (mini.getAttribute && mini.getAttribute('data-key')) || keyOfRow(openTr);
      var rec = getPinByKey(kNow);
      if (!rec){
        rec = { k: kNow, side: sideOf(openTr), idx: getRowIndex(openTr), force: 1 };
        PINS.push(rec);
      }else{
        rec.force = rec.force ? 0 : 1;
        // refresh index when enabling force
        if (rec.force){ rec.idx = getRowIndex(openTr); rec.side = sideOf(openTr); }
      }
      savePins(); reflect();
    });

    reflect();
  }

  // Observe to decorate any new minis
  if (!root.__mcxForceDecor){
    root.__mcxForceDecor = true;
    new MutationObserver(function(muts){
      muts.forEach(function(m){
        Array.from(m.addedNodes||[]).forEach(function(n){
          if (n.nodeType===1){
            if (n.classList && n.classList.contains('lb-mini-row')) decorateMini(n);
            n.querySelectorAll && n.querySelectorAll('.lb-mini-row').forEach(decorateMini);
          }
        });
      });
    }).observe(root, { childList:true, subtree:true });
  }
  // Decorate existing
  root.querySelectorAll('.lb-mini-row').forEach(decorateMini);

  var reopenBusy = false;
  function ensurePins(){
    if (reopenBusy) return; reopenBusy = true;
    try{
      PINS.forEach(function(rec){
        // First, try to find by current key
        var tr = root.querySelector('tr[data-lb-key="'+rec.k+'"]');
        if (!tr){
          // Try by name within side
          var name = rec.k.split('|').slice(1).join('|');
          tr = findRowByName(rec.side, name);
        }
        if (!tr && rec.force){
          // Fallback by stored index within side
          tr = rowAtIndex(rec.side, rec.idx);
        }
        if (!tr) return; // can't yet map; wait for next refresh

        // If key changed (e.g., name changed), update record
        var kNow = keyOfRow(tr);
        if (kNow !== rec.k){
          rec.k = kNow;
          // refresh stored index too
          rec.idx = getRowIndex(tr);
          savePins();
        }

        // Ensure mini is open under this tr
        var open = tr.nextElementSibling && tr.nextElementSibling.classList && tr.nextElementSibling.classList.contains('lb-mini-row');
        if (!open && typeof tr.click==='function'){ tr.click(); }
        // If a stray mini exists not directly after tr (e.g., stale), hide it
        var stray = root.querySelector('.lb-mini-row[data-key="'+rec.k+'"]');
        if (stray && stray.previousElementSibling !== tr){
          stray.style.display='none';
        }
      });
    } finally { reopenBusy = false; }
  }

  // Run on mutations and on a slow interval
  if (!root.__mcxForcePinsObs){
    root.__mcxForcePinsObs = true;
    new MutationObserver(function(){ setTimeout(ensurePins, 40); }).observe(root, { childList:true, subtree:true });
  }
  setInterval(ensurePins, 800);

  // Seed: if minis are already open at load and not pinned, offer controls
  root.querySelectorAll('.lb-mini-row').forEach(decorateMini);
})();
</script>
<!-- v20.3: Robust GM + Tracker click handlers -->
<script id="mcx-v20-3-fixes">
(function(){
  function $(sel, ctx){ return (ctx||document).querySelector(sel); }
  function findGmDock(){
    return $('#gmDock49') ||
           document.querySelector('[id^="gmDock"]') ||
           document.querySelector('.gm-dock') ||
           document.querySelector('[data-gm-dock]') ||
           document.querySelector('[data-role="gmDock"],[data-role="gm-dock"]');
  }
  function show(el){ if(!el) return; el.style.display='block'; el.style.opacity='1'; el.style.pointerEvents='auto'; el.style.visibility='visible'; }
  function hide(el){ if(!el) return; el.style.display='none'; }

  // Rebind bottom tab buttons every time to be safe
  function wireTabs(){
    var ann = document.getElementById('qtabAnn');
    var gm  = document.getElementById('qtabGM');
    if (ann && !ann.__mcx){
      ann.__mcx = true;
      ann.addEventListener('click', function(e){
        e.stopPropagation();
        var banner = document.getElementById('gmBanner48') ||
                     document.querySelector('[id^="gmBanner"]') ||
                     document.querySelector('.gm-banner,[data-role="announcement"]');
        if(!banner){ return; }
        var isHidden = (banner.style.display==='none') || (getComputedStyle(banner).display==='none');
        if (isHidden) show(banner); else hide(banner);
      });
    }
    if (gm && !gm.__mcx){
      gm.__mcx = true;
      gm.addEventListener('click', function(e){
        e.stopPropagation();
        var dock = findGmDock();
        if (!dock) return;
        var isHidden = (dock.style.display==='none') || (getComputedStyle(dock).display==='none');
        if (isHidden){ show(dock); }
        else { hide(dock); }
      });
    }
  }

  // Tracker pill click → open favorites sidebar (or toggle if already visible)
  function wireTracker(){
    var pill = document.getElementById('lbFavDock');
    if (pill && !pill.__mcx){
      pill.__mcx = true;
      pill.style.pointerEvents = 'auto'; // ensure clickable
      pill.addEventListener('click', function(e){
        e.stopPropagation();
        var side = document.getElementById('lbFavSidebar') ||
                   document.querySelector('#lbFavSidebar,[data-role="fav-sidebar"],.lb-fav-sidebar');
        if (!side) return;
        var isHidden = (side.style.display==='none') || (getComputedStyle(side).display==='none');
        if (isHidden){ show(side); }
        else { hide(side); }
      });
    }
  }

  function tick(){
    wireTabs();
    wireTracker();
  }
  tick();
  setInterval(tick, 800);
})();
</script>
<!-- v20.4: Tracker everywhere; GM only on Tee Sheet -->
<script id="mcx-v20-4-page-logic">
(function(){
  function $(sel, ctx){ return (ctx||document).querySelector(sel); }
  function all(sel, ctx){ return Array.from((ctx||document).querySelectorAll(sel)); }

  // Heuristic: are we past login? (any nav/sidebar/table present, or known app root present)
  function isLoggedIn(){
    try{
      if (document.getElementById('live-center-root')) return true;
      var navish = document.querySelector('nav, [role="navigation"], .sidebar, .app-shell, header');
      var tables = document.querySelectorAll('table'); if (tables.length>0) return true;
      // URLs that look like login
      var url = (location.pathname+location.hash+location.search).toLowerCase();
      if (/login|signin/.test(url)) return false;
    }catch(e){}
    return true; // default to true so tracker is widely available
  }

  // Detect Tee Sheet pages by URL/labels
  function isTeeSheetPage(){
    try{
      var url = (location.pathname+location.hash+location.search).toLowerCase();
      if (/tee[-\s]?sheet|t[-\s]?sheet|\/tee|#tee/.test(url)) return true;
      var textBits = all('a,button,li,[role="tab"]')
        .map(el => (el.textContent||'').trim().toLowerCase());
      if (textBits.some(t => t==='tee sheet' || t.includes('tee sheet'))) return true;
      var heads = all('h1,h2,h3,[role="heading"]')
        .map(h => (h.textContent||'').trim().toLowerCase());
      if (heads.some(t => t.includes('tee sheet'))) return true;
    }catch(e){}
    return false;
  }

  function findGmDock(){
    return $('#gmDock49') ||
           document.querySelector('[id^="gmDock"]') ||
           document.querySelector('.gm-dock') ||
           document.querySelector('[data-gm-dock]') ||
           document.querySelector('[data-role="gmDock"],[data-role="gm-dock"]');
  }

  function show(el){ if(!el) return; el.style.display='block'; el.style.opacity='1'; el.style.pointerEvents='auto'; el.style.visibility='visible'; }
  function hide(el){ if(!el) return; el.style.display='none'; }

  // Ensure bottom bar exists (Announcements + GM spot)
  function ensureBar(){
    var bar = $('#quickBarTabs');
    if (!bar){
      bar = document.createElement('div');
      bar.id='quickBarTabs';
      bar.innerHTML = '<button id="qtabAnn" class="secondary"><span class="icon">🔔</span><span>Announcements</span></button>'+
                      '<button id="qtabGM"><span class="icon">🛠</span><span>GM</span></button>';
      document.body.appendChild(bar);
    }
    // Wire Announcements toggle
    var ann = $('#qtabAnn');
    if (ann && !ann.__mcx){
      ann.__mcx = true;
      ann.addEventListener('click', function(e){
        e.stopPropagation();
        var banner = $('#gmBanner48') || document.querySelector('[id^="gmBanner"]') ||
                     document.querySelector('.gm-banner,[data-role="announcement"]');
        if(!banner) return;
        var hidden = (banner.style.display==='none') || (getComputedStyle(banner).display==='none');
        if (hidden) show(banner); else hide(banner);
      });
    }
    // Wire GM toggle
    var gm = $('#qtabGM');
    if (gm && !gm.__mcx){
      gm.__mcx = true;
      gm.addEventListener('click', function(e){
        e.stopPropagation();
        var dock = findGmDock(); if (!dock) return;
        var hidden = (dock.style.display==='none') || (getComputedStyle(dock).display==='none');
        if (hidden) show(dock); else hide(dock);
      });
    }
  }

  // Tracker pill should be available anywhere after login
  function ensureTracker(){
    var pill = document.getElementById('lbFavDock');
    if (!pill){
      pill = document.createElement('div');
      pill.id='lbFavDock';
      pill.innerHTML = '<span class="dot"></span><span class="txt">Tracker</span>';
      pill.style.cssText = 'position:fixed;top:8px;left:50%;transform:translateX(-50%);z-index:2147483640;background:rgba(17,24,39,.9);color:#fff;padding:3px 6px;border-radius:9999px;box-shadow:0 8px 24px rgba(0,0,0,.35);cursor:pointer;height:22px;display:inline-flex;align-items:center;gap:4px;';
      document.body.appendChild(pill);
    }
    if (!pill.__mcx){
      pill.__mcx = true;
      pill.addEventListener('click', function(e){
        e.stopPropagation();
        var side = document.getElementById('lbFavSidebar') ||
                   document.querySelector('#lbFavSidebar,[data-role="fav-sidebar"],.lb-fav-sidebar');
        if (!side) return;
        var isHidden = (side.style.display==='none') || (getComputedStyle(side).display==='none');
        if (isHidden){ show(side); } else { hide(side); }
      });
    }
    pill.style.display = isLoggedIn() ? 'inline-flex' : 'none';
  }

  // GM visibility strictly tied to Tee Sheet
  function updateGM(){
    var gmBtn = document.getElementById('qtabGM');
    var dock = findGmDock();
    var onTS = isTeeSheetPage();
    if (gmBtn){ gmBtn.style.display = onTS ? 'inline-flex' : 'none'; }
    if (!onTS){ hide(dock); } // ensure it's closed elsewhere
  }

  function tick(){
    ensureBar();
    ensureTracker();
    updateGM();
  }

  // react to route changes
  window.addEventListener('hashchange', tick);
  window.addEventListener('popstate', tick);
  setInterval(tick, 800);
  tick();
})();
</script>
<!-- v20.5 styles: bottom bar includes Tracker; hide top Tracker pill -->
<style id="mcx-v20-5-styles">
/* Hide legacy top pill */
#lbFavDock{ display:none !important; }

/* Bottom bar spacing for 3 buttons */
#quickBarTabs{ gap: 10px !important; padding: 6px 10px !important; }
#quickBarTabs button{ min-width: 44px; height: 36px; font-size: 14px; }
#quickBarTabs button .icon{ font-size: 16px; }
/* Make tracker a small secondary button by default */
#qtabTracker{ background:#374151 !important; }
</style>
<!-- v20.5 script: Tracker button in bottom bar; GM only on Tee Sheet -->
<script id="mcx-v20-5-bar">
(function(){
  function $(sel, ctx){ return (ctx||document).querySelector(sel); }
  function all(sel, ctx){ return Array.from((ctx||document).querySelectorAll(sel)); }

  // is user past login?
  function isLoggedIn(){
    try{
      if (document.getElementById('live-center-root')) return true;
      if (document.querySelector('nav,[role="navigation"],header,.sidebar,.app-shell')) return true;
      var url=(location.pathname+location.hash+location.search).toLowerCase();
      if (/login|signin/.test(url)) return false;
    }catch(e){}
    return true;
  }
  // Detect Tee Sheet
  function isTeeSheetPage(){
    try{
      var url=(location.pathname+location.hash+location.search).toLowerCase();
      if (/tee[-\s]?sheet|t[-\s]?sheet|\/tee|#tee/.test(url)) return true;
      var bits=all('a,button,li,[role="tab"]').map(el=>(el.textContent||'').trim().toLowerCase());
      if (bits.some(t=>t==='tee sheet'||t.includes('tee sheet'))) return true;
      var heads=all('h1,h2,h3,[role="heading"]').map(h=>(h.textContent||'').trim().toLowerCase());
      if (heads.some(t=>t.includes('tee sheet'))) return true;
    }catch(e){}
    return false;
  }
  function findGmDock(){
    return $('#gmDock49') ||
           document.querySelector('[id^="gmDock"]') ||
           document.querySelector('.gm-dock') ||
           document.querySelector('[data-gm-dock]') ||
           document.querySelector('[data-role="gmDock"],[data-role="gm-dock"]');
  }
  function show(el){ if(!el) return; el.style.display='block'; el.style.opacity='1'; el.style.pointerEvents='auto'; el.style.visibility='visible'; }
  function hide(el){ if(!el) return; el.style.display='none'; }

  function ensureBar(){
    var bar=$('#quickBarTabs');
    if (!bar){
      bar=document.createElement('div');
      bar.id='quickBarTabs';
      bar.innerHTML = ''
        + '<button id="qtabAnn" class="secondary"><span class="icon">🔔</span><span>Announcements</span></button>'
        + '<button id="qtabTracker"><span class="icon">📊</span><span>Tracker</span></button>'
        + '<button id="qtabGM"><span class="icon">🛠</span><span>GM</span></button>';
      document.body.appendChild(bar);
    }
    // wire Announcements
    var ann=$('#qtabAnn');
    if (ann && !ann.__mcx){
      ann.__mcx=true;
      ann.addEventListener('click', function(e){
        e.stopPropagation();
        var banner = $('#gmBanner48') || document.querySelector('[id^="gmBanner"]') ||
                     document.querySelector('.gm-banner,[data-role="announcement"]');
        if (!banner) return;
        var hidden=(banner.style.display==='none') || (getComputedStyle(banner).display==='none');
        if (hidden) show(banner); else hide(banner);
      });
    }
    // wire Tracker (open/close favorites sidebar)
    var trk=$('#qtabTracker');
    if (trk && !trk.__mcx){
      trk.__mcx=true;
      trk.addEventListener('click', function(e){
        e.stopPropagation();
        var side = document.getElementById('lbFavSidebar') ||
                   document.querySelector('#lbFavSidebar,[data-role="fav-sidebar"],.lb-fav-sidebar');
        if (!side) return;
        var hidden=(side.style.display==='none') || (getComputedStyle(side).display==='none');
        if (hidden) show(side); else hide(side);
      });
    }
    // wire GM
    var gm=$('#qtabGM');
    if (gm && !gm.__mcx){
      gm.__mcx=true;
      gm.addEventListener('click', function(e){
        e.stopPropagation();
        var dock=findGmDock(); if (!dock) return;
        var hidden=(dock.style.display==='none') || (getComputedStyle(dock).display==='none');
        if (hidden) show(dock); else hide(dock);
      });
    }
  }

  function updateVisibility(){
    var bar=$('#quickBarTabs');
    if (!bar) return;
    // Tracker shows anywhere after login
    bar.style.display = isLoggedIn() ? 'flex' : 'none';
    // GM only on Tee Sheet
    var onTS = isTeeSheetPage();
    var gmBtn = $('#qtabGM');
    if (gmBtn) gmBtn.style.display = onTS ? 'inline-flex' : 'none';
    if (!onTS){ hide(findGmDock()); }
  }

  function tick(){ ensureBar(); updateVisibility(); }
  window.addEventListener('hashchange', tick);
  window.addEventListener('popstate', tick);
  setInterval(tick, 700);
  tick();
})();
</script>
<!-- v20.6: Force-add Tracker button to existing bottom bar -->
<script id="mcx-v20-6-fix-tracker-missing">
(function(){
  function $(sel, ctx){ return (ctx||document).querySelector(sel); }
  function all(sel, ctx){ return Array.from((ctx||document).querySelectorAll(sel)); }
  function isLoggedIn(){
    try{
      if (document.getElementById('live-center-root')) return true;
      if (document.querySelector('nav,[role="navigation"],header,.sidebar,.app-shell')) return true;
      var url=(location.pathname+location.hash+location.search).toLowerCase();
      if (/login|signin/.test(url)) return false;
    }catch(e){}
    return true;
  }
  function isTeeSheetPage(){
    try{
      var url=(location.pathname+location.hash+location.search).toLowerCase();
      if (/tee[-\s]?sheet|t[-\s]?sheet|\/tee|#tee/.test(url)) return true;
      var bits=all('a,button,li,[role="tab"]').map(el=>(el.textContent||'').trim().toLowerCase());
      if (bits.some(t=>t==='tee sheet'||t.includes('tee sheet'))) return true;
      var heads=all('h1,h2,h3,[role="heading"]').map(h=>(h.textContent||'').trim().toLowerCase());
      if (heads.some(t=>t.includes('tee sheet'))) return true;
    }catch(e){}
    return false;
  }
  function findGmDock(){
    return $('#gmDock49') ||
           document.querySelector('[id^="gmDock"]') ||
           document.querySelector('.gm-dock') ||
           document.querySelector('[data-gm-dock]') ||
           document.querySelector('[data-role="gmDock"],[data-role="gm-dock"]');
  }
  function show(el){ if(!el) return; el.style.display='block'; el.style.opacity='1'; el.style.pointerEvents='auto'; el.style.visibility='visible'; }
  function hide(el){ if(!el) return; el.style.display='none'; }
  function ensureHandlers(btn, fn){
    if (btn && !btn.__mcx){
      btn.__mcx = true; btn.addEventListener('click', function(e){ e.stopPropagation(); fn(); });
    }
  }

  function upgradeBar(){
    var bar = $('#quickBarTabs');
    if (!bar){
      bar = document.createElement('div');
      bar.id='quickBarTabs';
      document.body.appendChild(bar);
    }
    // Ensure buttons exist (append missing ones, preserve order Ann, Tracker, GM)
    if (!$('#qtabAnn')){
      var ann = document.createElement('button'); ann.id='qtabAnn'; ann.className='secondary';
      ann.innerHTML = '<span class="icon">🔔</span><span>Announcements</span>'; bar.appendChild(ann);
    }
    if (!$('#qtabTracker')){
      var trk = document.createElement('button'); trk.id='qtabTracker';
      trk.innerHTML = '<span class="icon">📊</span><span>Tracker</span>'; bar.appendChild(trk);
    }
    if (!$('#qtabGM')){
      var gm = document.createElement('button'); gm.id='qtabGM';
      gm.innerHTML = '<span class="icon">🛠</span><span>GM</span>'; bar.appendChild(gm);
    }
    // Wire
    ensureHandlers($('#qtabAnn'), function(){
      var banner = $('#gmBanner48') || document.querySelector('[id^="gmBanner"]') ||
                   document.querySelector('.gm-banner,[data-role="announcement"]');
      if (!banner) return;
      var hidden=(banner.style.display==='none') || (getComputedStyle(banner).display==='none');
      if (hidden) show(banner); else hide(banner);
    });
    ensureHandlers($('#qtabTracker'), function(){
      var side = document.getElementById('lbFavSidebar') ||
                 document.querySelector('#lbFavSidebar,[data-role="fav-sidebar"],.lb-fav-sidebar');
      if (!side) return;
      var hidden=(side.style.display==='none') || (getComputedStyle(side).display==='none');
      if (hidden) show(side); else hide(side);
    });
    ensureHandlers($('#qtabGM'), function(){
      var dock = findGmDock(); if (!dock) return;
      var hidden=(dock.style.display==='none') || (getComputedStyle(dock).display==='none');
      if (hidden) show(dock); else hide(dock);
    });
  }

  function updateVisibility(){
    var bar = $('#quickBarTabs'); if (!bar) return;
    bar.style.display = isLoggedIn() ? 'flex' : 'none';
    var onTS = isTeeSheetPage();
    var gmBtn = $('#qtabGM'); if (gmBtn) gmBtn.style.display = onTS ? 'inline-flex' : 'none';
    if (!onTS){ hide(findGmDock()); }
  }

  function tick(){ upgradeBar(); updateVisibility(); }
  tick();
  setInterval(tick, 600);
  window.addEventListener('hashchange', tick);
  window.addEventListener('popstate', tick);
})();
</script>
<style id="mcx-quickadd-css">
  #mcxQuickAdd{position:absolute;z-index:2147483000;background:#0b1220;color:#e5e7eb;border:1px solid #374151;border-radius:12px;box-shadow:0 14px 40px rgba(0,0,0,.45);padding:12px;display:none;width:320px}
  #mcxQuickAdd label{font-size:12px;opacity:.9;margin-top:6px;display:block}
  #mcxQuickAdd input,#mcxQuickAdd select{width:100%;background:#0f172a;color:#e5e7eb;border:1px solid #334155;border-radius:8px;padding:8px;margin-top:4px}
  #mcxQuickAdd .row{display:flex;gap:8px}
  #mcxQuickAdd .row>div{flex:1}
  #mcxQuickAdd .actions{display:flex;gap:8px;margin-top:10px;justify-content:flex-end}
  #mcxQuickAdd button{border:1px solid #475569;border-radius:8px;padding:6px 10px;background:#111827;color:#e5e7eb;cursor:pointer}
  #mcxQuickAdd button.primary{background:#1f2937}
</style>
<div aria-label="Quick Add Booking" id="mcxQuickAdd" role="dialog">
<div class="row">
<div><label>Golfer</label><input id="mcxQaGolfer" placeholder="e.g., Peter Park"/></div>
<div><label>Caddy ID</label><input id="mcxQaCaddy" placeholder="e.g., 003"/></div>
</div>
<label>Course</label>
<select id="mcxQaCourse">
<option>Pattaya Country Club</option>
<option>Eastern Star</option>
<option>Siam Old Course</option>
</select>
<label>Notes</label>
<input id="mcxQaNotes" placeholder="VIP, preferences, etc."/>
<div class="actions">
<button id="mcxQaCancel">Cancel</button>
<button class="primary" id="mcxQaSave">Save</button>
</div>
</div>
<script id="mcx-quickadd-js">
(function(){
  if (window.__mcxQuickAddBoot) return; window.__mcxQuickAddBoot = true;
  const qa = document.getElementById('mcxQuickAdd');
  const inGolfer = document.getElementById('mcxQaGolfer');
  const inCaddy  = document.getElementById('mcxQaCaddy');
  const inCourse = document.getElementById('mcxQaCourse');
  const inNotes  = document.getElementById('mcxQaNotes');
  let current = { time:null, tee:null };
  function hide(){ qa.style.display='none'; current.time=current.tee=null; }
  function showAt(rect){
    const pad=8;
    qa.style.left = Math.max(8, Math.min(window.innerWidth-qa.offsetWidth-8, rect.left + window.scrollX)) + 'px';
    qa.style.top  = (rect.bottom + window.scrollY + pad) + 'px';
    qa.style.display='block';
    setTimeout(()=>inGolfer.focus(), 50);
  }
  window.mcxQuickAdd = function(time, tee, ev){
    current.time=time; current.tee=tee;
    inGolfer.value=''; inCaddy.value=''; inCourse.value=inCourse.options[0].value; inNotes.value='';
    const target = (ev && ev.target ? ev.target.getBoundingClientRect() : qa.getBoundingClientRect());
    showAt(target);
  };
  document.getElementById('mcxQaCancel').addEventListener('click', hide);
  document.getElementById('mcxQaSave').addEventListener('click', function(ev){
    ev.preventDefault();
    const g = inGolfer.value.trim(); const c = inCaddy.value.trim().padStart(3,'0');
    if (!g || !c) { inGolfer.focus(); return; }
    if (window.mcxAddBooking && current.time && current.tee){
      const r = window.mcxAddBooking(current.time, current.tee, { golfer:g, caddyId:c, course:inCourse.value, notes:inNotes.value });
      if (!r || !r.ok){ alert('Save failed'); }
    } else {
      alert('Save wiring missing'); 
    }
    hide();
  });
})();
</script>
<style id="mcx-games-compact-css">
  .mcx-games-header { display:flex !important; justify-content:flex-start !important; gap:.5rem !important; flex-wrap:wrap !important; }
  .mcx-games-left { display:flex !important; gap:.5rem !important; align-items:center !important; }
  .mcx-games-left .mcx-hide { display:none !important; }
  @media (max-width: 640px){ .mcx-games-left button { flex: 1 1 auto; } }
</style>
<script id="mcx-games-compact-js">
(function(){
  if (window.__mcxGamesCompact) return; window.__mcxGamesCompact = true;
  function compact(){
    try{
      var chip = document.getElementById('ucg-course-chip');
      var dir  = document.getElementById('ucg-dir');
      if (!chip || !dir) return;
      var left = chip.closest('div');
      var header = left && left.parentElement;
      var right = dir.closest('div');
      if (!header || !left || !right) return;
      header.classList.add('mcx-games-header');
      left.classList.add('mcx-games-left');
      var gamesLabel = left.querySelector('span.font-semibold');
      if (gamesLabel) gamesLabel.classList.add('mcx-hide');
      chip.classList.add('mcx-hide');
      if (right !== left){
        while (right.firstElementChild){ left.appendChild(right.firstElementChild); }
        right.style.display='none';
      }
    }catch(e){}
  }
  window.addEventListener('load', function(){ setTimeout(compact, 400); });
  window.addEventListener('hashchange', function(){ setTimeout(compact, 400); });
})();
</script>
<script id="mcx-search-jump">
(function(){
  if (window.__mcxSearchJumpBoot) return; window.__mcxSearchJumpBoot = true;

  function norm(s){ return String(s||'').toLowerCase().replace(/\s+/g,' ').trim(); }

  function findSearchInput(){
    // Look for the search box used on the GM Tee Sheet toolbar
    const inputs = Array.from(document.querySelectorAll('input[placeholder],input[type="search"]'));
    return inputs.find(i => /search.*golfer.*caddy/i.test(i.placeholder||'')) || null;
  }

  function findMatchEl(query){
    const q = norm(query);
    if (!q) return null;
    // Prefer a highlighted cell if your UI adds one
    const hi = document.querySelector('.ring-blue-500, .bg-yellow-100, .highlight');
    if (hi && norm(hi.textContent).includes(q)) return hi;
    // Otherwise search all data-key cells (we annotate them on empty cells)
    const cells = Array.from(document.querySelectorAll('[data-key]'));
    for (const cell of cells){
      const txt = norm(cell.textContent);
      if (txt.includes(q)) return cell;
    }
    return null;
  }

  function jumpTo(query){
    const el = findMatchEl(query);
    if (el && el.scrollIntoView){
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      // Subtle pulse
      el.classList.add('ring-2','ring-blue-500');
      setTimeout(()=> el.classList.remove('ring-2','ring-blue-500'), 900);
    }
  }

  function boot(){
    const input = findSearchInput();
    if (!input){ return setTimeout(boot, 400); }

    let last = '';
    input.addEventListener('input', function(){
      const val = input.value||'';
      if (val === last) return;
      last = val;
      // Defer a tick so the filtered grid renders
      setTimeout(()=> jumpTo(val), 120);
    });

    // Also run when the page hash/tab changes back to GM view
    window.addEventListener('hashchange', function(){
      const input2 = findSearchInput();
      if (input2 && input2.value) setTimeout(()=> jumpTo(input2.value), 250);
    });
  }

  if (document.readyState !== 'loading') boot(); else document.addEventListener('DOMContentLoaded', boot);
  // safety retry
  setTimeout(boot, 800);
})();
</script>
<style id="quickBarTabs-scale-55">
#quickBarTabs{
  transform: translateX(-50%) scale(0.55) !important;
  transform-origin: center bottom !important;
}
</style>
<script id="mcp-x-injector-v8">
(function(){
  if (window.__mcp_x_v8) return; window.__mcp_x_v8 = true;
  var LABELS = {'events':1,'participants':1,'pairings':1,'analytics':1};

  function norm(t){ return (t||'').replace(/\s+/g,' ').trim().toLowerCase(); }
  function isTabLabel(el){
    var t = norm(el.textContent);
    return !!LABELS[t];
  }
  function findTabsRowInDoc(doc){
    // 1) Collect all elements that look like tab labels (button, a, [role=tab], div/span with matching text)
    var candidates = Array.from(doc.querySelectorAll('button, a, [role="tab"], div, span')).filter(isTabLabel);
    if (candidates.length < 3) return null;
    // 2) From the first label, climb up until we find an ancestor that contains at least 3 labels
    var node = candidates[0];
    while (node && node !== doc.body){
      var count = 0;
      for (var i=0;i<candidates.length;i++){ if (node.contains(candidates[i])) count++; }
      if (count >= 3){
        // Prefer a shallow child within this ancestor that itself contains >=3 labels (the true row)
        var kids = Array.from(node.children);
        for (var k=0;k<kids.length;k++){
          var kid = kids[k], kidCount = 0;
          for (var j=0;j<candidates.length;j++){ if (kid.contains(candidates[j])) kidCount++; }
          if (kidCount >= 3) { node = kid; break; }
        }
        return node;
      }
      node = node.parentElement;
    }
    // 3) Fallback: any element whose text contains all four words
    var blocks = Array.from(doc.querySelectorAll('div,nav,header,section'));
    for (var b=0;b<blocks.length;b++){
      var text = norm(blocks[b].textContent);
      if (text.includes('events') && text.includes('participants') && text.includes('pairings') && text.includes('analytics')){
        return blocks[b];
      }
    }
    return null;
  }

  function ensureXInDoc(doc, closer){
    try{
      var row = findTabsRowInDoc(doc);
      if (!row) return false;
      if (row.querySelector('#mcp_modal_inline_x')) return true;
      // Positioning
      var cs = (doc.defaultView||window).getComputedStyle(row);
      if (cs.position === 'static') row.style.position = 'relative';
      // Create X
      var x = doc.createElement('button');
      x.id = 'mcp_modal_inline_x';
      x.setAttribute('aria-label','Close');
      x.innerHTML = '×';
      x.style.cssText = 'position:absolute;right:12px;top:50%;transform:translateY(-50%);width:32px;height:32px;border-radius:9999px;border:1px solid #e5e7eb;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,.12);cursor:pointer;z-index:50;font-size:20px;line-height:20px';
      x.addEventListener('click', function(){ try{ closer(); }catch(_){} });
      row.appendChild(x);
      return true;
    }catch(_){ return false; }
  }

  function findDialogRoot(){
    // Prefer an explicit dialog; otherwise the highest z-index fixed container
    var dlg = document.querySelector('[role="dialog"]');
    if (dlg) return dlg;
    var nodes = Array.from(document.querySelectorAll('div,section,main,article'));
    var best = null, bestZ = 0;
    nodes.forEach(function(n){
      var cs = getComputedStyle(n);
      if (cs.position === 'fixed'){
        var z = parseInt(cs.zIndex||'0',10) || 0;
        if (z > bestZ){ bestZ = z; best = n; }
      }
    });
    return best;
  }

  function attach(){
    var root = findDialogRoot();
    if (!root) return;
    var attached = false;
    // Parent document close
    var parentCloser = function(){ try{ if (root.parentNode) root.parentNode.removeChild(root); }catch(_){ } };
    attached = ensureXInDoc(document, parentCloser) || attached;
    // If there's an iframe inside the dialog, attach inside too
    var ifr = root.querySelector('iframe') || document.getElementById('mcp_pairings_iframe');
    if (ifr){
      try{
        var idoc = ifr.contentDocument || (ifr.contentWindow && ifr.contentWindow.document);
        if (idoc){
          var iframeCloser = function(){ parentCloser(); };
          attached = ensureXInDoc(idoc, iframeCloser) || attached;
        }
      }catch(_){ /* cross-origin, ignore */ }
    }
  }

  var mo = new MutationObserver(function(){ attach(); });
  mo.observe(document.documentElement, {subtree:true, childList:true});
  window.addEventListener('load', function(){
    attach();
    setTimeout(attach, 120);
    setTimeout(attach, 400);
    setTimeout(attach, 1000);
  });
})();
</script>
<script id="mcp-any-modal-x-v1">
(function(){
  if (window.__mcp_any_x_v1) return; window.__mcp_any_x_v1 = true;

  var SKIP_WORDS = ['events','participants','pairings','analytics']; // skip Pairings modal (handled elsewhere)

  function isWhite(bg){
    return /rgb\(\s*255\s*,\s*255\s*,\s*255\s*\)/i.test(bg) || /#fff\b/i.test(bg) || /white/i.test(bg);
  }

  function findPanels(){
    var dialogs = Array.from(document.querySelectorAll('[role="dialog"]'));
    var panels = [];
    dialogs.forEach(function(dlg){
      // choose the largest white-ish card inside this dialog
      var best = null, bestArea = 0;
      Array.from(dlg.querySelectorAll('div,section,main,article')).forEach(function(el){
        try{
          var cs = getComputedStyle(el);
          if (!isWhite(cs.backgroundColor)) return;
          var r = el.getBoundingClientRect();
          var area = (r.width||0) * (r.height||0);
          if (area > bestArea){ best = el; bestArea = area; }
        }catch(_){}
      });
      panels.push(best || dlg);
    });
    return panels;
  }

  function placeX(panel){
    if (!panel) return;
    var txt = (panel.textContent||'').toLowerCase();
    var isPairings = SKIP_WORDS.every(function(w){ return txt.indexOf(w) !== -1; });
    if (isPairings) return; // let the pairings-specific injector handle it

    if (panel.querySelector('.mc-any-x')) return;
    var btn = document.createElement('button');
    btn.className = 'mc-any-x';
    btn.setAttribute('aria-label', 'Close');
    btn.innerHTML = '×';
    btn.style.cssText = 'position:absolute;right:12px;top:12px;width:32px;height:32px;border-radius:9999px;border:1px solid #e5e7eb;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,.12);cursor:pointer;z-index:1002;font-size:20px;line-height:20px';
    // ensure panel can host absolutely positioned child
    try{ var cs = getComputedStyle(panel); if (cs.position === 'static') panel.style.position = 'relative'; }catch(_){}
    btn.addEventListener('click', function(){
      try{
        var dlg = panel.closest('[role=\"dialog\"]') || panel;
        if (dlg && dlg.parentNode) dlg.parentNode.removeChild(dlg);
        else document.dispatchEvent(new KeyboardEvent('keydown', {key:'Escape'}));
      }catch(_){}
    });
    panel.appendChild(btn);
  }

  function scan(){
    findPanels().forEach(placeX);
  }

  var mo = new MutationObserver(function(){ scan(); });
  mo.observe(document.documentElement, {subtree:true, childList:true});

  window.addEventListener('load', function(){
    scan(); setTimeout(scan, 120); setTimeout(scan, 400);
  });
})();
</script>
<script>(function () {
if (window.WHS) return;
function round1(x){ return Math.round(x*10)/10; }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function adjustedGrossFallback(o){ return o.gross; }
function scoreDifferential(o){ if(!o.slopeRating) return null; const sd=((o.adjustedGross - o.courseRating - (o.PCC||0)) * 113)/o.slopeRating; return round1(sd); }
function hiFromDifferentials(diffs, opts={}){
  const d = diffs.filter(x=>Number.isFinite(x)).slice(-20).sort((a,b)=>a-b);
  const n = d.length; if(n<3) return null;
  let take=0, adj=0;
  if(n===3){take=1;adj=-2.0;} else if(n===4){take=1;adj=-1.0;} else if(n===5){take=1;adj=-0.5;}
  else if(n===6){take=2;} else if(n<=8){take=2;} else if(n<=11){take=3;} else if(n<=14){take=4;}
  else if(n<=16){take=5;} else if(n<=18){take=6;} else if(n===19){take=7;} else {take=8;}
  let HI = round1(d.slice(0,take).reduce((a,b)=>a+b,0)/take + adj);
  const newest = diffs[diffs.length-1];
  if(Number.isFinite(HI) && Number.isFinite(newest)){
    const gap = HI - newest;
    if (gap >= 10) HI = round1(HI - 2.0); else if (gap >= 7) HI = round1(HI - 1.0);
  }
  const low = opts.lowHI12mo;
  if (Number.isFinite(low)){
    const diff = HI - low;
    if (diff > 3) { HI = round1(low + 3 + 0.5*(diff-3)); HI = round1(clamp(HI, -50, low + 5)); }
    else { HI = round1(clamp(HI, -50, low + 5)); }
  }
  return HI;
}
function courseHandicap(o){ if(!Number.isFinite(o.handicapIndex)||!o.slopeRating) return null; return Math.round(o.handicapIndex*(o.slopeRating/113)+((o.courseRating||0)-(o.par||0))); }
function playingHandicap(o){ if(!Number.isFinite(o.courseHandicap)) return null; return Math.round(o.courseHandicap*(o.allowance||1)); }
window.WHS = { adjustedGrossFallback, scoreDifferential, hiFromDifferentials, courseHandicap, playingHandicap };
})();</script><script>(function(){
if (window.WHS_HI_AfterIndex) return;
window.WHS_HI_AfterIndex = function(idx, rounds){
  try{
    rounds = Array.isArray(rounds) ? rounds.slice(idx) : [];
    if (!rounds.length) return null;
    var defaultSlope = 120, defaultCR = 72.0;
    var diffs = rounds.map(function(r){
      var gross = Number(r.score || r.gross || r.total || 0);
      var cr    = Number(r.courseRating || r.cr || defaultCR);
      var slope = Number(r.slope || r.slopeRating || defaultSlope);
      var adj   = (window.WHS && WHS.adjustedGrossFallback({ gross: gross })) || gross;
      return window.WHS ? WHS.scoreDifferential({ adjustedGross: adj, courseRating: cr, slopeRating: slope, PCC: 0 }) : null;
    }).filter(function(x){ return typeof x === 'number' && !isNaN(x); });
    if (!diffs.length) return null;
    var chronological = diffs.reverse(); // newest last
    return window.WHS ? WHS.hiFromDifferentials(chronological, {}) : null;
  }catch(e){ return null; }
};})();</script><script>(function(){
if (window.__mcp_back_min_v3) return; window.__mcp_back_min_v3 = true;
function ready(fn){ if (document.readyState==='complete') return setTimeout(fn,0); window.addEventListener('load', fn, {once:true}); }
ready(function(){
  function txt(el){ return (el && (el.innerText||el.textContent) || '').replace(/\s+/g,' ').trim().toLowerCase(); }
  function clickDashboard(){
    try{
      var els = [].slice.call(document.querySelectorAll('button,[role="button"],[role="tab"],a'));
      var el = els.find(function(e){return txt(e)==='dashboard';}) || els.find(function(e){return /dashboard/.test(txt(e));});
      if (el){ try{ el.dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true,view:window})); }catch(_){ try{ el.click(); }catch(__){} } }
    }catch(_){}
  }
  function closeOverlay(){
    try{ var o=document.getElementById('mcp_pairings_overlay'); if(o){ o.style.display='none'; o.setAttribute('aria-hidden','true'); } }catch(_){}
    try{ document.documentElement.classList.remove('spa-page-pairings'); }catch(_){}
    try{ if (location.hash==='#soc-pairings') location.hash=''; }catch(_){}
  }
  window.addEventListener('message', function(ev){ var d=ev && ev.data; if (!d || d.type!=='mcp_pairings_back') return; closeOverlay(); clickDashboard(); }, false);
  document.addEventListener('click', function(e){ var b=e.target && e.target.closest ? e.target.closest('#mcp_pairings_back') : null; if (!b) return; e.preventDefault(); closeOverlay(); clickDashboard(); }, false);
});})();</script><script>(function(){
if (window.MyCaddyLine) return;
var LSKEY = 'mcp.line.userId';
var endpoint = 'http://localhost:3000/notify-line';
function getUserId(){ try{ return localStorage.getItem(LSKEY) || ''; }catch(_){ return ''; } }
function setUserId(id){ try{ localStorage.setItem(LSKEY, id||''); }catch(_){ } }
function configure(cfg){ if (cfg && cfg.endpoint) endpoint = cfg.endpoint; }
function send(to, text, url){
  if (!to || !text) return;
  try{
    fetch(endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ to: to, text: text, url: url||'' }) })
      .catch(function(){});
  }catch(_){}
}
function formatOfferMsg(of){
  var evt = of && (of.eventName || of.eventTitle || of.societyEventName || (of.event && (of.event.name||of.event.title)) || of.societyName);
  var crs = of && of.courseName ? (' @ '+of.courseName) : '';
  var tt  = of && of.teeTimeLocal ? (' '+of.teeTimeLocal) : '';
  var hdr = evt ? ('['+evt+']') : 'Offer';
  var c   = of && (of.caddyName || of.cid) ? (of.caddyName || of.cid) : 'Caddy';
  var t   = of && of.slot ? of.slot : (new Date()).toLocaleString();
  return hdr+crs+tt+'
Caddy: '+c+'
Slot: '+t+'
Accept within 15 min';
}
function sendOffer(of){
  var uid = getUserId(); if (!uid) return;
  var msg = formatOfferMsg(of||{});
  var link = of && of.deepLink ? of.deepLink : '';
  send(uid, msg, link);
}
window.MyCaddyLine = { getUserId:getUserId, setUserId:setUserId, configure:configure, send:send, sendOffer:sendOffer };

// Monkey-patch CW.Offers if present (non-destructive)
function tryPatch(){
  if (!window.CW || !CW.Offers) return false;
  if (!CW.Offers.__origCreate){
    CW.Offers.__origCreate = CW.Offers.create;
    CW.Offers.create = function(slot, gid, ttlMs){
      var of = CW.Offers.__origCreate.apply(this, arguments);
      try{
        // pull context from Bookings if available
        var last = (window.CW && CW.Bookings && CW.Bookings.get && CW.Bookings.get(slot)) || null;
        if (last){
          if (!of.cid && last.cid) of.cid = last.cid;
          if (!of.caddyName && last.caddyName) of.caddyName = last.caddyName;
          var evt = last.eventName || (last.event && (last.event.name || last.event.title)) || last.societyEventName || last.societyName;
          if (evt && !of.eventName) of.eventName = evt;
          if (!of.courseName && (last.courseName || (last.course && last.course.name))) of.courseName = last.courseName || (last.course && last.course.name);
          if (!of.teeTimeLocal && (last.teeTimeLocal || last.teeTime)) of.teeTimeLocal = last.teeTimeLocal || last.teeTime;
          if (!of.deepLink && last.deepLink) of.deepLink = last.deepLink;
        }
      }catch(_){}
      // try from Events namespace if exposed
      try{
        if (!of.eventName && window.CW && CW.Events){
          var ev = (CW.Events.bySlot && CW.Events.bySlot(slot)) || (CW.Events.get && CW.Events.get(slot));
          if (ev && (ev.name || ev.title)) of.eventName = ev.name || ev.title;
        }
      }catch(_){}
      try{ window.MyCaddyLine && MyCaddyLine.sendOffer(of); }catch(_){}
      return of;
    };
  }
  if (!CW.__origAccept){
    CW.__origAccept = CW.acceptOffer;
    CW.acceptOffer = function(slot, gid){
      var ok = CW.__origAccept.apply(this, arguments);
      try{
        var uid = MyCaddyLine.getUserId();
        if (uid && ok){ MyCaddyLine.send(uid, 'Offer accepted for slot '+slot, ''); }
      }catch(_){}
      return ok;
    };
  }
  if (!CW.__origPass){
    CW.__origPass = CW.passOffer;
    CW.passOffer = function(slot, gid){
      var ok = CW.__origPass.apply(this, arguments);
      try{
        var uid = MyCaddyLine.getUserId();
        if (uid && ok){ MyCaddyLine.send(uid, 'Offer passed for slot '+slot, ''); }
      }catch(_){}
      return ok;
    };
  }
  return true;
}
if (document.readyState==='complete') { tryPatch(); } else { window.addEventListener('load', tryPatch, {once:true}); }
})();</script>
<style>
  #mcp_line_btn { position: fixed; right: 16px; bottom: 16px; padding: 8px 12px; border-radius: 999px; background:#16a34a; color:#fff; font-weight:600; font-size:12px; box-shadow:0 4px 12px rgba(0,0,0,.15); z-index: 99999; cursor:pointer; }
  #mcp_line_btn:hover { filter: brightness(0.95); }
  #mcp_line_modal_backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:99998; }
  #mcp_line_modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:99999; }
  #mcp_line_modal .card { width:min(520px, 92vw); background:#fff; border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
  #mcp_line_modal h3 { margin:0 0 8px 0; font-size:16px; }
  #mcp_line_modal label { display:block; font-size:12px; color:#374151; margin-top:12px; }
  #mcp_line_modal input { width:100%; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; font-size:13px; }
  #mcp_line_modal .row { display:flex; gap:8px; margin-top:12px; }
  #mcp_line_modal .row > button { flex:1; padding:10px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#f9fafb; cursor:pointer; font-weight:600; }
  #mcp_line_modal .row > button.primary { background:#111827; color:#fff; border-color:#111827; }
</style>
<div id="mcp_line_btn" title="LINE setup">LINE</div>
<div id="mcp_line_modal_backdrop"></div>
<div id="mcp_line_modal">
<div class="card">
<h3>LINE Notifications</h3>
<p style="margin:0 0 8px 0; font-size:12px; color:#4b5563;">Set your LINE adapter endpoint and your LINE userId (from the adapter log). This stays on this device only.</p>
<label>Endpoint</label>
<input id="mcp_line_endpoint" placeholder="https://&lt;ngrok&gt;.ngrok.io/notify-line" type="text"/>
<label style="margin-top:8px;">LINE User ID</label>
<input id="mcp_line_userid" placeholder="Uxxxxxxxxxxxxxxxxxxxxxxxx" type="text"/>
<div class="row">
<button id="mcp_line_test">Send test</button>
<span id="mcp_line_status" style="align-self:center; font-size:12px; color:#374151;"></span>
<button class="primary" id="mcp_line_save">Save</button>
<button id="mcp_line_close">Close</button>
</div>
</div>
</div>
<script>(function(){
  if (window.__mcp_line_ui_v1) return; window.__mcp_line_ui_v1 = true;
  function $id(id){ return document.getElementById(id); }
  var btn = $id('mcp_line_btn'), modal = $id('mcp_line_modal'), back = $id('mcp_line_modal_backdrop');
  var inpE = $id('mcp_line_endpoint'), inpU = $id('mcp_line_userid');
  function open(){
    try{
      inpE.value = localStorage.getItem('mcp.line.endpoint') || 'http://localhost:3000/notify-line';
      inpU.value = localStorage.getItem('mcp.line.userId') || '';
    }catch(_){}
    modal.style.display = 'flex'; back.style.display = 'block';
  }
  function close(){ modal.style.display = 'none'; back.style.display = 'none'; }
  btn.addEventListener('click', open);
  $id('mcp_line_close').addEventListener('click', close);
  $id('mcp_line_save').addEventListener('click', function(){
    try{
      var ep = (inpE.value||'').trim();
      var uid = (inpU.value||'').trim();
      if (ep) { localStorage.setItem('mcp.line.endpoint', ep); if (window.MyCaddyLine) MyCaddyLine.configure({ endpoint: ep }); }
      if (uid) { localStorage.setItem('mcp.line.userId', uid); if (window.MyCaddyLine) MyCaddyLine.setUserId(uid); }
      btn.textContent = 'LINE ✓';
    }catch(_){}
    close();
  });
  
  $id('mcp_line_test').addEventListener('click', function(){
    var ep = (inpE.value||'').trim();
    var uid = (inpU.value||'').trim();
    var st = document.getElementById('mcp_line_status');
    function setStatus(msg, ok){
      if (!st) return;
      st.textContent = msg;
      st.style.color = ok ? '#065f46' : '#b91c1c';
    }
    if (!ep || !uid){
      setStatus('Enter endpoint and userId first', false);
      return;
    }
    try{
      if (window.MyCaddyLine){ MyCaddyLine.configure({ endpoint: ep }); MyCaddyLine.setUserId(uid); }
      setStatus('Sending…', true);
      fetch(ep, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to: uid, text: 'Test from MyCaddy Pro', url: '' })
      }).then(function(res){
        if (res && res.ok){ setStatus('Sent ✔', true); }
        else { setStatus('Failed: ' + (res && res.status), false); }
      }).catch(function(err){
        setStatus('Blocked or unreachable (CORS?)', false);
      });
    }catch(e){
      setStatus('Error: ' + (e && e.message || e), false);
    }
  });
if (uid && window.MyCaddyLine){ MyCaddyLine.setUserId(uid); MyCaddyLine.send(uid, 'Test from MyCaddy Pro', ''); }
  });
  // Hide the floating button if already configured
  try{
    var have = localStorage.getItem('mcp.line.userId');
    if (have) btn.textContent = 'LINE ✓';
  }catch(_){}
  // Expose programmatic open
  window.openLineSettings = open;
})();</script>
<script>
// Self-cleaner: if the schedule widget ends up inside the "Schedule Golf Round" overlay, remove it immediately.
(function(){
  try{
    var runs = 0;
    var it = setInterval(function(){
      runs++;
      try{
        // Detect visible Schedule modal overlay
        var marker = Array.from(document.querySelectorAll('*')).find(function(el){
          try{
            if(!el || !el.textContent) return false;
            if(!/Schedule\s+Golf\s+Round/i.test(el.textContent)) return false;
            var anc = el.closest('[role="dialog"],[aria-modal="true"],.modal,[data-modal],[class*="fixed"],[class*="inset-0"],[class*="z-50"],[class*="backdrop"]');
            if (!anc){
              var p = el;
              while(p && p!==document.body){
                var cs = window.getComputedStyle(p); if (cs && cs.position==='fixed'){ anc = p; break; }
                p = p.parentElement;
              }
            }
            if (!anc) return false;
            var cs2 = window.getComputedStyle(anc);
            if (cs2 && (cs2.display==='none' || cs2.visibility==='hidden' || Number(cs2.opacity||'1')===0)) return false;
            var r = anc.getBoundingClientRect(); if (!r || r.width<10 || r.height<10) return false;
            return true;
          }catch(_){ return false; }
        });
        if (marker){
          var bad = document.getElementById('mc-schedule-widgets');
          if (bad && marker && bad.closest('*')){
            // If the widget is inside any fixed/dialog ancestor, remove it
            var host = bad.closest('[role="dialog"],[aria-modal="true"],.modal,[data-modal],[class*="fixed"],[class*="inset-0"],[class*="z-50"],[class*="backdrop"]');
            if (host){
              bad.remove();
            }
          }
        }
      }catch(_){}
      if (runs>30) clearInterval(it); // stop after ~15s
    }, 500);
  }catch(_){}
})();
</script>
<!-- Embedded GM Tee Sheet (self-contained) -->
<style id="abcv11-css">
#abcv11{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:#111827}
#abcv11 .wrap{max-width:1280px;margin:0 auto}
#abcv11 h1{margin:0;font-size:18px}
#abcv11 .sub{color:#6b7280;font-size:12px;margin:4px 0 10px}
#abcv11 label{font-size:12px;color:#6b7280}
#abcv11 input,#abcv11 select,#abcv11 textarea{border:1px solid rgba(0,0,0,.12);border-radius:10px;padding:7px 9px;background:#fff;color:#111827;outline:none}
#abcv11 button{border:1px solid rgba(0,0,0,.12);background:#f3f4f6;border-radius:10px;padding:8px 10px;cursor:pointer}
#abcv11 button:hover{background:#eef2ff}
#abcv11 .btn-primary{background:#2563eb;color:#fff;border-color:#1d4ed8}
#abcv11 .iconbtn{width:34px;height:34px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center}
#abcv11 .legend{display:flex;gap:8px;align-items:center;font-size:12px;color:#6b7280;margin-top:6px}
#abcv11 .legend span{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:4px}
#abcv11 .lgA{background:#84cc16}#abcv11 .lgB{background:#38bdf8}#abcv11 .lgC{background:#f59e0b}#abcv11 .lgD{background:#a78bfa}
#abcv11 .card{background:#fff;border:1px solid rgba(0,0,0,.12);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:12px}
#abcv11 .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
#abcv11 .grow{flex:1 1 260px}
#abcv11 .right{margin-left:auto}
#abcv11 .tee-grid{display:grid;grid-template-columns:90px repeat(var(--cols), minmax(140px,1fr));gap:6px}
#abcv11 .tee-header{position:sticky;top:0;background:#f9fafb;z-index:5;border-bottom:1px solid rgba(0,0,0,.12)}
#abcv11 .time-cell{position:sticky;left:0;background:#f9fafb;border:1px dashed rgba(0,0,0,.12);border-radius:10px;padding:6px;text-align:center;font-size:12px;z-index:3}
#abcv11 .col-title{padding:8px 6px;text-align:center;border:1px solid rgba(0,0,0,.12);border-radius:10px;background:#fff;font-size:12px}
#abcv11 .group-title{padding:8px 6px;text-align:center;border:1px solid rgba(0,0,0,.12);border-radius:10px;background:#eef2ff;font-weight:700;letter-spacing:.2px;font-size:12px}
#abcv11 .slot{border:1px dashed rgba(0,0,0,.12);border-radius:10px;min-height:40px;position:relative;background:#fff}
#abcv11 .slot.group-boundary{border-left:2px solid rgba(0,0,0,.28)}
#abcv11 .slot:hover{background:#f8fafc}
#abcv11 .pill{display:block;background:#dcfce7;color:#064e3b;border:1px solid #86efac;border-radius:10px;padding:5px 6px;margin:3px;font-size:12px;cursor:grab;line-height:1.2}
#abcv11 .mono{font-variant-numeric:tabular-nums}
#abcv11 .tag{padding:4px 8px;border:1px solid rgba(0,0,0,.12);border-radius:999px;font-size:12px;color:#6b7280}
</style>
<script>(function(){ var _code = "\n(function(){\n  \"use strict\";\n  function pad2(n){ n=String(n); return n.length<2?(\"0\"+n):n; }\n  function minutes(hm){ var a=(hm||\"\").split(\":\").map(Number); return a[0]*60 + a[1]; }\n  function hhmm(m){ return pad2(Math.floor(m/60))+\":\"+pad2(m%60); }\n  function todayISO(){ var d=new Date(); return d.getFullYear()+\"-\"+pad2(d.getMonth()+1)+\"-\"+pad2(d.getDate()); }\n  function parseISO(s){ var a=(s||\"\").split(\"-\").map(Number); return new Date(a[0]||NaN,(a[1]||1)-1,a[2]||NaN); }\n  function genId(){ try{ return (crypto.getRandomValues(new Uint32Array(1))[0].toString(16)+Date.now().toString(16)); }catch(_){ return (Math.floor(Math.random()*1e9).toString(16)+Date.now().toString(16)); } }\n\n  function mount(){\n    var h2 = Array.from(document.querySelectorAll('h2')).find(function(n){ return /Today's Tee Sheet/i.test(n.textContent||''); });\n    if(!h2) return false;\n    var container=h2.closest('div');\n    var prev=container && container.previousElementSibling;\n    if(prev && /Override Assignment/i.test(prev.textContent||'')) prev.style.display='none';\n    var after=container && container.nextElementSibling;\n    if(after && (/Search/i.test(after.textContent||'') && after.querySelector('input'))) after.style.display='none';\n    var table=container && container.parentElement.querySelector('table.w-full');\n    var box=table && table.closest('div');\n    if(box) box.style.display='none';\n\n    if(document.getElementById('abcv11')) return true;\n    var host=document.createElement('section'); host.innerHTML = "\n<div id=\"abcv11\" class=\"wrap\">\n  <h1>Tee Sheet</h1>\n  <div class=\"sub\">A\u2192D straight across \u2022 18/27/36 hole complexes \u2022 1\u20132 tees per course \u2022 5/7/10/15 min intervals</div>\n\n  <div class=\"card\">\n    <div class=\"row\">\n      <div>\n        <label>Complex</label><br>\n        <select id=\"v11-complex\">\n          <option value=\"18\">18 holes (A/B)</option>\n          <option value=\"27\" selected>27 holes (A/B/C)</option>\n          <option value=\"36\">36 holes (A/B/C/D)</option>\n        </select>\n      </div>\n      <div>\n        <label>Date</label><br>\n        <div class=\"row\" style=\"gap:6px\">\n          <button id=\"v11-prevDay\" class=\"iconbtn\" title=\"Previous day\">\u2039</button>\n          <input type=\"date\" id=\"v11-date\">\n          <button id=\"v11-nextDay\" class=\"iconbtn\" title=\"Next day\">\u203a</button>\n          <button id=\"v11-openMonth\" class=\"iconbtn\" title=\"Open month picker\">\ud83d\udcc5</button>\n        </div>\n      </div>\n      <div><label>Start</label><br><input type=\"time\" id=\"v11-start\" value=\"06:00\"></div>\n      <div><label>End</label><br><input type=\"time\" id=\"v11-end\" value=\"18:00\"></div>\n      <div><label>Interval</label><br>\n        <select id=\"v11-interval\">\n          <option value=\"5\" selected>5 min</option>\n          <option value=\"7\">7 min</option>\n          <option value=\"10\">10 min</option>\n          <option value=\"15\">15 min</option>\n        </select>\n      </div>\n      <div><label>Tees per Course</label><br>\n        <select id=\"v11-teesPerCourse\">\n          <option value=\"1\" selected>1</option>\n          <option value=\"2\">2</option>\n        </select>\n      </div>\n      <div class=\"tag\">Total Tees: <span id=\"v11-totalTeesTag\">3</span></div>\n      <div class=\"right\"><button id=\"v11-clearDay\">Clear Day</button></div>\n      <div class=\"grow\">\n        <label>Golfer Name</label><br>\n        <input id=\"v11-searchQuery\" placeholder=\"Type golfer name or caddy number\" style=\"width:100%\">\n        <div style=\"font-size:12px;color:#6b7280\">Press Enter to find; Next to jump to the following match.</div>\n      </div>\n      <div style=\"align-self:end\"><label>&nbsp;</label><br><button id=\"v11-searchGo\" class=\"btn-primary\">Find</button></div>\n      <div style=\"align-self:end\"><label>&nbsp;</label><br><button id=\"v11-searchNext\">Next</button></div>\n      <div class=\"tag\" style=\"align-self:end\">Matches: <span id=\"v11-matchCount\">0</span></div>\n    </div>\n\n    <div class=\"legend\">\n      <div><span class=\"lgA\"></span>Course A</div>\n      <div><span class=\"lgB\"></span>Course B</div>\n      <div id=\"v11-legC\"><span class=\"lgC\"></span>Course C</div>\n      <div id=\"v11-legD\" style=\"display:none\"><span class=\"lgD\"></span>Course D</div>\n    </div>\n  </div>\n\n  <div class=\"card\" style=\"margin-top:10px\">\n    <div id=\"v11-sheet\"></div>\n  </div>\n</div>\n\n<dialog id=\"v11-bookingDialog\">\n  <form method=\"dialog\" id=\"v11-bookingForm\">\n    <div class=\"m-head\">\n      <div style=\"font-weight:800\">Book Slot(s)</div>\n      <button id=\"v11-closeDialog\" type=\"button\" class=\"iconbtn\" title=\"Close\">\u2715</button>\n    </div>\n    <div class=\"m-body\">\n      <input type=\"hidden\" id=\"v11-bkId\">\n      <div class=\"row\">\n        <div class=\"grow\"><label>Golfer Name</label><br><input id=\"v11-bkName\" placeholder=\"Golfer name\"></div>\n        <div><label>Caddy Number</label><br><input id=\"v11-bkCaddy\" placeholder=\"e.g., 27\"></div>\n        <div><label>Member ID</label><br><input id=\"v11-bkMid\" placeholder=\"e.g., 004\"></div>\n        <div><label>Course</label><br><input id=\"v11-bkCourse\" readonly style=\"width:84px\"></div>\n        <div><label>Tee #</label><br>\n          <select id=\"v11-bkTeeNo\"><option value=\"1\">1</option><option value=\"2\">2</option></select>\n        </div>\n      </div>\n      <div class=\"row\" style=\"margin-top:6px\">\n        <div><label>From</label><br><input type=\"time\" id=\"v11-bkFrom\" class=\"mono\"></div>\n        <div><label>To</label><br><input type=\"time\" id=\"v11-bkTo\" class=\"mono\"></div>\n        <div style=\"align-self:end\"><label>&nbsp;</label><br><label style=\"font-size:12px;color:#374151\"><input type=\"checkbox\" id=\"v11-bkApplyAll\"> Apply details to all slots in range</label></div>\n      </div>\n      <div style=\"font-size:12px;color:#6b7280;margin-top:4px\">Range aligns to the interval and clamped to Start/End.</div>\n      <div style=\"margin-top:8px\"><label>Notes</label><br><textarea id=\"v11-bkNotes\" rows=\"3\" style=\"width:100%\"></textarea></div>\n    </div>\n    <div class=\"m-foot\">\n      <button id=\"v11-deleteBooking\" type=\"button\" style=\"background:#fff;border:1px solid #ef4444;color:#ef4444;border-radius:10px;padding:8px 12px;display:none\">Delete</button>\n      <button id=\"v11-saveBooking\" class=\"btn-primary\" value=\"default\">Save</button>\n    </div>\n  </form>\n</dialog>\n\n<dialog id=\"v11-monthPicker\">\n  <div class=\"mp-head\">\n    <button id=\"v11-mpPrev\" class=\"iconbtn\">\u2039</button>\n    <div>\n      <select id=\"v11-mpMonth\"></select>\n      <select id=\"v11-mpYear\"></select>\n    </div>\n    <button id=\"v11-mpNext\" class=\"iconbtn\">\u203a</button>\n  </div>\n  <div class=\"mp-grid\" id=\"v11-mpGrid\">\n    <div class=\"mp-dow\">Sun</div><div class=\"mp-dow\">Mon</div><div class=\"mp-dow\">Tue</div><div class=\"mp-dow\">Wed</div><div class=\"mp-dow\">Thu</div><div class=\"mp-dow\">Fri</div><div class=\"mp-dow\">Sat</div>\n  </div>\n</dialog>\n";\n    (container.parentElement||document.body).insertBefore(host, box || (table?table.nextSibling:null));\n    // style\n    if(!document.getElementById('abcv11-css')){ var st=document.createElement('style'); st.id='abcv11-css'; st.textContent="\n#abcv11{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:#111827}\n#abcv11 .wrap{max-width:1280px;margin:0 auto}\n#abcv11 h1{margin:0;font-size:18px}\n#abcv11 .sub{color:#6b7280;font-size:12px;margin:4px 0 10px}\n#abcv11 label{font-size:12px;color:#6b7280}\n#abcv11 input,#abcv11 select,#abcv11 textarea{border:1px solid rgba(0,0,0,.12);border-radius:10px;padding:7px 9px;background:#fff;color:#111827;outline:none}\n#abcv11 button{border:1px solid rgba(0,0,0,.12);background:#f3f4f6;border-radius:10px;padding:8px 10px;cursor:pointer}\n#abcv11 button:hover{background:#eef2ff}\n#abcv11 .btn-primary{background:#2563eb;color:#fff;border-color:#1d4ed8}\n#abcv11 .iconbtn{width:34px;height:34px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center}\n#abcv11 .legend{display:flex;gap:8px;align-items:center;font-size:12px;color:#6b7280;margin-top:6px}\n#abcv11 .legend span{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:4px}\n#abcv11 .lgA{background:#84cc16}#abcv11 .lgB{background:#38bdf8}#abcv11 .lgC{background:#f59e0b}#abcv11 .lgD{background:#a78bfa}\n#abcv11 .card{background:#fff;border:1px solid rgba(0,0,0,.12);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:12px}\n#abcv11 .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}\n#abcv11 .grow{flex:1 1 260px}\n#abcv11 .right{margin-left:auto}\n#abcv11 .tee-grid{display:grid;grid-template-columns:90px repeat(var(--cols), minmax(140px,1fr));gap:6px}\n#abcv11 .tee-header{position:sticky;top:0;background:#f9fafb;z-index:5;border-bottom:1px solid rgba(0,0,0,.12)}\n#abcv11 .time-cell{position:sticky;left:0;background:#f9fafb;border:1px dashed rgba(0,0,0,.12);border-radius:10px;padding:6px;text-align:center;font-size:12px;z-index:3}\n#abcv11 .col-title{padding:8px 6px;text-align:center;border:1px solid rgba(0,0,0,.12);border-radius:10px;background:#fff;font-size:12px}\n#abcv11 .group-title{padding:8px 6px;text-align:center;border:1px solid rgba(0,0,0,.12);border-radius:10px;background:#eef2ff;font-weight:700;letter-spacing:.2px;font-size:12px}\n#abcv11 .slot{border:1px dashed rgba(0,0,0,.12);border-radius:10px;min-height:40px;position:relative;background:#fff}\n#abcv11 .slot.group-boundary{border-left:2px solid rgba(0,0,0,.28)}\n#abcv11 .slot:hover{background:#f8fafc}\n#abcv11 .pill{display:block;background:#dcfce7;color:#064e3b;border:1px solid #86efac;border-radius:10px;padding:5px 6px;margin:3px;font-size:12px;cursor:grab;line-height:1.2}\n#abcv11 .mono{font-variant-numeric:tabular-nums}\n#abcv11 .tag{padding:4px 8px;border:1px solid rgba(0,0,0,.12);border-radius:999px;font-size:12px;color:#6b7280}\n"; document.head.appendChild(st); }\n\n    // wire up\n    var $=function(id){ return document.getElementById(id); };\n    var el = {\n      complex: $(\"v11-complex\"), date: $(\"v11-date\"), prev: $(\"v11-prevDay\"), next: $(\"v11-nextDay\"), openMonth: $(\"v11-openMonth\"),\n      start: $(\"v11-start\"), end: $(\"v11-end\"), interval: $(\"v11-interval\"), tees: $(\"v11-teesPerCourse\"),\n      total: $(\"v11-totalTeesTag\"), sheet: $(\"v11-sheet\"), legC: $(\"v11-legC\"), legD: $(\"v11-legD\"),\n      clear: $(\"v11-clearDay\"),\n      dlg: $(\"v11-bookingDialog\"), id: $(\"v11-bkId\"), name: $(\"v11-bkName\"), caddy: $(\"v11-bkCaddy\"), mid: $(\"v11-bkMid\"),\n      course: $(\"v11-bkCourse\"), teeNo: $(\"v11-bkTeeNo\"), from: $(\"v11-bkFrom\"), to: $(\"v11-bkTo\"), apply: $(\"v11-bkApplyAll\"), notes: $(\"v11-bkNotes\"),\n      delBtn: $(\"v11-deleteBooking\"), saveBtn: $(\"v11-saveBooking\"), closeBtn: $(\"v11-closeDialog\"),\n      mp: $(\"v11-monthPicker\"), mpPrev: $(\"v11-mpPrev\"), mpNext: $(\"v11-mpNext\"), mpM: $(\"v11-mpMonth\"), mpY: $(\"v11-mpYear\"), mpGrid: $(\"v11-mpGrid\"),\n      q: $(\"v11-searchQuery\"), qGo: $(\"v11-searchGo\"), qNext: $(\"v11-searchNext\"), qCount: $(\"v11-matchCount\")\n    };\n\n    var keyDay = function(d){ return \"mctsheet.bookings.v12::\"+d; };\n    var keySettings = \"mctsheet.settings.v12\";\n    function getDay(d){ try{ return JSON.parse(localStorage.getItem(keyDay(d)) || \"[]\"); }catch(_){ return []; } }\n    function setDay(d,a){ localStorage.setItem(keyDay(d), JSON.stringify(a||[])); }\n\n    if(!el.date.value) el.date.value = todayISO();\n    try{ var s=JSON.parse(localStorage.getItem(keySettings)||\"{}\"); [\"complex\",\"start\",\"end\",\"interval\",\"tees\",\"date\"].forEach(function(k){ if(s[k]) el[k].value=s[k]; }); }catch(_){}\n    function saveSettings(){ var s={complex:el.complex.value,start:el.start.value,end:el.end.value,interval:el.interval.value,tees:el.tees.value,date:el.date.value}; localStorage.setItem(keySettings, JSON.stringify(s)); }\n\n    function groups(){ var t=el.complex.value; if(t===\"18\") return [\"A\",\"B\"]; if(t===\"27\") return [\"A\",\"B\",\"C\"]; return [\"A\",\"B\",\"C\",\"D\"]; }\n    function layout(){ var gs=groups(); var per=Math.max(1, Math.min(2, parseInt(el.tees.value||\"1\",10))); var cols=[]; gs.forEach(function(g){ for(var i=0;i<per;i++) cols.push(g); }); return {gs:gs, per:per, cols:cols, total:cols.length}; }\n\n    function render(){\n      saveSettings();\n      var L=layout();\n      el.total.textContent=L.total;\n      el.legC.style.display=L.gs.indexOf(\"C\")>=0?\"\":\"none\";\n      el.legD.style.display=L.gs.indexOf(\"D\")>=0?\"\":\"none\";\n      el.sheet.style.setProperty(\"--cols\", L.total);\n      el.sheet.innerHTML=\"\";\n\n      var header=document.createElement(\"div\"); header.className=\"tee-grid tee-header\"; header.appendChild(document.createElement(\"div\"));\n      var within={A:0,B:0,C:0,D:0};\n      L.cols.forEach(function(g){ within[g]++; var h=document.createElement(\"div\"); h.className=\"col-title\"; h.textContent=g+\"-\"+within[g]; header.appendChild(h); });\n      el.sheet.appendChild(header);\n\n      var ghead=document.createElement(\"div\"); ghead.className=\"tee-grid\"; ghead.appendChild(document.createElement(\"div\"));\n      L.gs.forEach(function(g){ var cell=document.createElement(\"div\"); cell.className=\"group-title\"; cell.textContent=\"Course \"+g; if(g===\"A\") cell.style.background=\"#d9f99d\"; if(g===\"B\") cell.style.background=\"#bae6fd\"; if(g===\"C\") cell.style.background=\"#fde68a\"; if(g===\"D\") cell.style.background=\"#ddd6fe\"; cell.style.gridColumn=\"span \"+L.per; ghead.appendChild(cell); });\n      el.sheet.appendChild(ghead);\n\n      var startM=minutes(el.start.value), endM=minutes(el.end.value), step=+el.interval.value;\n      var day=getDay(el.date.value);\n      for(var m=startM;m<=endM;m+=step){\n        var row=document.createElement(\"div\"); row.className=\"tee-grid\";\n        var label=hhmm(m);\n        var tCell=document.createElement(\"div\"); tCell.className=\"time-cell mono\"; tCell.textContent=label; row.appendChild(tCell);\n        var count={A:0,B:0,C:0,D:0};\n        L.cols.forEach(function(g, idx){\n          count[g]++;\n          var slot=document.createElement(\"div\"); slot.className=\"slot\"+(count[g]===1?\" group-boundary\":\"\"); slot.dataset.group=g; slot.dataset.tee=count[g]; slot.dataset.time=label; slot.dataset.col=String(idx);\n          day.filter(function(b){ return b.time===slot.dataset.time && b.col===idx; }).forEach(function(b){ slot.appendChild(pill(b)); });\n          slot.addEventListener(\"click\", function(e){ if(e.target.closest(\".pill\")) return; openDlg({ id:\"\", name:\"\", caddyNumber:\"\", mid:\"\", course: slot.dataset.group, tee: parseInt(slot.dataset.tee,10)||1, time: slot.dataset.time, col: parseInt(slot.dataset.col,10)||0, notes:\"\" }); });\n          slot.addEventListener(\"dragover\", function(e){ e.preventDefault(); });\n          slot.addEventListener(\"drop\", function(e){ e.preventDefault(); var id=e.dataTransfer.getData(\"text/id\"); if(!id) return; var data=getDay(el.date.value); var i=data.findIndex(function(x){ return x.id===id; }); if(i<0) return; data[i].time=slot.dataset.time; data[i].col=parseInt(slot.dataset.col,10)||0; data[i].course=slot.dataset.group; data[i].tee=parseInt(slot.dataset.tee,10)||1; setDay(el.date.value, data); render(); });\n          row.appendChild(slot);\n        });\n        el.sheet.appendChild(row);\n      }\n      computeMatches(el.q.value||\"\");\n    }\n\n    function pill(b){\n      var p=document.createElement(\"div\"); p.className=\"pill\"; p.draggable=true; p.dataset.id=b.id;\n      var caddy=b.caddyNumber?(\" \u2022 Caddy \"+b.caddyNumber):\"\";\n      p.innerHTML=\"<strong>\"+(b.name||\"Player\")+\"</strong><br><span style='font-size:11px'>ID: \"+(b.mid||\"\u2014\")+caddy+\" \u2022 \"+b.course+\"-\"+(b.tee||1)+\" \u2022 \"+b.time+\"</span>\";\n      p.addEventListener(\"dragstart\", function(e){ e.dataTransfer.setData(\"text/id\", b.id); });\n      p.addEventListener(\"click\", function(e){ openDlg(b); e.stopPropagation(); });\n      return p;\n    }\n\n    function openDlg(seed){\n      el.id.value=seed.id||\"\"; el.name.value=seed.name||\"\"; el.caddy.value=seed.caddyNumber||\"\"; el.mid.value=seed.mid||\"\"; el.course.value=seed.course||\"A\"; el.teeNo.value=String(seed.tee||1); el.from.value=seed.time||\"\"; el.to.value=seed.time||\"\"; el.apply.checked=false; el.notes.value=seed.notes||\"\"; el.delBtn.style.display=seed.id?\"\":\"\";\n      if(document.getElementById(\"v11-bookingDialog\").showModal) document.getElementById(\"v11-bookingDialog\").showModal(); else document.getElementById(\"v11-bookingDialog\").setAttribute(\"open\",\"\");\n    }\n    function closeDlg(){ var d=document.getElementById(\"v11-bookingDialog\"); if(d.close) d.close(); else d.removeAttribute(\"open\"); }\n    document.getElementById(\"v11-closeDialog\").addEventListener(\"click\", closeDlg);\n\n    function aligned(from,to,step,start,end){\n      function mins(hm){ var a=hm.split(\":\").map(Number); return a[0]*60+a[1]; }\n      function tohm(min){ return pad2(Math.floor(min/60))+\":\"+pad2(min%60); }\n      var a=mins(from||\"\"), b=mins(to||\"\"); if(isNaN(a)||isNaN(b)) return [];\n      if(b<a){ var t=a;a=b;b=t; }\n      var s=mins(start), e=mins(end); a=Math.max(a,s); b=Math.min(b,e); if(b<a) return [];\n      var off=(a-s)%step; if(off!==0) a+=(step-off);\n      var out=[]; for(var m=a;m<=b;m+=step) out.push(tohm(m)); return out;\n    }\n\n    document.getElementById(\"v11-saveBooking\").addEventListener(\"click\", function(e){\n      e.preventDefault();\n      var date = el.date.value || todayISO();\n      var arr = getDay(date);\n      var L = layout();\n      var course = el.course.value;\n      var tee = Math.max(1, Math.min(2, parseInt(el.teeNo.value||\"1\",10)));\n      var applyAll = !!el.apply.checked;\n      var step = +el.interval.value;\n      var times = aligned(el.from.value, el.to.value, step, el.start.value, el.end.value);\n      if(!times.length){ alert(\"Selected range has no times on this sheet.\"); return; }\n\n      var colIndex=0,count={A:0,B:0,C:0,D:0};\n      for(var i=0;i<L.cols.length;i++){ var g=L.cols[i]; count[g]++; if(g===course && count[g]===tee){ colIndex=i; break; } }\n\n      function upsertAt(t, seedId, copy){\n        var idx = arr.findIndex(function(x){ return x.time===t && x.col===colIndex; });\n        var base = { id: seedId || genId(), course:course, tee:tee, time:t, col:colIndex, name:\"\", caddyNumber:\"\", mid:\"\", notes:\"\" };\n        var payload = base; if(copy){ payload = Object.assign({}, base, { name:el.name.value.trim(), caddyNumber:el.caddy.value.trim(), mid:el.mid.value.trim(), notes:el.notes.value.trim() }); }\n        if(idx>=0){ if(copy){ arr[idx] = Object.assign({}, arr[idx], payload, {id:arr[idx].id}); } return arr[idx] && arr[idx].id || payload.id; }\n        else { arr.push(payload); return payload.id; }\n      }\n\n      if(times.length===1){\n        var id = el.id.value || null;\n        var idx = id ? arr.findIndex(function(x){ return x.id===id; }) : -1;\n        if(idx>=0){\n          arr[idx] = Object.assign({}, arr[idx], { name:el.name.value.trim(), caddyNumber:el.caddy.value.trim(), mid:el.mid.value.trim(), course:course, tee:tee, time:times[0], col:colIndex, notes:el.notes.value.trim() });\n        } else {\n          upsertAt(times[0], null, true);\n        }\n      } else {\n        upsertAt(times[0], el.id.value||null, true);\n        for(var j=1;j<times.length;j++) upsertAt(times[j], null, applyAll);\n      }\n\n      setDay(date, arr); closeDlg(); render();\n    });\n\n    document.getElementById(\"v11-deleteBooking\").addEventListener(\"click\", function(){\n      var date = el.date.value || todayISO();\n      var arr = getDay(date).filter(function(x){ return x.id !== el.id.value; });\n      setDay(date, arr); closeDlg(); render();\n    });\n\n    el.prev.addEventListener(\"click\", function(){ var d=parseISO(el.date.value||todayISO()); d.setDate(d.getDate()-1); el.date.value=d.getFullYear()+\"-\"+pad2(d.getMonth()+1)+\"-\"+pad2(d.getDate()); render(); });\n    el.next.addEventListener(\"click\", function(){ var d=parseISO(el.date.value||todayISO()); d.setDate(d.getDate()+1); el.date.value=d.getFullYear()+\"-\"+pad2(d.getMonth()+1)+\"-\"+pad2(d.getDate()); render(); });\n    el.date.addEventListener(\"change\", render);\n    el.complex.addEventListener(\"change\", render);\n    el.interval.addEventListener(\"change\", render);\n    el.start.addEventListener(\"change\", render);\n    el.end.addEventListener(\"change\", render);\n    el.tees.addEventListener(\"change\", render);\n    el.clear.addEventListener(\"click\", function(){ if(!confirm(\"Clear all bookings for \"+el.date.value+\"?\")) return; setDay(el.date.value, []); render(); });\n\n    var monthNames = [\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"];\n    (function buildMonthPicker(){\n      document.getElementById(\"v11-mpMonth\").innerHTML = monthNames.map(function(n,i){ return \"<option value='\"+i+\"'>\"+n+\"</option>\"; }).join(\"\");\n      var base=new Date().getFullYear(), years=[]; for(var y=base-5;y<=base+6;y++) years.push(\"<option value='\"+y+\"'>\"+y+\"</option>\");\n      document.getElementById(\"v11-mpYear\").innerHTML = years.join(\"\");\n    })();\n    function renderMonth(year, month){\n      Array.from(document.getElementById(\"v11-mpGrid\").querySelectorAll(\".mp-day\")).forEach(function(n){ n.remove(); });\n      var first=new Date(year, month, 1), firstDow=first.getDay(), days=new Date(year, month+1, 0).getDate(), prevDays=new Date(year, month, 0).getDate();\n      var t=new Date(); var today=t.getFullYear()+\"-\"+pad2(t.getMonth()+1)+\"-\"+pad2(t.getDate());\n      for(var i=0;i<42;i++){\n        var cell=document.createElement(\"div\"); cell.className=\"mp-day\";\n        var iso, muted=false;\n        if(i<firstDow){ var d=new Date(year, month-1, prevDays - firstDow + 1 + i); iso=d.getFullYear()+\"-\"+pad2(d.getMonth()+1)+\"-\"+pad2(d.getDate()); muted=true; }\n        else if(i>=firstDow+days){ var d2=new Date(year, month+1, i - (firstDow + days) + 1); iso=d2.getFullYear()+\"-\"+pad2(d2.getMonth()+1)+\"-\"+pad2(d2.getDate()); muted=true; }\n        else { var d3=new Date(year, month, i-firstDow+1); iso=d3.getFullYear()+\"-\"+pad2(d3.getMonth()+1)+\"-\"+pad2(d3.getDate()); }\n        cell.textContent=String(new Date(iso).getDate());\n        if(muted) cell.classList.add(\"muted\");\n        if(iso===today) cell.classList.add(\"today\");\n        (function(finalISO){ cell.addEventListener(\"click\", function(){ el.date.value=finalISO; render(); document.getElementById(\"v11-monthPicker\").close(); }); })(iso);\n        document.getElementById(\"v11-mpGrid\").appendChild(cell);\n      }\n    }\n    document.getElementById(\"v11-openMonth\").addEventListener(\"click\", function(){ var cur=parseISO(el.date.value||todayISO()); document.getElementById(\"v11-mpMonth\").value=String(cur.getMonth()); document.getElementById(\"v11-mpYear\").value=String(cur.getFullYear()); renderMonth(cur.getFullYear(), cur.getMonth()); document.getElementById(\"v11-monthPicker\").showModal(); });\n    document.getElementById(\"v11-mpPrev\").addEventListener(\"click\", function(){ var y=parseInt(document.getElementById(\"v11-mpYear\").value,10), m=parseInt(document.getElementById(\"v11-mpMonth\").value,10); var d=new Date(y, m-1, 1); document.getElementById(\"v11-mpYear\").value=String(d.getFullYear()); document.getElementById(\"v11-mpMonth\").value=String(d.getMonth()); renderMonth(d.getFullYear(), d.getMonth()); });\n    document.getElementById(\"v11-mpNext\").addEventListener(\"click\", function(){ var y=parseInt(document.getElementById(\"v11-mpYear\").value,10), m=parseInt(document.getElementById(\"v11-mpMonth\").value,10); var d=new Date(y, m+1, 1); document.getElementById(\"v11-mpYear\").value=String(d.getFullYear()); document.getElementById(\"v11-mpMonth\").value=String(d.getMonth()); renderMonth(d.getFullYear(), d.getMonth()); });\n    document.getElementById(\"v11-mpMonth\").addEventListener(\"change\", function(){ renderMonth(parseInt(document.getElementById(\"v11-mpYear\").value,10), parseInt(document.getElementById(\"v11-mpMonth\").value,10)); });\n    document.getElementById(\"v11-mpYear\").addEventListener(\"change\", function(){ renderMonth(parseInt(document.getElementById(\"v11-mpYear\").value,10), parseInt(document.getElementById(\"v11-mpMonth\").value,10)); });\n\n    var state={ids:[], idx:0};\n    function computeMatches(q){\n      var data=getDay(el.date.value || todayISO());\n      var needle=(q||\"\").trim().toLowerCase(); if(!needle){ state.ids=[]; state.idx=0; el.qCount.textContent=\"0\"; return; }\n      state.ids = data.filter(function(b){ var name=(b.name||\"\").toLowerCase(); var c=(b.caddyNumber||\"\").toLowerCase(); return name.indexOf(needle)>=0 || c.indexOf(needle)>=0; }).sort(function(a,b){ var da=minutes(a.time||\"00:00\"), db=minutes(b.time||\"00:00\"); if(da!==db) return da-db; return (a.col||0)-(b.col||0); }).map(function(b){ return b.id; });\n      el.qCount.textContent = String(state.ids.length||0);\n    }\n    function jump(id){\n      if(!id) return;\n      var data=getDay(el.date.value || todayISO());\n      var rec=data.find(function(r){ return r.id===id; }); if(!rec) return;\n      var slot=document.querySelector('#abcv11 .slot[data-time=\\\"'+rec.time+'\\\"][data-col=\\\"'+rec.col+'\\\"]');\n      if(!slot) return;\n      slot.style.outline=\"2px solid #10b981\";\n      slot.scrollIntoView({behavior:\"smooth\", block:\"center\", inline:\"center\"});\n      setTimeout(function(){ slot.style.outline=\"\"; }, 1600);\n    }\n    document.getElementById(\"v11-searchGo\").addEventListener(\"click\", function(e){ e.preventDefault(); computeMatches(el.q.value||\"\"); if(state.ids.length){ jump(state.ids[0]); } else { alert(\"No matches on this date.\"); } });\n    document.getElementById(\"v11-searchNext\").addEventListener(\"click\", function(e){ e.preventDefault(); if(!state.ids.length){ document.getElementById(\"v11-searchGo\").click(); return; } state.idx=(state.idx+1)%state.ids.length; jump(state.ids[state.idx]); });\n    document.getElementById(\"v11-searchQuery\").addEventListener(\"keydown\", function(e){ if(e.key===\"Enter\"){ e.preventDefault(); document.getElementById(\"v11-searchGo\").click(); } });\n\n    function renderExpose(){ render(); } // expose to closures\n    renderExpose();\n    return true;\n  }\n\n  function boot(){\n    if(document.readyState!=='loading'){ if(mount()) return; }\n    document.addEventListener('DOMContentLoaded', function(){ mount(); });\n    var mo=new MutationObserver(function(){ mount(); });\n    mo.observe(document.documentElement,{childList:true,subtree:true});\n    var tries=0;(function poll(){ if(mount()||tries++>60) return; setTimeout(poll,250); })();\n  }\n  boot();\n})();\n"; try{ (new Function(_code))(); }catch(e){ console.error('Embed failed:', e); } })();
</script>
<script>
(function(){
  var RX_BLOCK = /\{\s*\/\*[\s\S]*?\*\/\s*\}/g;  // matches {/* ... */}
  var RX_TAIL  = /\*\/\s*\}/g;                   // matches */}
  var RX_HINTS = /(Tab\s*-\s*(Golfer|Caddy|GM|Society))/gi; // common labels if exposed

  function cleanNodeText(node){
    try{
      var val = node.nodeValue;
      if (!val) return;
      var next = val.replace(RX_BLOCK, '').replace(RX_TAIL, '').replace(RX_HINTS, '');
      if (next !== val) node.nodeValue = next;
    }catch(e){}
  }

  function scrubVisible(root){
  if (!root || root.nodeType !== Node.ELEMENT_NODE) return;
  if (root.tagName==='SCRIPT'||root.tagName==='STYLE') return;
    try{
      var walker = document.createTreeWalker(root || document.body, NodeFilter.SHOW_TEXT, null, false);
      var n;
      while ((n = walker.nextNode())){
        if (n.parentElement && n.parentElement.tagName !== 'SCRIPT'){
          cleanNodeText(n);
        }
      }
    }catch(_){}
  }

  // Initial pass
  if (document.readyState !== 'loading') scrubVisible(document.body);
  document.addEventListener('DOMContentLoaded', function(){ scrubVisible(document.body); });

  // Observe future DOM changes
  try{
    var mo = new MutationObserver(function(muts){
      for (var i=0;i<muts.length;i++){
        var m = muts[i];
        if (m.type === 'characterData'){
          var t = m.target;
          if (t && t.parentElement && t.parentElement.tagName !== 'SCRIPT'){
            cleanNodeText(t);
          }
        } else if (m.type === 'childList'){
          m.addedNodes && m.addedNodes.forEach(function(node){
            if (node.nodeType === 3){ // Text
              cleanNodeText(node);
            } else if (node.nodeType === 1){ // Element
              scrubVisible(node);
            }
          });
        }
      }
    });
    mo.observe(document.body, {subtree:true, childList:true, characterData:true});
  }catch(_){}
})();
</script>
<style id="mc-events-ux-v25">
  .mc-note{max-width:100%;white-space:normal;overflow:hidden;overflow-wrap:anywhere;word-break:break-word;line-height:1.25rem;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:3;margin:6px 0;color:#374151;font-size:12px;}
  .mc-join,.mc-waitlist{display:inline-block;border:1px solid transparent;border-radius:10px;padding:6px 10px;font-size:.9rem;line-height:1.1rem;cursor:pointer;margin-left:8px;font-weight:600}
  .mc-join{background:#10b981;border-color:#10b981;color:#fff}
  .mc-waitlist{background:#2563eb;border-color:#2563eb;color:#fff}
  .mc-join[disabled],.mc-waitlist[disabled]{opacity:.6;cursor:default}
</style>
<script>
(function(){
  'use strict';
  if (window.__mcEventsEnhancerV25) return; window.__mcEventsEnhancerV25 = true;

  var JOINED_KEY='ucg.events.joined';
  var WAIT_KEY='ucg.events.waitlist';
  var NOTES_KEY='ucg.events.notes';

  function load(k){ try { return JSON.parse(localStorage.getItem(k)||'{}'); } catch(e){ return {}; } }
  function save(k,v){ try { localStorage.setItem(k, JSON.stringify(v)); } catch(e){} }
  function $all(root, sel){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  function text(el){ return (el && el.textContent || '').trim(); }
  function parseCap(s){ var m=(s||'').match(/(\\d+)\\s*\\/\\s*(\\d+)/); return m?{n:+m[1],cap:+m[2]}:null; }
  function hash(s){ var h=0,i; s=String(s||''); for(i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; } return 'e'+Math.abs(h); }

  function findOpen(el){
    var c=$all(el,'button,a,div,span').filter(function(e){ return /(^|\\s)open(\\s|$)/i.test(text(e)); });
    var exact=c.filter(function(e){ return /^open$/i.test(text(e)); });
    return exact[0]||c[0]||null;
  }
  function climbCard(el){
    var n=el, i=0;
    while(n && i<8){
      n = n.parentElement; i++;
      if(!n) break;
      var t = text(n);
      if (/Public/i.test(t) && /\\d+\\s*\\/\\s*\\d+/.test(t)) return n;
      var r = n.getBoundingClientRect ? n.getBoundingClientRect() : {width:0,height:0};
      if (r.width>260 && r.height>60 && n.querySelector('button')) return n;
    }
    return null;
  }
  function titleOf(card){
    var t=$all(card,'strong,h3,h4,.font-semibold,.font-medium').map(text).filter(Boolean)[0];
    if(!t){ t = text(card).split('\\n')[0] || 'Event'; }
    return t;
  }
  function dateOf(card){
    var t= text($all(card,'time')[0]);
    if(!t){
      var arr=$all(card,'div,span,small').map(text);
      for(var i=0;i<arr.length;i++){ if(/(Mon|Tue|Wed|Thu|Fri|Sat|Sun)|\\d{1,2}:\\d{2}|AM|PM|\\d{4}/i.test(arr[i])) return arr[i]; }
    }
    return t;
  }
  function courseOf(card){
    var arr=$all(card,'span,div').map(text);
    for(var i=0;i<arr.length;i++){ if(/\\bcourse\\b/i.test(arr[i])) return arr[i]; }
    return '';
  }
  function capacityEl(card){ return $all(card,'span,div').filter(function(x){ return /\\d+\\s*\\/\\s*\\d+/.test(text(x)); })[0]; }
  function isPublic(card){ return !!$all(card,'span,div').filter(function(x){ return /public/i.test(text(x)); })[0]; }
  function keyOf(card){ return hash(titleOf(card)+'|'+dateOf(card)+'|'+courseOf(card)); }

  function ensureNotes(card, key){
    if (card.querySelector('.mc-note')) return;
    var notesMap = load(NOTES_KEY);
    var val = card.getAttribute('data-notes') || notesMap[key] || '';
    if (!val) {
      // Only show "Add notes" if organizer controls visible
      var canEdit = $all(card,'button,a').some(function(b){ return /(^|\\s)edit(\\s|$)/i.test(text(b)); });
      if (!canEdit) return;
    }
    var node = card.ownerDocument.createElement('div');
    node.className='mc-note';
    if (val) { node.textContent = val; }
    else {
      var a = card.ownerDocument.createElement('a');
      a.textContent='Add notes'; a.style.color='#2563eb'; a.style.textDecoration='underline'; a.style.cursor='pointer';
      a.onclick=function(){
        var t=prompt('Notes for this event:');
        if (t && t.trim()){ notesMap=load(NOTES_KEY); notesMap[key]=t.trim(); save(NOTES_KEY,notesMap); node.textContent=t.trim(); }
      };
      node.appendChild(a);
    }
    var firstBtn=$all(card,'button,a')[0]; var row=firstBtn?firstBtn.parentElement:card;
    if(row && row.parentElement===card){ card.insertBefore(node, row); } else { card.appendChild(node); }
  }

  function ensureButtons(card){
    if (card.__mc_join_done) return;
    if (!isPublic(card)) return;
    var open = findOpen(card); if(!open) return;
    var row = open.parentElement || card;
    var key = keyOf(card);
    var capE = capacityEl(card), cap = capE? parseCap(text(capE)) : null;
    var full = cap ? (cap.n >= cap.cap) : false;
    var joined = load(JOINED_KEY), wait=load(WAIT_KEY);

    if (!full){
      var join = card.ownerDocument.createElement('button');
      join.className='mc-join'; join.textContent = joined[key] ? 'Joined' : 'Join';
      join.disabled = !!joined[key];
      row.insertBefore(join, open.nextSibling);
      join.onclick=function(){
        joined = load(JOINED_KEY); joined[key]=Date.now(); save(JOINED_KEY, joined);
        if (cap && cap.n < cap.cap){ cap.n++; capE.textContent = cap.n + '/' + cap.cap; }
        join.textContent='Joined'; join.disabled=true; try{ open.click(); }catch(e){}
      };
    } else {
      var wl = card.ownerDocument.createElement('button');
      wl.className='mc-waitlist'; wl.textContent = wait[key] ? 'On Waitlist' : 'Join Waitlist';
      wl.disabled = !!wait[key];
      row.insertBefore(wl, open.nextSibling);
      wl.onclick=function(){
        wait = load(WAIT_KEY); wait[key]=Date.now(); save(WAIT_KEY, wait);
        wl.textContent='On Waitlist'; wl.disabled=true; try{ open.click(); }catch(e){}
      };
    }

    ensureNotes(card, key);
    card.__mc_join_done = true;
  }

  function sweep(root){
    // Strategy: any element whose text contains "Open" → climb to card
    $all(root,'button,a,div,span').filter(function(e){ return /(^|\\s)open(\\s|$)/i.test(text(e)); })
      .forEach(function(e){ var c=climbCard(e); if(c) ensureButtons(c); });
    // Fallback: blocks with Public + n/cap
    $all(root,'div,article,section,li').forEach(function(n){
      var t=text(n); if(/public/i.test(t) && /\\d+\\s*\\/\\s*\\d+/.test(t)) ensureButtons(n);
    });
  }

  function boot(){
    try { sweep(document); } catch(e){}
    var MO=window.MutationObserver||window.WebKitMutationObserver;
    if (MO){
      new MO(function(){ try{sweep(document);}catch(e){} })
        .observe(document.documentElement, {childList:true, subtree:true});
    }
    // A couple of timed retries in case the list renders late
    setTimeout(function(){sweep(document);}, 500);
    setTimeout(function(){sweep(document);}, 1200);
  }

  if (document.readyState !== 'loading') boot();
  else document.addEventListener('DOMContentLoaded', boot);
})();
</script>


<!-- === BEGIN: Golf Events Button Binder (safe, scoped) === -->
<script>
(function () {
  'use strict';
  if (window.__golfEventsHandlers_v4) return;
  window.__golfEventsHandlers_v4 = true;

  const $$ = (sel, root) => Array.prototype.slice.call((root || document).querySelectorAll(sel));
  const $1 = (sel, root) => (root || document).querySelector(sel);
  const norm = (t) => (t || '').replace(/\s+/g, ' ').trim();
  const textOf = (el) => norm(el && (el.textContent || el.value));
  const on = (el, ev, fn) => el && el.addEventListener(ev, fn, { passive: true });

  function closestCard(node) {
    if (!node) return null;
    const candidate =
      node.closest && (node.closest('[data-event-card], .event-card') || node.closest('[role="article"]'));
    if (candidate) return candidate;
    let cur = node, i = 0;
    while (cur && i++ < 6) {
      const cls = (cur.className || '') + '';
      const disp = getComputedStyle(cur).display;
      if ((/card|panel|box|border|rounded|shadow/i.test(cls) || /block|grid|flex/.test(disp))) {
        const txt = (cur.innerText || '').toLowerCase();
        if (/(event|tee time|tee-time|course|shotgun|handicap|hcp|holes|registration|waitlist)/.test(txt)) {
          return cur;
        }
      }
      cur = cur.parentElement;
    }
    return null;
  }

  function ensureModal() {
    let wrap = $1('#ge-modal-wrap');
    if (wrap) return wrap;
    wrap = document.createElement('div');
    wrap.id = 'ge-modal-wrap';
    wrap.style.cssText = 'position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;background:rgba(0,0,0,.35)';
    const panel = document.createElement('div');
    panel.id = 'ge-modal-panel';
    panel.style.cssText = 'max-width:900px;width:min(90vw,900px);max-height:80vh;overflow:auto;border-radius:12px;background:#fff;box-shadow:0 10px 30px rgba(0,0,0,.25)';
    const hdr = document.createElement('div');
    hdr.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e7eb';
    const title = document.createElement('div');
    title.id = 'ge-modal-title';
    title.style.cssText = 'font-weight:600';
    const x = document.createElement('button');
    x.type = 'button'; x.textContent = '×'; x.setAttribute('aria-label', 'Close');
    x.style.cssText = 'font-size:22px;line-height:20px;border:0;background:transparent;cursor:pointer;padding:4px 8px';
    const body = document.createElement('div');
    body.id = 'ge-modal-body'; body.style.cssText = 'padding:12px 16px';
    hdr.appendChild(title); hdr.appendChild(x);
    panel.appendChild(hdr); panel.appendChild(body);
    wrap.appendChild(panel); document.body.appendChild(wrap);
    on(wrap, 'click', (e) => { if (e.target === wrap) closeModal(); });
    on(x, 'click', closeModal);
    return wrap;
  }
  function openModal(html, titleText) {
    const wrap = ensureModal();
    $1('#ge-modal-title', wrap).textContent = titleText || 'Event Details';
    $1('#ge-modal-body', wrap).innerHTML = html || '<div>No details available.</div>';
    document.body.dataset.geScrollLock = '1';
    document.body.style.overflow = 'hidden';
    wrap.style.display = 'flex';
  }
  function closeModal() {
    const wrap = $1('#ge-modal-wrap');
    if (wrap) wrap.style.display = 'none';
    if (document.body.dataset.geScrollLock) {
      delete document.body.dataset.geScrollLock;
      document.body.style.overflow = '';
    }
  }

  function findTitleEl(card) {
    return $1('[data-event-title], .event-title, h1, h2, h3, h4, strong', card);
  }
  function findDetailsEl(card) {
    return $1('[data-event-details], .event-details, .prose, .content, .description, .details', card);
  }
  function markStatus(card, text, styleKey) {
    let chip = card && card.querySelector('.ge-status');
    if (!chip) {
      chip = document.createElement('span');
      chip.className = 'ge-status';
      chip.style.cssText = 'margin-left:8px;padding:2px 8px;border-radius:9999px;font-size:12px;border:1px solid #e5e7eb';
      const titleEl = findTitleEl(card) || card;
      titleEl.appendChild(chip);
    }
    chip.textContent = text;
    chip.style.background = styleKey === 'wait' ? '#fffbea' : '#ecfdf5';
  }

  function allEventCards() {
    const cards = new Set($$('[data-event-card], .event-card'));
    $$('button, a[role="button"]').forEach((b) => {
      const t = (b.textContent || b.value || '').toLowerCase().trim();
      if (!/(view details|join event|edit|delete|join waitlist|confirm registration)/.test(t)) return;
      const c = closestCard(b); if (c) cards.add(c);
    });
    return Array.from(cards);
  }
  function deriveCategory(card) {
    if (card.dataset.geCategory) return card.dataset.geCategory;
    if (card.querySelector('[data-event-type="my"], .badge-my, .chip-my')) return card.dataset.geCategory = 'my';
    if (card.querySelector('[data-event-type="invited"], .badge-invited, .chip-invited')) return card.dataset.geCategory = 'invited';
    if (card.querySelector('[data-event-type="public"], .badge-public, .chip-public')) return card.dataset.geCategory = 'public';
    const txt = (card.innerText || '').toLowerCase();
    if (/my/.test(txt)) return card.dataset.geCategory = 'my';
    if (/invited/.test(txt)) return card.dataset.geCategory = 'invited';
    return card.dataset.geCategory = 'public';
  }
  function applyFilter(kind) {
    allEventCards().forEach((card) => {
      const cat = deriveCategory(card);
      card.style.display = (!kind || kind === 'all' || cat === kind) ? '' : 'none';
    });
  }
  function applySearch(q) {
    const query = (q || '').trim().toLowerCase();
    const cards = allEventCards();
    if (!query) return cards.forEach((c) => (c.style.display = ''));
    cards.forEach((card) => {
      const hay =
        (findTitleEl(card)?.innerText || '') + ' ' +
        (findDetailsEl(card)?.innerText || '') + ' ' +
        (card.innerText || '');
      card.style.display = hay.toLowerCase().indexOf(query) >= 0 ? '' : 'none';
    });
  }

  function wireButtons(ctx) {
    const root = ctx || document;

    // Create Event
    $$('button, a[role="button"]', root)
      .filter((b) => /^create event$/i.test((b.textContent || b.value || '').trim()))
      .forEach((btn) => {
        if (btn.__ge) return; btn.__ge = true;
        on(btn, 'click', function (e) {
          e.preventDefault();
          const container = $1('#eventsList, [data-events-list], .events-list, main, .container, .grid, .list') || document.body;
          const template = allEventCards()[0];
          let card;
          if (template) {
            card = template.cloneNode(true);
            const t = findTitleEl(card); if (t) t.textContent = 'New Event';
            card.querySelectorAll('.ge-status').forEach((s) => s.remove());
          } else {
            card = document.createElement('div');
            card.className = 'event-card';
            card.innerHTML = '<h3 class="event-title">New Event</h3>' +
              '<div class="event-details" style="display:none">Details TBD</div>' +
              '<div style="display:flex;gap:8px;margin-top:8px">' +
              '<button>View Details</button><button>Edit</button><button>Delete</button>' +
              '<button>Join Event</button><button>Join Waitlist</button></div>';
          }
          container.prepend(card);
          wireButtons(card);
          console.log('Create Event clicked');
        });
      });

    // View Details
    $$('button, a[role="button"]', root)
      .filter((b) => /^view details$/i.test((b.textContent || b.value || '').trim()))
      .forEach((btn) => {
        if (btn.__ge) return; btn.__ge = true;
        on(btn, 'click', function (e) {
          e.preventDefault();
          const card = closestCard(this);
          const title = (findTitleEl(card)?.innerText) || 'Event Details';
          const details = (findDetailsEl(card)?.innerHTML) ||
            (function () {
              const clone = card.cloneNode(true);
              clone.querySelectorAll('button, a, input').forEach((x) => x.remove());
              return clone.innerHTML || '<div>No details available.</div>';
            })();
          openModal(details, title);
          console.log('View Details clicked');
        });
      });

    // Edit
    $$('button, a[role="button"]', root)
      .filter((b) => /^edit$/i.test((b.textContent || b.value || '').trim()))
      .forEach((btn) => {
        if (btn.__ge) return; btn.__ge = true;
        on(btn, 'click', function (e) {
          e.preventDefault();
          const card = closestCard(this);
          const el = findTitleEl(card);
          const cur = el ? (el.textContent || '').trim() : '';
          const next = prompt('Edit event title:', cur);
          if (next != null && el) el.textContent = (next || cur).trim();
          console.log('Edit clicked');
        });
      });

    // Delete
    $$('button, a[role="button"]', root)
      .filter((b) => /^delete$/i.test((b.textContent || b.value || '').trim()))
      .forEach((btn) => {
        if (btn.__ge) return; btn.__ge = true;
        on(btn, 'click', function (e) {
          e.preventDefault();
          const card = closestCard(this);
          if (!card) return;
          if (confirm('Delete this event?')) {
            card.remove();
            console.log('Delete clicked');
          }
        });
      });

    // Join Event
    $$('button, a[role="button"]', root)
      .filter((b) => /^join event$/i.test((b.textContent || b.value || '').trim()))
      .forEach((btn) => {
        if (btn.__ge) return; btn.__ge = true;
        on(btn, 'click', function (e) {
          e.preventDefault();
          const card = closestCard(this);
          this.disabled = true;
          markStatus(card, 'Registered ✓', 'ok');
          console.log('Join Event clicked');
        });
      });

    // Join Waitlist
    $$('button, a[role="button"]', root)
      .filter((b) => /^join waitlist$/i.test((b.textContent || b.value || '').trim()))
      .forEach((btn) => {
        if (btn.__ge) return; btn.__ge = true;
        on(btn, 'click', function (e) {
          e.preventDefault();
          const card = closestCard(this);
          this.disabled = true;
          markStatus(card, 'On Waitlist ⏳', 'wait');
          console.log('Join Waitlist clicked');
        });
      });

    // Search
    $$('button, a[role="button"], input[type="submit"]', root)
      .filter((b) => /^search$/i.test((b.textContent || b.value || '').trim()))
      .forEach((btn) => {
        if (btn.__ge) return; btn.__ge = true;
        on(btn, 'click', function (e) {
          e.preventDefault();
          const input =
            $1('input[type="search"]') ||
            $1('input[placeholder*="Search" i]') ||
            $1('input[type="text"]', btn.parentElement);
          applySearch(input ? input.value : '');
          console.log('Search clicked');
        });
      });

    // Filters
    $$('button, a[role="button"]', root).forEach((btn) => {
      const t = ((btn.textContent || btn.value || '').trim().toLowerCase());
      if (!/^(all|my events|invited|public)$/.test(t)) return;
      if (btn.__ge) return; btn.__ge = true;
      on(btn, 'click', function (e) {
        e.preventDefault();
        const map = { all: 'all', 'my events': 'my', invited: 'invited', public: 'public' };
        const kind = map[t];
        applyFilter(kind);
        console.log('Filter clicked:', t);
      });
    });
  }

  function boot() { wireButtons(document); }
  if (document.readyState !== 'loading') boot();
  document.addEventListener('DOMContentLoaded', boot);
  try {
    new MutationObserver((muts) => {
      muts.forEach((m) => {
        if (m.addedNodes) Array.prototype.forEach.call(m.addedNodes, (n) => { if (n.nodeType === 1) wireButtons(n); });
      });
    }).observe(document.documentElement, { subtree: true, childList: true });
  } catch (e) {}
})();
</script>
<!-- === END: Golf Events Button Binder (safe, scoped) === -->



<!-- MCP Minimal Patch v2: Book Caddy (Dashboard) + Events module (no overlays, minimal observers) -->
<script>
(function(){
  'use strict';
  if (window.__mcpMinimalV2) return; window.__mcpMinimalV2 = true;

  function onReady(fn){ if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  function $(s, r){ return (r||document).querySelector(s); }
  function $all(s, r){ return Array.prototype.slice.call((r||document).querySelectorAll(s)); }

  function isDashboardActive(){
    var navs = $all('a,button');
    for (var i=0;i<navs.length;i++){
      var t=(navs[i].textContent||'').trim().toLowerCase();
      if (t==='dashboard'){
        var sel = navs[i].getAttribute('aria-current')==='page' || /active|selected|bg-gray-200|text-blue/i.test(navs[i].className||'');
        if (sel) return true;
      }
    }
    var h = $all('h1,h2').find(function(x){ return /dashboard/i.test((x.textContent||'')); });
    return !!h;
  }

  function applyBookCaddyOnce(){
    try{
      var main = document.querySelector('main') || document.body;
      var cards = $all(':scope div', main);
      for (var i=0;i<cards.length;i++){
        var ps = cards[i].querySelectorAll('p'); if (ps.length < 2) continue;
        var t0=(ps[0].textContent||'').trim(); var t1=(ps[1].textContent||'').trim();
        if (/^Book\s*Round$/i.test(t0) && /^Schedule$/i.test(t1)){
          ps[0].textContent = 'Book Caddy';
          ps[1].textContent = 'Book Caddy';
          cards[i].style.cursor = 'default';
          cards[i].style.pointerEvents = 'none';
          cards[i].addEventListener('click', function(e){ e.stopPropagation(); e.preventDefault(); }, true);
          // hide any schedule modal if present
          try { var mods = document.querySelectorAll('[role="dialog"], .modal, .MuiDialog-paper, .ant-modal, .chakra-modal__content');
            mods.forEach(function(el){ var t=(el.textContent||'').toLowerCase(); if (t.indexOf('schedule')!==-1) el.style.display='none'; }); } catch(_){ }
          break;
        }
      }
      if (typeof window.openGolfModal === 'function'){ window.openGolfModal = function(){ return false; }; }
    }catch(e){ }
  }

  function patchDashboard(){
    if (!isDashboardActive()) return;
    applyBookCaddyOnce();
    var main = document.querySelector('main') || document.body;
    var tries = 0;
    var mo = new MutationObserver(function(){ tries++; applyBookCaddyOnce(); if (tries > 10){ try{ mo.disconnect(); }catch(_){ } } });
    try{ mo.observe(main, {childList:true, subtree:true}); }catch(_){ }
    setTimeout(function(){ try{ mo.disconnect(); }catch(_){ } }, 4000);
  }

  var EVKEY='mcp_events_data_v1', _mounted=false;
  function seed(){ return [
    {id:'E1001',title:'Saturday Skins',date:'2025-09-13',time:'08:00',location:'Course A',capacity:24,attendees:18,waitlist:0,notes:'Gross & net skins. Bring cash.'},
    {id:'E1002',title:'Midweek Nine & Dine',date:'2025-09-17',time:'17:00',location:'Course B',capacity:16,attendees:16,waitlist:2,notes:'Pairs scramble. Dinner included.'},
    {id:'E1003',title:'Charity Scramble',date:'2025-09-28',time:'09:00',location:'Course C',capacity:80,attendees:53,waitlist:0,notes:'4-man scramble; proceeds go to juniors.'},
    {id:'E1004',title:'Open Play Day',date:'2025-10-05',time:'10:00',location:'Course D',capacity:40,attendees:12,waitlist:0,notes:'Casual group; great for new members.'}
  ];}
  function load(){ try{ var r=JSON.parse(localStorage.getItem(EVKEY)||'null'); return Array.isArray(r)?r:seed(); }catch(_){ return seed(); } }
  function save(d){ try{ localStorage.setItem(EVKEY, JSON.stringify(d)); }catch(_){ }

  function isEventsActive(){
    var navs = $all('a,button');
    for (var i=0;i<navs.length;i++){
      var t=(navs[i].textContent||'').trim().toLowerCase();
      if (t==='events' || t==='event'){
        var sel = navs[i].getAttribute('aria-current')==='page' || /active|selected|bg-gray-200|text-blue/i.test(navs[i].className||'');
        if (sel) return true;
      }
    }
    var h = $all('h1,h2').find(function(x){ return /events/i.test((x.textContent||'')); });
    return !!h;
  }

  function mountEvents(into){
    into.innerHTML='';
    into.classList.add('mcp-events-host');
    var events=load(), state={tab:'all', q:'', sel:null};
    var wrap=document.createElement('div'); wrap.className='w-full space-y-4';
    var details=document.createElement('div'); details.id='mcp-ev-details'; details.className='sticky top-0 z-10 bg-white/95 backdrop-blur rounded-xl shadow border border-gray-200 p-4';
    var ctrls=document.createElement('div'); ctrls.className='flex flex-col gap-3 md:flex-row md:items-center md:justify-between';
    var region=document.createElement('div'); region.id='mcp-ev-region'; region.className='space-y-3';
    wrap.appendChild(details); wrap.appendChild(ctrls); wrap.appendChild(region); into.appendChild(wrap);
    ctrls.innerHTML = '<div class="inline-flex rounded-xl shadow-sm overflow-hidden border border-gray-200">'
      + ['All','My Events','Invited','Public','Create'].map(function(l,i){ var k=['all','mine','invited','public','create'][i]; return '<button data-tab="'+k+'" class="px-4 py-2 text-sm hover:bg-gray-50">'+l+'</button>'; }).join('')
      + '</div><div class="flex items-center gap-2"><input id="mcp-ev-search" type="text" placeholder="Search events..." class="border border-gray-300 rounded-lg px-3 py-2 w-64"/><button id="mcp-ev-search-btn" class="px-3 py-2 text-sm rounded-lg border border-gray-200 shadow">Search</button></div>';
    function detailsView(){
      var e=events.find(function(x){ return x.id===state.sel; });
      details.innerHTML = e ? ('<div class="flex items-start justify-between gap-4"><div><div class="text-base text-gray-500">Event Details</div><div class="text-xl font-semibold">'+e.title+'</div><div class="text-sm text-gray-600">'+e.date+' • '+e.time+' • '+e.location+'</div></div><div class="text-sm text-gray-500">ID: '+e.id+'</div></div><div class="mt-2 text-sm text-gray-700">'+(e.notes||'')+'</div><div class="mt-3 flex gap-3 text-sm"><span class="px-2 py-1 rounded border">Capacity: '+e.capacity+'</span><span class="px-2 py-1 rounded border">Attending: '+e.attendees+'</span><span class="px-2 py-1 rounded border">Waitlist: '+(e.waitlist||0)+'</span></div>') : '<div class="text-sm text-gray-500">Select an event to see details here.</div>';
    }
    function listData(){
      var L=events.slice();
      if (state.tab==='mine') L=L.filter(function(e){ return e.attendees && e.attendees>=1; });
      else if (state.tab==='invited') L=L.filter(function(e){ return /invite|charity/i.test(e.title+' '+(e.notes||'')); });
      if (state.q){ var s=state.q; L=L.filter(function(e){ return (e.title+' '+e.location+' '+(e.notes||'')).toLowerCase().indexOf(s)>=0; }); }
      return L;
    }
    function listView(){
      if (state.tab==='create'){
        region.innerHTML = '<form id="mcp-ev-create" class="rounded-xl border border-gray-200 shadow p-4 grid grid-cols-1 md:grid-cols-2 gap-3"><div><label class="text-sm text-gray-600">Title</label><input required name="title" class="mt-1 w-full border rounded px-3 py-2"/></div><div><label class="text-sm text-gray-600">Location</label><input required name="location" class="mt-1 w-full border rounded px-3 py-2"/></div><div><label class="text-sm text-gray-600">Date</label><input required type="date" name="date" class="mt-1 w-full border rounded px-3 py-2"/></div><div><label class="text-sm text-gray-600">Time</label><input required type="time" name="time" class="mt-1 w-full border rounded px-3 py-2"/></div><div><label class="text-sm text-gray-600">Capacity</label><input required type="number" min="1" name="capacity" class="mt-1 w-full border rounded px-3 py-2"/></div><div class="md:col-span-2"><label class="text-sm text-gray-600">Notes</label><textarea name="notes" class="mt-1 w-full border rounded px-3 py-2" rows="3"></textarea></div><div class="md:col-span-2 flex justify-end gap-2"><button type="reset" class="px-3 py-2 rounded border">Reset</button><button type="submit" class="px-3 py-2 rounded border shadow">Create</button></div></form>';
        $('#mcp-ev-create').addEventListener('submit', function(ev){ ev.preventDefault(); var fd=new FormData(ev.currentTarget); var ne={ id:'E'+Math.floor(Math.random()*1e6), title:String(fd.get('title')||''), location:String(fd.get('location')||''), date:String(fd.get('date')||''), time:String(fd.get('time')||''), capacity:parseInt(fd.get('capacity')||'0',10)||0, attendees:0, waitlist:0, notes:String(fd.get('notes')||'') }; events.unshift(ne); save(events); state.tab='all'; state.sel=ne.id; render(); alert('Event created.'); });
        return;
      }
      var L=listData();
      if (!L.length){ region.innerHTML='<div class="text-sm text-gray-500">No events match your filters.</div>'; return; }
      region.innerHTML='';
      L.forEach(function(e){
        var card=document.createElement('div'); card.className='rounded-xl border border-gray-200 shadow p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3';
        card.innerHTML = '<div><div class="text-base font-medium">'+e.title+'</div><div class="text-sm text-gray-600">'+e.date+' • '+e.time+' • '+e.location+'</div><div class="text-sm text-gray-500 mt-1">'+(e.notes||'')+'</div><div class="mt-2 text-xs text-gray-500">Cap '+e.capacity+' • Att '+e.attendees+' • WL '+(e.waitlist||0)+'</div></div><div class="flex gap-2 justify-end"><button data-a="view" class="px-3 py-1.5 rounded border">View</button><button data-a="edit" class="px-3 py-1.5 rounded border">Edit</button><button data-a="del" class="px-3 py-1.5 rounded border">Delete</button>'+(e.attendees<e.capacity?'<button data-a="join" class="px-3 py-1.5 rounded border">Join</button>':'<button data-a="wait" class="px-3 py-1.5 rounded border">Join Waitlist</button>')+'</div>';
        card.querySelector('[data-a="view"]').addEventListener('click', function(){ state.sel=e.id; render(); });
        card.querySelector('[data-a="edit"]').addEventListener('click', function(){ var t=prompt('Title', e.title); if(t==null) return; var loc=prompt('Location', e.location); if(loc==null) return; e.title=t; e.location=loc; save(events); render(); });
        card.querySelector('[data-a="del"]').addEventListener('click', function(){ if (confirm('Delete this event?')){ events=events.filter(function(x){ return x.id!==e.id; }); if (state.sel===e.id) state.sel=null; save(events); render(); } });
        card.querySelector('[data-a="join"]').addEventListener('click', function(){ if(e.attendees<e.capacity){ e.attendees++; save(events); state.sel=e.id; render(); alert('Joined.'); } });
        card.querySelector('[data-a="wait"]').addEventListener('click', function(){ e.waitlist=(e.waitlist||0)+1; save(events); state.sel=e.id; render(); alert('Added to waitlist.'); });
        region.appendChild(card);
      });
    }
    function render(){ detailsView(); listView(); $all('[data-tab]').forEach(function(b){ var k=b.getAttribute('data-tab'); var a=(k===state.tab); b.classList.toggle('bg-gray-100',a); b.classList.toggle('font-semibold',a); }); }
    $all('[data-tab]', ctrls).forEach(function(b){ b.addEventListener('click', function(){ state.tab=b.getAttribute('data-tab'); state.sel=null; render(); }); });
    $('#mcp-ev-search-btn', ctrls).addEventListener('click', function(){ var q=$('#mcp-ev-search').value.trim().toLowerCase(); state.q=q; render(); });
    $('#mcp-ev-search', ctrls).addEventListener('keydown', function(e){ if(e.key==='Enter'){ $('#mcp-ev-search-btn', ctrls).click(); } });
    render();
  }

  function isEventsActive(){
    var navs = $all('a,button');
    for (var i=0;i<navs.length;i++){
      var t=(navs[i].textContent||'').trim().toLowerCase();
      if (t==='events' || t==='event'){
        var sel = navs[i].getAttribute('aria-current')==='page' || /active|selected|bg-gray-200|text-blue/i.test(navs[i].className||'');
        if (sel) return true;
      }
    }
    var h = $all('h1,h2').find(function(x){ return /events/i.test((x.textContent||'')); });
    return !!h;
  }

  function tryMountEvents(){
    if (_mounted || !isEventsActive()) return;
    var main = document.querySelector('main') || document.body;
    var ifr = $all('iframe', main).find(function(f){ var s=f.getAttribute('src')||''; return /^data:text\/html;base64,/.test(s); });
    var host = null;
    if (ifr){ host=document.createElement('div'); host.id='mcp-events-root'; ifr.replaceWith(host); }
    else {
      var h = $all('h1,h2,h3', main).find(function(x){ return /events/i.test((x.textContent||'')); });
      if (h){ host=document.createElement('div'); host.id='mcp-events-root'; h.parentElement.insertBefore(host, h.nextSibling); }
    }
    if (host){ mountEvents(host); _mounted=true; console.log('[MCP:Events] Mounted (minimal)'); }
  }

  function boot(){ patchDashboard(); tryMountEvents(); }
  onReady(boot);
  window.addEventListener('hashchange', boot);
  window.addEventListener('popstate', boot);
  onReady(function(){ var main = document.querySelector('main') || document.body; var mo = new MutationObserver(function(){ tryMountEvents(); patchDashboard(); }); try{ mo.observe(main, {childList:true, subtree:true}); }catch(_){ } setTimeout(function(){ try{ mo.disconnect(); }catch(_){ } }, 5000); });
})();
</script>
<style>.mcp-events-host *{box-sizing:border-box}</style>

<!-- MCP SCHEDULE CADDY START -->
<style id="mcp-caddy-schedule-style">
  /* Scoped styles (won't bleed) */
  #mcpCaddyScheduleRoot .mcp-card{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:12px;margin:10px 0}
  #mcpCaddyScheduleRoot .mcp-h{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(0,0,0,.06);font-weight:600;background:#f8fafc;border-top-left-radius:12px;border-top-right-radius:12px}
  #mcpCaddyScheduleRoot .mcp-b{padding:12px 14px}
  #mcpCaddyScheduleRoot .mcp-pill{font-size:12px;border:1px solid rgba(0,0,0,.12);border-radius:999px;padding:.15rem .5rem;background:#fff}
  #mcpCaddyScheduleRoot .mcp-btn{border:1px solid rgba(0,0,0,.15);border-radius:8px;padding:6px 10px;background:#fff;cursor:pointer}
  #mcpCaddyScheduleRoot .mcp-btn.primary{background:#2563eb;border-color:#2563eb;color:#fff}
  #mcpCaddyScheduleRoot .mcp-row{display:flex;align-items:center;justify-content:space-between;border:1px solid rgba(0,0,0,.08);border-radius:12px;padding:8px;margin-bottom:8px}
  body.mcp-caddy-mode-on .mcp-hidden-during-caddy{display:none !important}
</style>
<script id="mcp-caddy-schedule-script">
(function(){
  "use strict";
  var ROOT_ID="mcpCaddyScheduleRoot";
  var ENABLE_CLASS="mcp-caddy-mode-on";
  var LS_KEY="mcp.caddy.bookings.v1";
  var alive=true;

  var DEMO_TEE={date:"2025-09-15",time:"09:00",course:"Pattana Golf Resort",groupName:"Peter Park",
    players:["Peter Park","Alan Thomas","Tristan Gilbert","Billy Shepley"],bookingRef:"PGR-091525-010"};
  var DEMO_AVAIL=[{id:101,rating:4.6,price:1600},{id:103,rating:4.5,price:1600},{id:105,rating:4.4,price:1600}];
  var DEMO_BOOKED={"102":{bookedBy:"Alan Thomas"},"104":{bookedBy:"Tristan Gilbert"}};

  function $(sel,root){return (root||document).querySelector(sel);}
  function $$(sel,root){return Array.prototype.slice.call((root||document).querySelectorAll(sel));}
  function el(tag,attrs,children){var d=document.createElement(tag); if(attrs){for(var k in attrs){if(k==="class")d.className=attrs[k];else if(k==="text")d.textContent=attrs[k];else if(k==="html")d.innerHTML=attrs[k];else d.setAttribute(k,attrs[k]);}} if(children){children.forEach(function(c){if(typeof c==="string")d.appendChild(document.createTextNode(c));else if(c)d.appendChild(c);});} return d;}
  function fmtTime(t){var a=t.split(":"),H=parseInt(a[0],10),m=a[1],ap=H>=12?"PM":"AM",h=H%12; if(h===0)h=12; return h+":"+m+" "+ap;}

  function currentTabName(){
    var sel = $('[role="tab"][aria-selected="true"]');
    if(sel) return (sel.textContent||"").trim().toLowerCase();
    var act = $('.active'); if(act) return (act.textContent||"").trim().toLowerCase();
    return "";
  }
  function isScheduleTab(){
    var n=currentTabName();
    return n==="schedule" || n==="book caddy";
  }

  function renameScheduleToBookCaddy(){
    // change only label text, do not alter behavior
    var all=document.querySelectorAll('[role="tab"], button, a, span, div');
    for(var i=0;i<all.length;i++){
      var t=(all[i].textContent||"").trim();
      if(/^schedule$/i.test(t)){
        all[i].textContent="Book Caddy";
        break;
      }
    }
  }

  function getMainContainer(){
    // Heuristic: the first <main> if exists, else the largest content section
    var m=$("main"); if(m) return m;
    var candidates=$$("section, .content, .container, .main, .page");
    var best=null, max=0;
    candidates.forEach(function(n){var r=n.getBoundingClientRect(); var s=r.width*r.height; if(s>max){max=s; best=n;}});
    return best||document.body;
  }

  function hidePeers(main, root){
    // mark siblings as hidden-during-caddy
    Array.prototype.slice.call(main.children).forEach(function(ch){
      if(ch!==root && !ch.id.includes("toast") && ch.tagName!=="HEADER" && ch.tagName!=="NAV"){
        ch.classList.add("mcp-hidden-during-caddy");
      }
    });
    document.body.classList.add(ENABLE_CLASS);
  }
  function unhidePeers(main){
    document.body.classList.remove(ENABLE_CLASS);
    $$('.mcp-hidden-during-caddy', main).forEach(function(ch){ ch.classList.remove("mcp-hidden-during-caddy"); });
  }

  function load(){ try{var s=localStorage.getItem(LS_KEY); return s?JSON.parse(s):[];}catch(e){return [];} }
  function save(v){ try{localStorage.setItem(LS_KEY, JSON.stringify(v||[]));}catch(e){} }

  function renderBookings(root){
    var list=load();
    var wrap=el("div",{id:"mcpBookings"});
    if(!list.length){
      wrap.appendChild(el("div",{class:"mcp-card"},[ el("div",{class:"mcp-b",text:"No caddy bookings yet."}) ]));
    }else{
      list.forEach(function(b){
        var badge = b.status==="confirmed" ? 'background:#ecfdf5;border-color:#a7f3d0;color:#065f46' : 'background:#fffbeb;border-color:#fde68a;color:#92400e';
        var info = b.status==="confirmed" ? ("Caddy: Caddy #"+b.caddyId+" • ฿"+b.price) : ("Caddy: Unavailable • C-"+b.caddyId);
        var card=el("div",{class:"mcp-card"},[
          el("div",{class:"mcp-h"},[ el("div",{text:b.course}), el("div",{class:"mcp-pill",style:badge,text:b.status}) ]),
          el("div",{class:"mcp-b"},[ el("div",{text:b.date+" • "+fmtTime(b.time)}), el("div",{text:"Players: "+b.players.join(", ")}), el("div",{text:info}),
            el("div",{style:"padding-top:8px;display:flex;gap:8px;"},[ el("button",{class:"mcp-btn",text:"Edit Caddy"}), el("button",{class:"mcp-btn",text:"Cancel Caddy", onclick:function(){ save(load().filter(function(r){return r.id!==b.id;})); renderAll(root); }}) ]) ])
        ]);
        wrap.appendChild(card);
      });
    }
    root.appendChild(wrap);
  }

  function addBooking(status, caddyId, price){
    var list=load();
    list.unshift({
      id:"B"+Date.now().toString(36),
      course:DEMO_TEE.course,
      date:DEMO_TEE.date,
      time:DEMO_TEE.time,
      players:DEMO_TEE.players,
      status:status,
      caddyId:caddyId,
      price:price
    });
    save(list);
  }

  function renderModule(root){
    root.innerHTML="";
    // Search
    var search=el("div",{class:"mcp-card"},[
      el("div",{class:"mcp-h"},[ el("div",{text:"Book Caddy"}), el("div",{class:"mcp-pill",text:"Demo"}) ]),
      el("div",{class:"mcp-b"},[
        (function(){
          var box=el("div",{style:"display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;"});
          var n=el("input",{value:"Peter Park"}); n.placeholder="Name";
          var c=el("input",{value:"Pattana Golf Resort"}); c.placeholder="Course";
          var d=el("input",{type:"date",value:"2025-09-15"});
          box.appendChild(el("label",{},["Name", n])); box.appendChild(el("label",{},["Course", c])); box.appendChild(el("label",{},["Date", d]));
          var bar=el("div",{style:"display:flex;justify-content:flex-end;padding-top:8px;"},[
            el("button",{class:"mcp-btn primary",text:"Search Tee Time", onclick:function(){
              // simple match
              if(n.value.trim().toLowerCase().includes("peter") && c.value.trim().toLowerCase().includes("pattana") && d.value.trim()==="2025-09-15"){
                renderTee(root);
              }else{
                var miss=el("div",{class:"mcp-card"},[ el("div",{class:"mcp-b",text:"No matching tee time found."}) ]);
                root.appendChild(miss);
              }
            }})
          ]);
          var wrap=el("div"); wrap.appendChild(box); wrap.appendChild(bar); return wrap;
        })()
      ])
    ]);
    root.appendChild(search);
    renderBookings(root);
  }

  function renderTee(root){
    // Tee info
    var t=el("div",{class:"mcp-card"},[
      el("div",{class:"mcp-h"},[ el("div",{text:DEMO_TEE.course}), el("div",{class:"mcp-pill",text:"Group: "+DEMO_TEE.groupName}) ]),
      el("div",{class:"mcp-b"},[ el("div",{text:DEMO_TEE.date+" • "+fmtTime(DEMO_TEE.time)}), el("div",{text:"Players: "+DEMO_TEE.players.join(", ")}),
        el("div",{style:"padding-top:8px;"},[ el("button",{class:"mcp-btn",text:"Show Caddies", onclick:function(){ renderCaddies(root);} }) ]) ])
    ]);
    root.appendChild(t);
  }

  function renderCaddies(root){
    var box=el("div",{class:"mcp-card"},[ el("div",{class:"mcp-h"},[ el("div",{text:"Caddies for "+DEMO_TEE.date+" • "+fmtTime(DEMO_TEE.time)}), el("div",{class:"mcp-pill",text:DEMO_TEE.course}) ]), el("div",{class:"mcp-b",id:"mcpCaddyList"}) ]);
    var list=$("#mcpCaddyList", box);
    DEMO_AVAIL.forEach(function(c){
      var row=el("div",{class:"mcp-row"},[ el("div",{},[ el("div",{text:"#"+c.id+" (Available)", style:"font-weight:600;"}), el("div",{text:"Rating "+c.rating+" • ฿"+c.price, style:"font-size:12px;opacity:.7"}) ]),
        el("button",{class:"mcp-btn primary",text:"Book Now", onclick:function(){ addBooking("confirmed", c.id, c.price); renderAll(root); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});} }) ]);
      list.appendChild(row);
    });
    Object.keys(DEMO_BOOKED).forEach(function(id){
      var by=DEMO_BOOKED[id].bookedBy;
      var row=el("div",{class:"mcp-row"},[ el("div",{},[ el("div",{text:"#"+id+" (Booked)", style:"font-weight:600;"}), el("div",{text:"Booked by "+by, style:"font-size:12px;opacity:.8"}) ]),
        el("button",{class:"mcp-btn",text:"Join Waitlist", onclick:function(){ addBooking("waitlisted", Number(id), 1600); renderAll(root); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});} }) ]);
      list.appendChild(row);
    });
    root.appendChild(box);
  }

  function renderAll(root){
    root.innerHTML="";
    renderModule(root);
  }

  function mount(){
    if(!isScheduleTab()){ unmount(); return; }
    renameScheduleToBookCaddy();
    var main=getMainContainer();
    var root=$("#"+ROOT_ID);
    if(!root){
      root=el("div",{id:ROOT_ID});
      main.appendChild(root);
    }
    hidePeers(main, root);
    renderAll(root);
  }

  function unmount(){
    var root=$("#"+ROOT_ID); if(root&&root.parentNode){ root.parentNode.removeChild(root); }
    var main=getMainContainer(); if(main) unhidePeers(main);
  }

  function tick(){ if(!alive) return; if(isScheduleTab()) mount(); else unmount(); }

  if(document.readyState!=="loading") tick(); else document.addEventListener("DOMContentLoaded", tick);
  setInterval(tick, 900);
  window.addEventListener("focus", tick);
  window.addEventListener("beforeunload", function(){ alive=false; });
})();
</script>
<!-- MCP SCHEDULE CADDY END -->

<script type="text/babel" id="bookcaddy-v7-code">
const { useState, useEffect, useMemo } = React;

    // Icon shims
    const Icon = ({children}) => <span className="inline-flex items-center justify-center w-4 h-4">{children}</span>;
    const Search = () => <Icon>🔎</Icon>;
    const Star = () => <Icon>⭐</Icon>;
    const User = () => <Icon>👤</Icon>;
    const MapPin = () => <Icon>📍</Icon>;
    const CheckCircle = () => <Icon>✅</Icon>;
    const Calendar = () => <Icon>📅</Icon>;
    const Clock = () => <Icon>⏰</Icon>;
    const Timer = () => <Icon>⏳</Icon>;

    // -------- Caddy Booking Module (per-player with in-group conflict awareness) --------
    const CaddyBookingModule = ({ onComplete, onBooked, onWaitlisted, initialTeeTime = null, playerOptions = [], initialPlayer = null, groupBookedMap = {} }) => {
      const [searchForm, setSearchForm] = useState({ nameGroup: '', course: '', date: '' });
      const [searchResults, setSearchResults] = useState([]);
      const [selectedTeeTime, setSelectedTeeTime] = useState(initialTeeTime);
      const [displayedCaddy, setDisplayedCaddy] = useState(null);
      const [bookingComplete, setBookingComplete] = useState(false);
      const [waitlistComplete, setWaitlistComplete] = useState(false);
      const [searchPerformed, setSearchPerformed] = useState(false);

      // Player assignment
      const [assignPlayer, setAssignPlayer] = useState(initialPlayer || (playerOptions[0] || 'Peter Park'));

      // Caddy# quick search
      const [caddyNumber, setCaddyNumber] = useState('');
      const [caddyLookup, setCaddyLookup] = useState(null);

      const golfCourses = [
        'All Courses','Pattaya Country Club','Pattana Golf Resort','Laem Chabang International Country Club',
        'Phoenix Gold & Country Club','Thai Country Club'
      ];

      const teeTimes = [
        { id: 8, date: '2025-09-13', time: '08:00', course: 'Pattaya Country Club', bookingRef: 'PCC-091325-008', groupName: 'Peter Park Morning Round', players: ['Peter Park','Sarah Chen'], playerName: 'Peter Park', hasCaddy: false },
        { id: 9, date: '2025-09-13', time: '13:30', course: 'Pattana Golf Resort', bookingRef: 'PGR-091325-009', groupName: 'Park Weekend', players: ['Peter Park','Lisa Park','Tom Park'], playerName: 'Peter Park', hasCaddy: false }
      ];

      const caddies = [
        { id: 101, name: 'Somchai Pattana', rating: 4.9, price: 1500, avatar: '🏌️‍♂️' },
        { id: 102, name: 'Ploy Nakamura',  rating: 4.8, price: 1800, avatar: '👩‍🦱' },
        { id: 103, name: 'Krit Thanakit',  rating: 4.7, price: 2000, avatar: '👨‍🦲' },
        { id: 104, name: 'Niran Suwan',    rating: 4.6, price: 1600, avatar: '👨‍🦳' },
        { id: 105, name: 'Mali Thongsuk',  rating: 4.9, price: 1900, avatar: '👩‍🦰' }
      ];

      const getExternalBookingsForTeeTime = (teeTime) => {
        if (!teeTime) return [];
        if (teeTime.course === 'Pattaya Country Club' && teeTime.date === '2025-09-13') {
          return [
            { caddyId: 103, bookedBy: 'James Wilson', group: 'Wilson Brothers Golf' },
            { caddyId: 104, bookedBy: 'Lisa Zhang', group: 'Zhang Family Round' }
          ];
        }
        if (teeTime.course === 'Pattana Golf Resort' && teeTime.date === '2025-09-13') {
          return [ { caddyId: 102, bookedBy: 'Mike Torres', group: 'Torres Family' } ];
        }
        return [];
      };

      const formatDate = (s) => {
        const d = new Date(s);
        return isNaN(d.getTime()) ? s : d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
      };

      const normalizeDate = (v) => {
        if (!v) return '';
        if (v.includes('-')) return v;
        if (v.includes('/')) { const [mm, dd, yy] = v.split('/'); return `${yy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`; }
        return v;
      };

      const handleInputChange = (field, value) => setSearchForm(prev => ({ ...prev, [field]: value }));

      const handleSearch = () => {
        setSearchPerformed(true);
        let results = teeTimes;
        if (searchForm.nameGroup && searchForm.nameGroup.trim()) {
          const s = searchForm.nameGroup.toLowerCase();
          results = results.filter(t =>
            t.groupName.toLowerCase().includes(s) ||
            t.players.some(p => p.toLowerCase().includes(s)) ||
            t.bookingRef.toLowerCase().includes(s)
          );
        }
        if (searchForm.course && searchForm.course !== 'All Courses') {
          results = results.filter(t => t.course === searchForm.course);
        }
        if (searchForm.date) {
          const searchDate = normalizeDate(searchForm.date);
          results = results.filter(t => t.date === searchDate);
        }
        setSearchResults(results);
      };

      const handleSelectTeeTime = (teeTime) => {
        setSelectedTeeTime(teeTime);
        setCaddyNumber(''); setCaddyLookup(null);
        if (!playerOptions.length) {
          setAssignPlayer(teeTime.players?.[0] || 'Peter Park');
        }
      };

      const handleBookCaddy = (caddy) => {
        if (!caddy || !selectedTeeTime || !assignPlayer) return;
        setDisplayedCaddy(caddy);
        setTimeout(() => setBookingComplete(true), 300);
      };

      const handleJoinWaitlist = (caddy) => {
        if (!caddy || !selectedTeeTime || !assignPlayer) return;
        setDisplayedCaddy(caddy);
        setTimeout(() => setWaitlistComplete(true), 300);
      };

      const handleReset = () => {
        setSearchForm({ nameGroup: '', course: '', date: '' });
        setSearchResults([]);
        setSelectedTeeTime(initialTeeTime || null);
        setDisplayedCaddy(null);
        setBookingComplete(false);
        setWaitlistComplete(false);
        setSearchPerformed(false);
        setCaddyNumber(''); setCaddyLookup(null);
        onComplete && onComplete();
      };

      // In-group booked map keyed by caddyId -> player name (exclude current player's own booking)
      const reservedByGroup = useMemo(() => {
        const map = {};
        Object.entries(groupBookedMap || {}).forEach(([player, cid]) => {
          if (!cid) return;
          if (player === assignPlayer) return; // allow own booked id
          map[cid] = player;
        });
        return map;
      }, [groupBookedMap, assignPlayer]);

      // Lookup caddy as you type (conflict-aware)
      useEffect(() => {
        if (!caddyNumber || !selectedTeeTime) { setCaddyLookup(null); return; }
        const num = String(caddyNumber).trim();
        const c = caddies.find(cc => String(cc.id) === num);
        if (!c) { setCaddyLookup({ notFound: true }); return; }

        const external = getExternalBookingsForTeeTime(selectedTeeTime);
        const ext = external.find(b => b.caddyId === c.id);
        const inGroupBy = reservedByGroup[c.id];
        const isAvailable = !ext && !inGroupBy;

        setCaddyLookup({
          caddy: c,
          isAvailable,
          bookedBy: ext ? ext.bookedBy : (inGroupBy ? inGroupBy + ' (your group)' : null),
          bookedGroup: ext ? ext.group : (inGroupBy ? selectedTeeTime?.groupName || 'Your Group' : null),
          inGroup: Boolean(inGroupBy)
        });
      }, [caddyNumber, selectedTeeTime, reservedByGroup]);

      // Notify parent on success (include the player)
      useEffect(() => {
        if (bookingComplete && displayedCaddy && selectedTeeTime) {
          onBooked && onBooked({ teeTime: selectedTeeTime, caddy: displayedCaddy, player: assignPlayer });
          const t = setTimeout(() => onComplete && onComplete(), 800);
          return () => clearTimeout(t);
        }
      }, [bookingComplete]);

      useEffect(() => {
        if (waitlistComplete && displayedCaddy && selectedTeeTime) {
          onWaitlisted && onWaitlisted({ teeTime: selectedTeeTime, caddy: displayedCaddy, player: assignPlayer });
          const t = setTimeout(() => onComplete && onComplete(), 800);
          return () => clearTimeout(t);
        }
      }, [waitlistComplete]);

      // --- Success / Waitlist screens ---
      if (bookingComplete) {
        return (
          <div className="min-h-[40vh] bg-gray-50 flex items-center justify-center">
            <div className="bg-white rounded-lg shadow-lg p-8 max-w-md w-full mx-4 text-center">
              <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><CheckCircle /></div>
              <h2 className="text-2xl font-bold text-gray-900 mb-2">Caddy Booked!</h2>
              <p className="text-gray-600 mb-4">Caddy #{displayedCaddy.id} {displayedCaddy.name} is confirmed for <span className="font-semibold">{assignPlayer}</span></p>
              <div className="bg-gray-50 rounded-lg p-4 mb-6">
                <div className="text-sm text-gray-600 space-y-1">
                  <div>{selectedTeeTime.date}</div>
                  <div>{selectedTeeTime.time} • {selectedTeeTime.course}</div>
                  <div>Group: {selectedTeeTime.groupName}</div>
                  <div className="font-semibold">Total: ฿{displayedCaddy.price}</div>
                </div>
              </div>
              <button onClick={handleReset} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors">Return to Schedule</button>
            </div>
          </div>
        );
      }
      if (waitlistComplete) {
        return (
          <div className="min-h-[40vh] bg-gray-50 flex items-center justify-center">
            <div className="bg-white rounded-lg shadow-lg p-8 max-w-md w-full mx-4 text-center">
              <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"><Timer /></div>
              <h2 className="text-2xl font-bold text-gray-900 mb-2">Added to Waitlist</h2>
              <p className="text-gray-600 mb-4"><span className="font-semibold">{assignPlayer}</span> is #1 in line for Caddy #{displayedCaddy.id} {displayedCaddy.name}</p>
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <p className="text-blue-800 text-sm font-medium">⚡ Auto-Booking Enabled</p>
                <p className="text-blue-700 text-sm mt-1">If this caddy becomes available, we'll automatically book them for {assignPlayer} and keep any backup booking unless you remove it.</p>
              </div>
              <div className="bg-gray-50 rounded-lg p-4 mb-6">
                <div className="text-sm text-gray-600 space-y-1">
                  <div>{selectedTeeTime.date}</div>
                  <div>{selectedTeeTime.time} • {selectedTeeTime.course}</div>
                  <div>Group: {selectedTeeTime.groupName}</div>
                </div>
              </div>
              <button onClick={handleReset} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors">Return to Schedule</button>
            </div>
          </div>
        );
      }

      // --- Caddy Selection Screen (with player select + caddy# search) ---
      if (selectedTeeTime) {
        const external = getExternalBookingsForTeeTime(selectedTeeTime);

        // Helper to compute conflict for a given caddy id
        const conflictInfo = (cid) => {
          const ext = external.find(b => b.caddyId === cid);
          if (ext) return { type: 'external', bookedBy: ext.bookedBy, group: ext.group };
          const inGroupBy = reservedByGroup[cid];
          if (inGroupBy) return { type: 'inGroup', bookedBy: inGroupBy, group: selectedTeeTime?.groupName || 'Your Group' };
          return null;
        };

        const availableCount = 5 - external.length - Object.keys(reservedByGroup).length; // demo math

        return (
          <div className="min-h-[40vh]">
            <div className="bg-white shadow-sm border-b px-6 py-4">
              <div className="flex items-center justify-between">
                <div>
                  <h1 className="text-xl font-bold text-gray-900">Book Caddy</h1>
                  <p className="text-sm text-gray-600">{selectedTeeTime.date} • {selectedTeeTime.time} • {selectedTeeTime.course}</p>
                  <p className="text-sm text-gray-500">Group: {selectedTeeTime.groupName}</p>
                </div>
                <button onClick={() => setSelectedTeeTime(null)} className="text-gray-600 hover:text-gray-800">← Back</button>
              </div>
            </div>

            <div className="px-6 py-6">
              <div className="max-w-4xl mx-auto space-y-6">
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="flex flex-wrap items-end gap-4">
                    <div className="flex-1">
                      <h3 className="text-lg font-semibold text-gray-900 mb-2">Caddy Selection for {selectedTeeTime.date} at {selectedTeeTime.time}</h3>
                      <div className="flex items-center flex-wrap gap-6 text-sm text-gray-600">
                        <div className="flex items-center space-x-2"><div className="w-3 h-3 bg-green-200 rounded"></div><span>Available ({Math.max(0, availableCount)})</span></div>
                        <div className="flex items-center space-x-2"><div className="w-3 h-3 bg-red-200 rounded"></div><span>Booked (external + in‑group)</span></div>
                      </div>
                    </div>
                    {/* Player assignment select */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Assign to Player</label>
                      <select className="px-3 py-2 border rounded" value={assignPlayer} onChange={e=>setAssignPlayer(e.target.value)}>
                        {(playerOptions.length ? playerOptions : (selectedTeeTime.players || ['Peter Park'])).map(p => <option key={p} value={p}>{p}</option>)}
                      </select>
                    </div>
                  </div>

                  {/* Caddy number quick search */}
                  <div className="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Find a specific caddy by number</label>
                    <div className="flex gap-2">
                      <input type="number" inputMode="numeric" placeholder="e.g., 101" value={caddyNumber} onChange={(e)=>setCaddyNumber(e.target.value)} className="w-40 px-3 py-2 border rounded" />
                      <button onClick={()=>{}} className="px-3 py-2 bg-gray-100 rounded hover:bg-gray-200">Check</button>
                    </div>
                    {caddyNumber && (
                      <div className="mt-3">
                        {caddyLookup?.notFound ? (
                          <div className="text-sm text-red-600">Caddy #{caddyNumber} not found.</div>
                        ) : caddyLookup?.caddy ? (
                          <div className={'mt-2 p-3 rounded-lg border ' + (caddyLookup.isAvailable ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200')}>
                            <div className="flex items-center justify-between">
                              <div className="flex items-center gap-3">
                                <div className={'text-2xl ' + (caddyLookup.isAvailable ? '' : 'grayscale')}>{caddyLookup.caddy.avatar}</div>
                                <div>
                                  <div className="font-semibold text-gray-900">#{caddyLookup.caddy.id} {caddyLookup.caddy.name}</div>
                                  <div className="text-sm text-gray-600">⭐ {caddyLookup.caddy.rating} • ฿{caddyLookup.caddy.price}</div>
                                  {!caddyLookup.isAvailable && (
                                    <div className="text-xs text-red-700 mt-1">Booked by: {caddyLookup.bookedBy}{caddyLookup.inGroup ? '' : ''} • {caddyLookup.bookedGroup}</div>
                                  )}
                                </div>
                              </div>
                              <div className="flex items-center gap-2">
                                {caddyLookup.isAvailable ? (
                                  <button onClick={()=>handleBookCaddy(caddyLookup.caddy)} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">Book Now for {assignPlayer}</button>
                                ) : (
                                  <>
                                    <div className="px-2 py-1 rounded bg-red-100 text-red-700 text-xs">Not Available</div>
                                    <button onClick={()=>handleJoinWaitlist(caddyLookup.caddy)} className="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm">Join Waitlist for {assignPlayer}</button>
                                  </>
                                )}
                              </div>
                            </div>
                          </div>
                        ) : (
                          <div className="text-sm text-gray-500">Enter a caddy number to check availability.</div>
                        )}
                      </div>
                    )}
                  </div>
                </div>

                {/* Full caddy list */}
                <CaddyList
                  caddies={[
                    { id: 101, name: 'Somchai Pattana', rating: 4.9, price: 1500, avatar: '🏌️‍♂️' },
                    { id: 102, name: 'Ploy Nakamura',  rating: 4.8, price: 1800, avatar: '👩‍🦱' },
                    { id: 103, name: 'Krit Thanakit',  rating: 4.7, price: 2000, avatar: '👨‍🦲' },
                    { id: 104, name: 'Niran Suwan',    rating: 4.6, price: 1600, avatar: '👨‍🦳' },
                    { id: 105, name: 'Mali Thongsuk',  rating: 4.9, price: 1900, avatar: '👩‍🦰' }
                  ]}
                  conflictInfo={conflictInfo}
                  handleBookCaddy={handleBookCaddy}
                  handleJoinWaitlist={handleJoinWaitlist}
                  assignPlayer={assignPlayer}
                />
              </div>
            </div>
          </div>
        );
      }

      // --- Select Tee Time ---
      if (searchResults.length > 0) {
        return (
          <div className="min-h-[40vh]">
            <div className="bg-white shadow-sm border-b px-6 py-4">
              <div className="flex items-center justify-between">
                <div>
                  <h1 className="text-xl font-bold text-gray-900">Select Your Tee Time</h1>
                  <p className="text-sm text-gray-600">Found {searchResults.length} tee time(s)</p>
                </div>
                <button onClick={handleReset} className="text-gray-600 hover:text-gray-800">← New Search</button>
              </div>
            </div>
            <div className="px-6 py-6 space-y-4">
              {searchResults.map(teeTime => {
                return (
                  <div key={teeTime.id} className="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                    <div className="flex items-center justify-between">
                      <div>
                        <div className="flex items-center space-x-4 mb-2">
                          <h3 className="text-xl font-semibold text-gray-900">{teeTime.groupName}</h3>
                          {teeTime.hasCaddy && <span className="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">Caddy Booked</span>}
                        </div>
                        <div className="grid grid-cols-2 gap-4 text-sm text-gray-600">
                          <div className="flex items-center space-x-2"><Calendar /><span>{teeTime.date}</span></div>
                          <div className="flex items-center space-x-2"><Clock /><span>{teeTime.time}</span></div>
                          <div className="flex items-center space-x-2"><MapPin /><span>{teeTime.course}</span></div>
                          <div><span>Ref: {teeTime.bookingRef}</span></div>
                        </div>
                        <div className="mt-2 text-sm text-gray-500">Players: {teeTime.players.join(', ')}</div>
                      </div>
                      <div>
                        <button onClick={() => setSelectedTeeTime(teeTime)} disabled={teeTime.hasCaddy} className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-medium">{teeTime.hasCaddy ? 'Already Booked' : 'Book Caddy'}</button>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      // --- Main Search ---
      return (
        <div className="min-h-[40vh] bg-gray-50">
          <div className="bg-white rounded-lg shadow-lg p-8 w-full">
            <div className="text-center mb-6">
              <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"><User /></div>
              <h1 className="text-2xl font-bold text-gray-900 mb-2">Caddy Booking</h1>
              <p className="text-gray-600">Search across 300+ golf courses</p>
            </div>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Name / Group Name / Booking Reference</label>
                <input type="text" placeholder="Enter player name, group name, or booking reference" value={searchForm.nameGroup} onChange={(e)=>handleInputChange('nameGroup', e.target.value)} className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Golf Course</label>
                <div className="relative">
                  <select value={searchForm.course} onChange={(e)=>handleInputChange('course', e.target.value)} className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none bg-white">
                    {golfCourses.map(course => <option key={course} value={course}>{course}</option>)}
                  </select>
                  <span className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">▾</span>
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Date (Optional)</label>
                <input type="date" value={searchForm.date} onChange={(e)=>handleInputChange('date', e.target.value)} className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
              </div>
              <button onClick={handleSearch} disabled={!searchForm.nameGroup.trim()} className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white py-3 rounded-lg font-medium flex items-center justify-center space-x-2"><Search /><span>Search Tee Times</span></button>
            </div>
            {searchPerformed && searchResults.length === 0 && <div className="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center"><p className="text-yellow-800 text-sm">No tee times found. Try adjusting your search criteria.</p></div>}
          </div>
        </div>
      );
    };

    // Caddy list component
    const CaddyList = ({ caddies, conflictInfo, handleBookCaddy, handleJoinWaitlist, assignPlayer }) => {
      return (
        <div className="space-y-4">
          {caddies.map(caddy => {
            const conflict = conflictInfo(caddy.id);
            const isAvailable = !conflict;
            return (
              <div key={caddy.id} className={'bg-white rounded-lg shadow-sm p-4 border-2 ' + (isAvailable ? 'border-green-200' : 'border-red-200')}>
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-4 flex-1">
                    <div className={'text-3xl ' + (!isAvailable ? 'grayscale' : '')}>{caddy.avatar}</div>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center space-x-3 mb-1">
                        <h4 className="text-lg font-semibold text-gray-900">#{caddy.id} {caddy.name}</h4>
                        <span className={'px-2 py-1 rounded-full text-xs font-medium ' + (isAvailable ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800')}>{isAvailable ? 'AVAILABLE' : 'BOOKED'}</span>
                      </div>
                      <div className="flex items-center space-x-4 text-sm text-gray-600 mb-2">
                        <div className="flex items-center space-x-1"><Star /><span>{caddy.rating}</span></div>
                        <span className="font-semibold text-lg text-gray-900">฿{caddy.price}</span>
                      </div>
                      {!isAvailable && conflict && (
                        <div className="text-xs text-red-600">
                          <div>Booked by: {conflict.bookedBy}{conflict.type==='inGroup' ? ' (your group)' : ''}</div>
                          <div className="text-red-500">Group: {conflict.group}</div>
                        </div>
                      )}
                    </div>
                  </div>
                  <div className="flex flex-col space-y-2 ml-4">
                    {isAvailable ? (
                      <button onClick={() => handleBookCaddy(caddy)} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm min-w-[140px]">Book for {assignPlayer}</button>
                    ) : (
                      <div className="bg-red-50 border border-red-200 rounded-lg p-2 text-center min-w-[140px]">
                        <div className="text-red-800 text-xs font-medium">Not Available</div>
                      </div>
                    )}
                    <button onClick={() => handleJoinWaitlist(caddy)} className="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm min-w-[140px]">Waitlist for {assignPlayer}</button>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      );
    };

    // -------- Schedule App (per-player assignments + in-group conflicts) --------
    const ScheduleApp = () => {
      const [showDrawer, setShowDrawer] = useState(false);
      const [changingBooking, setChangingBooking] = useState(null); // {id, player}
      const [showDetails, setShowDetails] = useState(false);
      const [activeBooking, setActiveBooking] = useState(null);
      const [editMode, setEditMode] = useState(false);
      const [bookings, setBookings] = useState([
        {
          id: 'd1',
          date: '2025-09-12', time: '06:00', course: 'Pattaya Country Club',
          groupName: 'Torres Weekend', bookingRef: 'PCC-091225-004',
          players: ['Michael Torres','Alex Rodriguez'],
          assignments: { 'Michael Torres': { booked: null, waitlist: [] }, 'Alex Rodriguez': { booked: null, waitlist: [] } }
        },
        {
          id: 'd2',
          date: '2025-09-13', time: '08:00', course: 'Pattaya Country Club',
          groupName: 'Peter Park Morning Round', bookingRef: 'PCC-091325-008',
          players: ['Peter Park','Sarah Chen'],
          assignments: { 'Peter Park': { booked: { id: 101, name: 'Somchai Pattana' }, waitlist: [{id:104, name:'Niran Suwan'}] }, 'Sarah Chen': { booked: null, waitlist: [] } }
        },
        {
          id: 'd3',
          date: '2025-09-13', time: '13:30', course: 'Pattana Golf Resort',
          groupName: 'Park Weekend', bookingRef: 'PGR-091325-009',
          players: ['Peter Park','Lisa Park','Tom Park'],
          assignments: { 'Peter Park': { booked: null, waitlist: [] }, 'Lisa Park': { booked: null, waitlist: [] }, 'Tom Park': { booked: null, waitlist: [] } }
        },
      ]);

      const formatShort = (s) => {
        const d = new Date(s);
        return isNaN(d.getTime()) ? s : d.toLocaleDateString('en-US', { month:'short', day:'2-digit' });
      };

      const openDetails = (b) => { setActiveBooking(b); setEditMode(false); setShowDetails(true); };

      const saveEdit = () => {
        if (!activeBooking) return;
        setBookings(prev => prev.map(b => b.id === activeBooking.id ? activeBooking : b));
        setEditMode(false);
        setShowDetails(false);
      };

      const deleteBooking = (id) => {
        if (!confirm('Delete this booking?')) return;
        setBookings(prev => prev.filter(b => b.id !== id));
        setShowDetails(false);
      };

      const removeCaddyFor = (id, player) => {
        setBookings(prev => prev.map(b => {
          if (b.id !== id) return b;
          const next = { ...b, assignments: { ...b.assignments } };
          next.assignments[player] = { ...next.assignments[player], booked: null };
          return next;
        }));
        if (activeBooking && activeBooking.id === id) {
          setActiveBooking(prev => {
            const n = { ...prev, assignments: { ...prev.assignments } };
            n.assignments[player] = { ...n.assignments[player], booked: null };
            return n;
          });
        }
      };

      const removeWaitlistFor = (id, player, index=null) => {
        setBookings(prev => prev.map(b => {
          if (b.id !== id) return b;
          const next = { ...b, assignments: { ...b.assignments } };
          if (index === null) next.assignments[player] = { ...next.assignments[player], waitlist: [] };
          else next.assignments[player] = { ...next.assignments[player], waitlist: next.assignments[player].waitlist.filter((_,i)=>i!==index) };
          return next;
        }));
        if (activeBooking && activeBooking.id === id) {
          setActiveBooking(prev => {
            const n = { ...prev, assignments: { ...prev.assignments } };
            if (index === null) n.assignments[player] = { ...n.assignments[player], waitlist: [] };
            else n.assignments[player] = { ...n.assignments[player], waitlist: n.assignments[player].waitlist.filter((_,i)=>i!==index) };
            return n;
          });
        }
      };

      const handleBooked = ({ teeTime, caddy, player }) => {
        if (changingBooking) {
          setBookings(prev => prev.map(b => {
            if (b.id !== changingBooking.id) return b;
            const next = { ...b, assignments: { ...b.assignments } };
            const old = next.assignments[player] || { booked: null, waitlist: [] };
            next.assignments[player] = { ...old, booked: { id: caddy.id, name: caddy.name } };
            return next;
          }));
          if (activeBooking && activeBooking.id === changingBooking.id) {
            setActiveBooking(prev => {
              const n = { ...prev, assignments: { ...prev.assignments } };
              const old = n.assignments[player] || { booked: null, waitlist: [] };
              n.assignments[player] = { ...old, booked: { id: caddy.id, name: caddy.name } };
              return n;
            });
          }
          setChangingBooking(null);
          setShowDrawer(false);
        } else {
          const idx = bookings.findIndex(b => b.date===teeTime.date && b.time===teeTime.time && b.course===teeTime.course && b.groupName===teeTime.groupName);
          if (idx >= 0) {
            setBookings(prev => prev.map((b,i) => {
              if (i !== idx) return b;
              const next = { ...b, assignments: { ...b.assignments } };
              const old = next.assignments[player] || { booked: null, waitlist: [] };
              next.assignments[player] = { ...old, booked: { id: caddy.id, name: caddy.name } };
              return next;
            }));
          } else {
            const basePlayers = teeTime.players || [player];
            const baseAssignments = Object.fromEntries(basePlayers.map(p => [p, { booked: null, waitlist: [] }]));
            baseAssignments[player] = { booked: { id: caddy.id, name: caddy.name }, waitlist: [] };
            const newB = { id: 'new-'+Date.now(), date: teeTime.date, time: teeTime.time, course: teeTime.course, groupName: teeTime.groupName, bookingRef: teeTime.bookingRef, players: basePlayers, assignments: baseAssignments };
            setBookings(prev => [newB, ...prev]);
          }
          setShowDrawer(false);
        }
      };

      const handleWaitlisted = ({ teeTime, caddy, player }) => {
        if (changingBooking) {
          setBookings(prev => prev.map(b => {
            if (b.id !== changingBooking.id) return b;
            const next = { ...b, assignments: { ...b.assignments } };
            const old = next.assignments[player] || { booked: null, waitlist: [] };
            const exists = old.waitlist.some(w => w.id === caddy.id);
            next.assignments[player] = { ...old, waitlist: exists ? old.waitlist : [...old.waitlist, { id: caddy.id, name: caddy.name }] };
            return next;
          }));
          if (activeBooking && activeBooking.id === changingBooking.id) {
            setActiveBooking(prev => {
              const old = prev.assignments[player] || { booked: null, waitlist: [] };
              const exists = old.waitlist.some(w => w.id === caddy.id);
              const n = { ...prev, assignments: { ...prev.assignments, [player]: { ...old, waitlist: exists ? old.waitlist : [...old.waitlist, { id: caddy.id, name: caddy.name }] } } };
              return n;
            });
          }
          setChangingBooking(null);
          setShowDrawer(false);
        } else {
          const idx = bookings.findIndex(b => b.date===teeTime.date && b.time===teeTime.time && b.course===teeTime.course && b.groupName===teeTime.groupName);
          if (idx >= 0) {
            setBookings(prev => prev.map((b,i) => {
              if (i !== idx) return b;
              const next = { ...b, assignments: { ...b.assignments } };
              const old = next.assignments[player] || { booked: null, waitlist: [] };
              const exists = old.waitlist.some(w => w.id === caddy.id);
              next.assignments[player] = { ...old, waitlist: exists ? old.waitlist : [...old.waitlist, { id: caddy.id, name: caddy.name }] };
              return next;
            }));
          } else {
            const basePlayers = teeTime.players || [player];
            const baseAssignments = Object.fromEntries(basePlayers.map(p => [p, { booked: null, waitlist: [] }]));
            baseAssignments[player] = { booked: null, waitlist: [{ id: caddy.id, name: caddy.name }] };
            const newB = { id: 'new-'+Date.now(), date: teeTime.date, time: teeTime.time, course: teeTime.course, groupName: teeTime.groupName, bookingRef: teeTime.bookingRef, players: basePlayers, assignments: baseAssignments };
            setBookings(prev => [newB, ...prev]);
          }
          setShowDrawer(false);
        }
      };

      const openChangeCaddy = (booking, player) => {
        setChangingBooking({ id: booking.id, player });
        setShowDrawer(true);
        setActiveBooking(booking);
      };

      const courseOptions = [
        'Pattaya Country Club','Pattana Golf Resort','Laem Chabang International Country Club',
        'Phoenix Gold & Country Club','Thai Country Club'
      ];

      const initialTee = changingBooking && activeBooking ? {
        id: 'tee-' + activeBooking.id,
        date: activeBooking.date,
        time: activeBooking.time,
        course: activeBooking.course,
        groupName: activeBooking.groupName,
        bookingRef: activeBooking.bookingRef,
        players: activeBooking.players
      } : null;

      const initialPlayer = changingBooking?.player || (activeBooking?.players?.[0] || 'Peter Park');

      // Build in-group booked map: player -> caddyId
      const groupBookedMap = useMemo(() => {
        if (!changingBooking || !activeBooking) return {};
        const m = {};
        Object.entries(activeBooking.assignments || {}).forEach(([p, a]) => {
          m[p] = a?.booked?.id || null;
        });
        return m;
      }, [changingBooking, activeBooking]);

      return (
        <div>
          {/* Header */}
          <div className="bg-white rounded-xl border p-4 mb-4 flex items-center justify-between">
            <div>
              <h2 className="text-lg font-semibold text-gray-900">Schedule</h2>
              <p className="text-sm text-gray-500">Your upcoming rounds &amp; caddy bookings</p>
            </div>
            <button onClick={() => { setChangingBooking(null); setShowDrawer(true); }} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">Book Caddy</button>
          </div>

          {/* Bookings list */}
          <div className="bg-white rounded-xl border p-4 mb-6">
            <h3 className="font-semibold text-gray-900 mb-2">Your Bookings</h3>
            {bookings.length === 0 ? (
              <p className="text-sm text-gray-500">No upcoming rounds.</p>
            ) : (
              <ul className="divide-y divide-gray-100">
                {bookings.map(b => (
                  <li key={b.id} className="py-2">
                    <div className="flex items-center justify-between">
                      <button className="flex items-center space-x-3 text-left hover:bg-gray-50 rounded px-2 py-1 flex-1" onClick={() => openDetails(b)}>
                        <div className="w-24 text-gray-700">{formatShort(b.date)} {b.time}</div>
                        <div className="text-blue-700 underline">{b.course}</div>
                        <div className="text-gray-500">— {b.players.length} player{b.players.length>1?'s':''}</div>
                        <div className="flex flex-wrap gap-1 ml-2">
                          {b.players.slice(0,3).map(p => {
                            const a = b.assignments[p] || { booked: null, waitlist: [] };
                            return (
                              <div key={p} className="flex items-center gap-1 text-xs">
                                <span className="px-1.5 py-0.5 bg-gray-100 rounded">{p.split(' ')[0]}</span>
                                {a.booked && <span className="px-1.5 py-0.5 bg-green-100 text-green-700 rounded">C#{a.booked.id}</span>}
                                {a.waitlist?.length>0 && <span className="px-1.5 py-0.5 bg-yellow-100 text-yellow-700 rounded">WL#{a.waitlist[0].id}{a.waitlist.length>1?`+${a.waitlist.length-1}`:''}</span>}
                              </div>
                            );
                          })}
                        </div>
                      </button>
                      <div className="flex items-center gap-2">
                        <button className="text-blue-600 hover:text-blue-700 text-sm" onClick={() => openChangeCaddy(b, b.players[0])}>Change Caddy</button>
                        <button className="text-red-600 hover:text-red-700 text-sm" onClick={() => deleteBooking(b.id)}>Delete</button>
                      </div>
                    </div>
                  </li>
                ))}
              </ul>
            )}
          </div>

          {/* Details Modal */}
          {showDetails && activeBooking && (
            <div className="fixed inset-0 z-40">
              <div className="absolute inset-0 bg-black/30" onClick={() => setShowDetails(false)}></div>
              <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[95%] max-w-3xl bg-white rounded-xl shadow-2xl border">
                <div className="p-4 border-b flex items-center justify-between">
                  <h3 className="font-semibold text-gray-900">Booking Details</h3>
                  <button className="text-gray-600 hover:text-gray-800 text-sm" onClick={() => setShowDetails(false)}>Close ✕</button>
                </div>
                <div className="p-4 space-y-5">
                  <div className="grid grid-cols-2 gap-4 text-sm">
                    <div><span className="text-gray-500">Date:</span> <span className="font-medium">{activeBooking.date}</span></div>
                    <div><span className="text-gray-500">Time:</span> <span className="font-medium">{activeBooking.time}</span></div>
                    <div><span className="text-gray-500">Course:</span> <span className="font-medium">{activeBooking.course}</span></div>
                    <div><span className="text-gray-500">Booking Ref:</span> <span className="font-medium">{activeBooking.bookingRef || '-'}</span></div>
                    <div className="col-span-2"><span className="text-gray-500">Group:</span> <span className="font-medium">{activeBooking.groupName || '-'}</span></div>
                  </div>

                  <div>
                    <h4 className="font-semibold text-gray-900 mb-2">Player Caddy Assignments</h4>
                    <div className="overflow-x-auto border rounded-lg">
                      <table className="min-w-full text-sm">
                        <thead className="bg-gray-50 text-gray-600">
                          <tr>
                            <th className="text-left px-3 py-2">Player</th>
                            <th className="text-left px-3 py-2">Booked</th>
                            <th className="text-left px-3 py-2">Waitlist</th>
                            <th className="text-left px-3 py-2">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {activeBooking.players.map(p => {
                            const a = activeBooking.assignments[p] || { booked: null, waitlist: [] };
                            return (
                              <tr key={p} className="border-t">
                                <td className="px-3 py-2 font-medium text-gray-900">{p}</td>
                                <td className="px-3 py-2">
                                  {a.booked ? <span className="px-2 py-1 bg-green-100 text-green-700 rounded">#{a.booked.id} {a.booked.name}</span> : <span className="text-gray-500">—</span>}
                                </td>
                                <td className="px-3 py-2">
                                  {a.waitlist?.length ? (
                                    <div className="flex flex-wrap gap-1">
                                      {a.waitlist.map((w,idx) => (
                                        <span key={w.id} className="px-2 py-1 bg-yellow-100 text-yellow-700 rounded inline-flex items-center gap-1">
                                          #{w.id} {w.name}
                                          <button title="Remove" onClick={()=>removeWaitlistFor(activeBooking.id, p, idx)} className="text-yellow-800 hover:text-yellow-900">✕</button>
                                        </span>
                                      ))}
                                    </div>
                                  ) : <span className="text-gray-500">—</span>}
                                </td>
                                <td className="px-3 py-2">
                                  <div className="flex flex-wrap gap-2">
                                    <button className="text-blue-600 hover:text-blue-700" onClick={() => openChangeCaddy(activeBooking, p)}>Change / Add</button>
                                    {a.booked && <button className="text-gray-600 hover:text-gray-800" onClick={() => removeCaddyFor(activeBooking.id, p)}>Remove Caddy</button>}
                                    {a.waitlist?.length>0 && <button className="text-gray-600 hover:text-gray-800" onClick={() => removeWaitlistFor(activeBooking.id, p, null)}>Clear Waitlist</button>}
                                  </div>
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Drawer */}
          {showDrawer && (
            <div className="fixed inset-0 z-40">
              <div className="absolute inset-0 bg-black/30" onClick={() => { setShowDrawer(false); setChangingBooking(null); }}></div>
              <div className="absolute right-0 top-0 bottom-0 w-full sm:w-[640px] bg-white shadow-2xl flex flex-col">
                <div className="border-b p-4 flex items-center justify-between">
                  <h3 className="font-semibold text-gray-900">{changingBooking ? `Assign Caddy for ${initialPlayer}` : 'Book Caddy'}</h3>
                  <button onClick={() => { setShowDrawer(false); setChangingBooking(null); }} className="text-gray-600 hover:text-gray-800">Close ✕</button>
                </div>
                <div className="flex-1 overflow-y-auto p-4">
                  <CaddyBookingModule
                    initialTeeTime={initialTee}
                    playerOptions={initialTee?.players || []}
                    initialPlayer={initialPlayer}
                    groupBookedMap={groupBookedMap}
                    onComplete={() => { setShowDrawer(false); setChangingBooking(null); }}
                    onBooked={handleBooked}
                    onWaitlisted={handleWaitlisted}
                  />
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Mount
    const root = ReactDOM.createRoot(document.getElementById('schedule-react-root'));
    root.render(<ScheduleApp />);

    // Tabs
    const tabs = document.querySelectorAll('nav [data-tab]');
    function show(name){
      document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
      document.getElementById('panel-' + name).classList.remove('hidden');
      tabs.forEach(b => b.classList.toggle('border-blue-600', b.dataset.tab === name));
      tabs.forEach(b => b.classList.toggle('text-blue-700', b.dataset.tab === name));
    }
    tabs.forEach(b => b.addEventListener('click', () => show(b.dataset.tab)));
    document.getElementById('book-caddy-launch').addEventListener('click', () => show('schedule'));
;try{ window.ScheduleApp = ScheduleApp; }catch(_){}
</script>
<script type="text/babel" id="bookcaddy-v7-mount">
(function(){
  function mount(){
    var host = document.getElementById('schedule-react-root');
    if (!host || host.__mounted) return;
    if (!(window.React && window.ReactDOM && window.ScheduleApp)) return;
    var root = ReactDOM.createRoot(host);
    root.render(React.createElement(window.ScheduleApp));
    host.__mounted = true;
  }
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(mount);
  window.addEventListener('load', mount);
  window.__mountBookCaddyIntoSchedule = mount;
})();
</script>

</body>
</html>
<!-- === Society Admin: Manage Pairings + Editable Cap (v3) === -->
<script>
(function(){
  if (window.__soc_admin_pairings_cap_v3) return; window.__soc_admin_pairings_cap_v3 = true;
  var STORE='soc.events.v52';

  function load(){ try { return JSON.parse(localStorage.getItem(STORE)||'{}'); } catch(_) { return {}; } }
  function save(o){ try { localStorage.setItem(STORE, JSON.stringify(o)); window.dispatchEvent(new CustomEvent('soc:reg:update',{detail:o})); } catch(_){} }
  function hashId(s){ s=(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); return s||('evt-'+Date.now()); }

  // --- Pairing modal (vanilla JS, drag/drop) ---
  function buildModal(eid, meta){
    var S = load(); var E = S[eid] || { roster:[], pairs:{} };
    var roster = (E.roster||[]).map(function(p){ return Object.assign({}, p); });
    var pairs = E.pairs || {};

    var modal = document.createElement('div');
    modal.id='soc-admin-pairings-modal';
    modal.style.cssText='position:fixed;inset:0;z-index:100000;display:flex;align-items:center;justify-content:center;';
    modal.innerHTML = '<div style="position:absolute;inset:0;background:rgba(0,0,0,.4)"></div>' +
      '<div style="position:relative;background:#fff;border-radius:12px;box-shadow:0 24px 60px rgba(0,0,0,.25);width:min(1100px,96vw);max-height:90vh;padding:16px;overflow:hidden;font-family:system-ui,sans-serif">' +
        '<div style="display:flex;align-items:center;justify-content:space-between;padding-bottom:8px;border-bottom:1px solid #e5e7eb">' +
          '<div style="font-weight:700">Pairings • '+(meta&&meta.title||'')+'</div>' +
          '<button id="soc-close" style="padding:6px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer">Close</button>' +
        '</div>' +
        '<div style="display:grid;grid-template-columns:1fr 2fr;gap:12px;padding-top:12px;overflow:auto;max-height:70vh">' +
          '<div><div style="font-size:12px;font-weight:600;margin-bottom:4px">Unassigned</div><div id="soc-ua" style="min-height:48px;padding:8px;border:1px solid #e5e7eb;border-radius:10px;background:#f9fafb;display:grid;gap:6px"></div></div>' +
          '<div id="soc-groups" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px"></div>' +
        '</div>' +
        '<div style="padding-top:8px;border-top:1px solid #e5e7eb;margin-top:8px;font-size:11px;color:#6b7280">Drag players into groups (max 4). Wishes shown on cards.</div>' +
      '</div>';

    function cardHtml(p){
      var wants=(pairs[p.id]||[]).join(', ');
      return '<div draggable="true" data-id="'+p.id+'" style="padding:8px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)">'+
        '<div style="display:flex;align-items:center;justify-content:space-between"><div style="font-weight:600;font-size:12px">'+(p.name||p.id)+'</div><div style="font-size:11px;color:#6b7280">HCP '+(p.hc||'?')+'</div></div>'+
        (wants?'<div style="margin-top:2px;font-size:11px;color:#4b5563">wants: '+wants+'</div>':'')+
        (p.phone?'<div style="font-size:11px;color:#9ca3af">'+p.phone+'</div>':'')+
      '</div>';
    }
    function render(){
      var list = roster.map(function(p){ return Object.assign({},p); });
      var ua = list.filter(function(p){ return p.group==null; });
      var gs = {}; list.forEach(function(p){ var g=p.group==null?null:Number(p.group); if(g!=null){ (gs[g]=gs[g]||[]).push(p);} });
      var maxG = Math.max(6, Object.keys(gs).reduce(function(a,b){ return Math.max(a, Number(b)||0); }, 0));
      var groups = modal.querySelector('#soc-groups'); groups.innerHTML='';
      for (var i=1;i<=maxG;i++){
        var arr = gs[i]||[];
        groups.insertAdjacentHTML('beforeend',
          '<div><div style="font-size:12px;font-weight:600;margin-bottom:4px">Group '+i+' <span style="color:'+(arr.length>=4?'#dc2626':'#6b7280')+'">('+(arr.length)+'/4)</span></div>'+
          '<div class="soc-drop" data-gid="'+i+'" style="min-height:48px;padding:8px;border:1px solid #e5e7eb;border-radius:10px;background:'+(arr.length>=4?'#fef2f2':'#f9fafb')+';display:grid;gap:6px">'+
          (arr.map(cardHtml).join('') || '<div style="font-size:12px;color:#6b7280">Drop players here</div>')+
          '</div></div>');
      }
      var uaEl = modal.querySelector('#soc-ua'); uaEl.innerHTML = ua.map(cardHtml).join('');

      function onDragStart(e){ var t=e.target.closest('[draggable="true"]'); if(!t) return; e.dataTransfer.setData('text/plain', JSON.stringify({id:t.dataset.id})); }
      function onDrop(e){
        e.preventDefault();
        var payload=null; try{ payload=JSON.parse(e.dataTransfer.getData('text/plain')); }catch(_){ }
        if(!payload) return;
        var id = payload.id;
        var target = e.currentTarget;
        var gid = target.id==='soc-ua' ? null : Number(target.dataset.gid);
        var idx = roster.findIndex(function(p){ return String(p.id)===String(id); });
        if (idx<0) return;
        // enforce <=4
        if (gid!=null){
          var count = roster.filter(function(p){ return Number(p.group)===gid; }).length;
          if (count>=4){ try{ alert('Group '+gid+' is full (max 4).'); }catch(_){ } return; }
        }
        roster[idx].group = gid;
        var S = load(); var E = S[eid] || { roster:[], pairs:{} };
        var r = (E.roster||[]).map(function(p){ return Object.assign({}, p, {group:null}); });
        var ridx = r.findIndex(function(p){ return String(p.id)===String(id); });
        if (ridx>=0) r[ridx].group = gid;
        S[eid] = Object.assign({}, E, { roster:r });
        save(S);
        render();
        // also refresh counters on list
        try{ updateEventCounters(eid); }catch(_){ }
      }
      modal.querySelectorAll('[draggable="true"]').forEach(function(el){ el.addEventListener('dragstart', onDragStart); });
      modal.querySelectorAll('.soc-drop, #soc-ua').forEach(function(el){ el.addEventListener('dragover', function(e){ e.preventDefault(); }); el.addEventListener('drop', onDrop); });
    }

    modal.addEventListener('click', function(e){ if (e.target && (e.target.id==='soc-close' || e.target===modal.firstChild)) modal.remove(); });
    document.body.appendChild(modal);
    
    // Inject in-tab-row "×" close, scoped to THIS modal only
    try{
      var tabsRow = null;
      var nodes = modal.querySelectorAll('div,nav,header,section');
      for (var i=0;i<nodes.length;i++){
        var t = (nodes[i].textContent||'').replace(/\s+/g,' ').toLowerCase();
        if (t.includes('events') && t.includes('participants') && t.includes('pairings') && t.includes('analytics')){
          tabsRow = nodes[i]; break;
        }
      }
      if (tabsRow && !tabsRow.querySelector('#mcp_modal_inline_x')){
        var cs = getComputedStyle(tabsRow);
        if (cs.position === 'static') tabsRow.style.position = 'relative';
        var x = document.createElement('button');
        x.id = 'mcp_modal_inline_x';
        x.setAttribute('aria-label','Close');
        x.innerHTML = '&times;';
        x.style.cssText = 'position:absolute;right:12px;top:50%;transform:translateY(-50%);width:32px;height:32px;border-radius:9999px;border:1px solid #e5e7eb;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,.12);cursor:pointer;z-index:1001';
        x.addEventListener('click', function(){
          try{ modal.remove(); }catch(_){ if (modal && modal.parentNode) modal.parentNode.removeChild(modal); }
        });
        tabsRow.appendChild(x);
      }
    }catch(_){}
    render();
  }

  // --- seed mock roster if empty (only when Admin page is open) ---
  var MOCK_PLAYERS = [
    { id:'PP', name:'Peter Park', hc:12, phone:'081-111-1111' },
    { id:'SC', name:'Sarah Chen', hc:18, phone:'081-222-2222' },
    { id:'MB', name:'Michael Brown', hc: 9, phone:'081-333-3333' },
    { id:'ED', name:'Emily Davis', hc:22, phone:'081-444-4444' },
    { id:'JW', name:'Jessica Wilson', hc:15, phone:'081-555-5555' },
    { id:'DM', name:'David Miller', hc:10, phone:'081-666-6666' },
    { id:'JS', name:'John Smith', hc:13, phone:'081-777-7777' },
    { id:'RA', name:'Robert Anderson', hc:11, phone:'081-888-8888' },
    { id:'NS', name:'Ning Siriwan', hc:20, phone:'081-999-9999' },
    { id:'AG', name:'Alex Garcia', hc:17, phone:'081-000-1234' },
    { id:'PR', name:'Priya Patel', hc:19, phone:'082-101-0101' },
    { id:'LN', name:'Liam Nguyen', hc:14, phone:'082-202-0202' }
  ];
  var MOCK_PAIRS = { 'PP':['SC','MB'], 'SC':['PP','MB'], 'MB':['PP'], 'ED':['JW'], 'JW':['ED'], 'DM':[], 'JS':['RA'], 'RA':['JS'], 'NS':[], 'AG':['PR'], 'PR':['AG'], 'LN':[] };

  function ensureSeed(eid){
    var S=load(); var E=S[eid];
    if (!E || !Array.isArray(E.roster) || E.roster.length===0){
      S[eid] = { cap: 30, roster: MOCK_PLAYERS.map(function(p){ return Object.assign({}, p, {group:null}); }), pairs: MOCK_PAIRS };
      save(S);
    }
  }

  // --- Admin list wiring: Manage Pairings + editable Cap + live counters ---
  function deriveEventId(row, idx){
    var title = (row.querySelector('.font-medium, strong, h3') || {}).innerText || 'event';
    return 'evt-' + hashId(title) + '-' + idx;
  }

  function updateEventCounters(eid){
    var S = load(); var E = S[eid] || {};
    var rosterLen = Array.isArray(E.roster) ? E.roster.length : 0;
    var cap = Number(E.cap || 10);
    // Update badges
    document.querySelectorAll('[data-soc-id="'+eid+'"] .soc-count').forEach(function(el){
      el.textContent = rosterLen + ' / ' + cap;
    });
    // Try to update any existing "spots left" text and progress bar nearby
    document.querySelectorAll('[data-soc-id="'+eid+'"] .soc-spots').forEach(function(el){
      var left = Math.max(cap - rosterLen, 0);
      el.textContent = left + ' spots left of ' + cap;
    });
    document.querySelectorAll('[data-soc-id="'+eid+'"] .soc-progress').forEach(function(el){
      var pct = cap ? Math.round((rosterLen / cap) * 100) : 0;
      el.style.width = pct + '%';
      el.setAttribute('aria-valuenow', pct);
      var pctText = el.parentElement && el.parentElement.querySelector('.soc-pct');
      if (pctText) pctText.textContent = pct + '%';
    });
  }

  function wireAdminList(){
    var headers = Array.from(document.querySelectorAll('div,h2,h3')).filter(function(el){ return /Upcoming Society Events/i.test(el.textContent||''); });
    headers.forEach(function(h){
      var container = h.closest('div') || document.body;
      var rows = Array.from(container.querySelectorAll('div.py-3, div.py-2, div.border-b, div.divide-y > div')).filter(function(row){  try{    if (row.dataset && row.dataset.socWired==='1') return false;    var title = row.querySelector('.font-medium');    var hasProgress = row.querySelector('.w-full');    return !!(title && hasProgress);  }catch(_){ return false; }});
      Array.prototype.forEach.call(rows, function(row, idx){
        if (row.dataset && row.dataset.socWired==='1') return;
        // derive id
        var eid = deriveEventId(row, idx);
        row.dataset.socWired='1';
        row.setAttribute('data-soc-id', eid);

        // seed if empty (so counters show something)
        ensureSeed(eid);
        var S = load(); var E = S[eid] || {}; var rosterLen = Array.isArray(E.roster)?E.roster.length:0; var cap = Number(E.cap || 30);

        // right-side toolbar: count badge + Manage Pairings + Cap select
        var bar = document.createElement('div');
        bar.style.cssText = 'display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap;margin-top:4px';

        var count = document.createElement('span');
        count.className = 'soc-count';
        count.style.cssText = 'background:#111827;color:#fff;border-radius:999px;padding:2px 8px;font-size:12px';
        count.textContent = rosterLen + ' / ' + cap;
        bar.appendChild(count);

        var btn = document.createElement('button');
        btn.textContent = 'Manage Pairings';
        btn.style.cssText = 'padding:6px 10px;border:1px solid #111827;border-radius:8px;background:#111827;color:#fff;cursor:pointer;font-size:12px';
        btn.addEventListener('click', function(e){ e.stopPropagation(); var title=(row.querySelector(".font-medium, strong, h3")||{}).innerText||""; buildModal(eid, {title:title}); });
        bar.appendChild(btn);

        var sel = document.createElement('select');
        sel.title = 'Edit cap';
        sel.style.cssText = 'border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;font-size:12px;background:#fff';
        var options = [24, 30, 32, 36, 48, 60, 72];
        options.forEach(function(n){
          var o = document.createElement('option'); o.value = String(n); o.textContent = 'Cap ' + n;
          if (Number(n)===cap) o.selected = true;
          sel.appendChild(o);
        });
        var oCustom = document.createElement('option'); oCustom.value = 'custom'; oCustom.textContent = 'Custom…'; sel.appendChild(oCustom);
        sel.addEventListener('change', function(){
          var v = sel.value;
          var newCap = cap;
          if (v === 'custom'){ var inp = prompt('Enter cap (number):', String(cap)); if (inp && !isNaN(parseInt(inp,10))) newCap = parseInt(inp,10); else { sel.value = String(cap); return; } }
          else { newCap = parseInt(v,10); }
          var S2 = load(); var E2 = S2[eid] || { roster:[], pairs:{} };
          E2.cap = newCap; S2[eid] = E2; save(S2);
          updateEventCounters(eid);
        });
        bar.appendChild(sel);

        // Attach our bar at the end of this row container
        row.appendChild(bar);

        // Also update any "spots left" & progress if present (we add our own markers)
        // [fix] removed duplicate spots/progress injection

        // Click title also opens modal
        var titleEl = row.querySelector('.font-medium, strong, h3'); if (titleEl){ titleEl.style.cursor='pointer'; titleEl.addEventListener('click', function(){ var t=(titleEl.innerText||''); buildModal(eid, {title:t}); }); }

        // initial counters
        updateEventCounters(eid);
      });
    });
  }

  function boot(){ wireAdminList(); }
  if (document.readyState !== 'loading') boot();
  document.addEventListener('DOMContentLoaded', boot);
  // Keep it wired as the list updates
  var mo = new MutationObserver(boot); mo.observe(document.documentElement,{subtree:true, childList:true});
  setInterval(boot, 1500);
})();
</script>

<!-- BEGIN: Tee Sheet Integration (production) -->
<style id="v11-tee-style">


    /* ========== Tee Sheet ========== */
    #abcv11 h1{margin:0;font-size:18px}
    #abcv11 .sub{color:var(--muted);font-size:12px;margin:4px 0 10px}
    #abcv11 label{font-size:12px;color:var(--muted)}
    #abcv11 input,#abcv11 select,#abcv11 textarea{border:1px solid var(--border);border-radius:10px;padding:7px 9px;background:#fff;color:var(--ink);outline:none}
    #abcv11 button{border:1px solid var(--border);background:#f3f4f6;border-radius:10px;padding:8px 10px;cursor:pointer}
    #abcv11 button:hover{background:#eef2ff}
    #abcv11 .btn-primary{background:var(--brand);color:#fff;border-color:#1d4ed8}
    #abcv11 .iconbtn{width:34px;height:34px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center}

    #abcv11 .legend{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted);margin-top:6px}
    #abcv11 .legend span{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:4px}

    #abcv11 .tee-grid{display:grid;grid-template-columns:90px repeat(var(--cols), minmax(140px,1fr));gap:6px}
    #abcv11 .tee-header{position:sticky;top:0;background:#f9fafb;z-index:5;border-bottom:1px solid var(--border)}
    #abcv11 .time-cell{position:sticky;left:0;background:#f9fafb;border:1px dashed var(--border);border-radius:10px;padding:6px;text-align:center;font-size:12px;z-index:3}
    #abcv11 .col-title{padding:8px 6px;text-align:center;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:12px}
    #abcv11 .group-title{padding:8px 6px;text-align:center;border:1px solid var(--border);border-radius:10px;background:#eef2ff;font-weight:700;letter-spacing:.2px;font-size:12px}
    #abcv11 .slot{border:1px dashed var(--border);border-radius:10px;min-height:40px;position:relative;background:#fff}
    #abcv11 .slot.group-boundary{border-left:2px solid rgba(0,0,0,.28)}
    #abcv11 .slot:hover{background:#f8fafc}
    #abcv11 .pill{display:block;background:var(--pill);color:var(--pillink);border:1px solid #86efac;border-radius:10px;padding:5px 6px;margin:3px;font-size:12px;cursor:grab;line-height:1.2}
    .mono{font-variant-numeric:tabular-nums}
    .tag{padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}

    dialog::backdrop{background:rgba(0,0,0,.35)}
    dialog{border:none;border-radius:14px;box-shadow:0 14px 36px rgba(0,0,0,.2);padding:0;background:#fff}
    .m-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:#f8fafc}
    .m-body{padding:12px}
    .m-foot{padding:10px 12px;border-top:1px solid var(--border);background:#f8fafc;display:flex;gap:8px;justify-content:flex-end}

    /* Month picker */
    .mp-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
    .mp-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:12px}
    .mp-dow{font-size:11px;color:var(--muted);text-align:center}
    .mp-day{padding:8px 0;text-align:center;border:1px solid var(--border);border-radius:10px;cursor:pointer;background:#fff}
    .mp-day.muted{opacity:.6}
    .mp-day.today{border-color:var(--brand)}
    .mp-day:hover{background:#eff6ff}

    /* Utility */
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 260px}
    .right{margin-left:auto}
    .wrap{max-width:1280px;margin:0 auto}
  

/* === Tee Sheet Border Visibility Override (scoped to #abcv11) === */
#abcv11 {
  --v11-grid-border-visible: #9ca3af;  /* slate-400 for visibility */
  --v11-grid-border: #e5e7eb;
  --v11-surface: rgba(255,255,255,0.90);
  --v11-shadow-sm: 0 1px 2px rgba(0,0,0,.05);
  --v11-shadow-md: 0 4px 10px rgba(0,0,0,.06);
  --v11-radius-lg: 12px;
  --v11-radius-xl: 14px;
}
#abcv11 .card {
  background: var(--v11-surface);
  border: 1px solid var(--v11-grid-border);
  border-radius: var(--v11-radius-xl);
  box-shadow: var(--v11-shadow-sm), var(--v11-shadow-md);
  backdrop-filter: saturate(120%) blur(2px);
}
/* Grid borders */
#abcv11 .slot { border: 1.5px solid var(--v11-grid-border-visible) !important; }
#abcv11 .slot.group-boundary { border-left: 2px solid var(--v11-grid-border-visible) !important; }
#abcv11 .time-cell { border: 1.5px solid var(--v11-grid-border-visible) !important; }
#abcv11 .col-title { border: 1.5px solid var(--v11-grid-border-visible) !important; }
#abcv11 .group-title { border: 1.5px solid var(--v11-grid-border-visible) !important; }
/* Fallback for table separators */
#abcv11 table, #abcv11 th, #abcv11 td { border: 1px solid var(--v11-grid-border-visible) !important; }
/* Hover */
#abcv11 .slot:hover { background:#f8fafc; }
</style>

<script>
(function(){
  function injectOnce(host){
    if (!host || host.querySelector('#abcv11')) return;
    const markup = /* html */ `<div id="abcv11" class="wrap">
        <h1>Tee Sheet</h1>
        <div class="sub">A→D straight across • 18/27/36 hole complexes • 1–2 tees per course • 5/7/10/15 min intervals</div>

        <div class="card">
          <div class="row">
            <div>
              <label>Complex</label><br>
              <select id="v11-complex">
                <option value="18">18 holes (A/B)</option>
                <option value="27" selected>27 holes (A/B/C)</option>
                <option value="36">36 holes (A/B/C/D)</option>
              </select>
            </div>
            <div>
              <label>Date</label><br>
              <div class="row" style="gap:6px">
                <button id="v11-prevDay" class="iconbtn" title="Previous day">‹</button>
                <input type="date" id="v11-date">
                <button id="v11-nextDay" class="iconbtn" title="Next day">›</button>
                <button id="v11-openMonth" class="iconbtn" title="Open month picker">📅</button>
              </div>
            </div>
            <div><label>Start</label><br><input type="time" id="v11-start" value="06:00"></div>
            <div><label>End</label><br><input type="time" id="v11-end" value="18:00"></div>
            <div><label>Interval</label><br>
              <select id="v11-interval">
                <option value="5" selected>5 min</option>
                <option value="7">7 min</option>
                <option value="10">10 min</option>
                <option value="15">15 min</option>
              </select>
            </div>
            <div><label>Tees per Course</label><br>
              <select id="v11-teesPerCourse">
                <option value="1" selected>1</option>
                <option value="2">2</option>
              </select>
            </div>
            <div class="tag">Total Tees: <span id="v11-totalTeesTag">3</span></div>
            <div class="right"><button id="v11-clearDay">Clear Day</button></div>
            <div class="grow">
              <label>Golfer Name</label><br>
              <input id="v11-searchQuery" placeholder="Type golfer name or caddy number" style="width:100%">
              <div style="font-size:12px;color:var(--muted)">Press Enter to find; Next to jump to the following match.</div>
            </div>
            <div style="align-self:end"><label>&nbsp;</label><br><button id="v11-searchGo" class="btn-primary">Find</button></div>
            <div style="align-self:end"><label>&nbsp;</label><br><button id="v11-searchNext">Next</button></div>
            <div class="tag" style="align-self:end">Matches: <span id="v11-matchCount">0</span></div>
          </div>

          <div class="legend">
            <div><span class="lgA"></span>Course A</div>
            <div><span class="lgB"></span>Course B</div>
            <div id="v11-legC"><span class="lgC"></span>Course C</div>
            <div id="v11-legD" style="display:none"><span class="lgD"></span>Course D</div>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <div id="v11-sheet"></div>
        </div>
      </div>
<dialog id="v11-bookingDialog">
    <form method="dialog" id="v11-bookingForm">
      <div class="m-head">
        <div style="font-weight:800">Book Slot(s)</div>
        <button id="v11-closeDialog" type="button" class="iconbtn" title="Close">✕</button>
      </div>
      <div class="m-body">
        <input type="hidden" id="v11-bkId">
        <div class="row">
          <div class="grow"><label>Golfer Name</label><br><input id="v11-bkName" placeholder="Golfer name"></div>
          <div><label>Caddy Number</label><br><input id="v11-bkCaddy" placeholder="e.g., 27"></div>
          <div><label>Member ID</label><br><input id="v11-bkMid" placeholder="e.g., 004"></div>
          <div><label>Course</label><br><input id="v11-bkCourse" readonly style="width:84px"></div>
          <div><label>Tee #</label><br>
            <select id="v11-bkTeeNo"><option value="1">1</option><option value="2">2</option></select>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <div><label>From</label><br><input type="time" id="v11-bkFrom" class="mono"></div>
          <div><label>To</label><br><input type="time" id="v11-bkTo" class="mono"></div>
          <div style="align-self:end"><label>&nbsp;</label><br><label style="font-size:12px;color:#374151"><input type="checkbox" id="v11-bkApplyAll"> Apply details to all slots in range</label></div>
        </div>
        <div style="font-size:12px;color:var(--muted);margin-top:4px">Range aligns to the interval and clamped to Start/End.</div>
        <div style="margin-top:8px"><label>Notes</label><br><textarea id="v11-bkNotes" rows="3" style="width:100%"></textarea></div>
      </div>
      <div class="m-foot">
        <button id="v11-deleteBooking" type="button" style="background:#fff;border:1px solid #ef4444;color:#ef4444;border-radius:10px;padding:8px 12px;display:none">Delete</button>
        <button id="v11-saveBooking" class="btn-primary" value="default">Save</button>
      </div>
    </form>
  </dialog>
<dialog id="v11-monthPicker">
    <div class="mp-head">
      <button id="v11-mpPrev" class="iconbtn">‹</button>
      <div>
        <select id="v11-mpMonth"></select>
        <select id="v11-mpYear"></select>
      </div>
      <button id="v11-mpNext" class="iconbtn">›</button>
    </div>
    <div class="mp-grid" id="v11-mpGrid">
      <div class="mp-dow">Sun</div><div class="mp-dow">Mon</div><div class="mp-dow">Tue</div><div class="mp-dow">Wed</div><div class="mp-dow">Thu</div><div class="mp-dow">Fri</div><div class="mp-dow">Sat</div>
    </div>
  </dialog>
`;
    host.innerHTML = markup;
    try { (function(){
"use strict";


    // Helpers
    function pad2(n){ n=String(n); return n.length<2?("0"+n):n; }
    function minutes(hm){ var a=(hm||"").split(":").map(Number); return a[0]*60 + a[1]; }
    function hhmm(m){ return pad2(Math.floor(m/60))+":"+pad2(m%60); }
    function todayISO(){ var d=new Date(); return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); }
    function parseISO(s){ var a=(s||"").split("-").map(Number); return new Date(a[0]||NaN,(a[1]||1)-1,a[2]||NaN); }
    function genId(){ try{ return (crypto.getRandomValues(new Uint32Array(1))[0].toString(16)+Date.now().toString(16)); }catch(_){ return (Math.floor(Math.random()*1e9).toString(16)+Date.now().toString(16)); } }

    // DOM
    var $ = function(id){ return document.getElementById(id); };
    var el = {
      complex: $("v11-complex"), date: $("v11-date"), prev: $("v11-prevDay"), next: $("v11-nextDay"), openMonth: $("v11-openMonth"),
      start: $("v11-start"), end: $("v11-end"), interval: $("v11-interval"), tees: $("v11-teesPerCourse"),
      total: $("v11-totalTeesTag"), sheet: $("v11-sheet"), legC: $("v11-legC"), legD: $("v11-legD"),
      clear: $("v11-clearDay"),
      dlg: $("v11-bookingDialog"), id: $("v11-bkId"), name: $("v11-bkName"), caddy: $("v11-bkCaddy"), mid: $("v11-bkMid"),
      course: $("v11-bkCourse"), teeNo: $("v11-bkTeeNo"), from: $("v11-bkFrom"), to: $("v11-bkTo"), apply: $("v11-bkApplyAll"), notes: $("v11-bkNotes"),
      delBtn: $("v11-deleteBooking"), saveBtn: $("v11-saveBooking"), closeBtn: $("v11-closeDialog"),
      mp: $("v11-monthPicker"), mpPrev: $("v11-mpPrev"), mpNext: $("v11-mpNext"), mpM: $("v11-mpMonth"), mpY: $("v11-mpYear"), mpGrid: $("v11-mpGrid"),
      q: $("v11-searchQuery"), qGo: $("v11-searchGo"), qNext: $("v11-searchNext"), qCount: $("v11-matchCount")
    };

    // Storage
    var keyDay = function(d){ return "mctsheet.bookings.v12::"+d; };
    var keySettings = "mctsheet.settings.v12";
    function getDay(d){ try { return JSON.parse(localStorage.getItem(keyDay(d)) || "[]"); } catch(_){ return []; } }
    function setDay(d,a){ localStorage.setItem(keyDay(d), JSON.stringify(a||[])); }

    // Settings
    if(!el.date.value) el.date.value = todayISO();
    try {
      var s = JSON.parse(localStorage.getItem(keySettings) || "{}");
      ["complex","start","end","interval","tees","date"].forEach(function(k){ if(s[k]) el[k].value = s[k]; });
    } catch(_){}
    function saveSettings(){
      var s = { complex: el.complex.value, start: el.start.value, end: el.end.value, interval: el.interval.value, tees: el.tees.value, date: el.date.value };
      localStorage.setItem(keySettings, JSON.stringify(s));
    }

    // Layout
    function groups(){ var t = el.complex.value; if(t==="18") return ["A","B"]; if(t==="27") return ["A","B","C"]; return ["A","B","C","D"]; }
    function layout(){
      var gs = groups();
      var per = Math.max(1, Math.min(2, parseInt(el.tees.value||"1",10)));
      var cols = []; gs.forEach(function(g){ for(var i=0;i<per;i++) cols.push(g); });
      return { gs: gs, per: per, cols: cols, total: cols.length };
    }

    // Render
    function render(){
      saveSettings();
      var L = layout();
      el.total.textContent = L.total;
      el.legC.style.display = L.gs.indexOf("C")>=0 ? "" : "none";
      el.legD.style.display = L.gs.indexOf("D")>=0 ? "" : "none";
      el.sheet.style.setProperty("--cols", L.total);
      el.sheet.innerHTML = "";

      var header = document.createElement("div");
      header.className = "tee-grid tee-header";
      header.appendChild(document.createElement("div"));
      var within = {A:0,B:0,C:0,D:0};
      L.cols.forEach(function(g){
        within[g]++;
        var h = document.createElement("div");
        h.className = "col-title";
        h.textContent = g+"-"+within[g];
        header.appendChild(h);
      });
      el.sheet.appendChild(header);

      var ghead = document.createElement("div");
      ghead.className = "tee-grid";
      ghead.appendChild(document.createElement("div"));
      L.gs.forEach(function(g){
        var cell = document.createElement("div");
        cell.className = "group-title";
        cell.textContent = "Course "+g;
        if(g==="A") cell.style.background = "#d9f99d";
        if(g==="B") cell.style.background = "#bae6fd";
        if(g==="C") cell.style.background = "#fde68a";
        if(g==="D") cell.style.background = "#ddd6fe";
        cell.style.gridColumn = "span "+L.per;
        ghead.appendChild(cell);
      });
      el.sheet.appendChild(ghead);

      var startM = minutes(el.start.value), endM = minutes(el.end.value), step = +el.interval.value;
      var day = getDay(el.date.value);

      for(var m = startM; m <= endM; m += step){
        var row = document.createElement("div");
        row.className = "tee-grid";
        var label = hhmm(m);
        var tCell = document.createElement("div");
        tCell.className = "time-cell mono";
        tCell.textContent = label;
        row.appendChild(tCell);

        var count = {A:0,B:0,C:0,D:0};
        L.cols.forEach(function(g, idx){
          count[g]++;
          var slot = document.createElement("div");
          slot.className = "slot"+(count[g]===1?" group-boundary":"");
          slot.dataset.group = g;
          slot.dataset.tee = count[g];
          slot.dataset.time = label;
          slot.dataset.col = String(idx);

          day.filter(function(b){ return b.time===slot.dataset.time && b.col===idx; }).forEach(function(b){
            slot.appendChild(pill(b));
          });

          slot.addEventListener("click", function(e){
            if(e.target.closest(".pill")) return;
            openDlg({ id:"", name:"", caddyNumber:"", mid:"", course: slot.dataset.group, tee: parseInt(slot.dataset.tee,10)||1, time: slot.dataset.time, col: parseInt(slot.dataset.col,10)||0, notes:"" });
          });
          slot.addEventListener("dragover", function(e){ e.preventDefault(); });
          slot.addEventListener("drop", function(e){
            e.preventDefault();
            var id = e.dataTransfer.getData("text/id"); if(!id) return;
            var data = getDay(el.date.value);
            var i = data.findIndex(function(x){ return x.id===id; }); if(i<0) return;
            data[i].time = slot.dataset.time;
            data[i].col  = parseInt(slot.dataset.col,10) || 0;
            data[i].course = slot.dataset.group;
            data[i].tee = parseInt(slot.dataset.tee,10) || 1;
            setDay(el.date.value, data); render();
          });

          row.appendChild(slot);
        });

        el.sheet.appendChild(row);
      }

      computeMatches(el.q.value||"");
    }

    // Pill
    function pill(b){
      var p = document.createElement("div");
      p.className = "pill";
      p.draggable = true;
      p.dataset.id = b.id;
      var caddy = b.caddyNumber ? (" • Caddy "+b.caddyNumber) : "";
      p.innerHTML = "<strong>"+(b.name||"Player")+"</strong><br><span style='font-size:11px'>ID: "+(b.mid||"—")+caddy+" • "+b.course+"-"+(b.tee||1)+" • "+b.time+"</span>";
      p.addEventListener("dragstart", function(e){ e.dataTransfer.setData("text/id", b.id); });
      p.addEventListener("click", function(e){ openDlg(b); e.stopPropagation(); });
      return p;
    }

    // Dialog
    function openDlg(seed){
      el.id.value = seed.id || "";
      el.name.value = seed.name || "";
      el.caddy.value = seed.caddyNumber || "";
      el.mid.value = seed.mid || "";
      el.course.value = seed.course || "A";
      el.teeNo.value = String(seed.tee || 1);
      el.from.value = seed.time || "";
      el.to.value = seed.time || "";
      el.apply.checked = false;
      el.notes.value = seed.notes || "";
      el.delBtn.style.display = seed.id ? "" : "none";
      if(el.dlg.showModal) el.dlg.showModal(); else el.dlg.setAttribute("open","");
    }
    function closeDlg(){ if(el.dlg.close) el.dlg.close(); else el.dlg.removeAttribute("open"); }
    el.closeBtn.addEventListener("click", closeDlg);

    function aligned(from,to,step,start,end){
      function mins(hm){ var a=hm.split(":").map(Number); return a[0]*60+a[1]; }
      function tohm(min){ return pad2(Math.floor(min/60))+":"+pad2(min%60); }
      var a=mins(from||""), b=mins(to||""); if(isNaN(a)||isNaN(b)) return [];
      if(b<a){ var t=a;a=b;b=t; }
      var s=mins(start), e=mins(end); a=Math.max(a,s); b=Math.min(b,e); if(b<a) return [];
      var off=(a-s)%step; if(off!==0) a+=(step-off);
      var out=[]; for(var m=a;m<=b;m+=step) out.push(tohm(m)); return out;
    }

    el.saveBtn.addEventListener("click", function(e){
      e.preventDefault();
      var date = el.date.value || todayISO();
      var arr = getDay(date);
      var L = layout();
      var course = el.course.value;
      var tee = Math.max(1, Math.min(2, parseInt(el.teeNo.value||"1",10)));
      var applyAll = !!el.apply.checked;
      var step = +el.interval.value;
      var times = aligned(el.from.value, el.to.value, step, el.start.value, el.end.value);
      if(!times.length){ alert("Selected range has no times on this sheet."); return; }

      var colIndex = 0, count = {A:0,B:0,C:0,D:0};
      for(var i=0;i<L.cols.length;i++){ var g=L.cols[i]; count[g]++; if(g===course && count[g]===tee){ colIndex=i; break; } }

      function upsertAt(t, seedId, copy){
        var idx = arr.findIndex(function(x){ return x.time===t && x.col===colIndex; });
        var base = { id: seedId || genId(), course:course, tee:tee, time:t, col:colIndex, name:"", caddyNumber:"", mid:"", notes:"" };
        var payload = base; if(copy){ payload = Object.assign({}, base, { name:el.name.value.trim(), caddyNumber:el.caddy.value.trim(), mid:el.mid.value.trim(), notes:el.notes.value.trim() }); }
        if(idx>=0){ if(copy){ arr[idx] = Object.assign({}, arr[idx], payload, {id:arr[idx].id}); } return arr[idx] && arr[idx].id || payload.id; }
        else { arr.push(payload); return payload.id; }
      }

      if(times.length===1){
        var id = el.id.value || null;
        var idx = id ? arr.findIndex(function(x){ return x.id===id; }) : -1;
        if(idx>=0){
          arr[idx] = Object.assign({}, arr[idx], { name:el.name.value.trim(), caddyNumber:el.caddy.value.trim(), mid:el.mid.value.trim(), course:course, tee:tee, time:times[0], col:colIndex, notes:el.notes.value.trim() });
        } else {
          upsertAt(times[0], null, true);
        }
      } else {
        upsertAt(times[0], el.id.value||null, true);
        for(var j=1;j<times.length;j++) upsertAt(times[j], null, applyAll);
      }

      setDay(date, arr); closeDlg(); render();
    });

    el.delBtn.addEventListener("click", function(){
      var date = el.date.value || todayISO();
      var arr = getDay(date).filter(function(x){ return x.id !== el.id.value; });
      setDay(date, arr); closeDlg(); render();
    });

    // Date controls
    el.prev.addEventListener("click", function(){ var d=parseISO(el.date.value||todayISO()); d.setDate(d.getDate()-1); el.date.value=d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); render(); });
    el.next.addEventListener("click", function(){ var d=parseISO(el.date.value||todayISO()); d.setDate(d.getDate()+1); el.date.value=d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); render(); });
    el.date.addEventListener("change", render);
    el.complex.addEventListener("change", render);
    el.interval.addEventListener("change", render);
    el.start.addEventListener("change", render);
    el.end.addEventListener("change", render);
    el.tees.addEventListener("change", render);
    el.clear.addEventListener("click", function(){
      if(!confirm("Clear all bookings for "+el.date.value+"?")) return;
      setDay(el.date.value, []); render();
    });

    // Month picker
    var monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    (function buildMonthPicker(){
      el.mpM.innerHTML = monthNames.map(function(n,i){ return "<option value='"+i+"'>"+n+"</option>"; }).join("");
      var base = new Date().getFullYear(), years=[]; for(var y=base-5;y<=base+6;y++) years.push("<option value='"+y+"'>"+y+"</option>");
      el.mpY.innerHTML = years.join("");
    })();
    function renderMonth(year, month){
      Array.from(el.mpGrid.querySelectorAll(".mp-day")).forEach(function(n){ n.remove(); });
      var first = new Date(year, month, 1), firstDow = first.getDay(), daysInMonth = new Date(year, month+1, 0).getDate();
      var prevDays = new Date(year, month, 0).getDate();
      var t = new Date(); var today = t.getFullYear()+"-"+pad2(t.getMonth()+1)+"-"+pad2(t.getDate());
      for(var i=0;i<42;i++){
        var cell = document.createElement("div"); cell.className = "mp-day";
        var iso, muted=false;
        if(i<firstDow){ var d=new Date(year, month-1, prevDays - firstDow + 1 + i); iso=d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); muted=true; }
        else if(i>=firstDow + daysInMonth){ var d2=new Date(year, month+1, i - (firstDow + daysInMonth) + 1); iso=d2.getFullYear()+"-"+pad2(d2.getMonth()+1)+"-"+pad2(d2.getDate()); muted=true; }
        else { var d3=new Date(year, month, i - firstDow + 1); iso=d3.getFullYear()+"-"+pad2(d3.getMonth()+1)+"-"+pad2(d3.getDate()); }
        cell.textContent = String(new Date(iso).getDate());
        if(muted) cell.classList.add("muted");
        if(iso === today) cell.classList.add("today");
        (function(finalISO){ cell.addEventListener("click", function(){ el.date.value = finalISO; render(); el.mp.close(); }); })(iso);
        el.mpGrid.appendChild(cell);
      }
    }
    el.openMonth.addEventListener("click", function(){ var cur=parseISO(el.date.value||todayISO()); el.mpM.value=String(cur.getMonth()); el.mpY.value=String(cur.getFullYear()); renderMonth(cur.getFullYear(), cur.getMonth()); if(el.mp.showModal) el.mp.showModal(); else el.mp.setAttribute("open",""); });
    el.mpPrev.addEventListener("click", function(){ var y=parseInt(el.mpY.value,10), m=parseInt(el.mpM.value,10); var d=new Date(y, m-1, 1); el.mpY.value=String(d.getFullYear()); el.mpM.value=String(d.getMonth()); renderMonth(d.getFullYear(), d.getMonth()); });
    el.mpNext.addEventListener("click", function(){ var y=parseInt(el.mpY.value,10), m=parseInt(el.mpM.value,10); var d=new Date(y, m+1, 1); el.mpY.value=String(d.getFullYear()); el.mpM.value=String(d.getMonth()); renderMonth(d.getFullYear(), d.getMonth()); });
    el.mpM.addEventListener("change", function(){ renderMonth(parseInt(el.mpY.value,10), parseInt(el.mpM.value,10)); });
    el.mpY.addEventListener("change", function(){ renderMonth(parseInt(el.mpY.value,10), parseInt(el.mpM.value,10)); });

    // Search
    var state = { ids:[], idx:0 };
    function computeMatches(q){
      var data = getDay(el.date.value || todayISO());
      var needle = (q||"").trim().toLowerCase(); if(!needle){ state.ids=[]; state.idx=0; el.qCount.textContent="0"; return; }
      state.ids = data.filter(function(b){
        var name = (b.name||"").toLowerCase();
        var c = (b.caddyNumber||"").toLowerCase();
        return name.indexOf(needle)>=0 || c.indexOf(needle)>=0;
      }).sort(function(a,b){
        var da = minutes(a.time||"00:00"), db = minutes(b.time||"00:00");
        if(da!==db) return da-db; return (a.col||0)-(b.col||0);
      }).map(function(b){ return b.id; });
      el.qCount.textContent = String(state.ids.length||0);
    }
    function jump(id){
      if(!id) return;
      var data = getDay(el.date.value || todayISO());
      var rec = data.find(function(r){ return r.id===id; }); if(!rec) return;
      var slot = document.querySelector('#v11-sheet .slot[data-time="'+rec.time+'"][data-col="'+rec.col+'"]');
      if(!slot) return;
      slot.style.outline="2px solid #10b981";
      slot.scrollIntoView({behavior:"smooth", block:"center", inline:"center"});
      setTimeout(function(){ slot.style.outline=""; }, 1600);
    }
    el.qGo.addEventListener("click", function(e){ e.preventDefault(); computeMatches(el.q.value||""); if(state.ids.length){ jump(state.ids[0]); } else { alert("No matches on this date."); } });
    el.qNext.addEventListener("click", function(e){ e.preventDefault(); if(!state.ids.length){ el.qGo.click(); return; } state.idx=(state.idx+1)%state.ids.length; jump(state.ids[state.idx]); });
    el.q.addEventListener("keydown", function(e){ if(e.key==="Enter"){ e.preventDefault(); el.qGo.click(); } });

    // Init
    render();
  
})(); } catch(e){ console.error('TeeSheet init error', e); }
  }
  function watch(){
    const mount = () => {
      const host = document.getElementById('gm-teesheet-blank');
      if (host) injectOnce(host);
    };
    new MutationObserver(mount).observe(document.body, { childList:true, subtree:true });
    mount();
    // Cleanup dialogs on unmount
    new MutationObserver(() => {
      const hostNow = document.getElementById('gm-teesheet-blank');
      if (!hostNow) {
        try {
          const d1 = document.getElementById('v11-bookingDialog');
          const d2 = document.getElementById('v11-monthPicker');
          if (d1 && d1.open) d1.close();
          if (d2 && d2.open) d2.close();
        } catch(e){}
      }
    }).observe(document.body, { childList:true, subtree:true });
  }
  if (document.readyState !== 'loading') watch(); else document.addEventListener('DOMContentLoaded', watch);
})();
</script>
<!-- END: Tee Sheet Integration (production) -->

<style id="society-multicol-patch">
/* ===== Society Events: Multi-column Roster Layout (scoped patch) ===== */
#mc-grid:has(.soc-roster) {
  grid-template-columns: 1fr 1fr !important;      /* remove fixed 320px right rail when roster is present */
}
.soc-roster { width: 100% !important; max-width: none !important; }

/* Player list becomes a responsive grid */
.soc-list {
  display: grid !important;
  gap: 10px 14px !important;
  grid-template-columns: repeat(3, minmax(260px, 1fr)) !important;
  align-items: start;
}
@media (max-width: 1199px) { .soc-list { grid-template-columns: repeat(2, minmax(220px, 1fr)) !important; } }
@media (max-width: 767px)  { #mc-grid:has(.soc-roster) { grid-template-columns: 1fr !important; }
                             .soc-list { grid-template-columns: 1fr !important; } }

/* Keep each <label> row intact and styled */
.soc-list > label {
  break-inside: avoid;
  display: flex !important;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  margin: 0;
}
</style>

<style id="society-multicol-fallback">
/* Fallback when :has() is not supported */
body.soc-roster-present #mc-grid { grid-template-columns: 1fr 1fr !important; }
@media (max-width: 767px) {
  body.soc-roster-present #mc-grid { grid-template-columns: 1fr !important; }
}
</style>

<script>
(function(){
  function applySocRosterClass(){
    try {
      var hasRoster = !!document.querySelector('.soc-roster');
      document.body.classList.toggle('soc-roster-present', hasRoster);
    } catch(e){}
  }
  // Run now and whenever the DOM changes (since roster is injected)
  if (document.readyState !== 'loading') applySocRosterClass();
  else document.addEventListener('DOMContentLoaded', applySocRosterClass);
  new MutationObserver(applySocRosterClass).observe(document.documentElement, {subtree:true, childList:true});
})();
</script>


<style id="society-robust-patch">
/* ===== Society Events Robust Layout Override ===== */
/* Drive page grid via attribute to avoid :has() and class order issues */
#mc-grid[data-soc-view="1"] {
  grid-template-columns: 1fr 1fr !important;
}
@media (max-width: 767px) {
  #mc-grid[data-soc-view="1"] { grid-template-columns: 1fr !important; }
}

/* Ensure roster/list fill width and render as multi-column grid */
.soc-roster { width: 100% !important; max-width: none !important; }
.soc-list {
  display: grid !important;
  gap: 10px 14px !important;
  grid-template-columns: repeat(3, minmax(260px, 1fr)) !important;
  align-items: start;
}
@media (max-width: 1199px) {
  .soc-list { grid-template-columns: repeat(2, minmax(220px, 1fr)) !important; }
}
@media (max-width: 767px) {
  .soc-list { grid-template-columns: 1fr !important; }
}
.soc-list > label {
  break-inside: avoid;
  display: flex !important;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  margin: 0;
}
</style>

<script>
(function(){
  // Robust detector for Society page or roster presence
  function isSocietyContext(){
    try {
      if (document.querySelector('.soc-roster') || document.querySelector('.soc-list')) return true;
      // also detect by heading text
      var h = document.querySelector('h1,h2,h3');
      if (h && /Society\s+Events/i.test(h.textContent || '')) return true;
    } catch(e){}
    return false;
  }
  function apply(){
    try {
      var grid = document.getElementById('mc-grid');
      if (!grid) return;
      grid.toggleAttribute('data-soc-view', isSocietyContext() ? '1' : '');
    } catch(e){}
  }
  if (document.readyState !== 'loading') apply();
  else document.addEventListener('DOMContentLoaded', apply);
  // Observe DOM changes since the roster is injected dynamically
  new MutationObserver(apply).observe(document.documentElement, {childList:true, subtree:true});
})();
</script>



