# Changes Log - December 26, 2025

## Summary
Fixed critical handicap sync issues and match play scoring bugs.

---

## 1. HandicapManager Class [NEW]
**File:** `public/index.html` lines 10897-11046

Created centralized handicap management to prevent sync issues:
- `getHandicap()` - reads from society_handicaps (source of truth)
- `setHandicap()` - updates ALL storage locations atomically
- `formatDisplay()` - handles plus handicaps correctly
- `parseHandicap()` - converts "+1.0" format to numeric
- `syncAll()` - force sync all locations for a player

---

## 2. Match Play Handicap Calculation [BUG FIX]
**File:** `public/index.html` lines 49270-49276

**Before (BROKEN):**
```javascript
const playerStrokes = Math.floor(playerHcp) + (strokeIndex <= (playerHcp % 1) * 18 ? 1 : 0);
```

**After (FIXED):**
```javascript
const playerBaseStrokes = Math.floor(playerHcp / 18);
const playerExtraThreshold = playerHcp % 18;
const playerStrokes = playerBaseStrokes + (strokeIndex <= playerExtraThreshold ? 1 : 0);
```

---

## 3. Auto Handicap Adjustment Sync [BUG FIX]
**File:** `public/index.html` lines 52759-52792

Now syncs BOTH profile fields after each round:
- `profile_data.handicap` (legacy)
- `profile_data.golfInfo.handicap` (canonical)
- Updates AppState immediately
- Updates UI elements immediately

---

## 4. SocietyOrganizerSystem.saveUserEdits [BUG FIX]
**File:** `public/index.html` lines 60300-60345

Added sync of legacy handicap field and lastHandicapUpdate timestamp.

---

## 5. AdminSystem.saveUserEdits [BUG FIX]
**File:** `public/index.html` lines 44960-44982

Now updates society_handicaps table when editing user handicap.

---

## 6. ProfileSystem.saveProfileFromForm [BUG FIX]
**File:** `public/index.html` lines 19691-19730

Now updates society_handicaps table when user edits own profile.

---

## 7. Photo Score Feature [NEW]
**Files:**
- `supabase/functions/analyze-scorecard/index.ts` - Edge function
- `supabase/migrations/20251226_photo_score_setup.sql` - DB migration
- `public/index.html` - UI and PhotoScoreManager class

Status: Implemented, pending ANTHROPIC_API_KEY configuration.

---

## Database Changes

### society_handicaps table
Primary source of truth for all handicaps.

| Column | Type | Description |
|--------|------|-------------|
| golfer_id | TEXT | Player LINE ID |
| society_id | UUID | null for universal, UUID for society |
| handicap_index | NUMERIC | Negative for plus handicaps |
| calculation_method | TEXT | MANUAL, WHS-5, WHS-5-GPR, SYNC |
| last_calculated_at | TIMESTAMP | Last update time |

### rounds table
Added: `scorecard_photo_url TEXT` - URL to uploaded scorecard photo

### Storage bucket
`scorecard_photos` - Public bucket for scorecard images

---

## Handicap Data Fixes Applied

| Player | Before | After |
|--------|--------|-------|
| Alan Thomas | 8.7 | 10.8 |
| Tristan Gilbert | 20.0 | 13.2 |
| Pete Park | +1.0 (header) / 3.6 (db) | 3.6 everywhere |

---

## Files Modified

1. `public/index.html` - Main application (multiple sections)
2. `supabase/functions/analyze-scorecard/index.ts` - NEW
3. `supabase/migrations/20251226_photo_score_setup.sql` - NEW
