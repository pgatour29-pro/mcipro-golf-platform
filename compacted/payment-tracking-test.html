<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Tracking System - Test Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        .test-section {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
        }

        .test-result {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .test-pass {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #059669;
        }

        .test-fail {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #dc2626;
        }

        .test-pending {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-gradient-to-r from-sky-600 to-sky-400 text-white rounded-xl p-6 mb-6 shadow-lg">
            <h1 class="text-3xl font-bold mb-2">Payment Tracking System</h1>
            <p class="text-sky-100">Integration Test Suite</p>
        </div>

        <!-- Test 1: Database Connection -->
        <div class="test-section">
            <h2 class="text-xl font-bold text-gray-900 mb-3">Test 1: Database Connection</h2>
            <p class="text-gray-600 mb-3">Verify Supabase connection and payment tables exist</p>
            <button onclick="testDatabaseConnection()" class="bg-sky-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700">
                Run Test
            </button>
            <div id="test1Result"></div>
        </div>

        <!-- Test 2: Payment Record Creation -->
        <div class="test-section">
            <h2 class="text-xl font-bold text-gray-900 mb-3">Test 2: Payment Record Auto-Creation</h2>
            <p class="text-gray-600 mb-3">Verify payment records auto-create when registration is created</p>

            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Test Event ID</label>
                <input type="text" id="testEventId" class="w-full border rounded-lg px-3 py-2"
                       placeholder="Enter event ID to test">
            </div>

            <button onclick="testPaymentRecordCreation()" class="bg-sky-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700">
                Run Test
            </button>
            <div id="test2Result"></div>
        </div>

        <!-- Test 3: Payment Status Updates -->
        <div class="test-section">
            <h2 class="text-xl font-bold text-gray-900 mb-3">Test 3: Payment Status Updates</h2>
            <p class="text-gray-600 mb-3">Test marking individual fees as paid and verify status updates</p>

            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Test Payment ID</label>
                <input type="text" id="testPaymentId" class="w-full border rounded-lg px-3 py-2"
                       placeholder="Enter payment ID to test">
            </div>

            <button onclick="testPaymentStatusUpdates()" class="bg-sky-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700">
                Run Test
            </button>
            <div id="test3Result"></div>
        </div>

        <!-- Test 4: Payment Summary -->
        <div class="test-section">
            <h2 class="text-xl font-bold text-gray-900 mb-3">Test 4: Payment Summary Calculation</h2>
            <p class="text-gray-600 mb-3">Verify payment summary aggregations are correct</p>

            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Event ID for Summary</label>
                <input type="text" id="testSummaryEventId" class="w-full border rounded-lg px-3 py-2"
                       placeholder="Enter event ID">
            </div>

            <button onclick="testPaymentSummary()" class="bg-sky-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700">
                Run Test
            </button>
            <div id="test4Result"></div>
        </div>

        <!-- Test 5: Payment Preferences -->
        <div class="test-section">
            <h2 class="text-xl font-bold text-gray-900 mb-3">Test 5: Payment Preferences Update</h2>
            <p class="text-gray-600 mb-3">Test updating golfer payment preferences</p>

            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Payment ID</label>
                    <input type="text" id="testPrefPaymentId" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pay Green At</label>
                    <select id="testPayGreenAt" class="w-full border rounded-lg px-3 py-2">
                        <option value="bar">Society Bar</option>
                        <option value="course">Golf Course</option>
                        <option value="organizer">Organizer</option>
                    </select>
                </div>
            </div>

            <button onclick="testPaymentPreferences()" class="bg-sky-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700">
                Run Test
            </button>
            <div id="test5Result"></div>
        </div>

        <!-- Test 6: Real-time Subscriptions -->
        <div class="test-section">
            <h2 class="text-xl font-bold text-gray-900 mb-3">Test 6: Real-time Updates</h2>
            <p class="text-gray-600 mb-3">Test real-time subscription to payment changes</p>

            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Event ID for Subscription</label>
                <input type="text" id="testRealtimeEventId" class="w-full border rounded-lg px-3 py-2">
            </div>

            <button onclick="testRealtimeSubscription()" class="bg-sky-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700">
                Start Subscription
            </button>
            <button onclick="stopRealtimeSubscription()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 ml-2">
                Stop Subscription
            </button>
            <div id="test6Result"></div>
        </div>

        <!-- Test 7: Payment Breakdown -->
        <div class="test-section">
            <h2 class="text-xl font-bold text-gray-900 mb-3">Test 7: Payment Breakdown by Location</h2>
            <p class="text-gray-600 mb-3">Test payment breakdown aggregation</p>

            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Event ID</label>
                <input type="text" id="testBreakdownEventId" class="w-full border rounded-lg px-3 py-2">
            </div>

            <button onclick="testPaymentBreakdown()" class="bg-sky-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700">
                Run Test
            </button>
            <div id="test7Result"></div>
        </div>

        <!-- Test 8: Export Functionality -->
        <div class="test-section">
            <h2 class="text-xl font-bold text-gray-900 mb-3">Test 8: CSV Export</h2>
            <p class="text-gray-600 mb-3">Test payment checklist export to CSV</p>

            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Event ID</label>
                <input type="text" id="testExportEventId" class="w-full border rounded-lg px-3 py-2">
            </div>

            <button onclick="testExportFunctionality()" class="bg-sky-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700">
                Run Test
            </button>
            <div id="test8Result"></div>
        </div>

        <!-- Summary -->
        <div class="bg-white rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Test Summary</h2>
            <div id="testSummary" class="text-gray-600">
                Run tests to see summary...
            </div>
        </div>
    </div>

    <!-- Load Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Test Scripts -->
    <script>
        // Initialize test state
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0
        };

        let realtimeSubscription = null;

        // Helper function to display results
        function displayResult(elementId, success, message, details = null) {
            const element = document.getElementById(elementId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${success ? 'test-pass' : 'test-fail'}`;

            let html = `<strong>${success ? 'PASS' : 'FAIL'}:</strong> ${message}`;
            if (details) {
                html += `<br><pre class="mt-2 text-xs">${JSON.stringify(details, null, 2)}</pre>`;
            }

            resultDiv.innerHTML = html;
            element.appendChild(resultDiv);

            // Update summary
            testResults.total++;
            if (success) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }
            updateSummary();
        }

        function updateSummary() {
            const summaryEl = document.getElementById('testSummary');
            const passRate = testResults.total > 0
                ? Math.round((testResults.passed / testResults.total) * 100)
                : 0;

            summaryEl.innerHTML = `
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-gray-900">${testResults.total}</div>
                        <div class="text-sm text-gray-600">Total Tests</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-600">${testResults.passed}</div>
                        <div class="text-sm text-gray-600">Passed</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-red-600">${testResults.failed}</div>
                        <div class="text-sm text-gray-600">Failed</div>
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-4xl font-bold ${passRate === 100 ? 'text-green-600' : passRate >= 80 ? 'text-yellow-600' : 'text-red-600'}">
                        ${passRate}%
                    </div>
                    <div class="text-sm text-gray-600">Pass Rate</div>
                </div>
            `;
        }

        // Test 1: Database Connection
        async function testDatabaseConnection() {
            const resultId = 'test1Result';
            document.getElementById(resultId).innerHTML = '';

            try {
                if (!window.supabase) {
                    throw new Error('Supabase client not initialized');
                }

                // Try to query event_payments table
                const { data, error } = await supabase
                    .from('event_payments')
                    .select('id')
                    .limit(1);

                if (error) throw error;

                displayResult(resultId, true, 'Database connection successful and event_payments table exists');
            } catch (error) {
                displayResult(resultId, false, `Database connection failed: ${error.message}`);
            }
        }

        // Test 2: Payment Record Creation (simulated)
        async function testPaymentRecordCreation() {
            const resultId = 'test2Result';
            document.getElementById(resultId).innerHTML = '';

            const eventId = document.getElementById('testEventId').value;
            if (!eventId) {
                displayResult(resultId, false, 'Please enter an event ID');
                return;
            }

            try {
                // Get registrations for event
                const { data: registrations, error: regError } = await supabase
                    .from('event_registrations')
                    .select('id')
                    .eq('event_id', eventId);

                if (regError) throw regError;

                // Check if payment records exist
                const { data: payments, error: payError } = await supabase
                    .from('event_payments')
                    .select('id, registration_id')
                    .eq('event_id', eventId);

                if (payError) throw payError;

                const regCount = registrations?.length || 0;
                const payCount = payments?.length || 0;

                if (regCount === payCount && regCount > 0) {
                    displayResult(resultId, true, `All ${regCount} registrations have payment records`, {
                        registrations: regCount,
                        payments: payCount
                    });
                } else {
                    displayResult(resultId, false, `Mismatch: ${regCount} registrations but ${payCount} payments`, {
                        registrations: regCount,
                        payments: payCount
                    });
                }
            } catch (error) {
                displayResult(resultId, false, `Test failed: ${error.message}`);
            }
        }

        // Test 3: Payment Status Updates
        async function testPaymentStatusUpdates() {
            const resultId = 'test3Result';
            document.getElementById(resultId).innerHTML = '';

            const paymentId = document.getElementById('testPaymentId').value;
            if (!paymentId) {
                displayResult(resultId, false, 'Please enter a payment ID');
                return;
            }

            try {
                // Get current status
                const { data: before, error: beforeError } = await supabase
                    .from('event_payments')
                    .select('payment_status, green_fee_paid')
                    .eq('id', paymentId)
                    .single();

                if (beforeError) throw beforeError;

                // Update green fee to paid
                const { data: updated, error: updateError } = await supabase
                    .from('event_payments')
                    .update({ green_fee_paid: true })
                    .eq('id', paymentId)
                    .select()
                    .single();

                if (updateError) throw updateError;

                // Check if status changed appropriately
                const statusChanged = before.payment_status !== updated.payment_status;
                const greenFeePaid = updated.green_fee_paid === true;

                if (statusChanged && greenFeePaid) {
                    displayResult(resultId, true, `Payment status updated correctly`, {
                        before: before.payment_status,
                        after: updated.payment_status,
                        green_fee_paid: updated.green_fee_paid
                    });
                } else {
                    displayResult(resultId, false, `Status update incomplete`, {
                        status_changed: statusChanged,
                        green_fee_paid: greenFeePaid
                    });
                }
            } catch (error) {
                displayResult(resultId, false, `Test failed: ${error.message}`);
            }
        }

        // Test 4: Payment Summary
        async function testPaymentSummary() {
            const resultId = 'test4Result';
            document.getElementById(resultId).innerHTML = '';

            const eventId = document.getElementById('testSummaryEventId').value;
            if (!eventId) {
                displayResult(resultId, false, 'Please enter an event ID');
                return;
            }

            try {
                const { data, error } = await supabase
                    .rpc('get_event_payment_summary', { p_event_id: eventId });

                if (error) throw error;

                if (data && data.total_registrations > 0) {
                    displayResult(resultId, true, 'Payment summary calculated successfully', data);
                } else {
                    displayResult(resultId, false, 'No payment data found for event');
                }
            } catch (error) {
                displayResult(resultId, false, `Test failed: ${error.message}`);
            }
        }

        // Test 5: Payment Preferences
        async function testPaymentPreferences() {
            const resultId = 'test5Result';
            document.getElementById(resultId).innerHTML = '';

            const paymentId = document.getElementById('testPrefPaymentId').value;
            const payGreenAt = document.getElementById('testPayGreenAt').value;

            if (!paymentId) {
                displayResult(resultId, false, 'Please enter a payment ID');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('event_payments')
                    .update({ pay_green_at: payGreenAt })
                    .eq('id', paymentId)
                    .select()
                    .single();

                if (error) throw error;

                if (data.pay_green_at === payGreenAt) {
                    displayResult(resultId, true, 'Payment preference updated successfully', {
                        payment_id: data.id,
                        pay_green_at: data.pay_green_at
                    });
                } else {
                    displayResult(resultId, false, 'Preference not updated correctly');
                }
            } catch (error) {
                displayResult(resultId, false, `Test failed: ${error.message}`);
            }
        }

        // Test 6: Real-time Subscription
        function testRealtimeSubscription() {
            const resultId = 'test6Result';
            document.getElementById(resultId).innerHTML = '';

            const eventId = document.getElementById('testRealtimeEventId').value;
            if (!eventId) {
                displayResult(resultId, false, 'Please enter an event ID');
                return;
            }

            try {
                realtimeSubscription = supabase
                    .channel(`payments:${eventId}`)
                    .on(
                        'postgres_changes',
                        {
                            event: '*',
                            schema: 'public',
                            table: 'event_payments',
                            filter: `event_id=eq.${eventId}`
                        },
                        (payload) => {
                            displayResult(resultId, true, 'Real-time update received', {
                                event: payload.eventType,
                                timestamp: new Date().toISOString()
                            });
                        }
                    )
                    .subscribe();

                displayResult(resultId, true, 'Real-time subscription started. Make a payment update to test...', {
                    event_id: eventId,
                    status: 'listening'
                });
            } catch (error) {
                displayResult(resultId, false, `Subscription failed: ${error.message}`);
            }
        }

        function stopRealtimeSubscription() {
            if (realtimeSubscription) {
                supabase.removeChannel(realtimeSubscription);
                realtimeSubscription = null;
                const resultId = 'test6Result';
                displayResult(resultId, true, 'Real-time subscription stopped');
            }
        }

        // Test 7: Payment Breakdown
        async function testPaymentBreakdown() {
            const resultId = 'test7Result';
            document.getElementById(resultId).innerHTML = '';

            const eventId = document.getElementById('testBreakdownEventId').value;
            if (!eventId) {
                displayResult(resultId, false, 'Please enter an event ID');
                return;
            }

            try {
                const { data: payments, error } = await supabase
                    .from('event_payments')
                    .select('*')
                    .eq('event_id', eventId);

                if (error) throw error;

                // Calculate breakdown
                const breakdown = {
                    bar: { count: 0, amount: 0 },
                    course: { count: 0, amount: 0 },
                    organizer: { count: 0, amount: 0 }
                };

                payments.forEach(p => {
                    if (p.pay_green_at) breakdown[p.pay_green_at].amount += p.green_fee_amount;
                    if (p.pay_cart_at) breakdown[p.pay_cart_at].amount += p.cart_fee_amount;
                    if (p.pay_caddy_at) breakdown[p.pay_caddy_at].amount += p.caddy_fee_amount;
                });

                displayResult(resultId, true, 'Payment breakdown calculated', breakdown);
            } catch (error) {
                displayResult(resultId, false, `Test failed: ${error.message}`);
            }
        }

        // Test 8: Export Functionality
        async function testExportFunctionality() {
            const resultId = 'test8Result';
            document.getElementById(resultId).innerHTML = '';

            const eventId = document.getElementById('testExportEventId').value;
            if (!eventId) {
                displayResult(resultId, false, 'Please enter an event ID');
                return;
            }

            try {
                const { data: payments, error } = await supabase
                    .from('event_payments')
                    .select('*')
                    .eq('event_id', eventId);

                if (error) throw error;

                if (payments && payments.length > 0) {
                    // Test CSV generation (don't actually download)
                    const headers = ['Player', 'Total', 'Status'];
                    const rows = payments.map(p => [p.player_name, p.total_amount, p.payment_status]);
                    const csv = [headers, ...rows].map(r => r.join(',')).join('\n');

                    displayResult(resultId, true, 'Export data generated successfully', {
                        rows: payments.length,
                        csv_length: csv.length
                    });
                } else {
                    displayResult(resultId, false, 'No payments to export');
                }
            } catch (error) {
                displayResult(resultId, false, `Test failed: ${error.message}`);
            }
        }

        // Initialize summary on load
        updateSummary();
    </script>
</body>
</html>
