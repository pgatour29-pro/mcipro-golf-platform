<!DOCTYPE html>
<html>
<head>
    <title>Debug Pluto Handicaps</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; }
        button { padding: 10px 20px; font-size: 16px; margin: 5px; cursor: pointer; }
        pre { background: #f0f0f0; padding: 15px; border-radius: 5px; white-space: pre-wrap; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Debug Pluto Handicaps</h1>
    <button id="checkBtn">Check All Pluto Data</button>
    <button id="fixBtn">Create Society Handicap +1.6</button>
    <pre id="output"></pre>

    <script>
        const db = window.supabase.createClient(
            'https://pyeeplwsnupmhgbguwqs.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZWVwbHdzbnVwbWhnYmd1d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDM2NjksImV4cCI6MjA3NTQxOTY2OX0.KVQ6WvDKz9s77lxn3AhSA_YTMCN6rsht9kDkMIDhngk'
        );

        const TRGG_SOCIETY_ID = '7c0e4b72-d925-44bc-afda-38259a7ba346';

        function log(msg, type = '') {
            const span = document.createElement('span');
            span.className = type;
            span.textContent = msg + '\n';
            document.getElementById('output').appendChild(span);
        }

        function clearLog() {
            document.getElementById('output').innerHTML = '';
        }

        document.getElementById('checkBtn').addEventListener('click', async function() {
            clearLog();
            log('=== CHECKING ALL PLUTO DATA ===\n', 'info');

            // 1. Find Pluto in user_profiles
            log('1. Searching user_profiles for "Pluto"...');
            const { data: profiles } = await db
                .from('user_profiles')
                .select('line_user_id, name, handicap_index')
                .ilike('name', '%pluto%');

            if (profiles && profiles.length > 0) {
                profiles.forEach(p => {
                    log(`   Found: ${p.name}`, 'success');
                    log(`   line_user_id: ${p.line_user_id}`);
                    log(`   handicap_index: ${p.handicap_index}`);
                });
            } else {
                log('   No Pluto found in user_profiles', 'error');
            }

            // 2. Find Pluto in society_members
            log('\n2. Searching society_members for "Pluto"...');
            const { data: members } = await db
                .from('society_members')
                .select('id, golfer_id, society_id, member_data');

            const plutoMembers = members?.filter(m => {
                const name = m.member_data?.name || '';
                return name.toLowerCase().includes('pluto');
            }) || [];

            if (plutoMembers.length > 0) {
                plutoMembers.forEach(m => {
                    log(`   Found in society_members:`, 'success');
                    log(`   golfer_id: ${m.golfer_id}`);
                    log(`   society_id: ${m.society_id}`);
                    log(`   member_data.name: ${m.member_data?.name}`);
                });
            } else {
                log('   No Pluto found in society_members', 'error');
            }

            // 3. Get ALL handicaps for any Pluto ID
            log('\n3. Checking society_handicaps for all Pluto IDs...');
            const allPlutoIds = [
                ...(profiles?.map(p => p.line_user_id) || []),
                ...(plutoMembers?.map(m => m.golfer_id) || [])
            ].filter(Boolean);

            log(`   Checking IDs: ${JSON.stringify(allPlutoIds)}`);

            if (allPlutoIds.length > 0) {
                const { data: handicaps } = await db
                    .from('society_handicaps')
                    .select('*')
                    .in('golfer_id', allPlutoIds);

                if (handicaps && handicaps.length > 0) {
                    log(`\n   Found ${handicaps.length} handicap records:`, 'success');
                    handicaps.forEach(h => {
                        const societyLabel = h.society_id ? `Society: ${h.society_id}` : 'UNIVERSAL';
                        log(`   - ${societyLabel}`);
                        log(`     golfer_id: ${h.golfer_id}`);
                        log(`     handicap_index: ${h.handicap_index}`);
                    });
                } else {
                    log('   NO handicap records found!', 'error');
                }
            }

            log('\n=== DONE ===', 'info');
        });

        document.getElementById('fixBtn').addEventListener('click', async function() {
            clearLog();
            log('=== CREATING PLUTO SOCIETY HANDICAP ===\n', 'info');

            // Find Pluto's golfer_id from society_members
            const { data: members } = await db
                .from('society_members')
                .select('golfer_id, member_data')
                .eq('society_id', TRGG_SOCIETY_ID);

            const plutoMember = members?.find(m => {
                const name = m.member_data?.name || '';
                return name.toLowerCase().includes('pluto');
            });

            if (!plutoMember) {
                log('Pluto not found in Travellers Rest society_members!', 'error');
                return;
            }

            const plutoGolferId = plutoMember.golfer_id;
            log(`Found Pluto with golfer_id: ${plutoGolferId}`);

            // Delete existing society handicap
            log('Deleting any existing society handicap...');
            await db.from('society_handicaps')
                .delete()
                .eq('golfer_id', plutoGolferId)
                .eq('society_id', TRGG_SOCIETY_ID);

            // Insert new society handicap (-1.6 for +1.6)
            log('Creating society handicap = -1.6 (displays as +1.6)...');
            const { error } = await db.from('society_handicaps')
                .insert({
                    golfer_id: plutoGolferId,
                    society_id: TRGG_SOCIETY_ID,
                    handicap_index: -1.6,
                    calculation_method: 'MANUAL',
                    last_calculated_at: new Date().toISOString()
                });

            if (error) {
                log('Error: ' + error.message, 'error');
            } else {
                log('SUCCESS! Society handicap created.', 'success');
            }

            // Verify
            log('\nVerifying...');
            const { data: verify } = await db
                .from('society_handicaps')
                .select('*')
                .eq('golfer_id', plutoGolferId);

            if (verify) {
                verify.forEach(h => {
                    const label = h.society_id ? 'Society' : 'Universal';
                    log(`${label}: ${h.handicap_index}`, 'success');
                });
            }
        });
    </script>
</body>
</html>
