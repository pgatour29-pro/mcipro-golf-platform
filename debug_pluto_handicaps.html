<!DOCTYPE html>
<html>
<head>
    <title>Debug Pluto Handicaps</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; }
        button { padding: 10px 20px; font-size: 16px; margin: 5px; cursor: pointer; background: #4CAF50; color: white; border: none; }
        button:hover { background: #45a049; }
        pre { background: #f0f0f0; padding: 15px; border-radius: 5px; white-space: pre-wrap; max-height: 600px; overflow-y: auto; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Debug Pluto Handicaps</h1>
    <button id="checkBtn">1. Check All Pluto Data</button>
    <button id="fixBtn">2. Fix Pluto Society Handicap</button>
    <pre id="output"></pre>

    <script>
        const db = window.supabase.createClient(
            'https://pyeeplwsnupmhgbguwqs.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZWVwbHdzbnVwbWhnYmd1d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDM2NjksImV4cCI6MjA3NTQxOTY2OX0.KVQ6WvDKz9s77lxn3AhSA_YTMCN6rsht9kDkMIDhngk'
        );

        const TRGG_SOCIETY_ID = '7c0e4b72-d925-44bc-afda-38259a7ba346';
        const PLUTO_MANUAL_ID = 'MANUAL-1768008205248-jvtubbk';

        function log(msg, type = '') {
            const span = document.createElement('span');
            span.className = type;
            span.textContent = msg + '\n';
            document.getElementById('output').appendChild(span);
            console.log(msg);
        }

        function clearLog() {
            document.getElementById('output').innerHTML = '';
        }

        document.getElementById('checkBtn').addEventListener('click', async function() {
            clearLog();
            log('=== CHECKING PLUTO DATA ===\n', 'info');

            // 1. Find Pluto in user_profiles
            log('1. Searching user_profiles for "Pluto"...');
            const { data: profiles, error: profileErr } = await db
                .from('user_profiles')
                .select('line_user_id, name, handicap_index')
                .ilike('name', '%pluto%');

            if (profileErr) {
                log('   Error: ' + profileErr.message, 'error');
            } else if (profiles && profiles.length > 0) {
                profiles.forEach(p => {
                    log('   FOUND in user_profiles:', 'success');
                    log('   - name: ' + p.name);
                    log('   - line_user_id: ' + p.line_user_id);
                    log('   - handicap_index: ' + p.handicap_index);
                });
            } else {
                log('   No Pluto found in user_profiles', 'error');
            }

            // 2. Check society_handicaps for known Pluto ID
            log('\n2. Checking society_handicaps for MANUAL ID...');
            const { data: hcps1, error: hcpErr1 } = await db
                .from('society_handicaps')
                .select('*')
                .eq('golfer_id', PLUTO_MANUAL_ID);

            if (hcpErr1) {
                log('   Error: ' + hcpErr1.message, 'error');
            } else if (hcps1 && hcps1.length > 0) {
                log('   FOUND handicaps for ' + PLUTO_MANUAL_ID + ':', 'success');
                hcps1.forEach(h => {
                    const label = h.society_id === null ? 'UNIVERSAL' : (h.society_id === TRGG_SOCIETY_ID ? 'TRAVELLERS REST' : h.society_id);
                    log('   - ' + label + ': ' + h.handicap_index);
                });
            } else {
                log('   No handicaps found for ' + PLUTO_MANUAL_ID, 'error');
            }

            // 3. Also check if there's a line_user_id version
            if (profiles && profiles.length > 0) {
                const plutoLineId = profiles[0].line_user_id;
                if (plutoLineId !== PLUTO_MANUAL_ID) {
                    log('\n3. Checking society_handicaps for line_user_id...');
                    const { data: hcps2, error: hcpErr2 } = await db
                        .from('society_handicaps')
                        .select('*')
                        .eq('golfer_id', plutoLineId);

                    if (hcpErr2) {
                        log('   Error: ' + hcpErr2.message, 'error');
                    } else if (hcps2 && hcps2.length > 0) {
                        log('   FOUND handicaps for ' + plutoLineId + ':', 'success');
                        hcps2.forEach(h => {
                            const label = h.society_id === null ? 'UNIVERSAL' : (h.society_id === TRGG_SOCIETY_ID ? 'TRAVELLERS REST' : h.society_id);
                            log('   - ' + label + ': ' + h.handicap_index);
                        });
                    } else {
                        log('   No handicaps found for ' + plutoLineId, 'error');
                    }
                }
            }

            // 4. Search ALL handicaps containing "pluto" or "manual"
            log('\n4. Searching ALL society_handicaps with MANUAL IDs...');
            const { data: allHcps, error: allErr } = await db
                .from('society_handicaps')
                .select('*')
                .ilike('golfer_id', '%MANUAL%');

            if (allErr) {
                log('   Error: ' + allErr.message, 'error');
            } else {
                log('   Found ' + (allHcps?.length || 0) + ' handicaps with MANUAL IDs');
                const plutoHcps = allHcps?.filter(h => h.golfer_id.toLowerCase().includes('pluto') || h.golfer_id === PLUTO_MANUAL_ID);
                if (plutoHcps && plutoHcps.length > 0) {
                    log('   Pluto-related handicaps:', 'success');
                    plutoHcps.forEach(h => {
                        log('   - golfer_id: ' + h.golfer_id);
                        log('     society_id: ' + (h.society_id || 'UNIVERSAL'));
                        log('     handicap: ' + h.handicap_index);
                    });
                }
            }

            log('\n=== DONE ===', 'info');
        });

        document.getElementById('fixBtn').addEventListener('click', async function() {
            clearLog();
            log('=== FIXING PLUTO SOCIETY HANDICAP ===\n', 'info');

            // First find Pluto's line_user_id from user_profiles
            const { data: profiles } = await db
                .from('user_profiles')
                .select('line_user_id, name')
                .ilike('name', '%pluto%')
                .limit(1);

            if (!profiles || profiles.length === 0) {
                log('Pluto not found in user_profiles!', 'error');
                return;
            }

            const plutoId = profiles[0].line_user_id;
            log('Found Pluto: ' + profiles[0].name);
            log('line_user_id: ' + plutoId);

            // Delete any existing society handicap for this ID
            log('\nDeleting existing Travellers Rest handicap...');
            const { error: delErr } = await db
                .from('society_handicaps')
                .delete()
                .eq('golfer_id', plutoId)
                .eq('society_id', TRGG_SOCIETY_ID);

            if (delErr) log('Delete error: ' + delErr.message, 'error');

            // Also delete for MANUAL ID if different
            if (plutoId !== PLUTO_MANUAL_ID) {
                await db
                    .from('society_handicaps')
                    .delete()
                    .eq('golfer_id', PLUTO_MANUAL_ID)
                    .eq('society_id', TRGG_SOCIETY_ID);
            }

            // Create society handicap with the user_profiles ID
            log('Creating society handicap = -1.6 (displays as +1.6)...');
            const { error: insErr } = await db
                .from('society_handicaps')
                .insert({
                    golfer_id: plutoId,
                    society_id: TRGG_SOCIETY_ID,
                    handicap_index: -1.6,
                    calculation_method: 'MANUAL',
                    last_calculated_at: new Date().toISOString()
                });

            if (insErr) {
                log('Insert error: ' + insErr.message, 'error');
            } else {
                log('SUCCESS!', 'success');
            }

            // Verify
            log('\nVerifying all handicaps for Pluto...');
            const { data: verify } = await db
                .from('society_handicaps')
                .select('*')
                .eq('golfer_id', plutoId);

            if (verify && verify.length > 0) {
                verify.forEach(h => {
                    const label = h.society_id === null ? 'UNIVERSAL' : 'TRAVELLERS REST';
                    log(label + ': ' + h.handicap_index, 'success');
                });
            }

            log('\n=== DONE - Now test in Start Round ===', 'info');
        });
    </script>
</body>
</html>
