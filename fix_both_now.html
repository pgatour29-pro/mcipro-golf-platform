<!DOCTYPE html>
<html>
<head>
    <title>FIX RYAN & PLUTO</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>FIX RYAN & PLUTO HANDICAPS</h1>
    <p>Society: +1.6 | Universal: 0</p>
    <button id="fixBtn" style="padding:30px 60px;font-size:28px;background:red;color:white;cursor:pointer;border:none;">FIX BOTH NOW</button>
    <pre id="output" style="background:#eee;padding:20px;margin-top:20px;font-size:14px;"></pre>
    <script>
        const db = window.supabase.createClient(
            'https://pyeeplwsnupmhgbguwqs.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZWVwbHdzbnVwbWhnYmd1d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDM2NjksImV4cCI6MjA3NTQxOTY2OX0.KVQ6WvDKz9s77lxn3AhSA_YTMCN6rsht9kDkMIDhngk'
        );
        const TRGG = '7c0e4b72-d925-44bc-afda-38259a7ba346';
        const out = document.getElementById('output');

        function log(msg) {
            out.textContent += msg + '\n';
            console.log(msg);
        }

        document.getElementById('fixBtn').onclick = async () => {
            out.textContent = '';
            log('=== FIXING RYAN & PLUTO ===\n');

            const players = ['ryan', 'pluto'];

            for (const name of players) {
                log('--- ' + name.toUpperCase() + ' ---');

                // Find in user_profiles
                const {data: profiles} = await db.from('user_profiles')
                    .select('line_user_id, name')
                    .ilike('name', '%' + name + '%')
                    .limit(1);

                if (!profiles || !profiles[0]) {
                    log('ERROR: ' + name + ' not found in user_profiles!\n');
                    continue;
                }

                const id = profiles[0].line_user_id;
                log('Found: ' + profiles[0].name);
                log('ID: ' + id);

                // Delete ALL existing handicaps for this ID
                log('Deleting old handicaps...');
                await db.from('society_handicaps').delete().eq('golfer_id', id);

                // Create UNIVERSAL = 0
                log('Creating UNIVERSAL = 0...');
                const {error: e1} = await db.from('society_handicaps').insert({
                    golfer_id: id,
                    society_id: null,
                    handicap_index: 0,
                    calculation_method: 'MANUAL',
                    last_calculated_at: new Date().toISOString()
                });
                if (e1) log('Error: ' + e1.message);

                // Create SOCIETY = -1.6 (displays as +1.6)
                log('Creating TRAVELLERS = -1.6 (shows as +1.6)...');
                const {error: e2} = await db.from('society_handicaps').insert({
                    golfer_id: id,
                    society_id: TRGG,
                    handicap_index: -1.6,
                    calculation_method: 'MANUAL',
                    last_calculated_at: new Date().toISOString()
                });
                if (e2) log('Error: ' + e2.message);

                // Verify
                const {data: verify} = await db.from('society_handicaps').select('*').eq('golfer_id', id);
                log('Result:');
                verify?.forEach(h => {
                    const label = h.society_id === null ? 'UNIVERSAL' : 'TRAVELLERS';
                    log('  ' + label + ': ' + h.handicap_index);
                });
                log('');
            }

            log('=== DONE ===');
            log('Now test in Start Round!');
        };
    </script>
</body>
</html>
