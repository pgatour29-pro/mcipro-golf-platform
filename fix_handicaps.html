<!DOCTYPE html>
<html>
<head>
    <title>Fix Pete Park Handicap</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Fix Pete Park: Universal 3.2, Travellers 2.1</h1>
    <button id="runBtn">Click to Fix</button>
    <pre id="output"></pre>
    <script>
        const db = window.supabase.createClient(
            'https://pyeeplwsnupmhgbguwqs.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZWVwbHdzbnVwbWhnYmd1d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDM2NjksImV4cCI6MjA3NTQxOTY2OX0.KVQ6WvDKz9s77lxn3AhSA_YTMCN6rsht9kDkMIDhngk'
        );

        const PETE_LINE_ID = 'U2b6d976f19bca4b2f4374ae0e10ed873';
        const TRGG_SOCIETY_ID = '7c0e4b72-d925-44bc-afda-38259a7ba346';

        function log(msg) {
            document.getElementById('output').textContent += msg + '\n';
            console.log(msg);
        }

        document.getElementById('runBtn').addEventListener('click', async function() {
            this.disabled = true;
            log('Fixing Pete Park handicaps...');
            log('Universal: 3.2');
            log('Travellers (TRGG): 2.1');

            // 1. Update user_profiles - handicap_index and profile_data
            const {data: profile} = await db.from('user_profiles')
                .select('profile_data')
                .eq('line_user_id', PETE_LINE_ID)
                .single();

            const pd = profile?.profile_data || {};
            pd.handicap = '3.2';
            if (!pd.golfInfo) pd.golfInfo = {};
            pd.golfInfo.handicap = '3.2';
            pd.golfInfo.lastHandicapUpdate = new Date().toISOString();

            const {error: e1} = await db.from('user_profiles')
                .update({
                    handicap_index: 3.2,
                    profile_data: pd
                })
                .eq('line_user_id', PETE_LINE_ID);

            if (e1) log('ERROR user_profiles: ' + e1.message);
            else log('✓ user_profiles.handicap_index = 3.2');

            // 2. Update society_handicaps (universal)
            await db.from('society_handicaps')
                .delete()
                .eq('golfer_id', PETE_LINE_ID)
                .is('society_id', null);

            const {error: e2} = await db.from('society_handicaps')
                .insert({
                    golfer_id: PETE_LINE_ID,
                    society_id: null,
                    handicap_index: 3.2,
                    calculation_method: 'MANUAL',
                    last_calculated_at: new Date().toISOString()
                });

            if (e2) log('ERROR universal: ' + e2.message);
            else log('✓ society_handicaps (universal) = 3.2');

            // 3. Update society_handicaps (TRGG/Travellers)
            await db.from('society_handicaps')
                .delete()
                .eq('golfer_id', PETE_LINE_ID)
                .eq('society_id', TRGG_SOCIETY_ID);

            const {error: e3} = await db.from('society_handicaps')
                .insert({
                    golfer_id: PETE_LINE_ID,
                    society_id: TRGG_SOCIETY_ID,
                    handicap_index: 2.1,
                    calculation_method: 'MANUAL',
                    last_calculated_at: new Date().toISOString()
                });

            if (e3) log('ERROR TRGG: ' + e3.message);
            else log('✓ society_handicaps (Travellers) = 2.1');

            // Verify
            log('\n=== VERIFICATION ===');
            const {data: check} = await db.from('user_profiles')
                .select('handicap_index, profile_data')
                .eq('line_user_id', PETE_LINE_ID)
                .single();

            log('user_profiles.handicap_index: ' + check?.handicap_index);
            log('profile_data.handicap: ' + check?.profile_data?.handicap);
            log('profile_data.golfInfo.handicap: ' + check?.profile_data?.golfInfo?.handicap);

            const {data: hcps} = await db.from('society_handicaps')
                .select('society_id, handicap_index')
                .eq('golfer_id', PETE_LINE_ID);

            for (const h of (hcps || [])) {
                const label = h.society_id === null ? 'Universal' : 'Travellers';
                log('society_handicaps [' + label + ']: ' + h.handicap_index);
            }

            log('\nDONE! Refresh mycaddipro.com');
        });
    </script>
</body>
</html>
