<!DOCTYPE html>
<html>
<head>
    <title>Fix Handicaps</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Fix Handicaps - Alan, Ryan, Pluto</h1>
    <button id="runBtn">Click to Fix Handicaps</button>
    <pre id="output"></pre>
    <script>
        const db = window.supabase.createClient(
            'https://pyeeplwsnupmhgbguwqs.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZWVwbHdzbnVwbWhnYmd1d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDM2NjksImV4cCI6MjA3NTQxOTY2OX0.KVQ6WvDKz9s77lxn3AhSA_YTMCN6rsht9kDkMIDhngk'
        );

        function log(msg) {
            document.getElementById('output').textContent += msg + '\n';
            console.log(msg);
        }

        async function fixPlayer(name, handicapValue) {
            log(`\n=== ${name}: Setting to ${handicapValue} ===`);

            // Find player
            const {data: profiles} = await db.from('user_profiles')
                .select('line_user_id, name, profile_data')
                .ilike('name', `%${name}%`);

            if (!profiles || profiles.length === 0) {
                log(`  ERROR: Could not find ${name}`);
                return;
            }

            const player = profiles[0];
            log(`  Found: ${player.name} (${player.line_user_id})`);

            // For plus handicaps, store as string "+X.X" in profile_data
            // For society_handicaps numeric field, use positive number (the system reads the + from profile_data)
            const isPlus = String(handicapValue).startsWith('+');
            const numericValue = isPlus ? parseFloat(String(handicapValue).substring(1)) : parseFloat(handicapValue);
            const displayValue = String(handicapValue); // Keep the + sign for display

            // Update user_profiles.handicap_index and profile_data
            const pd = player.profile_data || {};
            pd.handicap = displayValue;
            if (!pd.golfInfo) pd.golfInfo = {};
            pd.golfInfo.handicap = displayValue;
            pd.golfInfo.lastHandicapUpdate = new Date().toISOString();

            const {error: e1} = await db.from('user_profiles')
                .update({
                    handicap_index: numericValue,
                    profile_data: pd
                })
                .eq('line_user_id', player.line_user_id);

            if (e1) log(`  ERROR updating profile: ${e1.message}`);
            else log(`  Updated user_profiles: handicap_index=${numericValue}, profile_data.handicap="${displayValue}"`);

            // Update society_handicaps (universal) - store numeric value
            const {error: e2} = await db.from('society_handicaps')
                .update({
                    handicap_index: numericValue,
                    calculation_method: 'MANUAL',
                    last_calculated_at: new Date().toISOString()
                })
                .eq('golfer_id', player.line_user_id)
                .is('society_id', null);

            if (e2) log(`  ERROR updating universal: ${e2.message}`);
            else log(`  Updated society_handicaps (universal) = ${numericValue}`);

            return player.line_user_id;
        }

        document.getElementById('runBtn').addEventListener('click', async function() {
            this.disabled = true;
            log('Starting handicap fixes...');

            // Fix Alan Thomas - handicap 9
            await fixPlayer('Alan Thomas', '9');

            // Fix Ryan Thomas - plus handicap +1.6
            await fixPlayer('Thomas, Ryan', '+1.6');

            // Fix Pluto - plus handicap +1.6
            await fixPlayer('Pluto', '+1.6');

            log('\n=== VERIFICATION ===');

            // Verify all three
            for (const name of ['Alan Thomas', 'Thomas, Ryan', 'Pluto']) {
                const {data} = await db.from('user_profiles')
                    .select('name, handicap_index, profile_data')
                    .ilike('name', `%${name.split(',')[0]}%`);
                if (data && data[0]) {
                    log(`${data[0].name}:`);
                    log(`  handicap_index = ${data[0].handicap_index}`);
                    log(`  profile_data.handicap = ${data[0].profile_data?.handicap}`);
                }
            }

            log('\nDONE! Refresh mycaddipro.com to see changes.');
        });
    </script>
</body>
</html>
