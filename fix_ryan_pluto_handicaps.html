<!DOCTYPE html>
<html>
<head>
    <title>Fix Ryan Thomas & Pluto Handicaps</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; }
        button { padding: 10px 20px; font-size: 16px; margin: 5px; cursor: pointer; }
        pre { background: #f0f0f0; padding: 15px; border-radius: 5px; white-space: pre-wrap; max-height: 500px; overflow-y: auto; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        h2 { margin-top: 30px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Fix Ryan & Pluto Society Handicaps</h1>
    <p><strong>Task:</strong> Set their society handicaps back to 1.6</p>

    <button id="fixBtn">Fix Ryan & Pluto Society Handicaps to 1.6</button>

    <h2>Output</h2>
    <pre id="output"></pre>

    <script>
        const db = window.supabase.createClient(
            'https://pyeeplwsnupmhgbguwqs.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZWVwbHdzbnVwbWhnYmd1d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDM2NjksImV4cCI6MjA3NTQxOTY2OX0.KVQ6WvDKz9s77lxn3AhSA_YTMCN6rsht9kDkMIDhngk'
        );

        const TRGG_SOCIETY_ID = '7c0e4b72-d925-44bc-afda-38259a7ba346';
        const RYAN_ID = 'TRGG-GUEST-1002';
        const PLUTO_ID = 'MANUAL-1768008205248-jvtubbk';

        function log(msg, type = '') {
            const span = document.createElement('span');
            span.className = type;
            span.textContent = msg + '\n';
            document.getElementById('output').appendChild(span);
            console.log(msg);
        }

        function clearLog() {
            document.getElementById('output').innerHTML = '';
        }

        // Fix Ryan and Pluto society handicaps to 1.6
        document.getElementById('fixBtn').addEventListener('click', async function() {
            this.disabled = true;
            clearLog();

            log('=== FIXING RYAN & PLUTO SOCIETY HANDICAPS ===\n', 'info');
            log('Target: Set society handicap to 1.6 for both players\n');

            const players = [
                { id: RYAN_ID, name: 'Ryan Thomas' },
                { id: PLUTO_ID, name: 'Pluto' }
            ];

            for (const player of players) {
                log('Processing ' + player.name + ' (' + player.id + ')...', 'info');

                // Check current society handicap
                const { data: existing, error: checkErr } = await db
                    .from('society_handicaps')
                    .select('*')
                    .eq('golfer_id', player.id)
                    .eq('society_id', TRGG_SOCIETY_ID)
                    .single();

                if (checkErr && checkErr.code !== 'PGRST116') {
                    log('  Error checking: ' + checkErr.message, 'error');
                    continue;
                }

                if (existing) {
                    log('  Current society handicap: ' + existing.handicap_index);

                    // Update to 1.6
                    const { error: updateErr } = await db
                        .from('society_handicaps')
                        .update({ handicap_index: 1.6 })
                        .eq('id', existing.id);

                    if (updateErr) {
                        log('  Error updating: ' + updateErr.message, 'error');
                    } else {
                        log('  ✓ Updated to 1.6', 'success');
                    }
                } else {
                    log('  No society handicap found, creating one...');

                    // Insert new society handicap
                    const { error: insertErr } = await db
                        .from('society_handicaps')
                        .insert({
                            golfer_id: player.id,
                            society_id: TRGG_SOCIETY_ID,
                            handicap_index: 1.6,
                            calculation_method: 'MANUAL',
                            last_calculated_at: new Date().toISOString()
                        });

                    if (insertErr) {
                        log('  Error creating: ' + insertErr.message, 'error');
                    } else {
                        log('  ✓ Created with handicap 1.6', 'success');
                    }
                }
            }

            log('\n=== DONE ===', 'success');
            log('Ryan and Pluto should now have society handicap = 1.6');
            log('Their universal handicaps remain at 0');

            this.disabled = false;
        });
    </script>
</body>
</html>
