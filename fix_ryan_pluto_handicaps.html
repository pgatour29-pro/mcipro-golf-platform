<!DOCTYPE html>
<html>
<head>
    <title>Fix Ryan Thomas & Pluto Handicaps</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; }
        button { padding: 10px 20px; font-size: 16px; margin: 5px; cursor: pointer; }
        pre { background: #f0f0f0; padding: 15px; border-radius: 5px; white-space: pre-wrap; max-height: 500px; overflow-y: auto; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        h2 { margin-top: 30px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Fix Negative Handicaps</h1>
    <p><strong>Task:</strong> Find all negative handicaps and convert to positive (plus handicaps)</p>

    <h2>Step 1: Find Negative Handicaps</h2>
    <button id="searchBtn">Find All Negative Handicaps</button>

    <h2>Step 2: Fix Them</h2>
    <button id="fixBtn" disabled>Convert All to Positive</button>

    <h2>Output</h2>
    <pre id="output"></pre>

    <script>
        const db = window.supabase.createClient(
            'https://pyeeplwsnupmhgbguwqs.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZWVwbHdzbnVwbWhnYmd1d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDM2NjksImV4cCI6MjA3NTQxOTY2OX0.KVQ6WvDKz9s77lxn3AhSA_YTMCN6rsht9kDkMIDhngk'
        );

        let negativeHcps = [];

        function log(msg, type = '') {
            const span = document.createElement('span');
            span.className = type;
            span.textContent = msg + '\n';
            document.getElementById('output').appendChild(span);
            console.log(msg);
        }

        function clearLog() {
            document.getElementById('output').innerHTML = '';
        }

        // Step 1: Find all negative handicaps
        document.getElementById('searchBtn').addEventListener('click', async function() {
            this.disabled = true;
            clearLog();

            log('Finding all negative handicaps in society_handicaps...', 'info');

            // Get all handicaps where value is negative
            const { data: allHcps, error } = await db
                .from('society_handicaps')
                .select('*')
                .lt('handicap_index', 0);

            if (error) {
                log('Error: ' + error.message, 'error');
                this.disabled = false;
                return;
            }

            negativeHcps = allHcps || [];
            log('Found ' + negativeHcps.length + ' negative handicaps:\n', 'success');

            for (const h of negativeHcps) {
                const societyLabel = h.society_id ? 'Society' : 'Universal';
                log('  ' + h.golfer_id + ': ' + h.handicap_index + ' (' + societyLabel + ')');
            }

            if (negativeHcps.length > 0) {
                document.getElementById('fixBtn').disabled = false;
                log('\nClick "Convert All to Positive" to fix these.', 'success');
            } else {
                log('\nNo negative handicaps found!', 'success');
            }

            this.disabled = false;
        });

        // Step 2: Convert negative to positive
        document.getElementById('fixBtn').addEventListener('click', async function() {
            this.disabled = true;
            log('\n=== CONVERTING NEGATIVE TO POSITIVE ===\n', 'info');

            let fixed = 0;
            let errors = 0;

            for (const h of negativeHcps) {
                const newValue = Math.abs(h.handicap_index);
                log('Fixing ' + h.golfer_id + ': ' + h.handicap_index + ' → ' + newValue);

                const { error } = await db
                    .from('society_handicaps')
                    .update({ handicap_index: newValue })
                    .eq('id', h.id);

                if (error) {
                    log('  Error: ' + error.message, 'error');
                    errors++;
                } else {
                    log('  ✓ Fixed', 'success');
                    fixed++;
                }
            }

            log('\n=== SUMMARY ===', 'info');
            log('Fixed: ' + fixed);
            log('Errors: ' + errors);
            log('\n✓ DONE!', 'success');
        });
    </script>
</body>
</html>
