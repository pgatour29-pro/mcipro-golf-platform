<!DOCTYPE html>
<html>
<head>
    <title>Fix Ryan Thomas & Pluto Handicaps</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; }
        button { padding: 10px 20px; font-size: 16px; margin: 5px; cursor: pointer; }
        pre { background: #f0f0f0; padding: 15px; border-radius: 5px; white-space: pre-wrap; max-height: 500px; overflow-y: auto; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        h2 { margin-top: 30px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Fix Ryan Thomas & Pluto Handicaps</h1>
    <p><strong>Task:</strong> Find them in society_members, create universal handicap = 0</p>
    <p><strong>Current:</strong> Society handicap = +1.6 (stored as -1.6)</p>

    <h2>Step 1: Search All Tables</h2>
    <button id="searchBtn">Search for Ryan Thomas & Pluto</button>

    <h2>Step 2: Fix Handicaps (after finding IDs)</h2>
    <button id="fixBtn" disabled>Create Universal Handicap = 0</button>

    <h2>Output</h2>
    <pre id="output"></pre>

    <script>
        const db = window.supabase.createClient(
            'https://pyeeplwsnupmhgbguwqs.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZWVwbHdzbnVwbWhnYmd1d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDM2NjksImV4cCI6MjA3NTQxOTY2OX0.KVQ6WvDKz9s77lxn3AhSA_YTMCN6rsht9kDkMIDhngk'
        );

        const TRGG_SOCIETY_ID = '7c0e4b72-d925-44bc-afda-38259a7ba346';
        let ryanId = null;
        let plutoId = null;

        function log(msg, type = '') {
            const span = document.createElement('span');
            span.className = type;
            span.textContent = msg + '\n';
            document.getElementById('output').appendChild(span);
            console.log(msg);
        }

        function clearLog() {
            document.getElementById('output').innerHTML = '';
        }

        // Step 1: Search all tables
        document.getElementById('searchBtn').addEventListener('click', async function() {
            this.disabled = true;
            clearLog();

            log('Searching multiple tables for Ryan & Pluto...', 'info');

            // Try golfers table
            log('\n1. Checking golfers table...');
            const { data: golfers, error: golfersErr } = await db
                .from('golfers')
                .select('*');

            if (golfersErr) {
                log('   golfers table: ' + golfersErr.message, 'error');
            } else {
                log('   golfers table: ' + (golfers?.length || 0) + ' records', 'success');
                if (golfers && golfers.length > 0) {
                    log('   Sample keys: ' + Object.keys(golfers[0]).join(', '));
                    const ryanG = golfers.filter(g => JSON.stringify(g).toLowerCase().includes('ryan'));
                    const plutoG = golfers.filter(g => JSON.stringify(g).toLowerCase().includes('pluto'));
                    if (ryanG.length) log('   FOUND RYAN: ' + JSON.stringify(ryanG[0]), 'success');
                    if (plutoG.length) log('   FOUND PLUTO: ' + JSON.stringify(plutoG[0]), 'success');
                }
            }

            // Try players table
            log('\n2. Checking players table...');
            const { data: players, error: playersErr } = await db
                .from('players')
                .select('*');

            if (playersErr) {
                log('   players table: ' + playersErr.message, 'error');
            } else {
                log('   players table: ' + (players?.length || 0) + ' records', 'success');
                if (players && players.length > 0) {
                    log('   Sample keys: ' + Object.keys(players[0]).join(', '));
                    const ryanP = players.filter(p => JSON.stringify(p).toLowerCase().includes('ryan'));
                    const plutoP = players.filter(p => JSON.stringify(p).toLowerCase().includes('pluto'));
                    if (ryanP.length) log('   FOUND RYAN: ' + JSON.stringify(ryanP[0]), 'success');
                    if (plutoP.length) log('   FOUND PLUTO: ' + JSON.stringify(plutoP[0]), 'success');
                }
            }

            // Try society_players table
            log('\n3. Checking society_players table...');
            const { data: socPlayers, error: socPlayersErr } = await db
                .from('society_players')
                .select('*')
                .eq('society_id', TRGG_SOCIETY_ID);

            if (socPlayersErr) {
                log('   society_players table: ' + socPlayersErr.message, 'error');
            } else {
                log('   society_players table: ' + (socPlayers?.length || 0) + ' records', 'success');
                if (socPlayers && socPlayers.length > 0) {
                    log('   Sample keys: ' + Object.keys(socPlayers[0]).join(', '));
                    const ryanSP = socPlayers.filter(p => JSON.stringify(p).toLowerCase().includes('ryan'));
                    const plutoSP = socPlayers.filter(p => JSON.stringify(p).toLowerCase().includes('pluto'));
                    if (ryanSP.length) log('   FOUND RYAN: ' + JSON.stringify(ryanSP[0]), 'success');
                    if (plutoSP.length) log('   FOUND PLUTO: ' + JSON.stringify(plutoSP[0]), 'success');
                }
            }

            // Try user_profiles directly searching all
            log('\n4. Checking ALL user_profiles...');
            const { data: allProfiles, error: allProfilesErr } = await db
                .from('user_profiles')
                .select('*');

            if (allProfilesErr) {
                log('   user_profiles: ' + allProfilesErr.message, 'error');
            } else {
                log('   user_profiles: ' + (allProfiles?.length || 0) + ' records', 'success');
                const ryanUP = allProfiles?.filter(p => JSON.stringify(p).toLowerCase().includes('ryan')) || [];
                const plutoUP = allProfiles?.filter(p => JSON.stringify(p).toLowerCase().includes('pluto')) || [];
                if (ryanUP.length) {
                    log('   FOUND RYAN in user_profiles!', 'success');
                    log('   ' + JSON.stringify(ryanUP[0]).substring(0, 500));
                    ryanId = ryanUP[0].line_user_id;
                }
                if (plutoUP.length) {
                    log('   FOUND PLUTO in user_profiles!', 'success');
                    log('   ' + JSON.stringify(plutoUP[0]).substring(0, 500));
                    plutoId = plutoUP[0].line_user_id;
                }
            }

            // Try society_handicaps directly
            log('\n5. Checking society_handicaps...');
            const { data: allHcps, error: allHcpsErr } = await db
                .from('society_handicaps')
                .select('*')
                .eq('society_id', TRGG_SOCIETY_ID);

            if (allHcpsErr) {
                log('   society_handicaps: ' + allHcpsErr.message, 'error');
            } else {
                log('   society_handicaps for TRGG: ' + (allHcps?.length || 0) + ' records', 'success');
                if (allHcps && allHcps.length > 0) {
                    log('   Sample: ' + JSON.stringify(allHcps[0]));
                }
            }

            // 6. Try rounds table - players might be stored there
            log('\n6. Checking rounds table...');
            const { data: rounds, error: roundsErr } = await db
                .from('rounds')
                .select('*')
                .limit(10);

            if (roundsErr) {
                log('   rounds: ' + roundsErr.message, 'error');
            } else {
                log('   rounds: ' + (rounds?.length || 0) + ' sample records', 'success');
                if (rounds && rounds.length > 0) {
                    log('   Sample keys: ' + Object.keys(rounds[0]).join(', '));
                    const ryanR = rounds.filter(r => JSON.stringify(r).toLowerCase().includes('ryan'));
                    if (ryanR.length) log('   FOUND RYAN in rounds: ' + JSON.stringify(ryanR[0]).substring(0, 300), 'success');
                }
            }

            // 7. List ALL tables we can access
            log('\n7. Testing additional tables...');
            const tablesToTest = ['members', 'guests', 'manual_players', 'event_players', 'tournament_players', 'registered_players'];
            for (const table of tablesToTest) {
                const { data, error } = await db.from(table).select('*').limit(1);
                if (!error) {
                    log('   ✅ ' + table + ' table EXISTS - has data: ' + (data?.length > 0), 'success');
                    if (data?.length > 0) log('      Keys: ' + Object.keys(data[0]).join(', '));
                }
            }

            // Placeholder for combined members
            const membersWithNames = [];
            const lineUserIds = [];

            // Helper to get name from member - check ALL possible locations
            function getMemberName(m) {
                return m.name ||
                       m.display_name ||
                       m.displayName ||
                       m.full_name ||
                       m.member_data?.name ||
                       m.member_data?.displayName ||
                       m.member_data?.full_name ||
                       m.profile_data?.name ||
                       m.profile_data?.displayName ||
                       '';
            }

            // Search by converting entire record to string
            function searchInRecord(m, term) {
                const str = JSON.stringify(m).toLowerCase();
                return str.includes(term.toLowerCase());
            }

            // Search for Ryan
            log('=== SEARCHING FOR RYAN THOMAS ===\n', 'info');
            const ryanMatches = membersWithNames.filter(m => searchInRecord(m, 'ryan'));

            if (ryanMatches.length > 0) {
                log('Found ' + ryanMatches.length + ' matches:', 'success');
                for (const m of ryanMatches) {
                    log('  Name: ' + getMemberName(m));
                    log('  ID: ' + m.id);
                    log('  golfer_id: ' + m.golfer_id);
                    log('  Handicap: ' + (m.handicap || m.member_data?.handicap || 'N/A'));
                    log('  RAW: ' + JSON.stringify(m).substring(0, 500));
                    ryanId = m.golfer_id || m.id;
                    log('  >>> Using golfer_id: ' + ryanId, 'success');
                    log('');
                }
            } else {
                log('No matches found for "ryan"', 'error');
            }

            // Check Ryan's handicaps
            if (ryanId) {
                const { data: ryanHcps } = await db
                    .from('society_handicaps')
                    .select('*')
                    .eq('golfer_id', ryanId);

                if (ryanHcps && ryanHcps.length > 0) {
                    log('Current handicaps for Ryan:', 'info');
                    for (const h of ryanHcps) {
                        const label = h.society_id === null ? 'UNIVERSAL' : 'Society';
                        log('  ' + label + ': ' + h.handicap_index);
                    }
                } else {
                    log('No handicaps in society_handicaps yet');
                }
            }

            // Search for Pluto
            log('\n=== SEARCHING FOR PLUTO ===\n', 'info');
            const plutoMatches = membersWithNames.filter(m => searchInRecord(m, 'pluto'));

            if (plutoMatches.length > 0) {
                log('Found ' + plutoMatches.length + ' matches:', 'success');
                for (const m of plutoMatches) {
                    log('  Name: ' + getMemberName(m));
                    log('  ID: ' + m.id);
                    log('  golfer_id: ' + m.golfer_id);
                    log('  Handicap: ' + (m.handicap || m.member_data?.handicap || 'N/A'));
                    log('  RAW: ' + JSON.stringify(m).substring(0, 500));
                    plutoId = m.golfer_id || m.id;
                    log('  >>> Using golfer_id: ' + plutoId, 'success');
                    log('');
                }
            } else {
                log('No matches found for "pluto"', 'error');
            }

            // Check Pluto's handicaps
            if (plutoId) {
                const { data: plutoHcps } = await db
                    .from('society_handicaps')
                    .select('*')
                    .eq('golfer_id', plutoId);

                if (plutoHcps && plutoHcps.length > 0) {
                    log('Current handicaps for Pluto:', 'info');
                    for (const h of plutoHcps) {
                        const label = h.society_id === null ? 'UNIVERSAL' : 'Society';
                        log('  ' + label + ': ' + h.handicap_index);
                    }
                } else {
                    log('No handicaps in society_handicaps yet');
                }
            }

            // Summary
            log('\n=== SUMMARY ===', 'info');
            log('Ryan Thomas ID: ' + (ryanId || 'NOT FOUND'));
            log('Pluto ID: ' + (plutoId || 'NOT FOUND'));

            if (ryanId || plutoId) {
                document.getElementById('fixBtn').disabled = false;
                log('\nClick "Create Universal Handicap = 0" to fix.', 'success');
            } else {
                log('\nNo IDs found. Cannot create handicaps.', 'error');
                log('\nDEBUG - Members with names (first 20):');
                const withNames = membersWithNames.filter(m => m.name && !m.name.startsWith('TRGG-') && !m.name.startsWith('U'));
                for (let i = 0; i < Math.min(20, withNames.length); i++) {
                    log('  ' + withNames[i].name + ' (golfer_id: ' + withNames[i].golfer_id + ')');
                }
                if (withNames.length === 0) {
                    log('  No members with profile names found');
                    log('\nAll LINE user golfer_ids:');
                    for (let i = 0; i < Math.min(10, lineUserIds.length); i++) {
                        log('  ' + lineUserIds[i]);
                    }
                }
            }

            this.disabled = false;
        });

        // Step 2: Create universal handicaps
        document.getElementById('fixBtn').addEventListener('click', async function() {
            this.disabled = true;
            log('\n=== CREATING UNIVERSAL HANDICAPS ===\n', 'info');

            if (ryanId) {
                log('Creating universal handicap for Ryan Thomas (ID: ' + ryanId + ')...');

                // Delete existing universal if any
                await db.from('society_handicaps')
                    .delete()
                    .eq('golfer_id', ryanId)
                    .is('society_id', null);

                // Insert universal = 0
                const { error } = await db.from('society_handicaps')
                    .insert({
                        golfer_id: ryanId,
                        society_id: null,
                        handicap_index: 0,
                        calculation_method: 'MANUAL',
                        last_calculated_at: new Date().toISOString()
                    });

                if (error) {
                    log('  Error: ' + error.message, 'error');
                } else {
                    log('  ✓ Ryan Thomas universal handicap = 0', 'success');
                }
            }

            if (plutoId) {
                log('Creating universal handicap for Pluto (ID: ' + plutoId + ')...');

                // Delete existing universal if any
                await db.from('society_handicaps')
                    .delete()
                    .eq('golfer_id', plutoId)
                    .is('society_id', null);

                // Insert universal = 0
                const { error } = await db.from('society_handicaps')
                    .insert({
                        golfer_id: plutoId,
                        society_id: null,
                        handicap_index: 0,
                        calculation_method: 'MANUAL',
                        last_calculated_at: new Date().toISOString()
                    });

                if (error) {
                    log('  Error: ' + error.message, 'error');
                } else {
                    log('  ✓ Pluto universal handicap = 0', 'success');
                }
            }

            // Verify
            log('\n=== VERIFICATION ===', 'info');

            if (ryanId) {
                const { data: ryanHcps } = await db
                    .from('society_handicaps')
                    .select('society_id, handicap_index')
                    .eq('golfer_id', ryanId);

                log('\nRyan Thomas handicaps:');
                for (const h of (ryanHcps || [])) {
                    const label = h.society_id === null ? 'Universal' : 'Society';
                    log('  ' + label + ': ' + h.handicap_index);
                }
            }

            if (plutoId) {
                const { data: plutoHcps } = await db
                    .from('society_handicaps')
                    .select('society_id, handicap_index')
                    .eq('golfer_id', plutoId);

                log('\nPluto handicaps:');
                for (const h of (plutoHcps || [])) {
                    const label = h.society_id === null ? 'Universal' : 'Society';
                    log('  ' + label + ': ' + h.handicap_index);
                }
            }

            log('\n✓ DONE!', 'success');
        });
    </script>
</body>
</html>
