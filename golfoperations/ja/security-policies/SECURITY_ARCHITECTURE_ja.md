# MciProセキュリティアーキテクチャ

## 完全なスタッフセキュリティシステムドキュメント

---

## 🔒 概要

MciProスタッフセキュリティシステムは、**4層防御戦略**を実装し、正規のスタッフとゴルファーにシームレスな体験を維持しながら、不正アクセスを防止します。

**設計原則**:
- ✓ ゴルファーにとってゼロ摩擦(変更なしのワンクリックLINE登録)
- ✓ ほとんどのスタッフにとってセルフサービス(認証後即座にアクセス)
- ✓ 機密性の高い役職のみマネージャー承認
- ✓ コース固有の分離(各ゴルフコースは独立)
- ✓ LINE電話番号ロック(1アカウント = 1電話番号)
- ✓ 複数のゴルフコースにスケーラブル

---

## 🛡️ セキュリティレイヤー

### レイヤー1: LINE前の役割選択

**目的**: ゴルファーとスタッフの登録フローを分離

**実装**:
- ランディングページで2つのパスを提供:
  - **「私はゴルファーです」** → 直接LINE ログイン → ワンクリックプロファイル作成
  - **「私はスタッフ/キャディです」** → まずスタッフ認証画面

**セキュリティ上の利点**: 一般ユーザーが偶然または意図的にスタッフ登録にアクセスすることを防止

**ファイル**: `index.html` (ランディングページルーティング)

---

### レイヤー2: ゴルフコースコード認証

**目的**: コース固有のコードを持つ認証済みスタッフのみが登録できるようにする

**動作方法**:
1. 各ゴルフコースは一意の4桁コードを持つ
2. コードは`localStorage`に保存: `golf_course_settings.staffRegistrationCode`
3. コードはGMのスタッフ管理ダッシュボードに表示される
4. GMはいつでもコードを変更可能(推奨: 月次)
5. スタッフは認証をパスするために正しいコードを入力する必要がある

**コード管理**:
```javascript
// 場所: staff-security.js
getCourseSettings() {
    return JSON.parse(localStorage.getItem('golf_course_settings') ||
        '{"staffRegistrationCode": "0000"}');
}

saveCourseSettings(settings) {
    localStorage.setItem('golf_course_settings', JSON.stringify(settings));
}
```

**GMインターフェース**:
- **場所**: スタッフ管理タブ → トップセクション
- **アクション**:
  - 現在のコードを表示
  - 「コードを変更」ボタンをクリック
  - 新しい4桁コードを入力
  - 保存してスタッフに配布

**セキュリティ上の利点**:
- ✓ コース固有の分離
- ✓ クロスコース不正アクセスを防止
- ✓ 簡単に取り消し可能(月次でコード変更)
- ✓ トレーサブル(コード変更履歴がログされる)
- ✓ スタッフが覚えやすい

**ベストプラクティス**:
- 月次でコードを変更(毎月1日)
- スタッフ退職後すぐに変更(機密性の高い役職の場合)
- コードが漏洩した場合は変更
- 公開で共有しない(内部配布のみ)
- 明白でない組み合わせを使用(1234、0000、1111などを避ける)

---

### レイヤー3: 従業員ID検証

**目的**: スタッフが適切な識別フォーマットを使用し、重複を防止することを保証

**従業員IDフォーマット**:
```
部門             | フォーマット | 例
─────────────────┼─────────────┼──────────
キャディ         | PAT-###     | PAT-001 から PAT-999
プロショップ     | PS-###      | PS-001, PS-012
レストラン/F&B   | FB-###      | FB-007, FB-023
メンテナンス     | MAINT-###   | MAINT-005
マネジメント     | MGR-###     | MGR-001
経理             | ACCT-###    | ACCT-001
受付             | RCP-###     | RCP-003
セキュリティ     | SEC-###     | SEC-002
```

**検証ロジック**:
```javascript
// 場所: staff-security.js:112-120
validateEmployeeId(employeeId, department) {
    const formats = this.getEmployeeIdFormat();
    const format = formats[department];
    if (!format) return false;

    const regex = new RegExp(`^${format.prefix}-\\d{${format.length}}$`);
    return regex.test(employeeId);
}
```

**重複防止**:
```javascript
// 場所: staff-security.js:284-289
const staff = JSON.parse(localStorage.getItem('staff_members') || '[]');
const exists = staff.find(s => s.employeeId === employeeId);

if (exists) {
    return { success: false, error: 'This Employee ID is already registered' };
}
```

**セキュリティ上の利点**:
- ✓ ランダムなID入力を防止
- ✓ 部門固有のフォーマットが組織を強化
- ✓ 重複検出により従業員ごとの複数アカウントを防止
- ✓ 監査が容易(フォーマットで即座に部門を表示)
- ✓ スケーラブル(新しい部門用に新しいフォーマットを追加)

---

### レイヤー4: マネージャー承認キュー

**目的**: アクセスを許可する前に機密性の高い役職の追加認証

**承認が必要な役職**:
- **マネジメント** (MGR-###): 完全なシステムアクセス
- **プロショップ** (PS-###): 金融取引、在庫
- **経理** (ACCT-###): 財務データアクセス

**即座にアクセス可能な役職** (承認不要):
- キャディ (PAT-###)
- レストラン/F&B (FB-###)
- メンテナンス (MAINT-###)
- 受付 (RCP-###)
- セキュリティ (SEC-###)

**承認ロジック**:
```javascript
// 場所: staff-security.js:155-161
requiresApproval(department, position) {
    const sensitiveRoles = ['management', 'proshop'];
    const sensitivePositions = ['manager', 'accounting', 'acct', 'pro shop'];

    return sensitiveRoles.includes(department) ||
           sensitivePositions.some(role => position.toLowerCase().includes(role));
}
```

**承認ワークフロー**:

1. **スタッフが登録**:
   - 認証を完了(レイヤー2および3)
   - LINE経由で認証
   - プロファイルを作成
   - ステータスを`pending_approval`に設定
   - ダッシュボードに「承認待ち」メッセージを表示

2. **マネージャーへの通知**:
   - 承認待ちスタッフがスタッフ管理に表示される
   - 黄色の通知バナー
   - カウント表示: 「承認待ち(3)」

3. **マネージャーがレビュー**:
   - スタッフの詳細を表示:
     - 名前
     - 従業員ID
     - 部門
     - 電話番号
     - メールアドレス
     - LINE認証ステータス ✓
   - 決定: 承認または拒否

4. **承認**:
   - 「承認」ボタンをクリック
   - ステータスが`active`に変更
   - スタッフは即座にアクセス可能
   - 承認タイムスタンプと承認者が記録される

5. **拒否**:
   - 「拒否」ボタンをクリック
   - プロファイルが完全に削除される
   - スタッフはログインできない
   - 正しい情報で再登録する必要がある

**マネージャーダッシュボードインターフェース**:
```javascript
// 場所: staff-security.js:196-263
renderPendingApprovalsUI() {
    const pending = this.getPendingApprovals();
    // 以下を含む黄色の通知ボックスをレンダリング:
    // - スタッフ名とポジション
    // - 従業員ID
    // - 連絡先情報
    // - LINE認証ステータス
    // - 承認/拒否ボタン
}
```

**セキュリティ上の利点**:
- ✓ 高権限役職の人的検証
- ✓ 自動大量登録を防止
- ✓ マネージャーが正規の従業員を認識
- ✓ 迅速な承認(平均24時間)
- ✓ 監査証跡(誰が承認したか、いつ)
- ✓ 疑わしいリクエストを拒否可能

---

### レイヤー5: LINE電話番号ロック(既存)

**目的**: LINEの組み込みセキュリティを使用して、1人 = 1アカウントを保証

**LINEの動作方法**:
- 1 LINEアカウント = 1電話番号(LINEによって認証)
- 電話番号はLINEによってSMSで認証される
- 同じ電話番号で複数のLINEアカウントを作成できない
- MciProで同じLINEアカウントを2回登録できない

**MciPro統合**:
```javascript
// 各プロファイルはlineUserIdにリンクされる(一意の識別子)
const profile = {
    lineUserId: 'U1234567890abcdef...',  // 一意のLINE ID
    // ... その他のプロファイルデータ
};
```

**重複防止**:
- システムは`lineUserId`が既に存在するかチェック
- 存在する場合、既存のプロファイルをロード(リターニングユーザー)
- 新規の場合、新しいプロファイルを作成
- 1 LINE ID = 1 MciProプロファイル

**セキュリティ上の利点**:
- ✓ LINEによる本人確認(信頼できる第三者)
- ✓ SMSによる電話番号認証
- ✓ 同じ電話番号で複数のアカウントを作成できない
- ✓ スマートフォンなしでは登録できない
- ✓ ボット/自動登録を防止
- ✓ 携帯電話を紛失 = LINEを回復 = MciProアクセスを回復

---

## 📊 データフロー図

### ゴルファー登録フロー

```
ゴルファーが「LINEでログイン」をクリック
          ↓
    LINE認証
          ↓
  LINEプロファイルを返す
          ↓
    lineUserIdが存在するかチェック
          ↓
    ┌─────┴─────┐
    ↓           ↓
 存在する      新規ユーザー
    ↓           ↓
プロファイルロード  プロファイル作成
    ↓           ↓
ダッシュボード   ダッシュボード
```

**時間**: 約30秒
**ユーザーアクション**: 2クリック
**セキュリティチェック**: 1(LINE電話認証)

---

### スタッフ登録フロー(非機密)

```
スタッフが「私はスタッフ/キャディです」をクリック
          ↓
  スタッフ認証ページ
          ↓
  入力: コースコード + 部門 + 従業員ID
          ↓
  検証:
  1. ✓ コースコードが一致
  2. ✓ 従業員IDフォーマットが正しい
  3. ✓ 従業員IDの重複なし
          ↓
  sessionStorageに保存
          ↓
  LINE認証にリダイレクト
          ↓
  LINEプロファイルを返す
          ↓
  スタッフプロファイルを作成
  • 役割 → 部門マッピング
  • ステータス = 'active' (即座にアクセス)
  • staff_membersに保存
          ↓
  ダッシュボード(即座にアクセス)
```

**時間**: 約2-3分
**ユーザーアクション**: 7入力、3クリック
**セキュリティチェック**: 4(コード、フォーマット、重複、LINE)

---

### スタッフ登録フロー(機密役職)

```
スタッフが「私はスタッフ/キャディです」をクリック
          ↓
  スタッフ認証ページ
          ↓
  入力: コースコード + 部門 + 従業員ID
          ↓
  検証(上記と同じ)
          ↓
  LINE認証
          ↓
  スタッフプロファイルを作成
  • ステータス = 'pending_approval'
  • staff_membersに保存
          ↓
  「承認待ち」画面
          ↓
  ┌─────────────────────────┐
  │   マネージャーダッシュボード  │
  │   承認待ち                  │
  │   [スタッフ詳細]            │
  │   [承認] [拒否]             │
  └─────────────────────────┘
          ↓
  マネージャーが「承認」をクリック
          ↓
  ステータス → 'active'
          ↓
  スタッフにLINE通知
          ↓
  スタッフがログイン
          ↓
  ダッシュボード(アクセス可能に)
```

**時間**: 2-3分(登録) + 承認待ち
**待ち時間**: 平均1-24時間
**セキュリティチェック**: 5(コード、フォーマット、重複、LINE、人的検証)

---

## 🗄️ データストレージ

### localStorageキー

**1. golf_course_settings**
```json
{
  "staffRegistrationCode": "1234",
  "courseName": "Greenview Golf Club",
  "lastCodeUpdate": "2025-10-07T10:30:00.000Z",
  "courseId": "GVC-001",
  "managerName": "John Manager"
}
```

**目的**: コース固有の設定を保存
**セキュリティ**: クライアント側に保存、コース固有
**アクセス**: GMはスタッフ管理ダッシュボード経由で変更可能

---

**2. staff_members**
```json
[
  {
    "id": "STAFF-1728284930123",
    "firstName": "John",
    "lastName": "Smith",
    "employeeId": "PAT-023",
    "department": "caddy",
    "position": "Caddie",
    "phone": "+66 12 345 6789",
    "email": "john.smith@email.com",
    "status": "active",
    "hireDate": "2025-10-01",
    "lineUserId": "U1234567890abcdef",
    "caddyLicense": "PAT-023",
    "experienceLevel": "Expert",
    "gpsTrackerId": "GPS-PAT-023",
    "languages": "English, Thai",
    "workingStatus": "off-duty",
    "currentLocation": null,
    "rating": 4.8,
    "totalAssignments": 247,
    "totalTips": 125400,
    "approvedAt": "2025-10-01T09:15:00.000Z",
    "approvedBy": "Jane Manager"
  },
  {
    "id": "STAFF-1728285930456",
    "firstName": "Sarah",
    "lastName": "Johnson",
    "employeeId": "PS-001",
    "department": "proshop",
    "position": "Pro Shop Manager",
    "phone": "+66 87 654 3210",
    "email": "sarah.johnson@email.com",
    "status": "pending_approval",
    "hireDate": "2025-10-07",
    "lineUserId": "U0987654321fedcba",
    "approvedAt": null,
    "approvedBy": null
  }
]
```

**目的**: すべてのスタッフプロファイルを保存
**セキュリティ**: ステータスフィールドがアクセスを制御
**アクセス**: GMは表示/編集可能、スタッフは自分のプロファイルを表示可能

---

**3. mcipro_user_profiles** (統合プロファイル)
```json
[
  {
    "id": "USER-1728284930123",
    "lineUserId": "U1234567890abcdef",
    "firstName": "John",
    "lastName": "Smith",
    "phone": "+66 12 345 6789",
    "email": "john.smith@email.com",
    "role": "caddie",
    "roleSpecific": {
      "caddyNumber": "PAT-023",
      "experience": "Expert",
      "languages": ["English", "Thai"]
    }
  }
]
```

**目的**: 統合プロファイルストレージ(ゴルファー + スタッフ)
**セキュリティ**: 役割フィールドがダッシュボードアクセスを決定
**アクセス**: 認証とプロファイルロードに使用

---

### sessionStorageキー

**staff_verification** (一時的)
```json
{
  "verified": true,
  "courseCode": "1234",
  "department": "caddy",
  "employeeId": "PAT-023",
  "timestamp": 1728284930123
}
```

**目的**: 登録中の一時的なストレージ
**セキュリティ**: 登録完了後にクリアされる
**有効期限**: セッションのみ(ブラウザタブを閉じると終了)

---

## 🔐 セキュリティベストプラクティス

### ゴルフコース管理向け

**1. 登録コード管理**:
- ✓ 毎月1日にコードを変更
- ✓ 連続しない番号を使用(1234、0000を避ける)
- ✓ コードを安全に配布(対面、プライベートメッセージ)
- ✓ コード変更を日付とともにログ
- ✓ 漏洩した場合は即座に変更
- ✓ 複数コース運営には異なるコードを使用

**2. 承認キュー監視**:
- ✓ 毎日承認待ちをチェック
- ✓ 承認前に従業員の正当性を確認
- ✓ 疑わしい登録を調査
- ✓ 未知/未承認の試みを拒否
- ✓ すべての承認/拒否を文書化
- ✓ 応答時間: 24時間以内

**3. スタッフ名簿監査**:
- ✓ 週次: アクティブスタッフリストをレビュー
- ✓ 月次: 完全な名簿監査
- ✓ 四半期: すべての従業員IDを確認
- ✓ 退職スタッフを即座に無効化
- ✓ 重複アカウントをチェック
- ✓ 部門割り当てを確認

**4. アクセス制御**:
- ✓ 退職時にスタッフを無効化(同日)
- ✓ スタッフアクセスログを定期的にレビュー
- ✓ 異常な活動パターンを監視
- ✓ ログイン失敗の試みを調査
- ✓ セキュリティインシデントを即座に報告

---

### スタッフ向け

**1. 登録セキュリティ**:
- ✓ コースコードを機密に保つ
- ✓ 従業員IDを共有しない
- ✓ ロック画面付きの安全な電話を使用
- ✓ LINEアプリを最新に保つ
- ✓ 携帯電話を紛失した場合は即座に報告

**2. アカウントセキュリティ**:
- ✓ LINEパスワードを安全に保つ
- ✓ LINE二要素認証を有効化
- ✓ 共有デバイスではログアウト
- ✓ ログイン資格情報を共有しない
- ✓ 疑わしい活動を報告

**3. データ保護**:
- ✓ 顧客データを共有しない
- ✓ 機密情報をスクリーンショットしない
- ✓ データプライバシーポリシーに従う
- ✓ データ侵害を即座に報告

---

## 🚨 セキュリティインシデント対応

### 不正アクセス試行

**指標**:
- 複数回のコード試行失敗
- 疑わしい従業員ID
- 繰り返し登録試行
- 承認待ちの未知の名前

**対応プロトコル**:
1. **即座**: 承認待ちを拒否
2. **即座**: スタッフ登録コードを変更
3. **1時間以内**: すべての部門長に通知
4. **4時間以内**: 新しいコードを安全に配布
5. **24時間以内**: 完全なスタッフ名簿監査
6. **48時間以内**: セキュリティログをレビュー
7. **文書化**: 完全なインシデントレポート

---

### コード漏洩

**指標**:
- コードが公開で共有された(ソーシャルメディアなど)
- 未知のスタッフ登録
- 元従業員がまだコードを持っている

**対応プロトコル**:
1. **即座**: コードを変更
2. **即座**: 最近の登録をレビュー
3. **1時間以内**: マネージャーに通知
4. **4時間以内**: 新しいコードを配布
5. **24時間以内**: 疑わしいアカウントを無効化
6. **48時間以内**: セキュリティレビュー

---

### スタッフアカウント侵害

**指標**:
- スタッフが不正アクセスを報告
- アカウントでの異常な活動
- 予期しない場所からのログイン
- LINEアカウントが侵害された

**対応プロトコル**:
1. **即座**: スタッフアカウントを無効化
2. **即座**: IT/セキュリティチームに通知
3. **1時間以内**: スタッフがLINEパスワードを変更
4. **4時間以内**: アカウント活動をレビュー
5. **24時間以内**: 安全であれば再有効化
6. **文書化**: インシデントレポート

---

## 📈 セキュリティ監視と監査

### 自動アラート

**システム監視**:
- コード試行失敗(10分で3回以上)
- 従業員IDの重複試行
- 48時間以上前の承認待ち
- スタッフアカウントログイン失敗(5回以上)
- 異常なアクセスパターン

**アラート受信者**:
- ゼネラルマネージャー
- IT/セキュリティチーム
- システム管理者

---

### 監査ログ

**ログされる内容**:
```
イベントタイプ      | 記録されるデータ
────────────────────┼──────────────────────────────────
スタッフ登録        | 時間、従業員ID、部門、IP
コード変更          | 時間、旧コード、新コード、変更者
承認/拒否           | 時間、スタッフID、決定、マネージャー
ログイン            | 時間、LINEユーザーID、成功/失敗
プロファイル更新    | 時間、変更されたフィールド、旧/新値
```

**ログ保持**: 最低12ヶ月

**アクセス**: ゼネラルマネージャー、IT/セキュリティチーム

---

### 定期的なセキュリティレビュー

**週次**:
- 承認待ちステータス
- 最近の登録レビュー
- アクセス試行失敗
- スタッフ名簿変更

**月次**:
- 完全なスタッフ名簿監査
- コード変更(推奨)
- セキュリティログレビュー
- アクセスパターン分析
- インシデント概要

**四半期**:
- 包括的なセキュリティ監査
- ポリシーレビュー
- スタッフセキュリティトレーニング
- システム脆弱性評価
- コンプライアンスチェック

**年次**:
- 完全なシステムセキュリティレビュー
- 侵入テスト
- ポリシー更新
- スタッフセキュリティ認証
- 第三者監査(該当する場合)

---

## 📋 コンプライアンスとプライバシー

### データプライバシー(PDPA準拠)

**収集される個人データ**:
- 名前
- 電話番号
- メールアドレス(オプション)
- LINEユーザーID
- 従業員ID
- 部門
- 雇用履歴

**データ使用**:
- スタッフ管理
- アクセス制御
- パフォーマンス追跡
- コミュニケーション
- 給与(統合されている場合)

**データ保護**:
- ローカルに保存(クライアント側)
- 同意なしのクラウドストレージなし
- 暗号化された送信(HTTPS)
- 役割によるアクセス制限
- 監査証跡を維持

**データ権利**:
- スタッフは自分のデータを表示可能
- スタッフは訂正を要求可能
- スタッフは削除を要求可能(雇用終了時)
- スタッフは自分のデータをエクスポート可能

---

### アクセス制御ポリシー

**役割ベースのアクセス**:

**ゼネラルマネージャー**:
- ✓ 完全なシステムアクセス
- ✓ すべてのスタッフを表示
- ✓ 登録を承認/拒否
- ✓ 登録コードを変更
- ✓ すべてのレポートを表示
- ✓ データをエクスポート

**部門マネージャー**:
- ✓ 部門スタッフを表示
- ✓ 部門スタッフを編集
- ✓ 部門レポートを表示
- ✗ スタッフを承認できない
- ✗ コードを変更できない

**スタッフ**:
- ✓ 自分のプロファイルを表示
- ✓ 自分の連絡先情報を編集
- ✓ 自分のスケジュールを表示
- ✓ 自分のパフォーマンスを表示
- ✗ 他のスタッフを表示できない
- ✗ 管理機能にアクセスできない

---

## 🔗 関連ドキュメント

- [ゼネラルマネージャーガイド](../general-manager/README.md)
- [スタッフ登録ガイド](../staff-registration/HOW_TO_REGISTER.md)
- [トラブルシューティング](../troubleshooting/COMMON_ISSUES.md)
- [技術実装](../../STAFF_SECURITY_IMPLEMENTATION.md)

---

## 📞 セキュリティ連絡先

**セキュリティ問題を報告**:
- メール: security@mcipro.com
- 電話: [緊急セキュリティライン]
- 対面: ゼネラルマネージャーオフィス

**技術的な問題**:
- メール: support@mcipro.com
- 電話: [ITサポートライン]

---

**最終更新**: 2025年10月7日
**バージョン**: 1.0
**次回レビュー**: 2025年11月7日
**分類**: 社内使用のみ
