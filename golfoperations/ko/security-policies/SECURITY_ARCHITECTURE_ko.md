# MciPro 보안 아키텍처

## 완전한 직원 보안 시스템 문서

---

## 🔒 개요

MciPro 직원 보안 시스템은 **4계층 방어 전략**을 구현하여 정당한 직원과 골퍼들에게 원활한 경험을 제공하면서 무단 액세스를 방지합니다.

**설계 원칙**:
- ✓ 골퍼를 위한 무마찰 경험 (변경되지 않은 원클릭 LINE 등록)
- ✓ 대부분의 직원을 위한 셀프 서비스 (검증 후 즉시 액세스)
- ✓ 민감한 역할에 대해서만 관리자 승인
- ✓ 코스별 격리 (각 골프장 독립적)
- ✓ LINE 전화번호 잠금 (1계정 = 1전화번호)
- ✓ 여러 골프장에 걸쳐 확장 가능

---

## 🛡️ 보안 계층

### 계층 1: LINE 이전 역할 선택

**목적**: 골퍼와 직원 등록 흐름 분리

**구현**:
- 랜딩 페이지에서 두 가지 경로 제공:
  - **"골퍼입니다"** → 직접 LINE 로그인 → 원클릭 프로필 생성
  - **"직원/캐디입니다"** → 먼저 직원 검증 화면

**보안 이점**: 일반 사용자가 실수로 또는 의도적으로 직원 등록에 액세스하는 것을 방지

**파일**: `index.html` (랜딩 페이지 라우팅)

---

### 계층 2: 골프장 코드 검증

**목적**: 코스별 코드를 가진 검증된 직원만 등록할 수 있도록 보장

**작동 방식**:
1. 각 골프장은 고유한 4자리 코드 보유
2. 코드는 `localStorage`에 저장: `golf_course_settings.staffRegistrationCode`
3. 코드는 GM의 직원 관리 대시보드에 표시
4. GM은 언제든지 코드 변경 가능 (권장: 월별)
5. 직원은 검증을 통과하기 위해 올바른 코드를 입력해야 함

**코드 관리**:
```javascript
// 위치: staff-security.js
getCourseSettings() {
    return JSON.parse(localStorage.getItem('golf_course_settings') ||
        '{"staffRegistrationCode": "0000"}');
}

saveCourseSettings(settings) {
    localStorage.setItem('golf_course_settings', JSON.stringify(settings));
}
```

**GM 인터페이스**:
- **위치**: 직원 관리 탭 → 상단 섹션
- **동작**:
  - 현재 코드 보기
  - "코드 변경" 버튼 클릭
  - 새로운 4자리 코드 입력
  - 저장 후 직원들에게 배포

**보안 이점**:
- ✓ 코스별 격리
- ✓ 타 코스 무단 액세스 방지
- ✓ 쉽게 철회 가능 (월별 코드 변경)
- ✓ 추적 가능 (코드 변경 이력 기록)
- ✓ 직원이 기억하기 쉬움

**모범 사례**:
- 매월 코드 변경 (매월 1일)
- 직원 퇴사 직후 즉시 변경 (민감한 역할)
- 코드가 유출된 경우 변경
- 공개적으로 공유 금지 (내부 배포만)
- 명백하지 않은 조합 사용 (1234, 0000, 1111 피하기)

---

### 계층 3: 직원 ID 검증

**목적**: 직원이 적절한 식별 형식을 사용하고 중복을 방지하도록 보장

**직원 ID 형식**:
```
부서                | 형식        | 예시
─────────────────┼─────────────┼──────────
캐디                | PAT-###     | PAT-001 ~ PAT-999
프로샵              | PS-###      | PS-001, PS-012
레스토랑/식음료      | FB-###      | FB-007, FB-023
시설관리            | MAINT-###   | MAINT-005
경영진              | MGR-###     | MGR-001
회계                | ACCT-###    | ACCT-001
접수처              | RCP-###     | RCP-003
보안                | SEC-###     | SEC-002
```

**검증 로직**:
```javascript
// 위치: staff-security.js:112-120
validateEmployeeId(employeeId, department) {
    const formats = this.getEmployeeIdFormat();
    const format = formats[department];
    if (!format) return false;

    const regex = new RegExp(`^${format.prefix}-\\d{${format.length}}$`);
    return regex.test(employeeId);
}
```

**중복 방지**:
```javascript
// 위치: staff-security.js:284-289
const staff = JSON.parse(localStorage.getItem('staff_members') || '[]');
const exists = staff.find(s => s.employeeId === employeeId);

if (exists) {
    return { success: false, error: 'This Employee ID is already registered' };
}
```

**보안 이점**:
- ✓ 무작위 ID 입력 방지
- ✓ 부서별 형식이 조직 구성 강제
- ✓ 중복 감지로 직원당 여러 계정 방지
- ✓ 감사하기 쉬움 (형식이 즉시 부서 표시)
- ✓ 확장 가능 (신규 부서를 위한 새 형식 추가)

---

### 계층 4: 관리자 승인 대기열

**목적**: 액세스 권한 부여 전 민감한 역할에 대한 추가 검증

**승인이 필요한 역할**:
- **경영진** (MGR-###): 전체 시스템 액세스
- **프로샵** (PS-###): 재무 거래, 재고
- **회계** (ACCT-###): 재무 데이터 액세스

**즉시 액세스 가능한 역할** (승인 불필요):
- 캐디 (PAT-###)
- 레스토랑/식음료 (FB-###)
- 시설관리 (MAINT-###)
- 접수처 (RCP-###)
- 보안 (SEC-###)

**승인 로직**:
```javascript
// 위치: staff-security.js:155-161
requiresApproval(department, position) {
    const sensitiveRoles = ['management', 'proshop'];
    const sensitivePositions = ['manager', 'accounting', 'acct', 'pro shop'];

    return sensitiveRoles.includes(department) ||
           sensitivePositions.some(role => position.toLowerCase().includes(role));
}
```

**승인 워크플로우**:

1. **직원 등록**:
   - 검증 완료 (계층 2 & 3)
   - LINE을 통한 인증
   - 프로필 생성
   - 상태를 `pending_approval`로 설정
   - 대시보드에 "승인 대기 중" 메시지 표시

2. **관리자 알림**:
   - 승인 대기 중인 직원이 직원 관리에 표시됨
   - 노란색 알림 배너
   - 카운트 표시: "승인 대기 중 (3)"

3. **관리자 검토**:
   - 직원 세부정보 확인:
     - 이름
     - 직원 ID
     - 부서
     - 전화번호
     - 이메일
     - LINE 검증 상태 ✓
   - 결정: 승인 또는 거부

4. **승인**:
   - "승인" 버튼 클릭
   - 상태가 `active`로 변경
   - 직원이 즉시 액세스 권한 획득
   - 승인 타임스탬프와 승인자 기록

5. **거부**:
   - "거부" 버튼 클릭
   - 프로필이 완전히 제거됨
   - 직원이 로그인할 수 없음
   - 올바른 정보로 재등록해야 함

**관리자 대시보드 인터페이스**:
```javascript
// 위치: staff-security.js:196-263
renderPendingApprovalsUI() {
    const pending = this.getPendingApprovals();
    // 다음과 함께 노란색 알림 상자 렌더링:
    // - 직원 이름 및 직위
    // - 직원 ID
    // - 연락처 정보
    // - LINE 검증 상태
    // - 승인/거부 버튼
}
```

**보안 이점**:
- ✓ 높은 권한 역할에 대한 사람의 검증
- ✓ 자동화된 대량 등록 방지
- ✓ 관리자가 합법적인 직원 인식
- ✓ 빠른 승인 (평균 24시간)
- ✓ 감사 추적 (누가, 언제 승인했는지)
- ✓ 의심스러운 요청 거부 가능

---

### 계층 5: LINE 전화번호 잠금 (기존)

**목적**: LINE의 내장 보안을 사용하여 1인 = 1계정 보장

**LINE 작동 방식**:
- 1 LINE 계정 = 1 전화번호 (LINE에서 검증)
- 전화번호는 LINE에서 SMS로 검증
- 동일한 전화번호로 여러 LINE 계정 생성 불가
- MciPro에서 동일한 LINE 계정을 두 번 등록할 수 없음

**MciPro 통합**:
```javascript
// 각 프로필은 lineUserId에 연결됨 (고유 식별자)
const profile = {
    lineUserId: 'U1234567890abcdef...',  // 고유 LINE ID
    // ... 기타 프로필 데이터
};
```

**중복 방지**:
- 시스템이 `lineUserId`가 이미 존재하는지 확인
- 존재하면 기존 프로필 로드 (재방문 사용자)
- 신규면 새 프로필 생성
- 1 LINE ID = 1 MciPro 프로필

**보안 이점**:
- ✓ LINE에서 신원 검증 (신뢰할 수 있는 제3자)
- ✓ SMS로 전화번호 검증
- ✓ 동일한 전화번호로 여러 계정 생성 불가
- ✓ 스마트폰 없이 등록 불가
- ✓ 봇/자동화된 등록 방지
- ✓ 전화기 분실 = LINE 복구 = MciPro 액세스 복구

---

## 📊 데이터 흐름 다이어그램

### 골퍼 등록 흐름

```
골퍼가 "LINE으로 로그인" 클릭
          ↓
    LINE 인증
          ↓
  LINE 프로필과 함께 반환
          ↓
    lineUserId 존재 여부 확인
          ↓
    ┌─────┴─────┐
    ↓           ↓
 존재함      신규 사용자
    ↓           ↓
프로필 로드   프로필 생성
    ↓           ↓
 대시보드     대시보드
```

**시간**: 약 30초
**사용자 동작**: 클릭 2회
**보안 확인**: 1회 (LINE 전화번호 검증)

---

### 직원 등록 흐름 (비민감 역할)

```
직원이 "직원/캐디입니다" 클릭
          ↓
  직원 검증 페이지
          ↓
  입력: 코스 코드 + 부서 + 직원 ID
          ↓
  검증:
  1. ✓ 코스 코드 일치
  2. ✓ 직원 ID 형식 정확
  3. ✓ 중복 직원 ID 없음
          ↓
  sessionStorage에 저장
          ↓
  LINE 인증으로 리디렉션
          ↓
  LINE 프로필과 함께 반환
          ↓
  직원 프로필 생성
  • 역할 → 부서 매핑
  • 상태 = 'active' (즉시 액세스)
  • staff_members에 저장
          ↓
  대시보드 (즉시 액세스)
```

**시간**: 약 2-3분
**사용자 동작**: 입력 7회, 클릭 3회
**보안 확인**: 4회 (코드, 형식, 중복, LINE)

---

### 직원 등록 흐름 (민감한 역할)

```
직원이 "직원/캐디입니다" 클릭
          ↓
  직원 검증 페이지
          ↓
  입력: 코스 코드 + 부서 + 직원 ID
          ↓
  검증 (위와 동일)
          ↓
  LINE 인증
          ↓
  직원 프로필 생성
  • 상태 = 'pending_approval'
  • staff_members에 저장
          ↓
  "승인 대기 중" 화면
          ↓
  ┌─────────────────────────┐
  │   관리자 대시보드         │
  │   승인 대기 중           │
  │   [직원 세부정보]        │
  │   [승인] [거부]          │
  └─────────────────────────┘
          ↓
  관리자가 "승인" 클릭
          ↓
  상태 → 'active'
          ↓
  직원에게 LINE 알림
          ↓
  직원 로그인
          ↓
  대시보드 (이제 액세스 가능)
```

**시간**: 2-3분 (등록) + 승인 대기
**대기 시간**: 평균 1-24시간
**보안 확인**: 5회 (코드, 형식, 중복, LINE, 사람 검증)

---

## 🗄️ 데이터 저장소

### localStorage 키

**1. golf_course_settings**
```json
{
  "staffRegistrationCode": "1234",
  "courseName": "Greenview Golf Club",
  "lastCodeUpdate": "2025-10-07T10:30:00.000Z",
  "courseId": "GVC-001",
  "managerName": "John Manager"
}
```

**목적**: 코스별 구성 저장
**보안**: 클라이언트 측에 저장, 코스별
**액세스**: GM이 직원 관리 대시보드를 통해 수정 가능

---

**2. staff_members**
```json
[
  {
    "id": "STAFF-1728284930123",
    "firstName": "John",
    "lastName": "Smith",
    "employeeId": "PAT-023",
    "department": "caddy",
    "position": "Caddie",
    "phone": "+66 12 345 6789",
    "email": "john.smith@email.com",
    "status": "active",
    "hireDate": "2025-10-01",
    "lineUserId": "U1234567890abcdef",
    "caddyLicense": "PAT-023",
    "experienceLevel": "Expert",
    "gpsTrackerId": "GPS-PAT-023",
    "languages": "English, Thai",
    "workingStatus": "off-duty",
    "currentLocation": null,
    "rating": 4.8,
    "totalAssignments": 247,
    "totalTips": 125400,
    "approvedAt": "2025-10-01T09:15:00.000Z",
    "approvedBy": "Jane Manager"
  },
  {
    "id": "STAFF-1728285930456",
    "firstName": "Sarah",
    "lastName": "Johnson",
    "employeeId": "PS-001",
    "department": "proshop",
    "position": "Pro Shop Manager",
    "phone": "+66 87 654 3210",
    "email": "sarah.johnson@email.com",
    "status": "pending_approval",
    "hireDate": "2025-10-07",
    "lineUserId": "U0987654321fedcba",
    "approvedAt": null,
    "approvedBy": null
  }
]
```

**목적**: 모든 직원 프로필 저장
**보안**: 상태 필드가 액세스 제어
**액세스**: GM은 보기/편집 가능, 직원은 본인 프로필만 볼 수 있음

---

**3. mcipro_user_profiles** (통합 프로필)
```json
[
  {
    "id": "USER-1728284930123",
    "lineUserId": "U1234567890abcdef",
    "firstName": "John",
    "lastName": "Smith",
    "phone": "+66 12 345 6789",
    "email": "john.smith@email.com",
    "role": "caddie",
    "roleSpecific": {
      "caddyNumber": "PAT-023",
      "experience": "Expert",
      "languages": ["English", "Thai"]
    }
  }
]
```

**목적**: 통합 프로필 저장 (골퍼 + 직원)
**보안**: 역할 필드가 대시보드 액세스 결정
**액세스**: 인증 및 프로필 로딩에 사용

---

### sessionStorage 키

**staff_verification** (임시)
```json
{
  "verified": true,
  "courseCode": "1234",
  "department": "caddy",
  "employeeId": "PAT-023",
  "timestamp": 1728284930123
}
```

**목적**: 등록 중 임시 저장
**보안**: 등록 완료 후 삭제됨
**수명**: 세션만 (브라우저 탭 닫으면 종료)

---

## 🔐 보안 모범 사례

### 골프장 관리를 위해

**1. 등록 코드 관리**:
- ✓ 매월 1일에 코드 변경
- ✓ 비순차적 숫자 사용 (1234, 0000 피하기)
- ✓ 안전하게 코드 배포 (대면, 개인 메시지)
- ✓ 날짜와 함께 코드 변경 기록
- ✓ 유출 시 즉시 변경
- ✓ 다중 코스 운영 시 다른 코드 사용

**2. 승인 대기열 모니터링**:
- ✓ 매일 승인 대기 확인
- ✓ 승인 전 직원 적법성 검증
- ✓ 의심스러운 등록 조사
- ✓ 알 수 없는/무단 시도 거부
- ✓ 모든 승인/거부 문서화
- ✓ 응답 시간: 24시간 이내

**3. 직원 명부 감사**:
- ✓ 주간: 활성 직원 목록 검토
- ✓ 월간: 전체 명부 감사
- ✓ 분기: 모든 직원 ID 검증
- ✓ 퇴사 직원 즉시 비활성화
- ✓ 중복 계정 확인
- ✓ 부서 할당 검증

**4. 액세스 제어**:
- ✓ 해고 시 직원 비활성화 (당일)
- ✓ 정기적으로 직원 액세스 로그 검토
- ✓ 비정상적인 활동 패턴 모니터링
- ✓ 로그인 실패 시도 조사
- ✓ 보안 사고 즉시 보고

---

### 직원을 위해

**1. 등록 보안**:
- ✓ 코스 코드 비밀 유지
- ✓ 직원 ID 공유 금지
- ✓ 잠금 화면이 있는 안전한 전화기 사용
- ✓ LINE 앱을 최신 상태로 유지
- ✓ 전화기 분실 시 즉시 보고

**2. 계정 보안**:
- ✓ 안전한 LINE 비밀번호
- ✓ LINE 2단계 인증 활성화
- ✓ 공유 기기에서 로그아웃
- ✓ 로그인 자격 증명 공유 금지
- ✓ 의심스러운 활동 보고

**3. 데이터 보호**:
- ✓ 고객 데이터 공유 금지
- ✓ 민감한 정보 스크린샷 금지
- ✓ 데이터 개인정보 보호 정책 준수
- ✓ 데이터 침해 즉시 보고

---

## 🚨 보안 사고 대응

### 무단 액세스 시도

**지표**:
- 여러 번의 코드 입력 실패
- 의심스러운 직원 ID
- 반복적인 등록 시도
- 승인 대기 중 알 수 없는 이름

**대응 프로토콜**:
1. **즉시**: 승인 대기 거부
2. **즉시**: 직원 등록 코드 변경
3. **1시간 이내**: 모든 부서장에게 알림
4. **4시간 이내**: 새 코드 안전하게 배포
5. **24시간 이내**: 전체 직원 명부 감사
6. **48시간 이내**: 보안 로그 검토
7. **문서화**: 완전한 사고 보고서

---

### 코드 유출

**지표**:
- 공개적으로 공유된 코드 (소셜 미디어 등)
- 알 수 없는 직원 등록
- 전 직원이 여전히 코드 보유

**대응 프로토콜**:
1. **즉시**: 코드 변경
2. **즉시**: 최근 등록 검토
3. **1시간 이내**: 관리자에게 알림
4. **4시간 이내**: 새 코드 배포
5. **24시간 이내**: 의심스러운 계정 비활성화
6. **48시간 이내**: 보안 검토

---

### 직원 계정 유출

**지표**:
- 직원이 무단 액세스 보고
- 계정의 비정상적인 활동
- 예상치 못한 위치에서 로그인
- LINE 계정 유출

**대응 프로토콜**:
1. **즉시**: 직원 계정 비활성화
2. **즉시**: IT/보안 팀에 알림
3. **1시간 이내**: 직원이 LINE 비밀번호 변경
4. **4시간 이내**: 계정 활동 검토
5. **24시간 이내**: 안전하면 재활성화
6. **문서화**: 사고 보고서

---

## 📈 보안 모니터링 및 감사

### 자동 알림

**시스템 모니터**:
- 코드 입력 실패 시도 (10분 내 3회 이상)
- 중복 직원 ID 시도
- 48시간 이상 된 승인 대기
- 직원 계정 로그인 실패 (5회 이상)
- 비정상적인 액세스 패턴

**알림 수신자**:
- 총괄 관리자
- IT/보안 팀
- 시스템 관리자

---

### 감사 로그

**기록 내용**:
```
이벤트 유형          | 기록된 데이터
────────────────────┼──────────────────────────────────
직원 등록            | 시간, 직원 ID, 부서, IP
코드 변경            | 시간, 이전 코드, 새 코드, 변경자
승인/거부            | 시간, 직원 ID, 결정, 관리자
로그인              | 시간, LINE 사용자 ID, 성공/실패
프로필 업데이트      | 시간, 변경된 필드, 이전/새 값
```

**로그 보존**: 최소 12개월

**액세스**: 총괄 관리자, IT/보안 팀

---

### 정기 보안 검토

**주간**:
- 승인 대기 상태
- 최근 등록 검토
- 액세스 실패 시도
- 직원 명부 변경

**월간**:
- 전체 직원 명부 감사
- 코드 변경 (권장)
- 보안 로그 검토
- 액세스 패턴 분석
- 사고 요약

**분기**:
- 포괄적 보안 감사
- 정책 검토
- 직원 보안 교육
- 시스템 취약점 평가
- 규정 준수 확인

**연간**:
- 전체 시스템 보안 검토
- 침투 테스트
- 정책 업데이트
- 직원 보안 인증
- 제3자 감사 (해당하는 경우)

---

## 📋 규정 준수 및 개인정보 보호

### 데이터 개인정보 보호 (PDPA 준수)

**수집된 개인 데이터**:
- 이름
- 전화번호
- 이메일 주소 (선택사항)
- LINE 사용자 ID
- 직원 ID
- 부서
- 고용 이력

**데이터 사용**:
- 직원 관리
- 액세스 제어
- 성과 추적
- 커뮤니케이션
- 급여 (통합된 경우)

**데이터 보호**:
- 로컬 저장 (클라이언트 측)
- 동의 없이 클라우드 저장 금지
- 암호화된 전송 (HTTPS)
- 역할별 액세스 제한
- 감사 추적 유지

**데이터 권리**:
- 직원은 본인 데이터 볼 수 있음
- 직원은 수정 요청 가능
- 직원은 삭제 요청 가능 (고용 종료 시)
- 직원은 본인 데이터 내보내기 가능

---

### 액세스 제어 정책

**역할 기반 액세스**:

**총괄 관리자**:
- ✓ 전체 시스템 액세스
- ✓ 모든 직원 보기
- ✓ 등록 승인/거부
- ✓ 등록 코드 변경
- ✓ 모든 보고서 보기
- ✓ 데이터 내보내기

**부서 관리자**:
- ✓ 부서 직원 보기
- ✓ 부서 직원 편집
- ✓ 부서 보고서 보기
- ✗ 직원 승인 불가
- ✗ 코드 변경 불가

**직원**:
- ✓ 본인 프로필 보기
- ✓ 본인 연락처 정보 편집
- ✓ 본인 스케줄 보기
- ✓ 본인 성과 보기
- ✗ 다른 직원 볼 수 없음
- ✗ 관리 기능 액세스 불가

---

## 🔗 관련 문서

- [총괄 관리자 가이드](../general-manager/README.md)
- [직원 등록 가이드](../staff-registration/HOW_TO_REGISTER.md)
- [문제 해결](../troubleshooting/COMMON_ISSUES.md)
- [기술 구현](../../STAFF_SECURITY_IMPLEMENTATION.md)

---

## 📞 보안 연락처

**보안 문제 보고**:
- 이메일: security@mcipro.com
- 전화: [긴급 보안 라인]
- 대면: 총괄 관리자 사무실

**기술 문제**:
- 이메일: support@mcipro.com
- 전화: [IT 지원 라인]

---

**최종 업데이트**: 2025년 10월 7일
**버전**: 1.0
**다음 검토**: 2025년 11월 7일
**분류**: 내부 사용 전용
