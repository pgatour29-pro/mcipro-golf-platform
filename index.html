<!DOCTYPE html>
<!-- VERSION: 2025-10-14-LOGIN-FIX - Fixed LIFF Permission Error Handling -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="2.1.0">

    <!-- Native App Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MciPro">
    <meta name="theme-color" content="#10b981">
    <meta name="format-detection" content="telephone=no">

    <!-- Preconnect to Supabase REST and Realtime for faster mobile first paint -->
    <link rel="preconnect" href="https://pyeeplwsnupmhgbguwqs.supabase.co" crossorigin>
    <link rel="preconnect" href="https://realtime-pyeeplwsnupmhgbguwqs.supabase.co" crossorigin>
    <link rel="dns-prefetch" href="//pyeeplwsnupmhgbguwqs.supabase.co">
    <link rel="dns-prefetch" href="//realtime-pyeeplwsnupmhgbguwqs.supabase.co">

    <title>MciPro - Professional Golf Course Management Platform v2.1.0</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script src="js/scorecardProfileLoader.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- OpenStreetMap with Leaflet (Free Alternative) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <link rel="stylesheet" href="professional-analytics.css">

    <!-- Native App Styles -->
    <style>
        /* Remove browser chrome and make fullscreen */
        html, body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
            /* overflow: hidden; */ /* REMOVED: Blocking dashboard scrolling */
        }

        /* Hide scrollbars but keep functionality */
        ::-webkit-scrollbar {
            display: none;
        }
        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Fullscreen app container */
        body {
            position: relative; /* FIXED: Changed from fixed to allow scrolling */
            min-height: 100vh; /* Minimum full viewport height */
            width: 100%;
            margin: 0;
            padding: 0;
            overflow-y: auto; /* Allow vertical scrolling */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* Safe area insets for notched devices */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Smooth animations */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>

    <!-- Firebase SDK for Production Cloud Sync -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <!-- Supabase for Real-time Database and Chat (Replaces Pusher + Netlify Blobs) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>

    <!-- Tesseract.js for OCR Scorecard Scanning -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <!-- js-yaml for YAML Profile Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4/dist/js-yaml.min.js"></script>

    <!-- Capacitor Core (Native App Support) -->
    <script type="module">
        // Capacitor auto-injects itself when running in native app
        // This script only runs when in web mode to prevent errors
        if (!window.Capacitor) {
            window.Capacitor = {
                isNativePlatform: () => false,
                getPlatform: () => 'web'
            };
        }
    </script>
    <script type="module" src="native-push.js"></script>

    <style>
        /* CSS Variables for Premium Theme */
        :root {
            --primary-50: #ecfdf5;
            --primary-100: #d1fae5;
            --primary-200: #a7f3d0;
            --primary-300: #6ee7b7;
            --primary-400: #34d399;
            --primary-500: #10b981;
            --primary-600: #059669;
            --primary-700: #047857;
            --primary-800: #065f46;
            --primary-900: #064e3b;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --orange-500: #f97316;
            --orange-600: #ea580c;
            --purple-500: #8b5cf6;
            --purple-600: #7c3aed;
            --red-500: #ef4444;
            --red-600: #dc2626;
            --yellow-500: #eab308;
            --green-500: #22c55e;
            --emerald-500: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Filled star icon for favorites */
        .fill-icon {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            max-width: 100vw;
        }

        /* Global mobile container constraints */
        @media (max-width: 768px) {
            body, html {
                overflow-x: hidden;
                max-width: 100vw;
                position: relative;
            }

            /* Prevent content overflow - target specific elements instead of wildcard */
            img, video, iframe, svg {
                max-width: 100%;
            }

            .max-w-7xl, .max-w-6xl, .max-w-5xl, .max-w-4xl, .max-w-3xl, .max-w-2xl, .max-w-xl {
                max-width: 100vw !important;
            }
        }

        /* Screen Management */
        .screen {
            display: none;
            width: 100%;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Tab Management */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: slideUp 0.2s ease-out;
        }

        /* Premium UI Components */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-radius: 20px;
        }

        .premium-gradient {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
        }

        .hero-gradient {
            background: var(--primary-900);
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .card-hover:hover {
            transform: translateY(-6px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: var(--primary-600);
            color: white;
            padding: 14px 28px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .btn-primary:hover {
            background: var(--primary-700);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(5, 150, 105, 0.4);
        }

        .btn-secondary {
            background: var(--gray-600);
            color: white;
            padding: 14px 28px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-secondary:hover {
            background: var(--gray-700);
            transform: translateY(-2px);
        }

        .btn-logout {
            background: var(--red-600);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-logout:hover {
            background: var(--red-700);
            transform: translateY(-1px);
        }

        .tab-button {
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: var(--gray-700);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .tab-button:hover {
            color: var(--gray-900);
            background: var(--gray-100);
            border-bottom-color: var(--gray-300);
        }

        .tab-button.active {
            color: var(--green-700);
            background: var(--green-50);
            border-bottom-color: var(--green-600);
            font-weight: 600;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 16px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .status-confirmed {
            background: var(--primary-100);
            color: var(--primary-800);
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        .metric-card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--gray-200);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .metric-card:hover {
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .metric-value {
            font-size: 36px;
            font-weight: 900;
            color: var(--primary-600);
            line-height: 1;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .line-login-btn {
            background: #00c300;
            color: white;
            padding: 18px 32px;
            border-radius: 14px;
            border: none;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .line-login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .line-login-btn:hover::before {
            left: 100%;
        }

        .line-login-btn:hover {
            background: #00b300;
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 195, 0, 0.4);
        }

        .otp-input {
            width: 56px;
            height: 56px;
            border: 3px solid var(--gray-300);
            border-radius: 12px;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
        }

        .otp-input:focus {
            outline: none;
            border-color: var(--primary-600);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
            transform: scale(1.05);
        }


        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid var(--gray-300);
            border-top: 5px solid var(--primary-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Form Styles */
        .form-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--gray-300);
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-600);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }

        .form-label {
            display: block;
            font-weight: 700;
            color: var(--gray-700);
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .metric-card {
                padding: 20px;
            }

            .metric-value {
                font-size: 28px;
            }

            .tab-button {
                padding: 10px 12px;
                font-size: 11px;
                min-width: 44px;
                min-height: 44px;
                white-space: nowrap;
                gap: 3px;
                border-radius: 6px 6px 0 0;
            }

            .tab-button .material-symbols-outlined {
                font-size: 18px;
            }

            .tab-button.active {
                /* Active styling inherited from main CSS */
            }

            .btn-primary, .btn-secondary {
                padding: 12px 24px;
                font-size: 14px;
            }

            /* Mobile Header Fixes */
            .nav-header {
                padding: 0;
            }

            .nav-header .max-w-7xl {
                max-width: 100%;
                padding: 0 16px;
            }

            .nav-header h1 {
                font-size: 22.5px; /* 18px * 1.25 = 22.5px */
            }

            .nav-header p {
                font-size: 15px; /* 12px * 1.25 = 15px */
            }

            /* Mobile Navigation Tabs */
            .tab-navigation .flex {
                justify-content: flex-start;
                overflow-x: auto;
                scrollbar-width: none;
                -ms-overflow-style: none;
                padding-bottom: 8px;
            }

            .tab-navigation .flex::-webkit-scrollbar {
                display: none;
            }

            /* Horizontal Scrolling for Mobile Caddys */
            .scrollbar-hide {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }

            /* Mobile Caddy Cards */
            @media (max-width: 768px) {
                .mobile-caddie-card {
                    min-width: 280px;
                    max-width: 280px;
                    flex-shrink: 0;
                    scroll-snap-align: start;
                }

                /* Smooth scrolling for mobile caddies */
                #promotionalCaddysContainer {
                    scroll-behavior: smooth;
                    scroll-snap-type: x mandatory;
                    overscroll-behavior-x: contain;
                    -webkit-overflow-scrolling: touch;
                }

                /* Add scroll indicators */
                .mobile-scroll-container {
                    position: relative;
                }

                .mobile-scroll-container::after {
                    content: '';
                    position: absolute;
                    top: 50%;
                    right: 8px;
                    transform: translateY(-50%);
                    width: 20px;
                    height: 20px;
                    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8));
                    pointer-events: none;
                    border-radius: 50%;
                }
            }

            .tab-navigation {
                border-bottom: 1px solid #e5e7eb;
                background: white;
            }

            /* Schedule Filter Buttons */
            .schedule-filter-btn {
                padding: 8px 16px;
                border-radius: 8px;
                border: 2px solid #e5e7eb;
                background: white;
                color: #6b7280;
                font-weight: 500;
                font-size: 14px;
                transition: all 0.2s;
                cursor: pointer;
            }

            .schedule-filter-btn:hover {
                border-color: #059669;
                color: #059669;
            }

            .schedule-filter-btn.active {
                border-color: #059669;
                background: #059669;
                color: white;
            }

            /* Schedule Item Cards */
            .schedule-item {
                border: 1px solid #e5e7eb;
                border-radius: 12px;
                padding: 20px;
                background: white;
                transition: all 0.2s;
                overflow: hidden;
                max-width: 100%;
            }

            /* Mobile overflow fixes */
            @media (max-width: 768px) {
                .schedule-item {
                    padding: 12px;
                }

                .schedule-item * {
                    overflow-wrap: break-word;
                    word-wrap: break-word;
                    word-break: break-word;
                }

                .schedule-item .flex {
                    flex-wrap: wrap;
                }

                .schedule-item .space-x-3 {
                    gap: 0.5rem;
                }

                /* Emergency alerts mobile */
                .persistent-emergency-alerts {
                    max-width: 100%;
                    overflow: hidden;
                }

                .persistent-emergency-alerts * {
                    overflow-wrap: break-word;
                    word-wrap: break-word;
                    max-width: 100%;
                }

                /* All card components */
                .metric-card, .glass-card, .booking-card {
                    max-width: 100%;
                    overflow: hidden;
                }

                /* Text elements */
                h1, h2, h3, h4, h5, h6, p, span, div {
                    overflow-wrap: break-word;
                    word-wrap: break-word;
                }

                /* Flex containers on mobile */
                .flex:not(.overflow-x-auto):not([style*="nowrap"]) {
                    flex-wrap: wrap;
                }

                /* Space utilities */
                .space-x-1, .space-x-2, .space-x-3, .space-x-4 {
                    gap: 0.25rem;
                }
            }

            .schedule-item:hover {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            .schedule-item.editing {
                border-color: #059669;
                background: #f0fdf4;
            }

            /* Mobile Button Groups */
            .nav-header .space-x-2,
            .nav-header .space-x-4 {
                display: flex;
                flex-direction: row;
            }

            .nav-header .space-x-4 > * {
                margin-left: 0;
            }

            /* Hide scrollbar on header buttons container */
            .nav-header .overflow-x-auto::-webkit-scrollbar {
                display: none;
            }

            /* Emergency and Chat buttons on mobile */
            .emergency-btn {
                padding: 10px; /* 8px * 1.25 = 10px */
                min-width: 55px; /* 44px * 1.25 = 55px */
                height: 55px; /* 44px * 1.25 = 55px */
            }

            .btn-logout {
                padding: 10px 15px; /* 8px * 1.25 = 10px, 12px * 1.25 = 15px */
                font-size: 15px; /* 12px * 1.25 = 15px */
            }

            /* Chat button mobile optimization */
            .nav-header .btn-primary {
                padding: 10px 15px; /* 8px * 1.25 = 10px, 12px * 1.25 = 15px */
                font-size: 15px; /* 12px * 1.25 = 15px */
            }

            /* Grid layout adjustments for mobile */
            .grid {
                gap: 12px;
            }

            /* Hero sections mobile */
            .hero-section {
                padding: 16px;
                text-align: center;
            }

            .hero-section h2 {
                font-size: 24px;
            }

            /* Mobile stats cards */
            .stats-card {
                padding: 16px;
            }

            /* Mobile Chat Interface Styles */
            #chatModal {
                align-items: flex-start;
                justify-content: flex-start;
            }

            .chat-modal-container {
                border-radius: 0 !important;
                max-height: 100vh !important;
                height: 100vh !important;
                height: calc(var(--vh, 1vh) * 100) !important;
            }

            /* Mobile chat room view with proper viewport handling */
            #chatRoomView {
                height: 100vh;
                height: calc(var(--vh, 1vh) * 100);
                max-height: 100vh;
                max-height: calc(var(--vh, 1vh) * 100);
            }

            /* Mobile chat list view with proper viewport handling */
            #chatListView {
                height: 100vh;
                height: calc(var(--vh, 1vh) * 100);
                max-height: 100vh;
                max-height: calc(var(--vh, 1vh) * 100);
            }

            #chatListView {
                width: 100% !important;
            }

            #chatRoomView {
                width: 100% !important;
            }

            /* Mobile chat list items */
            #chatListView .hover\\:bg-gray-50:hover {
                background-color: #f9fafb;
            }

            #chatListView .active\\:bg-gray-100:active {
                background-color: #f3f4f6;
            }

            /* Mobile message bubbles */
            #mobileChatMessages .max-w-xs {
                max-width: 280px;
            }

            /* Mobile textarea */
            #mobileMessageInput {
                font-size: 16px !important; /* Prevent zoom on iOS */
                line-height: 1.4;
            }

            /* Mobile send button */
            #mobileSendButton {
                min-width: 44px;
                min-height: 44px;
            }

            /* Touch-friendly mobile header buttons */
            #mobileChatHeader button {
                min-width: 44px;
                min-height: 44px;
            }

            /* Mobile chat search */
            #chatListView input {
                font-size: 16px !important; /* Prevent zoom on iOS */
            }

            /* Mobile input area safe positioning */
            #chatRoomView > div:last-child {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 1000 !important;
                background: white !important;
                border-top: 1px solid #e5e7eb !important;
                padding-bottom: env(safe-area-inset-bottom, 0px) !important;
                min-height: calc(60px + env(safe-area-inset-bottom, 0px)) !important;
            }

            /* Adjust chat messages area to account for fixed input */
            #mobileChatMessages {
                padding-bottom: calc(80px + env(safe-area-inset-bottom, 20px)) !important;
                height: calc(100vh - 60px - 80px - env(safe-area-inset-bottom, 20px)) !important;
                height: calc(calc(var(--vh, 1vh) * 100) - 60px - 80px - env(safe-area-inset-bottom, 20px)) !important;
            }

            /* Mobile chat header adjustments */
            #mobileChatHeader {
                position: sticky !important;
                top: 0 !important;
                z-index: 999 !important;
                background: white !important;
                border-bottom: 1px solid #e5e7eb !important;
            }

            /* Keyboard handling - prevent scrolling issues */
            #chatRoomView.keyboard-open #mobileChatMessages {
                height: calc(50vh - 80px) !important;
            }
        }

        /* Navigation Enhancement */
        .nav-header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 40;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 3px solid var(--primary-200);
            object-fit: cover;
        }

        /* Emergency Button */
        .emergency-btn {
            background: var(--red-600);
            color: white;
            padding: 15px; /* 12px * 1.25 = 15px */
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .emergency-btn:hover {
            background: var(--red-700);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        /* Advanced Status Indicators */
        .status-online {
            width: 12px;
            height: 12px;
            background: var(--green-500);
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
            }
        }

        @keyframes emergency-flash {
            0% { background: rgba(220, 38, 38, 0.95); }
            25% { background: rgba(245, 158, 11, 0.95); }
            50% { background: rgba(220, 38, 38, 0.95); }
            75% { background: rgba(245, 158, 11, 0.95); }
            100% { background: rgba(220, 38, 38, 0.95); }
        }

        /* Pro Shop POS System Styles */
        .category-tab {
            padding: 8px 16px;
            border: 1px solid var(--gray-300);
            border-radius: 20px;
            background: white;
            color: var(--gray-600);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .category-tab:hover {
            background: var(--gray-50);
            border-color: var(--purple-300);
        }

        .category-tab.active {
            background: var(--purple-600);
            border-color: var(--purple-600);
            color: white;
        }

        .product-card {
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .product-card:hover {
            border-color: var(--purple-300);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .product-image {
            margin-bottom: 8px;
        }

        .table-header {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            color: var(--gray-900);
            border-bottom: 1px solid var(--gray-200);
        }

        .table-cell {
            padding: 12px 16px;
            font-size: 14px;
            color: var(--gray-900);
            border-bottom: 1px solid var(--gray-100);
        }

        /* Modal improvements */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Form improvements */
        .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
            resize: vertical;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--purple-500);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        /* Enhanced button styles */
        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            text-decoration: none;
        }

        .btn-sm:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-sm.btn-outline {
            background: white;
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
        }

        .btn-sm.btn-outline:hover:not(:disabled) {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .btn-sm.btn-primary {
            background: var(--purple-600);
            color: white;
        }

        .btn-sm.btn-primary:hover:not(:disabled) {
            background: var(--purple-700);
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .product-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .category-tab {
                font-size: 13px;
                padding: 6px 12px;
            }

            .table-header,
            .table-cell {
                padding: 8px 12px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                margin: 10px;
                padding: 16px;
            }
        }

        /* Profile Creation Styles */
        .role-selection-card {
            cursor: pointer;
        }

        .role-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            transition: all 0.2s ease;
            min-height: 80px;
        }

        .role-card:hover {
            border-color: var(--primary-500);
            background: var(--primary-50);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }

        .role-selection-card input:checked + .role-card {
            border-color: var(--primary-500);
            background: var(--primary-100);
            color: var(--primary-700);
        }

        .role-card .material-symbols-outlined {
            margin-bottom: 8px;
            color: var(--primary-600);
        }

        .role-selection-card input:checked + .role-card .material-symbols-outlined {
            color: var(--primary-700);
        }

        /* Language Selector Styles */
        .language-btn {
            width: 40px;
            height: 30px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.8);
            color: var(--gray-600);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .language-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .language-btn.active {
            background: var(--blue-600);
            border-color: var(--blue-600);
            color: white;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
            transform: translateY(-1px);
        }

        /* ============================================ */
        /* SOCIETY GOLF STYLES */
        /* ============================================ */

        .organizer-tab-button {
            transition: all 0.2s;
        }

        .organizer-tab-button:hover {
            background-color: #f9fafb;
        }

        .roster-tab-button {
            cursor: pointer;
            padding: 0.5rem 0;
            transition: all 0.2s;
        }

        .roster-tab-button.active {
            font-weight: 600;
            border-bottom: 2px solid currentColor;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(6px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-container {
            background: white;
            border-radius: 1rem;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 1.25rem;
            display: flex;
            justify-between:items-center;
        }

        .modal-body {
            padding: 1.25rem;
            overflow-y: auto;
        }

        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background: white;
            }
        }

        /* Live Scorecard Keypad Styles */
        .keypad-btn {
            @apply px-6 py-4 bg-white border-2 border-gray-300 text-2xl font-bold text-gray-900 hover:bg-gray-50 hover:border-gray-400 active:bg-gray-100 transition-all shadow-md;
            min-height: 70px;
            min-width: 70px;
            border-radius: 50%; /* Circular like phone keypad */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .keypad-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Mobile optimization for scorecard */
        @media (max-width: 640px) {
            .keypad-btn {
                min-height: 60px;
                min-width: 60px;
                font-size: 1.5rem;
            }

            #groupScorecardGrid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)) !important;
            }
        }

    </style>

    <script>
        // ===== GLOBAL STATE MANAGEMENT =====

        // ===== GLOBAL DATA CLEANUP SYSTEM =====
        function clearAllDemoData() {
            console.log('🧹 Clearing all demo data from application...');

            // List of data keys to preserve (only courses, caddies, societies)
            const preservedKeys = [
                'mcipro_user_profiles',
                'mci-pro-language',
                'caddie_system_data',
                'golf_courses_data',
                'societies_data',
                'mcipro_sync_users_',
                'last_local_sync',
                'last_local_update',
                'played_audio_alerts'
            ];

            // Keys to force remove (all demo/activity data)
            const demoDataKeys = [
                'mcipro_bookings',
                'mcipro_schedule',
                'schedule_items',
                'food_orders',
                'chat_messages',
                'maintenance_reports',
                'waitlist_data',
                'cart_data',
                'order_history',
                'rounds_history',
                'earnings_history',
                'payment_history',
                'notification_history',
                'search_history',
                'recent_activities',
                'performance_stats',
                'user_preferences',
                'activity_log'
            ];

            // Remove all demo data keys
            demoDataKeys.forEach(key => {
                localStorage.removeItem(key);
                console.log(`Removed: ${key}`);
            });

            // Also clear any profile-specific data except the profile definitions
            const allKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                allKeys.push(localStorage.key(i));
            }

            allKeys.forEach(key => {
                // Remove all data except the preserved keys
                if (!preservedKeys.some(preserved => key.includes(preserved)) &&
                    !key.startsWith('profile_') &&
                    !key.includes('language')) {
                    localStorage.removeItem(key);
                    console.log(`Cleaned: ${key}`);
                }
            });

            // Force empty data for all major systems
            localStorage.setItem('mcipro_bookings', JSON.stringify([]));
            localStorage.setItem('mcipro_schedule', JSON.stringify({ events: [] }));
            localStorage.setItem('schedule_items', JSON.stringify([]));
            localStorage.setItem('food_orders', JSON.stringify([]));
            localStorage.setItem('chat_messages', JSON.stringify([]));

            console.log('✅ All demo data cleared - only courses, caddies, and societies preserved');
        }

        // ===== INTERNATIONALIZATION SYSTEM =====
        let currentLanguage = 'en';

        const translations = {
            en: {
                // Login Screen
                'app.title': 'MciPro',
                'app.subtitle': 'Professional Golf Course Management',
                'login.golfer': 'Login as Golfer',
                'login.caddie': 'Login as Caddy',
                'login.manager': 'Login as Manager',
                'login.proshop': 'Login as Pro Shop',

                // Navigation & Common
                'nav.logout': 'Logout',
                'nav.emergency': 'Emergency Alert',
                'common.back': 'Back',
                'common.next': 'Next',
                'common.save': 'Save',
                'common.cancel': 'Cancel',
                'common.close': 'Close',
                'common.loading': 'Loading...',
                'common.settings': 'Settings',
                'common.chat': 'Chat',
                'common.logout': 'Logout',
                'common.edit': 'Edit',
                'common.delete': 'Delete',
                'common.view': 'View',
                'common.add': 'Add',
                'common.remove': 'Remove',
                'common.update': 'Update',
                'common.submit': 'Submit',
                'common.confirm': 'Confirm',
                'common.active': 'Active',
                'common.inactive': 'Inactive',
                'common.pending': 'Pending',
                'common.completed': 'Completed',
                'common.error': 'Error',
                'common.success': 'Success',
                'common.date': 'Date',
                'common.time': 'Time',
                'common.name': 'Name',
                'common.description': 'Description',
                'common.status': 'Status',
                'common.actions': 'Actions',
                'common.refresh': 'Refresh',
                'common.select': 'Select',
                'common.all': 'All',
                'common.none': 'None',
                'common.yes': 'Yes',
                'common.no': 'No',
                'common.upload': 'Upload',
                'common.capture': 'Capture',
                'common.photo': 'Photo',
                'common.image': 'Image',

                // Scorecard Modals
                'modal.scan.title': 'Scan Scorecard',
                'modal.scan.course': 'Select Course Profile (for better accuracy)',
                'modal.scan.generic': 'Generic (Any Course)',
                'modal.scan.help': 'Select your course for optimized OCR. Choose "Generic" if your course isn\'t listed.',
                'modal.scan.capture': 'Capture Photo',
                'modal.scan.upload': 'Upload Image',
                'modal.addplayer.title': 'Add Player',
                'modal.addplayer.search': 'Search players...',
                'modal.addplayer.add': 'Add Player',
                'modal.joingames.title': 'Join Active Games',
                'modal.joingames.available': 'Available Games',
                'modal.joingames.join': 'Join Game',
                'modal.finalized.title': 'Round Complete',
                'modal.finalized.congrats': 'Congratulations!',
                'modal.finalized.score': 'Final Score',
                'modal.finalized.share': 'Share Results',
                'modal.export.title': 'Export to LINE',
                'modal.export.sharing': 'Share your scorecard',

                // Manager Dashboard
                'manager.title': 'Manager Dashboard',
                'manager.welcome': 'Welcome back, Manager!',
                'manager.overview': 'Overview',
                'manager.staff': 'Staff Management',
                'manager.analytics': 'Analytics',
                'manager.reports': 'Reports',
                'manager.traffic': 'Traffic',
                'manager.maintenance': 'Maint',
                'manager.weather': 'Weather',
                'manager.course.operations': 'Course Operations',
                'manager.managing': 'Managing Pattaya Golf Club',
                'manager.monthly.revenue': 'Monthly Revenue',
                'manager.holes.active': '18 Holes Active',
                'manager.staff.members': '47 Staff Members',
                'manager.satisfaction': '98% Satisfaction',
                'manager.todays.rounds': "Today's Rounds",
                'manager.active.caddies': 'Active Caddys',
                'manager.course.occupancy': 'Course Occupancy',
                'manager.emergency.alerts': 'Emergency Alerts',
                'manager.current.rounds': 'Current Rounds',
                'manager.staff.status': 'Staff Status',
                'manager.nodata': 'No data yet',
                'manager.noassignments': 'No assignments',
                'manager.nobookings': 'No bookings',
                'manager.allclear': 'All clear',

                // Caddy Dashboard
                'caddie.title': 'Caddy Dashboard',
                'caddie.welcome': 'Welcome back, Caddy!',
                'caddie.overview': 'Overview',
                'caddie.assignments': 'My Assignments',
                'caddie.tracking': 'Live Tracking',
                'caddie.reports': 'Reports',
                'caddie.earnings': 'Earnings',
                'caddie.monthly.earnings': 'Monthly Earnings',
                'caddie.elite.status': 'Elite Status',
                'caddie.current.round': 'Current Round',
                'caddie.performance': 'Performance',
                'caddie.currentstatus': 'Current Status',
                'caddie.available': 'Available',
                'caddie.readyforbookings': 'Ready for bookings',
                'caddie.nocurrentbookings': 'No current bookings',
                'caddie.checkschedule': 'Check schedule for upcoming assignments',
                'caddie.waitlist': 'Waitlist',
                'caddie.people': 'people',
                'caddie.nogolfers': 'No golfers on waitlist',
                'caddie.newrequests': 'New requests will appear here',
                'caddie.liveroundtracking': 'Live Round Tracking',
                'caddie.starttracking': 'Start tracking when you reach the first hole with your golfer',
                'caddie.startroundtracking': 'Start Round Tracking',
                'caddie.roundinprogress': 'Round in Progress',
                'caddie.currenthole': 'Current Hole',
                'caddie.roundtime': 'Round Time',
                'caddie.gpsstatus': 'GPS Status',
                'caddie.finishround': 'Finish Round',
                'caddie.roundcompleted': 'Round Completed!',
                'caddie.totaltime': 'Total Time',
                'caddie.holescompleted': 'Holes Completed',
                'caddie.startnewround': 'Start New Round',
                'caddie.todaysassignment': "Today's Assignment",
                'caddie.currentlocation': 'Current Location',
                'caddie.livetrackingactive': 'Live Tracking Active',
                'caddie.nextassignment': 'Next Assignment',
                'caddie.todaysearnings': "Today's Earnings",
                'caddie.roundscompleted': 'Rounds Completed',
                'caddie.currentroundstatus': 'Current Round Status',
                'caddie.noactiveround': 'No active round',
                'caddie.starttrackingbegin': 'Start tracking when you begin a round',
                'caddie.performancemetrics': 'Performance Metrics',
                'caddie.averageroundtime': 'Average Round Time',
                'caddie.clientsatisfaction': 'Client Satisfaction',
                'caddie.roundsthisweek': 'Rounds This Week',
                'caddie.weeklyearnings': 'Weekly Earnings',
                'caddie.todaysassignments': "Today's Assignments",
                'caddie.noassignmentsyet': 'No assignments yet',
                'caddie.newbookingrequests': 'New booking requests will appear here',
                'caddie.assignmentsummary': 'Assignment Summary',
                'caddie.todaytotal': 'Today Total',
                'caddie.scheduled': 'Scheduled',
                'caddie.projectedearnings': 'Projected Earnings',
                'caddie.weekahead': 'Week Ahead',
                'caddie.noupcomingassignments': 'No upcoming assignments',
                'caddie.livecoursetracking': 'Live Course Tracking',
                'caddie.interactivecourse': 'Interactive course map with real-time position',

                // Pro Shop
                'proshop.title': 'Pro Shop Dashboard',
                'proshop.welcome': 'Welcome back, Pro Shop!',
                'proshop.pos': 'Point of Sale',
                'proshop.inventory': 'Inventory',
                'proshop.sales': 'Sales Reports',
                'proshop.customers': 'Customers',
                'proshop.pos.title': 'Pro Shop POS',
                'proshop.equipment': 'Golf Equipment & Merchandise',
                'proshop.items': '450+ Items',
                'proshop.sales.today': '28 Sales Today',
                'proshop.service': '4.9★ Service',
                'proshop.todays.sales': "Today's Sales",
                'proshop.search.products': 'Search products...',
                'proshop.all.categories': 'All Categories',
                'proshop.golf.clubs': 'Golf Clubs',
                'proshop.golf.balls': 'Golf Balls',
                'proshop.apparel': 'Apparel',
                'proshop.accessories': 'Accessories',
                'proshop.beverages': 'Beverages',
                'proshop.snacks': 'Snacks',
                'proshop.shopping.cart': 'Shopping Cart',
                'proshop.cart.empty': 'Cart is empty',
                'proshop.add.products': 'Add products to start a sale',
                'proshop.subtotal': 'Subtotal:',
                'proshop.tax': 'Tax (7%):',
                'proshop.total': 'Total:',
                'proshop.cash.payment': 'Cash Payment',
                'proshop.card.payment': 'Card Payment',
                'proshop.payment.successful': 'Payment Successful!',
                'proshop.print.receipt': 'Print Receipt',
                'proshop.new.sale': 'New Sale',

                // Golfer Dashboard
                'golfer.title': 'Golfer Dashboard',
                'golfer.welcome': 'Welcome back',
                'golfer.overview': 'Overview',
                'golfer.booking': 'Booking',
                'golfer.food': 'Food & Drinks',
                'golfer.gps': 'GPS & Navigation',
                'golfer.emergency': 'Emergency',
                'golfer.profile': 'Profile',
                'golfer.chat': 'Chat',
                'golfer.schedule': 'Schedule',
                'golfer.orderstatus': 'Order Status',
                'golfer.statistics': 'Statistics',
                'golfer.roundhistory': 'Round History',
                'golfer.societyevents': 'Society Events',
                'golfer.livescorecard': 'Live Scorecard',
                'golfer.teetime': 'Tee Time',
                'golfer.teetime.desc': 'Reserve your next round',
                'golfer.teetime.available': 'Available Now',
                'golfer.caddy': 'Caddy',
                'golfer.caddy.desc': 'Request a caddy',
                'golfer.caddy.booknow': 'Book Now',
                'golfer.food.title': 'Food',
                'golfer.food.desc': 'Course dining & beverages',
                'golfer.food.open': 'Kitchen Open',
                'golfer.schedule.desc': 'View your calendar',
                'golfer.schedule.planahead': 'Plan Ahead',
                'golfer.orders': 'Orders',
                'golfer.orders.desc': 'Track your orders',
                'golfer.orders.viewstatus': 'View Status',
                'golfer.stats': 'Stats',
                'golfer.stats.desc': 'Performance tracking',
                'golfer.stats.rounds': '47 Rounds',
                'golfer.gps.desc': 'Course navigation',
                'golfer.gps.livetracking': 'Live Tracking',
                'golfer.history': 'History',
                'golfer.history.desc': 'Round history',
                'golfer.history.viewpast': 'View Past',
                'golfer.featured.caddies': 'Featured Caddies',
                'golfer.featured.desc': 'Discover top-rated caddies and explore new golf courses',
                'golfer.refresh': 'Refresh',
                'golfer.today.teetime': 'Today\'s Tee Time',
                'golfer.no.teetime': 'No tee time booked today',
                'golfer.book.prompt': 'Book your next round to see it here',
                'golfer.book.teetime': 'Book Tee Time',
                'golfer.live.status': 'Live Course Status',
                'golfer.current.hole': 'Current Hole',
                'golfer.not.playing': 'Not playing',
                'golfer.yards.topin': 'Yards to Pin',
                'golfer.temperature': 'Temperature',
                'golfer.wind': 'Wind',
                'golfer.conditions': 'Conditions',
                'golfer.performance': 'Performance Overview',
                'golfer.viewdetails': 'View Details',
                'golfer.bestscore': 'Best Score',
                'golfer.avgscore': 'Average Score',
                'golfer.roundsplayed': 'Rounds Played',
                'golfer.eagles': 'Eagles',
                'golfer.norounds': 'No rounds yet',
                'golfer.thisyear': 'This year',
                'golfer.thismonth': 'This month',
                'golfer.book.title': 'Book Your Tee Time',
                'golfer.search.course': 'Search & Select Golf Course',
                'golfer.search.placeholder': 'Search courses (e.g., Pattana, Championship, Executive...)',
                'golfer.sunny': 'Sunny',
                'golfer.selectdate': 'Select Date',
                'golfer.preferredtime': 'Preferred Time',
                'golfer.choosetime': 'Choose time...',
                'golfer.numplayers': 'Number of Players',
                'golfer.player': 'Player',
                'golfer.players': 'Players',
                'golfer.selectcaddy': 'Select Professional Caddys',
                'golfer.available': 'available',
                'golfer.onwaitlist': 'on waitlist',
                'golfer.searchcaddy': 'Search by caddie name, number, or specialty...',
                'golfer.bookingdetails': 'Booking Details',
                'golfer.confirmbooking': 'Confirm Booking',
                'golfer.mybookings': 'My Bookings',
                'golfer.upcoming': 'Upcoming',
                'golfer.past': 'Past',
                'golfer.cancel': 'Cancel',
                'golfer.modify': 'Modify',
                'golfer.food.menu': 'Course Dining Menu',
                'golfer.food.order': 'Place Order',
                'golfer.food.categories': 'Categories',
                'golfer.food.beverages': 'Beverages',
                'golfer.food.meals': 'Meals',
                'golfer.food.snacks': 'Snacks',
                'golfer.food.addtocart': 'Add to Cart',
                'golfer.food.cart': 'Cart',
                'golfer.food.checkout': 'Checkout',
                'golfer.schedule.events': 'Scheduled Events',
                'golfer.schedule.view': 'View Schedule',
                'golfer.schedule.today': 'Today',
                'golfer.schedule.week': 'This Week',
                'golfer.schedule.month': 'This Month',
                'golfer.stats.handicap': 'Handicap Index',
                'golfer.stats.avgputts': 'Avg Putts',
                'golfer.stats.fairways': 'Fairways Hit',
                'golfer.stats.greens': 'Greens in Regulation',
                'golfer.stats.birdies': 'Birdies',
                'golfer.stats.pars': 'Pars',
                'golfer.stats.bogeys': 'Bogeys',
                'golfer.gps.currentlocation': 'Current Location',
                'golfer.gps.distancetohole': 'Distance to Hole',
                'golfer.gps.distancetogreen': 'Distance to Green',
                'golfer.gps.hazards': 'Hazards',
                'golfer.history.filter': 'Filter History',
                'golfer.history.allcourses': 'All Courses',
                'golfer.history.date': 'Date',
                'golfer.history.course': 'Course',
                'golfer.stats.experience': 'Experience',
                'golfer.stats.homeclub': 'Home Club',
                'golfer.stats.society': 'Society',
                'golfer.stats.membersince': 'Member Since',
                'golfer.stats.achievements': 'Achievements',
                'golfer.stats.eagleachievement': 'Eagle Achievement',
                'golfer.stats.handicapimprovement': 'Handicap Improvement',
                'golfer.stats.newplayer': 'New Player',
                'golfer.gps.navigation': 'Course Navigation',
                'golfer.gps.updatelocation': 'Update Location',
                'golfer.gps.satellite': 'Satellite',
                'golfer.gps.centeronme': 'Center on Me',
                'golfer.gps.accuracy': 'GPS Accuracy',
                'golfer.gps.holepar': 'Hole Par',
                'golfer.gps.yardstotal': 'Yards Total',
                'golfer.gps.distanceinfo': 'Distance Information',
                'golfer.gps.tofront': 'To Front',
                'golfer.gps.topin': 'To Pin',
                'golfer.gps.toback': 'To Back',
                'golfer.gps.conditions': 'Course Conditions',
                'golfer.gps.measuredistance': 'Measure Distance',
                'golfer.gps.findcart': 'Find Cart',
                'golfer.gps.callmarshal': 'Call Marshal',
                'golfer.gps.paceofplay': 'Pace of Play',
                'golfer.gps.ontime': 'On Time',
                'golfer.gps.elapsed': 'elapsed',
                'golfer.history.title': 'Round History',
                'golfer.history.addround': 'Add Round',
                'golfer.history.totalrounds': 'Total Rounds',
                'golfer.history.avgscoreLabel': 'Average Score',
                'golfer.history.currenthandicap': 'Current Handicap',
                'golfer.history.bestround': 'Best Round',
                'golfer.history.courselabel': 'Course',
                'golfer.history.year': 'Year',
                'golfer.history.tees': 'Tees',
                'golfer.history.alltees': 'All Tees',

                // Live Scorecard
                'scorecard.course': 'Course',
                'scorecard.select.course': '-- Select Course --',
                'scorecard.teemarkers': 'Tee Markers',
                'scorecard.red': 'Red',
                'scorecard.white': 'White',
                'scorecard.yellow': 'Yellow',
                'scorecard.blue': 'Blue',
                'scorecard.black': 'Black',
                'scorecard.scoring.formats': 'Scoring Formats (select one or more)',
                'scorecard.select.all': 'Select All / Deselect All',
                'scorecard.course.data.note': 'Course data loads only when you start round',
                'scorecard.manage': 'Manage',
                'scorecard.players': 'Players',
                'scorecard.addplayer': 'Add Player',
                'scorecard.playername': 'Player Name',
                'scorecard.handicap': 'Handicap',
                'scorecard.startround': 'Start Round',
                'scorecard.hole': 'Hole',
                'scorecard.par': 'Par',
                'scorecard.yards': 'Yards',
                'scorecard.score': 'Score',
                'scorecard.points': 'Points',
                'scorecard.total': 'Total',
                'scorecard.front9': 'Front 9',
                'scorecard.back9': 'Back 9',
                'scorecard.gross': 'Gross',
                'scorecard.net': 'Net',
                'scorecard.stableford': 'Thailand Stableford',
                'scorecard.strokeplay': 'Stroke Play',
                'scorecard.matchplay': 'Match Play',
                'scorecard.completeround': 'Complete Round',
                'scorecard.finalize': 'Finalize Scorecard',
                'scorecard.summary': 'Round Summary',
                'scorecard.export': 'Export to LINE',

                // Maintenance Dashboard
                'login.maintenance': 'Login as Maintenance',
                'maintenance.title': 'Maintenance Dashboard',
                'maintenance.welcome': 'Welcome back, Maintenance!',
                'maintenance.overview': 'Overview',
                'maintenance.course.updates': 'Course Updates',
                'maintenance.tasks': 'Task Management',
                'maintenance.equipment': 'Equipment',
                'maintenance.schedule': 'Schedule',
                'maintenance.course.maintenance': 'Course Maintenance',
                'maintenance.professional.care': 'Professional Golf Course Care',
                'maintenance.courses.active': '4 Courses Active',
                'maintenance.tasks.today': '12 Tasks Today',
                'maintenance.crew.members': '8 Crew Members',
                'maintenance.course.condition': 'Course Condition',
                'maintenance.excellent.rating': 'Excellent rating',
                'maintenance.holes.maintained': 'Holes Maintained',
                'maintenance.water.usage': 'Water Usage (hrs)',
                'maintenance.optimal.level': 'Optimal level',
                'maintenance.equipment.issues': 'Equipment Issues',
                'maintenance.needs.attention': 'Needs attention',
                'maintenance.pending.tasks': 'Pending Tasks',
                'maintenance.due.today': 'Due today',
                'maintenance.live.updates': 'Live Course Updates',
                'maintenance.report.conditions': 'Report course conditions with photos and detailed descriptions',
                'maintenance.submit.update': 'Submit Course Update',
                'maintenance.course.section': 'Course Section',
                'maintenance.select.section': 'Select course section...',
                'maintenance.hole.number': 'Hole Number',
                'maintenance.select.hole': 'Select hole number...',
                'maintenance.area.type': 'Area Type',
                'maintenance.select.area': 'Select area type...',
                'maintenance.tee.box': 'Tee Box',
                'maintenance.fairway': 'Fairway',
                'maintenance.rough': 'Rough',
                'maintenance.fairway.bunker': 'Fairway Bunker',
                'maintenance.greenside.bunker': 'Greenside Bunker',
                'maintenance.green': 'Green',
                'maintenance.flag.cup': 'Flag and Cup',
                'maintenance.issue.priority': 'Issue Priority',
                'maintenance.low.routine': 'Low - Routine maintenance',
                'maintenance.medium.attention': 'Medium - Needs attention',
                'maintenance.high.urgent': 'High - Urgent repair',
                'maintenance.critical.safety': 'Critical - Safety concern',
                'maintenance.description': 'Description',
                'maintenance.describe.issue': 'Describe the issue or condition in detail...',
                'maintenance.upload.photos': 'Upload Photos',
                'maintenance.click.upload': 'Click to upload photos or drag and drop',
                'maintenance.choose.photos': 'Choose Photos',
                'maintenance.submit.course.update': 'Submit Course Update',
                'maintenance.recent.updates': 'Recent Course Updates',
                'maintenance.all.courses': 'All Courses',

                // Emergency & Safety
                'emergency.alert': 'Emergency Alert',
                'emergency.select.type': 'Select the type of assistance you need',
                'emergency.safety.info': 'Safety Info',
                'emergency.course.safety': 'Course Safety Information',
                'emergency.alert.sent': 'Alert Sent Successfully',

                // Profile Creation
                'profile.create': 'Create Your Profile',
                'profile.choose.role': 'Choose your role and fill in your information',
                'profile.golfer.info': 'Golfer Information',
                'profile.caddie.info': 'Caddy Information',
                'profile.manager.info': 'Manager Information',
                'profile.proshop.info': 'Pro Shop Information',
                'profile.maintenance.info': 'Maintenance Information',
                'profile.handicap': 'Handicap',
                'profile.experience.level': 'Experience Level',
                'profile.select.level': 'Select level...',
                'profile.beginner': 'Beginner',
                'profile.intermediate': 'Intermediate',
                'profile.advanced': 'Advanced',
                'profile.professional': 'Professional',
                'profile.club.affiliation': 'Club Affiliation',
                'profile.select.society': 'Select society...',
                'profile.playing.style': 'Playing Style',
                'profile.years.experience': 'Years of Experience',
                'profile.specialty': 'Specialty',
                'profile.select.specialty': 'Select specialty...',
                'profile.championship.course': 'Championship Course',
                'profile.beginner.support': 'Beginner Support',
                'profile.tournament.play': 'Tournament Play',
                'profile.vip.service': 'VIP Service',
                'profile.international.service': 'International Service',
                'profile.languages': 'Languages (select multiple)',
                'profile.preferred.avatar': 'Preferred Avatar',
                'profile.avatar.man': 'Man',
                'profile.avatar.woman': 'Woman',
                'profile.avatar.bald.man': 'Bald Man',
                'profile.avatar.bald.woman': 'Bald Woman',
                'profile.avatar.curly.man': 'Curly Hair Man',
                'profile.avatar.curly.woman': 'Curly Hair Woman',
                'profile.avatar.white.man': 'White Hair Man',
                'profile.avatar.white.woman': 'White Hair Woman',
                'profile.years.management': 'Years in Management',
                'profile.golf.professional': 'Golf Professional',

                // Common Form Elements
                'form.email': 'Email',
                'form.phone': 'Phone',
                'form.first.name': 'First Name',
                'form.last.name': 'Last Name',
                'form.create.profile': 'Create Profile',
                'form.submit': 'Submit',

                // Page Titles
                'page.title': 'MciPro - Professional Golf Course Management Platform',
            },

            th: {
                // Login Screen
                'app.title': 'MciPro',
                'app.subtitle': 'ระบบบริหารจัดการสนามกอล์ฟมืออาชีพ',
                'login.golfer': 'เข้าสู่ระบบสำหรับนักกอล์ฟ',
                'login.caddie': 'เข้าสู่ระบบสำหรับแคดดี้',
                'login.manager': 'เข้าสู่ระบบสำหรับผู้จัดการ',
                'login.proshop': 'เข้าสู่ระบบสำหรับโปรช็อป',

                // Navigation & Common
                'nav.logout': 'ออกจากระบบ',
                'nav.emergency': 'แจ้งเหตุฉุกเฉิน',
                'common.back': 'กลับ',
                'common.next': 'ถัดไป',
                'common.save': 'บันทึก',
                'common.cancel': 'ยกเลิก',
                'common.close': 'ปิด',
                'common.loading': 'กำลังโหลด...',
                'common.settings': 'การตั้งค่า',
                'common.chat': 'แชท',
                'common.logout': 'ออกจากระบบ',
                'common.edit': 'แก้ไข',
                'common.delete': 'ลบ',
                'common.view': 'ดู',
                'common.add': 'เพิ่ม',
                'common.remove': 'ลบออก',
                'common.update': 'อัปเดต',
                'common.submit': 'ส่ง',
                'common.confirm': 'ยืนยัน',
                'common.active': 'ใช้งานอยู่',
                'common.inactive': 'ไม่ได้ใช้งาน',
                'common.pending': 'รอดำเนินการ',
                'common.completed': 'เสร็จสิ้น',
                'common.error': 'ข้อผิดพลาด',
                'common.success': 'สำเร็จ',
                'common.date': 'วันที่',
                'common.time': 'เวลา',
                'common.name': 'ชื่อ',
                'common.description': 'คำอธิบาย',
                'common.status': 'สถานะ',
                'common.actions': 'การดำเนินการ',
                'common.refresh': 'รีเฟรช',
                'common.select': 'เลือก',
                'common.all': 'ทั้งหมด',
                'common.none': 'ไม่มี',
                'common.yes': 'ใช่',
                'common.no': 'ไม่ใช่',
                'common.upload': 'อัปโหลด',
                'common.capture': 'ถ่ายภาพ',
                'common.photo': 'รูปภาพ',
                'common.image': 'ภาพ',

                // Scorecard Modals
                'modal.scan.title': 'สแกนสกอร์การ์ด',
                'modal.scan.course': 'เลือกโปรไฟล์สนาม (เพื่อความแม่นยำที่ดีขึ้น)',
                'modal.scan.generic': 'ทั่วไป (สนามใดก็ได้)',
                'modal.scan.help': 'เลือกสนามของคุณเพื่อ OCR ที่ดีที่สุด เลือก "ทั่วไป" หากไม่มีสนามของคุณในรายการ',
                'modal.scan.capture': 'ถ่ายภาพ',
                'modal.scan.upload': 'อัปโหลดภาพ',
                'modal.addplayer.title': 'เพิ่มผู้เล่น',
                'modal.addplayer.search': 'ค้นหาผู้เล่น...',
                'modal.addplayer.add': 'เพิ่มผู้เล่น',
                'modal.joingames.title': 'เข้าร่วมเกมที่กำลังเล่น',
                'modal.joingames.available': 'เกมที่มีอยู่',
                'modal.joingames.join': 'เข้าร่วมเกม',
                'modal.finalized.title': 'รอบเสร็จสิ้น',
                'modal.finalized.congrats': 'ยินดีด้วย!',
                'modal.finalized.score': 'คะแนนสุดท้าย',
                'modal.finalized.share': 'แชร์ผลลัพธ์',
                'modal.export.title': 'ส่งออกไปยัง LINE',
                'modal.export.sharing': 'แชร์สกอร์การ์ดของคุณ',

                // Manager Dashboard
                'manager.title': 'แดชบอร์ดผู้จัดการ',
                'manager.welcome': 'ยินดีต้อนรับกลับ ผู้จัดการ!',
                'manager.overview': 'ภาพรวม',
                'manager.staff': 'การจัดการพนักงาน',
                'manager.analytics': 'การวิเคราะห์',
                'manager.reports': 'รายงาน',
                'manager.traffic': 'การจราจร',
                'manager.maintenance': 'ซ่อมบำรุง',
                'manager.weather': 'สภาพอากาศ',
                'manager.course.operations': 'การดำเนินงานสนาม',
                'manager.managing': 'การจัดการสนามกอล์ฟพัทยา',
                'manager.monthly.revenue': 'รายได้รายเดือน',
                'manager.holes.active': '18 หลุมใช้งาน',
                'manager.staff.members': 'พนักงาน 47 คน',
                'manager.satisfaction': 'ความพึงพอใจ 98%',
                'manager.todays.rounds': 'รอบวันนี้',
                'manager.active.caddies': 'แคดดี้ที่ใช้งาน',
                'manager.course.occupancy': 'การใช้งานสนาม',
                'manager.emergency.alerts': 'การแจ้งเหตุฉุกเฉิน',
                'manager.current.rounds': 'รอบปัจจุบัน',
                'manager.staff.status': 'สถานะพนักงาน',
                'manager.nodata': 'ยังไม่มีข้อมูล',
                'manager.noassignments': 'ไม่มีงาน',
                'manager.nobookings': 'ไม่มีการจอง',
                'manager.allclear': 'ปลอดภัยดี',

                // Caddy Dashboard
                'caddie.title': 'แดชบอร์ดแคดดี้',
                'caddie.welcome': 'ยินดีต้อนรับกลับ แคดดี้!',
                'caddie.overview': 'ภาพรวม',
                'caddie.assignments': 'งานที่ได้รับมอบหมาย',
                'caddie.tracking': 'ติดตามสด',
                'caddie.reports': 'รายงาน',
                'caddie.earnings': 'รายได้',
                'caddie.monthly.earnings': 'รายได้รายเดือน',
                'caddie.elite.status': 'สถานะพิเศษ',
                'caddie.current.round': 'รอบปัจจุบัน',
                'caddie.performance': 'ผลการปฏิบัติงาน',
                'caddie.currentstatus': 'สถานะปัจจุบัน',
                'caddie.available': 'พร้อมให้บริการ',
                'caddie.readyforbookings': 'พร้อมรับการจอง',
                'caddie.nocurrentbookings': 'ไม่มีการจองในขณะนี้',
                'caddie.checkschedule': 'ตรวจสอบตารางสำหรับงานที่กำลังจะมาถึง',
                'caddie.waitlist': 'รายชื่อรอ',
                'caddie.people': 'คน',
                'caddie.nogolfers': 'ไม่มีนักกอล์ฟในรายชื่อรอ',
                'caddie.newrequests': 'คำขอใหม่จะปรากฏที่นี่',
                'caddie.liveroundtracking': 'ติดตามรอบสด',
                'caddie.starttracking': 'เริ่มติดตามเมื่อคุณถึงหลุมแรกกับนักกอล์ฟของคุณ',
                'caddie.startroundtracking': 'เริ่มติดตามรอบ',
                'caddie.roundinprogress': 'รอบกำลังดำเนินการ',
                'caddie.currenthole': 'หลุมปัจจุบัน',
                'caddie.roundtime': 'เวลาเล่น',
                'caddie.gpsstatus': 'สถานะ GPS',
                'caddie.finishround': 'จบรอบ',
                'caddie.roundcompleted': 'เสร็จสิ้นรอบแล้ว!',
                'caddie.totaltime': 'เวลารวม',
                'caddie.holescompleted': 'หลุมที่เสร็จสิ้น',
                'caddie.startnewround': 'เริ่มรอบใหม่',
                'caddie.todaysassignment': 'งานประจำวันนี้',
                'caddie.currentlocation': 'ตำแหน่งปัจจุบัน',
                'caddie.livetrackingactive': 'การติดตามสดทำงานอยู่',
                'caddie.nextassignment': 'งานถัดไป',
                'caddie.todaysearnings': 'รายได้วันนี้',
                'caddie.roundscompleted': 'รอบที่เสร็จสิ้น',
                'caddie.currentroundstatus': 'สถานะรอบปัจจุบัน',
                'caddie.noactiveround': 'ไม่มีรอบที่ทำงานอยู่',
                'caddie.starttrackingbegin': 'เริ่มติดตามเมื่อคุณเริ่มรอบ',
                'caddie.performancemetrics': 'ตัวชี้วัดผลการปฏิบัติงาน',
                'caddie.averageroundtime': 'เวลาเฉลี่ยต่อรอบ',
                'caddie.clientsatisfaction': 'ความพึงพอใจของลูกค้า',
                'caddie.roundsthisweek': 'รอบสัปดาห์นี้',
                'caddie.weeklyearnings': 'รายได้รายสัปดาห์',
                'caddie.todaysassignments': 'งานประจำวันนี้',
                'caddie.noassignmentsyet': 'ยังไม่มีงาน',
                'caddie.newbookingrequests': 'คำขอจองใหม่จะปรากฏที่นี่',
                'caddie.assignmentsummary': 'สรุปงาน',
                'caddie.todaytotal': 'รวมวันนี้',
                'caddie.scheduled': 'กำหนดการแล้ว',
                'caddie.projectedearnings': 'รายได้คาดการณ์',
                'caddie.weekahead': 'สัปดาห์หน้า',
                'caddie.noupcomingassignments': 'ไม่มีงานที่กำลังจะมาถึง',
                'caddie.livecoursetracking': 'ติดตามสนามสด',
                'caddie.interactivecourse': 'แผนที่สนามแบบอินเทอร์แอคทีฟพร้อมตำแหน่งเรียลไทม์',

                // Pro Shop
                'proshop.title': 'แดชบอร์ดโปรช็อป',
                'proshop.welcome': 'ยินดีต้อนรับกลับ โปรช็อป!',
                'proshop.pos': 'จุดขาย',
                'proshop.inventory': 'คลังสินค้า',
                'proshop.sales': 'รายงานการขาย',
                'proshop.customers': 'ลูกค้า',
                'proshop.pos.title': 'จุดขายโปรช็อป',
                'proshop.equipment': 'อุปกรณ์กอล์ฟและสินค้า',
                'proshop.items': 'สินค้า 450+ ชิ้น',
                'proshop.sales.today': 'ยอดขายวันนี้ 28 รายการ',
                'proshop.service': 'บริการ 4.9★',
                'proshop.todays.sales': 'ยอดขายวันนี้',
                'proshop.search.products': 'ค้นหาสินค้า...',
                'proshop.all.categories': 'หมวดหมู่ทั้งหมด',
                'proshop.golf.clubs': 'ไม้กอล์ฟ',
                'proshop.golf.balls': 'ลูกกอล์ฟ',
                'proshop.apparel': 'เสื้อผ้า',
                'proshop.accessories': 'อุปกรณ์เสริม',
                'proshop.beverages': 'เครื่องดื่ม',
                'proshop.snacks': 'ขนม',
                'proshop.shopping.cart': 'ตะกร้าสินค้า',
                'proshop.cart.empty': 'ตะกร้าว่างเปล่า',
                'proshop.add.products': 'เพิ่มสินค้าเพื่อเริ่มการขาย',
                'proshop.subtotal': 'ยอดรวมย่อย:',
                'proshop.tax': 'ภาษี (7%):',
                'proshop.total': 'รวมทั้งหมด:',
                'proshop.cash.payment': 'ชำระเงินสด',
                'proshop.card.payment': 'ชำระด้วยบัตร',
                'proshop.payment.successful': 'ชำระเงินสำเร็จ!',
                'proshop.print.receipt': 'พิมพ์ใบเสร็จ',
                'proshop.new.sale': 'การขายใหม่',

                // Golfer Dashboard
                'golfer.title': 'แดชบอร์ดนักกอล์ฟ',
                'golfer.welcome': 'ยินดีต้อนรับกลับ',
                'golfer.overview': 'ภาพรวม',
                'golfer.booking': 'การจอง',
                'golfer.food': 'อาหารและเครื่องดื่ม',
                'golfer.gps': 'GPS และการนำทาง',
                'golfer.emergency': 'เหตุฉุกเฉิน',
                'golfer.profile': 'โปรไฟล์',
                'golfer.chat': 'แชท',
                'golfer.schedule': 'ตารางงาน',
                'golfer.orderstatus': 'สถานะคำสั่งซื้อ',
                'golfer.statistics': 'สถิติ',
                'golfer.roundhistory': 'ประวัติรอบ',
                'golfer.societyevents': 'กิจกรรมสมาคม',
                'golfer.livescorecard': 'สกอร์การ์ดสด',
                'golfer.teetime': 'เวลาตีออก',
                'golfer.teetime.desc': 'จองรอบถัดไป',
                'golfer.teetime.available': 'พร้อมใช้งาน',
                'golfer.caddy': 'แคดดี้',
                'golfer.caddy.desc': 'ขอแคดดี้',
                'golfer.caddy.booknow': 'จองเลย',
                'golfer.food.title': 'อาหาร',
                'golfer.food.desc': 'อาหารและเครื่องดื่มในสนาม',
                'golfer.food.open': 'ครัวเปิด',
                'golfer.schedule.desc': 'ดูปฏิทินของคุณ',
                'golfer.schedule.planahead': 'วางแผนล่วงหน้า',
                'golfer.orders': 'คำสั่งซื้อ',
                'golfer.orders.desc': 'ติดตามคำสั่งซื้อของคุณ',
                'golfer.orders.viewstatus': 'ดูสถานะ',
                'golfer.stats': 'สถิติ',
                'golfer.stats.desc': 'ติดตามผลงาน',
                'golfer.stats.rounds': '47 รอบ',
                'golfer.gps.desc': 'การนำทางในสนาม',
                'golfer.gps.livetracking': 'ติดตามสด',
                'golfer.history': 'ประวัติ',
                'golfer.history.desc': 'ประวัติรอบ',
                'golfer.history.viewpast': 'ดูย้อนหลัง',
                'golfer.featured.caddies': 'แคดดี้แนะนำ',
                'golfer.featured.desc': 'ค้นพบแคดดี้ชั้นนำและสำรวจสนามกอล์ฟใหม่',
                'golfer.refresh': 'รีเฟรช',
                'golfer.today.teetime': 'เวลาตีออกวันนี้',
                'golfer.no.teetime': 'ยังไม่มีการจองเวลาตีออกวันนี้',
                'golfer.book.prompt': 'จองรอบถัดไปเพื่อดูที่นี่',
                'golfer.book.teetime': 'จองเวลาตีออก',
                'golfer.live.status': 'สถานะสนามสด',
                'golfer.current.hole': 'หลุมปัจจุบัน',
                'golfer.not.playing': 'ไม่ได้เล่น',
                'golfer.yards.topin': 'หลาถึงธง',
                'golfer.temperature': 'อุณหภูมิ',
                'golfer.wind': 'ลม',
                'golfer.conditions': 'สภาพอากาศ',
                'golfer.performance': 'ภาพรวมผลงาน',
                'golfer.viewdetails': 'ดูรายละเอียด',
                'golfer.bestscore': 'คะแนนที่ดีที่สุด',
                'golfer.avgscore': 'คะแนนเฉลี่ย',
                'golfer.roundsplayed': 'รอบที่เล่น',
                'golfer.eagles': 'อีเกิ้ล',
                'golfer.norounds': 'ยังไม่มีรอบ',
                'golfer.thisyear': 'ปีนี้',
                'golfer.thismonth': 'เดือนนี้',
                'golfer.book.title': 'จองเวลาตีออก',
                'golfer.search.course': 'ค้นหาและเลือกสนามกอล์ฟ',
                'golfer.search.placeholder': 'ค้นหาสนาม (เช่น พัทยา, แชมเปี้ยนชิพ, เอ็กเซคคิวทีฟ...)',
                'golfer.sunny': 'แดดสดใส',
                'golfer.selectdate': 'เลือกวันที่',
                'golfer.preferredtime': 'เวลาที่ต้องการ',
                'golfer.choosetime': 'เลือกเวลา...',
                'golfer.numplayers': 'จำนวนผู้เล่น',
                'golfer.player': 'ผู้เล่น',
                'golfer.players': 'ผู้เล่น',
                'golfer.selectcaddy': 'เลือกแคดดี้มืออาชีพ',
                'golfer.available': 'พร้อมให้บริการ',
                'golfer.onwaitlist': 'รอคิว',
                'golfer.searchcaddy': 'ค้นหาด้วยชื่อ หมายเลข หรือความเชี่ยวชาญของแคดดี้...',
                'golfer.bookingdetails': 'รายละเอียดการจอง',
                'golfer.confirmbooking': 'ยืนยันการจอง',
                'golfer.mybookings': 'การจองของฉัน',
                'golfer.upcoming': 'กำลังจะมาถึง',
                'golfer.past': 'ผ่านมาแล้ว',
                'golfer.cancel': 'ยกเลิก',
                'golfer.modify': 'แก้ไข',
                'golfer.food.menu': 'เมนูอาหารในสนาม',
                'golfer.food.order': 'สั่งอาหาร',
                'golfer.food.categories': 'หมวดหมู่',
                'golfer.food.beverages': 'เครื่องดื่ม',
                'golfer.food.meals': 'อาหารมื้อหลัก',
                'golfer.food.snacks': 'ของว่าง',
                'golfer.food.addtocart': 'เพิ่มลงตะกร้า',
                'golfer.food.cart': 'ตะกร้า',
                'golfer.food.checkout': 'ชำระเงิน',
                'golfer.schedule.events': 'กิจกรรมที่กำหนดไว้',
                'golfer.schedule.view': 'ดูตารางงาน',
                'golfer.schedule.today': 'วันนี้',
                'golfer.schedule.week': 'สัปดาห์นี้',
                'golfer.schedule.month': 'เดือนนี้',
                'golfer.stats.handicap': 'ดัชนีแฮนดิแคป',
                'golfer.stats.avgputts': 'พัตต์เฉลี่ย',
                'golfer.stats.fairways': 'เฟร์เวย์ที่ตี',
                'golfer.stats.greens': 'กรีนในกฎระเบียบ',
                'golfer.stats.birdies': 'เบอร์ดี้',
                'golfer.stats.pars': 'พาร์',
                'golfer.stats.bogeys': 'โบกี้',
                'golfer.gps.currentlocation': 'ตำแหน่งปัจจุบัน',
                'golfer.gps.distancetohole': 'ระยะถึงหลุม',
                'golfer.gps.distancetogreen': 'ระยะถึงกรีน',
                'golfer.gps.hazards': 'อุปสรรค',
                'golfer.history.filter': 'กรองประวัติ',
                'golfer.history.allcourses': 'สนามทั้งหมด',
                'golfer.history.date': 'วันที่',
                'golfer.history.course': 'สนาม',
                'golfer.stats.experience': 'ประสบการณ์',
                'golfer.stats.homeclub': 'สโมสรบ้าน',
                'golfer.stats.society': 'สมาคม',
                'golfer.stats.membersince': 'สมาชิกตั้งแต่',
                'golfer.stats.achievements': 'ความสำเร็จ',
                'golfer.stats.eagleachievement': 'ความสำเร็จอีเกิล',
                'golfer.stats.handicapimprovement': 'การพัฒนาแฮนดิแคป',
                'golfer.stats.newplayer': 'ผู้เล่นใหม่',
                'golfer.gps.navigation': 'การนำทางสนาม',
                'golfer.gps.updatelocation': 'อัปเดตตำแหน่ง',
                'golfer.gps.satellite': 'ดาวเทียม',
                'golfer.gps.centeronme': 'จัดกึ่งกลางที่ฉัน',
                'golfer.gps.accuracy': 'ความแม่นยำ GPS',
                'golfer.gps.holepar': 'พาร์หลุม',
                'golfer.gps.yardstotal': 'ระยะรวม',
                'golfer.gps.distanceinfo': 'ข้อมูลระยะทาง',
                'golfer.gps.tofront': 'ถึงด้านหน้า',
                'golfer.gps.topin': 'ถึงธง',
                'golfer.gps.toback': 'ถึงด้านหลัง',
                'golfer.gps.conditions': 'สภาพสนาม',
                'golfer.gps.measuredistance': 'วัดระยะทาง',
                'golfer.gps.findcart': 'หารถกอล์ฟ',
                'golfer.gps.callmarshal': 'เรียกมาร์แชล',
                'golfer.gps.paceofplay': 'จังหวะการเล่น',
                'golfer.gps.ontime': 'ตรงเวลา',
                'golfer.gps.elapsed': 'ผ่านไป',
                'golfer.history.title': 'ประวัติการเล่น',
                'golfer.history.addround': 'เพิ่มรอบ',
                'golfer.history.totalrounds': 'รอบทั้งหมด',
                'golfer.history.avgscoreLabel': 'คะแนนเฉลี่ย',
                'golfer.history.currenthandicap': 'แฮนดิแคปปัจจุบัน',
                'golfer.history.bestround': 'รอบที่ดีที่สุด',
                'golfer.history.courselabel': 'สนาม',
                'golfer.history.year': 'ปี',
                'golfer.history.tees': 'ที่ตีออก',
                'golfer.history.alltees': 'ที่ตีออกทั้งหมด',

                // Live Scorecard
                'scorecard.course': 'สนาม',
                'scorecard.select.course': '-- เลือกสนาม --',
                'scorecard.teemarkers': 'ที่ตีออก',
                'scorecard.red': 'แดง',
                'scorecard.white': 'ขาว',
                'scorecard.yellow': 'เหลือง',
                'scorecard.blue': 'น้ำเงิน',
                'scorecard.black': 'ดำ',
                'scorecard.scoring.formats': 'รูปแบบการนับคะแนน (เลือกหนึ่งหรือหลายรูปแบบ)',
                'scorecard.select.all': 'เลือกทั้งหมด / ยกเลิกทั้งหมด',
                'scorecard.course.data.note': 'ข้อมูลสนามจะโหลดเมื่อคุณเริ่มรอบ',
                'scorecard.manage': 'จัดการ',
                'scorecard.players': 'ผู้เล่น',
                'scorecard.addplayer': 'เพิ่มผู้เล่น',
                'scorecard.playername': 'ชื่อผู้เล่น',
                'scorecard.handicap': 'แฮนดิแคป',
                'scorecard.startround': 'เริ่มรอบ',
                'scorecard.hole': 'หลุม',
                'scorecard.par': 'พาร์',
                'scorecard.yards': 'หลา',
                'scorecard.score': 'คะแนน',
                'scorecard.points': 'แต้ม',
                'scorecard.total': 'รวม',
                'scorecard.front9': 'หน้า 9',
                'scorecard.back9': 'หลัง 9',
                'scorecard.gross': 'กรอส',
                'scorecard.net': 'เน็ต',
                'scorecard.stableford': 'สเตเบิลฟอร์ดไทย',
                'scorecard.strokeplay': 'สโตรคเพลย์',
                'scorecard.matchplay': 'แมตช์เพลย์',
                'scorecard.completeround': 'จบรอบ',
                'scorecard.finalize': 'สรุปสกอร์การ์ด',
                'scorecard.summary': 'สรุปรอบ',
                'scorecard.export': 'ส่งออกไปยัง LINE',

                // Maintenance Dashboard
                'login.maintenance': 'เข้าสู่ระบบสำหรับทีมดูแลสนาม',
                'maintenance.title': 'แดชบอร์ดทีมดูแลสนาม',
                'maintenance.welcome': 'ยินดีต้อนรับกลับ ทีมดูแลสนาม!',
                'maintenance.overview': 'ภาพรวม',
                'maintenance.course.updates': 'อัปเดตสภาพสนาม',
                'maintenance.tasks': 'การจัดการงาน',
                'maintenance.equipment': 'อุปกรณ์',
                'maintenance.schedule': 'ตารางงาน',
                'maintenance.course.maintenance': 'การดูแลสนามกอล์ฟ',
                'maintenance.professional.care': 'การดูแลสนามกอล์ฟมืออาชีพ',
                'maintenance.courses.active': '4 สนามดำเนินการ',
                'maintenance.tasks.today': 'งานวันนี้ 12 รายการ',
                'maintenance.crew.members': 'ทีมงาน 8 คน',
                'maintenance.course.condition': 'สภาพสนาม',
                'maintenance.excellent.rating': 'ระดับดีเยี่ยม',
                'maintenance.holes.maintained': 'หลุมที่ดูแลแล้ว',
                'maintenance.water.usage': 'การใช้น้ำ (ชั่วโมง)',
                'maintenance.optimal.level': 'ระดับที่เหมาะสม',
                'maintenance.equipment.issues': 'ปัญหาอุปกรณ์',
                'maintenance.needs.attention': 'ต้องการดูแล',
                'maintenance.pending.tasks': 'งานรอดำเนินการ',
                'maintenance.due.today': 'ครบกำหนดวันนี้',
                'maintenance.live.updates': 'อัปเดตสภาพสนามแบบสด',
                'maintenance.report.conditions': 'รายงานสภาพสนามพร้อมรูปภาพและรายละเอียด',
                'maintenance.submit.update': 'ส่งรายงานอัปเดตสนาม',
                'maintenance.course.section': 'ส่วนของสนาม',
                'maintenance.select.section': 'เลือกส่วนของสนาม...',
                'maintenance.hole.number': 'หมายเลขหลุม',
                'maintenance.select.hole': 'เลือกหมายเลขหลุม...',
                'maintenance.area.type': 'ประเภทพื้นที่',
                'maintenance.select.area': 'เลือกประเภทพื้นที่...',
                'maintenance.tee.box': 'จุดตีออก',
                'maintenance.fairway': 'แฟร์เวย์',
                'maintenance.rough': 'รัฟ',
                'maintenance.fairway.bunker': 'บังเกอร์แฟร์เวย์',
                'maintenance.greenside.bunker': 'บังเกอร์ข้างกรีน',
                'maintenance.green': 'กรีน',
                'maintenance.flag.cup': 'ธงและหลุม',
                'maintenance.issue.priority': 'ระดับความสำคัญ',
                'maintenance.low.routine': 'ต่ำ - การดูแลปกติ',
                'maintenance.medium.attention': 'กลาง - ต้องการดูแล',
                'maintenance.high.urgent': 'สูง - ต้องซ่อมด่วน',
                'maintenance.critical.safety': 'วิกฤต - เรื่องความปลอดภัย',
                'maintenance.description': 'รายละเอียด',
                'maintenance.describe.issue': 'อธิบายปัญหาหรือสภาพพื้นที่โดยละเอียด...',
                'maintenance.upload.photos': 'อัปโหลดรูปภาพ',
                'maintenance.click.upload': 'คลิกเพื่ออัปโหลดรูปภาพหรือลากมาวาง',
                'maintenance.choose.photos': 'เลือกรูปภาพ',
                'maintenance.submit.course.update': 'ส่งรายงานอัปเดตสนาม',
                'maintenance.recent.updates': 'อัปเดตล่าสุด',
                'maintenance.all.courses': 'ทุกสนาม',

                // Emergency & Safety
                'emergency.alert': 'แจ้งเหตุฉุกเฉิน',
                'emergency.select.type': 'เลือกประเภทของความช่วยเหลือที่ต้องการ',
                'emergency.safety.info': 'ข้อมูลความปลอดภัย',
                'emergency.course.safety': 'ข้อมูลความปลอดภัยของสนาม',
                'emergency.alert.sent': 'ส่งการแจ้งเหตุสำเร็จแล้ว',

                // Profile Creation
                'profile.create': 'สร้างโปรไฟล์ของคุณ',
                'profile.choose.role': 'เลือกบทบาทของคุณและกรอกข้อมูล',
                'profile.golfer.info': 'ข้อมูลนักกอล์ฟ',
                'profile.caddie.info': 'ข้อมูลแคดดี้',
                'profile.manager.info': 'ข้อมูลผู้จัดการ',
                'profile.proshop.info': 'ข้อมูลโปรช็อป',
                'profile.maintenance.info': 'ข้อมูลทีมดูแลสนาม',
                'profile.handicap': 'แฮนดิแคป',
                'profile.experience.level': 'ระดับประสบการณ์',
                'profile.select.level': 'เลือกระดับ...',
                'profile.beginner': 'มือใหม่',
                'profile.intermediate': 'ระดับกลาง',
                'profile.advanced': 'ระดับสูง',
                'profile.professional': 'มืออาชีพ',
                'profile.club.affiliation': 'สังกัดคลับ',
                'profile.select.society': 'เลือกสมาคม...',
                'profile.playing.style': 'สไตล์การเล่น',
                'profile.years.experience': 'ปีประสบการณ์',
                'profile.specialty': 'ความเชี่ยวชาญ',
                'profile.select.specialty': 'เลือกความเชี่ยวชาญ...',
                'profile.championship.course': 'สนามชิงแชมป์',
                'profile.beginner.support': 'ช่วยเหลือมือใหม่',
                'profile.tournament.play': 'การเล่นแข่งขัน',
                'profile.vip.service': 'บริการวีไอพี',
                'profile.international.service': 'บริการนานาชาติ',
                'profile.languages': 'ภาษา (เลือกได้หลายภาษา)',
                'profile.preferred.avatar': 'อวตารที่ต้องการ',
                'profile.avatar.man': 'ผู้ชาย',
                'profile.avatar.woman': 'ผู้หญิง',
                'profile.avatar.bald.man': 'ผู้ชายหัวล้าน',
                'profile.avatar.bald.woman': 'ผู้หญิงหัวล้าน',
                'profile.avatar.curly.man': 'ผู้ชายผมหยิก',
                'profile.avatar.curly.woman': 'ผู้หญิงผมหยิก',
                'profile.avatar.white.man': 'ผู้ชายผมขาว',
                'profile.avatar.white.woman': 'ผู้หญิงผมขาว',
                'profile.years.management': 'ปีการจัดการ',
                'profile.golf.professional': 'มืออาชีพกอล์ฟ',

                // Common Form Elements
                'form.email': 'อีเมล',
                'form.phone': 'เบอร์โทรศัพท์',
                'form.first.name': 'ชื่อ',
                'form.last.name': 'นามสกุล',
                'form.create.profile': 'สร้างโปรไฟล์',
                'form.submit': 'ส่ง',

                // Page Titles
                'page.title': 'MciPro - ระบบบริหารจัดการสนามกอล์ฟมืออาชีพ',
            },

            ko: {
                // Login Screen
                'app.title': 'MciPro',
                'app.subtitle': '전문 골프장 관리 플랫폼',
                'login.golfer': '골퍼 로그인',
                'login.caddie': '캐디 로그인',
                'login.manager': '매니저 로그인',
                'login.proshop': '프로샵 로그인',

                // Navigation & Common
                'nav.logout': '로그아웃',
                'nav.emergency': '응급 알림',
                'common.back': '뒤로',
                'common.next': '다음',
                'common.save': '저장',
                'common.cancel': '취소',
                'common.close': '닫기',
                'common.loading': '로딩 중...',
                'common.settings': '설정',
                'common.chat': '채팅',
                'common.logout': '로그아웃',
                'common.edit': '편집',
                'common.delete': '삭제',
                'common.view': '보기',
                'common.add': '추가',
                'common.remove': '제거',
                'common.update': '업데이트',
                'common.submit': '제출',
                'common.confirm': '확인',
                'common.active': '활성',
                'common.inactive': '비활성',
                'common.pending': '대기 중',
                'common.completed': '완료',
                'common.error': '오류',
                'common.success': '성공',
                'common.date': '날짜',
                'common.time': '시간',
                'common.name': '이름',
                'common.description': '설명',
                'common.status': '상태',
                'common.actions': '작업',
                'common.refresh': '새로고침',
                'common.select': '선택',
                'common.all': '전체',
                'common.none': '없음',
                'common.yes': '예',
                'common.no': '아니오',
                'common.upload': '업로드',
                'common.capture': '캡처',
                'common.photo': '사진',
                'common.image': '이미지',

                // Scorecard Modals
                'modal.scan.title': '스코어카드 스캔',
                'modal.scan.course': '코스 프로필 선택 (정확도 향상)',
                'modal.scan.generic': '일반 (모든 코스)',
                'modal.scan.help': '최적화된 OCR을 위해 코스를 선택하세요. 목록에 없으면 "일반"을 선택하세요.',
                'modal.scan.capture': '사진 찍기',
                'modal.scan.upload': '이미지 업로드',
                'modal.addplayer.title': '플레이어 추가',
                'modal.addplayer.search': '플레이어 검색...',
                'modal.addplayer.add': '플레이어 추가',
                'modal.joingames.title': '활성 게임 참가',
                'modal.joingames.available': '사용 가능한 게임',
                'modal.joingames.join': '게임 참가',
                'modal.finalized.title': '라운드 완료',
                'modal.finalized.congrats': '축하합니다!',
                'modal.finalized.score': '최종 점수',
                'modal.finalized.share': '결과 공유',
                'modal.export.title': 'LINE으로 내보내기',
                'modal.export.sharing': '스코어카드 공유',

                // Manager Dashboard
                'manager.title': '매니저 대시보드',
                'manager.welcome': '환영합니다, 매니저님!',
                'manager.overview': '개요',
                'manager.staff': '직원 관리',
                'manager.analytics': '분석',
                'manager.reports': '보고서',
                'manager.traffic': '교통',
                'manager.maintenance': '정비',
                'manager.weather': '날씨',
                'manager.course.operations': '코스 운영',
                'manager.managing': '파타야 골프 클럽 관리',
                'manager.monthly.revenue': '월별 매출',
                'manager.holes.active': '18홀 운영 중',
                'manager.staff.members': '직원 47명',
                'manager.satisfaction': '만족도 98%',
                'manager.todays.rounds': '오늘의 라운드',
                'manager.active.caddies': '활동 중인 캐디',
                'manager.course.occupancy': '코스 점유율',
                'manager.emergency.alerts': '응급 알림',
                'manager.current.rounds': '현재 라운드',
                'manager.staff.status': '직원 상태',
                'manager.nodata': '데이터 없음',
                'manager.noassignments': '할당 없음',
                'manager.nobookings': '예약 없음',
                'manager.allclear': '모두 정상',

                // Caddy Dashboard
                'caddie.title': '캐디 대시보드',
                'caddie.welcome': '환영합니다, 캐디님!',
                'caddie.overview': '개요',
                'caddie.assignments': '내 배정',
                'caddie.tracking': '실시간 추적',
                'caddie.reports': '보고서',
                'caddie.earnings': '수입',
                'caddie.monthly.earnings': '월별 수입',
                'caddie.elite.status': '엘리트 상태',
                'caddie.current.round': '현재 라운드',
                'caddie.performance': '성과',
                'caddie.currentstatus': '현재 상태',
                'caddie.available': '예약 가능',
                'caddie.readyforbookings': '예약 준비 완료',
                'caddie.nocurrentbookings': '현재 예약 없음',
                'caddie.checkschedule': '예정된 배정 일정 확인',
                'caddie.waitlist': '대기 목록',
                'caddie.people': '명',
                'caddie.nogolfers': '대기 중인 골퍼 없음',
                'caddie.newrequests': '새 요청이 여기에 표시됩니다',
                'caddie.liveroundtracking': '실시간 라운드 추적',
                'caddie.starttracking': '골퍼와 첫 번째 홀에 도착하면 추적 시작',
                'caddie.startroundtracking': '라운드 추적 시작',
                'caddie.roundinprogress': '라운드 진행 중',
                'caddie.currenthole': '현재 홀',
                'caddie.roundtime': '라운드 시간',
                'caddie.gpsstatus': 'GPS 상태',
                'caddie.finishround': '라운드 종료',
                'caddie.roundcompleted': '라운드 완료!',
                'caddie.totaltime': '총 시간',
                'caddie.holescompleted': '완료된 홀',
                'caddie.startnewround': '새 라운드 시작',
                'caddie.todaysassignment': '오늘의 배정',
                'caddie.currentlocation': '현재 위치',
                'caddie.livetrackingactive': '실시간 추적 활성',
                'caddie.nextassignment': '다음 배정',
                'caddie.todaysearnings': '오늘의 수입',
                'caddie.roundscompleted': '완료된 라운드',
                'caddie.currentroundstatus': '현재 라운드 상태',
                'caddie.noactiveround': '활성 라운드 없음',
                'caddie.starttrackingbegin': '라운드를 시작할 때 추적 시작',
                'caddie.performancemetrics': '성과 지표',
                'caddie.averageroundtime': '평균 라운드 시간',
                'caddie.clientsatisfaction': '고객 만족도',
                'caddie.roundsthisweek': '이번 주 라운드',
                'caddie.weeklyearnings': '주간 수입',
                'caddie.todaysassignments': '오늘의 배정',
                'caddie.noassignmentsyet': '아직 배정 없음',
                'caddie.newbookingrequests': '새 예약 요청이 여기에 표시됩니다',
                'caddie.assignmentsummary': '배정 요약',
                'caddie.todaytotal': '오늘 총',
                'caddie.scheduled': '예정됨',
                'caddie.projectedearnings': '예상 수입',
                'caddie.weekahead': '다음 주',
                'caddie.noupcomingassignments': '예정된 배정 없음',
                'caddie.livecoursetracking': '실시간 코스 추적',
                'caddie.interactivecourse': '실시간 위치가 포함된 대화형 코스 지도',

                // Pro Shop
                'proshop.title': '프로샵 대시보드',
                'proshop.welcome': '환영합니다, 프로샵!',
                'proshop.pos': 'POS 시스템',
                'proshop.inventory': '재고',
                'proshop.sales': '판매 보고서',
                'proshop.customers': '고객',
                'proshop.pos.title': '프로샵 POS',
                'proshop.equipment': '골프 장비 및 상품',
                'proshop.items': '450+ 상품',
                'proshop.sales.today': '오늘 28건 판매',
                'proshop.service': '4.9★ 서비스',
                'proshop.todays.sales': '오늘의 판매',
                'proshop.search.products': '상품 검색...',
                'proshop.all.categories': '모든 카테고리',
                'proshop.golf.clubs': '골프 클럽',
                'proshop.golf.balls': '골프공',
                'proshop.apparel': '의류',
                'proshop.accessories': '액세서리',
                'proshop.beverages': '음료',
                'proshop.snacks': '스낵',
                'proshop.shopping.cart': '장바구니',
                'proshop.cart.empty': '장바구니가 비어 있습니다',
                'proshop.add.products': '판매를 시작하려면 상품을 추가하세요',
                'proshop.subtotal': '소계:',
                'proshop.tax': '세금 (7%):',
                'proshop.total': '총계:',
                'proshop.cash.payment': '현금 결제',
                'proshop.card.payment': '카드 결제',
                'proshop.payment.successful': '결제 성공!',
                'proshop.print.receipt': '영수증 인쇄',
                'proshop.new.sale': '새 판매',

                // Golfer Dashboard
                'golfer.title': '골퍼 대시보드',
                'golfer.welcome': '환영합니다',
                'golfer.overview': '개요',
                'golfer.booking': '예약',
                'golfer.food': '음식 및 음료',
                'golfer.gps': 'GPS 및 내비게이션',
                'golfer.emergency': '응급상황',
                'golfer.profile': '프로필',
                'golfer.chat': '채팅',
                'golfer.schedule': '일정',
                'golfer.orderstatus': '주문 상태',
                'golfer.statistics': '통계',
                'golfer.roundhistory': '라운드 기록',
                'golfer.societyevents': '소사이어티 이벤트',
                'golfer.livescorecard': '라이브 스코어카드',
                'golfer.teetime': '티타임',
                'golfer.teetime.desc': '다음 라운드 예약',
                'golfer.teetime.available': '지금 예약 가능',
                'golfer.caddy': '캐디',
                'golfer.caddy.desc': '캐디 요청',
                'golfer.caddy.booknow': '지금 예약',
                'golfer.food.title': '음식',
                'golfer.food.desc': '코스 식사 및 음료',
                'golfer.food.open': '주방 운영 중',
                'golfer.schedule.desc': '일정 확인',
                'golfer.schedule.planahead': '미리 계획하기',
                'golfer.orders': '주문',
                'golfer.orders.desc': '주문 추적',
                'golfer.orders.viewstatus': '상태 보기',
                'golfer.stats': '통계',
                'golfer.stats.desc': '성과 추적',
                'golfer.stats.rounds': '47 라운드',
                'golfer.gps.desc': '코스 내비게이션',
                'golfer.gps.livetracking': '실시간 추적',
                'golfer.history': '기록',
                'golfer.history.desc': '라운드 기록',
                'golfer.history.viewpast': '과거 기록 보기',
                'golfer.featured.caddies': '추천 캐디',
                'golfer.featured.desc': '최고 평점 캐디를 찾고 새로운 골프장을 탐험하세요',
                'golfer.refresh': '새로고침',
                'golfer.today.teetime': '오늘의 티타임',
                'golfer.no.teetime': '오늘 예약된 티타임 없음',
                'golfer.book.prompt': '다음 라운드를 예약하면 여기에 표시됩니다',
                'golfer.book.teetime': '티타임 예약',
                'golfer.live.status': '실시간 코스 상태',
                'golfer.current.hole': '현재 홀',
                'golfer.not.playing': '플레이 중이 아님',
                'golfer.yards.topin': '핀까지 거리',
                'golfer.temperature': '온도',
                'golfer.wind': '바람',
                'golfer.conditions': '기상 상태',
                'golfer.performance': '성과 개요',
                'golfer.viewdetails': '자세히 보기',
                'golfer.bestscore': '최고 스코어',
                'golfer.avgscore': '평균 스코어',
                'golfer.roundsplayed': '플레이한 라운드',
                'golfer.eagles': '이글',
                'golfer.norounds': '아직 라운드 없음',
                'golfer.thisyear': '올해',
                'golfer.thismonth': '이번 달',
                'golfer.book.title': '티타임 예약',
                'golfer.search.course': '골프장 검색 및 선택',
                'golfer.search.placeholder': '코스 검색 (예: Pattana, Championship, Executive...)',
                'golfer.sunny': '맑음',
                'golfer.selectdate': '날짜 선택',
                'golfer.preferredtime': '선호 시간',
                'golfer.choosetime': '시간 선택...',
                'golfer.numplayers': '플레이어 수',
                'golfer.player': '플레이어',
                'golfer.players': '플레이어',
                'golfer.selectcaddy': '프로 캐디 선택',
                'golfer.available': '예약 가능',
                'golfer.onwaitlist': '대기 중',
                'golfer.searchcaddy': '캐디 이름, 번호 또는 전문 분야로 검색...',
                'golfer.bookingdetails': '예약 세부 정보',
                'golfer.confirmbooking': '예약 확인',
                'golfer.mybookings': '내 예약',
                'golfer.upcoming': '예정된',
                'golfer.past': '과거',
                'golfer.cancel': '취소',
                'golfer.modify': '수정',
                'golfer.food.menu': '코스 레스토랑 메뉴',
                'golfer.food.order': '주문하기',
                'golfer.food.categories': '카테고리',
                'golfer.food.beverages': '음료',
                'golfer.food.meals': '식사',
                'golfer.food.snacks': '스낵',
                'golfer.food.addtocart': '장바구니에 추가',
                'golfer.food.cart': '장바구니',
                'golfer.food.checkout': '결제',
                'golfer.schedule.events': '예정된 이벤트',
                'golfer.schedule.view': '일정 보기',
                'golfer.schedule.today': '오늘',
                'golfer.schedule.week': '이번 주',
                'golfer.schedule.month': '이번 달',
                'golfer.stats.handicap': '핸디캡 인덱스',
                'golfer.stats.avgputts': '평균 퍼트',
                'golfer.stats.fairways': '페어웨이 적중',
                'golfer.stats.greens': '그린 적중률',
                'golfer.stats.birdies': '버디',
                'golfer.stats.pars': '파',
                'golfer.stats.bogeys': '보기',
                'golfer.gps.currentlocation': '현재 위치',
                'golfer.gps.distancetohole': '홀까지 거리',
                'golfer.gps.distancetogreen': '그린까지 거리',
                'golfer.gps.hazards': '해저드',
                'golfer.history.filter': '기록 필터',
                'golfer.history.allcourses': '모든 코스',
                'golfer.history.date': '날짜',
                'golfer.history.course': '코스',
                'golfer.stats.experience': '경험',
                'golfer.stats.homeclub': '홈 클럽',
                'golfer.stats.society': '소사이어티',
                'golfer.stats.membersince': '가입일',
                'golfer.stats.achievements': '업적',
                'golfer.stats.eagleachievement': '이글 업적',
                'golfer.stats.handicapimprovement': '핸디캡 개선',
                'golfer.stats.newplayer': '신규 플레이어',
                'golfer.gps.navigation': '코스 내비게이션',
                'golfer.gps.updatelocation': '위치 업데이트',
                'golfer.gps.satellite': '위성',
                'golfer.gps.centeronme': '내 위치로 중앙',
                'golfer.gps.accuracy': 'GPS 정확도',
                'golfer.gps.holepar': '홀 파',
                'golfer.gps.yardstotal': '총 야드',
                'golfer.gps.distanceinfo': '거리 정보',
                'golfer.gps.tofront': '앞쪽까지',
                'golfer.gps.topin': '핀까지',
                'golfer.gps.toback': '뒤쪽까지',
                'golfer.gps.conditions': '코스 상태',
                'golfer.gps.measuredistance': '거리 측정',
                'golfer.gps.findcart': '카트 찾기',
                'golfer.gps.callmarshal': '마샬 호출',
                'golfer.gps.paceofplay': '플레이 속도',
                'golfer.gps.ontime': '정시',
                'golfer.gps.elapsed': '경과',
                'golfer.history.title': '라운드 기록',
                'golfer.history.addround': '라운드 추가',
                'golfer.history.totalrounds': '총 라운드',
                'golfer.history.avgscoreLabel': '평균 스코어',
                'golfer.history.currenthandicap': '현재 핸디캡',
                'golfer.history.bestround': '최고 라운드',
                'golfer.history.courselabel': '코스',
                'golfer.history.year': '연도',
                'golfer.history.tees': '티',
                'golfer.history.alltees': '모든 티',

                // Live Scorecard
                'scorecard.course': '코스',
                'scorecard.select.course': '-- 코스 선택 --',
                'scorecard.teemarkers': '티 마커',
                'scorecard.red': '레드',
                'scorecard.white': '화이트',
                'scorecard.yellow': '옐로우',
                'scorecard.blue': '블루',
                'scorecard.black': '블랙',
                'scorecard.scoring.formats': '스코어링 형식 (하나 이상 선택)',
                'scorecard.select.all': '모두 선택 / 모두 선택 해제',
                'scorecard.course.data.note': '코스 데이터는 라운드 시작 시 로드됩니다',
                'scorecard.manage': '관리',
                'scorecard.players': '플레이어',
                'scorecard.addplayer': '플레이어 추가',
                'scorecard.playername': '플레이어 이름',
                'scorecard.handicap': '핸디캡',
                'scorecard.startround': '라운드 시작',
                'scorecard.hole': '홀',
                'scorecard.par': '파',
                'scorecard.yards': '야드',
                'scorecard.score': '스코어',
                'scorecard.points': '포인트',
                'scorecard.total': '합계',
                'scorecard.front9': '전반 9홀',
                'scorecard.back9': '후반 9홀',
                'scorecard.gross': '그로스',
                'scorecard.net': '네트',
                'scorecard.stableford': '태국 스테이블포드',
                'scorecard.strokeplay': '스트로크 플레이',
                'scorecard.matchplay': '매치 플레이',
                'scorecard.completeround': '라운드 완료',
                'scorecard.finalize': '스코어카드 확정',
                'scorecard.summary': '라운드 요약',
                'scorecard.export': 'LINE으로 내보내기',

                // Maintenance Dashboard
                'login.maintenance': '정비팀 로그인',
                'maintenance.title': '정비 대시보드',
                'maintenance.welcome': '환영합니다, 정비팀!',
                'maintenance.overview': '개요',
                'maintenance.course.updates': '코스 업데이트',
                'maintenance.tasks': '작업 관리',
                'maintenance.equipment': '장비',
                'maintenance.schedule': '일정',
                'maintenance.course.maintenance': '코스 관리',
                'maintenance.professional.care': '전문 골프 코스 관리',
                'maintenance.courses.active': '4개 코스 운영 중',
                'maintenance.tasks.today': '오늘 12개 작업',
                'maintenance.crew.members': '8명 작업팀',
                'maintenance.course.condition': '코스 상태',
                'maintenance.excellent.rating': '우수 등급',
                'maintenance.holes.maintained': '관리된 홀',
                'maintenance.water.usage': '물 사용량 (시간)',
                'maintenance.optimal.level': '최적 수준',
                'maintenance.equipment.issues': '장비 문제',
                'maintenance.needs.attention': '주의 필요',
                'maintenance.pending.tasks': '대기 중인 작업',
                'maintenance.due.today': '오늘 마감',
                'maintenance.live.updates': '실시간 코스 업데이트',
                'maintenance.report.conditions': '사진과 상세 설명으로 코스 상태 보고',
                'maintenance.submit.update': '코스 업데이트 제출',
                'maintenance.course.section': '코스 섹션',
                'maintenance.select.section': '코스 섹션을 선택하세요...',
                'maintenance.hole.number': '홀 번호',
                'maintenance.select.hole': '홀 번호를 선택하세요...',
                'maintenance.area.type': '지역 유형',
                'maintenance.select.area': '지역 유형을 선택하세요...',
                'maintenance.tee.box': '티 박스',
                'maintenance.fairway': '페어웨이',
                'maintenance.rough': '러프',
                'maintenance.fairway.bunker': '페어웨이 벙커',
                'maintenance.greenside.bunker': '그린사이드 벙커',
                'maintenance.green': '그린',
                'maintenance.flag.cup': '깃대와 컵',
                'maintenance.issue.priority': '문제 우선순위',
                'maintenance.low.routine': '낮음 - 일상 관리',
                'maintenance.medium.attention': '보통 - 주의 필요',
                'maintenance.high.urgent': '높음 - 긴급 수리',
                'maintenance.critical.safety': '위험 - 안전 문제',
                'maintenance.description': '설명',
                'maintenance.describe.issue': '문제나 상태를 자세히 설명하세요...',
                'maintenance.upload.photos': '사진 업로드',
                'maintenance.click.upload': '클릭하여 사진을 업로드하거나 드래그하여 놓으세요',
                'maintenance.choose.photos': '사진 선택',
                'maintenance.submit.course.update': '코스 업데이트 제출',
                'maintenance.recent.updates': '최근 업데이트',
                'maintenance.all.courses': '모든 코스',

                // Emergency & Safety
                'emergency.alert': '응급 알림',
                'emergency.select.type': '필요한 지원 유형을 선택하세요',
                'emergency.safety.info': '안전 정보',
                'emergency.course.safety': '코스 안전 정보',
                'emergency.alert.sent': '알림 전송 완료',

                // Profile Creation
                'profile.create': '프로필 만들기',
                'profile.choose.role': '역할을 선택하고 정보를 입력하세요',
                'profile.golfer.info': '골퍼 정보',
                'profile.caddie.info': '캐디 정보',
                'profile.manager.info': '매니저 정보',
                'profile.proshop.info': '프로샵 정보',
                'profile.maintenance.info': '정비팀 정보',
                'profile.handicap': '핸디캡',
                'profile.experience.level': '경험 수준',
                'profile.select.level': '레벨 선택...',
                'profile.beginner': '초급',
                'profile.intermediate': '중급',
                'profile.advanced': '고급',
                'profile.professional': '프로',
                'profile.club.affiliation': '클럽 소속',
                'profile.select.society': '모임 선택...',
                'profile.playing.style': '플레이 스타일',
                'profile.years.experience': '경험 년수',
                'profile.specialty': '전문 분야',
                'profile.select.specialty': '전문 분야 선택...',
                'profile.championship.course': '챔피언십 코스',
                'profile.beginner.support': '초급자 지원',
                'profile.tournament.play': '토너먼트 플레이',
                'profile.vip.service': 'VIP 서비스',
                'profile.international.service': '국제 서비스',
                'profile.languages': '언어 (다중 선택)',
                'profile.preferred.avatar': '선호하는 아바타',
                'profile.avatar.man': '남성',
                'profile.avatar.woman': '여성',
                'profile.avatar.bald.man': '대머리 남성',
                'profile.avatar.bald.woman': '대머리 여성',
                'profile.avatar.curly.man': '곱슬머리 남성',
                'profile.avatar.curly.woman': '곱슬머리 여성',
                'profile.avatar.white.man': '백발 남성',
                'profile.avatar.white.woman': '백발 여성',
                'profile.years.management': '관리 경력',
                'profile.golf.professional': '골프 프로',

                // Common Form Elements
                'form.email': '이메일',
                'form.phone': '전화번호',
                'form.first.name': '이름',
                'form.last.name': '성',
                'form.create.profile': '프로필 생성',
                'form.submit': '제출',

                // Page Titles
                'page.title': 'MciPro - 전문 골프장 관리 플랫폼',
            },

            ja: {
                // Login Screen
                'app.title': 'MciPro',
                'app.subtitle': 'プロゴルフ場管理プラットフォーム',
                'login.golfer': 'ゴルファーログイン',
                'login.caddie': 'キャディログイン',
                'login.manager': 'マネージャーログイン',
                'login.proshop': 'プロショップログイン',

                // Navigation & Common
                'nav.logout': 'ログアウト',
                'nav.emergency': '緊急警報',
                'common.back': '戻る',
                'common.next': '次へ',
                'common.save': '保存',
                'common.cancel': 'キャンセル',
                'common.close': '閉じる',
                'common.loading': '読み込み中...',
                'common.settings': '設定',
                'common.chat': 'チャット',
                'common.logout': 'ログアウト',
                'common.edit': '編集',
                'common.delete': '削除',
                'common.view': '表示',
                'common.add': '追加',
                'common.remove': '削除',
                'common.update': '更新',
                'common.submit': '送信',
                'common.confirm': '確認',
                'common.active': 'アクティブ',
                'common.inactive': '非アクティブ',
                'common.pending': '保留中',
                'common.completed': '完了',
                'common.error': 'エラー',
                'common.success': '成功',
                'common.date': '日付',
                'common.time': '時刻',
                'common.name': '名前',
                'common.description': '説明',
                'common.status': 'ステータス',
                'common.actions': 'アクション',
                'common.refresh': '更新',
                'common.select': '選択',
                'common.all': 'すべて',
                'common.none': 'なし',
                'common.yes': 'はい',
                'common.no': 'いいえ',
                'common.upload': 'アップロード',
                'common.capture': '撮影',
                'common.photo': '写真',
                'common.image': '画像',

                // Scorecard Modals
                'modal.scan.title': 'スコアカードをスキャン',
                'modal.scan.course': 'コースプロファイルを選択（精度向上のため）',
                'modal.scan.generic': '一般（すべてのコース）',
                'modal.scan.help': '最適化されたOCRのためにコースを選択してください。リストにない場合は「一般」を選択してください。',
                'modal.scan.capture': '写真を撮る',
                'modal.scan.upload': '画像をアップロード',
                'modal.addplayer.title': 'プレイヤーを追加',
                'modal.addplayer.search': 'プレイヤーを検索...',
                'modal.addplayer.add': 'プレイヤーを追加',
                'modal.joingames.title': 'アクティブなゲームに参加',
                'modal.joingames.available': '利用可能なゲーム',
                'modal.joingames.join': 'ゲームに参加',
                'modal.finalized.title': 'ラウンド完了',
                'modal.finalized.congrats': 'おめでとうございます！',
                'modal.finalized.score': '最終スコア',
                'modal.finalized.share': '結果を共有',
                'modal.export.title': 'LINEにエクスポート',
                'modal.export.sharing': 'スコアカードを共有',

                // Manager Dashboard
                'manager.title': 'マネージャーダッシュボード',
                'manager.welcome': 'おかえりなさい、マネージャー！',
                'manager.overview': '概要',
                'manager.staff': 'スタッフ管理',
                'manager.analytics': '分析',
                'manager.reports': 'レポート',
                'manager.traffic': '交通',
                'manager.maintenance': 'メンテナンス',
                'manager.weather': '天気',
                'manager.course.operations': 'コース運営',
                'manager.managing': 'パタヤゴルフクラブ管理',
                'manager.monthly.revenue': '月次収入',
                'manager.holes.active': '18ホール稼働',
                'manager.staff.members': '47名のスタッフ',
                'manager.satisfaction': '98%満足度',
                'manager.todays.rounds': '本日のラウンド',
                'manager.active.caddies': 'アクティブキャディ',
                'manager.course.occupancy': 'コース利用率',
                'manager.emergency.alerts': '緊急アラート',
                'manager.current.rounds': '現在のラウンド',
                'manager.staff.status': 'スタッフステータス',
                'manager.nodata': 'データなし',
                'manager.noassignments': '割り当てなし',
                'manager.nobookings': '予約なし',
                'manager.allclear': '問題なし',

                // Caddy Dashboard
                'caddie.title': 'キャディダッシュボード',
                'caddie.welcome': 'おかえりなさい、キャディ！',
                'caddie.overview': '概要',
                'caddie.assignments': '私の割り当て',
                'caddie.tracking': 'ライブ追跡',
                'caddie.reports': 'レポート',
                'caddie.earnings': '収入',
                'caddie.monthly.earnings': '月次収入',
                'caddie.elite.status': 'エリートステータス',
                'caddie.current.round': '現在のラウンド',
                'caddie.performance': 'パフォーマンス',
                'caddie.currentstatus': '現在のステータス',
                'caddie.available': '予約可能',
                'caddie.readyforbookings': '予約受付準備完了',
                'caddie.nocurrentbookings': '現在の予約なし',
                'caddie.checkschedule': '今後の割り当てスケジュールを確認',
                'caddie.waitlist': '待機リスト',
                'caddie.people': '人',
                'caddie.nogolfers': '待機中のゴルファーなし',
                'caddie.newrequests': '新しいリクエストがここに表示されます',
                'caddie.liveroundtracking': 'ライブラウンド追跡',
                'caddie.starttracking': 'ゴルファーと最初のホールに到着したら追跡を開始',
                'caddie.startroundtracking': 'ラウンド追跡開始',
                'caddie.roundinprogress': 'ラウンド進行中',
                'caddie.currenthole': '現在のホール',
                'caddie.roundtime': 'ラウンド時間',
                'caddie.gpsstatus': 'GPSステータス',
                'caddie.finishround': 'ラウンド終了',
                'caddie.roundcompleted': 'ラウンド完了！',
                'caddie.totaltime': '合計時間',
                'caddie.holescompleted': '完了したホール',
                'caddie.startnewround': '新しいラウンドを開始',
                'caddie.todaysassignment': '本日の割り当て',
                'caddie.currentlocation': '現在地',
                'caddie.livetrackingactive': 'ライブ追跡アクティブ',
                'caddie.nextassignment': '次の割り当て',
                'caddie.todaysearnings': '本日の収入',
                'caddie.roundscompleted': '完了したラウンド',
                'caddie.currentroundstatus': '現在のラウンド状態',
                'caddie.noactiveround': 'アクティブなラウンドなし',
                'caddie.starttrackingbegin': 'ラウンドを開始したら追跡を開始',
                'caddie.performancemetrics': 'パフォーマンス指標',
                'caddie.averageroundtime': '平均ラウンド時間',
                'caddie.clientsatisfaction': '顧客満足度',
                'caddie.roundsthisweek': '今週のラウンド',
                'caddie.weeklyearnings': '週次収入',
                'caddie.todaysassignments': '本日の割り当て',
                'caddie.noassignmentsyet': 'まだ割り当てなし',
                'caddie.newbookingrequests': '新しい予約リクエストがここに表示されます',
                'caddie.assignmentsummary': '割り当て概要',
                'caddie.todaytotal': '本日の合計',
                'caddie.scheduled': 'スケジュール済み',
                'caddie.projectedearnings': '予想収入',
                'caddie.weekahead': '来週',
                'caddie.noupcomingassignments': '今後の割り当てなし',
                'caddie.livecoursetracking': 'ライブコース追跡',
                'caddie.interactivecourse': 'リアルタイム位置情報付きインタラクティブコースマップ',

                // Pro Shop
                'proshop.title': 'プロショップダッシュボード',
                'proshop.welcome': 'おかえりなさい、プロショップ！',
                'proshop.pos': 'POS',
                'proshop.inventory': '在庫',
                'proshop.sales': '売上レポート',
                'proshop.customers': '顧客',
                'proshop.pos.title': 'プロショップPOS',
                'proshop.equipment': 'ゴルフ用品・商品',
                'proshop.items': '450+アイテム',
                'proshop.sales.today': '本日28件の売上',
                'proshop.service': '4.9★サービス',
                'proshop.todays.sales': '本日の売上',
                'proshop.search.products': '商品を検索...',
                'proshop.all.categories': 'すべてのカテゴリ',
                'proshop.golf.clubs': 'ゴルフクラブ',
                'proshop.golf.balls': 'ゴルフボール',
                'proshop.apparel': 'アパレル',
                'proshop.accessories': 'アクセサリー',
                'proshop.beverages': '飲み物',
                'proshop.snacks': 'スナック',
                'proshop.shopping.cart': 'ショッピングカート',
                'proshop.cart.empty': 'カートは空です',
                'proshop.add.products': '商品を追加して販売開始',
                'proshop.subtotal': '小計：',
                'proshop.tax': '税金(7%)：',
                'proshop.total': '合計：',
                'proshop.cash.payment': '現金払い',
                'proshop.card.payment': 'カード払い',
                'proshop.payment.successful': '支払い完了！',
                'proshop.print.receipt': 'レシート印刷',
                'proshop.new.sale': '新しい販売',

                // Golfer Dashboard
                'golfer.title': 'ゴルファーダッシュボード',
                'golfer.welcome': 'おかえりなさい',
                'golfer.overview': '概要',
                'golfer.booking': '予約',
                'golfer.food': '食べ物・飲み物',
                'golfer.gps': 'GPS・ナビゲーション',
                'golfer.emergency': '緊急',
                'golfer.profile': 'プロフィール',
                'golfer.chat': 'チャット',
                'golfer.schedule': 'スケジュール',
                'golfer.orderstatus': '注文状況',
                'golfer.statistics': '統計',
                'golfer.roundhistory': 'ラウンド履歴',
                'golfer.societyevents': 'ソサエティイベント',
                'golfer.livescorecard': 'ライブスコアカード',
                'golfer.teetime': 'ティータイム',
                'golfer.teetime.desc': '次のラウンドを予約',
                'golfer.teetime.available': '予約可能',
                'golfer.caddy': 'キャディ',
                'golfer.caddy.desc': 'キャディをリクエスト',
                'golfer.caddy.booknow': '今すぐ予約',
                'golfer.food.title': '食べ物',
                'golfer.food.desc': 'コース内の食事・飲み物',
                'golfer.food.open': 'キッチン営業中',
                'golfer.schedule.desc': 'カレンダーを見る',
                'golfer.schedule.planahead': '計画を立てる',
                'golfer.orders': '注文',
                'golfer.orders.desc': '注文を追跡',
                'golfer.orders.viewstatus': 'ステータス表示',
                'golfer.stats': '統計',
                'golfer.stats.desc': 'パフォーマンス追跡',
                'golfer.stats.rounds': '47ラウンド',
                'golfer.gps.desc': 'コースナビゲーション',
                'golfer.gps.livetracking': 'ライブ追跡',
                'golfer.history': '履歴',
                'golfer.history.desc': 'ラウンド履歴',
                'golfer.history.viewpast': '過去を見る',
                'golfer.featured.caddies': 'おすすめキャディ',
                'golfer.featured.desc': '高評価のキャディを見つけて新しいゴルフコースを探索',
                'golfer.refresh': '更新',
                'golfer.today.teetime': '今日のティータイム',
                'golfer.no.teetime': '今日のティータイム予約なし',
                'golfer.book.prompt': '次のラウンドを予約するとここに表示されます',
                'golfer.book.teetime': 'ティータイムを予約',
                'golfer.live.status': 'ライブコース状況',
                'golfer.current.hole': '現在のホール',
                'golfer.not.playing': 'プレー中ではありません',
                'golfer.yards.topin': 'ピンまでの距離',
                'golfer.temperature': '気温',
                'golfer.wind': '風',
                'golfer.conditions': '天候',
                'golfer.performance': 'パフォーマンス概要',
                'golfer.viewdetails': '詳細を見る',
                'golfer.bestscore': 'ベストスコア',
                'golfer.avgscore': '平均スコア',
                'golfer.roundsplayed': 'プレーラウンド',
                'golfer.eagles': 'イーグル',
                'golfer.norounds': 'まだラウンドなし',
                'golfer.thisyear': '今年',
                'golfer.thismonth': '今月',
                'golfer.book.title': 'ティータイムを予約',
                'golfer.search.course': 'ゴルフコース検索・選択',
                'golfer.search.placeholder': 'コース検索（例：Pattana、Championship、Executive...）',
                'golfer.sunny': '晴れ',
                'golfer.selectdate': '日付を選択',
                'golfer.preferredtime': '希望時間',
                'golfer.choosetime': '時間を選択...',
                'golfer.numplayers': 'プレーヤー数',
                'golfer.player': 'プレーヤー',
                'golfer.players': 'プレーヤー',
                'golfer.selectcaddy': 'プロキャディを選択',
                'golfer.available': '予約可能',
                'golfer.onwaitlist': 'キャンセル待ち',
                'golfer.searchcaddy': 'キャディ名、番号、専門分野で検索...',
                'golfer.bookingdetails': '予約詳細',
                'golfer.confirmbooking': '予約確認',
                'golfer.mybookings': 'マイ予約',
                'golfer.upcoming': '今後の予定',
                'golfer.past': '過去',
                'golfer.cancel': 'キャンセル',
                'golfer.modify': '変更',
                'golfer.food.menu': 'コース内レストランメニュー',
                'golfer.food.order': '注文する',
                'golfer.food.categories': 'カテゴリ',
                'golfer.food.beverages': '飲み物',
                'golfer.food.meals': '食事',
                'golfer.food.snacks': 'スナック',
                'golfer.food.addtocart': 'カートに追加',
                'golfer.food.cart': 'カート',
                'golfer.food.checkout': 'チェックアウト',
                'golfer.schedule.events': '予定されたイベント',
                'golfer.schedule.view': 'スケジュール表示',
                'golfer.schedule.today': '今日',
                'golfer.schedule.week': '今週',
                'golfer.schedule.month': '今月',
                'golfer.stats.handicap': 'ハンディキャップ指数',
                'golfer.stats.avgputts': '平均パット',
                'golfer.stats.fairways': 'フェアウェイキープ',
                'golfer.stats.greens': 'パーオン率',
                'golfer.stats.birdies': 'バーディ',
                'golfer.stats.pars': 'パー',
                'golfer.stats.bogeys': 'ボギー',
                'golfer.gps.currentlocation': '現在地',
                'golfer.gps.distancetohole': 'ホールまでの距離',
                'golfer.gps.distancetogreen': 'グリーンまでの距離',
                'golfer.gps.hazards': 'ハザード',
                'golfer.history.filter': '履歴フィルター',
                'golfer.history.allcourses': 'すべてのコース',
                'golfer.history.date': '日付',
                'golfer.history.course': 'コース',
                'golfer.stats.experience': '経験',
                'golfer.stats.homeclub': 'ホームクラブ',
                'golfer.stats.society': 'ソサエティ',
                'golfer.stats.membersince': '会員歴',
                'golfer.stats.achievements': '実績',
                'golfer.stats.eagleachievement': 'イーグル実績',
                'golfer.stats.handicapimprovement': 'ハンディキャップ改善',
                'golfer.stats.newplayer': '新規プレーヤー',
                'golfer.gps.navigation': 'コースナビゲーション',
                'golfer.gps.updatelocation': '位置更新',
                'golfer.gps.satellite': '衛星',
                'golfer.gps.centeronme': '自分の位置に中心',
                'golfer.gps.accuracy': 'GPS精度',
                'golfer.gps.holepar': 'ホールパー',
                'golfer.gps.yardstotal': '総ヤード',
                'golfer.gps.distanceinfo': '距離情報',
                'golfer.gps.tofront': 'フロントまで',
                'golfer.gps.topin': 'ピンまで',
                'golfer.gps.toback': 'バックまで',
                'golfer.gps.conditions': 'コース状態',
                'golfer.gps.measuredistance': '距離測定',
                'golfer.gps.findcart': 'カート検索',
                'golfer.gps.callmarshal': 'マーシャル呼出',
                'golfer.gps.paceofplay': 'プレーペース',
                'golfer.gps.ontime': '時間通り',
                'golfer.gps.elapsed': '経過',
                'golfer.history.title': 'ラウンド履歴',
                'golfer.history.addround': 'ラウンド追加',
                'golfer.history.totalrounds': '総ラウンド',
                'golfer.history.avgscoreLabel': '平均スコア',
                'golfer.history.currenthandicap': '現在のハンディキャップ',
                'golfer.history.bestround': 'ベストラウンド',
                'golfer.history.courselabel': 'コース',
                'golfer.history.year': '年',
                'golfer.history.tees': 'ティー',
                'golfer.history.alltees': 'すべてのティー',

                // Live Scorecard
                'scorecard.course': 'コース',
                'scorecard.select.course': '-- コース選択 --',
                'scorecard.teemarkers': 'ティーマーカー',
                'scorecard.red': 'レッド',
                'scorecard.white': 'ホワイト',
                'scorecard.yellow': 'イエロー',
                'scorecard.blue': 'ブルー',
                'scorecard.black': 'ブラック',
                'scorecard.scoring.formats': 'スコアリング形式（1つ以上選択）',
                'scorecard.select.all': 'すべて選択 / すべて選択解除',
                'scorecard.course.data.note': 'コースデータはラウンド開始時に読み込まれます',
                'scorecard.manage': '管理',
                'scorecard.players': 'プレーヤー',
                'scorecard.addplayer': 'プレーヤー追加',
                'scorecard.playername': 'プレーヤー名',
                'scorecard.handicap': 'ハンディキャップ',
                'scorecard.startround': 'ラウンド開始',
                'scorecard.hole': 'ホール',
                'scorecard.par': 'パー',
                'scorecard.yards': 'ヤード',
                'scorecard.score': 'スコア',
                'scorecard.points': 'ポイント',
                'scorecard.total': '合計',
                'scorecard.front9': 'フロント9',
                'scorecard.back9': 'バック9',
                'scorecard.gross': 'グロス',
                'scorecard.net': 'ネット',
                'scorecard.stableford': 'タイスタブルフォード',
                'scorecard.strokeplay': 'ストロークプレー',
                'scorecard.matchplay': 'マッチプレー',
                'scorecard.completeround': 'ラウンド完了',
                'scorecard.finalize': 'スコアカード確定',
                'scorecard.summary': 'ラウンド概要',
                'scorecard.export': 'LINEにエクスポート',

                // Maintenance Dashboard
                'login.maintenance': 'メンテナンスチーム ログイン',
                'maintenance.title': 'メンテナンス ダッシュボード',
                'maintenance.welcome': 'おかえりなさい、メンテナンスチーム！',
                'maintenance.overview': '概要',
                'maintenance.course.updates': 'コース更新',
                'maintenance.tasks': 'タスク管理',
                'maintenance.equipment': '機材',
                'maintenance.schedule': 'スケジュール',
                'maintenance.course.maintenance': 'コースメンテナンス',
                'maintenance.professional.care': 'プロフェッショナル ゴルフコース ケア',
                'maintenance.courses.active': '4コース稼働中',
                'maintenance.tasks.today': '本日12タスク',
                'maintenance.crew.members': '8名のクルー',
                'maintenance.course.condition': 'コース状態',
                'maintenance.excellent.rating': '優秀な評価',
                'maintenance.holes.maintained': '整備済みホール',
                'maintenance.water.usage': '水使用量（時間）',
                'maintenance.optimal.level': '最適レベル',
                'maintenance.equipment.issues': '機材問題',
                'maintenance.needs.attention': '注意が必要',
                'maintenance.pending.tasks': '保留中のタスク',
                'maintenance.due.today': '本日期限',
                'maintenance.live.updates': 'ライブ コース更新',
                'maintenance.report.conditions': '写真と詳細説明でコース状態を報告',
                'maintenance.submit.update': 'コース更新を送信',
                'maintenance.course.section': 'コースセクション',
                'maintenance.select.section': 'コースセクションを選択...',
                'maintenance.hole.number': 'ホール番号',
                'maintenance.select.hole': 'ホール番号を選択...',
                'maintenance.area.type': 'エリアタイプ',
                'maintenance.select.area': 'エリアタイプを選択...',
                'maintenance.tee.box': 'ティーボックス',
                'maintenance.fairway': 'フェアウェイ',
                'maintenance.rough': 'ラフ',
                'maintenance.fairway.bunker': 'フェアウェイバンカー',
                'maintenance.greenside.bunker': 'グリーンサイドバンカー',
                'maintenance.green': 'グリーン',
                'maintenance.flag.cup': 'フラッグとカップ',
                'maintenance.issue.priority': '問題優先度',
                'maintenance.low.routine': '低 - 定期メンテナンス',
                'maintenance.medium.attention': '中 - 注意が必要',
                'maintenance.high.urgent': '高 - 緊急修理',
                'maintenance.critical.safety': '危険 - 安全上の問題',
                'maintenance.description': '説明',
                'maintenance.describe.issue': '問題や状態を詳しく説明してください...',
                'maintenance.upload.photos': '写真をアップロード',
                'maintenance.click.upload': 'クリックして写真をアップロードするか、ドラッグ&ドロップ',
                'maintenance.choose.photos': '写真を選択',
                'maintenance.submit.course.update': 'コース更新を送信',
                'maintenance.recent.updates': '最近の更新',
                'maintenance.all.courses': 'すべてのコース',

                // Emergency & Safety
                'emergency.alert': '緊急警報',
                'emergency.select.type': '必要な支援の種類を選択してください',
                'emergency.safety.info': '安全情報',
                'emergency.course.safety': 'コース安全情報',
                'emergency.alert.sent': 'アラート送信完了',

                // Profile Creation
                'profile.create': 'プロフィール作成',
                'profile.choose.role': '役割を選択し、情報を入力してください',
                'profile.golfer.info': 'ゴルファー情報',
                'profile.caddie.info': 'キャディ情報',
                'profile.manager.info': 'マネージャー情報',
                'profile.proshop.info': 'プロショップ情報',
                'profile.maintenance.info': 'メンテナンス情報',
                'profile.handicap': 'ハンディキャップ',
                'profile.experience.level': '経験レベル',
                'profile.select.level': 'レベルを選択...',
                'profile.beginner': '初級',
                'profile.intermediate': '中級',
                'profile.advanced': '上級',
                'profile.professional': 'プロ',
                'profile.club.affiliation': 'クラブ所属',
                'profile.select.society': '団体を選択...',
                'profile.playing.style': 'プレイスタイル',
                'profile.years.experience': '経験年数',
                'profile.specialty': '専門分野',
                'profile.select.specialty': '専門分野を選択...',
                'profile.championship.course': 'チャンピオンシップコース',
                'profile.beginner.support': '初心者サポート',
                'profile.tournament.play': 'トーナメントプレイ',
                'profile.vip.service': 'VIPサービス',
                'profile.international.service': '国際サービス',
                'profile.languages': '言語（複数選択可）',
                'profile.preferred.avatar': '希望アバター',
                'profile.avatar.man': '男性',
                'profile.avatar.woman': '女性',
                'profile.avatar.bald.man': 'はげ頭男性',
                'profile.avatar.bald.woman': 'はげ頭女性',
                'profile.avatar.curly.man': '巻き毛男性',
                'profile.avatar.curly.woman': '巻き毛女性',
                'profile.avatar.white.man': '白髪男性',
                'profile.avatar.white.woman': '白髪女性',
                'profile.years.management': '管理経験年数',
                'profile.golf.professional': 'ゴルフプロ',

                // Common Form Elements
                'form.email': 'メール',
                'form.phone': '電話番号',
                'form.first.name': '名',
                'form.last.name': '姓',
                'form.create.profile': 'プロフィール作成',
                'form.submit': '送信',

                // Page Titles
                'page.title': 'MciPro - プロゴルフ場管理プラットフォーム',
            }
        };

        // Translation function
        function t(key, lang = currentLanguage) {
            return translations[lang] && translations[lang][key] ? translations[lang][key] : key;
        }

        // Update all translatable elements
        function updateLanguage(lang) {
            currentLanguage = lang;

            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                element.textContent = t(key);
            });

            // Update all placeholders with data-i18n-placeholder attribute
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                element.placeholder = t(key);
            });

            // Auto-translate common hardcoded text elements
            autoTranslateCommonElements();

            // Update page title
            document.title = t('page.title');

            // Save language preference
            localStorage.setItem('mci-pro-language', lang);
        }

        // Auto-translate common hardcoded text patterns
        function autoTranslateCommonElements() {
            // Common text mappings for elements that haven't been manually tagged
            const textMappings = {
                'Emergency Alert': 'emergency.alert',
                'Select the type of assistance you need': 'emergency.select.type',
                'Safety Info': 'emergency.safety.info',
                'Course Safety Information': 'emergency.course.safety',
                'Alert Sent Successfully': 'emergency.alert.sent',
                'Create Your Profile': 'profile.create',
                'Choose your role and fill in your information': 'profile.choose.role',
                'Golfer Information': 'profile.golfer.info',
                'Caddy Information': 'profile.caddie.info',
                'Manager Information': 'profile.manager.info',
                'Pro Shop Information': 'profile.proshop.info',
                'Maintenance Information': 'profile.maintenance.info',
                'Handicap': 'profile.handicap',
                'Experience Level': 'profile.experience.level',
                'Select level...': 'profile.select.level',
                'Beginner': 'profile.beginner',
                'Intermediate': 'profile.intermediate',
                'Advanced': 'profile.advanced',
                'Professional': 'profile.professional',
                'Club Affiliation': 'profile.club.affiliation',
                'Select society...': 'profile.select.society',
                'Playing Style': 'profile.playing.style',
                'Years of Experience': 'profile.years.experience',
                'Specialty': 'profile.specialty',
                'Select specialty...': 'profile.select.specialty',
                'Championship Course': 'profile.championship.course',
                'Beginner Support': 'profile.beginner.support',
                'Tournament Play': 'profile.tournament.play',
                'VIP Service': 'profile.vip.service',
                'International Service': 'profile.international.service',
                'Languages (select multiple)': 'profile.languages',
                'Preferred Avatar': 'profile.preferred.avatar',
                'Man': 'profile.avatar.man',
                'Woman': 'profile.avatar.woman',
                'Bald Man': 'profile.avatar.bald.man',
                'Bald Woman': 'profile.avatar.bald.woman',
                'Curly Hair Man': 'profile.avatar.curly.man',
                'Curly Hair Woman': 'profile.avatar.curly.woman',
                'White Hair Man': 'profile.avatar.white.man',
                'White Hair Woman': 'profile.avatar.white.woman',
                'Years in Management': 'profile.years.management',
                'Golf Professional': 'profile.golf.professional',
                'Email': 'form.email',
                'Phone': 'form.phone',
                'First Name': 'form.first.name',
                'Last Name': 'form.last.name',
                'Create Profile': 'form.create.profile',
                'Submit': 'form.submit',
                'Cancel': 'common.cancel',
                'Close': 'common.close',
                'Back': 'common.back',
                'Next': 'common.next',
                'Save': 'common.save',
                'Loading...': 'common.loading',
                'Settings': 'common.settings',
                'Logout': 'nav.logout',
                'Overview': 'golfer.overview',
                'Booking': 'golfer.booking',
                'Food & Drinks': 'golfer.food',
                'GPS & Navigation': 'golfer.gps',
                'Emergency': 'golfer.emergency'
            };

            // Update text content based on exact matches
            Object.entries(textMappings).forEach(([englishText, translationKey]) => {
                const elements = Array.from(document.querySelectorAll('*')).filter(el => {
                    return el.childNodes.length === 1 &&
                           el.childNodes[0].nodeType === Node.TEXT_NODE &&
                           el.textContent.trim() === englishText &&
                           !el.hasAttribute('data-i18n');
                });

                elements.forEach(el => {
                    el.textContent = t(translationKey);
                    el.setAttribute('data-i18n', translationKey);
                });
            });

            // Update option elements specifically
            document.querySelectorAll('option').forEach(option => {
                const text = option.textContent.trim();
                if (textMappings[text] && !option.hasAttribute('data-i18n')) {
                    option.textContent = t(textMappings[text]);
                    option.setAttribute('data-i18n', textMappings[text]);
                }
            });
        }

        // Language selector function
        function changeLanguage(lang) {
            updateLanguage(lang);

            // Update active language button
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-lang') === lang) {
                    btn.classList.add('active');
                }
            });
        }

        // Initialize language on page load
        function initializeLanguage() {
            const savedLanguage = localStorage.getItem('mci-pro-language') || 'en';
            updateLanguage(savedLanguage);

            // Set active language button
            const activeBtn = document.querySelector(`[data-lang="${savedLanguage}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }

            // Set up observer for dynamic content
            setupDynamicContentObserver();
        }

        // Setup observer to auto-translate dynamically added content
        function setupDynamicContentObserver() {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        // Wait a bit for content to settle, then auto-translate
                        setTimeout(() => {
                            autoTranslateCommonElements();
                        }, 100);
                    }
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }

        // ============================================================
        // UNIQUE ID SYSTEM - Generate UUID for user identification
        // ============================================================
        const UserIDSystem = {
            // Generate a unique UUID v4
            generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            },

            // Get or create unique ID for a user
            // Priority: 1. lineUserId, 2. existing userId, 3. generate new UUID
            getUserUniqueID(user) {
                // LINE users - use their lineUserId
                if (user.lineUserId) {
                    return user.lineUserId;
                }

                // Check if user already has a userId stored
                if (user.userId) {
                    return user.userId;
                }

                // Generate new UUID and store it
                const newUUID = this.generateUUID();
                console.log('[UserIDSystem] Generated new UUID:', newUUID, 'for user:', user.name);
                return newUUID;
            },

            // Get profile key using unique ID
            getProfileKey(userType, uniqueId) {
                return `profile_${uniqueId}`;
            }
        };

        // Application State
        const AppState = {
            currentUser: {
                role: 'guest',
                name: 'Guest User',
                lineId: null,
                userId: null, // UNIQUE ID - lineUserId or UUID
                avatar: null,
                email: null,
                phone: null,
                handicap: null,
                membershipLevel: 'basic',
                joinDate: null,
                stats: {
                    totalRounds: 0,
                    averageScore: 0,
                    bestScore: 0,
                    totalEarnings: 0,
                    rating: 0
                },
                permissions: [],
                preferences: {
                    gpsTracking: true,
                    emergencyContacts: []
                }
            },

            navigation: {
                currentScreen: 'loginScreen',
                lastScreen: null,
                activeTab: '',
                breadcrumb: []
            },

            session: {
                loginTime: null,
                lastActivity: null,
                isAuthenticated: false,
                authMethod: null // 'line', 'otp', 'fallback'
            },

        };

        // LINE LIFF Configuration
        const LineConfig = {
            liffId: '2008228481-xBBwXqp1',
            channelId: '2008228481',
            fallbackEnabled: false, // Disable fallback - require LINE authentication
            debugMode: true,
            // Admin LINE User IDs (can manage all profiles)
            adminUserIds: [
                // Add your LINE User ID here after first login
                // Example: 'U1234567890abcdef1234567890abcdef'
            ]
        };

        // ===== CORE SYSTEM FUNCTIONS =====

        // Helper functions for sync operations
        function toArray(x) {
            if (Array.isArray(x)) return x;
            if (x?.items) return x.items;                      // support {items:[...]}
            if (x && typeof x === 'object') return Object.values(x); // legacy object map
            return [];
        }

        function upsertById(list, item, key='id') {
            const a = [...(list || [])];
            const i = a.findIndex(x => x && x[key] === item[key]);
            if (i >= 0) a[i] = { ...a[i], ...item }; else a.push(item);
            return a;
        }

        // Generate stable, deterministic booking ID to prevent duplicates
        function newBookingId(booking) {
            // deterministic enough to survive retries; include seconds to avoid natural collisions
            const t = booking.teeTime || booking.date + 'T' + (booking.time || '08:00') + ':00Z';
            const course = booking.courseId || booking.course || 'unknown';
            const user = window.Auth?.currentUserId || booking.golferId || 'anon';
            const type = booking.type || 'teeTime';
            const caddieSuffix = booking.caddieId ? `_caddie_${booking.caddieId}` : '';
            const serviceSuffix = booking.serviceId ? `_service_${booking.serviceId}` : '';
            const mainSuffix = booking.isMainBooking ? '_main' : '';
            const id = `bk_${course}_${t}_${user}_${type}${caddieSuffix}${serviceSuffix}${mainSuffix}`.replace(/[^a-zA-Z0-9_]/g, '_');
            console.log('[newBookingId] Generated ID:', id, 'for booking:', booking);
            return id;
        }

        // CRITICAL: Booking validation and schema helpers
        function validISO(s) {
            if (!s) return false;
            const d = new Date(s);
            return !Number.isNaN(d.getTime());
        }

        function cleanBooking(booking) {
            if (!booking || !booking.id) return null;

            const clean = { ...booking };

            // Fix corrupted teeTime with underscores instead of colons
            if (clean.teeTime && !validISO(clean.teeTime)) {
                const fixed = clean.teeTime.replace(/_/g, ':').replace('T:', 'T');
                if (validISO(fixed)) {
                    clean.teeTime = fixed;
                } else {
                    console.warn('[cleanBooking] Invalid teeTime, dropping:', clean.id);
                    return null;
                }
            }

            // Fix literal "undefined" strings
            ['courseName', 'caddieName', 'golferName', 'playerName'].forEach(key => {
                if (clean[key] === 'undefined' || clean[key] === undefined) {
                    delete clean[key];
                }
            });

            // Ensure kind field exists
            if (!clean.kind) {
                if (clean.type === 'caddie') clean.kind = 'caddie';
                else if (clean.type === 'service') clean.kind = 'service';
                else if (clean.type === 'waitlist') clean.kind = 'waitlist';
                else clean.kind = 'tee';
            }

            // Ensure updatedAt exists
            if (!clean.updatedAt) {
                clean.updatedAt = Date.now();
            }

            return clean;
        }

        function cleanAllBookings() {
            const bookings = JSON.parse(localStorage.getItem('mcipro_bookings') || '[]');
            const cleaned = bookings.map(cleanBooking).filter(Boolean);
            const removedCount = bookings.length - cleaned.length;

            if (removedCount > 0) {
                console.log(`[cleanAllBookings] Removed ${removedCount} corrupted bookings`);
                localStorage.setItem('mcipro_bookings', JSON.stringify(cleaned));
            }

            return cleaned;
        }

        // Advanced cleanup: removes duplicates and "undefined" junk
        function purgeJunkBookings() {
            const bookings = JSON.parse(localStorage.getItem('mcipro_bookings') || '[]');
            const seen = new Set();

            const normKind = (b) => {
                if (b.kind) return b.kind;
                const id = b.id || '';
                if (/_caddie_/.test(id)) return 'caddie';
                if (/_service_/.test(id)) return 'service';
                if (/_teeTime/.test(id) || /_tee_/.test(id)) return 'tee';
                return 'unknown';
            };

            const valid = bookings.filter(b => {
                if (!b || !b.id) return false;

                // Normalize kind
                b.kind = normKind(b);
                if (b.kind === 'unknown') {
                    console.log('[purge] Removing unknown kind:', b.id);
                    return false;
                }

                // Check valid timestamp
                const when = Date.parse(b.teeTime || b.startTime || '');
                if (!isFinite(when)) {
                    console.log('[purge] Removing invalid time:', b.id);
                    return false;
                }

                // Check for "undefined" text
                const text = (b.title || '') + ' ' + (b.courseName || b.course || '');
                if (/undefined/i.test(text)) {
                    console.log('[purge] Removing "undefined" text:', b.id);
                    return false;
                }

                // Check for duplicates
                if (seen.has(b.id)) {
                    console.log('[purge] Removing duplicate:', b.id);
                    return false;
                }
                seen.add(b.id);

                return true;
            });

            const removedCount = bookings.length - valid.length;
            console.log(`[purgeJunkBookings] Cleaned ${removedCount} junk bookings. Remaining: ${valid.length}`);

            localStorage.setItem('mcipro_bookings', JSON.stringify(valid));

            // Update BookingManager
            if (typeof BookingManager !== 'undefined') {
                BookingManager.bookings = valid;
            }

            // Force cloud sync
            if (typeof SimpleCloudSync !== 'undefined') {
                SimpleCloudSync.saveToCloud();
            }

            // Refresh stats
            if (typeof ScheduleSystem !== 'undefined') {
                ScheduleSystem.refreshStats();
            }

            return { removed: removedCount, remaining: valid.length };
        }

        // Expose for console debugging
        window.purgeJunkBookings = purgeJunkBookings;

        // Generate stable round groupId for schedule consolidation
        // GLOBAL PERFORMANCE UTILITIES - 100% optimization across the board
        function debounce(func, wait = 300) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func.apply(this, args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function throttle(func, limit = 150) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // Create debounced versions of all filter/search functions
        let debouncedFilterCaddys, debouncedFilterCourses, debouncedSearchContacts, debouncedFilterNewChatContacts, debouncedFilterBrowseGroups;

        function makeRoundGroupId({ courseId, teeTime, userId }) {
            const iso = new Date(teeTime).toISOString();
            return `round_${courseId}_${iso}_${userId}`.replace(/[^\w]/g, "_");
        }

        // Guard against double-tap and duplicate handlers
        let creatingBooking = false;

        // Clean up any bad home course values from localStorage
        (function normalizeBadHomeClub() {
            try {
                const PLACEHOLDER_TEXTS = new Set([
                    'Select your home course...', 'Select your home course', 'Select home course', 'Not Selected', '—'
                ]);

                const p = JSON.parse(localStorage.getItem('mcipro_user_profile') || 'null');
                if (p && (PLACEHOLDER_TEXTS.has(p.homeClub) || !p.homeClub || p.homeClub.includes('Select'))) {
                    console.log('[ProfileSystem] Cleaning bad homeClub value:', p.homeClub);
                    p.homeClub = '';
                    localStorage.setItem('mcipro_user_profile', JSON.stringify(p));
                    localStorage.setItem('mcipro_user_profiles', JSON.stringify([p]));
                }

                // Also clean the array format
                const profiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');
                let cleaned = false;
                profiles.forEach(profile => {
                    if (profile.homeClub && (PLACEHOLDER_TEXTS.has(profile.homeClub) || profile.homeClub.includes('Select'))) {
                        console.log('[ProfileSystem] Cleaning bad homeClub in profiles array:', profile.homeClub);
                        profile.homeClub = '';
                        cleaned = true;
                    }
                });
                if (cleaned) {
                    localStorage.setItem('mcipro_user_profiles', JSON.stringify(profiles));
                }
            } catch (e) {
                console.warn('[ProfileSystem] Error cleaning bad homeClub values:', e);
            }
        })();

        // Add schedule event once for booking (prevents duplicates)
        function addScheduleEventOnceForBooking(booking) {
            // Read schedule data as object structure (not flat array)
            let scheduleData = JSON.parse(localStorage.getItem('mcipro_schedule') || '{"events":[],"caddieBookings":[],"waitlists":[]}');
            let events = scheduleData.events || [];

            const eventId = `sch_${booking.id}`;
            const evt = {
                id: eventId,
                title: `Round at ${booking.course || booking.courseName}`,
                date: booking.date,
                time: booking.time,
                type: 'golf',
                description: booking.eventName || 'Golf round',
                bookingId: booking.id,
                updatedAt: Date.now(),
                createdAt: Date.now()
            };

            // Use upsert on events array to prevent duplicates
            events = upsertById(events, evt, 'id');
            scheduleData.events = events;

            // Save back as object structure for ScheduleSystem compatibility
            localStorage.setItem('mcipro_schedule', JSON.stringify(scheduleData));
        }

        // Production Cloud Sync System - Google Cloud Firestore + Cloudflare
        class SimpleCloudSync {
            static isInitialized = false;
            static pushTimer = null;
            static DEBOUNCE_DELAY = 800; // 800ms debounce to reduce conflicts
            static circuitOpenUntil = 0; // Circuit breaker timestamp
            static pushing = false; // Guard to prevent pull during push
            static FUNCTION_URL = 'https://mcipro-golf-platform.netlify.app/.netlify/functions/bookings';
            static API_KEY = 'mcipro-site-key-2024';
            static MAX_RETRIES = 5;

            static mergeBookings(local, server) {
                const map = new Map(local.map(b => [b.id, b]));
                for (const b of server) {
                    if (!b?.id) continue;
                    if (b.deleted) {
                        map.delete(b.id);
                        continue;
                    }
                    const existing = map.get(b.id);
                    if (!existing || (b.updatedAt || 0) >= (existing.updatedAt || 0)) {
                        map.set(b.id, b);
                    }
                }
                return Array.from(map.values()).filter(b => !b.deleted);
            }

            static async initialize() {
                console.log('[SimpleCloudSync] Initializing Supabase realtime sync...');
                this.isInitialized = true;

                // PERFORMANCE: Load data in background (non-blocking)
                this.loadFromCloud().catch(err => {
                    console.error('[SimpleCloudSync] Initial load failed:', err);
                });

                // PERFORMANCE: Start Realtime WebSocket subscriptions (replaces polling)
                this.startRealtimeSync();
            }

            static startRealtimeSync() {
                // Wait for SupabaseDB to be ready
                if (!window.SupabaseDB || !window.SupabaseDB.ready) {
                    console.log('[SimpleCloudSync] Waiting for Supabase...');
                    setTimeout(() => this.startRealtimeSync(), 500);
                    return;
                }

                console.log('[SimpleCloudSync] 🚀 Starting Realtime WebSocket subscriptions (0 polling)');

                // Subscribe to bookings changes via WebSocket
                window.SupabaseDB.subscribeToBookings((payload) => {
                    console.log('[SimpleCloudSync] 🔄 Booking update received via WebSocket:', payload.eventType);
                    this.handleRealtimeBookingChange(payload);
                });

                // Subscribe to profile changes via WebSocket
                window.SupabaseDB.subscribeToProfiles((payload) => {
                    console.log('[SimpleCloudSync] 🔄 Profile update received via WebSocket:', payload.eventType);
                    this.handleRealtimeProfileChange(payload);
                });

                // Subscribe to emergency alerts via WebSocket (INSTANT DELIVERY)
                window.SupabaseDB.subscribeToEmergencyAlerts((payload) => {
                    console.log('[SimpleCloudSync] 🚨 Emergency alert WebSocket received:', payload);
                    try {
                        this.handleRealtimeAlertChange(payload);
                    } catch (error) {
                        console.error('[SimpleCloudSync] ❌ Error handling alert WebSocket:', error);
                    }
                });

                // Fallback: Light sync every 5 minutes as safety net
                setInterval(() => {
                    console.log('[SimpleCloudSync] Safety sync (5min fallback)');
                    this.loadFromCloud().catch(err => {
                        console.log('[SimpleCloudSync] Fallback sync failed:', err.message);
                    });
                }, 300000); // 5 minutes

                // Auto-cleanup expired emergency alerts every hour
                setInterval(() => {
                    if (window.SupabaseDB) {
                        window.SupabaseDB.cleanupExpiredAlerts()
                            .then(count => console.log(`[Emergency] Cleaned up ${count} expired alerts`))
                            .catch(err => console.error('[Emergency] Cleanup failed:', err));
                    }
                }, 3600000); // 1 hour

                console.log('[SimpleCloudSync] ✅ Realtime sync active - instant updates via WebSocket');
            }

            static handleRealtimeBookingChange(payload) {
                const { eventType, new: newRecord, old: oldRecord } = payload;

                // Get current local bookings
                const localBookings = JSON.parse(localStorage.getItem('mcipro_bookings') || '[]');

                switch(eventType) {
                    case 'INSERT':
                        // Add new booking if not already present
                        if (!localBookings.find(b => b.id === newRecord.id)) {
                            // Convert snake_case to camelCase
                            const booking = this.convertBookingFromSupabase(newRecord);
                            localBookings.push(booking);
                            localStorage.setItem('mcipro_bookings', JSON.stringify(localBookings));
                            console.log('[SimpleCloudSync] ➕ New booking added:', booking.id);

                            // Trigger UI update
                            window.dispatchEvent(new CustomEvent('booking-added', { detail: booking }));
                        }
                        break;

                    case 'UPDATE':
                        // Update existing booking
                        const updateIndex = localBookings.findIndex(b => b.id === newRecord.id);
                        if (updateIndex !== -1) {
                            const booking = this.convertBookingFromSupabase(newRecord);
                            localBookings[updateIndex] = booking;
                            localStorage.setItem('mcipro_bookings', JSON.stringify(localBookings));
                            console.log('[SimpleCloudSync] ✏️ Booking updated:', booking.id);

                            // Trigger UI update
                            window.dispatchEvent(new CustomEvent('booking-updated', { detail: booking }));
                        }
                        break;

                    case 'DELETE':
                        // Remove deleted booking
                        const deleteIndex = localBookings.findIndex(b => b.id === oldRecord.id);
                        if (deleteIndex !== -1) {
                            localBookings.splice(deleteIndex, 1);
                            localStorage.setItem('mcipro_bookings', JSON.stringify(localBookings));
                            console.log('[SimpleCloudSync] 🗑️ Booking deleted:', oldRecord.id);

                            // Trigger UI update
                            window.dispatchEvent(new CustomEvent('booking-deleted', { detail: { id: oldRecord.id } }));
                        }
                        break;
                }
            }

            static handleRealtimeProfileChange(payload) {
                const { eventType, new: newRecord, old: oldRecord } = payload;

                // Get current local profiles
                const localProfiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');

                switch(eventType) {
                    case 'INSERT':
                    case 'UPDATE':
                        // Upsert profile
                        const existingIndex = localProfiles.findIndex(p =>
                            p.line_user_id === newRecord.line_user_id
                        );

                        if (existingIndex !== -1) {
                            localProfiles[existingIndex] = newRecord;
                            console.log('[SimpleCloudSync] ✏️ Profile updated:', newRecord.line_user_id);
                        } else {
                            localProfiles.push(newRecord);
                            console.log('[SimpleCloudSync] ➕ Profile added:', newRecord.line_user_id);
                        }

                        localStorage.setItem('mcipro_user_profiles', JSON.stringify(localProfiles));
                        break;

                    case 'DELETE':
                        // Remove deleted profile
                        const deleteIndex = localProfiles.findIndex(p =>
                            p.line_user_id === oldRecord.line_user_id
                        );

                        if (deleteIndex !== -1) {
                            localProfiles.splice(deleteIndex, 1);
                            localStorage.setItem('mcipro_user_profiles', JSON.stringify(localProfiles));
                            console.log('[SimpleCloudSync] 🗑️ Profile deleted:', oldRecord.line_user_id);
                        }
                        break;
                }
            }

            static handleRealtimeAlertChange(payload) {
                console.log('[SimpleCloudSync] 📥 Processing alert payload:', JSON.stringify(payload, null, 2));

                const { eventType, new: newRecord, old: oldRecord } = payload;
                console.log('[SimpleCloudSync] Event type:', eventType);

                switch(eventType) {
                    case 'INSERT':
                    case 'UPDATE':
                        console.log('[SimpleCloudSync] 🔄 INSERT/UPDATE - newRecord:', newRecord);

                        // Convert Supabase format to app format
                        const alert = {
                            id: newRecord.id,
                            type: newRecord.type,
                            message: newRecord.message,
                            user: newRecord.user_name,
                            role: newRecord.user_role,
                            timestamp: newRecord.timestamp,
                            location: (newRecord.location_lat && newRecord.location_lng) ? {
                                lat: newRecord.location_lat,
                                lng: newRecord.location_lng,
                                hole: newRecord.location_hole
                            } : null,
                            status: newRecord.status,
                            priority: newRecord.priority,
                            acknowledgedBy: newRecord.acknowledged_by || [],
                            resolvedBy: newRecord.resolved_by,
                            resolvedAt: newRecord.resolved_at
                        };
                        console.log('[SimpleCloudSync] 📋 Converted alert:', alert);

                        // Update local alerts
                        const localAlerts = EmergencySystem.activeAlerts || [];
                        const existingIndex = localAlerts.findIndex(a => a.id === alert.id);
                        console.log('[SimpleCloudSync] Current activeAlerts count:', localAlerts.length, 'existingIndex:', existingIndex);

                        if (alert.status === 'active') {
                            if (existingIndex !== -1) {
                                localAlerts[existingIndex] = alert;
                                console.log('[SimpleCloudSync] ✏️ Emergency alert updated:', alert.id);
                            } else {
                                localAlerts.push(alert);
                                console.log('[SimpleCloudSync] ➕ New emergency alert received:', alert.id);

                                // Show full-screen overlay for NEW alerts
                                console.log('[SimpleCloudSync] 🎯 Checking overlay conditions - eventType:', eventType, 'EmergencySystem defined:', typeof EmergencySystem !== 'undefined');
                                if (eventType === 'INSERT' && typeof EmergencySystem !== 'undefined') {
                                    console.log('[SimpleCloudSync] 🚨 SHOWING FULL-SCREEN OVERLAY NOW!');
                                    EmergencySystem.createFullScreenEmergencyOverlay(alert);
                                    console.log('[SimpleCloudSync] 🔊 PLAYING SIREN NOW!');
                                    EmergencySystem.playEmergencySiren();
                                } else {
                                    console.warn('[SimpleCloudSync] ⚠️ NOT showing overlay - eventType:', eventType, 'EmergencySystem:', typeof EmergencySystem);
                                }
                            }
                        } else {
                            // Alert resolved/inactive - remove it
                            if (existingIndex !== -1) {
                                localAlerts.splice(existingIndex, 1);
                                console.log('[SimpleCloudSync] ✅ Emergency alert resolved:', alert.id);
                            }
                        }

                        EmergencySystem.activeAlerts = localAlerts;
                        localStorage.setItem('emergency_alerts', JSON.stringify(localAlerts));
                        console.log('[SimpleCloudSync] 💾 Saved to localStorage - total alerts:', localAlerts.length);

                        // Update all role displays
                        if (typeof PersistentEmergencyAlerts !== 'undefined') {
                            PersistentEmergencyAlerts.updateAllOverviewAlerts();
                            console.log('[SimpleCloudSync] 🔄 Updated role displays');
                        }
                        break;

                    case 'DELETE':
                        console.log('[SimpleCloudSync] 🗑️ DELETE - oldRecord:', oldRecord);
                        // Remove deleted alert
                        const deleteIndex = EmergencySystem.activeAlerts?.findIndex(a => a.id === oldRecord.id);
                        if (deleteIndex !== -1) {
                            EmergencySystem.activeAlerts.splice(deleteIndex, 1);
                            localStorage.setItem('emergency_alerts', JSON.stringify(EmergencySystem.activeAlerts));
                            console.log('[SimpleCloudSync] ❌ Emergency alert deleted:', oldRecord.id);

                            if (typeof PersistentEmergencyAlerts !== 'undefined') {
                                PersistentEmergencyAlerts.updateAllOverviewAlerts();
                            }
                        }
                        break;

                    default:
                        console.warn('[SimpleCloudSync] ⚠️ Unknown event type:', eventType);
                }
            }

            static convertBookingFromSupabase(booking) {
                // Convert snake_case fields to camelCase for app compatibility
                return {
                    id: booking.id,
                    name: booking.name,
                    date: booking.date,
                    time: booking.time,
                    teeTime: booking.tee_time,
                    status: booking.status,
                    players: booking.players,
                    caddyNumber: booking.caddy_number,
                    currentHole: booking.current_hole,
                    lastHoleUpdate: booking.last_hole_update,
                    notes: booking.notes,
                    phone: booking.phone,
                    email: booking.email,
                    groupId: booking.group_id,
                    kind: booking.kind,
                    golferId: booking.golfer_id,
                    golferName: booking.golfer_name,
                    eventName: booking.event_name,
                    courseId: booking.course_id,
                    courseName: booking.course_name,
                    course: booking.course,
                    teeSheetCourse: booking.tee_sheet_course,
                    teeNumber: booking.tee_number,
                    bookingType: booking.booking_type,
                    durationMin: booking.duration_min,
                    caddieId: booking.caddie_id,
                    caddieName: booking.caddie_name,
                    caddieStatus: booking.caddie_status,
                    caddyConfirmationRequired: booking.caddy_confirmation_required,
                    serviceName: booking.service_name,
                    service: booking.service,
                    source: booking.source,
                    isPrivate: booking.is_private,
                    isVIP: booking.is_vip,
                    deleted: booking.deleted,
                    createdAt: booking.created_at,
                    updatedAt: booking.updated_at
                };
            }

            // PERFORMANCE: Prefetch data on tab hover (instant loading)
            static prefetchData() {
                // Throttle prefetch - don't spam if user hovers multiple times
                if (this.prefetchTimeout) return;

                this.prefetchTimeout = setTimeout(() => {
                    this.prefetchTimeout = null;
                }, 2000); // Throttle to once per 2 seconds

                // Only prefetch if data is stale (older than 30s)
                const lastLoad = localStorage.getItem('mcipro_last_sync');
                if (lastLoad && Date.now() - parseInt(lastLoad) < 30000) {
                    return; // Data is fresh, no need to prefetch
                }

                console.log('[SimpleCloudSync] 🚀 Prefetching data on hover...');

                // Non-blocking prefetch
                this.loadFromCloud().catch(err => {
                    console.log('[SimpleCloudSync] Prefetch failed (non-critical):', err.message);
                });

                localStorage.setItem('mcipro_last_sync', Date.now().toString());
            }

            static async loadFromCloud(forceLoadAllProfiles = false) {
                // Guard: Skip pull during active push to prevent partial state corruption
                if (this.pushing) {
                    console.log('[SimpleCloudSync] Push in progress, skipping pull');
                    return null;
                }

                // Circuit breaker: stop hammering if server is down
                const now = Date.now();
                if (now < this.circuitOpenUntil) {
                    console.log('[SimpleCloudSync] Circuit breaker open, skipping sync');
                    throw new Error('Circuit open - server unavailable');
                }

                try {
                    // PERFORMANCE: Load bookings first
                    const bookingsResult = await window.SupabaseDB.getBookings();
                    const bookings = bookingsResult.bookings || [];

                    // PERFORMANCE: Lazy load only essential profiles (current user + visible bookings)
                    // EXCEPT during login - need all profiles to check if user exists
                    let profilesResult;

                    if (forceLoadAllProfiles) {
                        console.log('[SimpleCloudSync] Loading ALL profiles (login/registration)');
                        profilesResult = await window.SupabaseDB.getAllProfiles();
                    } else {
                        const currentUserId = (window.AppState?.currentUser?.id) ||
                                            (window.Auth?.currentUserId) ||
                                            localStorage.getItem('line_user_id') || null;

                        profilesResult = await window.SupabaseDB.getEssentialProfiles(
                            currentUserId,
                            bookings
                        );
                    }

                    const cloudData = {
                        bookings: bookings,
                        user_profiles: profilesResult || [],
                        version: Date.now(), // Use timestamp as version
                        updatedAt: new Date().toISOString()
                    };

                    console.log('[SimpleCloudSync] 🚀 Loaded from Supabase (LAZY):', {
                        bookings: cloudData.bookings?.length || 0,
                        profiles: cloudData.user_profiles?.length || 0,
                        profilesLoadedRatio: `${cloudData.user_profiles?.length || 0} (only essential)`,
                        version: cloudData.version,
                        updatedAt: cloudData.updatedAt
                    });

                    // Sync profiles from cloud
                    if (cloudData.user_profiles && Array.isArray(cloudData.user_profiles)) {
                        const localProfiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');
                        const serverProfiles = cloudData.user_profiles;

                        // Merge profiles by lineUserId or username
                        const mergedProfiles = [...serverProfiles];
                        localProfiles.forEach(localProfile => {
                            const existsInServer = serverProfiles.find(sp =>
                                (sp.lineUserId && sp.lineUserId === localProfile.lineUserId) ||
                                (sp.username && sp.username === localProfile.username)
                            );
                            if (!existsInServer) {
                                mergedProfiles.push(localProfile);
                            }
                        });

                        localStorage.setItem('mcipro_user_profiles', JSON.stringify(mergedProfiles));
                        console.log('[SimpleCloudSync] Synced profiles:', {
                            server: serverProfiles.length,
                            local: localProfiles.length,
                            merged: mergedProfiles.length
                        });
                    }

                    // EMPTY PAYLOAD GUARD: If server returns empty but we have local data, keep local
                    const localBookings = JSON.parse(localStorage.getItem('mcipro_bookings') || '[]');
                    const serverBookings = cloudData.bookings || [];
                    if (serverBookings.length === 0 && localBookings.length > 0) {
                        console.warn('[SimpleCloudSync] Server empty but local has data, keeping local (prevents wipe)');
                        return false;
                    }

                    // Get local base version
                    const localVersionRaw = localStorage.getItem('mcipro_baseVersion');
                    const localVersion = (localVersionRaw && localVersionRaw !== 'undefined') ? JSON.parse(localVersionRaw) : 0;

                    // Only update if cloud version is newer
                    if (cloudData.version > localVersion) {
                        console.log('[SimpleCloudSync] Cloud version newer, merging bookings');

                        // NEVER replace - always merge using last-write-wins
                        const merged = this.mergeBookings(localBookings, serverBookings);
                        localStorage.setItem('mcipro_bookings', JSON.stringify(merged));
                        localStorage.setItem('mcipro_baseVersion', JSON.stringify(cloudData.version));

                        if (typeof BookingManager !== 'undefined') {
                            BookingManager.bookings = merged;
                            console.log('[SimpleCloudSync] Updated BookingManager with', merged.length, 'bookings');
                        }

                        // Refresh schedule UI since it renders from bookings
                        if (typeof ScheduleSystem !== 'undefined' && ScheduleSystem.renderScheduleList) {
                            ScheduleSystem.renderScheduleList();
                        }

                        this.showSyncStatus('↓ Cloud Update', 'info');
                        return true;
                    }

                    return false;
                } catch (error) {
                    console.error('[SimpleCloudSync] Failed to load from cloud:', error);
                    return false;
                }
            }

            static ensureStableIds(data) {
                // Ensure all items have stable IDs and updatedAt timestamps

                // Fix bookings
                data.bookings = (data.bookings || []).map(booking => ({
                    ...booking,
                    id: booking.id || `booking_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    updatedAt: booking.updatedAt || Date.now()
                }));

                // Fix profiles with stable userId instead of name
                data.user_profiles = (data.user_profiles || []).map(profile => ({
                    ...profile,
                    userId: profile.userId || `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    updatedAt: profile.updatedAt || Date.now()
                }));

                // Fix schedule items - ensure it's an array
                let scheduleItems = data.schedule_items || [];
                if (typeof scheduleItems === 'object' && !Array.isArray(scheduleItems)) {
                    // Convert object to array if needed
                    if (scheduleItems.events) {
                        scheduleItems = scheduleItems.events || [];
                    } else {
                        scheduleItems = [];
                    }
                }
                data.schedule_items = scheduleItems.map(item => ({
                    ...item,
                    id: item.id || `schedule_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    updatedAt: item.updatedAt || Date.now()
                }));

                // Fix emergency alerts
                data.emergency_alerts = (data.emergency_alerts || []).map(alert => ({
                    ...alert,
                    id: alert.id || `alert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    updatedAt: alert.updatedAt || Date.now()
                }));

                return data;
            }

            static async saveToCloud(retryCount = 0) {
                const MAX_RETRIES = 3;
                const BASE_DELAY = 500; // 500ms base delay

                // Set push guard to prevent concurrent pulls
                this.pushing = true;

                // Circuit breaker: stop hammering if server is down
                const now = Date.now();
                if (now < this.circuitOpenUntil) {
                    console.log('[SimpleCloudSync] Circuit breaker open, working locally only');
                    this.showSyncStatus('💾 Local Only', 'warning');
                    this.pushing = false;
                    return false;
                }

                try {
                    // Get current baseVersion
                    const baseVersionRaw = localStorage.getItem('mcipro_baseVersion');
                    const baseVersion = (baseVersionRaw && baseVersionRaw !== 'undefined') ? JSON.parse(baseVersionRaw) : 0;

                    // Get local bookings AND profiles
                    const bookings = JSON.parse(localStorage.getItem('mcipro_bookings') || '[]');
                    const profiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');

                    // Ensure all bookings have stable IDs and timestamps
                    const cleanBookings = bookings.map(b => ({
                        ...b,
                        id: b.id || `bk_${Date.now()}_${Math.random().toString(36).slice(2)}`,
                        updatedAt: b.updatedAt || Date.now()
                    }));

                    console.log('[SimpleCloudSync] Sending to server:', {
                        bookings: cleanBookings.length,
                        profiles: profiles.length,
                        baseVersion,
                        attempt: retryCount + 1
                    });

                    // PERFORMANCE: Batch save to Supabase (1 request instead of N)
                    try {
                        // Batch save all bookings in one transaction
                        await window.SupabaseDB.batchSaveBookings(cleanBookings);

                        // Batch save all profiles
                        const profilePromises = profiles.map(profile =>
                            window.SupabaseDB.saveUserProfile(profile).catch(err => {
                                console.error('[SimpleCloudSync] Failed to save profile:', profile.line_user_id || profile.lineUserId, err);
                                return null;
                            })
                        );

                        await Promise.all(profilePromises);
                        console.log('[SimpleCloudSync] ✅ Batch save complete');
                    } catch (err) {
                        console.error('[SimpleCloudSync] Batch save failed, falling back to individual saves');
                        // Fallback to individual saves
                        const savePromises = cleanBookings.map(booking =>
                            window.SupabaseDB.saveBooking(booking).catch(err => {
                                console.error('[SimpleCloudSync] Failed to save booking:', booking.id, err);
                                return null;
                            })
                        );
                        await Promise.all(savePromises);
                    }

                    // PERFORMANCE: Get updated data from Supabase with lazy profile loading
                    const updatedBookingsResult = await window.SupabaseDB.getBookings();
                    const updatedBookings = updatedBookingsResult.bookings || [];

                    const currentUserId = (window.AppState?.currentUser?.id) ||
                                        (window.Auth?.currentUserId) ||
                                        localStorage.getItem('line_user_id') || null;

                    const profilesResult = await window.SupabaseDB.getEssentialProfiles(
                        currentUserId,
                        updatedBookings
                    );

                    const result = {
                        bookings: updatedBookings,
                        user_profiles: profilesResult || [],
                        version: Date.now(),
                        updatedAt: new Date().toISOString()
                    };

                    // Merge with server state
                    const merged = this.mergeBookings(cleanBookings, result.bookings);
                    localStorage.setItem('mcipro_bookings', JSON.stringify(merged));
                    localStorage.setItem('mcipro_baseVersion', JSON.stringify(result.version));

                    if (typeof BookingManager !== 'undefined') {
                        BookingManager.bookings = merged;
                    }

                    console.log('[SimpleCloudSync] Saved to Supabase, version:', result.version);
                    this.showSyncStatus('☁️ Synced', 'success');
                    return true;
                } catch (error) {
                    console.error('[SimpleCloudSync] Failed to save to cloud:', error);
                    this.showSyncStatus('💾 Local Only', 'warning');
                    return false;
                } finally {
                    // Always clear push guard
                    this.pushing = false;
                }
            }

            static updateLocalStorageFromServer(serverData) {
                // Helper function to normalize to array
                function toArray(x) {
                    if (Array.isArray(x)) return x;
                    if (x?.items) return x.items;
                    if (x && typeof x === 'object') return Object.values(x);
                    return [];
                }

                // CRITICAL FIX: Merge server data with local data (last-write-wins)
                // Never destructively replace - only upsert by ID with updatedAt comparison
                function mergeIntoLocal(localKey, serverItems, idField = 'id') {
                    const localItems = toArray(JSON.parse(localStorage.getItem(localKey) || '[]'));
                    const map = new Map(localItems.map(x => [x[idField], x]));

                    // Upsert server items using last-write-wins
                    for (const item of toArray(serverItems)) {
                        const id = item[idField];
                        if (!id) continue;

                        const existing = map.get(id);

                        // Handle deletions (tombstones)
                        if (item.deleted) {
                            map.delete(id);
                            continue;
                        }

                        // Last-write-wins: use server item if newer or if no local item exists
                        if (!existing || (item.updatedAt || 0) >= (existing.updatedAt || 0)) {
                            map.set(id, item);
                        }
                    }

                    // Filter out deleted items
                    const merged = Array.from(map.values()).filter(x => !x.deleted);
                    localStorage.setItem(localKey, JSON.stringify(merged));
                    return merged;
                }

                const scheduleData = toArray(serverData.schedule_items || serverData.schedule || []);

                // Merge server data with local data (non-destructive)
                const mergedBookings = mergeIntoLocal('mcipro_bookings', serverData.bookings || [], 'id');
                const mergedProfiles = mergeIntoLocal('mcipro_user_profiles', serverData.user_profiles || [], 'userId');
                const mergedSchedule = mergeIntoLocal('mcipro_schedule', scheduleData, 'id');
                const mergedAlerts = mergeIntoLocal('emergency_alerts', serverData.emergency_alerts || [], 'id');
                const mergedCaddies = mergeIntoLocal('mcipro_caddies', serverData.caddies || [], 'id');
                const mergedWaitlist = mergeIntoLocal('mcipro_waitlist', serverData.waitlist || [], 'id');

                // Update envelope with merged data
                localStorage.setItem('mcipro_data', JSON.stringify({
                    ...serverData,
                    bookings: mergedBookings,
                    user_profiles: mergedProfiles,
                    schedule: mergedSchedule,
                    emergency_alerts: mergedAlerts,
                    caddies: mergedCaddies,
                    waitlist: mergedWaitlist,
                    lastSyncVersion: serverData.version
                }));

                // Update in-memory data structures
                if (typeof BookingManager !== 'undefined' && BookingManager.bookings) {
                    BookingManager.bookings = mergedBookings;
                    console.log('[SimpleCloudSync] Updated BookingManager with merged data:', BookingManager.bookings.length, 'bookings');
                }

                // Update ProfileSystem UI with synced profile data
                if (typeof ProfileSystem !== 'undefined' && ProfileSystem.updateUIWithProfile) {
                    console.log('[SimpleCloudSync] Updating ProfileSystem UI with synced data');

                    // Also update single profile format and re-apply form selection
                    const currentUserId = (window.AppState && window.AppState.currentUser && window.AppState.currentUser.id) ||
                                        (window.Auth && window.Auth.currentUserId) || 'anon';
                    const userProfile = (serverData.user_profiles || []).find(u => u.userId === currentUserId);

                    if (userProfile) {
                        localStorage.setItem('mcipro_user_profile', JSON.stringify(userProfile));
                        console.log('[SimpleCloudSync] Updated single profile format with homeClub:', userProfile.homeClub || '(none)');

                        // Re-apply home club selection to form if it exists
                        if (userProfile.homeClub && typeof ProfileSystem.applyHomeClubToForm === 'function') {
                            ProfileSystem.applyHomeClubToForm(userProfile.homeClub);
                        }
                    }

                    ProfileSystem.updateUIWithProfile();
                }

                // Refresh ScheduleSystem to reflect merged schedule
                if (typeof ScheduleSystem !== 'undefined' && ScheduleSystem.loadFromStorage) {
                    ScheduleSystem.loadFromStorage();
                    ScheduleSystem.updateScheduleTab();
                }

                console.log('[SimpleCloudSync] Local storage updated from server:', {
                    bookings: serverData.bookings?.length || 0,
                    profiles: serverData.user_profiles?.length || 0,
                    schedule: scheduleData.length,
                    version: serverData.version
                });
            }

            static async handleDeletion(entityType, id) {
                // Send a deletion tombstone to the server
                const deletionData = {};
                deletionData[entityType] = [{
                    id: id,
                    deleted: true,
                    updatedAt: Date.now()
                }];

                console.log(`[SimpleCloudSync] Sending deletion tombstone for ${entityType}:${id}`);

                const res = await fetch('/.netlify/functions/bookings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer mcipro-site-key-2024'
                    },
                    body: JSON.stringify(deletionData)
                });

                if (res.ok) {
                    const result = await res.json();
                    this.updateLocalStorageFromServer(result.mergedData);
                    console.log(`[SimpleCloudSync] Deletion synced for ${entityType}:${id}`);
                }
            }

            static async saveViaCloudflare(userData) {
                const response = await fetch(`${this.cloudflareWorkerUrl}/sync/${this.getUserDocPath()}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'mcipro-sync-key-2024'
                    },
                    body: JSON.stringify(userData)
                });

                if (!response.ok) {
                    throw new Error(`Cloudflare sync failed: ${response.status}`);
                }

                const result = await response.json();
                console.log('[ProductionCloudSync] Data saved via Cloudflare:', result);
                this.showSyncStatus('⚡ Edge Synced', 'success');
            }

            static async syncFromCloudflare() {
                if (!this.isInitialized) return;

                try {
                    const response = await fetch(`${this.cloudflareWorkerUrl}/sync/${this.getUserDocPath()}`, {
                        headers: { 'X-API-Key': 'mcipro-sync-key-2024' }
                    });

                    if (response.ok) {
                        const cloudData = await response.json();
                        this.handleCloudUpdate(cloudData);
                    }
                } catch (error) {
                    console.error('[ProductionCloudSync] Sync from Cloudflare failed:', error);
                }
            }

            static handleCloudUpdate(cloudData) {
                try {
                    console.log('[SYNC] Received cloud data:', {
                        user: cloudData.user_name,
                        bookings: cloudData.bookings?.length || 0,
                        profiles: cloudData.user_profiles?.length || 0
                    });

                    if (cloudData.bookings) {
                        const currentBookings = JSON.parse(localStorage.getItem('mcipro_bookings') || '[]');
                        const existingIds = new Set(currentBookings.map(b => b.id));
                        const newBookings = cloudData.bookings.filter(booking => !existingIds.has(booking.id));

                        if (newBookings.length > 0) {
                            const mergedBookings = [...currentBookings, ...newBookings];
                            localStorage.setItem('mcipro_bookings', JSON.stringify(mergedBookings));
                            if (typeof BookingManager !== 'undefined') {
                                BookingManager.bookings = mergedBookings;
                                console.log('[SYNC] Merged bookings - refreshing UI');
                                BookingManager.render();
                            }
                            this.showSyncStatus('↓ Real-time Update', 'info');
                        }
                    }

                    if (cloudData.user_profiles) {
                        const currentProfiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');
                        const existingNames = new Set(currentProfiles.map(p => p.name));
                        const newProfiles = cloudData.user_profiles.filter(profile => !existingNames.has(profile.name));

                        if (newProfiles.length > 0) {
                            const mergedProfiles = [...currentProfiles, ...newProfiles];
                            localStorage.setItem('mcipro_user_profiles', JSON.stringify(mergedProfiles));
                            console.log('[SYNC] Merged profiles');
                            this.showSyncStatus('↓ Real-time Update', 'info');
                        }
                    }

                    if (cloudData.emergency_alerts) {
                        localStorage.setItem('emergency_alerts', JSON.stringify(cloudData.emergency_alerts));
                        if (typeof EmergencySystem !== 'undefined') {
                            EmergencySystem.activeAlerts = cloudData.emergency_alerts;
                            // Show any new emergency alerts immediately
                            const newAlert = cloudData.emergency_alerts[cloudData.emergency_alerts.length - 1];
                            if (newAlert) {
                                console.log('[Emergency] Displaying synced alert from cloud:', newAlert);
                                EmergencySystem.createFullScreenEmergencyOverlay(newAlert);
                            }
                        }
                    }

                } catch (error) {
                    console.error('[ProductionCloudSync] Handle cloud update failed:', error);
                }
            }

            static async syncGlobalEmergencyAlerts() {
                try {
                    const response = await fetch(`${this.cloudflareWorkerUrl}/global/emergency-alerts`, {
                        headers: { 'X-API-Key': 'mcipro-sync-key-2024' }
                    });

                    if (response.ok) {
                        const raw = await res.clone().text();
                    console.log('[exchange] status', res.status, raw);
                    const data = JSON.parse(raw || '{}');
                        if (data.alerts && data.alerts.length > 0) {
                            localStorage.setItem('emergency_alerts', JSON.stringify(data.alerts));
                            if (typeof EmergencySystem !== 'undefined') {
                                EmergencySystem.activeAlerts = data.alerts;
                                console.log('[ProductionCloudSync] Updated global emergency alerts');
                            }
                        }
                    }
                } catch (error) {
                    console.error('[ProductionCloudSync] Emergency alerts sync failed:', error);
                }
            }


            static showSyncStatus(message, type = 'info') {
                console.log(`[ProductionCloudSync] ${message}`);

                let statusElement = document.getElementById('sync-status');
                if (!statusElement) {
                    statusElement = document.createElement('div');
                    statusElement.id = 'sync-status';
                    statusElement.style.cssText = `
                        position: fixed;
                        top: 10px;
                        right: 10px;
                        width: 10px;
                        height: 10px;
                        border-radius: 50%;
                        background-color: #10b981;
                        z-index: 10000;
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    `;
                    document.body.appendChild(statusElement);
                }

                // Show the green dot with pulse animation
                statusElement.style.opacity = '1';
                statusElement.style.animation = 'pulse 0.5s ease-in-out 2';

                setTimeout(() => {
                    if (statusElement) {
                        statusElement.style.opacity = '0';
                        statusElement.style.animation = '';
                    }
                }, 2000);
            }
            // Backward compatibility aliases
            static async saveData() {
                return await this.saveToCloud();
            }

            static async syncFromCloudflare() {
                return await this.loadFromCloud();
            }

            // Add missing methods that are being called
            static async forceSync() {
                console.log('[ProductionCloudSync] forceSync() called');
                try {
                    await this.saveData();
                    await this.syncFromCloudflare();
                    console.log('[ProductionCloudSync] Force sync completed');
                } catch (error) {
                    console.error('[ProductionCloudSync] Force sync failed:', error);
                }
            }

            static async loadDataFromCloudflare() {
                console.log('[ProductionCloudSync] loadDataFromCloudflare() called');
                try {
                    const response = await fetch(`${this.cloudflareWorkerUrl}/sync/${this.getUserDocPath()}`, {
                        headers: { 'X-API-Key': 'mcipro-sync-key-2024' }
                    });

                    if (response.ok) {
                        const cloudData = await response.json();
                        this.handleCloudUpdate(cloudData);
                        console.log('[ProductionCloudSync] Initial data loaded from cloud');
                    } else {
                        console.log('[ProductionCloudSync] No cloud data found for initial load');
                    }
                } catch (error) {
                    console.error('[ProductionCloudSync] Failed to load initial data:', error);
                }
            }

            // Debounced sync to prevent conflict storms
            static saveToCloudSoon() {
                clearTimeout(this.pushTimer);
                this.pushTimer = setTimeout(() => {
                    console.log('[SimpleCloudSync] Debounced sync executing...');
                    this.saveToCloud();
                }, this.DEBOUNCE_DELAY);
            }
        }

        // Alias for backward compatibility
        window.CrossDeviceSync = SimpleCloudSync;
        window.ProductionCloudSync = SimpleCloudSync; // Also alias the old name
        const CrossDeviceSync = SimpleCloudSync;
        const ProductionCloudSync = SimpleCloudSync;

        // FIXED: Cross-device sync via storage events
        window.addEventListener('storage', (e) => {
            if (e.key === 'mcipro_bookings' && e.newValue) {
                console.log('[CrossDeviceSync] Bookings updated in another tab/device');
                try {
                    const newBookings = JSON.parse(e.newValue);
                    if (typeof BookingManager !== 'undefined' && BookingManager.bookings) {
                        BookingManager.bookings = newBookings;
                        console.log('[CrossDeviceSync] Synced', newBookings.length, 'bookings from other device');
                        // Refresh UI if on bookings page
                        if (typeof BookingManager.render === 'function') {
                            BookingManager.render();
                        }
                        // Also refresh schedule stats
                        if (typeof ScheduleSystem !== 'undefined' && ScheduleSystem.refreshStats) {
                            ScheduleSystem.refreshStats();
                        }
                    }
                } catch (err) {
                    console.error('[CrossDeviceSync] Failed to sync bookings:', err);
                }
            }

            if (e.key === 'mcipro_schedule' && e.newValue) {
                console.log('[CrossDeviceSync] Schedule updated in another tab/device');
                try {
                    if (typeof ScheduleSystem !== 'undefined') {
                        ScheduleSystem.loadSchedule();
                        ScheduleSystem.updateScheduleTab();
                        console.log('[CrossDeviceSync] Schedule synced from other device');
                    }
                } catch (err) {
                    console.error('[CrossDeviceSync] Failed to sync schedule:', err);
                }
            }
        });

        // FIXED: Force sync when page becomes visible (user returns to app)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                console.log('[CrossDeviceSync] Page visible - forcing sync');
                if (typeof SimpleCloudSync !== 'undefined' && SimpleCloudSync.loadFromCloud) {
                    SimpleCloudSync.loadFromCloud();
                }
            }
        });

        // Screen Management System
        class ScreenManager {
            static showScreen(screenId, data = null) {
                try {
                    console.log(`ScreenManager: Navigating to ${screenId}`);

                    // Hide all screens
                    document.querySelectorAll('.screen').forEach(screen => {
                        screen.classList.remove('active');
                    });

                    // Show target screen
                    const targetScreen = document.getElementById(screenId);
                    if (!targetScreen) {
                        throw new Error(`Screen '${screenId}' not found`);
                    }

                    targetScreen.classList.add('active');

                    // Update navigation state
                    AppState.navigation.lastScreen = AppState.navigation.currentScreen;
                    AppState.navigation.currentScreen = screenId;
                    AppState.navigation.breadcrumb.push(screenId);

                    // Limit breadcrumb history
                    if (AppState.navigation.breadcrumb.length > 10) {
                        AppState.navigation.breadcrumb.shift();
                    }

                    // Initialize screen-specific functionality
                    this.initializeScreen(screenId, data);

                    // Update session activity
                    AppState.session.lastActivity = new Date().toISOString();

                    console.log(`ScreenManager: Successfully navigated to ${screenId}`);

                } catch (error) {
                    console.error('ScreenManager Error:', error);
                    NotificationManager.show('Navigation error occurred', 'error');
                }
            }

            static initializeScreen(screenId, data) {
                const initMap = {
                    'loginScreen': () => this.initLoginScreen(),
                    'otpScreen': () => this.initOTPScreen(),
                    'golferDashboard': () => this.initGolferDashboard(),
                    'caddieDashboard': () => this.initCaddyDashboard(),
                    'managerDashboard': () => this.initManagerDashboard(),
                    'proshopDashboard': () => this.initProshopDashboard(),
                    'maintenanceDashboard': () => this.initMaintenanceDashboard(),
                    'societyOrganizerDashboard': () => this.initSocietyOrganizerDashboard()
                };

                const initFunction = initMap[screenId];
                if (initFunction) {
                    initFunction();
                }
            }

            static initLoginScreen() {
                // Reset any authentication state
                AppState.session.isAuthenticated = false;
                AppState.session.authMethod = null;

                // Initialize LINE LIFF if available
                LineAuthentication.initializeLIFF();
            }

            static initOTPScreen() {
                // Focus first OTP input
                const firstInput = document.querySelector('.otp-input');
                if (firstInput) {
                    firstInput.focus();
                }
            }

            static initGolferDashboard() {
                // === PERFORMANCE OPTIMIZATION: Check if already initialized ===
                const cacheKey = 'golfer_dashboard_init';
                const cached = GlobalCacheManager.get(cacheKey);

                if (cached) {
                    console.log('[Dashboard] Using cached Golfer Dashboard (instant load)');
                    TabManager.showTab('golferDashboard', 'overview');
                    UserInterface.updateUserDisplays();
                    // Schedule already rendered from cache
                    if (typeof ScheduleSystem !== 'undefined' && ScheduleSystem.renderScheduleList) {
                        ScheduleSystem.renderScheduleList();
                    }
                    return;
                }

                // First-time initialization
                console.log('[Dashboard] First-time Golfer Dashboard init');
                TabManager.showTab('golferDashboard', 'overview');
                UserInterface.updateUserDisplays();
                ProfileSystem.initializeDashboard();

                // CRITICAL: Render schedule immediately and repeatedly to ensure it loads
                if (typeof ScheduleSystem !== 'undefined' && ScheduleSystem.renderScheduleList) {
                    // Immediate render
                    ScheduleSystem.renderScheduleList();
                    console.log('[Dashboard] Schedule rendered immediately on init');

                    // Backup renders to catch async data loading
                    setTimeout(() => {
                        ScheduleSystem.renderScheduleList();
                        console.log('[Dashboard] Schedule re-rendered at 100ms');
                        // Mark as initialized after first successful render
                        GlobalCacheManager.set(cacheKey, true, 30000);
                    }, 100);

                    setTimeout(() => {
                        ScheduleSystem.renderScheduleList();
                        console.log('[Dashboard] Schedule re-rendered at 500ms');
                    }, 500);

                    setTimeout(() => {
                        ScheduleSystem.renderScheduleList();
                        console.log('[Dashboard] Schedule re-rendered at 1000ms');
                    }, 1000);
                }

                // CRITICAL: Render food menu immediately and repeatedly to ensure it loads
                if (typeof renderFoodMenu === 'function') {
                    // Immediate render
                    renderFoodMenu();
                    console.log('[Dashboard] Food menu rendered immediately on init');

                    // Backup renders to catch async data loading
                    setTimeout(() => {
                        renderFoodMenu();
                        console.log('[Dashboard] Food menu re-rendered at 100ms');
                    }, 100);

                    setTimeout(() => {
                        renderFoodMenu();
                        console.log('[Dashboard] Food menu re-rendered at 500ms');
                    }, 500);

                    setTimeout(() => {
                        renderFoodMenu();
                        console.log('[Dashboard] Food menu re-rendered at 1000ms');
                    }, 1000);
                }

                // Initialize GPS tracking for live course status
                setTimeout(() => {
                    if (typeof startGPSTracking === 'function') {
                        startGPSTracking();
                        getCurrentLocation();
                    }
                }, 1000);
            }

            static initCaddyDashboard() {
                // === PERFORMANCE OPTIMIZATION ===
                const cacheKey = 'caddy_dashboard_init';
                const cached = GlobalCacheManager.get(cacheKey);

                if (cached) {
                    console.log('[Dashboard] Using cached Caddy Dashboard (instant load)');
                    TabManager.showTab('caddieDashboard', 'overview');
                    UserInterface.updateUserDisplays();
                    return;
                }

                console.log('[Dashboard] First-time Caddy Dashboard init');
                TabManager.showTab('caddieDashboard', 'overview');
                UserInterface.updateUserDisplays();
                GlobalCacheManager.set(cacheKey, true, 30000);
            }

            static initManagerDashboard() {
                // === PERFORMANCE OPTIMIZATION ===
                const cacheKey = 'manager_dashboard_init';
                const cached = GlobalCacheManager.get(cacheKey);

                if (cached) {
                    console.log('[Dashboard] Using cached Manager Dashboard (instant load)');
                    TabManager.showTab('managerDashboard', 'overview');
                    UserInterface.updateUserDisplays();
                    // Analytics already loaded from cache
                    if (typeof ManagerAnalytics !== 'undefined') {
                        ManagerAnalytics.updateUI();
                    }
                    return;
                }

                console.log('[Dashboard] First-time Manager Dashboard init');
                TabManager.showTab('managerDashboard', 'overview');
                UserInterface.updateUserDisplays();
                // Load real data from Supabase
                setTimeout(() => {
                    if (typeof ManagerAnalytics !== 'undefined') {
                        ManagerAnalytics.updateOverview();
                        ManagerAnalytics.updateUI();
                        GlobalCacheManager.set(cacheKey, true, 30000);
                    }
                }, 500);
            }

            static initProshopDashboard() {
                // === PERFORMANCE OPTIMIZATION ===
                const cacheKey = 'proshop_dashboard_init';
                const cached = GlobalCacheManager.get(cacheKey);

                if (cached) {
                    console.log('[Dashboard] Using cached Proshop Dashboard (instant load)');
                    TabManager.showTab('proshopDashboard', 'pos');
                    UserInterface.updateUserDisplays();
                    return;
                }

                console.log('[Dashboard] First-time Proshop Dashboard init');
                TabManager.showTab('proshopDashboard', 'pos');
                UserInterface.updateUserDisplays();
                GlobalCacheManager.set(cacheKey, true, 30000);
            }

            static initMaintenanceDashboard() {
                // === PERFORMANCE OPTIMIZATION ===
                const cacheKey = 'maintenance_dashboard_init';
                const cached = GlobalCacheManager.get(cacheKey);

                if (cached) {
                    console.log('[Dashboard] Using cached Maintenance Dashboard (instant load)');
                    TabManager.showTab('maintenanceDashboard', 'overview');
                    UserInterface.updateUserDisplays();
                    return;
                }

                console.log('[Dashboard] First-time Maintenance Dashboard init');
                TabManager.showTab('maintenanceDashboard', 'overview');
                UserInterface.updateUserDisplays();
                GlobalCacheManager.set(cacheKey, true, 30000);
            }

            static initSocietyOrganizerDashboard() {
                console.log('[ScreenManager] Initializing Society Organizer Dashboard');
                if (typeof SocietyOrganizerSystem !== 'undefined') {
                    SocietyOrganizerSystem.init();
                } else {
                    console.error('[ScreenManager] SocietyOrganizerSystem not found');
                }
            }

            static goBack() {
                if (AppState.navigation.lastScreen) {
                    this.showScreen(AppState.navigation.lastScreen);
                }
            }
        }

        // Tab Management System
        class TabManager {
            static showTab(dashboardId, tabName, event = null) {
                try {
                    console.log(`TabManager: Switching to ${tabName} in ${dashboardId}`);

                    // Update tab button states
                    const tabButtons = document.querySelectorAll(`#${dashboardId} .tab-button`);
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });

                    // Activate clicked tab button
                    if (event && event.currentTarget) {
                        // Use currentTarget to always get the button, not nested spans
                        event.currentTarget.classList.add('active');
                    } else {
                        // Find and activate tab button by onclick attribute
                        const targetBtn = document.querySelector(`#${dashboardId} .tab-button[onclick*="${tabName}"]`);
                        if (targetBtn) {
                            targetBtn.classList.add('active');
                        }
                    }

                    // Hide all tab content
                    const tabContents = document.querySelectorAll(`#${dashboardId} .tab-content`);
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                    });

                    // Show target tab content
                    const targetContent = document.getElementById(`${dashboardId.replace('Dashboard', '')}-${tabName}`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                        AppState.navigation.activeTab = tabName;

                        // Load tab-specific data
                        this.loadTabData(dashboardId, tabName);
                    } else {
                        console.warn(`Tab content '${dashboardId.replace('Dashboard', '')}-${tabName}' not found`);
                    }

                } catch (error) {
                    console.error('TabManager Error:', error);
                    NotificationManager.show('Tab switching error', 'error');
                }
            }

            static loadTabData(dashboardId, tabName) {
                console.log(`Loading data for ${dashboardId}:${tabName}`);

                // Load tab-specific data
                if (dashboardId === 'golferDashboard' && tabName === 'overview') {
                    // Load promotional caddies for golf course promotion
                    setTimeout(() => {
                        loadPromotionalCaddys();

                        // Update GPS data for Live Course Status
                        if (typeof calculateDistances === 'function') {
                            calculateDistances();
                        }
                        if (typeof updateHoleDisplay === 'function') {
                            updateHoleDisplay();
                        }
                    }, 100);
                }

                // Update order status tab when shown
                if (dashboardId === 'golferDashboard' && tabName === 'status') {
                    setTimeout(() => {
                        updateOrderStatusTab();
                    }, 100);
                }

                // Initialize schedule tab when shown
                if (dashboardId === 'golferDashboard' && tabName === 'schedule') {
                    // Immediate render
                    ScheduleSystem.renderScheduleList();
                    console.log('[TabManager] Schedule rendered immediately on tab switch');

                    // Backup renders to catch async loading
                    setTimeout(() => {
                        ScheduleSystem.renderScheduleList();
                        console.log('[TabManager] Schedule re-rendered at 100ms');
                    }, 100);

                    setTimeout(() => {
                        ScheduleSystem.renderScheduleList();
                        console.log('[TabManager] Schedule re-rendered at 300ms');
                    }, 300);
                }

                // Initialize booking tab when shown
                if (dashboardId === 'golferDashboard' && tabName === 'booking') {
                    setTimeout(() => {
                        initializeBookingSystem();
                        initializeBookingCart();
                    }, 100);
                }

                // Initialize GPS tab when shown
                if (dashboardId === 'golferDashboard' && tabName === 'gps') {
                    setTimeout(() => {
                        // Initialize map first
                        if (document.getElementById('courseMap')) {
                            if (typeof initOpenStreetMap === 'function' && !window.googleMap) {
                                initOpenStreetMap();
                            }
                        }
                        // Start GPS tracking only if not already active
                        if (window.GPSNavigationSystem && !window.GPSNavigationSystem.trackingActive) {
                            if (typeof startGPSTracking === 'function') {
                                startGPSTracking();
                            }
                        }
                    }, 100);
                }

                // Initialize Food & Dining tab when shown
                if (dashboardId === 'golferDashboard' && tabName === 'food') {
                    // Immediate render
                    if (typeof renderFoodMenu === 'function') {
                        renderFoodMenu();
                        console.log('[TabManager] Food menu rendered immediately on tab switch');
                    }

                    // Backup renders to catch async loading
                    setTimeout(() => {
                        if (typeof renderFoodMenu === 'function') {
                            renderFoodMenu();
                            console.log('[TabManager] Food menu re-rendered at 100ms');
                        }
                    }, 100);

                    setTimeout(() => {
                        if (typeof renderFoodMenu === 'function') {
                            renderFoodMenu();
                            console.log('[TabManager] Food menu re-rendered at 500ms');
                        }
                    }, 500);

                    setTimeout(() => {
                        if (typeof renderFoodMenu === 'function') {
                            renderFoodMenu();
                            console.log('[TabManager] Food menu re-rendered at 1000ms');
                        }
                    }, 1000);
                }

                // Initialize Live Scorecard tab when shown
                if (dashboardId === 'golferDashboard' && tabName === 'scorecard') {
                    setTimeout(() => {
                        if (window.LiveScorecardManager && typeof window.LiveScorecardManager.init === 'function') {
                            window.LiveScorecardManager.init();
                            console.log('[TabManager] Live Scorecard initialized');
                        } else {
                            console.warn('[TabManager] LiveScorecardManager not found or init() missing');
                        }
                    }, 100);
                }

                // Initialize Manager Dashboard tabs
                if (dashboardId === 'managerDashboard') {
                    if (tabName === 'staff') {
                        setTimeout(() => {
                            // Refresh staff directory
                            if (typeof StaffManagement !== 'undefined' && StaffManagement.renderStaffList) {
                                StaffManagement.renderStaffList();
                            }
                            console.log('[TabManager] Staff directory refreshed');
                        }, 100);
                    }

                    if (tabName === 'analytics') {
                        setTimeout(() => {
                            // Initialize analytics if available
                            console.log('[TabManager] Analytics tab loaded');
                        }, 100);
                    }

                    if (tabName === 'reports') {
                        setTimeout(() => {
                            // Initialize reports if available
                            console.log('[TabManager] Reports tab loaded');
                        }, 100);
                    }

                    if (tabName === 'traffic') {
                        setTimeout(() => {
                            // Initialize traffic monitor
                            if (typeof TrafficMonitor !== 'undefined' && TrafficMonitor.init) {
                                TrafficMonitor.updateLiveStatus();
                                console.log('[TabManager] Traffic monitor refreshed');
                            }
                        }, 100);
                    }

                    if (tabName === 'settings') {
                        setTimeout(() => {
                            if (typeof AdminPricingControl !== 'undefined' && AdminPricingControl.renderPricingDashboard) {
                                AdminPricingControl.renderPricingDashboard();
                                console.log('[TabManager] Admin Pricing Control rendered');
                            }
                        }, 100);
                    }

                    if (tabName === 'maintenance') {
                        setTimeout(() => {
                            if (typeof MaintenanceManagement !== 'undefined' && MaintenanceManagement.init) {
                                MaintenanceManagement.init();
                                console.log('[TabManager] Maintenance Management initialized');
                            }
                        }, 100);
                    }

                    if (tabName === 'weather') {
                        setTimeout(() => {
                            if (typeof WeatherIntegration !== 'undefined' && WeatherIntegration.init) {
                                WeatherIntegration.init();
                                console.log('[TabManager] Weather Integration initialized');
                            }
                        }, 100);
                    }
                }

                // Update persistent emergency alerts when switching to overview or pos (proshop default) tabs
                if (tabName === 'overview' || tabName === 'pos') {
                    setTimeout(() => {
                        PersistentEmergencyAlerts.updateAllOverviewAlerts();
                    }, 100);
                }
            }
        }

        // LINE Authentication System
        class LineAuthentication {
            static async initializeLIFF() {
                if (!LineConfig.liffId || LineConfig.liffId === 'liff-v2-your-liff-id-here') {
                    console.log('LINE LIFF not configured, showing fallback login');
                    this.showFallbackLogin();
                    return;
                }

                try {
                    await liff.init({ liffId: LineConfig.liffId });
                    console.log('LIFF initialized successfully');

                    if (liff.isLoggedIn()) {
                        console.log('[LINE] Already logged in, auto-proceeding to dashboard...');
                        const profile = await liff.getProfile();
                        await this.setUserFromLineProfile(profile);
                        this.redirectToDashboard();
                    } else {
                        this.showLineLogin();
                    }
                } catch (error) {
                    console.error('LIFF initialization failed:', error);
                    this.showFallbackLogin();
                }
            }

            static async loginWithLINE() {
                try {
                    LoadingManager.show('Connecting to LINE...');

                    // Use direct LINE OAuth instead of LIFF
                    const LINE_CHANNEL_ID = '2008228481'; // Your LINE Login channel ID
                    const redirectUri = window.location.href.split('#')[0].split('?')[0];
                    const state = Math.random().toString(36).substring(7);

                    // Store state for verification
                    localStorage.setItem('line_oauth_state', state);

                    // Build LINE OAuth URL
                    const authUrl = new URL('https://access.line.me/oauth2/v2.1/authorize');
                    authUrl.searchParams.set('response_type', 'code');
                    authUrl.searchParams.set('client_id', LINE_CHANNEL_ID);
                    authUrl.searchParams.set('redirect_uri', redirectUri);
                    authUrl.searchParams.set('state', state);
                    authUrl.searchParams.set('scope', 'profile openid email');

                    console.log('[LINE OAuth] Redirecting to:', authUrl.toString());

                    // Redirect to LINE OAuth
                    window.location.href = authUrl.toString();
                } catch (error) {
                    console.error('LINE login failed:', error);
                    NotificationManager.show('LINE login failed. Please try again.', 'error');
                    LoadingManager.hide();
                }
            }

            static async setUserFromLineProfile(profile) {
                // SECURITY: Store LINE User ID for authorization
                const lineUserId = profile.userId;

                console.log('[LINE] Looking up profile for LINE user:', lineUserId);

                // Query Supabase DIRECTLY for this user's profile
                let userProfile = null;
                try {
                    if (window.SupabaseDB) {
                        await window.SupabaseDB.waitForReady();
                        userProfile = await window.SupabaseDB.getUserProfile(lineUserId);
                        console.log('[LINE] Supabase query result:', userProfile);
                    }
                } catch (err) {
                    console.error('[LINE] Failed to query Supabase:', err);
                }

                if (userProfile) {
                    // User has a profile - load it
                    console.log('[LINE] Profile found:', {
                        role: userProfile.role,
                        name: userProfile.name,
                        lineUserId: userProfile.line_user_id,
                        hasFullProfileData: !!userProfile.profile_data
                    });

                    AppState.currentUser = {
                        role: userProfile.role || 'golfer',
                        name: userProfile.name || profile.displayName,
                        username: userProfile.username || userProfile.name || profile.displayName || 'User',
                        lineId: lineUserId,
                        lineUserId: lineUserId,
                        userId: lineUserId, // UNIQUE ID - Use lineUserId as primary unique identifier (INTERNAL ONLY, NEVER DISPLAY TO USER)
                        avatar: profile.pictureUrl,
                        email: userProfile.email,
                        phone: userProfile.phone,
                        handicap: userProfile.profile_data?.handicap || null,
                        membershipLevel: userProfile.role === 'golfer' ? 'premium' : 'staff',
                        joinDate: userProfile.created_at || new Date().toISOString(),
                        stats: {},
                        permissions: this.getPermissions(userProfile.role || 'golfer'),
                        profileData: userProfile
                    };

                    // ===== FIX: Restore FULL profile to localStorage from Supabase =====
                    if (userProfile.profile_data) {
                        const profileKey = UserIDSystem.getProfileKey(userProfile.role, lineUserId);
                        const fullProfile = {
                            userId: lineUserId,
                            lineUserId: lineUserId,
                            username: userProfile.profile_data.username || userProfile.username || userProfile.name || profile.displayName || '',
                            linePictureUrl: userProfile.profile_data.linePictureUrl || profile.pictureUrl,
                            personalInfo: userProfile.profile_data.personalInfo || {},
                            golfInfo: userProfile.profile_data.golfInfo || {},
                            professionalInfo: userProfile.profile_data.professionalInfo || {},
                            skills: userProfile.profile_data.skills || {},
                            preferences: userProfile.profile_data.preferences || {},
                            media: userProfile.profile_data.media || {},
                            privacy: userProfile.profile_data.privacy || {}
                        };

                        localStorage.setItem(profileKey, JSON.stringify(fullProfile));
                        console.log('[LINE] ✅ Full profile restored to localStorage:', profileKey);
                        console.log('[LINE] FULL profile_data from Supabase:', JSON.stringify(userProfile.profile_data, null, 2));
                        console.log('[LINE] golfInfo object:', fullProfile.golfInfo);
                        console.log('[LINE] Handicap from Supabase:', fullProfile.golfInfo?.handicap);
                        console.log('[LINE] Home Club from Supabase:', fullProfile.golfInfo?.homeClub);

                        // CRITICAL: Also update mcipro_user_profiles array for 100% consistency
                        const profiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');
                        const existingIndex = profiles.findIndex(p => p.lineUserId === lineUserId || p.userId === lineUserId);

                        const profileSummary = {
                            userId: lineUserId,
                            lineUserId: lineUserId,
                            role: userProfile.role,
                            name: userProfile.name || profile.displayName,
                            username: fullProfile.username,
                            email: fullProfile.personalInfo?.email,
                            phone: fullProfile.personalInfo?.phone,
                            handicap: fullProfile.golfInfo?.handicap,
                            homeClub: fullProfile.golfInfo?.homeClub
                        };

                        if (existingIndex >= 0) {
                            profiles[existingIndex] = { ...profiles[existingIndex], ...profileSummary };
                        } else {
                            profiles.push(profileSummary);
                        }
                        localStorage.setItem('mcipro_user_profiles', JSON.stringify(profiles));
                        console.log('[LINE] ✅ Profile array also updated for consistency');

                        // Update Supabase if LINE picture URL is missing
                        if (!userProfile.profile_data.linePictureUrl && profile.pictureUrl) {
                            console.log('[LINE] Updating Supabase with LINE picture URL:', profile.pictureUrl);
                            const updatedProfileData = {
                                ...userProfile.profile_data,
                                linePictureUrl: profile.pictureUrl
                            };

                            window.SupabaseDB.client
                                .from('user_profiles')
                                .update({ profile_data: updatedProfileData })
                                .eq('line_user_id', lineUserId)
                                .then(({ error }) => {
                                    if (error) {
                                        console.error('[LINE] Failed to update picture URL:', error);
                                    } else {
                                        console.log('[LINE] ✅ LINE picture URL saved to Supabase');
                                    }
                                });
                        }
                    } else {
                        console.warn('[LINE] ⚠️ No profile_data in Supabase - profile NOT synced');
                    }

                    console.log('[LINE] ✓ Unique ID set:', {
                        userId: AppState.currentUser.userId,
                        profileKey: UserIDSystem.getProfileKey(AppState.currentUser.role, AppState.currentUser.userId)
                    });

                    AppState.session = {
                        isAuthenticated: true,
                        authMethod: 'line',
                        loginTime: new Date().toISOString()
                    };

                    console.log('[LINE] User logged in:', AppState.currentUser);
                } else {
                    // New user - auto-create basic profile
                    console.log('[LINE] No profile found - auto-creating basic profile for:', lineUserId);

                    try {
                        // Create basic golfer profile automatically
                        const newProfile = {
                            line_user_id: lineUserId,
                            role: 'golfer',
                            name: profile.displayName || 'Golfer',
                            username: '', // Leave blank - user will set their own username
                            profile_data: {
                                username: '', // Leave blank - user will set their own username
                                linePictureUrl: profile.pictureUrl,
                                personalInfo: {
                                    firstName: '',
                                    lastName: '',
                                    email: '',
                                    phone: ''
                                },
                                golfInfo: {
                                    handicap: 0,
                                    homeClub: '',
                                    clubAffiliation: ''
                                },
                                professionalInfo: {},
                                skills: {},
                                preferences: {},
                                media: {},
                                privacy: {}
                            }
                        };

                        // Insert into Supabase using SECURITY DEFINER function (bypasses RLS)
                        if (window.SupabaseDB) {
                            await window.SupabaseDB.waitForReady();

                            // Try using RPC function first (bypasses RLS issues)
                            let data, error;
                            try {
                                const result = await window.SupabaseDB.client
                                    .rpc('create_user_profile', {
                                        p_line_user_id: lineUserId,
                                        p_name: profile.displayName || 'Golfer',
                                        p_role: 'golfer',
                                        p_profile_data: newProfile.profile_data
                                    });

                                data = result.data;
                                error = result.error;

                                if (!error) {
                                    console.log('[LINE] ✅ Profile created via RPC function');
                                }
                            } catch (rpcError) {
                                console.warn('[LINE] RPC function not available, trying direct INSERT:', rpcError);
                                // Fallback to direct INSERT
                                const result = await window.SupabaseDB.client
                                    .from('user_profiles')
                                    .insert([newProfile])
                                    .select()
                                    .single();

                                data = result.data;
                                error = result.error;
                            }

                            if (error) {
                                console.error('[LINE] Failed to create auto-profile:', error);
                                console.error('[LINE] Error details:', JSON.stringify(error, null, 2));
                                // Fallback to manual profile creation
                                localStorage.setItem('pending_line_profile', JSON.stringify({
                                    lineUserId: lineUserId,
                                    displayName: profile.displayName,
                                    pictureUrl: profile.pictureUrl
                                }));
                                ScreenManager.showScreen('createProfileScreen');
                                NotificationManager.show('Welcome! Please create your profile to continue.', 'info');
                                LoadingManager.hide();
                                return;
                            }

                            console.log('[LINE] ✅ Auto-profile created:', data);

                            // Now set user from the newly created profile
                            userProfile = data;

                            // Set AppState
                            AppState.currentUser = {
                                role: 'golfer',
                                name: profile.displayName || 'Golfer',
                                username: data.username || data.name || profile.displayName || 'User',
                                lineId: lineUserId,
                                lineUserId: lineUserId,
                                userId: lineUserId,
                                avatar: profile.pictureUrl,
                                email: null,
                                phone: null,
                                handicap: 0,
                                membershipLevel: 'premium',
                                joinDate: new Date().toISOString(),
                                stats: {},
                                permissions: this.getPermissions('golfer'),
                                profileData: data
                            };

                            // Save to localStorage
                            const profileKey = UserIDSystem.getProfileKey('golfer', lineUserId);
                            localStorage.setItem(profileKey, JSON.stringify(newProfile.profile_data));

                            // Update profiles array
                            const profiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');
                            profiles.push({
                                userId: lineUserId,
                                lineUserId: lineUserId,
                                role: 'golfer',
                                name: profile.displayName || 'Golfer',
                                username: data.username || '', // Leave blank if not set
                                handicap: 0
                            });
                            localStorage.setItem('mcipro_user_profiles', JSON.stringify(profiles));

                            AppState.session = {
                                isAuthenticated: true,
                                authMethod: 'line',
                                loginTime: new Date().toISOString()
                            };

                            console.log('[LINE] ✅ New user auto-logged in:', AppState.currentUser);
                            NotificationManager.show(`Welcome ${profile.displayName}!`, 'success');
                        }
                    } catch (error) {
                        console.error('[LINE] Auto-profile creation failed:', error);
                        // Fallback to manual
                        localStorage.setItem('pending_line_profile', JSON.stringify({
                            lineUserId: lineUserId,
                            displayName: profile.displayName,
                            pictureUrl: profile.pictureUrl
                        }));
                        ScreenManager.showScreen('createProfileScreen');
                        NotificationManager.show('Welcome! Please create your profile to continue.', 'info');
                        LoadingManager.hide();
                        return;
                    }
                }
            }

            static redirectToDashboard() {
                console.log('[redirectToDashboard] Called with user:', AppState.currentUser);

                const dashboardMap = {
                    'golfer': 'golferDashboard',
                    'caddie': 'caddieDashboard',
                    'manager': 'managerDashboard',
                    'proshop': 'proshopDashboard',
                    'society_organizer': 'societyOrganizerDashboard',
                    'maintenance': 'maintenanceDashboard'
                };

                const targetDashboard = dashboardMap[AppState.currentUser.role] || 'golferDashboard';
                console.log('[redirectToDashboard] Redirecting to:', targetDashboard, 'for role:', AppState.currentUser.role);
                ScreenManager.showScreen(targetDashboard);

                const userName = AppState.currentUser.name || AppState.currentUser.displayName || 'User';

                // Update UI with user data
                if (typeof UserInterface !== 'undefined' && UserInterface.updateUserDisplays) {
                    UserInterface.updateUserDisplays();
                }

                NotificationManager.show(`Welcome back, ${userName}!`, 'success');
                // Enable dev mode panel after login                if (typeof DevMode !== 'undefined') {                    DevMode.init(); // Re-check after user is logged in                }

                // Load data from Cloudflare AFTER successful login (source of truth)
                if (typeof ProductionCloudSync !== 'undefined') {
                    console.log('[Login] Loading data from Cloudflare after login...');
                    SimpleCloudSync.loadFromCloud();
                    console.log('[Login] Initial production sync completed');
                }
            }

            static getPermissions(role) {
                const permissionMap = {
                    'golfer': ['book_tee_time', 'view_stats', 'order_food', 'book_caddy', 'emergency_alert'],
                    'caddie': ['view_assignments', 'update_location', 'submit_reports', 'emergency_alert'],
                    'manager': ['manage_staff', 'view_reports', 'manage_bookings', 'manage_inventory', 'emergency_broadcast'],
                    'proshop': ['manage_inventory', 'process_payments', 'view_sales', 'emergency_alert'],
                    'society': ['organize_events', 'manage_bookings', 'member_communication', 'view_reports', 'emergency_alert']
                };
                return permissionMap[role] || [];
            }

            static showLineLogin() {
                const lineContainer = document.getElementById('lineLoginContainer');
                const fallbackContainer = document.getElementById('fallbackLoginContainer');

                // SHOW BOTH - let user choose
                if (lineContainer) lineContainer.style.display = 'block';
                if (fallbackContainer) fallbackContainer.style.display = 'block';
            }

            static showFallbackLogin() {
                const lineContainer = document.getElementById('lineLoginContainer');
                const fallbackContainer = document.getElementById('fallbackLoginContainer');

                // SHOW BOTH - let user choose
                if (lineContainer) lineContainer.style.display = 'block';
                if (fallbackContainer) fallbackContainer.style.display = 'block';
            }

            static logout() {
                try {
                    if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                        liff.logout();
                    }
                } catch (error) {
                    console.error('LINE logout error:', error);
                }

                // Reset application state
                AppState.currentUser = {
                    role: 'guest',
                    name: 'Guest User',
                    lineId: null,
                    avatar: null,
                    email: null,
                    phone: null,
                    handicap: null,
                    membershipLevel: 'basic',
                    joinDate: null,
                    stats: {
                        totalRounds: 0,
                        averageScore: 0,
                        bestScore: 0,
                        totalEarnings: 0,
                        rating: 0
                    },
                    permissions: [],
                    preferences: {
                            gpsTracking: true,
                        emergencyContacts: []
                    }
                };

                AppState.session.isAuthenticated = false;
                AppState.session.authMethod = null;
                AppState.session.loginTime = null;

                ScreenManager.showScreen('loginScreen');
                NotificationManager.show('Logged out successfully', 'info');
            }
        }

        // OTP Authentication System
        class OTPAuthentication {
            static currentPhoneNumber = null;
            static otpCode = null;

            static showOTPScreen() {
                ScreenManager.showScreen('otpScreen');
            }

            static async sendOTP() {
                const phoneInput = document.getElementById('phoneInput');
                const phone = phoneInput?.value;

                if (!phone || phone.length < 10) {
                    NotificationManager.show('Please enter a valid phone number', 'error');
                    return;
                }

                this.currentPhoneNumber = phone;
                LoadingManager.show('Sending OTP...');

                try {
                    // Simulate OTP sending with realistic delay
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    // Generate random OTP for demo
                    this.otpCode = '123456'; // In production, this would be sent via SMS

                    NotificationManager.show(`OTP sent to ${phone}`, 'success');

                    // Show OTP input section
                    const otpSection = document.getElementById('otpInputSection');
                    if (otpSection) {
                        otpSection.classList.remove('hidden');

                        // Focus first OTP input
                        const firstInput = document.querySelector('.otp-input');
                        if (firstInput) {
                            firstInput.focus();
                        }
                    }

                    // Update button text
                    const sendBtn = document.getElementById('sendOTPBtn');
                    if (sendBtn) {
                        sendBtn.textContent = 'Resend OTP';
                    }

                } catch (error) {
                    console.error('OTP sending failed:', error);
                    NotificationManager.show('Failed to send OTP. Please try again.', 'error');
                } finally {
                    LoadingManager.hide();
                }
            }

            static async verifyOTP() {
                const otpInputs = document.querySelectorAll('.otp-input');
                const enteredOTP = Array.from(otpInputs).map(input => input.value).join('');

                if (enteredOTP.length !== 6) {
                    NotificationManager.show('Please enter complete OTP code', 'error');
                    return;
                }

                LoadingManager.show('Verifying OTP...');

                try {
                    // Simulate verification delay
                    await new Promise(resolve => setTimeout(resolve, 1500));

                    if (enteredOTP === this.otpCode) {
                        // Check if this phone number already has a userId in localStorage
                        const phoneKey = `phone_userId_${this.currentPhoneNumber}`;
                        let existingUserId = localStorage.getItem(phoneKey);

                        // Generate or reuse UUID for OTP users
                        if (!existingUserId) {
                            existingUserId = UserIDSystem.generateUUID();
                            localStorage.setItem(phoneKey, existingUserId);
                            console.log('[OTP] ✓ Generated new UUID for phone:', this.currentPhoneNumber, '→', existingUserId.substring(0, 12) + '...');
                        } else {
                            console.log('[OTP] ✓ Reusing existing UUID for phone:', this.currentPhoneNumber, '→', existingUserId.substring(0, 12) + '...');
                        }

                        // Set user data for OTP authentication
                        AppState.currentUser = {
                            ...AppState.currentUser,
                            role: 'golfer', // Default to golfer for OTP users
                            name: 'Mobile User',
                            userId: existingUserId, // UNIQUE ID - UUID for OTP users
                            phone: this.currentPhoneNumber,
                            membershipLevel: 'basic',
                            joinDate: new Date().toISOString(),
                            permissions: LineAuthentication.getPermissions('golfer')
                        };

                        console.log('[OTP] ✓ Unique ID set:', {
                            userId: AppState.currentUser.userId.substring(0, 12) + '...',
                            phone: this.currentPhoneNumber,
                            profileKey: UserIDSystem.getProfileKey('golfer', existingUserId)
                        });

                        AppState.session.isAuthenticated = true;
                        AppState.session.authMethod = 'otp';
                        AppState.session.loginTime = new Date().toISOString();

                        NotificationManager.show('Phone verified successfully!', 'success');
                        ScreenManager.showScreen('golferDashboard');

                    } else {
                        NotificationManager.show('Invalid OTP code. Please try again.', 'error');

                        // Clear OTP inputs
                        otpInputs.forEach(input => input.value = '');
                        otpInputs[0]?.focus();
                    }

                } catch (error) {
                    console.error('OTP verification failed:', error);
                    NotificationManager.show('Verification failed. Please try again.', 'error');
                } finally {
                    LoadingManager.hide();
                }
            }

            static setupOTPInputHandlers() {
                const otpInputs = document.querySelectorAll('.otp-input');

                otpInputs.forEach((input, index) => {
                    // Auto-advance to next input
                    input.addEventListener('input', function() {
                        if (this.value.length === 1 && index < otpInputs.length - 1) {
                            otpInputs[index + 1].focus();
                        }

                        // Auto-verify when all inputs are filled
                        const allFilled = Array.from(otpInputs).every(inp => inp.value.length === 1);
                        if (allFilled) {
                            setTimeout(() => OTPAuthentication.verifyOTP(), 500);
                        }
                    });

                    // Handle backspace
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Backspace' && this.value === '' && index > 0) {
                            otpInputs[index - 1].focus();
                        }
                    });

                    // Only allow numbers
                    input.addEventListener('input', function() {
                        this.value = this.value.replace(/[^0-9]/g, '');
                    });
                });
            }
        }

        // Fallback Authentication System
        class FallbackAuthentication {
            static login(role) {
                LoadingManager.show('Authenticating...');

                setTimeout(() => {
                    const userProfiles = {
                        'golfer': {
                            name: 'John Mitchell',
                            handicap: 18,
                            stats: { totalRounds: 0, averageScore: 0, bestScore: 0 }
                        },
                        'caddie': {
                            name: 'Ning',
                            stats: { totalRounds: 0, rating: 0, totalEarnings: 0 }
                        },
                        'manager': {
                            name: 'Sarah Wilson',
                            stats: { totalReports: 0, staffManaged: 0, revenue: 0 }
                        },
                        'proshop': {
                            name: 'Robert Chen',
                            stats: { totalSales: 0, itemsSold: 0, revenue: 0 }
                        },
                        'society': {
                            name: 'Bangkok Golf Society',
                            organizer: 'Alex Thompson',
                            members: 0,
                            stats: { eventsOrganized: 0, totalMembers: 0 }
                        },
                        'maintenance': {
                            name: 'Tom Rodriguez',
                            role: 'Head Groundskeeper',
                            team: 'Course Maintenance',
                            shift: 'Morning Crew',
                            stats: { tasksCompleted: 0, reportsSubmitted: 0 }
                        }
                    };

                    const profile = userProfiles[role];

                    // Check if this dev user already has a UUID stored
                    const devUserKey = `dev_userId_${role}`;
                    let devUserId = localStorage.getItem(devUserKey);

                    // Generate or reuse UUID for dev users
                    if (!devUserId) {
                        devUserId = UserIDSystem.generateUUID();
                        localStorage.setItem(devUserKey, devUserId);
                        console.log('[DevMode] ✓ Generated new UUID for role:', role, '→', devUserId.substring(0, 12) + '...');
                    } else {
                        console.log('[DevMode] ✓ Reusing existing UUID for role:', role, '→', devUserId.substring(0, 12) + '...');
                    }

                    AppState.currentUser = {
                        role: role,
                        name: profile.name,
                        username: role + '_user',
                        lineId: null,
                        lineUserId: null,
                        userId: devUserId, // UNIQUE ID - UUID for dev mode users
                        avatar: null,
                        email: null,
                        phone: null,
                        handicap: profile.handicap || null,
                        membershipLevel: role === 'golfer' ? 'premium' : 'staff',
                        joinDate: new Date().toISOString(),
                        stats: profile.stats || {},
                        permissions: LineAuthentication.getPermissions(role)
                    };

                    console.log('[DevMode] ✓ Unique ID set:', {
                        role: role,
                        userId: devUserId.substring(0, 12) + '...',
                        profileKey: UserIDSystem.getProfileKey(role, devUserId)
                    });

                    AppState.session = {
                        isAuthenticated: true,
                        authMethod: 'fallback',
                        loginTime: new Date().toISOString()
                    };

                    console.log('[FallbackAuth] User set:', AppState.currentUser);

                    LoadingManager.hide();

                    // Update UI with user data
                    if (typeof UserInterface !== 'undefined' && UserInterface.updateUserDisplays) {
                        UserInterface.updateUserDisplays();
                    }

                    // Navigate to dashboard
                    const dashboardMap = {
                        'golfer': 'golferDashboard',
                        'caddie': 'caddieDashboard',
                        'manager': 'managerDashboard',
                        'proshop': 'proshopDashboard',
                        'society_organizer': 'societyOrganizerDashboard',
                        'maintenance': 'maintenanceDashboard'
                    };
                    const targetDashboard = dashboardMap[role] || 'golferDashboard';
                    console.log('[FallbackAuth] Navigating to:', targetDashboard, 'for role:', role);
                    ScreenManager.showScreen(targetDashboard);
                    NotificationManager.show(`Welcome, ${profile.name}!`, 'success');

                }, 1500);
            }
        }

        // Expose FallbackAuthentication to window for Auth system
        window.FallbackAuthentication = FallbackAuthentication;

        // Notification Management System (Disabled - Notifications removed per user request)
        class NotificationManager {
            static show(message, type = 'info', duration = null) {
                // Notifications disabled - logging to console instead
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }

        // Loading Management System
        class LoadingManager {
            static show(message = 'Loading...') {
                let overlay = document.getElementById('loadingOverlay');

                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'loadingOverlay';
                    overlay.className = 'loading-overlay';
                    document.body.appendChild(overlay);
                }

                overlay.innerHTML = `
                    <div class="glass-card p-8 text-center max-w-sm">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-700 font-semibold">${message}</p>
                    </div>
                `;

                overlay.style.display = 'flex';
            }

            static hide() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }
        }

        // User Interface Management
        class UserInterface {
            static updateUserDisplays() {
                // Update user name displays
                const nameElements = document.querySelectorAll('.user-name-display');
                nameElements.forEach(element => {
                    element.textContent = AppState.currentUser.name;
                });

                // Update username displays
                const usernameElements = document.querySelectorAll('.user-username-display');
                usernameElements.forEach(element => {
                    if (AppState.currentUser.username) {
                        element.textContent = AppState.currentUser.username;
                    } else {
                        element.textContent = '';
                    }
                });

                // Update user avatars
                const avatarElements = document.querySelectorAll('.user-avatar');
                avatarElements.forEach(element => {
                    if (AppState.currentUser.avatar) {
                        element.src = AppState.currentUser.avatar;
                        element.style.display = 'block';
                    } else {
                        element.style.display = 'none';
                    }
                });

                // Update role-specific displays
                this.updateRoleSpecificDisplays();
            }

            static updateRoleSpecificDisplays() {
                const role = AppState.currentUser.role;

                // Update handicap displays for golfers
                if (role === 'golfer' && AppState.currentUser.handicap) {
                    const handicapElements = document.querySelectorAll('.user-handicap');
                    handicapElements.forEach(element => {
                        element.textContent = AppState.currentUser.handicap;
                    });
                }

                // Update rating displays for caddies
                if (role === 'caddie' && AppState.currentUser.stats.rating) {
                    const ratingElements = document.querySelectorAll('.user-rating');
                    ratingElements.forEach(element => {
                        element.textContent = AppState.currentUser.stats.rating;
                    });
                }

                // Update club affiliation displays
                if (role === 'golfer' && AppState.currentUser.profileData) {
                    const affiliation = AppState.currentUser.profileData.roleSpecific?.clubAffiliation ||
                                      AppState.currentUser.profileData.golfInfo?.clubAffiliation;
                    if (affiliation) {
                        const affiliationContainers = document.querySelectorAll('.club-affiliation-container');
                        affiliationContainers.forEach(container => {
                            const affiliationElement = container.querySelector('.club-affiliation');
                            if (affiliationElement) {
                                affiliationElement.textContent = affiliation;
                                container.style.display = 'inline';
                            }
                        });
                    }
                }
            }
        }

        // Enhanced Emergency & Safety System
        class EmergencySystem {
            static emergencyTypes = {
                medical: {
                    name: 'Medical Emergency',
                    icon: '🚑',
                    color: 'red',
                    priority: 'critical',
                    responseTime: '2-5 minutes',
                    contacts: ['Pro Shop', 'Caddy Master', 'All Management'],
                    targetRoles: ['golfer', 'proshop', 'manager', 'caddie', 'maintenance']
                },
                lightning_warning: {
                    name: 'Lightning Warning',
                    icon: '⚡',
                    color: 'yellow',
                    priority: 'critical',
                    responseTime: 'Immediate',
                    contacts: ['All Golfers', 'All Caddies', 'All Staff Members'],
                    targetRoles: ['golfer', 'caddie', 'manager', 'proshop', 'maintenance'],
                    authorizedRoles: ['manager', 'proshop'],
                    description: 'Lightning detected - seek shelter immediately'
                },
                stop_play: {
                    name: 'STOP PLAY - Lightning Alert',
                    icon: '🛑',
                    color: 'red',
                    priority: 'critical',
                    responseTime: 'Immediate',
                    contacts: ['All Golfers', 'All Caddies', 'All Staff Members'],
                    targetRoles: ['golfer', 'caddie', 'manager', 'proshop', 'maintenance'],
                    authorizedRoles: ['manager', 'proshop'],
                    description: 'IMMEDIATE STOP PLAY - Lightning present, evacuate to clubhouse'
                },
                resume_play: {
                    name: 'Resume Play',
                    icon: '✅',
                    color: 'green',
                    priority: 'high',
                    responseTime: 'Immediate',
                    contacts: ['All Golfers', 'All Caddies', 'All Staff Members'],
                    targetRoles: ['golfer', 'caddie', 'manager', 'proshop', 'maintenance'],
                    authorizedRoles: ['manager', 'proshop'],
                    description: 'All clear - play may resume safely'
                },
                weather: {
                    name: 'Severe Weather',
                    icon: '⛈️',
                    color: 'orange',
                    priority: 'high',
                    responseTime: '1-2 minutes',
                    contacts: ['Pro Shop', 'Caddy Master', 'General Manager', 'All Management'],
                    targetRoles: ['golfer', 'proshop', 'manager', 'caddie', 'maintenance']
                },
                security: {
                    name: 'Security Issue',
                    icon: '🛡️',
                    color: 'yellow',
                    priority: 'high',
                    responseTime: '3-5 minutes',
                    contacts: ['Pro Shop', 'Caddy Master', 'General Manager', 'All Management'],
                    targetRoles: ['golfer', 'proshop', 'manager', 'caddie', 'maintenance']
                },
                equipment: {
                    name: 'Equipment/Cart Issue',
                    icon: '🚗',
                    color: 'blue',
                    priority: 'medium',
                    responseTime: '5-10 minutes',
                    contacts: ['Cart and Mechanic Staff', 'Pro Shop', 'Caddy Master'],
                    targetRoles: ['golfer', 'proshop', 'caddie', 'maintenance', 'manager']
                },
                cart_path_only: {
                    name: 'Cart Path Only',
                    icon: '🛤️',
                    color: 'blue',
                    priority: 'high',
                    responseTime: 'Immediate',
                    contacts: ['All Golfers', 'All Caddies', 'Pro Shop'],
                    targetRoles: ['golfer', 'caddie', 'proshop', 'manager'],
                    authorizedRoles: ['manager', 'proshop'],
                    description: 'Carts restricted to paths only - no driving on fairways'
                },
                carts_on_fairways: {
                    name: 'Carts Allowed on Fairways',
                    icon: '⛳',
                    color: 'green',
                    priority: 'medium',
                    responseTime: 'Immediate',
                    contacts: ['All Golfers', 'All Caddies', 'Pro Shop'],
                    targetRoles: ['golfer', 'caddie', 'proshop', 'manager'],
                    authorizedRoles: ['manager', 'proshop'],
                    description: 'Carts permitted on fairways - please observe 90-degree rule'
                },
                lost: {
                    name: 'Lost/Assistance',
                    icon: '📍',
                    color: 'green',
                    priority: 'low',
                    responseTime: '5-10 minutes',
                    contacts: ['Caddy Master', 'Pro Shop'],
                    targetRoles: ['caddie', 'proshop']
                }
            };

            static activeAlerts = [];
            static emergencyContacts = {
                medical: { name: 'Emergency Medical', phone: '1669', location: 'On-site Medical Center' },
                manager: { name: 'Course Manager', phone: '+66-2-555-0001', location: 'Clubhouse Office' },
                security: { name: 'Security', phone: '+66-2-555-0002', location: 'Main Gate' },
                marshal: { name: 'Course Marshal', phone: '+66-2-555-0003', location: 'Mobile Unit' },
                proshop: { name: 'Pro Shop', phone: '+66-2-555-0004', location: 'Pro Shop Counter' },
                maintenance: { name: 'Maintenance', phone: '+66-2-555-0005', location: 'Equipment Shed' }
            };

            static safetyZones = [
                { name: 'Main Clubhouse', lat: 13.7560, lng: 100.5015, capacity: 200, facilities: ['Medical', 'Shelter', 'Food'] },
                { name: 'Halfway House', lat: 13.7625, lng: 100.5095, capacity: 50, facilities: ['Shelter', 'Refreshments'] },
                { name: 'Practice Facility', lat: 13.7555, lng: 100.5010, capacity: 30, facilities: ['Shelter'] },
                { name: 'Maintenance Building', lat: 13.7700, lng: 100.5180, capacity: 20, facilities: ['Shelter', 'Tools'] }
            ];

            static sendAlert(alertType = null) {
                if (alertType) {
                    this.sendSpecificAlert(alertType);
                } else {
                    this.showEmergencyModal();
                }
            }

            static showEmergencyModal() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl w-full max-w-md h-[90vh] md:max-h-[90vh] flex flex-col">
                        <div class="text-center p-4 md:p-6 pb-3 md:pb-4 flex-shrink-0">
                            <div class="w-16 h-16 md:w-20 md:h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3 md:mb-4">
                                <span class="material-symbols-outlined text-2xl md:text-4xl text-red-600">emergency</span>
                            </div>
                            <h3 class="text-lg md:text-xl font-bold text-gray-900" data-i18n="emergency.alert">Emergency Alert</h3>
                            <p class="text-sm md:text-base text-gray-600 mt-2" data-i18n="emergency.select.type">Select the type of assistance you need</p>
                        </div>

                        <div class="flex-1 overflow-y-auto px-4 md:px-6 pb-4" style="min-height: 0;">
                            <div class="space-y-2 md:space-y-3">
                            ${Object.entries(this.emergencyTypes).map(([key, type]) => {
                                // Check if user is authorized to send this type of alert
                                const userRole = AppState.currentUser.role;
                                const isAuthorized = !type.authorizedRoles || type.authorizedRoles.includes(userRole);

                                if (!isAuthorized) return ''; // Don't show unauthorized alerts

                                return `
                                <div class="emergency-type p-3 md:p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-${type.color}-500 active:border-${type.color}-500 transition-colors"
                                     onclick="EmergencySystem.sendSpecificAlert('${key}')">
                                    <div class="flex items-start md:items-center">
                                        <span class="text-xl md:text-2xl mr-2 md:mr-3 flex-shrink-0">${type.icon}</span>
                                        <div class="flex-1 min-w-0">
                                            <h5 class="font-bold text-sm md:text-base text-gray-900">${type.name}</h5>
                                            <p class="text-xs md:text-sm text-gray-600">Response: ${type.responseTime}</p>
                                            ${type.description ? `<p class="text-xs text-gray-500 mt-1 line-clamp-2">${type.description}</p>` : ''}
                                        </div>
                                        <span class="priority-badge bg-${type.color}-100 text-${type.color}-800 px-1.5 md:px-2 py-0.5 md:py-1 rounded-full text-xs font-medium ml-2 flex-shrink-0">
                                            ${type.priority}
                                        </span>
                                    </div>
                                </div>
                                `;
                            }).filter(Boolean).join('')}
                            </div>
                        </div>

                        <div class="flex space-x-2 md:space-x-3 p-4 md:p-6 pt-3 md:pt-4 border-t border-gray-200 flex-shrink-0">
                            <button onclick="EmergencySystem.closeEmergencyModal()" class="btn-secondary flex-1 text-sm md:text-base py-2 md:py-2.5" data-i18n="common.cancel">Cancel</button>
                            <button onclick="EmergencySystem.showSafetyInfo()" class="btn-primary flex-1 text-sm md:text-base py-2 md:py-2.5" data-i18n="emergency.safety.info">Safety Info</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                window.currentEmergencyModal = modal;
            }

            static sendSpecificAlert(alertType) {
                const type = this.emergencyTypes[alertType];
                if (!type) return;

                this.closeEmergencyModal();

                // IMMEDIATE PROCESSING - NO DELAYS FOR EMERGENCIES
                const alertId = 'EMG' + Date.now().toString().slice(-6);
                const currentLocation = GPSNavigationSystem?.currentPosition;

                const alertData = {
                    id: alertId,
                    type: alertType,
                    message: `${type.name} at ${new Date().toLocaleTimeString()}`,
                    user: AppState.currentUser.name,
                    role: AppState.currentUser.role,
                    timestamp: new Date().toISOString(),
                    location: currentLocation ? {
                        lat: currentLocation.lat,
                        lng: currentLocation.lng,
                        hole: GPSNavigationSystem.currentHole
                    } : null,
                    status: 'active',
                    priority: type.priority
                };

                this.activeAlerts.push(alertData);
                console.log('[Emergency] IMMEDIATE alert created:', alertData);

                // 1. IMMEDIATE full-screen overlay with siren
                this.createFullScreenEmergencyOverlay(alertData);
                this.playEmergencySiren();

                // 2. IMMEDIATE save to localStorage
                localStorage.setItem('emergency_alerts', JSON.stringify(this.activeAlerts));

                // 3. IMMEDIATE save to Supabase for cross-device sync - NO DELAYS
                console.log('[Emergency] 💾 Attempting to save alert to Supabase:', alertData);
                if (typeof window.SupabaseDB !== 'undefined') {
                    console.log('[Emergency] ✅ SupabaseDB is defined, saving now...');
                    window.SupabaseDB.saveEmergencyAlert(alertData)
                        .then((savedAlert) => {
                            console.log('[Emergency] ✅ IMMEDIATE Supabase sync completed successfully!');
                            console.log('[Emergency] 📤 Saved alert data:', savedAlert);
                        })
                        .catch(err => {
                            console.error('[Emergency] ❌ Supabase save failed:', err);
                            console.error('[Emergency] Error details:', JSON.stringify(err, null, 2));
                            // Still saved to localStorage, so alert works locally
                            NotificationManager.show('Alert sent locally (cloud sync pending)', 'warning');
                        });
                } else {
                    console.error('[Emergency] ❌ SupabaseDB is NOT defined! Cannot save to cloud!');
                }

                // 4. Update all systems immediately
                PersistentEmergencyAlerts.updateAllOverviewAlerts();
                window.dispatchEvent(new CustomEvent('emergency-alert-sent', { detail: alertData }));

                // 5. Success notification
                NotificationManager.show(`${type.icon} ${type.name} EMERGENCY ALERT SENT!`, 'success');

                // 6. Show instructions after a brief delay
                setTimeout(() => this.showEmergencyInstructions(alertType, alertId), 1000);
            }

            static showEmergencyInstructions(alertType, alertId) {
                const type = this.emergencyTypes[alertType];
                const instructions = this.getEmergencyInstructions(alertType);

                setTimeout(() => {
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
                            <div class="text-center mb-6">
                                <span class="text-4xl">${type.icon}</span>
                                <h3 class="text-xl font-bold text-gray-900 mt-2">Alert Sent Successfully</h3>
                                <p class="text-sm text-gray-600">ID: ${alertId}</p>
                            </div>

                            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                                <h4 class="font-bold text-blue-900 mb-2">What to do now:</h4>
                                <ul class="text-sm text-blue-800 space-y-1">
                                    ${instructions.map(instruction => `<li>• ${instruction}</li>`).join('')}
                                </ul>
                            </div>

                            <div class="text-center space-y-2">
                                <button onclick="EmergencySystem.showNearestSafetyZone()" class="btn-primary w-full">
                                    📍 Find Nearest Shelter
                                </button>
                                <button onclick="EmergencySystem.closeInstructionModal()" class="btn-secondary w-full">
                                    Understood
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    window.currentInstructionModal = modal;
                }, 1000);
            }

            static getEmergencyInstructions(alertType) {
                const instructions = {
                    medical: ['Stay with the injured person if safe to do so', 'Do not move them unless in immediate danger', 'Medical team is en route to your location', 'Be prepared to provide basic information'],
                    weather: ['Move to the nearest shelter immediately', 'Stay away from trees, water, and high ground', 'Wait for weather all-clear announcement', 'Course play is temporarily suspended'],
                    security: ['Move to a safe location if possible', 'Do not confront any security threat', 'Security personnel are responding', 'Stay alert and follow staff instructions'],
                    equipment: ['Park cart safely away from play areas', 'Use hazard markers if available', 'Maintenance team will assist shortly', 'Consider walking to nearest facility'],
                    cart_path_only: ['Keep all carts on designated cart paths', 'Do not drive on fairways or rough areas', 'Observe all path markers and signage', 'Help protect course conditions'],
                    carts_on_fairways: ['Carts are now permitted on fairways', 'Follow the 90-degree rule when entering fairways', 'Stay at least 30 yards from greens', 'Avoid wet or sensitive areas'],
                    lost: ['Stay in your current location', 'Use course markers to identify your position', 'Course marshal is en route to assist', 'Check the GPS tab for navigation help']
                };
                return instructions[alertType] || ['Help is on the way', 'Stay safe and follow instructions'];
            }

            // AGGRESSIVE EMERGENCY OVERLAY SYSTEM
            static createFullScreenEmergencyOverlay(alert) {
                // Remove any existing overlays
                document.querySelectorAll('.emergency-fullscreen-overlay').forEach(el => el.remove());

                // Create full-screen emergency overlay
                const overlay = document.createElement('div');
                overlay.className = 'emergency-fullscreen-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(220, 38, 38, 0.95);
                    color: white;
                    z-index: 99999;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    text-align: center;
                    font-family: Arial, sans-serif;
                    animation: emergency-pulse 1s ease-in-out infinite;
                `;

                overlay.innerHTML = `
                    <div style="max-width: 80%; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🚨</div>
                        <h1 style="font-size: 36px; margin: 20px 0; font-weight: bold;">EMERGENCY ALERT</h1>
                        <p style="font-size: 24px; margin: 20px 0; line-height: 1.4;">${alert.message}</p>
                        <p style="font-size: 18px; margin: 20px 0; opacity: 0.9;">Time: ${new Date(alert.timestamp).toLocaleTimeString()}</p>
                        <button onclick="this.closest('.emergency-fullscreen-overlay').remove()"
                                style="font-size: 18px; padding: 15px 30px; background: white; color: #dc2626; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px;">
                            ACKNOWLEDGE & DISMISS
                        </button>
                    </div>
                `;

                // Add CSS animation if not exists
                if (!document.querySelector('#emergency-animation-styles')) {
                    const styleSheet = document.createElement('style');
                    styleSheet.id = 'emergency-animation-styles';
                    styleSheet.textContent = `
                        @keyframes emergency-pulse {
                            0% { background: rgba(220, 38, 38, 0.95); }
                            50% { background: rgba(220, 38, 38, 1); }
                            100% { background: rgba(220, 38, 38, 0.95); }
                        }
                    `;
                    document.head.appendChild(styleSheet);
                }

                // Add overlay to body
                document.body.appendChild(overlay);

                // Also play alert sound if available
                try {
                    if (typeof AlertSoundManager !== 'undefined') {
                        AlertSoundManager.playAlert('emergency');
                    }
                } catch (e) {
                    console.log('Alert sound not available');
                }

                console.log('Full-screen emergency overlay created for alert:', alert);
                return overlay;
            }

            // EMERGENCY SIREN SYSTEM - delegated to global helpers
            static playEmergencySiren() {
                if (typeof window.playEmergencySiren === 'function') {
                    return window.playEmergencySiren();
                }
                return true;
            }

            static playFallbackAlert() {
                if (typeof window.playFallbackAlert === 'function') {
                    return window.playFallbackAlert();
                }
                return true;
            }

            static showSafetyInfo() {
                this.closeEmergencyModal();
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl p-6 max-w-lg w-full mx-4 max-h-96 overflow-y-auto">
                        <h3 class="text-xl font-bold text-gray-900 mb-4" data-i18n="emergency.course.safety">🛡️ Course Safety Information</h3>

                        <div class="space-y-4">
                            <div class="bg-red-50 p-4 rounded-lg">
                                <h4 class="font-bold text-red-900 mb-2">Emergency Contacts</h4>
                                ${Object.entries(this.emergencyContacts).map(([key, contact]) => `
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="font-medium">${contact.name}</span>
                                        <span class="text-red-700">${contact.phone}</span>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-bold text-blue-900 mb-2">Safety Zones</h4>
                                ${this.safetyZones.map(zone => `
                                    <div class="text-sm mb-2">
                                        <div class="font-medium">${zone.name}</div>
                                        <div class="text-blue-700">Capacity: ${zone.capacity} | ${zone.facilities.join(', ')}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <button onclick="EmergencySystem.closeSafetyModal()" class="btn-primary w-full mt-4">
                            Close
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
                window.currentSafetyModal = modal;
            }

            static showNearestSafetyZone() {
                const currentPos = GPSNavigationSystem?.currentPosition;
                if (!currentPos) {
                    NotificationManager.show('📍 Enable GPS to find nearest shelter', 'info');
                    return;
                }

                let nearestZone = this.safetyZones[0];
                let minDistance = Infinity;

                this.safetyZones.forEach(zone => {
                    const distance = calculateDistance(currentPos.lat, currentPos.lng, zone.lat, zone.lng);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestZone = zone;
                    }
                });

                this.closeInstructionModal();
                NotificationManager.show(
                    `🏃‍♂️ Nearest shelter: ${nearestZone.name} (${Math.round(minDistance)} yards away)`,
                    'info'
                );
            }

            static closeEmergencyModal() {
                if (window.currentEmergencyModal) {
                    document.body.removeChild(window.currentEmergencyModal);
                    window.currentEmergencyModal = null;
                }
            }

            static closeInstructionModal() {
                if (window.currentInstructionModal) {
                    document.body.removeChild(window.currentInstructionModal);
                    window.currentInstructionModal = null;
                }
            }

            static closeSafetyModal() {
                if (window.currentSafetyModal) {
                    document.body.removeChild(window.currentSafetyModal);
                    window.currentSafetyModal = null;
                }
            }
        }

        // Persistent Emergency Alert Management System
        class PersistentEmergencyAlerts {
            static updateAllOverviewAlerts() {
                const activeAlerts = EmergencySystem.activeAlerts;

                // Update each role's overview alert display
                this.updateRoleAlerts('golfer', activeAlerts);
                this.updateRoleAlerts('caddie', activeAlerts);
                this.updateRoleAlerts('manager', activeAlerts);
                this.updateRoleAlerts('proshop', activeAlerts);
                this.updateRoleAlerts('maintenance', activeAlerts);
            }

            static updateRoleAlerts(role, alerts) {
                const alertContainer = document.getElementById(`${role}-emergency-alerts`);
                const alertList = document.getElementById(`${role}-alert-list`);
                const alertCount = document.getElementById(`${role}-alert-count`);

                if (!alertContainer || !alertList || !alertCount) return;

                // Filter alerts based on target roles - only show alerts meant for this role
                const relevantAlerts = alerts.filter(alert => {
                    const alertType = EmergencySystem.emergencyTypes[alert.type];
                    return alertType && alertType.targetRoles && alertType.targetRoles.includes(role);
                });

                if (relevantAlerts.length === 0) {
                    alertContainer.style.display = 'none';
                    return;
                }

                alertContainer.style.display = 'block';
                alertCount.textContent = relevantAlerts.length;

                alertList.innerHTML = relevantAlerts.map(alert => this.createAlertHTML(alert, role)).join('');
            }

            static createAlertHTML(alert, role) {
                const alertType = EmergencySystem.emergencyTypes[alert.type];
                const timeAgo = this.getTimeAgo(alert.timestamp);

                // Special handling for lightning/safety alerts
                const isLightningSafety = ['lightning_warning', 'stop_play', 'resume_play'].includes(alert.type);
                const alertClass = isLightningSafety ? 'lightning-safety-alert' : 'alert-item';
                const bgColor = isLightningSafety ? 'bg-yellow-50' : 'bg-white';
                const borderColor = isLightningSafety ? 'border-yellow-400 border-2' : 'border-red-300';
                const animation = isLightningSafety ? 'animate-pulse' : '';

                return `
                    <div class="${alertClass} ${bgColor} border ${borderColor} rounded-lg p-3 mb-2 ${animation}">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-3 flex-1">
                                <span class="text-xl ${isLightningSafety ? 'animate-bounce' : ''}">${alertType.icon}</span>
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <h4 class="font-bold ${isLightningSafety ? 'text-yellow-900' : 'text-red-800'}">${alertType.name}</h4>
                                        <span class="priority-badge bg-${alertType.color}-100 text-${alertType.color}-800 px-2 py-1 rounded text-xs font-medium">
                                            ${alertType.priority}
                                        </span>
                                    </div>
                                    ${alertType.description ? `
                                        <p class="text-sm font-medium ${isLightningSafety ? 'text-yellow-800' : 'text-red-700'} mb-1">${alertType.description}</p>
                                    ` : ''}
                                    <p class="text-sm ${isLightningSafety ? 'text-yellow-700' : 'text-red-700'} mb-1">Alert ID: ${alert.id}</p>
                                    <p class="text-sm ${isLightningSafety ? 'text-yellow-600' : 'text-red-600'}">From: ${alert.user} (${alert.role})</p>
                                    <p class="text-xs ${isLightningSafety ? 'text-yellow-500' : 'text-red-500'} mt-1">${timeAgo}</p>
                                    ${alert.location ? `
                                        <p class="text-xs ${isLightningSafety ? 'text-yellow-500' : 'text-red-500'}">Location: Hole ${alert.location.hole || 'Unknown'}</p>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                ${!isLightningSafety ? `
                                    <button onclick="PersistentEmergencyAlerts.acknowledgeAlert('${alert.id}')"
                                            class="text-xs bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 transition-colors">
                                        Acknowledge
                                    </button>
                                ` : ''}
                                <button onclick="PersistentEmergencyAlerts.resolveAlert('${alert.id}')"
                                        class="text-xs ${isLightningSafety ? 'bg-blue-500 hover:bg-blue-600' : 'bg-green-500 hover:bg-green-600'} text-white px-2 py-1 rounded transition-colors">
                                    ${isLightningSafety ? 'Clear' : 'Resolve'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            static getTimeAgo(timestamp) {
                const now = new Date();
                const alertTime = new Date(timestamp);
                const diffMs = now - alertTime;
                const diffMins = Math.floor(diffMs / 60000);

                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins} minutes ago`;

                const diffHours = Math.floor(diffMins / 60);
                if (diffHours < 24) return `${diffHours} hours ago`;

                const diffDays = Math.floor(diffHours / 24);
                return `${diffDays} days ago`;
            }

            static acknowledgeAlert(alertId) {
                const alert = EmergencySystem.activeAlerts.find(a => a.id === alertId);
                if (alert) {
                    alert.acknowledged = true;
                    alert.acknowledgedBy = AppState.currentUser.name;
                    alert.acknowledgedAt = new Date().toISOString();

                    NotificationManager.show(`Alert ${alertId} acknowledged`, 'success');
                    this.updateAllOverviewAlerts();
                }
            }

            static async resolveAlert(alertId) {
                const alertIndex = EmergencySystem.activeAlerts.findIndex(a => a.id === alertId);
                if (alertIndex > -1) {
                    // Remove from active alerts immediately
                    EmergencySystem.activeAlerts.splice(alertIndex, 1);

                    // Update local storage
                    localStorage.setItem('emergency_alerts', JSON.stringify(EmergencySystem.activeAlerts));

                    // === FIX: DELETE from Supabase permanently (not just mark resolved) ===
                    if (window.SupabaseDB) {
                        try {
                            await window.SupabaseDB.deleteEmergencyAlert(alertId);
                            console.log('[Emergency] ✅ Alert DELETED permanently from Supabase:', alertId);
                        } catch (error) {
                            console.error('[Emergency] ❌ Failed to delete alert from Supabase:', error);
                            // If delete fails, show error but don't re-add to local
                            NotificationManager.show('Failed to delete alert from cloud - may reappear', 'error');
                        }
                    }

                    NotificationManager.show(`Alert ${alertId} resolved and removed`, 'success');
                    this.updateAllOverviewAlerts();

                    // Invalidate cache to force refresh on all devices
                    if (typeof GlobalCacheManager !== 'undefined') {
                        GlobalCacheManager.invalidatePattern('emergency');
                    }
                }
            }
        }

        // Lightning Safety Alert System
        class LightningSafetySystem {
            static async playLightningAlert(alertType) {
                try {
                    // Request audio permissions and override silent mode
                    await this.requestAudioPermissions();

                    // Create audio context for alert sounds with silent mode override
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                    // Resume audio context if suspended (for silent mode override)
                    if (audioContext.state === 'suspended') {
                        await audioContext.resume();
                    }

                    // Trigger vibration for physical alert
                    this.triggerVibrationAlert(alertType);

                    // Play the appropriate sound with maximum volume
                    if (alertType === 'lightning_warning') {
                        this.playWarningSound(audioContext);
                    } else if (alertType === 'stop_play') {
                        this.playStopPlaySound(audioContext);
                    } else if (alertType === 'resume_play') {
                        this.playResumeSound(audioContext);
                    }

                    // Show visual alert overlay for maximum attention
                    this.showEmergencyOverlay(alertType);

                } catch (error) {
                    console.warn('Emergency alert system error:', error);
                    // Fallback to visual alerts only
                    this.showEmergencyOverlay(alertType);
                }
            }

            static async requestAudioPermissions() {
                try {
                    // Request microphone permission to enable audio override capabilities
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        const stream = await navigator.mediaDevices.getUserMedia({
                            audio: true,
                            video: false
                        });
                        // Immediately stop the stream, we just needed permission
                        stream.getTracks().forEach(track => track.stop());
                    }
                } catch (error) {
                    console.warn('Audio permission not granted:', error);
                }
            }

            static triggerVibrationAlert(alertType) {
                if ('vibrate' in navigator) {
                    // Different vibration patterns for different alert types
                    let pattern;

                    switch (alertType) {
                        case 'lightning_warning':
                            // Short warning pattern: 3 quick vibrations
                            pattern = [200, 100, 200, 100, 200];
                            break;
                        case 'stop_play':
                            // Urgent stop pattern: Long continuous vibrations
                            pattern = [1000, 500, 1000, 500, 1000, 500, 1000];
                            break;
                        case 'resume_play':
                            // Pleasant pattern: 2 gentle vibrations
                            pattern = [300, 200, 300];
                            break;
                        default:
                            pattern = [500];
                    }

                    navigator.vibrate(pattern);
                }
            }

            static showEmergencyOverlay(alertType) {
                const alertType_data = EmergencySystem.emergencyTypes[alertType];
                if (!alertType_data) return;

                // Keep screen awake during emergency
                this.requestWakeLock();

                // Create full-screen emergency overlay
                const overlay = document.createElement('div');
                overlay.className = 'fixed inset-0 z-[9999] flex items-center justify-center';
                overlay.style.cssText = `
                    background: rgba(0, 0, 0, 0.95);
                    animation: emergency-flash 1s infinite;
                `;

                overlay.innerHTML = `
                    <div class="text-center text-white p-8 max-w-md mx-auto">
                        <div class="text-8xl mb-4 animate-bounce">${alertType_data.icon}</div>
                        <h1 class="text-4xl font-bold mb-4 animate-pulse">${alertType_data.name}</h1>
                        <p class="text-2xl mb-8">${alertType_data.description}</p>
                        <button onclick="LightningSafetySystem.acknowledgeEmergency(this)"
                                class="bg-white text-black px-8 py-4 rounded-lg text-xl font-bold hover:bg-gray-200 shadow-lg">
                            ACKNOWLEDGE
                        </button>
                        <p class="text-sm mt-4 opacity-75">Auto-dismiss in <span id="countdown-${alertType}">${alertType === 'stop_play' ? '10' : '5'}</span> seconds</p>
                    </div>
                `;

                document.body.appendChild(overlay);

                // Start countdown
                this.startCountdown(alertType, overlay);

                // Auto-remove after 10 seconds for stop_play, 5 seconds for others
                const autoRemoveTime = alertType === 'stop_play' ? 10000 : 5000;
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.remove();
                        this.releaseWakeLock();
                    }
                }, autoRemoveTime);
            }

            static acknowledgeEmergency(button) {
                // Remove the overlay
                const overlay = button.closest('.fixed');
                if (overlay) {
                    overlay.remove();
                }
                this.releaseWakeLock();
            }

            static startCountdown(alertType, overlay) {
                const initialTime = alertType === 'stop_play' ? 10 : 5;
                let timeLeft = initialTime;

                const countdownElement = overlay.querySelector(`#countdown-${alertType}`);
                if (!countdownElement) return;

                const countdown = setInterval(() => {
                    timeLeft--;
                    countdownElement.textContent = timeLeft;

                    if (timeLeft <= 0) {
                        clearInterval(countdown);
                    }
                }, 1000);
            }

            static async requestWakeLock() {
                try {
                    if ('wakeLock' in navigator) {
                        this.wakeLock = await navigator.wakeLock.request('screen');
                        console.log('Wake lock active during emergency');
                    }
                } catch (error) {
                    console.warn('Wake lock not available:', error);
                }
            }

            static releaseWakeLock() {
                try {
                    if (this.wakeLock) {
                        this.wakeLock.release();
                        this.wakeLock = null;
                        console.log('Wake lock released');
                    }
                } catch (error) {
                    console.warn('Wake lock release error:', error);
                }
            }

            static playWarningSound(audioContext) {
                // Play warning beep pattern: 3 short beeps
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        this.playBeep(audioContext, 800, 0.3); // 800Hz, 0.3 seconds
                    }, i * 500);
                }
            }

            static playStopPlaySound(audioContext) {
                // Play urgent alarm: continuous siren-like sound
                this.playSiren(audioContext, 5); // 5 seconds of siren
            }

            static playResumeSound(audioContext) {
                // Play pleasant ascending tone
                this.playBeep(audioContext, 440, 0.5); // A note
                setTimeout(() => this.playBeep(audioContext, 554, 0.5), 250); // C# note
                setTimeout(() => this.playBeep(audioContext, 659, 0.8), 500); // E note (longer)
            }

            static playBeep(audioContext, frequency, duration) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';

                // Use maximum volume for emergency alerts (1.0 instead of 0.3)
                gainNode.gain.setValueAtTime(1.0, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            }

            static playSiren(audioContext, duration) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.5);
                oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 1);

                // Repeat the pattern
                for (let i = 1; i < duration; i++) {
                    oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + i + 0.5);
                    oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + i + 1);
                }

                // Use maximum volume for emergency siren (1.0 instead of 0.4)
                gainNode.gain.setValueAtTime(1.0, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            }
        }

        // Emergency Alert Debugging System
        class EmergencyDebugger {
            static debugAlertDelivery() {
                console.log('=== EMERGENCY ALERT DEBUG ===');
                console.log('Current User:', AppState.currentUser);
                console.log('Active Alerts:', EmergencySystem.activeAlerts);
                console.log('Current Screen:', document.querySelector('.screen.active')?.id);
                console.log('Emergency Alert Containers:');

                ['golfer', 'caddie', 'manager', 'proshop', 'maintenance'].forEach(role => {
                    const container = document.getElementById(`${role}-emergency-alerts`);
                    console.log(`${role}:`, container ? 'Found' : 'Not Found', container?.style.display);
                });

                console.log('================================');
            }

            static testAlertToAllRoles() {
                console.log('Testing alert delivery to all roles...');

                // Create a test alert manually
                const testAlert = {
                    id: 'TEST' + Date.now().toString().slice(-6),
                    type: 'lightning_warning',
                    user: AppState.currentUser.name,
                    role: AppState.currentUser.role,
                    timestamp: new Date().toISOString(),
                    status: 'active',
                    priority: 'critical'
                };

                // Add to active alerts
                EmergencySystem.activeAlerts.push(testAlert);

                // Update all overview alerts
                PersistentEmergencyAlerts.updateAllOverviewAlerts();

                console.log('Test alert sent:', testAlert);
                this.debugAlertDelivery();
            }
        }

        // Add debugging to window for console access
        window.EmergencyDebugger = EmergencyDebugger;

        // Extend EmergencySystem to update persistent alerts and handle lightning safety
        const originalSendSpecificAlert = EmergencySystem.sendSpecificAlert;
        EmergencySystem.sendSpecificAlert = function(alertType) {
            console.log('Sending emergency alert:', alertType, 'by user:', AppState.currentUser);

            originalSendSpecificAlert.call(this, alertType);

            // Play special audio for lightning safety alerts
            if (['lightning_warning', 'stop_play', 'resume_play'].includes(alertType)) {
                LightningSafetySystem.playLightningAlert(alertType);
            }

            // Update persistent alerts after sending
            setTimeout(() => {
                console.log('Updating overview alerts, active alerts:', EmergencySystem.activeAlerts);

                // Save emergency alerts to localStorage for sync
                localStorage.setItem('emergency_alerts', JSON.stringify(EmergencySystem.activeAlerts));

                // Trigger GLOBAL emergency alert sync for all users on property
                if (typeof ProductionCloudSync !== 'undefined') {
                    SimpleCloudSync.saveToCloudSoon();
                    console.log('[Emergency] Triggered GLOBAL emergency alert sync for all users on property');
                }

                PersistentEmergencyAlerts.updateAllOverviewAlerts();
                EmergencyDebugger.debugAlertDelivery();
            }, 2500); // Wait for alert to be added to activeAlerts
        };

        // Application Initialization
        document.addEventListener('DOMContentLoaded', async function() {
            // Handle LINE OAuth callback
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const storedState = localStorage.getItem('line_oauth_state');

            // DEBUG: Log OAuth callback detection
            console.log('[LINE OAuth DEBUG] Checking callback...');
            console.log('[LINE OAuth DEBUG] code:', code ? 'present' : 'missing');
            console.log('[LINE OAuth DEBUG] state from URL:', state);
            console.log('[LINE OAuth DEBUG] storedState from localStorage:', storedState);
            console.log('[LINE OAuth DEBUG] states match:', state === storedState);
            console.log('[LINE OAuth DEBUG] sessionStorage __line_code_used:', sessionStorage.getItem('__line_code_used'));

            if (code && state === storedState) {
                // Prevent duplicate processing of the same EXACT code (page refresh protection)
                const usedCode = sessionStorage.getItem('__line_code_used');
                if (usedCode === code) {
                    console.log('[LINE OAuth] This exact code was already processed, skipping duplicate');
                    return;
                }
                // Store this code as used (only prevents processing the SAME code twice)
                sessionStorage.setItem('__line_code_used', code);
                console.log('[LINE OAuth] Callback received, exchanging code for profile');
                LoadingManager.show('Completing LINE login...');

                try {
                    // Call Supabase Edge Function to exchange code for profile
                    const res = await fetch('https://pyeeplwsnupmhgbguwqs.supabase.co/functions/v1/line-oauth-exchange', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code, state, redirectUri: 'https://mycaddipro.com/' })
                    });

                    const raw = await res.clone().text();
                    console.log('[exchange] status', res.status, raw);
                    const data = JSON.parse(raw || '{}');
                    if (data.profile) {
                        await LineAuthentication.setUserFromLineProfile(data.profile);
                        localStorage.removeItem('line_oauth_state');

                        // Clean URL without reloading (remove ?code= and ?state= params)
                        const cleanUrl = window.location.origin + window.location.pathname;
                        history.replaceState(null, '', cleanUrl);

                        // Navigate to appropriate dashboard based on user role
                        LineAuthentication.redirectToDashboard();
                        LoadingManager.hide();
                        return;
                    }
                } catch (error) {
                    console.error('[LINE OAuth] Exchange failed:', error);
                    NotificationManager.show('Login failed. Please try again.', 'error');
                } finally {
                    LoadingManager.hide();
                }
            }

            // Prevent target="_blank" links from opening Chrome (keep in WebView)
            document.addEventListener('click', (e) => {
                const target = e.target;
                const a = target.closest && target.closest('a[target="_blank"]');
                if (a) {
                    e.preventDefault();
                    window.location.href = a.href;
                }
            });

            // Clear cache if requested via URL parameter
            if (window.location.search.includes('clearCache=1')) {
                console.log('[Dashboard] Clearing localStorage cache...');
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.includes('mcipro') || key.includes('booking')) {
                        localStorage.removeItem(key);
                    }
                });
                console.log('[Dashboard] Cache cleared, closing tab...');
                setTimeout(() => window.close(), 1000);
                return;
            }

            console.log('MciPro Enterprise Platform initializing...');

            try {
                // REMOVED: clearAllDemoData() - was wiping bookings on every startup!
                console.log('🚀 Starting MciPro without clearing existing data...');

                // Initialize internationalization system
                initializeLanguage();

                // Initialize OTP input handlers
                OTPAuthentication.setupOTPInputHandlers();

                // PERFORMANCE: Register Service Worker for offline-first caching
if ('serviceWorker' in navigator && !(location.search.includes('code=') && location.search.includes('state='))) {
    navigator.serviceWorker.register('/sw.js')
                        .then((registration) => {
                            console.log('[ServiceWorker] Registered successfully:', registration.scope);
                            console.log('[ServiceWorker] 🚀 Offline-first caching enabled');
                        })
                        .catch((error) => {
                            console.error('[ServiceWorker] Registration failed:', error);
                        });
                }

                // Initialize production cloud synchronization system
                SimpleCloudSync.initialize();

                // Initialize booking system and load saved data
                BookingManager.initialize();

                // Initialize schedule system
                ScheduleSystem.initializeSchedule();

                // Check if user is already logged in via LINE - do this IMMEDIATELY
                if (typeof liff !== 'undefined') {
                    liff.init({ liffId: LineConfig.liffId })
                        .then(() => {
                            console.log('[INIT] LIFF initialized, checking login status...');
                            console.log('[INIT] liff.isLoggedIn():', liff.isLoggedIn());

                            if (liff.isLoggedIn()) {
                                console.log('[INIT] User IS logged in via LINE, loading profile...');
                                LoadingManager.show('Loading your profile...');

                                // Try to get profile, but if permission is missing, check Supabase session instead
                                liff.getProfile().then(async (profile) => {
                                    console.log('[INIT] Got LINE profile:', profile.userId);
                                    await LineAuthentication.setUserFromLineProfile(profile);
                                    console.log('[INIT] Profile loaded, redirecting to dashboard...');

                                    // Initialize native push notifications
                                    try {
                                        const { data: { user } } = await window.SupabaseDB.client.auth.getUser();
                                        if (window.NativePush && user?.id) {
                                            await window.NativePush.init(user.id);
                                        }
                                    } catch (pushErr) {
                                        console.error('[INIT] Push init failed:', pushErr);
                                    }

                                    LineAuthentication.redirectToDashboard();
                                    LoadingManager.hide();
                                }).catch(async (err) => {
                                    console.error('[INIT] Failed to get LINE profile:', err);

                                    // If profile permission is missing, check for existing Supabase session
                                    try {
                                        if (window.SupabaseDB) {
                                            await window.SupabaseDB.waitForReady();
                                            const { data: { session }, error } = await window.SupabaseDB.client.auth.getSession();

                                            if (session && session.user) {
                                                console.log('[INIT] Found existing Supabase session, using that instead');
                                                // Use the Supabase user ID to load profile
                                                const userProfile = await window.SupabaseDB.getUserProfileBySupabaseId(session.user.id);

                                                if (userProfile) {
                                                    console.log('[INIT] Profile found via Supabase:', userProfile.name);

                                                    // Restore FULL profile to AppState (same as LINE flow)
                                                    const lineUserId = userProfile.line_user_id;
                                                    AppState.currentUser = {
                                                        role: userProfile.role || 'golfer',
                                                        name: userProfile.name,
                                                        username: userProfile.username || userProfile.name,
                                                        lineUserId: lineUserId,
                                                        userId: lineUserId || session.user.id,
                                                        email: userProfile.email,
                                                        phone: userProfile.phone,
                                                        handicap: userProfile.profile_data?.golfInfo?.handicap || null,
                                                        membershipLevel: userProfile.role === 'golfer' ? 'premium' : 'staff',
                                                        joinDate: userProfile.created_at || new Date().toISOString(),
                                                        stats: {},
                                                        permissions: LineAuthentication.getPermissions(userProfile.role || 'golfer'),
                                                        profileData: userProfile
                                                    };

                                                    // Restore FULL profile to localStorage (CRITICAL for home club/HCP display)
                                                    if (userProfile.profile_data) {
                                                        console.log('[INIT] FULL profile_data from Supabase:', JSON.stringify(userProfile.profile_data, null, 2));

                                                        const profileKey = UserIDSystem.getProfileKey(userProfile.role, lineUserId);
                                                        const fullProfile = {
                                                            userId: lineUserId,
                                                            lineUserId: lineUserId,
                                                            username: userProfile.profile_data.username || userProfile.username || userProfile.name || '',
                                                            linePictureUrl: userProfile.profile_data.linePictureUrl || '',
                                                            personalInfo: userProfile.profile_data.personalInfo || {},
                                                            golfInfo: userProfile.profile_data.golfInfo || {},
                                                            professionalInfo: userProfile.profile_data.professionalInfo || {},
                                                            skills: userProfile.profile_data.skills || {},
                                                            preferences: userProfile.profile_data.preferences || {},
                                                            media: userProfile.profile_data.media || {},
                                                            privacy: userProfile.profile_data.privacy || {}
                                                        };

                                                        localStorage.setItem(profileKey, JSON.stringify(fullProfile));
                                                        console.log('[INIT] ✅ Full profile restored to localStorage from Supabase');
                                                        console.log('[INIT] golfInfo:', fullProfile.golfInfo);
                                                        console.log('[INIT] Handicap:', fullProfile.golfInfo?.handicap);
                                                        console.log('[INIT] Home Club:', fullProfile.golfInfo?.homeClub);

                                                        // Update mcipro_user_profiles array
                                                        const profiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');
                                                        const existingIndex = profiles.findIndex(p => p.lineUserId === lineUserId || p.userId === lineUserId);

                                                        const profileSummary = {
                                                            userId: lineUserId,
                                                            lineUserId: lineUserId,
                                                            role: userProfile.role,
                                                            name: userProfile.name,
                                                            username: fullProfile.username,
                                                            email: fullProfile.personalInfo?.email,
                                                            phone: fullProfile.personalInfo?.phone,
                                                            handicap: fullProfile.golfInfo?.handicap,
                                                            homeClub: fullProfile.golfInfo?.homeClub
                                                        };

                                                        if (existingIndex >= 0) {
                                                            profiles[existingIndex] = { ...profiles[existingIndex], ...profileSummary };
                                                        } else {
                                                            profiles.push(profileSummary);
                                                        }
                                                        localStorage.setItem('mcipro_user_profiles', JSON.stringify(profiles));
                                                        console.log('[INIT] ✅ Profile array updated');

                                                        // CRITICAL: Update home club display manually (UserInterface.updateUserDisplays doesn't do this)
                                                        const homeClub = fullProfile.golfInfo?.homeClub;
                                                        if (homeClub) {
                                                            setTimeout(() => {
                                                                document.querySelectorAll('.home-club').forEach(el => {
                                                                    el.textContent = homeClub;
                                                                });
                                                                console.log('[INIT] ✅ Home club updated to:', homeClub);
                                                            }, 100);
                                                        }
                                                    }

                                                    // Initialize native push notifications
                                                    if (window.NativePush && userProfile.id) {
                                                        window.NativePush.init(userProfile.id).catch(err => {
                                                            console.error('[INIT] Push notification init failed:', err);
                                                        });
                                                    }

                                                    LineAuthentication.redirectToDashboard();
                                                    LoadingManager.hide();
                                                    return;
                                                }
                                            }
                                        }
                                    } catch (supabaseErr) {
                                        console.error('[INIT] Supabase session check failed:', supabaseErr);
                                    }

                                    LoadingManager.hide();
                                    ScreenManager.showScreen('loginScreen');
                                });
                            } else {
                                console.log('[INIT] User NOT logged in, showing login screen');
                                ScreenManager.showScreen('loginScreen');
                            }
                        })
                        .catch(err => {
                            console.error('[INIT] LIFF init failed:', err);
                            ScreenManager.showScreen('loginScreen');
                        });
                } else {
                    console.log('[INIT] LIFF SDK not available, showing login screen');
                    ScreenManager.showScreen('loginScreen');
                }

                // Initialize session tracking
                AppState.session.lastActivity = new Date().toISOString();

                // Load existing emergency alerts from Supabase (cross-device sync)
                console.log('[INIT] Loading emergency alerts from cloud...');
                try {
                    if (window.SupabaseDB) {
                        window.SupabaseDB.waitForReady().then(async () => {
                            const cloudAlerts = await window.SupabaseDB.getEmergencyAlerts();
                            if (cloudAlerts && cloudAlerts.length > 0) {
                                EmergencySystem.activeAlerts = cloudAlerts;
                                localStorage.setItem('emergency_alerts', JSON.stringify(cloudAlerts));
                                console.log(`[INIT] Loaded ${cloudAlerts.length} alerts from Supabase`);
                                // Update alert displays for all roles
                                PersistentEmergencyAlerts.updateAllOverviewAlerts();
                            } else {
                                // Fallback to localStorage if Supabase has no alerts
                                const storedAlerts = localStorage.getItem('emergency_alerts');
                                EmergencySystem.activeAlerts = storedAlerts ? JSON.parse(storedAlerts) : [];
                                console.log(`[INIT] Loaded ${EmergencySystem.activeAlerts.length} alerts from localStorage`);
                            }
                        }).catch(err => {
                            console.error('[INIT] Error loading from Supabase:', err);
                            // Fallback to localStorage
                            const storedAlerts = localStorage.getItem('emergency_alerts');
                            EmergencySystem.activeAlerts = storedAlerts ? JSON.parse(storedAlerts) : [];
                        });
                    } else {
                        // Fallback to localStorage if Supabase not available
                        const storedAlerts = localStorage.getItem('emergency_alerts');
                        EmergencySystem.activeAlerts = storedAlerts ? JSON.parse(storedAlerts) : [];
                        console.log('[INIT] Supabase not ready, using localStorage');
                    }
                } catch (error) {
                    console.error('[INIT] Error loading alerts:', error);
                    EmergencySystem.activeAlerts = [];
                }

                // CRITICAL: Clean corrupted bookings before any rendering
                console.log('[INIT] Running one-time data cleanup...');
                const cleaned = cleanAllBookings();
                if (BookingManager.bookings) {
                    BookingManager.bookings = cleaned;
                }

                // Initialize persistent emergency alerts
                PersistentEmergencyAlerts.updateAllOverviewAlerts();

                console.log('MciPro Enterprise Platform initialized successfully');

            } catch (error) {
                console.error('Initialization error:', error);
                NotificationManager.show('Application initialization error', 'error');
            }
        });

        // ===== GLOBAL HELPER FUNCTIONS =====

        // These are called directly from HTML onclick attributes
        function showScreen(screenId) {
            ScreenManager.showScreen(screenId);
        }

        function showTab(dashboardId, tabName, event) {
            TabManager.showTab(dashboardId, tabName, event);
        }

        // REMOVED: window.login definition here - conflicts with global one
        // The global window.login at line 19539 handles all auth systems

        window.loginWithCustomProfile = function(profileData) {
            LoadingManager.show('Logging in with your profile...');

            // FIRST: Clear all data immediately before any initialization
            ensureCleanSlateForNewUser(profileData);

            setTimeout(() => {
                // Get or generate unique ID for custom profile
                let customUserId = profileData.userId || profileData.lineUserId;

                if (!customUserId) {
                    // Check if profile has an ID stored
                    if (profileData.id) {
                        customUserId = profileData.id;
                    } else {
                        // Generate new UUID for custom profiles
                        customUserId = UserIDSystem.generateUUID();
                        console.log('[CustomProfile] ✓ Generated new UUID:', customUserId.substring(0, 12) + '...');
                    }
                }

                // Set AppState to use the custom profile with clean slate
                AppState.currentUser = {
                    role: profileData.role,
                    name: `${profileData.firstName} ${profileData.lastName}`,
                    lineId: null,
                    userId: customUserId, // UNIQUE ID - lineUserId or UUID
                    avatar: profileData.profilePicture || profileData.roleSpecific?.avatar || null,
                    email: profileData.email,
                    phone: profileData.phone,
                    handicap: profileData.roleSpecific?.handicap || null,
                    membershipLevel: profileData.role === 'golfer' ? 'premium' : 'staff',
                    joinDate: profileData.createdAt,
                    stats: {
                        totalRounds: 0,
                        averageScore: 0,
                        bestScore: 0,
                        totalEarnings: 0,
                        rating: 0
                    },
                    permissions: LineAuthentication.getPermissions(profileData.role),
                    profileData: profileData,
                    preferences: {
                        language: 'en',
                        notifications: true,
                        theme: 'light'
                    }
                };

                console.log('[CustomProfile] ✓ Unique ID set:', {
                    userId: AppState.currentUser.userId.substring(0, 12) + '...',
                    profileKey: UserIDSystem.getProfileKey(profileData.role, customUserId)
                });

                AppState.session.isAuthenticated = true;
                AppState.session.authMethod = 'custom_profile';
                AppState.session.loginTime = new Date().toISOString();

                LoadingManager.hide();

                // Update UI with profile data
                ProfileSystem.updateUIWithProfile();
                UserInterface.updateUserDisplays();

                // ChatSystem will initialize when user opens chat (loads real users from Supabase)

                LineAuthentication.redirectToDashboard();
            }, 1000);
        }

        function ensureCleanSlateForNewUser(profileData) {
            const userName = `${profileData.firstName} ${profileData.lastName}`;

            console.log(`Ensuring clean slate for: ${userName} (${profileData.role})`);

            // Clear ALL existing localStorage data except courses, caddies, and user profiles
            const keysToPreserve = [
                'mcipro_user_profiles',
                'mci-pro-language',
                'caddie_system_data',
                'golf_courses_data',
                'mcipro_bookings',  // CRITICAL: Preserve bookings with their caddies
                'schedule_items'    // CRITICAL: Preserve schedules
            ];

            // FIXED: Only clear temporary UI data, PRESERVE bookings and schedules
            const dataKeysToForceRemove = [
                // 'mcipro_bookings',  // FIXED: PRESERVE bookings across logins
                // 'schedule_items',   // FIXED: PRESERVE schedules across logins
                'food_orders',
                'chat_messages',
                'cart_data',
                'order_history'
            ];

            // Get all localStorage keys
            const allKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                allKeys.push(localStorage.key(i));
            }

            // Force remove specific data keys first
            dataKeysToForceRemove.forEach(key => {
                localStorage.removeItem(key);
            });

            // Remove all keys except preserved ones
            allKeys.forEach(key => {
                if (!keysToPreserve.includes(key) && !key.startsWith('profile_')) {
                    localStorage.removeItem(key);
                }
            });

            // FIXED: DO NOT reset bookings - preserve across logins
            if (window.BookingManager) {
                // BookingManager.bookings = [];  // FIXED: DO NOT WIPE BOOKINGS
                // BookingManager.waitlists = {};  // FIXED: DO NOT WIPE WAITLISTS

                // FIXED: DO NOT force empty state - preserve existing bookings
                // localStorage.setItem('mcipro_bookings', JSON.stringify([]));
                // BookingManager.saveToLocalStorage();
                console.log('BookingManager preserved existing bookings');
            }

            if (window.FoodOrderingSystem) {
                FoodOrderingSystem.orders = [];
                localStorage.setItem('food_orders', JSON.stringify([]));
                console.log('FoodOrderingSystem reset to clean state');
            }

            if (window.ScheduleManager) {
                // ScheduleManager.scheduleItems = [];  // FIXED: DO NOT WIPE SCHEDULES

                // FIXED: DO NOT force empty state - preserve existing schedules
                // localStorage.setItem('schedule_items', JSON.stringify([]));
                // ScheduleManager.saveSchedule();
                console.log('ScheduleManager preserved existing schedules');
            }

            // Chat system now uses professional chat with Supabase auth

            // Clear any cart data
            const cartElements = document.querySelectorAll('[data-cart-item]');
            cartElements.forEach(element => element.remove());

            // Clear any order history displays
            const orderHistoryElements = document.querySelectorAll('[data-order-history]');
            orderHistoryElements.forEach(element => element.innerHTML = '<p class="text-gray-500 text-center py-8">No orders yet</p>');

            console.log(`Clean slate completed for: ${userName} (${profileData.role})`);

            // Mark this session as a clean slate user
            window.isCleanSlateUser = true;

            // Force re-initialization of systems after clearing data
            setTimeout(() => {
                if (window.BookingManager) {
                    // Don't call initialize, just ensure empty state
                    BookingManager.bookings = [];
                    BookingManager.waitlists = {};
                }
                if (window.ScheduleManager) {
                    ScheduleManager.scheduleItems = [];
                }
                console.log('Systems re-initialized with clean data');
            }, 100);

            // Reset role-specific data displays
            resetRoleSpecificDisplays(profileData.role);

            // Force refresh dashboard content after clearing
            setTimeout(() => {
                refreshDashboardContent();
            }, 200);
        }

        function resetRoleSpecificDisplays(role) {
            // Reset stats and displays based on role
            switch (role) {
                case 'golfer':
                    // Reset golfer-specific displays
                    if (document.querySelector('.total-rounds')) {
                        document.querySelector('.total-rounds').textContent = '0';
                    }
                    if (document.querySelector('.handicap-display')) {
                        document.querySelector('.handicap-display').textContent = AppState.currentUser.handicap || 'Not Set';
                    }
                    break;

                case 'caddie':
                    // Reset caddie-specific displays
                    if (document.querySelector('.monthly-earnings')) {
                        document.querySelector('.monthly-earnings').textContent = '฿0';
                    }
                    if (document.querySelector('.total-rounds-caddie')) {
                        document.querySelector('.total-rounds-caddie').textContent = '0';
                    }
                    if (document.querySelector('.rating-display')) {
                        document.querySelector('.rating-display').textContent = '0.0';
                    }
                    break;

                case 'manager':
                    // Reset manager-specific displays
                    if (document.querySelector('.staff-count')) {
                        document.querySelector('.staff-count').textContent = '0 Staff Members';
                    }
                    break;

                case 'proshop':
                    // Reset pro shop-specific displays
                    if (document.querySelector('.daily-sales')) {
                        document.querySelector('.daily-sales').textContent = '฿0';
                    }
                    if (document.querySelector('.items-sold')) {
                        document.querySelector('.items-sold').textContent = '0 Items Sold';
                    }
                    break;

                case 'maintenance':
                    // Reset maintenance-specific displays
                    if (document.querySelector('.tasks-completed')) {
                        document.querySelector('.tasks-completed').textContent = '0 Tasks';
                    }
                    break;
            }

            // Clear any existing dashboard cards that show user-specific data
            const dashboardCards = document.querySelectorAll('.dashboard-card[data-user-specific="true"]');
            dashboardCards.forEach(card => {
                card.style.display = 'none';
            });

            console.log(`Role-specific displays reset for: ${role}`);
        }

        function refreshDashboardContent() {
            // Clear any booking cards in overview
            const bookingCards = document.querySelectorAll('.booking-card, .schedule-item-card');
            bookingCards.forEach(card => card.remove());

            // Clear schedule lists
            const scheduleContainer = document.querySelector('#scheduleItemsList');
            if (scheduleContainer) {
                scheduleContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No scheduled activities yet</p>';
            }

            // Clear overview booking displays
            const overviewBookings = document.querySelector('.overview-bookings');
            if (overviewBookings) {
                overviewBookings.innerHTML = '<p class="text-gray-500 text-center py-4">No upcoming bookings</p>';
            }

            // Clear any charts or stats that might show cached data
            const statElements = document.querySelectorAll('.stat-value, .metric-value');
            statElements.forEach(element => {
                if (element.textContent && !isNaN(element.textContent)) {
                    element.textContent = '0';
                }
            });

            console.log('Dashboard content refreshed for clean slate user');
        }

        function logout() {
            LineAuthentication.logout();
        }

        // ===== PROFILE CREATION SYSTEM =====
        window.showCreateProfileScreen = function() {
            showScreen('createProfileScreen');
        };

        window.goBackToLogin = function() {
            showScreen('loginScreen');
        };

        async function forceLoadProfileFromCloud() {
            try {
                LoadingManager.show('Syncing profiles from cloud...');
                console.log('[ForceSync] Forcing profile load from cloud...');

                // Force load from cloud (need ALL profiles to check)
                if (typeof SimpleCloudSync !== 'undefined') {
                    await SimpleCloudSync.loadFromCloud(true);
                }

                // Check if we now have a profile
                const profiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');
                console.log('[ForceSync] Loaded profiles:', profiles.length);

                if (profiles.length > 0 && typeof liff !== 'undefined' && liff.isLoggedIn()) {
                    const lineProfile = await liff.getProfile();
                    const myProfile = profiles.find(p => p.lineUserId === lineProfile.userId);

                    if (myProfile) {
                        alert('Profile found! Redirecting to dashboard...');
                        await LineAuthentication.setUserFromLineProfile(lineProfile);
                        LineAuthentication.redirectToDashboard();
                    } else {
                        alert(`Synced ${profiles.length} profiles, but none match your LINE account. You may need to create a new profile.`);
                    }
                } else {
                    alert(`Synced ${profiles.length} profiles from cloud. Please try logging in with LINE again.`);
                    ScreenManager.showScreen('loginScreen');
                }
            } catch (error) {
                console.error('[ForceSync] Error:', error);
                alert('Sync failed: ' + error.message);
            } finally {
                LoadingManager.hide();
            }
        }

        // Profile Management Functions
        window.showMyProfiles = function() {
            const profilesModal = document.createElement('div');
            profilesModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            profilesModal.id = 'profilesModal';

            const savedProfiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');

            profilesModal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 max-h-96 overflow-y-auto">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">My Profiles</h3>

                    ${savedProfiles.length === 0 ? `
                        <div class="text-center py-8">
                            <p class="text-gray-600 mb-4">No profiles created yet</p>
                            <button onclick="closeProfilesModal(); showCreateProfileScreen();" class="btn-primary">Create Profile</button>
                        </div>
                    ` : `
                        <div class="space-y-3">
                            ${savedProfiles.map(profile => `
                                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1 cursor-pointer" onclick="selectProfile('${profile.id}')">
                                            <h4 class="font-semibold text-gray-900">${profile.firstName} ${profile.lastName}</h4>
                                            <p class="text-sm text-gray-600 capitalize">${profile.role}</p>
                                            <p class="text-xs text-gray-500">${profile.email}</p>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${getRoleColor(profile.role)}-100 text-${getRoleColor(profile.role)}-800">
                                                ${profile.role}
                                            </span>
                                            <button onclick="deleteProfile('${profile.id}', event)"
                                                    class="p-2 text-red-600 hover:text-red-700 hover:bg-red-50 rounded border border-red-200"
                                                    title="Delete Profile">
                                                ❌
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="mt-6 flex space-x-3">
                            <button onclick="closeProfilesModal()" class="btn-secondary flex-1">Cancel</button>
                            <button onclick="closeProfilesModal(); showCreateProfileScreen();" class="btn-primary flex-1">Create New</button>
                        </div>
                    `}
                </div>
            `;

            document.body.appendChild(profilesModal);
        }

        function getRoleColor(role) {
            const colors = {
                'golfer': 'blue',
                'caddie': 'green',
                'manager': 'purple',
                'proshop': 'orange',
                'maintenance': 'yellow',
                'society': 'pink'
            };
            return colors[role] || 'gray';
        }

        function closeProfilesModal() {
            const modal = document.getElementById('profilesModal');
            if (modal) {
                modal.remove();
            }
        }

        function selectProfile(profileId) {
            const savedProfiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');
            const selectedProfile = savedProfiles.find(p => p.id === profileId);

            if (selectedProfile) {
                closeProfilesModal();
                loginWithCustomProfile(selectedProfile);
            }
        }

        function deleteProfile(profileId, event) {
            event.stopPropagation(); // Prevent profile selection when clicking delete

            if (confirm('Are you sure you want to delete this profile? This action cannot be undone.')) {
                try {
                    // Remove from saved profiles
                    const savedProfiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');
                    const updatedProfiles = savedProfiles.filter(p => p.id !== profileId);
                    localStorage.setItem('mcipro_user_profiles', JSON.stringify(updatedProfiles));

                    // Find the profile to get the name for cleanup
                    const deletedProfile = savedProfiles.find(p => p.id === profileId);
                    if (deletedProfile) {
                        const profileName = `${deletedProfile.firstName} ${deletedProfile.lastName}`;

                        // Clean up associated data
                        cleanupProfileData(deletedProfile.role, profileName, profileId);
                    }

                    // Refresh the modal
                    closeProfilesModal();
                    showMyProfiles();

                    console.log('Profile deleted successfully');
                } catch (error) {
                    console.error('Error deleting profile:', error);
                    alert('Error deleting profile. Please try again.');
                }
            }
        }

        function cleanupProfileData(role, profileName, profileId) {
            try {
                // Remove profile from ProfileSystem storage using UNIQUE ID
                const uniqueId = UserIDSystem.getUserUniqueID(AppState.currentUser);
                const profileKey = UserIDSystem.getProfileKey(role, uniqueId);
                localStorage.removeItem(profileKey);

                // Clean up role-specific data
                const userDataKey = `userData_${profileId}`;
                localStorage.removeItem(userDataKey);

                // Clean up any bookings, schedules, orders associated with this profile
                const keysToClean = [
                    `bookings_${profileName}`,
                    `schedule_${profileName}`,
                    `orders_${profileName}`,
                    `waitlist_${profileName}`,
                    `cart_${profileName}`,
                    `preferences_${profileName}`,
                    `history_${profileName}`,
                    `stats_${profileName}`
                ];

                keysToClean.forEach(key => {
                    localStorage.removeItem(key);
                });

                console.log(`Cleaned up data for profile: ${profileName}`);
            } catch (error) {
                console.error('Error cleaning up profile data:', error);
            }
        }

        // Handle role selection change
        document.addEventListener('DOMContentLoaded', function() {
            const roleInputs = document.querySelectorAll('input[name="role"]');
            roleInputs.forEach(input => {
                input.addEventListener('change', function() {
                    if (this.checked) {
                        showRoleSpecificFields(this.value);
                    }
                });
            });

            // Handle profile picture upload
            const profilePictureInput = document.getElementById('profilePicture');
            if (profilePictureInput) {
                profilePictureInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('previewImg').src = e.target.result;
                            document.getElementById('uploadArea').style.display = 'none';
                            document.getElementById('imagePreview').style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Handle form submission
            const profileForm = document.getElementById('profileCreationForm');
            if (profileForm) {
                profileForm.addEventListener('submit', handleProfileCreation);
            }
        });

        function showRoleSpecificFields(role) {
            const container = document.getElementById('roleSpecificFields');
            container.classList.remove('hidden');

            let fieldsHTML = '';

            switch(role) {
                case 'golfer':
                    fieldsHTML = `
                        <h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="profile.golfer.info">Golfer Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="profile.handicap">Handicap <span class="text-red-500">*</span></label>
                                <input type="number" name="handicap" min="0" max="54" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="e.g. 18 (Enter 0 if unknown)">
                                <p class="text-xs text-gray-500 mt-1">Required. Enter your current handicap, or 0 if you don't have one yet.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="profile.experience.level">Experience Level</label>
                                <select name="experienceLevel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                    <option value="" data-i18n="profile.select.level">Select level...</option>
                                    <option value="Beginner" data-i18n="profile.beginner">Beginner</option>
                                    <option value="Intermediate" data-i18n="profile.intermediate">Intermediate</option>
                                    <option value="Advanced" data-i18n="profile.advanced">Advanced</option>
                                    <option value="Professional" data-i18n="profile.professional">Professional</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Club Affiliation</label>
                                <select name="clubAffiliation" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Select society...</option>
                                    <option value="Travellers Rest Group">Travellers Rest Group</option>
                                    <option value="Pattaya Sports Club">Pattaya Sports Club</option>
                                    <option value="Bunker Boys">Bunker Boys</option>
                                    <option value="Diego Dubbi Golf">Diego Dubbi Golf</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Playing Style</label>
                                <input type="text" name="playingStyle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="e.g. Aggressive, Conservative">
                            </div>
                        </div>
                    `;
                    break;

                case 'caddie':
                    fieldsHTML = `
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Caddy Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Home Golf Course <span class="text-red-500">*</span></label>
                                <select name="homeClub" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Select your golf course...</option>
                                    <option value="pattana-golf-resort">Pattana Golf Resort & Spa</option>
                                    <option value="pattaya-golf">Pattaya Golf Club</option>
                                    <option value="thai-country-club">Thai Country Club</option>
                                    <option value="laem-chabang">Laem Chabang International Country Club</option>
                                    <option value="siam-old">Siam Country Club (Old Course)</option>
                                    <option value="siam-plantation">Siam Country Club (Plantation)</option>
                                    <option value="siam-waterside">Siam Country Club (Waterside)</option>
                                    <option value="phoenix-gold">Phoenix Gold Golf & Country Club</option>
                                    <option value="st-andrews">St. Andrews 2000</option>
                                    <option value="burapha">Burapha Golf Club</option>
                                    <option value="greenwood">Greenwood Golf & Resort</option>
                                    <option value="bangpra">Bangpra International Golf Club</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Required. Select the golf course where you work.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Caddy Number <span class="text-red-500">*</span></label>
                                <input type="text" name="caddyNumber" required maxlength="3" pattern="[0-9]{1,3}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="e.g. 015" oninput="this.value = this.value.replace(/[^0-9]/g, '').padStart(Math.min(this.value.length, 3), '0')">
                                <p class="text-xs text-gray-500 mt-1">Required. Your official caddy number (3 digits: 001-999)</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Years of Experience</label>
                                <input type="number" name="experience" min="0" max="50" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="e.g. 5">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Specialty</label>
                                <select name="specialty" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Select specialty...</option>
                                    <option value="Championship Course">Championship Course</option>
                                    <option value="Beginner Support">Beginner Support</option>
                                    <option value="Tournament Play">Tournament Play</option>
                                    <option value="VIP Service">VIP Service</option>
                                    <option value="International Service">International Service</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Languages (select multiple)</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" name="languages" value="Thai" class="mr-2"> Thai
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="languages" value="English" class="mr-2"> English
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="languages" value="Japanese" class="mr-2"> Japanese
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="languages" value="Chinese" class="mr-2"> Chinese
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="languages" value="Korean" class="mr-2"> Korean
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Avatar</label>
                                <select name="avatar" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                    <option value="👨">👨 Man</option>
                                    <option value="👩">👩 Woman</option>
                                    <option value="👨‍🦲">👨‍🦲 Bald Man</option>
                                    <option value="👩‍🦲">👩‍🦲 Bald Woman</option>
                                    <option value="👨‍🦱">👨‍🦱 Curly Hair Man</option>
                                    <option value="👩‍🦱">👩‍🦱 Curly Hair Woman</option>
                                    <option value="👨‍🦳">👨‍🦳 White Hair Man</option>
                                    <option value="👩‍🦳">👩‍🦳 White Hair Woman</option>
                                </select>
                            </div>
                        </div>
                    `;
                    break;

                case 'manager':
                    fieldsHTML = `
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Manager Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                                <select name="department" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Select department...</option>
                                    <option value="Operations">Operations</option>
                                    <option value="Food & Beverage">Food & Beverage</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Guest Services">Guest Services</option>
                                    <option value="Pro Shop">Pro Shop</option>
                                    <option value="Events">Events</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Years in Management</label>
                                <input type="number" name="managementExperience" min="0" max="50" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="e.g. 3">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Certifications</label>
                                <input type="text" name="certifications" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="e.g. PGA, GCSAA, etc.">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Emergency Contact</label>
                                <input type="tel" name="emergencyContact" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="Emergency contact number">
                            </div>
                        </div>
                    `;
                    break;

                case 'proshop':
                    fieldsHTML = `
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Pro Shop Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Position</label>
                                <select name="position" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Select position...</option>
                                    <option value="Manager">Manager</option>
                                    <option value="Sales Associate">Sales Associate</option>
                                    <option value="Golf Professional">Golf Professional</option>
                                    <option value="Assistant Pro">Assistant Pro</option>
                                    <option value="Inventory Specialist">Inventory Specialist</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Retail Experience (years)</label>
                                <input type="number" name="retailExperience" min="0" max="50" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="e.g. 2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Golf Knowledge Level</label>
                                <select name="golfKnowledge" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Select level...</option>
                                    <option value="Basic">Basic</option>
                                    <option value="Intermediate">Intermediate</option>
                                    <option value="Advanced">Advanced</option>
                                    <option value="Expert">Expert</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Equipment Fitting Certified</label>
                                <select name="fittingCertified" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                    <option value="no">No</option>
                                    <option value="yes">Yes</option>
                                </select>
                            </div>
                        </div>
                    `;
                    break;

                case 'maintenance':
                    fieldsHTML = `
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Maintenance Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Specialty Area</label>
                                <select name="maintenanceSpecialty" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Select specialty...</option>
                                    <option value="Greens">Greens Maintenance</option>
                                    <option value="Fairways">Fairways</option>
                                    <option value="Irrigation">Irrigation Systems</option>
                                    <option value="Equipment">Equipment Maintenance</option>
                                    <option value="Landscaping">Landscaping</option>
                                    <option value="Pest Control">Pest Control</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Years Experience</label>
                                <input type="number" name="maintenanceExperience" min="0" max="50" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="e.g. 8">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Certifications</label>
                                <input type="text" name="maintenanceCertifications" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="e.g. Pesticide License, GCSAA">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Shift Preference</label>
                                <select name="shiftPreference" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Select preference...</option>
                                    <option value="Early Morning">Early Morning (5:00-13:00)</option>
                                    <option value="Day">Day (8:00-16:00)</option>
                                    <option value="Afternoon">Afternoon (13:00-21:00)</option>
                                    <option value="Flexible">Flexible</option>
                                </select>
                            </div>
                        </div>
                    `;
                    break;

                case 'society':
                    fieldsHTML = `
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Society Organizer Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Society/Group Name</label>
                                <input type="text" name="societyName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="e.g. Travellers Rest Group">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Role in Society</label>
                                <select name="societyRole" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Select role...</option>
                                    <option value="President">President</option>
                                    <option value="Vice President">Vice President</option>
                                    <option value="Secretary">Secretary</option>
                                    <option value="Treasurer">Treasurer</option>
                                    <option value="Event Organizer">Event Organizer</option>
                                    <option value="Member">Member</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Years Organizing Events</label>
                                <input type="number" name="organizingExperience" min="0" max="50" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="e.g. 3">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Group Size</label>
                                <select name="groupSize" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Select size...</option>
                                    <option value="Small (5-20)">Small (5-20 members)</option>
                                    <option value="Medium (20-50)">Medium (20-50 members)</option>
                                    <option value="Large (50-100)">Large (50-100 members)</option>
                                    <option value="Very Large (100+)">Very Large (100+ members)</option>
                                </select>
                            </div>
                        </div>
                    `;
                    break;

                case 'caddymaster':
                    fieldsHTML = `
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Caddy Master Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Years in Management</label>
                                <input type="number" name="managementExperience" min="0" max="50" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="e.g. 5">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Caddy Team Size</label>
                                <select name="caddyTeamSize" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Select team size...</option>
                                    <option value="Small (1-10)">Small (1-10 caddies)</option>
                                    <option value="Medium (10-25)">Medium (10-25 caddies)</option>
                                    <option value="Large (25-50)">Large (25-50 caddies)</option>
                                    <option value="Very Large (50+)">Very Large (50+ caddies)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Scheduling Experience</label>
                                <select name="schedulingExperience" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Select level...</option>
                                    <option value="Basic">Basic</option>
                                    <option value="Intermediate">Intermediate</option>
                                    <option value="Advanced">Advanced</option>
                                    <option value="Expert">Expert</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Certifications</label>
                                <input type="text" name="certifications" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="e.g. PGA, Golf Management">
                            </div>
                        </div>
                    `;
                    break;

                case 'restaurant':
                    fieldsHTML = `
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Restaurant Staff Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Position</label>
                                <select name="position" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Select position...</option>
                                    <option value="Chef">Chef</option>
                                    <option value="Sous Chef">Sous Chef</option>
                                    <option value="Server">Server</option>
                                    <option value="Bartender">Bartender</option>
                                    <option value="Host/Hostess">Host/Hostess</option>
                                    <option value="Kitchen Staff">Kitchen Staff</option>
                                    <option value="Manager">Manager</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Culinary Experience (years)</label>
                                <input type="number" name="culinaryExperience" min="0" max="50" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="e.g. 3">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Service Experience (years)</label>
                                <input type="number" name="serviceExperience" min="0" max="50" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="e.g. 2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Certifications</label>
                                <input type="text" name="certifications" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="e.g. Food Safety, Sommelier">
                            </div>
                        </div>
                    `;
                    break;
            }

            container.innerHTML = fieldsHTML;
        }

        function removeImage() {
            document.getElementById('profilePicture').value = '';
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('imagePreview').style.display = 'none';
        }

        // Initialize profile picture upload handler
        document.addEventListener('DOMContentLoaded', function() {
            const profilePictureInput = document.getElementById('profilePicture');
            if (profilePictureInput) {
                profilePictureInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('previewImg').src = e.target.result;
                            document.getElementById('uploadArea').style.display = 'none';
                            document.getElementById('imagePreview').style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        // Username availability check
        let usernameCheckTimeout;
        async function checkUsernameAvailabilityInModal(username) {
            clearTimeout(usernameCheckTimeout);

            const statusEl = document.getElementById('usernameStatusModal');
            const messageEl = document.getElementById('usernameMessageModal');

            // Validate format
            if (!username || username.length < 3) {
                statusEl.innerHTML = '';
                messageEl.innerHTML = username ? '<span class="text-gray-500">Username must be at least 3 characters</span>' : '';
                return;
            }

            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                statusEl.innerHTML = '<span class="text-red-500">✖</span>';
                messageEl.innerHTML = '<span class="text-red-500">Only letters, numbers, and underscores allowed</span>';
                return;
            }

            // Show checking status
            statusEl.innerHTML = '<span class="text-gray-400">⌛</span>';
            messageEl.innerHTML = '<span class="text-gray-500">Checking availability...</span>';

            // Debounce API call
            usernameCheckTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/.netlify/functions/profiles?username=${encodeURIComponent(username)}`);
                    const raw = await res.clone().text();
                    console.log('[exchange] status', res.status, raw);
                    const data = JSON.parse(raw || '{}');

                    if (!response.ok || !data.success) {
                        statusEl.innerHTML = '<span class="text-green-500">✓</span>';
                        messageEl.innerHTML = '<span class="text-blue-500">Username available (database temporarily unavailable)</span>';
                        return;
                    }

                    if (data.available) {
                        statusEl.innerHTML = '<span class="text-green-500">✓</span>';
                        messageEl.innerHTML = '<span class="text-green-500">Username available!</span>';
                    } else {
                        statusEl.innerHTML = '<span class="text-red-500">✖</span>';
                        messageEl.innerHTML = '<span class="text-red-500">Username already taken</span>';
                    }
                } catch (error) {
                    console.error('Error checking username:', error);
                    statusEl.innerHTML = '<span class="text-green-500">✓</span>';
                    messageEl.innerHTML = '<span class="text-blue-500">Username available (verification unavailable)</span>';
                }
            }, 500);
        }

        async function checkUsernameAvailability(username) {
            clearTimeout(usernameCheckTimeout);

            const statusEl = document.getElementById('usernameStatus');
            const messageEl = document.getElementById('usernameMessage');

            // Validate username format
            if (!username || username.length < 3) {
                statusEl.innerHTML = '';
                messageEl.innerHTML = username ? '<span class="text-gray-500">Username must be at least 3 characters</span>' : '';
                return;
            }

            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                statusEl.innerHTML = '<span class="text-red-500">✖</span>';
                messageEl.innerHTML = '<span class="text-red-500">Only letters, numbers, and underscores allowed</span>';
                return;
            }

            // Show checking status
            statusEl.innerHTML = '<span class="text-gray-400">⌛</span>';
            messageEl.innerHTML = '<span class="text-gray-500">Checking availability...</span>';

            // Debounce the API call
            usernameCheckTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/.netlify/functions/profiles?username=${encodeURIComponent(username)}`);
                    const raw = await res.clone().text();
                    console.log('[exchange] status', res.status, raw);
                    const data = JSON.parse(raw || '{}');

                    // Check if the response was successful
                    if (!response.ok || !data.success) {
                        console.error('API Error:', data.error || 'Unknown error');
                        statusEl.innerHTML = '<span class="text-green-500">✓</span>';
                        messageEl.innerHTML = '<span class="text-blue-500">Username available (database temporarily unavailable)</span>';
                        return;
                    }

                    if (data.available) {
                        statusEl.innerHTML = '<span class="text-green-500">✓</span>';
                        messageEl.innerHTML = '<span class="text-green-500">Username available!</span>';
                    } else {
                        statusEl.innerHTML = '<span class="text-red-500">✖</span>';
                        messageEl.innerHTML = '<span class="text-red-500">Username already taken</span>';
                    }
                } catch (error) {
                    console.error('Error checking username:', error);
                    statusEl.innerHTML = '<span class="text-green-500">✓</span>';
                    messageEl.innerHTML = '<span class="text-blue-500">Username available (verification unavailable)</span>';
                }
            }, 500);
        }

        async function handleProfileCreation(event) {
            event.preventDefault();

            // SECURITY: Check if LINE is authenticated
            let lineUserId = null;
            if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                const lineProfile = await liff.getProfile();
                lineUserId = lineProfile.userId;
            } else {
                alert('❌ LINE authentication required to create a profile. Please login with LINE first.');
                return;
            }

            const formData = new FormData(event.target);
            const profileData = {};

            // Get basic information
            profileData.username = formData.get('username');
            profileData.firstName = formData.get('firstName');
            profileData.lastName = formData.get('lastName');
            profileData.email = formData.get('email') || null; // Optional
            profileData.phone = formData.get('phone');
            profileData.role = formData.get('role');
            profileData.homeClub = formData.get('homeClub');
            profileData.additionalInfo = formData.get('additionalInfo');

            // SECURITY: Link profile to LINE User ID (permanent ownership)
            profileData.lineUserId = lineUserId;

            // Get role-specific data
            const roleSpecificData = {};
            switch(profileData.role) {
                case 'golfer':
                    roleSpecificData.handicap = formData.get('handicap');
                    roleSpecificData.experienceLevel = formData.get('experienceLevel');
                    roleSpecificData.clubAffiliation = formData.get('clubAffiliation');
                    roleSpecificData.playingStyle = formData.get('playingStyle');
                    break;
                case 'caddie':
                    roleSpecificData.caddyNumber = formData.get('caddyNumber'); // Required 3-digit number
                    roleSpecificData.homeClub = formData.get('homeClub'); // Required golf course
                    roleSpecificData.experience = formData.get('experience');
                    roleSpecificData.specialty = formData.get('specialty');
                    roleSpecificData.avatar = formData.get('avatar');
                    // Get selected languages
                    const languages = formData.getAll('languages');
                    roleSpecificData.languages = languages;
                    break;
                case 'manager':
                    roleSpecificData.department = formData.get('department');
                    roleSpecificData.managementExperience = formData.get('managementExperience');
                    roleSpecificData.certifications = formData.get('certifications');
                    roleSpecificData.emergencyContact = formData.get('emergencyContact');
                    break;
                case 'proshop':
                    roleSpecificData.position = formData.get('position');
                    roleSpecificData.retailExperience = formData.get('retailExperience');
                    roleSpecificData.golfKnowledge = formData.get('golfKnowledge');
                    roleSpecificData.fittingCertified = formData.get('fittingCertified');
                    break;
                case 'maintenance':
                    roleSpecificData.maintenanceSpecialty = formData.get('maintenanceSpecialty');
                    roleSpecificData.maintenanceExperience = formData.get('maintenanceExperience');
                    roleSpecificData.maintenanceCertifications = formData.get('maintenanceCertifications');
                    roleSpecificData.shiftPreference = formData.get('shiftPreference');
                    break;
                case 'society':
                    roleSpecificData.societyName = formData.get('societyName');
                    roleSpecificData.societyRole = formData.get('societyRole');
                    roleSpecificData.organizingExperience = formData.get('organizingExperience');
                    roleSpecificData.groupSize = formData.get('groupSize');
                    break;
                case 'caddymaster':
                    roleSpecificData.managementExperience = formData.get('managementExperience');
                    roleSpecificData.caddyTeamSize = formData.get('caddyTeamSize');
                    roleSpecificData.schedulingExperience = formData.get('schedulingExperience');
                    roleSpecificData.certifications = formData.get('certifications');
                    break;
                case 'restaurant':
                    roleSpecificData.position = formData.get('position');
                    roleSpecificData.culinaryExperience = formData.get('culinaryExperience');
                    roleSpecificData.serviceExperience = formData.get('serviceExperience');
                    roleSpecificData.certifications = formData.get('certifications');
                    break;
            }

            profileData.roleSpecific = roleSpecificData;

            // Handle profile picture
            const profilePicture = formData.get('profilePicture');
            if (profilePicture && profilePicture.size > 0) {
                // In a real application, you would upload this to a server
                // For now, we'll use a data URL
                const reader = new FileReader();
                reader.onload = function(e) {
                    profileData.profilePicture = e.target.result;
                    saveProfile(profileData);
                };
                reader.readAsDataURL(profilePicture);
            } else {
                saveProfile(profileData);
            }
        }

        async function saveProfile(profileData) {
            try {
                // Show loading state
                const submitBtn = document.querySelector('#profileCreationForm button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="material-symbols-outlined animate-spin">refresh</span> Creating Profile...';
                }

                // Save to Netlify Blobs via API
                const response = await fetch('/.netlify/functions/profiles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Failed to create profile');
                }

                // Use the profile returned from the API (includes id, createdAt, updatedAt)
                const savedProfile = result.profile;

                // Also save to localStorage for quick access
                const existingProfiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');
                existingProfiles.push(savedProfile);
                localStorage.setItem('mcipro_user_profiles', JSON.stringify(existingProfiles));

                // Use lineUserId as unique ID for new profiles
                const uniqueId = savedProfile.lineUserId;

                // Set current user with username
                currentUser = {
                    id: savedProfile.id,
                    username: savedProfile.username,
                    role: savedProfile.role,
                    name: `${savedProfile.firstName} ${savedProfile.lastName}`,
                    userId: uniqueId, // UNIQUE ID - lineUserId for new profiles
                    lineUserId: uniqueId,
                    email: savedProfile.email,
                    phone: savedProfile.phone,
                    profileData: savedProfile
                };

                // Also store this profile in the expected format for ProfileSystem using UNIQUE ID KEY
                const profileKey = UserIDSystem.getProfileKey(savedProfile.role, uniqueId);
                const formattedProfile = {
                    userId: uniqueId,
                    lineUserId: uniqueId,
                    personalInfo: {
                        firstName: savedProfile.firstName,
                        lastName: savedProfile.lastName,
                        email: savedProfile.email,
                        phone: savedProfile.phone,
                        username: savedProfile.username
                    },
                    roleSpecific: savedProfile.roleSpecific,
                    createdAt: savedProfile.createdAt,
                    updatedAt: savedProfile.updatedAt,
                    id: savedProfile.id
                };
                localStorage.setItem(profileKey, JSON.stringify(formattedProfile));

                console.log('[ProfileCreation] ✓ New profile saved with unique ID:', {
                    uniqueId: uniqueId.substring(0, 12) + '...',
                    profileKey: profileKey,
                    name: currentUser.name
                });

                // Trigger cloud sync after profile creation
                if (typeof ProductionCloudSync !== 'undefined') {
                    console.log('[ProfileCreation] Triggering cloud sync for new profile');
                    SimpleCloudSync.saveToCloudSoon();
                }

                NotificationManager.show(`Profile created successfully! Welcome @${savedProfile.username}!`, 'success');

                // Login with the new profile
                setTimeout(() => {
                    loginWithCustomProfile(savedProfile);
                }, 1500);

            } catch (error) {
                console.error('Error saving profile:', error);
                NotificationManager.show(error.message || 'Error creating profile. Please try again.', 'error');

                // Re-enable submit button on error
                const submitBtn = document.querySelector('#profileCreationForm button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<span class="material-symbols-outlined">person_add</span> Create Profile';
                }
            }
        }

        window.loginWithLINE = function() {
            LineAuthentication.loginWithLINE();
        };

        window.showOTPScreen = function() {
            OTPAuthentication.showOTPScreen();
        };

        window.sendOTP = function() {
            OTPAuthentication.sendOTP();
        };

        window.verifyOTP = function() {
            OTPAuthentication.verifyOTP();
        };

        function sendEmergencyAlert() {
            EmergencySystem.sendAlert();
        }

        // DUPLICATE BOOKING CLEANUP FUNCTIONS
        function removeDuplicateBookings() {
            if (typeof BookingManager !== 'undefined') {
                const removed = BookingManager.removeDuplicateBookings();
                console.log(`✅ Removed ${removed} duplicate bookings`);
                // Refresh UI
                if (typeof ScheduleSystem !== 'undefined') {
                    ScheduleSystem.refreshStats();
                }
                return removed;
            } else {
                console.log('❌ BookingManager not available');
                return 0;
            }
        }

        function clearAllBookings() {
            if (typeof BookingManager !== 'undefined') {
                const cleared = BookingManager.clearAllBookings();
                console.log(`✅ Cleared ${cleared} bookings`);
                // Refresh UI
                if (typeof ScheduleSystem !== 'undefined') {
                    ScheduleSystem.refreshStats();
                }
                return cleared;
            } else {
                console.log('❌ BookingManager not available');
                return 0;
            }
        }

        // Tab-specific functions (will be expanded in later phases)
        function showGolferTab(tabName, event) {
            TabManager.showTab('golferDashboard', tabName, event);

            // Update Today's Tee Time when showing overview
            if (tabName === 'overview' && typeof TodaysTeeTimeManager !== 'undefined') {
                setTimeout(() => {
                    TodaysTeeTimeManager.updateTodaysTeeTime();

                    // Force reset Performance Overview stats to zero state (prevent cloud data from overwriting)
                    const bestScoreEl = document.getElementById('bestScore');
                    const avgScoreEl = document.getElementById('avgScore');
                    const totalRoundsEl = document.getElementById('totalRounds');
                    const eaglesCountEl = document.getElementById('eaglesCount');

                    if (bestScoreEl) bestScoreEl.textContent = '-';
                    if (avgScoreEl) avgScoreEl.textContent = '-';
                    if (totalRoundsEl) totalRoundsEl.textContent = '0';
                    if (eaglesCountEl) eaglesCountEl.textContent = '0';
                }, 100);
            }

            // Initialize Round History filters when showing rounds tab
            if (tabName === 'rounds' && typeof GolfScoreSystem !== 'undefined') {
                setTimeout(() => {
                    GolfScoreSystem.initializeYearFilter();
                    GolfScoreSystem.loadRoundHistoryTable();
                    GolfScoreSystem.renderHandicapProgression();
                    console.log('[Round History] Tab initialized');
                }, 100);
            }

            // Initialize Society Events when that tab is shown
            if (tabName === 'societyevents' && typeof GolferEventsSystem !== 'undefined') {
                setTimeout(() => {
                    GolferEventsSystem.init();
                }, 100);
            }
        }

        function showCaddyTab(tabName, event) {
            TabManager.showTab('caddieDashboard', tabName, event);
        }

        function showManagerTab(tabName, event) {
            TabManager.showTab('managerDashboard', tabName, event);

            // Initialize radar map when weather tab is shown
            if (tabName === 'weather' && typeof WeatherIntegration !== 'undefined') {
                setTimeout(() => {
                    WeatherIntegration.initializeRadarMap();
                }, 100);  // Small delay to ensure container is visible
            }
        }

        // ===========================================================
        // TRAFFIC MONITOR MODULE - Dynamic Hole Rendering & History
        // ===========================================================
        // Traffic Monitor Module with GPS Integration and Real Hole Tracking
const TrafficMonitor = {
    courseConfig: 18, // 9, 18, 27, or 36
    currentNineView: 1, // Which nine are we viewing (1-4)
    holeHistory: {}, // Store hole history {holeNumber: [{timestamp, type, message}]}
    holeEscalation: {}, // Track escalation level per hole {holeNumber: {level: 0-3, lastContact: timestamp, groupId: string}}

    // Preset messages for escalation
    presetMessages: {
        contact1: {
            level: 1,
            message: "Your group is behind pace",
            icon: "info",
            color: "blue",
            requiresAck: false
        },
        contact2: {
            level: 2,
            message: "Please pick up the pace",
            icon: "warning",
            color: "yellow",
            requiresAck: true
        },
        marshal: {
            level: 3,
            message: "Marshal dispatched to your location",
            icon: "local_police",
            color: "red",
            requiresAck: false
        }
    },

    init() {
        // Load settings from localStorage
        const settings = JSON.parse(localStorage.getItem('golf_course_settings') || '{}');
        this.courseConfig = settings.totalHoles || 18;

        // Load hole history
        this.holeHistory = JSON.parse(localStorage.getItem('mcipro_hole_history') || '{}');

        // Load escalation tracking
        this.holeEscalation = JSON.parse(localStorage.getItem('mcipro_hole_escalation') || '{}');

        // Render initial view
        this.updateCourseConfig();

        // Check for pace issues every 30 seconds
        setInterval(() => this.checkPaceOfPlay(), 30000);

        // Update hole status from GPS every 10 seconds
        setInterval(() => this.syncGPSWithBookings(), 10000);
    },

    syncGPSWithBookings() {
        // Update bookings with GPS hole positions from caddy tracking
        if (!window.GPSNavigationSystem) return;

        const bookings = JSON.parse(localStorage.getItem('mcipro_bookings_cloud') || '{"bookings": []}');
        const gpsPositions = JSON.parse(localStorage.getItem('mcipro_gps_positions') || '{}');

        let updated = false;

        bookings.bookings.forEach(booking => {
            if (booking.status !== 'confirmed' && booking.status !== 'checked-in') return;
            if (!booking.caddyNumber) return;

            // Check if this caddy has GPS position data
            const caddyPos = gpsPositions[booking.caddyNumber];
            if (caddyPos && caddyPos.currentHole) {
                if (booking.currentHole !== caddyPos.currentHole) {
                    booking.currentHole = caddyPos.currentHole;
                    booking.lastHoleUpdate = Date.now();
                    updated = true;
                    console.log(`[TrafficMonitor] Updated booking ${booking.id} to hole ${caddyPos.currentHole} from GPS`);
                }
            }
        });

        if (updated) {
            localStorage.setItem('mcipro_bookings_cloud', JSON.stringify(bookings));
            this.renderHoles(); // Refresh display
        }
    },

    updateCourseConfig() {
        const selector = document.getElementById('courseConfigSelector');
        if (!selector) return;

        this.courseConfig = parseInt(selector.value);

        // Show/hide nine selector based on course config
        const nineSelectorWrapper = document.getElementById('nineSelectorWrapper');
        const nineSelector = document.getElementById('nineSelector');
        if (nineSelectorWrapper && nineSelector) {
            if (this.courseConfig > 18) {
                nineSelectorWrapper.classList.remove('hidden');
                // Update nine selector options
                this.updateNineSelectorOptions();
            } else {
                nineSelectorWrapper.classList.add('hidden');
            }
        }

        // Reset to first nine
        this.currentNineView = 1;
        this.renderHoles();
    },

    updateNineSelectorOptions() {
        const nineSelector = document.getElementById('nineSelector');
        if (!nineSelector) return;

        let options = '';
        const numNines = Math.ceil(this.courseConfig / 9);

        for (let i = 1; i <= numNines; i++) {
            const startHole = (i - 1) * 9 + 1;
            const endHole = Math.min(i * 9, this.courseConfig);
            let label = '';

            if (i === 1) label = `Nine A (${startHole}-${endHole})`;
            else if (i === 2) label = `Nine B (${startHole}-${endHole})`;
            else if (i === 3) label = `Nine C (${startHole}-${endHole})`;
            else if (i === 4) label = `Nine D (${startHole}-${endHole})`;

            options += `<option value="${i}">${label}</option>`;
        }

        nineSelector.innerHTML = options;
    },

    changeNineView() {
        const nineSelector = document.getElementById('nineSelector');
        if (!nineSelector) return;

        this.currentNineView = parseInt(nineSelector.value);
        this.renderHoles();
    },

    renderHoles() {
        const grid = document.getElementById('trafficHoleGrid');
        const label = document.getElementById('currentViewLabel');
        if (!grid) return;

        // Calculate which holes to show and display
        let startHole, endHole, displayStart, displayEnd;

        if (this.courseConfig === 9) {
            startHole = 1; endHole = 9;
            displayStart = 1; displayEnd = 9;
        } else if (this.courseConfig === 18) {
            startHole = 1; endHole = 18;
            displayStart = 1; displayEnd = 18;
        } else {
            // 27 or 36 hole course - show 9 at a time, always display as 1-9
            startHole = (this.currentNineView - 1) * 9 + 1;
            endHole = Math.min(this.currentNineView * 9, this.courseConfig);
            displayStart = 1;
            displayEnd = 9;
        }

        // Update label
        if (label) {
            if (this.courseConfig > 18) {
                const nineName = this.currentNineView === 1 ? 'Nine A' :
                                 this.currentNineView === 2 ? 'Nine B' :
                                 this.currentNineView === 3 ? 'Nine C' : 'Nine D';
                label.textContent = `${nineName} (Holes 1-9)`;
            } else if (displayStart === displayEnd) {
                label.textContent = `Hole ${displayStart}`;
            } else {
                label.textContent = `Holes ${displayStart}-${displayEnd}`;
            }
        }

        // Render holes with professional styling
        let holesHTML = '';
        let displayNumber = displayStart;
        for (let i = startHole; i <= endHole; i++) {
            const status = this.getHoleStatus(i);

            let bgColor, ringColor, shadowColor, textColor;
            if (status === 'Clear') {
                bgColor = 'bg-green-400';
                ringColor = 'ring-green-200';
                shadowColor = 'shadow-green-100';
                textColor = 'text-white';
            } else if (status === 'Busy') {
                bgColor = 'bg-yellow-400';
                ringColor = 'ring-yellow-200';
                shadowColor = 'shadow-yellow-100';
                textColor = 'text-gray-900';
            } else {
                bgColor = 'bg-red-400';
                ringColor = 'ring-red-200';
                shadowColor = 'shadow-red-100';
                textColor = 'text-white';
            }

            holesHTML += `
                <div onclick="TrafficMonitor.showHoleDetails(${i})"
                     class="hole-marker cursor-pointer transition-all duration-200 hover:scale-110 hover:shadow-lg"
                     data-hole="${i}"
                     data-display="${displayNumber}">
                    <div class="w-12 h-12 rounded-full ${bgColor} ${shadowColor} shadow-md ring-4 ${ringColor} flex items-center justify-center font-bold ${textColor} text-base relative">
                        ${displayNumber}
                        <div class="absolute inset-0 rounded-full bg-white opacity-0 hover:opacity-10 transition-opacity"></div>
                    </div>
                </div>
            `;
            displayNumber++;
        }

        grid.innerHTML = holesHTML;
    },

    getHoleStatus(holeNumber) {
        // Get real status from active bookings with GPS-tracked hole positions
        const bookings = JSON.parse(localStorage.getItem('mcipro_bookings_cloud') || '{"bookings": []}');
        const activeBookingsOnHole = bookings.bookings.filter(b =>
            (b.status === 'confirmed' || b.status === 'checked-in') && b.currentHole === holeNumber
        );

        // Check escalation status first
        const escalation = this.holeEscalation[holeNumber];
        if (escalation) {
            if (escalation.level >= 2) return 'Backed Up';
            if (escalation.level === 1) return 'Busy';
        }

        // If bookings on this hole, it's busy
        if (activeBookingsOnHole.length > 0) return 'Busy';

        // Otherwise it's clear
        return 'Clear';
    },

    showHoleDetails(holeNumber) {
        const panel = document.getElementById('holeDetailsPanel');
        if (!panel) return;

        const status = this.getHoleStatus(holeNumber);
        const statusColor = status === 'Clear' ? 'text-green-600' : status === 'Busy' ? 'text-yellow-600' : 'text-red-600';
        const statusBg = status === 'Clear' ? 'bg-green-50 border-green-200' : status === 'Busy' ? 'bg-yellow-50 border-yellow-200' : 'bg-red-50 border-red-200';

        // Calculate display number based on current view
        let displayNumber = holeNumber;
        let nineLabel = '';

        if (this.courseConfig > 18) {
            displayNumber = ((holeNumber - 1) % 9) + 1;
            const nineIndex = Math.floor((holeNumber - 1) / 9) + 1;
            nineLabel = nineIndex === 1 ? 'Nine A' :
                       nineIndex === 2 ? 'Nine B' :
                       nineIndex === 3 ? 'Nine C' : 'Nine D';
        }

        // Get group info on this hole
        const groupInfo = this.getGroupOnHole(holeNumber);

        // Get escalation status
        const escalation = this.holeEscalation[holeNumber] || { level: 0 };

        // Get hole history
        const history = this.holeHistory[holeNumber] || [];
        const recentHistory = history.slice(-5).reverse();

        panel.innerHTML = `
            <div class="${statusBg} border rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <h4 class="text-lg font-bold text-gray-900">${nineLabel ? nineLabel + ', ' : ''}Hole ${displayNumber}</h4>
                        <p class="text-xs text-gray-600">Status: <span class="font-semibold ${statusColor}">${status}</span></p>
                        ${groupInfo ? `<p class="text-xs text-gray-500 mt-1">📍 ${groupInfo}</p>` : ''}
                        ${escalation.level > 0 ? `<p class="text-xs text-orange-600 font-semibold mt-1">⚠️ Escalation Level ${escalation.level}</p>` : ''}
                    </div>
                    <button onclick="TrafficMonitor.closeHoleDetails()" class="text-gray-400 hover:text-gray-600">
                        <span class="material-symbols-outlined text-sm">close</span>
                    </button>
                </div>

                ${recentHistory.length > 0 ? `
                    <div class="mt-3">
                        <h5 class="text-xs font-semibold text-gray-700 mb-2">Recent Activity</h5>
                        <div class="space-y-1.5">
                            ${recentHistory.map(event => {
                                let icon = 'info';
                                let iconColor = 'text-blue-500';
                                if (event.type === 'warning') {
                                    icon = 'warning';
                                    iconColor = 'text-yellow-500';
                                } else if (event.type === 'marshal') {
                                    icon = 'local_police';
                                    iconColor = 'text-red-500';
                                } else if (event.type === 'notification') {
                                    icon = 'notifications';
                                    iconColor = 'text-blue-500';
                                }

                                const timeAgo = this.getTimeAgo(event.timestamp);

                                return `
                                    <div class="flex items-start gap-2 bg-white p-2 rounded text-xs">
                                        <span class="material-symbols-outlined ${iconColor}" style="font-size: 14px;">${icon}</span>
                                        <div class="flex-1">
                                            <p class="text-gray-700">${event.message}</p>
                                            <p class="text-gray-400 text-xs mt-0.5">${timeAgo}</p>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : `
                    <div class="text-center py-3 text-gray-500">
                        <p class="text-xs">No recent activity on this hole</p>
                    </div>
                `}

                <div class="mt-3 space-y-2">
                    <!-- Escalation Contacts -->
                    <div class="flex gap-2">
                        <button onclick="TrafficMonitor.sendPresetMessage(${holeNumber}, 'contact1')"
                                class="flex-1 text-xs px-2 py-1.5 ${escalation.level >= 1 ? 'bg-gray-300 text-gray-600' : 'bg-blue-500 text-white hover:bg-blue-600'} rounded"
                                ${escalation.level >= 1 ? 'disabled' : ''}>
                            <span class="material-symbols-outlined text-xs">info</span> Contact 1
                        </button>
                        <button onclick="TrafficMonitor.sendPresetMessage(${holeNumber}, 'contact2')"
                                class="flex-1 text-xs px-2 py-1.5 ${escalation.level >= 2 ? 'bg-gray-300 text-gray-600' : escalation.level === 0 ? 'bg-gray-300 text-gray-600' : 'bg-yellow-500 text-white hover:bg-yellow-600'} rounded"
                                ${escalation.level !== 1 ? 'disabled' : ''}>
                            <span class="material-symbols-outlined text-xs">warning</span> Contact 2
                        </button>
                    </div>

                    <!-- Send Marshal Now -->
                    <button onclick="TrafficMonitor.sendMarshalNow(${holeNumber})"
                            class="w-full text-xs px-2 py-1.5 bg-red-500 text-white rounded hover:bg-red-600">
                        <span class="material-symbols-outlined text-xs">local_police</span> Send Marshal Now
                    </button>

                    <!-- View Group Details -->
                    <button onclick="TrafficMonitor.viewGroupDetails(${holeNumber})"
                            class="w-full text-xs px-2 py-1.5 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                        <span class="material-symbols-outlined text-xs">group</span> View Group Details
                    </button>
                </div>
            </div>
        `;
    },

    closeHoleDetails() {
        const panel = document.getElementById('holeDetailsPanel');
        if (panel) {
            panel.innerHTML = `
                <div class="text-center text-gray-500">
                    <span class="material-symbols-outlined text-2xl text-gray-400 mb-1 block">golf_course</span>
                    <p class="text-xs">Tap any hole to view details & history</p>
                </div>
            `;
        }
    },

    sendPresetMessage(holeNumber, contactType) {
        const preset = this.presetMessages[contactType];
        if (!preset) return;

        const groupInfo = this.getGroupOnHole(holeNumber) || `Unknown Group (Hole ${holeNumber})`;

        // Update escalation tracking
        if (!this.holeEscalation[holeNumber]) {
            this.holeEscalation[holeNumber] = { level: 0 };
        }
        this.holeEscalation[holeNumber].level = preset.level;
        this.holeEscalation[holeNumber].lastContact = Date.now();
        this.holeEscalation[holeNumber].groupId = groupInfo;
        localStorage.setItem('mcipro_hole_escalation', JSON.stringify(this.holeEscalation));

        // Add to hole history
        this.addHoleEvent(holeNumber, contactType === 'contact1' ? 'notification' : 'warning', preset.message);

        // Send notification to caddies via alert system
        this.sendPaceNotification(holeNumber, preset, groupInfo);

        // Show confirmation
        if (typeof NotificationManager !== 'undefined') {
            NotificationManager.show(`${preset.message} sent to ${groupInfo}`, 'success');
        }

        // Refresh display
        this.showHoleDetails(holeNumber);

        console.log(`[TrafficMonitor] Sent ${contactType} to hole ${holeNumber}: ${preset.message}`);
    },

    sendMarshalNow(holeNumber) {
        const preset = this.presetMessages.marshal;
        const groupInfo = this.getGroupOnHole(holeNumber);

        // Update escalation to marshal level
        if (!this.holeEscalation[holeNumber]) {
            this.holeEscalation[holeNumber] = { level: 0 };
        }
        this.holeEscalation[holeNumber].level = 3;
        this.holeEscalation[holeNumber].lastContact = Date.now();
        this.holeEscalation[holeNumber].groupId = groupInfo || 'Unknown Group';
        localStorage.setItem('mcipro_hole_escalation', JSON.stringify(this.holeEscalation));

        // Add to hole history
        this.addHoleEvent(holeNumber, 'marshal', preset.message);

        // Send marshal notification
        this.sendMarshalNotification(holeNumber, preset, groupInfo);

        // Show confirmation
        if (typeof NotificationManager !== 'undefined') {
            NotificationManager.show(`Marshal dispatched to hole ${holeNumber}`, 'success');
        }

        // Refresh display
        this.showHoleDetails(holeNumber);

        console.log(`[TrafficMonitor] Marshal dispatched to hole ${holeNumber}`);
    },

    sendPaceNotification(holeNumber, preset, groupInfo) {
        // Use existing alert notification infrastructure (like Stop Play, Lightning, Cart Alerts)
        const notification = {
            id: 'PACE' + Date.now().toString().slice(-6),
            type: 'pace_warning',
            level: preset.level,
            hole: holeNumber,
            message: preset.message,
            groupInfo: groupInfo,
            timestamp: new Date().toISOString(),
            requiresAck: preset.requiresAck,
            icon: preset.icon,
            color: preset.color
        };

        // Store in pace notifications
        const paceNotifications = JSON.parse(localStorage.getItem('mcipro_pace_notifications') || '[]');
        paceNotifications.push(notification);
        localStorage.setItem('mcipro_pace_notifications', JSON.stringify(paceNotifications));

        // TODO: Send to caddies via notification system (not chat)
        // This would integrate with EmergencySystem or NotificationManager for delivery
        console.log('[TrafficMonitor] Pace notification created:', notification);
    },

    sendMarshalNotification(holeNumber, preset, groupInfo) {
        const notification = {
            id: 'MRSH' + Date.now().toString().slice(-6),
            type: 'marshal_dispatch',
            hole: holeNumber,
            message: preset.message,
            groupInfo: groupInfo || 'Unknown Group',
            timestamp: new Date().toISOString(),
            icon: preset.icon,
            color: preset.color
        };

        // Store marshal dispatches
        const marshalDispatches = JSON.parse(localStorage.getItem('mcipro_marshal_dispatches') || '[]');
        marshalDispatches.push(notification);
        localStorage.setItem('mcipro_marshal_dispatches', JSON.stringify(marshalDispatches));

        // TODO: Send to marshal dashboard and caddies
        console.log('[TrafficMonitor] Marshal notification created:', notification);
    },

    getGroupOnHole(holeNumber) {
        // Get real group from bookings based on GPS-tracked currentHole
        const bookings = JSON.parse(localStorage.getItem('mcipro_bookings_cloud') || '{"bookings": []}');
        const activeBooking = bookings.bookings.find(b =>
            (b.status === 'confirmed' || b.status === 'checked-in') && b.currentHole === holeNumber
        );

        if (activeBooking) {
            const caddyInfo = activeBooking.caddyNumber ? ` (Caddy #${activeBooking.caddyNumber})` : '';
            return `${activeBooking.name || 'Unknown'}${caddyInfo} - Tee Time: ${activeBooking.teeTime || 'N/A'}`;
        }

        return null;
    },

    viewGroupDetails(holeNumber) {
        const groupInfo = this.getGroupOnHole(holeNumber) || `No group identified on Hole ${holeNumber}`;

        // TODO: Show modal with full group details
        // For now, just show notification
        if (typeof NotificationManager !== 'undefined') {
            NotificationManager.show(`Group on Hole ${holeNumber}: ${groupInfo}`, 'info');
        } else {
            alert(`Group on Hole ${holeNumber}: ${groupInfo}`);
        }

        console.log(`[TrafficMonitor] Viewing group details for hole ${holeNumber}: ${groupInfo}`);
    },

    checkPaceOfPlay() {
        // Auto-escalate groups that are 1.5 holes behind expected position
        const bookings = JSON.parse(localStorage.getItem('mcipro_bookings_cloud') || '{"bookings": []}');
        const activeBookings = bookings.bookings.filter(b =>
            (b.status === 'confirmed' || b.status === 'checked-in') && b.currentHole
        );

        activeBookings.forEach(booking => {
            const expectedHole = this.calculateExpectedHole(booking);
            const actualHole = booking.currentHole;
            const holesBehind = expectedHole - actualHole;

            // If 1.5+ holes behind, auto-escalate
            if (holesBehind >= 1.5) {
                const escalation = this.holeEscalation[actualHole];

                // Only auto-escalate if already at Contact 2 level and 10+ minutes have passed
                if (escalation && escalation.level === 2) {
                    const timeSinceContact = Date.now() - escalation.lastContact;
                    const tenMinutes = 10 * 60 * 1000;

                    if (timeSinceContact > tenMinutes) {
                        console.log(`[TrafficMonitor] Auto-escalating hole ${actualHole} to marshal (${holesBehind.toFixed(1)} holes behind)`);
                        this.sendMarshalNow(actualHole);
                    }
                }
            }
        });
    },

    calculateExpectedHole(booking) {
        // Calculate expected hole based on tee time
        if (!booking.teeTime || !booking.date) return 1;

        // Parse tee time (format: HH:MM)
        const [hours, minutes] = booking.teeTime.split(':').map(Number);
        const teeDateTime = new Date(booking.date);
        teeDateTime.setHours(hours, minutes, 0, 0);

        // Calculate elapsed time since tee time
        const now = new Date();
        const elapsedMinutes = (now - teeDateTime) / (1000 * 60);

        // Average 15 minutes per hole
        const expectedHole = Math.floor(elapsedMinutes / 15) + 1;

        // Cap at 18 (or courseConfig)
        return Math.min(expectedHole, this.courseConfig);
    },

    addHoleEvent(holeNumber, type, message) {
        if (!this.holeHistory[holeNumber]) {
            this.holeHistory[holeNumber] = [];
        }

        this.holeHistory[holeNumber].push({
            timestamp: Date.now(),
            type: type,
            message: message
        });

        localStorage.setItem('mcipro_hole_history', JSON.stringify(this.holeHistory));

        console.log(`[TrafficMonitor] Added ${type} to hole ${holeNumber}: ${message}`);
    },

    getTimeAgo(timestamp) {
        const seconds = Math.floor((Date.now() - timestamp) / 1000);

        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        return `${Math.floor(seconds / 86400)}d ago`;
    },

    updateLiveStatus() {
        this.renderHoles();
    }
};

// Initialize when manager traffic tab is shown
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (document.getElementById('trafficHoleGrid')) {
            TrafficMonitor.init();
        }
    }, 500);
});

        // ===========================================================

        // Tee Sheet Loading
        function loadTeeSheet() {
            const table = document.getElementById('teeSheetTable');
            const dateInput = document.getElementById('teeSheetDate');

            if (!table) return;

            // Get bookings for selected date
            const selectedDate = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
            const bookings = JSON.parse(localStorage.getItem('mcipro_bookings_cloud') || '{"bookings":[]}').bookings;

            const dayBookings = bookings.filter(b => b.date === selectedDate);

            if (dayBookings.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4 text-gray-500 text-xs">
                            No tee times scheduled for this date
                        </td>
                    </tr>
                `;
                return;
            }

            // Sort by tee time
            dayBookings.sort((a, b) => (a.teeTime || a.time || '').localeCompare(b.teeTime || b.time || ''));

            table.innerHTML = dayBookings.map(booking => {
                const time = booking.teeTime || booking.time || '-';
                const playerName = booking.playerName || booking.name || 'Unknown';
                const players = booking.players || 1;
                const caddy = booking.caddyName || 'None';
                const status = booking.status || 'Confirmed';

                let statusClass = 'bg-green-100 text-green-800';
                if (status === 'Completed') statusClass = 'bg-gray-100 text-gray-800';
                if (status === 'Cancelled') statusClass = 'bg-red-100 text-red-800';
                if (status === 'In Progress') statusClass = 'bg-blue-100 text-blue-800';

                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50 cursor-pointer" onclick="viewBookingDetails('${booking.id}')">
                        <td class="p-2 text-xs font-medium">${time}</td>
                        <td class="p-2 text-xs">${playerName}</td>
                        <td class="p-2 text-xs text-center">${players}</td>
                        <td class="p-2 text-xs">${caddy}</td>
                        <td class="p-2">
                            <span class="px-2 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                ${status}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Manager Analytics Data Engine
        const ManagerAnalytics = {
            // Calculate all analytics from existing data sources
            async calculate() {
                const bookings = await this.getBookings();
                const orders = this.getOrders();
                const profiles = this.getProfiles();

                return {
                    revenue: this.calculateRevenue(bookings, orders),
                    utilization: this.calculateUtilization(bookings),
                    staff: this.calculateStaffMetrics(profiles),
                    growth: this.calculateGrowth(bookings, orders)
                };
            },

            async getBookings() {
                // UPDATED: Use Supabase instead of localStorage
                if (window.SupabaseDB) {
                    try {
                        await window.SupabaseDB.waitForReady();
                        const { bookings } = await window.SupabaseDB.getBookings();
                        console.log('[ManagerAnalytics] Loaded bookings from Supabase:', bookings.length);
                        return bookings || [];
                    } catch (error) {
                        console.error('[ManagerAnalytics] Error loading from Supabase:', error);
                        // Fallback to localStorage if Supabase fails
                        const cloud = JSON.parse(localStorage.getItem('mcipro_bookings_cloud') || '{"bookings":[]}');
                        return cloud.bookings || [];
                    }
                } else {
                    // Fallback to localStorage if Supabase not initialized
                    const cloud = JSON.parse(localStorage.getItem('mcipro_bookings_cloud') || '{"bookings":[]}');
                    return cloud.bookings || [];
                }
            },

            getOrders() {
                return JSON.parse(localStorage.getItem('mcipro_orders') || '[]');
            },

            getProfiles() {
                return JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');
            },

            calculateRevenue(bookings, orders) {
                const today = new Date().toISOString().split('T')[0];
                const todayBookings = bookings.filter(b => b.date === today);

                // Green fees (assuming ฿2500 per round)
                const greenFees = todayBookings.length * 2500;

                // Caddy fees (assuming ฿500 per caddy)
                const caddyFees = todayBookings.filter(b => b.caddyId).length * 500;

                // F&B from orders
                const todayOrders = orders.filter(o => o.date === today);
                const fnbSales = todayOrders.reduce((sum, order) => sum + (order.total || 0), 0);

                // Pro shop (placeholder - will be from pro shop data)
                const proshopSales = 0;

                const totalRevenue = greenFees + caddyFees + fnbSales + proshopSales;

                return {
                    now: totalRevenue,
                    forecast: Math.round(totalRevenue * 1.2), // 20% growth projection
                    perRound: todayBookings.length > 0 ? Math.round(totalRevenue / todayBookings.length) : 0,
                    greenFees,
                    caddyFees,
                    fnbSales,
                    proshopSales,
                    rounds: todayBookings.length,
                    caddies: todayBookings.filter(b => b.caddyId).length,
                    orders: todayOrders.length
                };
            },

            calculateUtilization(bookings) {
                const today = new Date().toISOString().split('T')[0];
                const todayBookings = bookings.filter(b => b.date === today);

                // Assuming 50 available tee times per day
                const maxSlots = 50;
                const utilization = Math.round((todayBookings.length / maxSlots) * 100);

                // Break down by time periods
                const peakBookings = todayBookings.filter(b => {
                    const time = b.teeTime || b.time || '';
                    return time >= '08:00' && time < '14:00';
                });
                const midBookings = todayBookings.filter(b => {
                    const time = b.teeTime || b.time || '';
                    return time >= '14:00' && time < '17:00';
                });
                const eveningBookings = todayBookings.filter(b => {
                    const time = b.teeTime || b.time || '';
                    return time >= '17:00';
                });

                return {
                    overall: utilization,
                    peak: Math.round((peakBookings.length / 20) * 100), // 20 peak slots
                    mid: Math.round((midBookings.length / 20) * 100), // 20 mid slots
                    evening: Math.round((eveningBookings.length / 10) * 100) // 10 evening slots
                };
            },

            calculateStaffMetrics(profiles) {
                const caddies = profiles.filter(p => p.role === 'caddie');
                const staff = profiles.filter(p => p.role === 'staff' || p.role === 'manager');

                return {
                    totalCaddies: caddies.length,
                    activeCaddies: caddies.filter(c => c.status === 'active').length,
                    totalStaff: staff.length,
                    activeStaff: staff.filter(s => s.status === 'active').length
                };
            },

            calculateGrowth(bookings, orders) {
                const now = new Date();
                const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const lastMonthStr = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`;

                const thisMonthBookings = bookings.filter(b => b.date && b.date.startsWith(thisMonth));
                const lastMonthBookings = bookings.filter(b => b.date && b.date.startsWith(lastMonthStr));

                const thisMonthRevenue = thisMonthBookings.length * 2500; // Simplified
                const lastMonthRevenue = lastMonthBookings.length * 2500;

                const growth = lastMonthRevenue > 0
                    ? Math.round(((thisMonthRevenue - lastMonthRevenue) / lastMonthRevenue) * 100)
                    : 0;

                return {
                    percentage: growth > 0 ? `+${growth}%` : `${growth}%`,
                    thisMonth: thisMonthRevenue,
                    lastMonth: lastMonthRevenue,
                    difference: thisMonthRevenue - lastMonthRevenue
                };
            },

            // Update UI with calculated data
            async updateUI() {
                const data = await this.calculate();

                // Revenue metrics
                this.updateElement('analytics-revenue-now', `฿${data.revenue.now.toLocaleString()}`);
                this.updateElement('analytics-forecast', `฿${data.revenue.forecast.toLocaleString()}`);
                this.updateElement('analytics-rev-per-round', `฿${data.revenue.perRound.toLocaleString()}`);
                this.updateElement('analytics-utilization', `${data.utilization.overall}%`);

                // Revenue by source
                this.updateElement('analytics-green-fees', `฿${data.revenue.greenFees.toLocaleString()}`);
                this.updateElement('analytics-caddy-fees', `฿${data.revenue.caddyFees.toLocaleString()}`);
                this.updateElement('analytics-fnb-sales', `฿${data.revenue.fnbSales.toLocaleString()}`);
                this.updateElement('analytics-proshop-sales', `฿${data.revenue.proshopSales.toLocaleString()}`);

                // Update counts in revenue cards
                const greenFeesCard = document.querySelector('#analytics-green-fees + .text-xs');
                if (greenFeesCard) greenFeesCard.textContent = `${data.revenue.rounds} rounds`;

                const caddyFeesCard = document.querySelector('#analytics-caddy-fees + .text-xs');
                if (caddyFeesCard) caddyFeesCard.textContent = `${data.revenue.caddies} caddies`;

                const fnbCard = document.querySelector('#analytics-fnb-sales + .text-xs');
                if (fnbCard) fnbCard.textContent = `${data.revenue.orders} orders`;

                // Utilization bars
                this.updateUtilizationBar('analytics-peak', data.utilization.peak);
                this.updateUtilizationBar('analytics-mid', data.utilization.mid);
                this.updateUtilizationBar('analytics-evening', data.utilization.evening);

                // Growth metrics
                this.updateElement('analytics-growth', data.growth.percentage);
                this.updateElement('analytics-this-month', `฿${data.growth.thisMonth.toLocaleString()}`);
                this.updateElement('analytics-last-month', `฿${data.growth.lastMonth.toLocaleString()}`);
                this.updateElement('analytics-difference', `฿${data.growth.difference.toLocaleString()}`);
            },

            updateElement(id, value) {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            },

            updateUtilizationBar(prefix, percentage) {
                const barEl = document.getElementById(`${prefix}-bar`);
                const pctEl = document.getElementById(`${prefix}-pct`);

                if (barEl) barEl.style.width = `${percentage}%`;
                if (pctEl) pctEl.textContent = `${percentage}%`;
            },

            // Update Overview tab stat cards
            async updateOverview() {
                const data = await this.calculate();

                // Today's Rounds stat card
                const roundsCard = document.querySelector('#managerDashboard .stat-card:nth-child(1)');
                if (roundsCard) {
                    roundsCard.querySelector('.text-2xl').textContent = data.revenue.rounds;
                    roundsCard.querySelector('.text-2xl').classList.remove('text-gray-400');
                    roundsCard.querySelector('.text-2xl').classList.add('text-blue-600');
                    roundsCard.querySelector('.text-xs').textContent = `${data.utilization.overall}% utilization`;
                    roundsCard.querySelector('.text-xs').classList.remove('text-gray-400');
                    roundsCard.querySelector('.text-xs').classList.add('text-blue-500');
                }

                // Active Caddies stat card
                const caddiesCard = document.querySelector('#managerDashboard .stat-card:nth-child(2)');
                if (caddiesCard) {
                    caddiesCard.querySelector('.text-2xl').textContent = data.revenue.caddies;
                    caddiesCard.querySelector('.text-2xl').classList.remove('text-gray-400');
                    caddiesCard.querySelector('.text-2xl').classList.add('text-green-600');
                    caddiesCard.querySelector('.text-xs').textContent = `${data.staff.totalCaddies} total available`;
                    caddiesCard.querySelector('.text-xs').classList.remove('text-gray-400');
                    caddiesCard.querySelector('.text-xs').classList.add('text-green-500');
                }

                // Course Occupancy stat card
                const occupancyCard = document.querySelector('#managerDashboard .stat-card:nth-child(3)');
                if (occupancyCard) {
                    occupancyCard.querySelector('.text-2xl').textContent = `${data.utilization.overall}%`;
                    occupancyCard.querySelector('.text-2xl').classList.remove('text-gray-400');
                    occupancyCard.querySelector('.text-2xl').classList.add('text-orange-600');
                    occupancyCard.querySelector('.text-xs').textContent = `${data.revenue.rounds} of 50 slots`;
                    occupancyCard.querySelector('.text-xs').classList.remove('text-gray-400');
                    occupancyCard.querySelector('.text-xs').classList.add('text-orange-500');
                }

                // Current Rounds badge
                const roundsBadge = document.querySelector('#manager-overview .card-header .badge');
                if (roundsBadge) {
                    roundsBadge.textContent = `${data.revenue.rounds} Active`;
                }

                // Staff Status counts
                const staffCards = document.querySelectorAll('#manager-overview .space-y-4 .text-sm.font-bold');
                if (staffCards.length >= 1) {
                    staffCards[0].textContent = `${data.revenue.caddies}/${data.staff.totalCaddies}`;
                }

                console.log('[ManagerAnalytics] Overview updated with real data');
            }
        };

        // Auto-refresh analytics every 30 seconds when on manager dashboard
        setInterval(() => {
            if (window.location.hash.includes('manager') || AppState?.currentUser?.role === 'manager') {
                ManagerAnalytics.updateOverview();
                ManagerAnalytics.updateUI();
            }
        }, 30000);

        // Initialize tee sheet with today's date
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('teeSheetDate');
            if (dateInput) {
                dateInput.value = new Date().toISOString().split('T')[0];
                setTimeout(loadTeeSheet, 500);
            }

            // Initialize analytics if on manager dashboard
            setTimeout(() => {
                if (AppState?.currentUser?.role === 'manager') {
                    ManagerAnalytics.updateOverview();
                    ManagerAnalytics.updateUI();
                }
            }, 1000);
        });

        function showProshopTab(tabName, event) {
            TabManager.showTab('proshopDashboard', tabName, event);
        }

        function showMaintenanceTab(tabName, event) {
            TabManager.showTab('maintenanceDashboard', tabName, event);
        }

        // ===== GOLFER DASHBOARD FUNCTIONS =====

        // Enhanced Food Ordering System
        let foodCart = [];
        let currentFoodCategory = 'all';
        let activeOrderId = null;

        const FoodOrderingSystem = {
            // Comprehensive Menu Database
            menuItems: {
                // Appetizers & Starters
                1: { name: 'Caesar Salad', price: 280, category: 'appetizers', image: 'https://images.unsplash.com/photo-1546793665-c74683f339c1?w=400&h=300&fit=crop', description: 'Fresh romaine lettuce with parmesan and croutons', prepTime: 10, available: true, popular: true },
                2: { name: 'Shrimp Cocktail', price: 420, category: 'appetizers', image: 'https://images.unsplash.com/photo-1565680018434-b513d5e5fd47?w=400&h=300&fit=crop', description: 'Premium shrimp with cocktail sauce', prepTime: 5, available: true, popular: false },
                3: { name: 'Tom Yum Soup', price: 240, category: 'appetizers', image: 'https://images.unsplash.com/photo-1613844237701-8f3664fc2eff?w=400&h=300&fit=crop', description: 'Authentic Thai hot and sour soup', prepTime: 15, available: true, popular: true },
                4: { name: 'Spring Rolls', price: 180, category: 'appetizers', image: 'images/appetizers/springrolls.jpg', description: 'Fresh vegetables wrapped in rice paper', prepTime: 8, available: true, popular: false },
                5: { name: 'Chicken Satay', price: 320, category: 'appetizers', image: 'images/appetizers/chickensatay.jpg', description: 'Grilled chicken skewers with peanut sauce', prepTime: 12, available: true, popular: true },

                // Main Courses
                6: { name: 'Wagyu Steak', price: 1680, category: 'mains', image: 'https://images.unsplash.com/photo-1600891964092-4316c288032e?w=400&h=300&fit=crop', description: 'Premium A5 Wagyu beef with vegetables', prepTime: 25, available: true, popular: true },
                7: { name: 'Grilled Salmon', price: 680, category: 'mains', image: 'https://images.unsplash.com/photo-1485921325833-c519f76c4927?w=400&h=300&fit=crop', description: 'Norwegian salmon with lemon butter sauce', prepTime: 18, available: true, popular: true },
                8: { name: 'Club Sandwich', price: 380, category: 'mains', image: 'https://images.unsplash.com/photo-1619096252214-ef06c45683e3?w=400&h=300&fit=crop', description: 'Triple-deck sandwich with fries', prepTime: 12, available: true, popular: false },
                9: { name: 'Thai Green Curry', price: 320, category: 'mains', image: 'https://images.unsplash.com/photo-1455619452474-d2be8b1e70cd?w=400&h=300&fit=crop', description: 'Authentic green curry with jasmine rice', prepTime: 20, available: true, popular: true },
                10: { name: 'Pad Thai', price: 280, category: 'mains', image: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?w=400&h=300&fit=crop', description: 'Classic stir-fried rice noodles', prepTime: 15, available: true, popular: true },
                11: { name: 'Fish & Chips', price: 420, category: 'mains', image: 'images/main courses/fish&chips.jpg', description: 'Beer-battered fish with crispy fries', prepTime: 16, available: true, popular: false },
                12: { name: 'Massaman Curry', price: 340, category: 'mains', image: 'https://images.unsplash.com/photo-1631452180519-c014fe946bc7?w=400&h=300&fit=crop', description: 'Rich Thai curry with potatoes', prepTime: 22, available: true, popular: false },

                // Beverages
                13: { name: 'Fresh Orange Juice', price: 120, category: 'beverages', image: 'https://images.unsplash.com/photo-1600271886742-f049cd451bba?w=400&h=300&fit=crop', description: 'Freshly squeezed orange juice', prepTime: 3, available: true, popular: true },
                14: { name: 'Premium Coffee', price: 150, category: 'beverages', image: 'https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?w=400&h=300&fit=crop', description: 'Arabica coffee beans', prepTime: 5, available: true, popular: true },
                15: { name: 'Sparkling Water', price: 80, category: 'beverages', image: 'https://images.unsplash.com/photo-1548839140-29a749e1cf4d?w=400&h=300&fit=crop', description: 'San Pellegrino sparkling water', prepTime: 1, available: true, popular: false },
                16: { name: 'House Wine', price: 280, category: 'beverages', image: 'https://images.unsplash.com/photo-1510812431401-41d2bd2722f3?w=400&h=300&fit=crop', description: 'Selection of red or white wine', prepTime: 2, available: true, popular: false },
                17: { name: 'Thai Iced Tea', price: 100, category: 'beverages', image: 'https://images.unsplash.com/photo-1571934811356-5cc061b6821f?w=400&h=300&fit=crop', description: 'Traditional Thai tea with condensed milk', prepTime: 4, available: true, popular: true },
                18: { name: 'Coconut Water', price: 90, category: 'beverages', image: 'images/beverages/coconutwater.jpg', description: 'Fresh young coconut water', prepTime: 2, available: true, popular: true },
                19: { name: 'Heineken Small', price: 120, category: 'beverages', image: 'images/beverages/heinekenbeer.jpg', description: 'Premium Dutch beer (330ml)', prepTime: 1, available: true, popular: true },
                20: { name: 'Heineken Large', price: 180, category: 'beverages', image: 'images/beverages/heinekenbeer.jpg', description: 'Premium Dutch beer (640ml)', prepTime: 1, available: true, popular: true },
                21: { name: 'Chang Beer Small', price: 100, category: 'beverages', image: 'images/beverages/changbeer.jpg', description: 'Local Thai beer (330ml)', prepTime: 1, available: true, popular: false },
                22: { name: 'Chang Beer Large', price: 150, category: 'beverages', image: 'images/beverages/changbeer.jpg', description: 'Local Thai beer (640ml)', prepTime: 1, available: true, popular: false },
                23: { name: 'Singha Beer Small', price: 110, category: 'beverages', image: 'images/beverages/singhabeer.jpg', description: 'Classic Thai beer (330ml)', prepTime: 1, available: true, popular: false },
                24: { name: 'Singha Beer Large', price: 160, category: 'beverages', image: 'images/beverages/singhabeer.jpg', description: 'Classic Thai beer (640ml)', prepTime: 1, available: true, popular: false },
                25: { name: 'Smoothie Bowl', price: 220, category: 'beverages', image: 'images/beverages/smoothiebowl.jpg', description: 'Tropical fruit smoothie', prepTime: 6, available: true, popular: false },

                // Desserts
                26: { name: 'Mango Sticky Rice', price: 180, category: 'desserts', image: 'images/Desserts/mangostickyrice.jpg', description: 'Traditional Thai dessert', prepTime: 8, available: true, popular: true },
                27: { name: 'Chocolate Cake', price: 240, category: 'desserts', image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=400&h=300&fit=crop', description: 'Rich dark chocolate cake', prepTime: 5, available: true, popular: true },
                28: { name: 'Ice Cream Selection', price: 120, category: 'desserts', image: 'https://images.unsplash.com/photo-1563805042-7684c019e1cb?w=400&h=300&fit=crop', description: 'Vanilla, chocolate, or strawberry', prepTime: 3, available: true, popular: false },
                29: { name: 'Fruit Platter', price: 200, category: 'desserts', image: 'https://images.unsplash.com/photo-1564093497595-593b96d80180?w=400&h=300&fit=crop', description: 'Seasonal fresh fruits', prepTime: 6, available: true, popular: false },

                // Snacks & Light Bites
                30: { name: 'Chicken Wings', price: 280, category: 'snacks', image: 'images/snacks/chickenwings.jpg', description: 'Buffalo or BBQ style wings', prepTime: 15, available: true, popular: true },
                31: { name: 'Nachos Supreme', price: 320, category: 'snacks', image: 'https://images.unsplash.com/photo-1513456852971-30c0b8199d4d?w=400&h=300&fit=crop', description: 'Loaded nachos with cheese and jalapeños', prepTime: 10, available: true, popular: false },
                32: { name: 'Golf Course Mix', price: 150, category: 'snacks', image: 'https://images.unsplash.com/photo-1599599810769-bcde5a160d32?w=400&h=300&fit=crop', description: 'Premium nuts and dried fruits', prepTime: 1, available: true, popular: false },
                33: { name: 'Energy Bar', price: 80, category: 'snacks', image: 'images/snacks/energybar.jpg', description: 'Protein and energy bar', prepTime: 1, available: true, popular: false }
            },

            categories: {
                all: { name: 'All Items', icon: '🍽️' },
                appetizers: { name: 'Appetizers', icon: '🥗' },
                mains: { name: 'Main Courses', icon: '🍽️' },
                beverages: { name: 'Beverages', icon: '🥤' },
                desserts: { name: 'Desserts', icon: '🍰' },
                snacks: { name: 'Snacks', icon: '🍿' }
            },

            orderHistory: [
                { id: 'FO001', date: '2024-01-15', items: ['Caesar Salad', 'Grilled Salmon'], total: 960, status: 'delivered' },
                { id: 'FO002', date: '2024-01-10', items: ['Wagyu Steak', 'House Wine'], total: 1960, status: 'delivered' },
                { id: 'FO003', date: '2024-01-08', items: ['Thai Green Curry', 'Thai Iced Tea'], total: 420, status: 'delivered' }
            ],

            deliveryOptions: {
                'course-delivery': {
                    name: 'Course Delivery',
                    fee: 50,
                    time: '20-30 min',
                    icon: '🚗',
                    description: 'Delivered to your location on the course',
                    baseTime: 5
                },
                'clubhouse-pickup': {
                    name: 'Clubhouse Pickup',
                    fee: 0,
                    time: '15-20 min',
                    icon: '🏢',
                    description: 'Ready for pickup at the clubhouse',
                    baseTime: 0
                },
                'cart-service': {
                    name: 'Cart Service',
                    fee: 30,
                    time: '25-35 min',
                    icon: '🛒',
                    description: 'Brought to you by golf cart',
                    baseTime: 10
                },
                'restaurant-dining': {
                    name: 'Restaurant Dining',
                    fee: 0,
                    time: 'Reserve table after round',
                    icon: '🍽️',
                    description: 'Dine in our restaurant with reserved table',
                    baseTime: 0,
                    requiresReservation: true
                },
                'post-round-ready': {
                    name: 'Post-Round Ready',
                    fee: 0,
                    time: 'Ready when you finish',
                    icon: '⏰',
                    description: 'Food ready when you complete your round',
                    baseTime: 0,
                    requiresTimeEstimate: true
                }
            }
        };

        // Enhanced Food Cart Functions
        function addToFoodCart(itemId) {
            const item = FoodOrderingSystem.menuItems[itemId];
            if (!item || !item.available) {
                NotificationManager.show('Item is currently unavailable', 'error');
                return;
            }

            const existingItem = foodCart.find(cartItem => cartItem.id === itemId);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                foodCart.push({
                    id: itemId,
                    name: item.name,
                    price: item.price,
                    image: item.image,
                    description: item.description,
                    prepTime: item.prepTime,
                    quantity: 1
                });
            }

            updateFoodCartDisplay();
            NotificationManager.show(`${item.name} added to cart`, 'success');
        }

        function removeFromFoodCart(itemId) {
            foodCart = foodCart.filter(item => item.id !== itemId);
            updateFoodCartDisplay();
            NotificationManager.show('Item removed from cart', 'info');
        }

        function updateFoodCartQuantity(itemId, change) {
            const item = foodCart.find(cartItem => cartItem.id === itemId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeFromFoodCart(itemId);
                } else {
                    updateFoodCartDisplay();
                }
            }
        }

        function updateFoodCartDisplay() {
            const cartContainer = document.getElementById('foodCartContainer');
            const cartItemCount = document.getElementById('cartItemCount');
            const cartSubtotal = document.getElementById('cartSubtotal');
            const serviceCharge = document.getElementById('serviceCharge');
            const cartTotal = document.getElementById('cartTotal');
            const placeOrderBtn = document.getElementById('placeOrderBtn');

            if (!cartContainer) return;

            let subtotal = 0;
            let itemCount = 0;

            if (foodCart.length === 0) {
                cartContainer.innerHTML = '<p class="text-gray-600 text-sm text-center py-8">Your cart is empty</p>';
            } else {
                cartContainer.innerHTML = '';

                foodCart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;
                    itemCount += item.quantity;

                    const cartItem = document.createElement('div');
                    cartItem.className = 'bg-white p-3 rounded-lg border border-gray-200';
                    cartItem.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-3">
                                <img src="${item.image}" alt="${item.name}" class="w-12 h-12 rounded object-cover" onerror="this.src='https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=100&h=100&fit=crop'">
                                <div>
                                    <h5 class="font-semibold text-sm text-gray-900">${item.name}</h5>
                                    <p class="text-xs text-gray-600">฿${item.price} each</p>
                                </div>
                            </div>
                            <button onclick="removeFromFoodCart(${item.id})" class="text-red-600 hover:text-red-700">
                                <span class="material-symbols-outlined text-sm">delete</span>
                            </button>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <button onclick="updateFoodCartQuantity(${item.id}, -1)" class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300">
                                    <span class="material-symbols-outlined text-xs">remove</span>
                                </button>
                                <span class="font-semibold text-sm">${item.quantity}</span>
                                <button onclick="updateFoodCartQuantity(${item.id}, 1)" class="w-6 h-6 bg-primary-600 text-white rounded-full flex items-center justify-center hover:bg-primary-700">
                                    <span class="material-symbols-outlined text-xs">add</span>
                                </button>
                            </div>
                            <span class="font-semibold text-sm text-gray-900">฿${itemTotal}</span>
                        </div>
                    `;
                    cartContainer.appendChild(cartItem);
                });
            }

            const serviceChargeAmount = Math.round(subtotal * 0.1);
            const total = subtotal + serviceChargeAmount;

            if (cartItemCount) cartItemCount.textContent = itemCount;
            if (cartSubtotal) cartSubtotal.textContent = `฿${subtotal}`;
            if (serviceCharge) serviceCharge.textContent = `฿${serviceChargeAmount}`;
            if (cartTotal) cartTotal.textContent = `฿${total}`;

            if (placeOrderBtn) {
                placeOrderBtn.disabled = foodCart.length === 0;
                if (foodCart.length === 0) {
                    placeOrderBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    placeOrderBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        function placeOrder() {
            if (foodCart.length === 0) {
                NotificationManager.show('Your cart is empty', 'error');
                return;
            }

            // Show delivery options modal
            showDeliveryOptionsModal();
        }

        function filterFoodMenu(category) {
            currentFoodCategory = category;
            renderFoodMenu();

            // Update category button styles
            document.querySelectorAll('.food-category-btn').forEach(btn => {
                btn.classList.remove('bg-primary-500', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });

            const activeBtn = document.querySelector(`[data-category="${category}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-100', 'text-gray-700');
                activeBtn.classList.add('bg-primary-500', 'text-white');
            }
        }

        function renderFoodMenu() {
            const menuContainer = document.getElementById('foodMenuItems');
            if (!menuContainer) return;

            const items = Object.entries(FoodOrderingSystem.menuItems)
                .filter(([id, item]) => currentFoodCategory === 'all' || item.category === currentFoodCategory)
                .sort(([a, itemA], [b, itemB]) => {
                    // Sort popular items first, then by price
                    if (itemA.popular && !itemB.popular) return -1;
                    if (!itemA.popular && itemB.popular) return 1;
                    return itemA.price - itemB.price;
                });

            menuContainer.innerHTML = items.map(([id, item]) => `
                <div class="menu-item-card border-2 border-gray-200 rounded-xl hover:border-primary-500 transition-all duration-200 overflow-hidden ${!item.available ? 'opacity-50' : ''}">
                    <!-- Food Image -->
                    <div class="relative h-48 bg-gray-100 overflow-hidden">
                        <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400&h=300&fit=crop'">
                        ${item.popular ? '<div class="absolute top-2 right-2 bg-orange-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">Popular</div>' : ''}
                        ${!item.available ? '<div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center"><span class="text-white font-bold text-lg">Unavailable</span></div>' : ''}
                    </div>

                    <!-- Food Details -->
                    <div class="p-4">
                        <div class="flex items-start justify-between mb-2">
                            <h5 class="font-bold text-gray-900 text-lg">${item.name}</h5>
                            <span class="text-xl font-bold text-primary-600 whitespace-nowrap ml-2">฿${item.price.toLocaleString()}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3 line-clamp-2">${item.description}</p>
                        <div class="flex items-center space-x-4 mb-3 text-xs text-gray-500">
                            <span class="flex items-center">
                                <span class="material-symbols-outlined text-sm mr-1">schedule</span>
                                ${item.prepTime} min
                            </span>
                            ${item.available ? '<span class="text-green-600 font-medium">Available</span>' : '<span class="text-red-600 font-medium">Unavailable</span>'}
                        </div>
                        <button
                            onclick="addToFoodCart(${id})"
                            class="w-full btn-primary py-2.5 text-sm font-semibold ${!item.available ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${!item.available ? 'disabled' : ''}
                        >
                            <span class="material-symbols-outlined text-sm mr-1">add_shopping_cart</span>
                            Add to Cart
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function showDeliveryOptionsModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="material-symbols-outlined text-2xl text-green-600">restaurant</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Choose Your Dining Option</h3>
                        <p class="text-sm text-gray-600">Select how you'd like to receive your order</p>
                    </div>
                    <div class="space-y-3">
                        ${Object.entries(FoodOrderingSystem.deliveryOptions).map(([key, option]) => `
                            <div class="delivery-option p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-green-500 hover:bg-green-50 transition-all"
                                 onclick="selectDeliveryOption('${key}')">
                                <div class="flex items-start justify-between">
                                    <div class="flex items-start space-x-3">
                                        <span class="text-2xl">${option.icon}</span>
                                        <div class="flex-1">
                                            <h5 class="font-bold text-gray-900">${option.name}</h5>
                                            <p class="text-sm text-gray-600 mb-1">${option.description}</p>
                                            <div class="flex items-center space-x-2">
                                                <span class="material-symbols-outlined text-sm text-blue-600">schedule</span>
                                                <span class="text-sm text-blue-600 font-medium">${option.time}</span>
                                            </div>
                                            ${option.requiresReservation ? `
                                                <div class="mt-2 px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full inline-block">
                                                    Table reservation required
                                                </div>
                                            ` : ''}
                                            ${option.requiresTimeEstimate ? `
                                                <div class="mt-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full inline-block">
                                                    Round completion time needed
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-lg font-bold ${option.fee > 0 ? 'text-orange-600' : 'text-green-600'}">
                                            ${option.fee > 0 ? `+฿${option.fee}` : 'FREE'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex space-x-3 mt-6">
                        <button onclick="closeDeliveryModal()" class="btn-secondary flex-1">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window.currentDeliveryModal = modal;
        }

        function selectDeliveryOption(optionKey) {
            console.log('selectDeliveryOption called with:', optionKey);
            const option = FoodOrderingSystem.deliveryOptions[optionKey];

            if (!option) {
                console.error('Option not found:', optionKey);
                NotificationManager.show('Invalid delivery option selected', 'error');
                return;
            }

            console.log('Selected option:', option);

            try {
                if (option.requiresReservation) {
                    console.log('Showing table reservation modal');
                    closeDeliveryModal();
                    showTableReservationModal(optionKey, option);
                } else if (option.requiresTimeEstimate) {
                    console.log('Showing round time modal');
                    closeDeliveryModal();
                    showRoundTimeModal(optionKey, option);
                } else {
                    console.log('Processing direct order');
                    closeDeliveryModal();
                    confirmFoodOrder(optionKey, option);
                }
            } catch (error) {
                console.error('Error in selectDeliveryOption:', error);
                closeDeliveryModal();
                NotificationManager.show('Error processing selection. Please try again.', 'error');
            }
        }

        function showTableReservationModal(optionKey, option) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-md w-full">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="material-symbols-outlined text-2xl text-orange-600">table_restaurant</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">Reserve Your Table</h3>
                        <p class="text-sm text-gray-600 mt-2">Select your preferred dining time after your round</p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Estimated Round Completion</label>
                            <select id="roundCompletionTime" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                                <option value="">Select estimated time</option>
                                <option value="12:00">12:00 PM</option>
                                <option value="12:30">12:30 PM</option>
                                <option value="13:00">1:00 PM</option>
                                <option value="13:30">1:30 PM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="14:30">2:30 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="15:30">3:30 PM</option>
                                <option value="16:00">4:00 PM</option>
                                <option value="16:30">4:30 PM</option>
                                <option value="17:00">5:00 PM</option>
                                <option value="17:30">5:30 PM</option>
                                <option value="18:00">6:00 PM</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Party Size</label>
                            <select id="partySize" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                                <option value="1">1 person</option>
                                <option value="2" selected>2 people</option>
                                <option value="3">3 people</option>
                                <option value="4">4 people</option>
                                <option value="5">5 people</option>
                                <option value="6">6 people</option>
                                <option value="8">8 people</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Seating Preference</label>
                            <select id="seatingPreference" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                                <option value="indoor">Indoor dining</option>
                                <option value="outdoor">Outdoor terrace</option>
                                <option value="private">Private dining room</option>
                                <option value="bar">Bar seating</option>
                            </select>
                        </div>

                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="flex items-center space-x-2 text-green-800">
                                <span class="material-symbols-outlined text-sm">info</span>
                                <span class="text-sm font-medium">Your food will be prepared fresh upon your arrival</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-3 mt-6">
                        <button onclick="closeTableReservationModal()" class="btn-secondary flex-1">Back</button>
                        <button onclick="confirmTableReservation('${optionKey}')" class="btn-primary flex-1">
                            Reserve Table
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window.currentTableReservationModal = modal;
        }

        function showRoundTimeModal(optionKey, option) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-md w-full">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="material-symbols-outlined text-2xl text-blue-600">schedule</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">When Will You Finish?</h3>
                        <p class="text-sm text-gray-600 mt-2">Help us time your order perfectly</p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Expected Completion Time</label>
                            <select id="expectedCompletionTime" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select estimated time</option>
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="75">1 hour 15 minutes</option>
                                <option value="90">1 hour 30 minutes</option>
                                <option value="105">1 hour 45 minutes</option>
                                <option value="120">2 hours</option>
                                <option value="135">2 hours 15 minutes</option>
                                <option value="150">2 hours 30 minutes</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Current Hole</label>
                            <select id="currentHole" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="1">Hole 1</option>
                                <option value="2">Hole 2</option>
                                <option value="3">Hole 3</option>
                                <option value="4">Hole 4</option>
                                <option value="5">Hole 5</option>
                                <option value="6">Hole 6</option>
                                <option value="7">Hole 7</option>
                                <option value="8">Hole 8</option>
                                <option value="9">Hole 9</option>
                                <option value="10">Hole 10</option>
                                <option value="11">Hole 11</option>
                                <option value="12">Hole 12</option>
                                <option value="13">Hole 13</option>
                                <option value="14">Hole 14</option>
                                <option value="15">Hole 15</option>
                                <option value="16">Hole 16</option>
                                <option value="17">Hole 17</option>
                                <option value="18">Hole 18</option>
                            </select>
                        </div>

                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="flex items-center space-x-2 text-blue-800">
                                <span class="material-symbols-outlined text-sm">timer</span>
                                <span class="text-sm font-medium">Your food will be ready when you arrive</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-3 mt-6">
                        <button onclick="closeRoundTimeModal()" class="btn-secondary flex-1">Back</button>
                        <button onclick="confirmRoundTiming('${optionKey}')" class="btn-primary flex-1">
                            Confirm Timing
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window.currentRoundTimeModal = modal;
        }

        function confirmTableReservation(optionKey) {
            console.log('confirmTableReservation called for:', optionKey);

            const completionTime = document.getElementById('roundCompletionTime').value;
            const partySize = document.getElementById('partySize').value;
            const seatingPreference = document.getElementById('seatingPreference').value;

            console.log('Reservation details:', { completionTime, partySize, seatingPreference });

            if (!completionTime) {
                NotificationManager.show('Please select your estimated completion time', 'error');
                return;
            }

            try {
                const option = FoodOrderingSystem.deliveryOptions[optionKey];
                const enhancedOption = {
                    ...option,
                    reservationDetails: {
                        time: completionTime,
                        partySize: parseInt(partySize),
                        seating: seatingPreference,
                        tableNumber: `T${Math.floor(Math.random() * 20) + 1}`
                    }
                };

                console.log('Enhanced option for reservation:', enhancedOption);
                closeTableReservationModal();
                confirmFoodOrder(optionKey, enhancedOption);
            } catch (error) {
                console.error('Error in confirmTableReservation:', error);
                closeTableReservationModal();
                NotificationManager.show('Error processing reservation. Please try again.', 'error');
            }
        }

        function confirmRoundTiming(optionKey) {
            console.log('confirmRoundTiming called for:', optionKey);

            const completionTime = document.getElementById('expectedCompletionTime').value;
            const currentHole = document.getElementById('currentHole').value;

            console.log('Round timing details:', { completionTime, currentHole });

            if (!completionTime || !currentHole) {
                NotificationManager.show('Please select both completion time and current hole', 'error');
                return;
            }

            try {
                const option = FoodOrderingSystem.deliveryOptions[optionKey];
                const enhancedOption = {
                    ...option,
                    timingDetails: {
                        estimatedMinutes: parseInt(completionTime),
                        currentHole: parseInt(currentHole),
                        readyTime: new Date(Date.now() + parseInt(completionTime) * 60000)
                    }
                };

                console.log('Enhanced option for timing:', enhancedOption);
                closeRoundTimeModal();
                confirmFoodOrder(optionKey, enhancedOption);
            } catch (error) {
                console.error('Error in confirmRoundTiming:', error);
                closeRoundTimeModal();
                NotificationManager.show('Error processing timing. Please try again.', 'error');
            }
        }

        function closeTableReservationModal() {
            if (window.currentTableReservationModal) {
                document.body.removeChild(window.currentTableReservationModal);
                window.currentTableReservationModal = null;
            }
        }

        function closeRoundTimeModal() {
            if (window.currentRoundTimeModal) {
                document.body.removeChild(window.currentRoundTimeModal);
                window.currentRoundTimeModal = null;
            }
        }

        function closeDeliveryModal() {
            if (window.currentDeliveryModal) {
                document.body.removeChild(window.currentDeliveryModal);
                window.currentDeliveryModal = null;
            }
        }

        function confirmFoodOrder(deliveryType, deliveryOption) {
            console.log('confirmFoodOrder called with:', { deliveryType, deliveryOption });
            LoadingManager.show('Processing your order...');

            try {
                setTimeout(() => {
                    try {
                        console.log('Processing order, cart:', foodCart);

                        const subtotal = foodCart.reduce((total, item) => total + (item.price * item.quantity), 0);
                        const serviceCharge = Math.round(subtotal * 0.1);
                        const deliveryFee = deliveryOption.fee || 0;
                        const total = subtotal + serviceCharge + deliveryFee;

                        const orderId = 'FO' + Date.now().toString().slice(-6);
                        const orderTime = new Date();

                        // Create comprehensive order object
                        const orderDetails = {
                            id: orderId,
                            orderTime: orderTime.toISOString(),
                            customerName: AppState.currentUser?.name || 'Guest',
                            customerType: AppState.currentUser?.role || 'guest',
                            tableNumber: getTableNumber(),
                            items: foodCart.map(item => ({
                                name: item.name,
                                quantity: item.quantity,
                                unitPrice: item.price,
                                totalPrice: item.price * item.quantity,
                                image: item.image,
                                prepTime: item.prepTime || 15
                            })),
                            subtotal: subtotal,
                            serviceCharge: serviceCharge,
                            deliveryFee: deliveryFee,
                            total: total,
                            status: 'confirmed',
                            deliveryType: deliveryType,
                            deliveryOption: deliveryOption,
                            estimatedTime: calculateEstimatedTime(foodCart, deliveryOption),
                            progress: {
                                confirmed: { time: orderTime.toISOString(), completed: true },
                                preparing: { time: null, completed: false },
                                cooking: { time: null, completed: false },
                                ready: { time: null, completed: false },
                                delivered: { time: null, completed: false }
                            },
                            paymentMethod: 'Room Charge'
                        };

                        // Initialize order history if needed
                        if (!FoodOrderingSystem.orderHistory) {
                            FoodOrderingSystem.orderHistory = [];
                        }

                        // Add to order history
                        FoodOrderingSystem.orderHistory.unshift(orderDetails);

                        console.log('Order created:', orderDetails);

                        // Show receipt and start order tracking
                        try {
                            console.log('Showing order receipt...');
                            showOrderReceipt(orderDetails);
                            console.log('Starting order tracking...');
                            startOrderTracking(orderId);
                        } catch (receiptError) {
                            console.error('Error showing receipt or starting tracking:', receiptError);
                            // Still continue with clearing cart and hiding loader
                            NotificationManager.show(`Order ${orderId} placed successfully! Total: ฿${orderDetails.total}`, 'success');
                        }

                        // Clear cart
                        foodCart = [];
                        updateFoodCartDisplay();
                        LoadingManager.hide();

                        // Update status tab if it exists
                        setTimeout(() => {
                            updateOrderStatusTab();
                        }, 100);

                        console.log('Order processing completed successfully');
                    } catch (innerError) {
                        console.error('Error in order processing:', innerError);
                        LoadingManager.hide();
                        NotificationManager.show('Error processing order. Please try again.', 'error');
                    }
                }, 2000);
            } catch (error) {
                console.error('Error in confirmFoodOrder:', error);
                LoadingManager.hide();
                NotificationManager.show('Error processing order. Please try again.', 'error');
            }
        }

        function getTableNumber() {
            try {
                // Generate table number based on user or location
                if (AppState.currentUser && AppState.currentUser.role === 'golfer') {
                    return 'Table ' + (Math.floor(Math.random() * 20) + 1);
                }
                return 'Mobile Order';
            } catch (error) {
                console.error('Error generating table number:', error);
                return 'Table ' + (Math.floor(Math.random() * 20) + 1);
            }
        }

        function calculateEstimatedTime(cartItems, deliveryOption) {
            try {
                if (!cartItems || cartItems.length === 0) {
                    console.log('No cart items, using default time');
                    return 20; // Default 20 minutes
                }

                const prepTimes = cartItems.map(item => item.prepTime || 15);
                const maxPrepTime = Math.max(...prepTimes);
                const baseTime = maxPrepTime + (deliveryOption.baseTime || 0);
                const estimatedTime = baseTime + Math.floor(Math.random() * 10);

                console.log('Calculated estimated time:', {
                    cartItems: cartItems.length,
                    maxPrepTime,
                    baseTime: deliveryOption.baseTime || 0,
                    estimatedTime
                });

                return estimatedTime;
            } catch (error) {
                console.error('Error calculating estimated time:', error);
                return 25; // Fallback time
            }
        }

        function showOrderReceipt(order) {
            // Close any existing modals first
            closeReceiptModal();

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.onclick = (e) => {
                if (e.target === modal) closeReceiptModal();
            };
            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <!-- Receipt Header -->
                    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-t-2xl relative">
                        <button onclick="closeReceiptModal()" class="absolute top-4 right-4 text-white hover:text-gray-200 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white hover:bg-opacity-20">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                        <div class="text-center">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-3">
                                <span class="material-symbols-outlined text-2xl">receipt</span>
                            </div>
                            <h3 class="text-xl font-bold">Order Receipt</h3>
                            <p class="text-green-100">Order #${order.id}</p>
                        </div>
                    </div>

                    <!-- Receipt Body -->
                    <div class="p-6">
                        <!-- Order Details -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-600">Customer:</span>
                                <span class="font-semibold">${order.customerName}</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-600">Table:</span>
                                <span class="font-semibold">${order.tableNumber}</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-600">Date & Time:</span>
                                <span class="font-semibold">${new Date(order.orderTime).toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-gray-600">Delivery:</span>
                                <span class="font-semibold">${order.deliveryOption.name}</span>
                            </div>
                        </div>

                        <!-- Order Items -->
                        <div class="border-t border-b py-4 mb-4">
                            <h4 class="font-bold text-gray-900 mb-3">Order Items</h4>
                            <div class="space-y-2">
                                ${order.items.map(item => `
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <img src="${item.image}" alt="${item.name}" class="w-10 h-10 rounded object-cover" onerror="this.src='https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=100&h=100&fit=crop'">
                                            <span class="font-medium">${item.name}</span>
                                            <span class="text-gray-500">×${item.quantity}</span>
                                        </div>
                                        <span class="font-semibold">฿${item.totalPrice}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Order Summary -->
                        <div class="space-y-2 mb-6">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Subtotal:</span>
                                <span class="font-semibold">฿${order.subtotal}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Service Charge (10%):</span>
                                <span class="font-semibold">฿${order.serviceCharge}</span>
                            </div>
                            ${order.deliveryFee > 0 ? `
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Delivery Fee:</span>
                                    <span class="font-semibold">฿${order.deliveryFee}</span>
                                </div>
                            ` : ''}
                            <div class="flex justify-between text-lg font-bold border-t pt-2">
                                <span>Total Amount:</span>
                                <span class="text-green-600">฿${order.total}</span>
                            </div>
                        </div>

                        <!-- Estimated Time -->
                        <div class="bg-blue-50 rounded-lg p-4 mb-6">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="material-symbols-outlined text-blue-600">schedule</span>
                                <span class="font-semibold text-blue-800">Estimated Preparation Time</span>
                            </div>
                            <p class="text-blue-700 font-bold text-lg">${order.estimatedTime} minutes</p>
                            <p class="text-blue-600 text-sm">${order.deliveryOption.time}</p>
                        </div>

                        <!-- Action Buttons -->
                        <div class="space-y-3">
                            <button onclick="trackOrder('${order.id}')" class="w-full btn-primary">
                                <span class="material-symbols-outlined text-sm mr-2">track_changes</span>
                                Track Order Status
                            </button>
                            <button onclick="printReceipt('${order.id}')" class="w-full btn-secondary">
                                <span class="material-symbols-outlined text-sm mr-2">print</span>
                                Print Receipt
                            </button>
                            <button onclick="closeReceiptModal()" class="w-full btn-outline">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Add ESC key handler
            const handleEscKey = (e) => {
                if (e.key === 'Escape') {
                    closeReceiptModal();
                    document.removeEventListener('keydown', handleEscKey);
                }
            };
            document.addEventListener('keydown', handleEscKey);

            document.body.appendChild(modal);
            window.currentReceiptModal = modal;

            console.log('Order receipt modal opened');
        }

        function closeReceiptModal() {
            try {
                // Find and remove modal by class name as backup
                const modals = document.querySelectorAll('.fixed.inset-0');
                modals.forEach(modal => {
                    if (modal.innerHTML.includes('Order Receipt') || modal.innerHTML.includes('receipt')) {
                        modal.remove();
                    }
                });

                // Also use the window reference if it exists
                if (window.currentReceiptModal) {
                    if (window.currentReceiptModal.parentNode) {
                        window.currentReceiptModal.parentNode.removeChild(window.currentReceiptModal);
                    }
                    window.currentReceiptModal = null;
                }

                console.log('Receipt modal closed successfully');
            } catch (error) {
                console.error('Error closing receipt modal:', error);
                // Force remove any receipt modals
                document.querySelectorAll('[class*="fixed"][class*="inset-0"]').forEach(el => {
                    if (el.innerHTML.includes('Order Receipt')) {
                        el.remove();
                    }
                });
            }
        }

        // Emergency modal closer - can be called from console
        window.forceCloseAllModals = function() {
            console.log('Force closing all modals...');

            // Remove all fixed positioned elements that look like modals
            const possibleModals = document.querySelectorAll('.fixed');
            possibleModals.forEach(el => {
                if (el.classList.contains('inset-0') ||
                    el.style.position === 'fixed' ||
                    el.innerHTML.includes('modal') ||
                    el.innerHTML.includes('Modal') ||
                    el.innerHTML.includes('Order Receipt')) {
                    console.log('Removing modal:', el);
                    el.remove();
                }
            });

            // Clear modal references
            window.currentReceiptModal = null;
            window.currentTrackingModal = null;
            window.currentOrderHistoryModal = null;

            console.log('All modals force closed');
        };

        function startOrderTracking(orderId) {
            // Simulate order progress
            const order = FoodOrderingSystem.orderHistory.find(o => o.id === orderId);
            if (!order) return;

            // Start preparing after 2 minutes
            setTimeout(() => {
                order.status = 'preparing';
                order.progress.preparing = { time: new Date().toISOString(), completed: true };
                NotificationManager.show(`Order ${orderId}: Kitchen has started preparing your order`, 'info');
                updateOrderTrackingUI(orderId);
            }, 2 * 60 * 1000);

            // Start cooking after 5 minutes
            setTimeout(() => {
                order.status = 'cooking';
                order.progress.cooking = { time: new Date().toISOString(), completed: true };
                NotificationManager.show(`Order ${orderId}: Your order is now being cooked`, 'info');
                updateOrderTrackingUI(orderId);
            }, 5 * 60 * 1000);

            // Ready after estimated time
            setTimeout(() => {
                order.status = 'ready';
                order.progress.ready = { time: new Date().toISOString(), completed: true };
                NotificationManager.show(`Order ${orderId}: Your order is ready for ${order.deliveryType}!`, 'success');
                updateOrderTrackingUI(orderId);
            }, order.estimatedTime * 60 * 1000);

            // Delivered/Complete after additional time
            setTimeout(() => {
                order.status = 'delivered';
                order.progress.delivered = { time: new Date().toISOString(), completed: true };
                NotificationManager.show(`Order ${orderId}: Order completed! Enjoy your meal!`, 'success');
                updateOrderTrackingUI(orderId);
            }, (order.estimatedTime + 5) * 60 * 1000);
        }

        function trackOrder(orderId) {
            closeReceiptModal();
            const order = FoodOrderingSystem.orderHistory.find(o => o.id === orderId);
            if (!order) {
                NotificationManager.show('Order not found', 'error');
                return;
            }

            showOrderTrackingModal(order);
        }

        function showOrderTrackingModal(order) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';

            const progressSteps = [
                { key: 'confirmed', label: 'Order Confirmed', icon: 'check_circle' },
                { key: 'preparing', label: 'Preparing', icon: 'restaurant' },
                { key: 'cooking', label: 'Cooking', icon: 'local_fire_department' },
                { key: 'ready', label: 'Ready', icon: 'done_all' },
                { key: 'delivered', label: 'Delivered', icon: 'delivery_dining' }
            ];

            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-t-2xl">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-3">
                                <span class="material-symbols-outlined text-2xl">track_changes</span>
                            </div>
                            <h3 class="text-xl font-bold">Track Your Order</h3>
                            <p class="text-blue-100">Order #${order.id}</p>
                        </div>
                    </div>

                    <!-- Order Details -->
                    <div class="p-6">
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <h4 class="font-bold text-gray-900 mb-1">Order Summary</h4>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p><strong>Customer:</strong> ${order.customerName}</p>
                                <p><strong>Table:</strong> ${order.tableNumber}</p>
                                <p><strong>Total:</strong> <span class="font-bold text-green-600">฿${order.total}</span></p>
                                <p><strong>Estimated Time:</strong> ${order.estimatedTime} minutes</p>
                            </div>
                        </div>

                        <!-- Progress Tracking -->
                        <div class="mb-6">
                            <h4 class="font-bold text-gray-900 mb-4">Order Progress</h4>
                            <div class="space-y-4">
                                ${progressSteps.map((step, index) => {
                                    const isCompleted = order.progress[step.key].completed;
                                    const isActive = !isCompleted &&
                                        (index === 0 || order.progress[progressSteps[index - 1].key].completed);
                                    const time = order.progress[step.key].time;

                                    return `
                                        <div class="flex items-center space-x-4 ${isCompleted ? 'text-green-600' : isActive ? 'text-blue-600' : 'text-gray-400'}">
                                            <div class="w-10 h-10 rounded-full flex items-center justify-center ${
                                                isCompleted ? 'bg-green-100' : isActive ? 'bg-blue-100 animate-pulse' : 'bg-gray-100'
                                            }">
                                                <span class="material-symbols-outlined text-lg">${step.icon}</span>
                                            </div>
                                            <div class="flex-1">
                                                <p class="font-semibold">${step.label}</p>
                                                ${time ? `<p class="text-xs opacity-70">${new Date(time).toLocaleTimeString()}</p>` :
                                                  isActive ? '<p class="text-xs opacity-70">In progress...</p>' :
                                                  '<p class="text-xs opacity-70">Pending</p>'}
                                            </div>
                                            ${isCompleted ? '<span class="material-symbols-outlined text-green-500">check</span>' : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Estimated Completion -->
                        ${order.status !== 'delivered' ? `
                            <div class="bg-orange-50 rounded-lg p-4 mb-6">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="material-symbols-outlined text-orange-600">schedule</span>
                                    <span class="font-semibold text-orange-800">Estimated Completion</span>
                                </div>
                                <p class="text-orange-700 font-bold">${getRemainingTime(order)} remaining</p>
                            </div>
                        ` : `
                            <div class="bg-green-50 rounded-lg p-4 mb-6">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="material-symbols-outlined text-green-600">check_circle</span>
                                    <span class="font-semibold text-green-800">Order Complete</span>
                                </div>
                                <p class="text-green-700">Enjoy your meal!</p>
                            </div>
                        `}

                        <!-- Order Items -->
                        <div class="border-t pt-4">
                            <h4 class="font-bold text-gray-900 mb-3">Your Items</h4>
                            <div class="space-y-2">
                                ${order.items.map(item => `
                                    <div class="flex items-center justify-between py-2">
                                        <div class="flex items-center space-x-3">
                                            <img src="${item.image}" alt="${item.name}" class="w-8 h-8 rounded object-cover" onerror="this.src='https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=100&h=100&fit=crop'">
                                            <span class="font-medium text-sm">${item.name}</span>
                                            <span class="text-gray-500 text-sm">×${item.quantity}</span>
                                        </div>
                                        <span class="font-semibold text-sm">฿${item.totalPrice}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="mt-6 space-y-3">
                            <button onclick="refreshOrderStatus('${order.id}')" class="w-full btn-primary">
                                <span class="material-symbols-outlined text-sm mr-2">refresh</span>
                                Refresh Status
                            </button>
                            <button onclick="viewOrderHistory()" class="w-full btn-secondary">
                                <span class="material-symbols-outlined text-sm mr-2">history</span>
                                View Order History
                            </button>
                            <button onclick="closeTrackingModal()" class="w-full btn-outline">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentTrackingModal = modal;

            // Auto-refresh every 30 seconds
            window.trackingInterval = setInterval(() => {
                refreshOrderStatus(order.id, false);
            }, 30000);
        }

        function getRemainingTime(order) {
            const orderTime = new Date(order.orderTime);
            const estimatedCompletionTime = new Date(orderTime.getTime() + order.estimatedTime * 60000);
            const now = new Date();
            const remainingMs = estimatedCompletionTime - now;

            if (remainingMs <= 0) return "Any moment now";

            const remainingMinutes = Math.ceil(remainingMs / 60000);
            return `${remainingMinutes} minute${remainingMinutes !== 1 ? 's' : ''}`;
        }

        function refreshOrderStatus(orderId, showNotification = true) {
            const order = FoodOrderingSystem.orderHistory.find(o => o.id === orderId);
            if (!order) return;

            if (showNotification) {
                NotificationManager.show('Refreshing order status...', 'info');
            }

            // If tracking modal is open, refresh it
            if (window.currentTrackingModal) {
                closeTrackingModal();
                setTimeout(() => showOrderTrackingModal(order), 100);
            }
        }

        function closeTrackingModal() {
            if (window.currentTrackingModal) {
                document.body.removeChild(window.currentTrackingModal);
                window.currentTrackingModal = null;
            }
            if (window.trackingInterval) {
                clearInterval(window.trackingInterval);
                window.trackingInterval = null;
            }
        }

        function updateOrderTrackingUI(orderId) {
            // Update any tracking UI if visible
            if (window.currentTrackingModal) {
                const order = FoodOrderingSystem.orderHistory.find(o => o.id === orderId);
                if (order) {
                    refreshOrderStatus(orderId, false);
                }
            }

            // Always update the status tab when order tracking changes
            setTimeout(() => {
                updateOrderStatusTab();
            }, 100);
        }

        function printReceipt(orderId) {
            const order = FoodOrderingSystem.orderHistory.find(o => o.id === orderId);
            if (!order) return;

            // Create printable receipt
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Receipt - Order #${order.id}</title>
                    <style>
                        body { font-family: 'Courier New', monospace; max-width: 300px; margin: 0 auto; padding: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
                        .line-item { display: flex; justify-content: space-between; margin: 5px 0; }
                        .total { border-top: 1px solid #000; padding-top: 10px; margin-top: 10px; font-weight: bold; }
                        .footer { text-align: center; margin-top: 20px; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>MciPro Golf Course</h2>
                        <p>Order Receipt</p>
                        <p>Order #${order.id}</p>
                        <p>${new Date(order.orderTime).toLocaleString()}</p>
                    </div>

                    <div class="line-item">
                        <span>Customer:</span>
                        <span>${order.customerName}</span>
                    </div>
                    <div class="line-item">
                        <span>Table:</span>
                        <span>${order.tableNumber}</span>
                    </div>
                    <hr>

                    ${order.items.map(item => `
                        <div class="line-item">
                            <span>${item.name} x${item.quantity}</span>
                            <span>฿${item.totalPrice}</span>
                        </div>
                    `).join('')}

                    <div class="total">
                        <div class="line-item">
                            <span>Subtotal:</span>
                            <span>฿${order.subtotal}</span>
                        </div>
                        <div class="line-item">
                            <span>Service Charge:</span>
                            <span>฿${order.serviceCharge}</span>
                        </div>
                        ${order.deliveryFee > 0 ? `
                            <div class="line-item">
                                <span>Delivery Fee:</span>
                                <span>฿${order.deliveryFee}</span>
                            </div>
                        ` : ''}
                        <div class="line-item" style="font-size: 18px;">
                            <span>TOTAL:</span>
                            <span>฿${order.total}</span>
                        </div>
                    </div>

                    <div class="footer">
                        <p>Thank you for dining with us!</p>
                        <p>MciPro Golf Course Restaurant</p>
                        <p>Est. completion: ${order.estimatedTime} minutes</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function viewOrderHistory() {
            closeTrackingModal();
            showOrderHistoryModal();
        }

        function showOrderHistoryModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 flex-shrink-0">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold">Order History</h3>
                                <p class="text-purple-100">Your recent food orders</p>
                            </div>
                            <button onclick="closeOrderHistoryModal()" class="text-white hover:text-purple-200">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>
                    </div>

                    <!-- Order History List -->
                    <div class="flex-1 overflow-y-auto p-6">
                        ${FoodOrderingSystem.orderHistory.length > 0 ? `
                            <div class="space-y-4">
                                ${FoodOrderingSystem.orderHistory.map(order => `
                                    <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                                        <div class="flex items-center justify-between mb-3">
                                            <div>
                                                <h4 class="font-bold text-gray-900">Order #${order.id}</h4>
                                                <p class="text-sm text-gray-600">${new Date(order.orderTime).toLocaleString()}</p>
                                            </div>
                                            <div class="text-right">
                                                <span class="text-lg font-bold text-green-600">฿${order.total}</span>
                                                <div class="mt-1">
                                                    <span class="px-2 py-1 text-xs rounded-full ${getStatusBadgeClass(order.status)}">
                                                        ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="text-sm text-gray-600 mb-3">
                                            <p><strong>Items:</strong> ${order.items.map(item => `${item.name} (×${item.quantity})`).join(', ')}</p>
                                            <p><strong>Delivery:</strong> ${order.deliveryOption.name}</p>
                                        </div>

                                        <div class="flex space-x-2">
                                            <button onclick="trackOrder('${order.id}')" class="btn-sm btn-primary">
                                                <span class="material-symbols-outlined text-sm mr-1">track_changes</span>
                                                Track
                                            </button>
                                            <button onclick="printReceipt('${order.id}')" class="btn-sm btn-secondary">
                                                <span class="material-symbols-outlined text-sm mr-1">print</span>
                                                Receipt
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-12 text-gray-500">
                                <span class="material-symbols-outlined text-6xl mb-4 block">restaurant</span>
                                <p class="text-lg mb-2">No orders yet</p>
                                <p class="text-sm">Your food orders will appear here</p>
                            </div>
                        `}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentOrderHistoryModal = modal;
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'confirmed': 'bg-blue-100 text-blue-800',
                'preparing': 'bg-yellow-100 text-yellow-800',
                'cooking': 'bg-orange-100 text-orange-800',
                'ready': 'bg-green-100 text-green-800',
                'delivered': 'bg-gray-100 text-gray-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        // Alias for order status tab compatibility
        function getStatusClass(status) {
            return getStatusBadgeClass(status);
        }

        function closeOrderHistoryModal() {
            if (window.currentOrderHistoryModal) {
                document.body.removeChild(window.currentOrderHistoryModal);
                window.currentOrderHistoryModal = null;
            }
        }

        function showOrderHistory() {
            const historyContainer = document.getElementById('orderHistoryContainer');
            if (!historyContainer) return;

            historyContainer.innerHTML = FoodOrderingSystem.orderHistory.map(order => `
                <div class="order-history-item p-4 border border-gray-200 rounded-xl">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h5 class="font-bold text-gray-900">Order ${order.id}</h5>
                            <p class="text-sm text-gray-600">${order.date}</p>
                        </div>
                        <span class="order-status ${order.status === 'delivered' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'} px-2 py-1 rounded-full text-xs font-medium">
                            ${order.status}
                        </span>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">
                        ${order.items.join(', ')}
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-primary-600">฿${order.total.toLocaleString()}</span>
                        ${order.status === 'preparing' ? '<button class="btn-secondary text-xs px-3 py-1">Track Order</button>' : ''}
                    </div>
                </div>
            `).join('');
        }

        // Golf Course Database for Caddy Promotions
        const GolfCourseDatabase = {
            courses: [
                {
                    id: 'pattaya-golf',
                    name: 'Pattaya Golf Club',
                    location: 'Pattaya, Thailand',
                    rating: 4.8,
                    holes: 18,
                    type: 'Championship',
                    description: 'Premier championship golf course with ocean views',
                    amenities: ['Pro Shop', 'Restaurant', 'Driving Range', 'Club House'],
                    greenFees: { weekday: 2500, weekend: 3200 },
                    image: '🏌️‍♂️',
                    featured: true
                },
                {
                    id: 'thai-country-club',
                    name: 'Thai Country Club',
                    location: 'Bangkok, Thailand',
                    rating: 4.9,
                    holes: 18,
                    type: 'Luxury',
                    description: 'Exclusive luxury golf experience in Bangkok',
                    amenities: ['Spa', 'Fine Dining', 'Caddy Academy', 'VIP Lounge'],
                    greenFees: { weekday: 4500, weekend: 5800 },
                    image: '⛳',
                    featured: true
                },
                {
                    id: 'siam-plantation',
                    name: 'Siam Plantation Golf',
                    location: 'Pattaya, Thailand',
                    rating: 4.6,
                    holes: 27,
                    type: 'Resort',
                    description: 'Beautiful resort course with tropical landscape',
                    amenities: ['Resort', 'Pool', 'Spa', 'Multiple Restaurants'],
                    greenFees: { weekday: 3200, weekend: 4000 },
                    image: '🌴',
                    featured: false
                },
                {
                    id: 'royal-garden',
                    name: 'Royal Garden Golf Club',
                    location: 'Hua Hin, Thailand',
                    rating: 4.7,
                    holes: 18,
                    type: 'Royal',
                    description: 'Royal golf course with traditional Thai design',
                    amenities: ['Royal Clubhouse', 'Traditional Cuisine', 'Cultural Tours'],
                    greenFees: { weekday: 3800, weekend: 4600 },
                    image: '👑',
                    featured: true
                }
            ],

            getRandomCourse() {
                const featuredCourses = this.courses.filter(c => c.featured);
                return featuredCourses[Math.floor(Math.random() * featuredCourses.length)];
            },

            getCourseById(id) {
                return this.courses.find(c => c.id === id);
            }
        };

        // ===== ORDER STATUS TAB FUNCTIONS =====

        function updateOrderStatusTab() {
            const activeOrdersList = document.getElementById('activeOrdersList');
            const orderHistoryList = document.getElementById('orderHistoryList');
            const activeOrdersCount = document.getElementById('activeOrdersCount');

            if (!FoodOrderingSystem.orderHistory) {
                FoodOrderingSystem.orderHistory = [];
            }

            // Filter active orders (not delivered)
            const activeOrders = FoodOrderingSystem.orderHistory.filter(order =>
                order.status !== 'delivered' && order.status !== 'cancelled'
            );

            // Update active orders count
            if (activeOrdersCount) {
                activeOrdersCount.textContent = `${activeOrders.length} active order${activeOrders.length !== 1 ? 's' : ''}`;
            }

            // Update badges
            const activeOrdersBadge = document.getElementById('activeOrdersBadge');
            const orderStatusTabBadge = document.getElementById('orderStatusTabBadge');

            if (activeOrdersBadge) {
                if (activeOrders.length > 0) {
                    activeOrdersBadge.textContent = activeOrders.length;
                    activeOrdersBadge.style.display = 'inline';
                } else {
                    activeOrdersBadge.style.display = 'none';
                }
            }

            if (orderStatusTabBadge) {
                if (activeOrders.length > 0) {
                    orderStatusTabBadge.textContent = activeOrders.length;
                    orderStatusTabBadge.style.display = 'flex';
                } else {
                    orderStatusTabBadge.style.display = 'none';
                }
            }

            // Update active orders list
            if (activeOrdersList) {
                if (activeOrders.length === 0) {
                    activeOrdersList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <span class="material-symbols-outlined text-4xl mb-2 opacity-50">receipt_long</span>
                            <p>No active orders</p>
                            <button onclick="showGolferTab('food', event)" class="mt-4 bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700">
                                Order Food & Drinks
                            </button>
                        </div>
                    `;
                } else {
                    activeOrdersList.innerHTML = activeOrders.map(order => createOrderCard(order, true)).join('');
                }
            }

            // Update order history (last 10 orders)
            if (orderHistoryList) {
                const recentHistory = FoodOrderingSystem.orderHistory.slice(0, 10);
                if (recentHistory.length === 0) {
                    orderHistoryList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <span class="material-symbols-outlined text-4xl mb-2 opacity-50">history</span>
                            <p>No order history</p>
                        </div>
                    `;
                } else {
                    orderHistoryList.innerHTML = recentHistory.map(order => createOrderCard(order, false)).join('');
                }

                // Update order history badge
                const orderHistoryBadge = document.getElementById('orderHistoryBadge');
                if (orderHistoryBadge) {
                    if (recentHistory.length > 0) {
                        orderHistoryBadge.textContent = recentHistory.length;
                        orderHistoryBadge.style.display = 'inline';
                    } else {
                        orderHistoryBadge.style.display = 'none';
                    }
                }
            }
        }

        function createOrderCard(order, isActive) {
            const statusColor = getStatusClass(order.status);
            const progress = getOrderProgress(order);

            return `
                <div class="border border-gray-200 rounded-xl p-4 ${isActive ? 'bg-blue-50' : 'bg-white'} hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center">
                                <span class="material-symbols-outlined text-primary-600">restaurant</span>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900">Order #${order.id}</h4>
                                <p class="text-sm text-gray-500">${new Date(order.orderTime).toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                                ${order.status.toUpperCase()}
                            </span>
                            <p class="text-sm font-semibold text-gray-900 mt-1">฿${order.total}</p>
                        </div>
                    </div>

                    <!-- Order Items -->
                    <div class="mb-3">
                        <div class="text-sm text-gray-600 space-y-2">
                            ${order.items.slice(0, 2).map(item =>
                                `<div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <img src="${item.image}" alt="${item.name}" class="w-8 h-8 rounded object-cover" onerror="this.src='https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=100&h=100&fit=crop'">
                                        <span>${item.name} x${item.quantity}</span>
                                    </div>
                                    <span>฿${item.totalPrice}</span>
                                </div>`
                            ).join('')}
                            ${order.items.length > 2 ? `<p class="text-xs text-gray-500">+${order.items.length - 2} more items</p>` : ''}
                        </div>
                    </div>

                    ${isActive ? `
                        <!-- Progress Bar -->
                        <div class="mb-3">
                            <div class="flex items-center justify-between text-xs text-gray-600 mb-1">
                                <span>Progress</span>
                                <span>${progress}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-primary-600 h-2 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                            </div>
                        </div>

                        <!-- Estimated Time -->
                        <div class="text-sm text-gray-600 mb-3">
                            <span class="material-symbols-outlined text-xs">schedule</span>
                            ${order.deliveryOption?.name || 'Course Delivery'} • ${order.estimatedTime || '15-20 min'}
                        </div>
                    ` : ''}

                    <!-- Actions -->
                    <div class="flex space-x-2">
                        <button onclick="showOrderDetails('${order.id}')" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium">
                            View Details
                        </button>
                        ${isActive ? `
                            <button onclick="trackOrder('${order.id}')" class="flex-1 bg-primary-600 hover:bg-primary-700 text-white px-3 py-2 rounded-lg text-sm font-medium">
                                Track Order
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function getOrderProgress(order) {
            if (!order.progress) return 0;

            const stages = ['confirmed', 'preparing', 'cooking', 'ready', 'delivered'];
            let completed = 0;

            stages.forEach(stage => {
                if (order.progress[stage]?.completed) {
                    completed++;
                }
            });

            return Math.round((completed / stages.length) * 100);
        }

        function showOrderDetails(orderId) {
            const order = FoodOrderingSystem.orderHistory.find(o => o.id === orderId);
            if (!order) return;

            // Show the existing order receipt modal
            showOrderReceipt(order);
        }

        function trackOrder(orderId) {
            const order = FoodOrderingSystem.orderHistory.find(o => o.id === orderId);
            if (!order) return;

            // Show the existing order tracking UI
            showOrderReceipt(order);

            // Automatically scroll to tracking section
            setTimeout(() => {
                const trackingElement = document.querySelector('.order-tracking-status');
                if (trackingElement) {
                    trackingElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 300);
        }

        function clearOrderHistory() {
            if (confirm('Are you sure you want to clear your order history? This action cannot be undone.')) {
                FoodOrderingSystem.orderHistory = [];
                updateOrderStatusTab();
                NotificationManager.show('Order history cleared', 'info');
            }
        }

        function contactKitchen() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Contact Kitchen</h3>
                    <div class="space-y-4">
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <div class="flex items-center space-x-3">
                                <span class="material-symbols-outlined text-orange-600">restaurant</span>
                                <div>
                                    <p class="font-semibold text-orange-800">Kitchen Direct Line</p>
                                    <p class="text-orange-700">+66-2-555-0101</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center space-x-3">
                                <span class="material-symbols-outlined text-blue-600">headset_mic</span>
                                <div>
                                    <p class="font-semibold text-blue-800">Food Service Manager</p>
                                    <p class="text-blue-700">+66-2-555-0102</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center space-x-3">
                                <span class="material-symbols-outlined text-green-600">chat</span>
                                <div>
                                    <p class="font-semibold text-green-800">Send Message</p>
                                    <button onclick="openKitchenChat()" class="text-green-700 hover:text-green-800 text-sm underline">
                                        Chat with kitchen staff
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-3 mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium">
                            Close
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function openKitchenChat() {
            // Close contact modal
            document.querySelector('.fixed.inset-0').remove();

            // Switch to chat and open kitchen room
            showGolferTab('overview', event);
            setTimeout(() => {
                window.openProfessionalChat();
            }, 500);
        }

        // ===== GLOBAL PERFORMANCE CACHE MANAGER =====
        // Ultra-fast caching system for all dashboards and modules
        const GlobalCacheManager = {
            cache: {},
            subscriptions: {},
            cacheDuration: 30000, // 30 seconds default cache

            // Get cached data if fresh
            get(key) {
                const cached = this.cache[key];
                if (!cached) return null;

                const age = Date.now() - cached.timestamp;
                if (age > cached.duration) {
                    console.log(`[Cache] Expired: ${key} (${age}ms old)`);
                    delete this.cache[key];
                    return null;
                }

                console.log(`[Cache] HIT: ${key} (${age}ms old)`);
                return cached.data;
            },

            // Store data in cache
            set(key, data, duration = this.cacheDuration) {
                this.cache[key] = {
                    data: data,
                    timestamp: Date.now(),
                    duration: duration
                };
                console.log(`[Cache] SET: ${key} (expires in ${duration}ms)`);
            },

            // Invalidate specific cache key
            invalidate(key) {
                if (this.cache[key]) {
                    console.log(`[Cache] INVALIDATED: ${key}`);
                    delete this.cache[key];
                }
            },

            // Invalidate all cache
            invalidateAll() {
                console.log('[Cache] INVALIDATED ALL');
                this.cache = {};
            },

            // Invalidate cache by pattern
            invalidatePattern(pattern) {
                Object.keys(this.cache).forEach(key => {
                    if (key.includes(pattern)) {
                        console.log(`[Cache] INVALIDATED: ${key} (pattern: ${pattern})`);
                        delete this.cache[key];
                    }
                });
            },

            // Prevent duplicate subscriptions
            subscribe(key, subscriptionFn) {
                if (this.subscriptions[key]) {
                    console.log(`[Cache] Subscription already exists: ${key}`);
                    return this.subscriptions[key];
                }

                console.log(`[Cache] Creating subscription: ${key}`);
                this.subscriptions[key] = subscriptionFn();
                return this.subscriptions[key];
            },

            // Unsubscribe
            unsubscribe(key) {
                if (this.subscriptions[key]) {
                    console.log(`[Cache] Unsubscribing: ${key}`);
                    if (typeof this.subscriptions[key].unsubscribe === 'function') {
                        this.subscriptions[key].unsubscribe();
                    }
                    delete this.subscriptions[key];
                }
            },

            // Clear all subscriptions
            unsubscribeAll() {
                console.log('[Cache] Unsubscribing all');
                Object.keys(this.subscriptions).forEach(key => {
                    this.unsubscribe(key);
                });
            },

            // Cached async fetch wrapper
            async fetchCached(key, fetchFn, duration = this.cacheDuration) {
                // Try cache first
                const cached = this.get(key);
                if (cached !== null) {
                    return cached;
                }

                // Fetch fresh data
                console.log(`[Cache] MISS: ${key} - fetching...`);
                const data = await fetchFn();
                this.set(key, data, duration);
                return data;
            }
        };

        // Make globally available
        window.GlobalCacheManager = GlobalCacheManager;

        // ===== MOBILE PERFORMANCE OPTIMIZATION =====
        // Handle app visibility changes (mobile background/foreground)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                console.log('[Mobile] App resumed - invalidating stale cache');
                // Invalidate cache older than 5 minutes when app resumes
                Object.keys(GlobalCacheManager.cache).forEach(key => {
                    const cached = GlobalCacheManager.cache[key];
                    const age = Date.now() - cached.timestamp;
                    if (age > 300000) { // 5 minutes
                        console.log(`[Mobile] Invalidating old cache: ${key} (${Math.round(age/1000)}s old)`);
                        GlobalCacheManager.invalidate(key);
                    }
                });
            }
        });

        // Handle page focus (mobile/desktop)
        window.addEventListener('focus', function() {
            console.log('[Mobile] Window focused');
            // Don't invalidate cache on focus - use visibility instead
        });

        // Optimize for mobile memory management
        window.addEventListener('pagehide', function() {
            console.log('[Mobile] Page hidden - preparing for background');
            // Keep cache but unsubscribe from heavy listeners
            if (typeof GlobalCacheManager.unsubscribeAll === 'function') {
                // Don't unsubscribe all - this would break realtime
                // Just log for debugging
                console.log('[Mobile] Keeping subscriptions active in background');
            }
        });

        // Profile Management System
        const ProfileSystem = {
            profiles: {
                golfer: {
                    template: {
                        personalInfo: {
                            firstName: '',
                            lastName: '',
                            nickname: '',
                            dateOfBirth: '',
                            nationality: 'Thai',
                            phone: '',
                            email: '',
                            address: '',
                            emergencyContact: ''
                        },
                        golfInfo: {
                            handicap: '18',
                            memberSince: new Date().toISOString().split('T')[0],
                            homeClub: '',
                            clubAffiliation: '',
                            playingStyle: '',
                            favoriteClubs: [],
                            golfGoals: '',
                            experienceLevel: 'Intermediate'
                        },
                        preferences: {
                            preferredTeeTime: 'Morning',
                            preferredCaddyType: 'Professional',
                            dietaryRestrictions: '',
                            specialRequests: '',
                            communicationLanguage: 'English',
                            notifications: true
                        },
                        media: {
                            profilePhoto: '',
                            golfPhotos: [],
                            achievements: []
                        },
                        privacy: {
                            profileVisibility: 'members',
                            showHandicap: true,
                            showStats: true,
                            allowMessages: true
                        }
                    }
                },
                caddie: {
                    template: {
                        personalInfo: {
                            firstName: '',
                            lastName: '',
                            nickname: '',
                            dateOfBirth: '',
                            nationality: '',
                            phone: '',
                            email: '',
                            address: '',
                            emergencyContact: ''
                        },
                        professionalInfo: {
                            licenseNumber: '',
                            experience: '',
                            homeClub: '',
                            specialties: [],
                            languages: [],
                            certifications: [],
                            workingHours: '',
                            availability: 'available'
                        },
                        skills: {
                            courseKnowledge: '',
                            clubSelection: '',
                            readingGreens: '',
                            mentalCoaching: '',
                            customerService: '',
                            additionalSkills: []
                        },
                        media: {
                            profilePhoto: '',
                            workPhotos: [],
                            certificates: [],
                            testimonials: []
                        },
                        preferences: {
                            preferredGroupSize: '',
                            workingStyle: '',
                            communicationStyle: '',
                            specialAccommodations: ''
                        }
                    }
                },
                manager: {
                    template: {
                        personalInfo: {
                            firstName: '',
                            lastName: '',
                            title: '',
                            department: '',
                            phone: '',
                            email: '',
                            address: '',
                            emergencyContact: ''
                        },
                        professionalInfo: {
                            employeeId: '',
                            startDate: '',
                            position: '',
                            responsibilities: [],
                            managementLevel: '',
                            reportingTo: '',
                            directReports: []
                        },
                        qualifications: {
                            education: '',
                            certifications: [],
                            experience: '',
                            specializations: [],
                            languages: []
                        },
                        media: {
                            profilePhoto: '',
                            teamPhotos: [],
                            achievements: [],
                            presentations: []
                        }
                    }
                },
                proshop: {
                    template: {
                        personalInfo: {
                            firstName: '',
                            lastName: '',
                            title: '',
                            phone: '',
                            email: '',
                            address: '',
                            emergencyContact: ''
                        },
                        professionalInfo: {
                            employeeId: '',
                            startDate: '',
                            position: '',
                            departments: [],
                            shiftSchedule: '',
                            expertise: []
                        },
                        skills: {
                            salesExperience: '',
                            productKnowledge: '',
                            customerService: '',
                            languages: [],
                            technicalSkills: [],
                            specializations: []
                        },
                        media: {
                            profilePhoto: '',
                            workPhotos: [],
                            certifications: [],
                            achievements: []
                        }
                    }
                },
                society: {
                    template: {
                        organizationInfo: {
                            societyName: '',
                            organizerName: '',
                            title: '',
                            establishedDate: '',
                            memberCount: '',
                            phone: '',
                            email: '',
                            website: '',
                            address: ''
                        },
                        golfInfo: {
                            societyType: '',
                            playingLevel: '',
                            meetingFrequency: '',
                            homeClubs: [],
                            tournaments: [],
                            handicapRange: '',
                            specialEvents: []
                        },
                        preferences: {
                            preferredCourses: [],
                            groupSize: '',
                            budgetRange: '',
                            cateringNeeds: '',
                            specialRequirements: '',
                            communicationMethod: ''
                        },
                        media: {
                            societyLogo: '',
                            eventPhotos: [],
                            trophies: [],
                            certificates: [],
                            promotional: []
                        },
                        contact: {
                            primaryContact: '',
                            secondaryContact: '',
                            bookingContact: '',
                            financialContact: '',
                            emergencyContact: ''
                        }
                    }
                }
            },

            // SECURITY: Check if current user can edit a profile
            async canEditProfile() {
                console.log('[ProfileSystem] 🔐 Checking edit permissions...');
                console.log('[ProfileSystem] Current user:', AppState.currentUser);

                // If user is logged in via AppState, they can edit their own profile
                if (AppState.currentUser && AppState.currentUser.lineUserId) {
                    console.log('[ProfileSystem] ✅ User is logged in via AppState - allowing profile edit');
                    return true;
                }

                // Fallback: Check if LINE is authenticated (only if liff is initialized)
                try {
                    if (typeof liff !== 'undefined' && liff.isLoggedIn && liff.isLoggedIn()) {
                        const lineProfile = await liff.getProfile();
                        const currentLineUserId = lineProfile.userId;

                        console.log('[ProfileSystem] Checking authorization for LINE User ID:', currentLineUserId);

                        // Check if user is admin
                        if (LineConfig.adminUserIds.includes(currentLineUserId)) {
                            console.log('[ProfileSystem] Admin access granted');
                            return true; // Admins can edit any profile
                        }

                        // Check if current user's LINE ID matches (they're editing their own profile)
                        if (AppState.currentUser.lineUserId === currentLineUserId) {
                            console.log('[ProfileSystem] Owner access granted - matches current user');
                            return true;
                        }

                        // Check if profile belongs to this LINE user
                        const profile = this.getCurrentProfile(AppState.currentUser.role);

                        // If profile doesn't have lineUserId yet (legacy profile), allow edit
                        // This allows users to claim their existing profiles
                        if (profile && !profile.lineUserId) {
                            console.log('[ProfileSystem] Legacy profile detected - allowing edit to claim ownership');
                            return true;
                        }

                        if (profile && profile.lineUserId === currentLineUserId) {
                            console.log('[ProfileSystem] Owner access granted - matches profile');
                            return true; // Owner can edit their own profile
                        }
                    }
                } catch (error) {
                    console.warn('[ProfileSystem] ⚠️ LIFF check failed (not initialized or error):', error.message);
                    // If LIFF check fails but user is in AppState, they can still edit
                    if (AppState.currentUser && AppState.currentUser.lineUserId) {
                        console.log('[ProfileSystem] ✅ Allowing edit based on AppState despite LIFF error');
                        return true;
                    }
                }

                console.log('[ProfileSystem] ❌ Authorization denied');
                return false; // No permission
            },

            // SECURITY: Check if current user is admin
            async isAdmin() {
                try {
                    if (typeof liff !== 'undefined' && liff.isLoggedIn && liff.isLoggedIn()) {
                        const lineProfile = await liff.getProfile();
                        return LineConfig.adminUserIds.includes(lineProfile.userId);
                    }
                } catch (error) {
                    console.warn('[ProfileSystem] isAdmin LIFF check failed:', error.message);
                }
                return false;
            },

            getCurrentProfile(userType) {
                try {
                    // Check if profile was just deleted - don't recreate
                    if (localStorage.getItem('PROFILE_DELETE_FLAG') === 'true') {
                        console.log('[ProfileSystem] Profile delete flag detected - preventing auto-creation');
                        localStorage.removeItem('PROFILE_DELETE_FLAG');
                        return null;
                    }

                    // Get unique ID for current user
                    const uniqueId = UserIDSystem.getUserUniqueID(AppState.currentUser);
                    if (!uniqueId) {
                        console.warn('[ProfileSystem] No unique ID available for user');
                        return null;
                    }

                    // Ensure userId is set in AppState
                    if (!AppState.currentUser.userId) {
                        AppState.currentUser.userId = uniqueId;
                    }

                    // NEW: Use unique ID-based key
                    const newProfileKey = UserIDSystem.getProfileKey(userType, uniqueId);
                    let saved = localStorage.getItem(newProfileKey);

                    console.log('[ProfileSystem] Looking up profile with unique ID:', {
                        uniqueId: uniqueId.substring(0, 12) + '...',
                        newKey: newProfileKey,
                        foundWithNewKey: !!saved
                    });

                    // MIGRATION: If not found with new key, try old name-based keys and migrate
                    if (!saved) {
                        console.log('[ProfileSystem] Profile not found with new key, attempting migration...');

                        // Try old name-based key
                        const oldNameKey = `profile_${userType}_${AppState.currentUser.name}`;
                        const oldSaved = localStorage.getItem(oldNameKey);

                        if (oldSaved) {
                            console.log('[ProfileSystem] Found old profile, migrating to new key:', oldNameKey, '->', newProfileKey);

                            // Migrate to new key
                            localStorage.setItem(newProfileKey, oldSaved);
                            saved = oldSaved;

                            // Keep old key for backward compatibility (will be cleaned up later)
                            // Don't delete yet to allow rollback if needed
                        } else {
                            // Try scanning all old profile keys
                            const allOldKeys = Object.keys(localStorage).filter(k => k.startsWith(`profile_${userType}_`));

                            for (const oldKey of allOldKeys) {
                                try {
                                    const testProfile = JSON.parse(localStorage.getItem(oldKey));
                                    if (testProfile.lineUserId === uniqueId) {
                                        console.log('[ProfileSystem] Found matching old profile, migrating:', oldKey, '->', newProfileKey);
                                        localStorage.setItem(newProfileKey, localStorage.getItem(oldKey));
                                        saved = localStorage.getItem(oldKey);
                                        break;
                                    }
                                } catch (e) {
                                    console.warn('[ProfileSystem] Error parsing old profile key:', oldKey, e);
                                }
                            }
                        }
                    }

                    if (saved) {
                        const profile = JSON.parse(saved);

                        // Ensure profile has the unique ID stored
                        if (!profile.userId) {
                            profile.userId = uniqueId;
                        }
                        if (!profile.lineUserId && AppState.currentUser.lineUserId) {
                            profile.lineUserId = AppState.currentUser.lineUserId;
                        }

                        // NORMALIZE: If profile has data at root level (new format), move to nested structure (old format)
                        if (profile.firstName && !profile.personalInfo) {
                            console.log('[ProfileSystem] Normalizing new profile format to legacy structure');
                            profile.personalInfo = {
                                username: profile.username || '',
                                firstName: profile.firstName || '',
                                lastName: profile.lastName || '',
                                nickname: profile.nickname || '',
                                nationality: profile.nationality || '',
                                phone: profile.phone || '',
                                email: profile.email || ''
                            };
                            profile.golfInfo = profile.roleSpecific || profile.golfInfo || {};
                            profile.media = profile.media || {};
                            profile.preferences = profile.preferences || {};
                        }

                        console.log('[ProfileSystem] Loading existing profile:', {
                            uniqueId: uniqueId.substring(0, 12) + '...',
                            handicap: profile.golfInfo?.handicap,
                            homeClub: profile.golfInfo?.homeClub,
                            clubAffiliation: profile.golfInfo?.clubAffiliation
                        });
                        return profile;
                    } else {
                        // Safe template access with fallback
                        const template = this.profiles && this.profiles[userType] && this.profiles[userType].template
                            ? JSON.parse(JSON.stringify(this.profiles[userType].template))
                            : {
                                personalInfo: { firstName: '', lastName: '' },
                                golfInfo: { homeClub: '', handicap: '18' },
                                preferences: {},
                                media: {},
                                privacy: {}
                            };

                        if (template.personalInfo) {
                            const nameParts = (AppState.currentUser?.name || '').split(' ');
                            template.personalInfo.firstName = nameParts[0] || '';
                            template.personalInfo.lastName = nameParts.slice(1).join(' ') || '';
                        }
                        if (template.organizationInfo) {
                            template.organizationInfo.organizerName = AppState.currentUser?.name || '';
                        }
                        console.log('[ProfileSystem] Using template profile - homeClub:', template.golfInfo?.homeClub);
                        return template;
                    }
                } catch (e) {
                    console.warn('[ProfileSystem] getCurrentProfile error, using fallback:', e);
                    return {
                        personalInfo: { firstName: '', lastName: '' },
                        golfInfo: { homeClub: '', handicap: '18' },
                        preferences: {},
                        media: {},
                        privacy: {}
                    };
                }
            },

            saveProfile(userType, profileData) {
                // Get unique ID for current user
                const uniqueId = UserIDSystem.getUserUniqueID(AppState.currentUser);
                if (!uniqueId) {
                    console.error('[ProfileSystem] Cannot save profile - no unique ID');
                    return;
                }

                // Ensure userId is set in AppState
                if (!AppState.currentUser.userId) {
                    AppState.currentUser.userId = uniqueId;
                }

                // Ensure profile has unique ID
                if (!profileData.userId) {
                    profileData.userId = uniqueId;
                }
                if (!profileData.lineUserId && AppState.currentUser.lineUserId) {
                    profileData.lineUserId = AppState.currentUser.lineUserId;
                }

                // NEW: Use unique ID-based key
                const newProfileKey = UserIDSystem.getProfileKey(userType, uniqueId);

                console.log('[ProfileSystem] Saving profile - BEFORE save:', {
                    uniqueId: uniqueId.substring(0, 12) + '...',
                    newKey: newProfileKey,
                    homeClub: profileData.golfInfo?.homeClub,
                    fullGolfInfo: profileData.golfInfo,
                    userType: userType,
                    userName: AppState.currentUser.name
                });

                localStorage.setItem(newProfileKey, JSON.stringify(profileData));

                // Also update mcipro_user_profiles array
                const profiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');
                const existingIndex = profiles.findIndex(p => p.lineUserId === uniqueId || p.userId === uniqueId);

                const profileSummary = {
                    userId: uniqueId,
                    lineUserId: uniqueId,
                    role: userType,
                    name: AppState.currentUser.name,
                    username: profileData.personalInfo?.username || AppState.currentUser.username,
                    email: profileData.personalInfo?.email,
                    phone: profileData.personalInfo?.phone
                };

                if (existingIndex >= 0) {
                    profiles[existingIndex] = { ...profiles[existingIndex], ...profileSummary };
                } else {
                    profiles.push(profileSummary);
                }
                localStorage.setItem('mcipro_user_profiles', JSON.stringify(profiles));

                // Verify it was saved correctly
                const savedCheck = localStorage.getItem(newProfileKey);
                const parsedCheck = JSON.parse(savedCheck);
                console.log('[ProfileSystem] Saving profile - AFTER save verification:', {
                    newKey: newProfileKey,
                    savedHomeClub: parsedCheck.golfInfo?.homeClub,
                    savedCorrectly: parsedCheck.golfInfo?.homeClub === profileData.golfInfo?.homeClub,
                    savedUserId: parsedCheck.userId
                });

                // Update current user name if changed
                if (profileData.personalInfo?.firstName && profileData.personalInfo?.lastName) {
                    AppState.currentUser.name = `${profileData.personalInfo.firstName} ${profileData.personalInfo.lastName}`;
                } else if (profileData.organizationInfo?.organizerName) {
                    AppState.currentUser.name = profileData.organizationInfo.organizerName;
                }

                // ===== FIX: Push FULL profile to Supabase for cross-device sync - NOW WITH 100% GUARANTEE =====
                // CRITICAL: Ensure lineUserId is set from uniqueId
                if (!AppState.currentUser.lineUserId) {
                    AppState.currentUser.lineUserId = uniqueId;
                    console.log('[ProfileSystem] ⚠️ lineUserId was missing - set from uniqueId:', uniqueId.substring(0, 12) + '...');
                }

                // CRITICAL: Always attempt Supabase sync - don't silently skip
                const attemptSupabaseSync = async () => {
                    try {
                        if (!window.SupabaseDB) {
                            console.warn('[ProfileSystem] ⚠️ SupabaseDB not ready - waiting...');
                            // Wait up to 5 seconds for SupabaseDB to initialize
                            for (let i = 0; i < 10; i++) {
                                await new Promise(resolve => setTimeout(resolve, 500));
                                if (window.SupabaseDB) {
                                    console.log('[ProfileSystem] ✓ SupabaseDB ready after wait');
                                    break;
                                }
                            }
                        }

                        if (!window.SupabaseDB) {
                            throw new Error('SupabaseDB failed to initialize after 5 seconds');
                        }

                        // Ensure SupabaseDB is fully initialized
                        if (window.SupabaseDB.waitForReady) {
                            await window.SupabaseDB.waitForReady();
                        }

                        console.log('[ProfileSystem] 🔄 Syncing to Supabase...', {
                            lineUserId: AppState.currentUser.lineUserId.substring(0, 12) + '...',
                            role: userType,
                            homeClub: profileData.golfInfo?.homeClub,
                            handicap: profileData.golfInfo?.handicap
                        });

                        await window.SupabaseDB.saveUserProfile({
                            lineUserId: AppState.currentUser.lineUserId,
                            name: AppState.currentUser.name,
                            role: userType,
                            phone: profileData.personalInfo?.phone || AppState.currentUser.phone,
                            email: profileData.personalInfo?.email || AppState.currentUser.email,
                            homeClub: profileData.golfInfo?.homeClub || '',
                            language: profileData.preferences?.communicationLanguage || 'en',
                            // Full profile data
                            personalInfo: profileData.personalInfo,
                            golfInfo: profileData.golfInfo,
                            professionalInfo: profileData.professionalInfo,
                            skills: profileData.skills,
                            preferences: profileData.preferences,
                            media: profileData.media,
                            privacy: profileData.privacy,
                            handicap: profileData.golfInfo?.handicap,
                            username: profileData.personalInfo?.username,
                            userId: uniqueId,
                            linePictureUrl: profileData.linePictureUrl || AppState.currentUser.avatar
                        });

                        console.log('[ProfileSystem] ✅ 100% SYNCED TO SUPABASE - Profile available on all devices!');

                        // Show success confirmation to user
                        if (typeof NotificationManager !== 'undefined') {
                            NotificationManager.show('✅ Profile synced to cloud!', 'success');
                        }

                    } catch (err) {
                        console.error('[ProfileSystem] ❌ CRITICAL: Failed to sync profile to Supabase:', err);
                        console.error('[ProfileSystem] Stack trace:', err.stack);

                        // ALERT USER - this is critical!
                        const userMessage = `⚠️ WARNING: Profile saved locally but cloud sync failed!\n\nError: ${err.message}\n\nYour profile may not appear on other devices.\n\nPlease try saving again or contact support if this persists.`;

                        if (typeof NotificationManager !== 'undefined') {
                            NotificationManager.show(userMessage, 'error', 10000);
                        } else {
                            alert(userMessage);
                        }
                    }
                };

                // Execute sync immediately (don't wait for it to complete before returning)
                attemptSupabaseSync();

                this.updateUIWithProfile();
                console.log(`[SUCCESS] Profile saved with unique ID for ${userType}`, profileData.golfInfo?.homeClub ? `- homeClub: ${profileData.golfInfo.homeClub}` : '- no homeClub');
            },

            updateUIWithProfile(incoming) {
                try {
                    // Use incoming profile or get current profile safely
                    const profile = (incoming && typeof incoming === 'object')
                        ? incoming
                        : this.getCurrentProfile(AppState.currentUser?.role || 'golfer');

                    // Update all user name displays
                    const userName = AppState.currentUser?.name || '';
                    document.querySelectorAll('.user-name-display').forEach(el => {
                        el.textContent = userName;
                    });

                    // Update user avatar if available
                    const avatarUrl = profile.media?.profilePhoto || profile.media?.societyLogo;
                    if (avatarUrl) {
                        document.querySelectorAll('.user-avatar').forEach(el => {
                            el.src = avatarUrl;
                            el.style.display = 'block';
                        });
                    }

                    // Update home club displays
                    const homeClub = profile.golfInfo?.homeClub || 'Not Selected';
                    console.log('[ProfileSystem] updateUIWithProfile - homeClub debug:', {
                        profile: profile,
                        golfInfo: profile.golfInfo,
                        homeClub: profile.golfInfo?.homeClub,
                        finalDisplay: homeClub,
                        homeClubElements: document.querySelectorAll('.home-club').length
                    });
                    document.querySelectorAll('.home-club').forEach(el => {
                        el.textContent = homeClub;
                    });
                    console.log('[ProfileSystem] Updated UI with homeClub:', homeClub);

                    // Also update the form field if it exists
                    this.applyHomeClubToForm(profile.golfInfo?.homeClub);
                } catch (e) {
                    console.warn('[ProfileSystem] updateUIWithProfile error:', e);
                    // Continue gracefully, just don't update UI
                }
            },

            applyHomeClubToForm(slug) {
                if (!slug) return;

                // Target the profile modal specifically
                const el = document.querySelector('#profileModal #homeClub') ||
                          document.querySelector('#homeClub, #homeCourse, [name="homeClub"], [name="homeCourse"]');
                if (!el) return;

                const opts = Array.from(el.options || []);
                const byValue = opts.find(o => (o.value || '').trim() === slug);
                const byData  = opts.find(o => (o.dataset.courseId || o.dataset.value || '').trim() === slug);
                const pick = byValue || byData;
                if (pick) {
                    el.value = pick.value; // select it
                    console.log('[ProfileSystem] Applied homeClub to form:', slug, '-> option value:', pick.value, 'in modal:', !!el.closest('#profileModal'));
                } else {
                    console.log('[ProfileSystem] Could not find matching option for homeClub:', slug, 'in element:', el.id);
                }
            },

            // Wait for dropdown options to load
            waitForOptions(selector, min = 2) {
                return new Promise(resolve => {
                    const el = document.querySelector(selector);
                    if (el && el.options && el.options.length >= min) return resolve();
                    const obs = new MutationObserver(() => {
                        if (el && el.options && el.options.length >= min) {
                            obs.disconnect();
                            resolve();
                        }
                    });
                    obs.observe(el || document.body, { childList: true, subtree: true });
                    // Timeout after 3 seconds
                    setTimeout(() => { obs.disconnect(); resolve(); }, 3000);
                });
            },

            async showProfileModal() {
                const userType = AppState.currentUser.role;

                // Show modal immediately with loading state
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.id = 'profileModal';
                modal.onclick = (e) => {
                    if (e.target === modal) this.closeProfileModal();
                };

                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-screen overflow-hidden">
                        <div class="flex items-center justify-between p-6 border-b border-gray-200">
                            <h3 class="text-2xl font-bold text-gray-900">My Profile</h3>
                            <button onclick="ProfileSystem.closeProfileModal()" class="text-gray-400 hover:text-gray-600">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>

                        <div class="overflow-y-auto" style="max-height: calc(100vh - 200px);">
                            <div class="p-6 text-center">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mb-2"></div>
                                <p class="text-gray-600">Loading profile...</p>
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 p-4 md:p-6 border-t border-gray-200 bg-gray-50">
                            <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                                <button onclick="ProfileSystem.closeProfileModal()"
                                        class="px-4 py-2 md:px-6 md:py-3 bg-gray-300 text-gray-700 rounded-xl font-semibold hover:bg-gray-400 transition-colors text-sm md:text-base">
                                    Cancel
                                </button>
                                <button onclick="ProfileSystem.resetToDefaults('${userType}')"
                                        class="px-4 py-2 md:px-6 md:py-3 bg-orange-600 text-white rounded-xl font-semibold hover:bg-orange-700 transition-colors text-sm md:text-base">
                                    Reset to Defaults
                                </button>
                                <button onclick="ProfileSystem.deleteProfile('${userType}')"
                                        class="px-4 py-2 md:px-6 md:py-3 bg-red-600 text-white rounded-xl font-semibold hover:bg-red-700 transition-colors text-sm md:text-base">
                                    <span class="material-symbols-outlined text-sm mr-1">delete</span>
                                    Delete Profile
                                </button>
                            </div>
                            <button id="saveProfileButton" onclick="ProfileSystem.saveProfileFromForm('${userType}')"
                                    class="px-6 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition-colors text-base shadow-lg"
                                    style="min-width: 150px; display: block !important; visibility: visible !important;">
                                <span class="material-symbols-outlined text-sm mr-1">save</span>
                                Save Profile
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                window.currentProfileModal = modal;

                // Load profile data in background and update modal
                setTimeout(async () => {
                    try {
                        console.log('[ProfileSystem] 🔄 Loading profile for userType:', userType);

                        // Check authorization in background
                        console.log('[ProfileSystem] Checking edit permissions...');
                        const canEdit = await this.canEditProfile();
                        console.log('[ProfileSystem] Can edit:', canEdit);

                        if (!canEdit) {
                            this.closeProfileModal();
                            alert('❌ You do not have permission to edit this profile.');
                            return;
                        }

                        // Load profile data
                        console.log('[ProfileSystem] Getting current profile...');
                        const profile = this.getCurrentProfile(userType);
                        console.log('[ProfileSystem] Profile loaded:', profile);

                        // Update modal content with actual form
                        console.log('[ProfileSystem] Generating profile form...');
                        const contentDiv = modal.querySelector('.overflow-y-auto > div');
                        if (contentDiv) {
                            contentDiv.innerHTML = this.generateProfileForm(userType, profile);
                            console.log('[ProfileSystem] ✅ Profile form rendered');
                        } else {
                            console.warn('[ProfileSystem] ⚠️ Content div not found');
                        }

                        // Debug: Check if save button exists
                        const saveButton = document.getElementById('saveProfileButton');
                        console.log('[ProfileSystem] 🔍 Save button exists (by ID):', !!saveButton);
                        if (saveButton) {
                            console.log('[ProfileSystem] Save button text:', saveButton.textContent.trim());
                            console.log('[ProfileSystem] Save button display:', window.getComputedStyle(saveButton).display);
                            console.log('[ProfileSystem] Save button visibility:', window.getComputedStyle(saveButton).visibility);
                            console.log('[ProfileSystem] Save button offsetParent:', saveButton.offsetParent);
                            console.log('[ProfileSystem] Save button in viewport:', saveButton.getBoundingClientRect());
                        } else {
                            console.error('[ProfileSystem] ❌ Save button NOT FOUND in modal DOM!');
                            // Try alternate selector
                            const altButton = modal.querySelector('button[onclick*="saveProfileFromForm"]');
                            console.log('[ProfileSystem] Alternate selector found button:', !!altButton);
                        }

                        // Scroll to top
                        const scrollContainer = modal.querySelector('.overflow-y-auto');
                        if (scrollContainer) {
                            scrollContainer.scrollTop = 0;
                        }

                        // Wait for home course options to load
                        setTimeout(async () => {
                            try {
                                await this.waitForOptions('#homeClub, #homeCourse, [name="homeClub"], [name="homeCourse"]', 2);
                                if (profile.golfInfo?.homeClub) {
                                    this.applyHomeClubToForm(profile.golfInfo.homeClub);
                                }
                            } catch (error) {
                                console.log('[ProfileSystem] Options loading timeout');
                            }
                        }, 100);
                    } catch (error) {
                        console.error('[ProfileSystem] ❌ Error loading profile:', error);
                        console.error('[ProfileSystem] Error message:', error.message);
                        console.error('[ProfileSystem] Error stack:', error.stack);
                        this.closeProfileModal();
                        alert('Error loading profile. Please try again.');
                    }
                }, 10);
            },

            closeProfileModal() {
                try {
                    if (window.currentProfileModal) {
                        window.currentProfileModal.remove();
                        window.currentProfileModal = null;
                    }
                    // Fallback - remove any profile modals
                    document.querySelectorAll('#profileModal').forEach(modal => modal.remove());
                } catch (error) {
                    console.error('Error closing profile modal:', error);
                }
            },

            generateProfileForm(userType, profile) {
                switch(userType) {
                    case 'golfer':
                    case 'guest':
                        return this.generateGolferForm(profile);
                    case 'caddie':
                    case 'caddymaster':
                        return this.generateCaddyForm(profile);
                    case 'manager':
                    case 'maintenance':
                    case 'restaurant':
                        return this.generateManagerForm(profile);
                    case 'proshop':
                        return this.generateProshopForm(profile);
                    case 'society':
                    case 'society_organizer':
                        return this.generateSocietyForm(profile);
                    default:
                        // Default to golfer form for unknown types
                        console.warn('[ProfileSystem] Unknown profile type:', userType, '- using golfer form');
                        return this.generateGolferForm(profile);
                }
            },

            generateGolferForm(profile) {
                return `
                    <div class="space-y-8">
                        <!-- Photo Upload Section -->
                        <div class="text-center">
                            <div class="relative inline-block">
                                <img id="profilePhotoPreview" src="${profile.media?.profilePhoto || profile.linePictureUrl || AppState.currentUser?.avatar || '/api/placeholder/120/120'}"
                                     class="w-24 h-24 rounded-full object-cover border-4 border-primary-200"
                                     alt="Profile Photo"
                                     style="cursor: pointer;"
                                     onclick="console.log('[ProfileSystem] 📸 Photo clicked!'); document.getElementById('profilePhotoInput').click();">
                                <input type="file" id="profilePhotoInput" accept="image/*" class="hidden"
                                       onchange="console.log('[ProfileSystem] 📁 File selected:', this.files[0]?.name); ProfileSystem.handlePhotoUpload(this, 'profilePhotoPreview')">
                                <button id="photoUploadButton"
                                        onclick="console.log('[ProfileSystem] 📸 Camera button clicked!'); const input = document.getElementById('profilePhotoInput'); console.log('[ProfileSystem] Input element:', input); if(input) input.click(); else console.error('[ProfileSystem] ❌ Input element not found!');"
                                        class="absolute bottom-0 right-0 bg-primary-600 text-white rounded-full p-2 hover:bg-primary-700"
                                        style="cursor: pointer; z-index: 10;">
                                    <span class="material-symbols-outlined text-sm">camera_alt</span>
                                </button>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">Click camera button or photo to upload</p>
                        </div>

                        <!-- Personal Information -->
                        <div class="bg-gray-50 rounded-xl p-6">
                            <h4 class="text-lg font-bold text-gray-900 mb-4">Personal Information</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                    <div class="relative">
                                        <input type="text" id="profileUsername" value="${profile.personalInfo?.username || profile.username || ''}"
                                               class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500"
                                               placeholder="Choose username"
                                               pattern="[a-zA-Z0-9_]+"
                                               oninput="checkUsernameAvailabilityInModal(this.value)">
                                        <div id="usernameStatusModal" class="absolute right-3 top-3"></div>
                                    </div>
                                    <p id="usernameMessageModal" class="text-xs mt-1 text-gray-600">
                                        Letters, numbers, underscore only (a-z, 0-9, _)
                                    </p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                                    <input type="text" id="profileFirstName" value="${profile.personalInfo?.firstName || profile.firstName || ''}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                                    <input type="text" id="profileLastName" value="${profile.personalInfo?.lastName || profile.lastName || ''}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nickname</label>
                                    <input type="text" id="nickname" value="${profile.personalInfo?.nickname || profile.nickname || ''}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nationality</label>
                                    <select id="nationality" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select nationality</option>
                                        <option value="Thai" ${(profile.personalInfo?.nationality || profile.nationality) === 'Thai' ? 'selected' : ''}>Thai</option>
                                        <option value="American" ${(profile.personalInfo?.nationality || profile.nationality) === 'American' ? 'selected' : ''}>American</option>
                                        <option value="British" ${(profile.personalInfo?.nationality || profile.nationality) === 'British' ? 'selected' : ''}>British</option>
                                        <option value="Japanese" ${(profile.personalInfo?.nationality || profile.nationality) === 'Japanese' ? 'selected' : ''}>Japanese</option>
                                        <option value="Korean" ${(profile.personalInfo?.nationality || profile.nationality) === 'Korean' ? 'selected' : ''}>Korean</option>
                                        <option value="Chinese" ${(profile.personalInfo?.nationality || profile.nationality) === 'Chinese' ? 'selected' : ''}>Chinese</option>
                                        <option value="Australian" ${(profile.personalInfo?.nationality || profile.nationality) === 'Australian' ? 'selected' : ''}>Australian</option>
                                        <option value="German" ${(profile.personalInfo?.nationality || profile.nationality) === 'German' ? 'selected' : ''}>German</option>
                                        <option value="Other" ${(profile.personalInfo?.nationality || profile.nationality) === 'Other' ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                    <input type="tel" id="phone" value="${profile.personalInfo?.phone || profile.phone || ''}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="email" value="${profile.personalInfo?.email || profile.email || ''}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                </div>
                            </div>
                        </div>

                        <!-- Golf Information -->
                        <div class="bg-green-50 rounded-xl p-6">
                            <h4 class="text-lg font-bold text-gray-900 mb-4">Golf Information</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Current Handicap</label>
                                    <input type="number" id="handicap" value="${profile.golfInfo?.handicap || profile.roleSpecific?.handicap || ''}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Member Since</label>
                                    <input type="date" id="memberSince" value="${profile.golfInfo?.memberSince || profile.roleSpecific?.memberSince || ''}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Home Course</label>
                                    <select id="homeClub" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select home course</option>
                                        <option value="Pattana Golf Resort & Spa" ${(profile.golfInfo?.homeClub || profile.roleSpecific?.homeClub) === 'Pattana Golf Resort & Spa' ? 'selected' : ''}>Pattana Golf Resort & Spa</option>
                                        <option value="Crystal Bay Golf Club" ${(profile.golfInfo?.homeClub || profile.roleSpecific?.homeClub) === 'Crystal Bay Golf Club' ? 'selected' : ''}>Crystal Bay Golf Club</option>
                                        <option value="Phoenix Gold Golf Club" ${(profile.golfInfo?.homeClub || profile.roleSpecific?.homeClub) === 'Phoenix Gold Golf Club' ? 'selected' : ''}>Phoenix Gold Golf Club</option>
                                        <option value="Pattaya Country Club" ${(profile.golfInfo?.homeClub || profile.roleSpecific?.homeClub) === 'Pattaya Country Club' ? 'selected' : ''}>Pattaya Country Club</option>
                                        <option value="Burapha Golf Club" ${(profile.golfInfo?.homeClub || profile.roleSpecific?.homeClub) === 'Burapha Golf Club' ? 'selected' : ''}>Burapha Golf Club</option>
                                        <option value="Siam Country Club" ${(profile.golfInfo?.homeClub || profile.roleSpecific?.homeClub) === 'Siam Country Club' ? 'selected' : ''}>Siam Country Club</option>
                                        <option value="Laem Chabang International Country Club" ${(profile.golfInfo?.homeClub || profile.roleSpecific?.homeClub) === 'Laem Chabang International Country Club' ? 'selected' : ''}>Laem Chabang International Country Club</option>
                                        <option value="Royal Garden Golf Club" ${(profile.golfInfo?.homeClub || profile.roleSpecific?.homeClub) === 'Royal Garden Golf Club' ? 'selected' : ''}>Royal Garden Golf Club</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Club Affiliation / Society</label>
                                    <select id="clubAffiliation" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select club affiliation</option>
                                        <option value="Travellers Rest Group" ${(profile.golfInfo?.clubAffiliation || profile.roleSpecific?.clubAffiliation) === 'Travellers Rest Group' ? 'selected' : ''}>Travellers Rest Group</option>
                                        <option value="Pattaya Sports Club" ${(profile.golfInfo?.clubAffiliation || profile.roleSpecific?.clubAffiliation) === 'Pattaya Sports Club' ? 'selected' : ''}>Pattaya Sports Club</option>
                                        <option value="Bunker Boys" ${(profile.golfInfo?.clubAffiliation || profile.roleSpecific?.clubAffiliation) === 'Bunker Boys' ? 'selected' : ''}>Bunker Boys</option>
                                        <option value="Diego Dubbi Golf" ${(profile.golfInfo?.clubAffiliation || profile.roleSpecific?.clubAffiliation) === 'Diego Dubbi Golf' ? 'selected' : ''}>Diego Dubbi Golf</option>
                                        <option value="Independent" ${(profile.golfInfo?.clubAffiliation || profile.roleSpecific?.clubAffiliation) === 'Independent' ? 'selected' : ''}>Independent (No Affiliation)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Experience Level</label>
                                    <select id="experienceLevel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select experience</option>
                                        <option value="Beginner" ${(profile.golfInfo?.experienceLevel || profile.roleSpecific?.experienceLevel) === 'Beginner' ? 'selected' : ''}>Beginner (0-2 years)</option>
                                        <option value="Intermediate" ${(profile.golfInfo?.experienceLevel || profile.roleSpecific?.experienceLevel) === 'Intermediate' ? 'selected' : ''}>Intermediate (3-10 years)</option>
                                        <option value="Advanced" ${(profile.golfInfo?.experienceLevel || profile.roleSpecific?.experienceLevel) === 'Advanced' ? 'selected' : ''}>Advanced (10+ years)</option>
                                        <option value="Professional" ${(profile.golfInfo?.experienceLevel || profile.roleSpecific?.experienceLevel) === 'Professional' ? 'selected' : ''}>Professional</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Playing Style</label>
                                    <textarea id="playingStyle" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">${profile.golfInfo?.playingStyle || profile.roleSpecific?.playingStyle || ''}</textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Golf Goals</label>
                                    <textarea id="golfGoals" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">${profile.golfInfo?.golfGoals || profile.roleSpecific?.golfGoals || ''}</textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Preferences -->
                        <div class="bg-blue-50 rounded-xl p-6">
                            <h4 class="text-lg font-bold text-gray-900 mb-4">Preferences</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Tee Time</label>
                                    <select id="preferredTeeTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">No preference</option>
                                        <option value="Early Morning" ${(profile.preferences?.preferredTeeTime || profile.roleSpecific?.preferredTeeTime) === 'Early Morning' ? 'selected' : ''}>Early Morning (6:00-8:00)</option>
                                        <option value="Morning" ${(profile.preferences?.preferredTeeTime || profile.roleSpecific?.preferredTeeTime) === 'Morning' ? 'selected' : ''}>Morning (8:00-11:00)</option>
                                        <option value="Afternoon" ${(profile.preferences?.preferredTeeTime || profile.roleSpecific?.preferredTeeTime) === 'Afternoon' ? 'selected' : ''}>Afternoon (11:00-15:00)</option>
                                        <option value="Late Afternoon" ${(profile.preferences?.preferredTeeTime || profile.roleSpecific?.preferredTeeTime) === 'Late Afternoon' ? 'selected' : ''}>Late Afternoon (15:00-18:00)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Caddy Type</label>
                                    <select id="preferredCaddyType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">No preference</option>
                                        <option value="Professional" ${(profile.preferences?.preferredCaddyType || profile.roleSpecific?.preferredCaddyType) === 'Professional' ? 'selected' : ''}>Professional & Strategic</option>
                                        <option value="Friendly" ${(profile.preferences?.preferredCaddyType || profile.roleSpecific?.preferredCaddyType) === 'Friendly' ? 'selected' : ''}>Friendly & Encouraging</option>
                                        <option value="Quiet" ${(profile.preferences?.preferredCaddyType || profile.roleSpecific?.preferredCaddyType) === 'Quiet' ? 'selected' : ''}>Quiet & Focused</option>
                                        <option value="Teaching" ${(profile.preferences?.preferredCaddyType || profile.roleSpecific?.preferredCaddyType) === 'Teaching' ? 'selected' : ''}>Teaching & Instructional</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Communication Language</label>
                                    <select id="communicationLanguage" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                        <option value="English" ${(profile.preferences?.communicationLanguage || profile.roleSpecific?.communicationLanguage) === 'English' ? 'selected' : ''}>English</option>
                                        <option value="Thai" ${(profile.preferences?.communicationLanguage || profile.roleSpecific?.communicationLanguage) === 'Thai' ? 'selected' : ''}>Thai</option>
                                        <option value="Japanese" ${(profile.preferences?.communicationLanguage || profile.roleSpecific?.communicationLanguage) === 'Japanese' ? 'selected' : ''}>Japanese</option>
                                        <option value="Korean" ${(profile.preferences?.communicationLanguage || profile.roleSpecific?.communicationLanguage) === 'Korean' ? 'selected' : ''}>Korean</option>
                                        <option value="Chinese" ${(profile.preferences?.communicationLanguage || profile.roleSpecific?.communicationLanguage) === 'Chinese' ? 'selected' : ''}>Chinese</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" id="notifications" ${profile.preferences?.notifications || profile.roleSpecific?.notifications ? 'checked' : ''}
                                               class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                        <span class="text-sm font-medium text-gray-700">Enable notifications</span>
                                    </label>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Dietary Restrictions / Special Requests</label>
                                    <textarea id="dietaryRestrictions" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">${profile.preferences?.dietaryRestrictions || profile.roleSpecific?.dietaryRestrictions || ''}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            generateSocietyForm(profile) {
                return `
                    <div class="space-y-8">
                        <!-- Logo Upload Section -->
                        <div class="text-center">
                            <div class="relative inline-block">
                                <img id="profilePhotoPreview" src="${profile.media.societyLogo || '/api/placeholder/120/120'}"
                                     class="w-24 h-24 rounded-lg object-cover border-4 border-primary-200"
                                     alt="Society Logo">
                                <input type="file" id="profilePhotoInput" accept="image/*" class="hidden"
                                       onchange="ProfileSystem.handlePhotoUpload(this, 'profilePhotoPreview')">
                                <button onclick="document.getElementById('profilePhotoInput').click()"
                                        class="absolute bottom-0 right-0 bg-primary-600 text-white rounded-full p-2 hover:bg-primary-700">
                                    <span class="material-symbols-outlined text-sm">camera_alt</span>
                                </button>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">Click to upload society logo</p>
                        </div>

                        <!-- Organization Information -->
                        <div class="bg-gray-50 rounded-xl p-6">
                            <h4 class="text-lg font-bold text-gray-900 mb-4">Organization Information</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Society Name</label>
                                    <input type="text" id="societyName" value="${profile.organizationInfo.societyName}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Organizer Name</label>
                                    <input type="text" id="organizerName" value="${profile.organizationInfo.organizerName}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Title/Position</label>
                                    <input type="text" id="title" value="${profile.organizationInfo.title}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Established Date</label>
                                    <input type="date" id="establishedDate" value="${profile.organizationInfo.establishedDate}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Member Count</label>
                                    <input type="number" id="memberCount" value="${profile.organizationInfo.memberCount}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                    <input type="tel" id="phone" value="${profile.organizationInfo.phone}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="email" value="${profile.organizationInfo.email}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Website</label>
                                    <input type="url" id="website" value="${profile.organizationInfo.website}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                </div>
                            </div>
                        </div>

                        <!-- Golf Information -->
                        <div class="bg-green-50 rounded-xl p-6">
                            <h4 class="text-lg font-bold text-gray-900 mb-4">Golf Society Details</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Society Type</label>
                                    <select id="societyType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select type</option>
                                        <option value="Corporate" ${profile.golfInfo.societyType === 'Corporate' ? 'selected' : ''}>Corporate</option>
                                        <option value="Social Club" ${profile.golfInfo.societyType === 'Social Club' ? 'selected' : ''}>Social Club</option>
                                        <option value="Amateur League" ${profile.golfInfo.societyType === 'Amateur League' ? 'selected' : ''}>Amateur League</option>
                                        <option value="Professional" ${profile.golfInfo.societyType === 'Professional' ? 'selected' : ''}>Professional</option>
                                        <option value="Charity" ${profile.golfInfo.societyType === 'Charity' ? 'selected' : ''}>Charity Organization</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Playing Level</label>
                                    <select id="playingLevel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select level</option>
                                        <option value="Beginner" ${profile.golfInfo.playingLevel === 'Beginner' ? 'selected' : ''}>Beginner (25+ handicap)</option>
                                        <option value="Intermediate" ${profile.golfInfo.playingLevel === 'Intermediate' ? 'selected' : ''}>Intermediate (10-25 handicap)</option>
                                        <option value="Advanced" ${profile.golfInfo.playingLevel === 'Advanced' ? 'selected' : ''}>Advanced (0-10 handicap)</option>
                                        <option value="Mixed" ${profile.golfInfo.playingLevel === 'Mixed' ? 'selected' : ''}>Mixed levels</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Meeting Frequency</label>
                                    <select id="meetingFrequency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select frequency</option>
                                        <option value="Weekly" ${profile.golfInfo.meetingFrequency === 'Weekly' ? 'selected' : ''}>Weekly</option>
                                        <option value="Bi-weekly" ${profile.golfInfo.meetingFrequency === 'Bi-weekly' ? 'selected' : ''}>Bi-weekly</option>
                                        <option value="Monthly" ${profile.golfInfo.meetingFrequency === 'Monthly' ? 'selected' : ''}>Monthly</option>
                                        <option value="Quarterly" ${profile.golfInfo.meetingFrequency === 'Quarterly' ? 'selected' : ''}>Quarterly</option>
                                        <option value="Special Events" ${profile.golfInfo.meetingFrequency === 'Special Events' ? 'selected' : ''}>Special Events Only</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Typical Group Size</label>
                                    <select id="groupSize" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select size</option>
                                        <option value="Small (4-12)" ${profile.preferences.groupSize === 'Small (4-12)' ? 'selected' : ''}>Small (4-12 people)</option>
                                        <option value="Medium (12-24)" ${profile.preferences.groupSize === 'Medium (12-24)' ? 'selected' : ''}>Medium (12-24 people)</option>
                                        <option value="Large (24-48)" ${profile.preferences.groupSize === 'Large (24-48)' ? 'selected' : ''}>Large (24-48 people)</option>
                                        <option value="Very Large (48+)" ${profile.preferences.groupSize === 'Very Large (48+)' ? 'selected' : ''}>Very Large (48+ people)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Preferences -->
                        <div class="bg-blue-50 rounded-xl p-6">
                            <h4 class="text-lg font-bold text-gray-900 mb-4">Event Preferences</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Budget Range</label>
                                    <select id="budgetRange" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select budget</option>
                                        <option value="Budget (฿1,000-2,500)" ${profile.preferences.budgetRange === 'Budget (฿1,000-2,500)' ? 'selected' : ''}>Budget (฿1,000-2,500 per person)</option>
                                        <option value="Standard (฿2,500-5,000)" ${profile.preferences.budgetRange === 'Standard (฿2,500-5,000)' ? 'selected' : ''}>Standard (฿2,500-5,000 per person)</option>
                                        <option value="Premium (฿5,000-10,000)" ${profile.preferences.budgetRange === 'Premium (฿5,000-10,000)' ? 'selected' : ''}>Premium (฿5,000-10,000 per person)</option>
                                        <option value="Luxury (฿10,000+)" ${profile.preferences.budgetRange === 'Luxury (฿10,000+)' ? 'selected' : ''}>Luxury (฿10,000+ per person)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Communication Method</label>
                                    <select id="communicationMethod" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                                        <option value="Line" ${profile.preferences.communicationMethod === 'Line' ? 'selected' : ''}>Line</option>
                                        <option value="WhatsApp" ${profile.preferences.communicationMethod === 'WhatsApp' ? 'selected' : ''}>WhatsApp</option>
                                        <option value="Email" ${profile.preferences.communicationMethod === 'Email' ? 'selected' : ''}>Email</option>
                                        <option value="Phone" ${profile.preferences.communicationMethod === 'Phone' ? 'selected' : ''}>Phone</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Catering Needs</label>
                                    <textarea id="cateringNeeds" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">${profile.preferences.cateringNeeds}</textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Special Requirements</label>
                                    <textarea id="specialRequirements" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">${profile.preferences.specialRequirements}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            updateDashboardData() {
                try {
                    console.log('[ProfileSystem] updateDashboardData called - Current user:', {
                        name: AppState.currentUser?.name,
                        role: AppState.currentUser?.role
                    });

                    // Update all UI elements with current user data
                    UserInterface.updateUserDisplays();
                    UserInterface.updateRoleSpecificDisplays();

                    // Get current profile - DON'T use fallbacks to avoid overwriting real data
                    const profile = this.getCurrentProfile(AppState.currentUser.role);
                    if (!profile) {
                        console.warn('[ProfileSystem] No profile found for updateDashboardData');
                        return;
                    }

                    console.log('[ProfileSystem] updateDashboardData using profile:', {
                        handicap: profile.golfInfo?.handicap,
                        homeClub: profile.golfInfo?.homeClub,
                        clubAffiliation: profile.golfInfo?.clubAffiliation,
                        isMobile: window.innerWidth < 768
                    });

                    // Debug panel removed - unique ID system working correctly

                    // Update handicap ONLY if it exists in profile
                    if (profile.golfInfo?.handicap !== undefined && profile.golfInfo?.handicap !== null && profile.golfInfo?.handicap !== '') {
                        const handicap = profile.golfInfo.handicap;
                        AppState.currentUser.handicap = handicap;
                        const handicapElements = document.querySelectorAll('.user-handicap');
                        console.log('[ProfileSystem] Updating handicap to:', handicap, 'on', handicapElements.length, 'elements');
                        handicapElements.forEach(el => {
                            el.textContent = handicap;
                        });
                    }

                    // Update member since displays (show current year if empty)
                    const memberSince = profile.golfInfo?.memberSince || new Date().toISOString().split('T')[0];
                    document.querySelectorAll('.member-since').forEach(el => {
                        const year = new Date(memberSince).getFullYear();
                        el.textContent = year || new Date().getFullYear();
                    });

                    // Update home club ONLY if it exists in profile
                    if (profile.golfInfo?.homeClub !== undefined && profile.golfInfo?.homeClub !== null && profile.golfInfo?.homeClub !== '') {
                        const homeClub = profile.golfInfo.homeClub;
                        const homeClubElements = document.querySelectorAll('.home-club');
                        console.log('[ProfileSystem] Updating home club to:', homeClub, 'on', homeClubElements.length, 'elements');
                        homeClubElements.forEach(el => {
                            el.textContent = homeClub;
                        });
                    }

                    // Update club affiliation displays
                    const clubAffiliation = profile.golfInfo?.clubAffiliation;
                    const affiliationContainers = document.querySelectorAll('.club-affiliation-container, .club-affiliation-stats-container');
                    const affiliationElements = document.querySelectorAll('.club-affiliation');

                    console.log('[ProfileSystem] Updating club affiliation:', clubAffiliation, 'on', affiliationElements.length, 'elements');

                    if (clubAffiliation && clubAffiliation !== '') {
                        affiliationElements.forEach(el => {
                            el.textContent = clubAffiliation;
                        });
                        affiliationContainers.forEach(container => {
                            container.style.display = 'flex';
                        });
                    } else {
                        affiliationContainers.forEach(container => {
                            container.style.display = 'none';
                        });
                    }

                    // Update experience level displays (show default if empty)
                    const experienceLevel = profile.golfInfo?.experienceLevel || 'Intermediate';
                    document.querySelectorAll('.experience-level').forEach(el => {
                        el.textContent = experienceLevel;
                    });

                    // Update profile photo if available
                    if (profile.media?.profilePhoto) {
                        document.querySelectorAll('.user-avatar').forEach(el => {
                            el.src = profile.media.profilePhoto;
                            el.style.display = 'block';
                        });
                    }

                    console.log('[ProfileSystem] Dashboard data updated successfully with profile:', {
                        handicap: profile.golfInfo?.handicap || 'not set',
                        homeClub: profile.golfInfo?.homeClub || 'not set',
                        experienceLevel: profile.golfInfo?.experienceLevel || 'not set',
                        memberSince: new Date(memberSince).getFullYear()
                    });
                } catch (error) {
                    console.error('Error updating dashboard data:', error);
                }
            },

            // Initialize dashboard with profile data on load
            initializeDashboard() {
                // Multiple attempts to ensure data loads on both mobile and desktop
                setTimeout(() => {
                    this.updateDashboardData();
                }, 100);
                setTimeout(() => {
                    this.updateDashboardData();
                }, 500);
                setTimeout(() => {
                    this.updateDashboardData();
                }, 1000);
            },

            resetToDefaults(userType) {
                if (confirm('Are you sure you want to reset your profile to default values? This will clear all your current information.')) {
                    // Clear the saved profile using UNIQUE ID
                    const uniqueId = UserIDSystem.getUserUniqueID(AppState.currentUser);
                    const profileKey = UserIDSystem.getProfileKey(userType, uniqueId);
                    localStorage.removeItem(profileKey);

                    // Close and reopen the modal with fresh defaults
                    this.closeProfileModal();
                    setTimeout(() => {
                        this.showProfileModal();
                    }, 100);

                    console.log('Profile reset to defaults');
                }
            },

            async deleteProfile(userType) {
                // SECURITY: Check authorization
                const canEdit = await this.canEditProfile();
                if (!canEdit) {
                    alert('❌ You do not have permission to delete this profile.');
                    return;
                }

                if (!confirm('⚠️ WARNING: This will permanently delete your profile from both local storage and the cloud database. This action cannot be undone.\n\nAre you absolutely sure you want to delete your profile?')) {
                    return;
                }

                try {
                    const username = AppState.currentUser.username;

                    // Delete from cloud if username exists
                    if (username) {
                        const response = await fetch(`/.netlify/functions/profiles?username=${encodeURIComponent(username)}`, {
                            method: 'DELETE'
                        });
                        const result = await response.json();

                        if (result.success) {
                            console.log('Profile deleted from cloud:', username);
                        } else {
                            console.warn('Cloud delete failed:', result.error);
                        }
                    }

                    // Delete from localStorage using UNIQUE ID
                    const uniqueId = UserIDSystem.getUserUniqueID(AppState.currentUser);
                    const profileKey = UserIDSystem.getProfileKey(userType, uniqueId);
                    localStorage.removeItem(profileKey);

                    // Also remove from user profiles list
                    const existingProfiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');
                    const updatedProfiles = existingProfiles.filter(p => p.username !== username);
                    localStorage.setItem('mcipro_user_profiles', JSON.stringify(updatedProfiles));

                    NotificationManager.show('Profile deleted successfully', 'success');

                    // Close modal and redirect to login
                    this.closeProfileModal();
                    setTimeout(() => {
                        ScreenManager.showScreen('loginScreen');
                    }, 500);

                } catch (error) {
                    console.error('Error deleting profile:', error);
                    NotificationManager.show('Error deleting profile. Please try again.', 'error');
                }
            },

            handlePhotoUpload(input, previewId) {
                const file = input.files[0];
                if (file) {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please select a valid image file.');
                        input.value = '';
                        return;
                    }

                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Please select an image smaller than 5MB.');
                        input.value = '';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById(previewId);
                        if (preview) {
                            preview.src = e.target.result;
                            console.log('Profile photo uploaded successfully');
                        }
                    };
                    reader.onerror = function() {
                        alert('Error reading the image file. Please try again.');
                    };
                    reader.readAsDataURL(file);
                }
            },

            async saveProfileFromForm(userType) {
                console.log('[ProfileSystem] 💾 Save Profile button clicked! UserType:', userType);
                const profile = this.getCurrentProfile(userType);
                console.log('[ProfileSystem] Current profile:', profile);

                // Cache LINE profile once at the start (single API call)
                let linePictureUrl = AppState.currentUser?.avatar || profile.linePictureUrl || '';
                try {
                    if (typeof liff !== 'undefined' && liff.isLoggedIn && liff.isLoggedIn()) {
                        const lineProfile = await liff.getProfile();
                        if (!profile.lineUserId) {
                            profile.lineUserId = lineProfile.userId;
                        }
                        linePictureUrl = lineProfile.pictureUrl || linePictureUrl;
                    }
                } catch (e) {
                    console.warn('[ProfileSystem] saveProfile LIFF check failed:', e.message);
                }

                try {
                    if (userType === 'golfer') {
                        // Get current form values
                        const firstNameEl = document.getElementById('profileFirstName');
                        const lastNameEl = document.getElementById('profileLastName');

                        const firstName = firstNameEl?.value?.trim() || '';
                        const lastName = lastNameEl?.value?.trim() || '';

                        // Check names
                        const hasFirstName = firstName || profile.personalInfo?.firstName || profile.firstName;
                        const hasLastName = lastName || profile.personalInfo?.lastName || profile.lastName;

                        if (!hasFirstName || !hasLastName) {
                            alert('ERROR: Missing first or last name.\n\nFirst Name: "' + (firstName || 'EMPTY') + '"\nLast Name: "' + (lastName || 'EMPTY') + '"');
                            return;
                        }

                        // Ensure profile objects exist
                        if (!profile.golfInfo) profile.golfInfo = {};
                        if (!profile.roleSpecific) profile.roleSpecific = {};
                        if (!profile.personalInfo) profile.personalInfo = {};
                        if (!profile.preferences) profile.preferences = {};
                        if (!profile.media) profile.media = {};

                        // Username (can be changed)
                        const usernameInput = document.getElementById('profileUsername');
                        if (usernameInput) {
                            const newUsername = usernameInput.value?.trim();
                            if (newUsername) {
                                profile.personalInfo.username = newUsername;
                                profile.username = newUsername;
                                AppState.currentUser.username = newUsername;
                            }
                        }

                        // Personal Info - save in BOTH formats (nested and root) for compatibility
                        const savedFirstName = firstName || profile.personalInfo?.firstName || profile.firstName || '';
                        const savedLastName = lastName || profile.personalInfo?.lastName || profile.lastName || '';
                        const savedNickname = document.getElementById('nickname')?.value?.trim() || profile.personalInfo?.nickname || profile.nickname || '';
                        const savedNationality = document.getElementById('nationality')?.value || profile.personalInfo?.nationality || profile.nationality || '';
                        const savedPhone = document.getElementById('phone')?.value?.trim() || profile.personalInfo?.phone || profile.phone || '';
                        const savedEmail = document.getElementById('email')?.value?.trim() || profile.personalInfo?.email || profile.email || '';

                        // Save in nested format (old)
                        profile.personalInfo.firstName = savedFirstName;
                        profile.personalInfo.lastName = savedLastName;
                        profile.personalInfo.nickname = savedNickname;
                        profile.personalInfo.nationality = savedNationality;
                        profile.personalInfo.phone = savedPhone;
                        profile.personalInfo.email = savedEmail;

                        // Also save at root level (new format)
                        profile.firstName = savedFirstName;
                        profile.lastName = savedLastName;
                        profile.nickname = savedNickname;
                        profile.nationality = savedNationality;
                        profile.phone = savedPhone;
                        profile.email = savedEmail;

                        // Golf Info with validation
                        const handicap = document.getElementById('handicap')?.value?.trim() || '';
                        const memberSince = document.getElementById('memberSince')?.value || '';
                        // Strict home course extraction - only accepts real slugs, never placeholders
                        const PLACEHOLDER_TEXTS = new Set([
                            'Select your home course...', 'Select your home course', 'Select home course', 'Not Selected', '—'
                        ]);

                        function getHomeClubFromFormStrict() {
                            const el = document.querySelector('#profileModal #homeClub') ||
                                      document.querySelector('#homeClub, #homeCourse, [name="homeClub"], [name="homeCourse"]');

                            if (!el || el.selectedIndex === 0) return '';

                            const opt  = el.selectedOptions && el.selectedOptions[0];
                            const val  = (opt?.value || '').trim();
                            const data = (opt?.dataset?.courseId || opt?.dataset?.value || '').trim();
                            const text = (opt?.textContent || '').trim();

                            if (PLACEHOLDER_TEXTS.has(text)) return '';

                            return val || data || '';
                        }

                        // Get home club from form OR preserve existing value
                        const homeClubFromForm = getHomeClubFromFormStrict();
                        const existingHomeClub = profile.golfInfo?.homeClub || profile.roleSpecific?.homeClub || '';
                        const homeClub = homeClubFromForm || existingHomeClub;

                        // Warn about missing home course but allow save
                        if (!homeClub && !existingHomeClub) {
                            const continueWithoutHome = confirm('WARNING: No home course selected.\n\nYou can add it later, but it\'s recommended to select one now.\n\nContinue saving without home course?');
                            if (!continueWithoutHome) return;
                        }

                        // Golf Info - save in both formats
                        const savedClubAffiliation = document.getElementById('clubAffiliation')?.value || profile.golfInfo.clubAffiliation || profile.roleSpecific.clubAffiliation || '';
                        const savedExperienceLevel = document.getElementById('experienceLevel')?.value || profile.golfInfo.experienceLevel || profile.roleSpecific.experienceLevel || '';
                        const savedPlayingStyle = document.getElementById('playingStyle')?.value?.trim() || profile.golfInfo.playingStyle || profile.roleSpecific.playingStyle || '';
                        const savedGolfGoals = document.getElementById('golfGoals')?.value?.trim() || profile.golfInfo.golfGoals || profile.roleSpecific.golfGoals || '';

                        profile.golfInfo.handicap = handicap;
                        profile.golfInfo.memberSince = memberSince;
                        profile.golfInfo.homeClub = homeClub;
                        profile.golfInfo.clubAffiliation = savedClubAffiliation;
                        profile.golfInfo.experienceLevel = savedExperienceLevel;
                        profile.golfInfo.playingStyle = savedPlayingStyle;
                        profile.golfInfo.golfGoals = savedGolfGoals;

                        profile.roleSpecific.handicap = handicap;
                        profile.roleSpecific.memberSince = memberSince;
                        profile.roleSpecific.homeClub = homeClub;
                        profile.roleSpecific.clubAffiliation = savedClubAffiliation;
                        profile.roleSpecific.experienceLevel = savedExperienceLevel;
                        profile.roleSpecific.playingStyle = savedPlayingStyle;
                        profile.roleSpecific.golfGoals = savedGolfGoals;

                        // Preferences - save in both formats
                        const savedPreferredTeeTime = document.getElementById('preferredTeeTime')?.value || profile.preferences?.preferredTeeTime || profile.roleSpecific?.preferredTeeTime || '';
                        const savedPreferredCaddyType = document.getElementById('preferredCaddyType')?.value || profile.preferences?.preferredCaddyType || profile.roleSpecific?.preferredCaddyType || '';
                        const savedCommunicationLanguage = document.getElementById('communicationLanguage')?.value || profile.preferences?.communicationLanguage || profile.roleSpecific?.communicationLanguage || '';
                        const savedNotifications = document.getElementById('notifications')?.checked || profile.preferences?.notifications || profile.roleSpecific?.notifications || false;
                        const savedDietaryRestrictions = document.getElementById('dietaryRestrictions')?.value || profile.preferences?.dietaryRestrictions || profile.roleSpecific?.dietaryRestrictions || '';

                        profile.preferences.preferredTeeTime = savedPreferredTeeTime;
                        profile.preferences.preferredCaddyType = savedPreferredCaddyType;
                        profile.preferences.communicationLanguage = savedCommunicationLanguage;
                        profile.preferences.notifications = savedNotifications;
                        profile.preferences.dietaryRestrictions = savedDietaryRestrictions;

                        // Also save in roleSpecific
                        profile.roleSpecific.preferredTeeTime = savedPreferredTeeTime;
                        profile.roleSpecific.preferredCaddyType = savedPreferredCaddyType;
                        profile.roleSpecific.communicationLanguage = savedCommunicationLanguage;
                        profile.roleSpecific.notifications = savedNotifications;
                        profile.roleSpecific.dietaryRestrictions = savedDietaryRestrictions;

                        // Update profile data in localStorage
                        const profilesArray = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');

                        // Find existing by username OR lineUserId OR name
                        const existingIndex = profilesArray.findIndex(p =>
                            (profile.personalInfo.username && p.username === profile.personalInfo.username) ||
                            (AppState.currentUser?.lineUserId && p.lineUserId === AppState.currentUser.lineUserId) ||
                            (p.name === `${profile.personalInfo.firstName} ${profile.personalInfo.lastName}`)
                        );

                        const profileForSync = {
                            // Identity
                            id: profile.id || `user_${profile.personalInfo.username}_${Date.now()}`,
                            username: profile.personalInfo.username || profile.username || '',
                            name: `${profile.personalInfo.firstName} ${profile.personalInfo.lastName}`,
                            role: 'golfer',

                            // LINE authentication
                            lineUserId: AppState.currentUser?.lineUserId || profile.lineUserId || '',
                            linePictureUrl: linePictureUrl,

                            // Nested structures
                            personalInfo: profile.personalInfo,
                            golfInfo: profile.golfInfo,
                            roleSpecific: profile.roleSpecific,
                            preferences: profile.preferences,
                            media: profile.media || {},

                            // Root-level fields (for compatibility)
                            firstName: profile.firstName,
                            lastName: profile.lastName,
                            nickname: profile.nickname,
                            nationality: profile.nationality,
                            phone: profile.phone,
                            email: profile.email,

                            // Timestamps
                            createdAt: profile.createdAt || new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                            timestamp: new Date().toISOString()
                        };

                        if (existingIndex >= 0) {
                            // Update existing profile (preserve createdAt)
                            profileForSync.createdAt = profilesArray[existingIndex].createdAt || profileForSync.createdAt;
                            profilesArray[existingIndex] = profileForSync;
                        } else {
                            profilesArray.push(profileForSync);
                        }

                        localStorage.setItem('mcipro_user_profiles', JSON.stringify(profilesArray));

                        // Media
                        const profilePhoto = document.getElementById('profilePhotoPreview')?.src;
                        if (profilePhoto && !profilePhoto.includes('/api/placeholder/')) {
                            profile.media.profilePhoto = profilePhoto;
                        }
                    } else if (userType === 'society') {
                        // Organization Info
                        profile.organizationInfo.societyName = document.getElementById('societyName')?.value || '';
                        profile.organizationInfo.organizerName = document.getElementById('organizerName')?.value || '';
                        profile.organizationInfo.title = document.getElementById('title')?.value || '';
                        profile.organizationInfo.establishedDate = document.getElementById('establishedDate')?.value || '';
                        profile.organizationInfo.memberCount = document.getElementById('memberCount')?.value || '';
                        profile.organizationInfo.phone = document.getElementById('phone')?.value || '';
                        profile.organizationInfo.email = document.getElementById('email')?.value || '';
                        profile.organizationInfo.website = document.getElementById('website')?.value || '';

                        // Golf Info
                        profile.golfInfo.societyType = document.getElementById('societyType')?.value || '';
                        profile.golfInfo.playingLevel = document.getElementById('playingLevel')?.value || '';
                        profile.golfInfo.meetingFrequency = document.getElementById('meetingFrequency')?.value || '';

                        // Preferences
                        profile.preferences.groupSize = document.getElementById('groupSize')?.value || '';
                        profile.preferences.budgetRange = document.getElementById('budgetRange')?.value || '';
                        profile.preferences.communicationMethod = document.getElementById('communicationMethod')?.value || '';
                        profile.preferences.cateringNeeds = document.getElementById('cateringNeeds')?.value || '';
                        profile.preferences.specialRequirements = document.getElementById('specialRequirements')?.value || '';

                        // Media
                        const societyLogo = document.getElementById('profilePhotoPreview')?.src;
                        if (societyLogo && !societyLogo.includes('/api/placeholder/')) {
                            profile.media.societyLogo = societyLogo;
                        }
                    }

                    // Save profile immediately to localStorage (fast)
                    console.log('[ProfileSystem] 📝 Saving profile to localStorage...');
                    this.saveProfile(userType, profile);
                    console.log('[ProfileSystem] ✅ Profile saved to localStorage');

                    // Close modal immediately
                    console.log('[ProfileSystem] Closing modal...');
                    this.closeProfileModal();
                    console.log('[ProfileSystem] ✅ Modal closed');

                    // Update dashboard data
                    console.log('[ProfileSystem] Updating dashboard data...');
                    this.updateDashboardData();
                    console.log('[ProfileSystem] ✅ Dashboard data updated');

                    // Show quick success message
                    const successModal = document.createElement('div');
                    successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    successModal.innerHTML = `
                        <div class="bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-2xl">
                            <div class="text-center">
                                <div class="text-5xl mb-3">✅</div>
                                <h3 class="text-xl font-bold text-gray-900 mb-1">Saved!</h3>
                                <p class="text-sm text-gray-600">Profile updated</p>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(successModal);

                    // Auto-dismiss after 1 second
                    setTimeout(() => {
                        if (successModal.parentNode) {
                            successModal.remove();
                        }
                    }, 1000);

                } catch (error) {
                    console.error('[ProfileSystem] ❌ Error saving profile:', error);
                    console.error('[ProfileSystem] Error message:', error.message);
                    console.error('[ProfileSystem] Error stack:', error.stack);
                    alert('Error saving profile: ' + error.message + '\n\nPlease check the console for details.');
                }
            }
        };

        // ===== SCHEDULE MANAGEMENT SYSTEM =====
        const ScheduleSystem = {
            scheduleData: {
                events: [],
                caddieBookings: [],
                waitlists: [],
                foodOrders: []
            },

            currentFilter: 'all',
            searchQuery: '',
            selectedBookings: [], // NEW: Multi-select for batch deletion

            initializeSchedule() {
                this.loadFromStorage();
                this.updateScheduleTab();
            },

            loadFromStorage() {
                try {
                    const savedSchedule = localStorage.getItem('mcipro_schedule');
                    if (savedSchedule) {
                        this.scheduleData = JSON.parse(savedSchedule);
                        console.log('[ScheduleSystem] Loaded schedule from localStorage');
                        return;
                    }
                } catch (error) {
                    console.error('[ScheduleSystem] Failed to load from localStorage:', error);
                }
                // Always start with empty schedule (no demo data)
                console.log('[ScheduleSystem] Starting with clean schedule (no demo data)');
                this.scheduleData = {
                    events: [],
                    caddieBookings: [],
                    waitlists: []
                };
                this.saveToStorage();
            },

            saveToStorage() {
                try {
                    localStorage.setItem('mcipro_schedule', JSON.stringify(this.scheduleData));
                    console.log('[ScheduleSystem] Saved schedule to localStorage');

                    // DEBOUNCED CLOUD SYNC after schedule changes
                    console.log('[ScheduleSystem] SCHEDULE CHANGED - SCHEDULING CLOUD SYNC');
                    SimpleCloudSync.saveToCloudSoon();
                    this.refreshStats();
                } catch (error) {
                    console.error('[ScheduleSystem] Failed to save to localStorage:', error);
                }
            },

            getList() {
                const raw = localStorage.getItem("mcipro_schedule") || "[]";
                const list = JSON.parse(raw);
                return Array.isArray(list) ? list : Object.values(list || {});
            },

            saveList(list) {
                // dedupe by id before saving
                const m = new Map();
                for (const e of list) if (e?.id) m.set(e.id, { ...(m.get(e.id) || {}), ...e });
                const out = [...m.values()];
                localStorage.setItem("mcipro_schedule", JSON.stringify(out));
                // kick the cloud sync & refresh counters
                console.log("[ScheduleSystem] SCHEDULE CHANGED - TRIGGERING CLOUD SYNC");
                SimpleCloudSync.saveToCloudSoon();
                this.refreshStats();
            },

            upsertFromBooking(bk) {
                const id = `sch_${bk.groupId}`;         // one event per round
                const list = this.getList();
                let evt = list.find(x => x.id === id);

                if (!evt) {
                    evt = {
                        id,
                        groupId: bk.groupId,
                        title: `Round at ${bk.courseName || bk.course}`,
                        start: bk.teeTime || bk.date,
                        courseId: bk.courseId || bk.course,
                        courseName: bk.courseName || bk.course,
                        status: "confirmed",
                        caddies: [],
                        services: [],
                        updatedAt: Date.now(),
                        type: "round"
                    };
                    list.push(evt);
                }

                // fold children into the one event
                if (bk.kind === "teeTime" || bk.type === "teeTime") {
                    evt.start = bk.teeTime || bk.date;
                    evt.players = bk.players ?? evt.players;
                    evt.status = bk.status ?? evt.status;
                } else if (bk.kind === "caddie" || bk.type === "caddie") {
                    if (!evt.caddies.some(c => c.id === bk.caddieId)) {
                        evt.caddies.push({ id: bk.caddieId, name: bk.caddieName });
                    }
                } else if (bk.kind === "service" || bk.type === "service") {
                    const serviceName = bk.service || bk.serviceName || "service";
                    if (!evt.services.includes(serviceName)) evt.services.push(serviceName);
                }

                evt.updatedAt = Date.now();
                this.saveList(list);
            },

            refreshStats() {
                // Stats counter removed - using detailed booking information instead
                console.log('[ScheduleSystem] refreshStats - stats counter removed');
            },

            loadSampleData() {
                // Sample events for demonstration
                this.scheduleData.events = [
                    {
                        id: 'event_001',
                        type: 'teeTime',
                        title: 'Round at Pattaya Golf Club',
                        date: new Date(Date.now() + 24 * 60 * 60 * 1000), // Tomorrow
                        time: '14:00',
                        duration: 240, // 4 hours
                        course: 'Pattaya Golf Club',
                        status: 'confirmed',
                        players: 1,
                        notes: 'Afternoon round',
                        canEdit: true,
                        canCancel: true
                    },
                    {
                        id: 'event_002',
                        type: 'tournament',
                        title: 'Monthly Club Championship',
                        date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // Next week
                        time: '08:00',
                        duration: 300, // 5 hours
                        course: 'Championship Course',
                        status: 'registered',
                        players: 4,
                        notes: 'Tournament entry fee paid',
                        canEdit: false,
                        canCancel: true
                    }
                ];

                this.scheduleData.caddieBookings = [
                    {
                        id: 'caddie_001',
                        type: 'caddieBooking',
                        title: 'Caddy: Ning (Professional)',
                        eventId: 'event_001',
                        caddieName: 'Ning',
                        caddieId: 'c002',
                        date: new Date(Date.now() + 24 * 60 * 60 * 1000),
                        time: '14:00',
                        status: 'confirmed',
                        rate: '฿1,200',
                        canEdit: true,
                        canCancel: true
                    }
                ];

                this.scheduleData.waitlists = [
                    {
                        id: 'waitlist_001',
                        type: 'waitlist',
                        title: 'Waitlist: Alex Chen (VIP)',
                        caddieName: 'Alex Chen',
                        caddieId: 'c001',
                        position: 2,
                        requestedDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000),
                        status: 'waiting',
                        canEdit: true,
                        canCancel: true
                    }
                ];
            },

            // Check if event exists for booking (idempotent)
            hasEventForBooking(bookingId) {
                return this.scheduleData.events.some(event =>
                    event.bookingId === bookingId
                );
            },

            // Add event only if it doesn't already exist for the booking
            addEventForBooking(eventData, bookingId) {
                if (this.hasEventForBooking(bookingId)) {
                    console.log('[ScheduleSystem] Event already exists for booking:', bookingId);
                    return null;
                }

                const event = {
                    id: 'event_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    bookingId: bookingId, // Link to booking
                    ...eventData,
                    createdAt: new Date()
                };
                this.scheduleData.events.push(event);
                this.saveToStorage();
                this.updateScheduleTab();
                console.log('[ScheduleSystem] Added event for booking:', bookingId, event.title);
                return event;
            },

            addEvent(eventData) {
                const event = {
                    id: 'event_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    ...eventData,
                    createdAt: new Date()
                };
                this.scheduleData.events.push(event);
                this.saveToStorage();
                this.updateScheduleTab();
                console.log('[ScheduleSystem] Added event:', event.title);
                return event;
            },

            addCaddyBooking(bookingData) {
                const booking = {
                    id: 'caddie_' + Date.now(),
                    type: 'caddieBooking',
                    ...bookingData,
                    createdAt: new Date()
                };
                this.scheduleData.caddieBookings.push(booking);
                this.saveToStorage();
                this.updateScheduleTab();
                console.log('[ScheduleSystem] Added caddie booking:', booking.caddieName);
                return booking;
            },

            addToWaitlist(waitlistData) {
                const waitlist = {
                    id: 'waitlist_' + Date.now(),
                    type: 'waitlist',
                    ...waitlistData,
                    createdAt: new Date()
                };
                this.scheduleData.waitlists.push(waitlist);
                this.saveToStorage();
                this.updateScheduleTab();
                console.log('[ScheduleSystem] Added waitlist entry:', waitlist.caddieName);
                return waitlist;
            },

            updateScheduleTab() {
                console.log('ScheduleSystem.updateScheduleTab called');
                console.log('Schedule data:', this.scheduleData);
                this.updateStats();
                this.renderScheduleList();
            },

            updateStats() {
                // Ensure all required arrays exist
                if (!this.scheduleData.events) this.scheduleData.events = [];
                if (!this.scheduleData.caddieBookings) this.scheduleData.caddieBookings = [];
                if (!this.scheduleData.waitlists) this.scheduleData.waitlists = [];

                const now = new Date();
                const thisWeekEnd = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

                const upcomingEvents = this.scheduleData.events.filter(e => new Date(e.date) > now).length;
                const confirmedCaddys = this.scheduleData.caddieBookings.filter(c => c.status === 'confirmed').length;
                const waitlistCount = this.scheduleData.waitlists.length;
                const thisWeekEvents = this.scheduleData.events.filter(e => {
                    const eventDate = new Date(e.date);
                    return eventDate > now && eventDate <= thisWeekEnd;
                }).length;

                const upcomingEl = document.getElementById('upcomingEventsCount');
                const caddysEl = document.getElementById('confirmedCaddysCount');
                const waitlistEl = document.getElementById('waitlistCount');

                if (upcomingEl) upcomingEl.textContent = upcomingEvents;
                if (caddysEl) caddysEl.textContent = confirmedCaddys;
                if (waitlistEl) waitlistEl.textContent = waitlistCount;

                const thisWeekEl = document.getElementById('thisWeekCount');
                if (thisWeekEl) thisWeekEl.textContent = thisWeekEvents;
            },

            renderScheduleList() {
                console.log('ScheduleSystem.renderScheduleList called');
                const container = document.getElementById('scheduleList');
                const emptyState = document.getElementById('emptySchedule');

                if (!container) {
                    console.error('scheduleList container not found!');
                    return;
                }

                // CRITICAL FIX: Render from bookings directly (single source of truth)
                // Load from localStorage if BookingManager.bookings is empty
                let bookings = BookingManager.bookings || [];
                if (bookings.length === 0) {
                    const savedBookings = localStorage.getItem('mcipro_bookings');
                    if (savedBookings) {
                        bookings = JSON.parse(savedBookings);
                        BookingManager.bookings = bookings;
                        console.log('[renderScheduleList] Loaded', bookings.length, 'bookings from localStorage');
                    }
                }

                // CRITICAL: Filter out deleted bookings FIRST
                let activeBookings = bookings.filter(b => !b.deleted);

                // FIXED: Filter by current user for golfer dashboard
                const currentUserRole = (window.AppState && window.AppState.currentUser && window.AppState.currentUser.role) || 'golfer';
                const currentUserName = (window.AppState && window.AppState.currentUser && window.AppState.currentUser.name) || '';

                if (currentUserRole === 'golfer' && currentUserName) {
                    // Only show bookings where the golfer's name matches current user
                    activeBookings = activeBookings.filter(b => {
                        // Check golferName field
                        if (b.golferName === currentUserName) return true;

                        // Check golfers array
                        if (b.golfers && Array.isArray(b.golfers)) {
                            return b.golfers.some(g => g.name === currentUserName || g.golferName === currentUserName);
                        }

                        return false;
                    });
                    console.log('[renderScheduleList] Filtered to current golfer:', currentUserName, '- found', activeBookings.length, 'bookings');
                }

                console.log('[renderScheduleList] Total bookings to process:', activeBookings.length, '(filtered from', bookings.length, 'total)');
                if (activeBookings.length > 0) {
                    console.log('[renderScheduleList] Sample booking:', activeBookings[0]);
                }

                // Group bookings by groupId
                const groups = {};
                for (const b of activeBookings) {
                    if (!b || !b.id) continue;
                    if (!b.teeTime || !validISO(b.teeTime)) continue;

                    const groupId = b.groupId || b.id;
                    if (!groups[groupId]) {
                        groups[groupId] = {
                            id: groupId,
                            teeTime: b.teeTime,
                            date: b.date,
                            time: b.time,
                            tee: null,
                            teeBookings: [], // NEW: Track all tee bookings in range
                            caddies: [],
                            waitlists: [],
                            services: []
                        };
                    }

                    const kind = b.kind || (/_tee_/.test(b.id) || /_teeTime/.test(b.id) ? 'tee' : /_caddie_/.test(b.id) ? 'caddie' : /_service_/.test(b.id) ? 'service' : 'unknown');

                    if (kind === 'tee' || kind === 'teeTime') {
                        // NEW: For range bookings, collect all tee bookings, use earliest as primary
                        groups[groupId].teeBookings.push(b);
                        if (!groups[groupId].tee || b.teeTime < groups[groupId].tee.teeTime) {
                            groups[groupId].tee = b;
                            groups[groupId].teeTime = b.teeTime;
                            groups[groupId].date = b.date;
                            groups[groupId].time = b.time;
                        }
                    } else if (kind === 'caddie') {
                        // Check both status field and caddieStatus field for waitlist
                        if (b.status === 'waitlist' || b.caddieStatus === 'waitlist' || /_waitlist_/.test(b.id)) {
                            groups[groupId].waitlists.push(b);
                        } else {
                            groups[groupId].caddies.push(b);
                        }
                    } else if (kind === 'service') {
                        groups[groupId].services.push(b);
                    }
                }

                // Convert groups to array and filter
                console.log('[renderScheduleList] Raw groups:', Object.keys(groups).length, 'Sample:', Object.values(groups)[0]);
                let groupedBookings = Object.values(groups).filter(g => g.tee); // Only show groups with a tee time
                console.log('[renderScheduleList] Grouped bookings before filter:', groupedBookings.length);
                if (groupedBookings.length === 0 && Object.keys(groups).length > 0) {
                    console.error('[renderScheduleList] ERROR: Groups exist but no tee bookings found!');
                    console.error('[renderScheduleList] Sample group:', Object.values(groups)[0]);
                }

                // Apply filter (using Bangkok timezone)
                const now = new Date();
                const bangkokNow = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Bangkok' }));
                const todayBangkok = new Date(bangkokNow);
                todayBangkok.setHours(0, 0, 0, 0);

                const tomorrowBangkok = new Date(todayBangkok);
                tomorrowBangkok.setDate(tomorrowBangkok.getDate() + 1);

                switch (this.currentFilter) {
                    case 'today':
                        groupedBookings = groupedBookings.filter(g => {
                            const itemDate = new Date(g.teeTime);
                            const itemBangkok = new Date(itemDate.toLocaleString('en-US', { timeZone: 'Asia/Bangkok' }));
                            return itemBangkok >= todayBangkok && itemBangkok < tomorrowBangkok;
                        });
                        break;
                    case 'upcoming':
                        groupedBookings = groupedBookings.filter(g => {
                            const itemDate = new Date(g.teeTime);
                            return itemDate >= bangkokNow;
                        });
                        break;
                    case 'caddies':
                        groupedBookings = groupedBookings.filter(g => g.caddies.length > 0);
                        break;
                    case 'waitlist':
                        groupedBookings = groupedBookings.filter(g => g.waitlists.length > 0);
                        break;
                    case 'all':
                    default:
                        // Show all
                        break;
                }

                console.log('[renderScheduleList] Grouped bookings after filter:', groupedBookings.length);

                // Apply search query
                if (this.searchQuery) {
                    groupedBookings = groupedBookings.filter(g => {
                        const tee = g.tee;
                        const searchStr = this.searchQuery;

                        // Search in course name
                        if ((tee.courseName || '').toLowerCase().includes(searchStr)) return true;
                        if ((tee.course || '').toLowerCase().includes(searchStr)) return true;

                        // Search in event name
                        if ((tee.eventName || '').toLowerCase().includes(searchStr)) return true;
                        if ((tee.societyName || '').toLowerCase().includes(searchStr)) return true;

                        // Search in date
                        const dateStr = new Date(g.teeTime).toLocaleDateString().toLowerCase();
                        if (dateStr.includes(searchStr)) return true;

                        // Search in caddies
                        if (g.caddies.some(c => (c.caddieName || '').toLowerCase().includes(searchStr))) return true;

                        return false;
                    });
                    console.log('[renderScheduleList] Grouped bookings after search:', groupedBookings.length);
                }

                if (groupedBookings.length === 0) {
                    container.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }

                container.style.display = 'block';
                emptyState.style.display = 'none';

                // Sort by teeTime
                groupedBookings.sort((a, b) => new Date(a.teeTime) - new Date(b.teeTime));

                container.innerHTML = groupedBookings.map(group => this.createGroupedScheduleItem(group)).join('');
            },

            createGroupedScheduleItem(group) {
                const tee = group.tee;
                const date = new Date(group.teeTime);
                const isToday = date.toDateString() === new Date().toDateString();
                const isPast = date < new Date();

                // PRIVACY ENFORCEMENT: Check if booking is private
                const isPrivateBooking = tee.isPrivate === true;
                const currentUserRole = (window.AppState && window.AppState.currentUser && window.AppState.currentUser.role) || 'golfer'; // Default to golfer if no role
                const canSeeDetails = !isPrivateBooking || currentUserRole === 'staff' || currentUserRole === 'proshop' || currentUserRole === 'manager';

                // If private and user is not staff, hide sensitive details
                if (!canSeeDetails) {
                    const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                    const timeStr = group.time || date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                    return `
                        <div class="schedule-item border-l-4 border-gray-400" data-id="${group.id}">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-2">
                                        <div class="w-12 h-12 rounded-full flex items-center justify-center bg-gray-500">
                                            <span class="material-symbols-outlined text-white">lock</span>
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-gray-700 text-lg">Private Booking</h4>
                                            <div class="flex items-center space-x-3 text-sm text-gray-600">
                                                <span class="font-medium">${dateStr}</span>
                                                <span class="font-medium">${timeStr}</span>
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gray-200 text-gray-700">🔒 STAFF ONLY</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg text-center text-gray-600">
                                <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">visibility_off</span>
                                <p class="text-sm">This tee time has been booked. Details are only visible to staff.</p>
                            </div>
                        </div>
                    `;
                }

                // Format date and time
                const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });

                // NEW: Show time range if multiple tee bookings (range booking)
                let timeStr;
                if (group.teeBookings.length > 1) {
                    // Range booking: show start to end time
                    const times = group.teeBookings.map(b => b.time || b.teeTime.split('T')[1].substring(0, 5)).sort();
                    timeStr = `${times[0]} - ${times[times.length - 1]}`;
                } else {
                    timeStr = group.time || date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                }

                // Event type and details with color coding
                // Private = Orange, Society = Green, Club/Course = Red
                let eventType, borderColor, bgColor, badgeColor;

                if (tee.societyId || tee.societyName) {
                    // Society Event - Green
                    eventType = 'Society Event';
                    borderColor = 'border-green-500';
                    bgColor = 'bg-green-600';
                    badgeColor = 'bg-green-100 text-green-700';
                } else if (tee.eventType === 'club' || tee.eventName === 'Club Event') {
                    // Club Event - Red (only if explicitly marked as club)
                    eventType = 'Club Event';
                    borderColor = 'border-red-500';
                    bgColor = 'bg-red-600';
                    badgeColor = 'bg-red-100 text-red-700';
                } else {
                    // Default to Private - Orange
                    eventType = 'Private Round';
                    borderColor = 'border-orange-500';
                    bgColor = 'bg-orange-600';
                    badgeColor = 'bg-orange-100 text-orange-700';
                }

                const eventName = tee.eventName || tee.societyName || 'Golf Round';
                const facility = tee.courseName || tee.course || 'Course';
                const location = tee.courseId || '';

                // Combine Caddies and Waitlist
                let caddyInfo = [];
                if (group.caddies.length > 0) {
                    caddyInfo.push(...group.caddies.map(c => c.caddieName || c.golferName));
                }
                if (group.waitlists.length > 0) {
                    caddyInfo.push(...group.waitlists.map(w => `${w.caddieName || w.golferName} (waitlist)`));
                }
                const caddiesHtml = caddyInfo.length > 0
                    ? `<div class="text-sm"><span class="font-medium text-gray-700">Caddy:</span> ${caddyInfo.join(', ')}</div>`
                    : '';

                // Services
                const servicesHtml = group.services.length > 0
                    ? `<div class="text-sm"><span class="font-medium text-gray-700">Services:</span> ${group.services.map(s => {
                        if (/_cart_/.test(s.id)) return 'Golf Cart';
                        if (/_shoes_/.test(s.id)) return 'Golf Shoes';
                        return s.eventName || s.serviceName || 'Service';
                    }).join(', ')}</div>`
                    : '';

                const isSelected = this.selectedBookings.includes(group.id);

                return `
                    <div class="schedule-item border-l-4 ${borderColor} ${isSelected ? 'bg-blue-50 border-blue-500' : ''}" data-id="${group.id}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center flex-1">
                                <input
                                    type="checkbox"
                                    class="schedule-checkbox w-5 h-5 mr-3 cursor-pointer"
                                    ${isSelected ? 'checked' : ''}
                                    onchange="ScheduleSystem.toggleSelection('${group.id}')"
                                />
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-2">
                                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${bgColor}">
                                            <span class="material-symbols-outlined text-white">golf_course</span>
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-gray-900 text-lg">${eventName}</h4>
                                            <div class="flex items-center space-x-3 text-sm text-gray-600">
                                                <span class="font-medium">${dateStr}</span>
                                                <span class="font-medium">${timeStr}</span>
                                                ${group.teeBookings.length > 1 ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-700">RANGE (${group.teeBookings.length} slots)</span>` : ''}
                                                ${isToday ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold ${badgeColor}">TODAY</span>` : ''}
                                                ${isPast ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-600">PAST</span>' : ''}
                                                ${tee.cancelledByStaff ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800 border border-red-300" title="' + (tee.cancellationReason || 'Cancelled by pro shop staff') + '">❌ CANCELLED</span>' : ''}
                                                ${tee.modifiedByStaff && !tee.cancelledByStaff ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-amber-100 text-amber-800 border border-amber-300" title="' + (tee.modificationReason || 'Modified by pro shop staff') + '">⚠️ MODIFIED</span>' : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="editScheduleItem('${tee.id}')" class="text-blue-600 hover:text-blue-700 p-2 rounded-lg hover:bg-blue-50" title="Edit">
                                    <span class="material-symbols-outlined text-sm">edit</span>
                                </button>
                                <button onclick="cancelScheduleItem('${tee.id}')" class="text-red-600 hover:text-red-700 p-2 rounded-lg hover:bg-red-50" title="Cancel">
                                    <span class="material-symbols-outlined text-sm">cancel</span>
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 bg-gray-50 p-4 rounded-lg">
                            <div>
                                <div class="text-xs font-semibold text-gray-500 uppercase mb-1">Event Type</div>
                                <div class="text-sm font-medium text-gray-900">${eventType}</div>
                                ${tee.societyName ? `<div class="text-xs text-gray-600">${tee.societyName}</div>` : ''}
                            </div>

                            <div>
                                <div class="text-xs font-semibold text-gray-500 uppercase mb-1">Location</div>
                                <div class="text-sm font-medium text-gray-900">${facility}</div>
                                ${location ? `<div class="text-xs text-gray-600">${location}</div>` : ''}
                            </div>

                            <div>
                                <div class="text-xs font-semibold text-gray-500 uppercase mb-1">Players</div>
                                <div class="text-sm font-medium text-gray-900">${tee.players || 1} Players</div>
                                ${tee.durationMin ? `<div class="text-xs text-gray-600">${tee.durationMin} min</div>` : ''}
                            </div>

                            <div>
                                <div class="text-xs font-semibold text-gray-500 uppercase mb-1">Status</div>
                                <div class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${this.getStatusColor(tee.status || 'confirmed')}">
                                    ${(tee.status || 'confirmed').toUpperCase()}
                                </div>
                            </div>
                        </div>

                        ${caddiesHtml || servicesHtml ? `
                            <div class="mt-4 space-y-2 pl-4 border-l-2 border-gray-200">
                                ${caddiesHtml}
                                ${servicesHtml}
                            </div>
                        ` : ''}
                    </div>
                `;
            },

            filterItems(items) {
                const now = new Date();

                switch (this.currentFilter) {
                    case 'today':
                        return items.filter(item => {
                            const itemDate = new Date(item.date || item.start || item.requestedDate || item.createdAt);
                            return itemDate.toDateString() === now.toDateString();
                        });
                    case 'upcoming':
                        return items.filter(item => {
                            const itemDate = new Date(item.date || item.start || item.requestedDate || item.createdAt);
                            return itemDate > now;
                        });
                    case 'caddies':
                        return items.filter(item => item.type === 'caddieBooking');
                    case 'waitlist':
                        return items.filter(item => item.type === 'waitlist');
                    case 'all':
                    default:
                        return items; // Show everything for 'all' filter
                }
            },

            createScheduleItem(item) {
                const date = new Date(item.date || item.start || item.requestedDate || item.createdAt);
                const isToday = date.toDateString() === new Date().toDateString();
                const isPast = date < new Date();

                return `
                    <div class="schedule-item ${item.editing ? 'editing' : ''}" data-id="${item.id}">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center ${this.getTypeColor(item.type)}">
                                        <span class="material-symbols-outlined text-white">${this.getTypeIcon(item.type)}</span>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-900">${item.title}</h4>
                                        <div class="flex items-center space-x-4 text-sm text-gray-600">
                                            <span>${date.toLocaleDateString()}</span>
                                            ${item.time ? `<span>${item.time}</span>` : ''}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${this.getStatusColor(item.status)}">
                                                ${item.status}
                                            </span>
                                            ${isToday ? '<span class="text-blue-600 font-medium">Today</span>' : ''}
                                            ${isPast ? '<span class="text-gray-500">Past</span>' : ''}
                                        </div>
                                    </div>
                                </div>

                                ${this.renderItemDetails(item)}
                            </div>

                            <div class="flex space-x-2 ml-4">
                                ${item.canEdit ? `<button onclick="editScheduleItem('${item.id}')" class="text-blue-600 hover:text-blue-700 p-2 rounded-lg hover:bg-blue-50">
                                    <span class="material-symbols-outlined text-sm">edit</span>
                                </button>` : ''}
                                ${item.canCancel ? `<button onclick="cancelScheduleItem('${item.id}')" class="text-red-600 hover:text-red-700 p-2 rounded-lg hover:bg-red-50">
                                    <span class="material-symbols-outlined text-sm">cancel</span>
                                </button>` : ''}
                                <button onclick="saveScheduleItem('${item.id}')" class="text-green-600 hover:text-green-700 p-2 rounded-lg hover:bg-green-50" style="display: none;">
                                    <span class="material-symbols-outlined text-sm">save</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderItemDetails(item) {
                switch (item.type) {
                    case 'round':
                        const caddiesHtml = item.caddies && item.caddies.length > 0
                            ? `<div class="break-words"><span class="text-gray-500">Caddies:</span> <span class="break-words">${item.caddies.map(c => c.name).join(', ')}</span></div>`
                            : '';
                        const servicesHtml = item.services && item.services.length > 0
                            ? `<div class="break-words"><span class="text-gray-500">Services:</span> <span class="break-words">${item.services.join(', ')}</span></div>`
                            : '';
                        return `
                            <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                                <div class="break-words"><span class="text-gray-500">Course:</span> <span class="break-words">${item.courseName || item.course}</span></div>
                                <div class="break-words"><span class="text-gray-500">Players:</span> ${item.players || 1}</div>
                                ${caddiesHtml}
                                ${servicesHtml}
                            </div>
                        `;
                    case 'event':
                        return `
                            <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                                <div class="break-words"><span class="text-gray-500">Course:</span> <span class="break-words">${item.course}</span></div>
                                <div class="break-words"><span class="text-gray-500">Players:</span> ${item.players}</div>
                                <div class="break-words"><span class="text-gray-500">Duration:</span> ${item.duration} min</div>
                                ${item.notes ? `<div class="break-words col-span-full"><span class="text-gray-500">Notes:</span> <span class="break-words whitespace-pre-wrap">${item.notes}</span></div>` : ''}
                            </div>
                        `;
                    case 'caddieBooking':
                        return `
                            <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                                <div class="break-words"><span class="text-gray-500">Caddy:</span> <span class="break-words">${item.caddieName}</span></div>
                                <div class="break-words"><span class="text-gray-500">Rate:</span> ${item.rate}</div>
                                <div class="break-words"><span class="text-gray-500">Event:</span> <span class="break-words">${item.eventId || 'Standalone'}</span></div>
                            </div>
                        `;
                    case 'waitlist':
                        return `
                            <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                                <div class="break-words"><span class="text-gray-500">Position:</span> #${item.position}</div>
                                <div class="break-words"><span class="text-gray-500">Requested:</span> ${new Date(item.requestedDate).toLocaleDateString()}</div>
                                <div class="break-words"><span class="text-gray-500">Caddy:</span> <span class="break-words">${item.caddieName}</span></div>
                            </div>
                        `;
                    default:
                        return '';
                }
            },

            getTypeIcon(type) {
                const icons = {
                    'event': 'golf_course',
                    'caddieBooking': 'person',
                    'waitlist': 'hourglass_empty'
                };
                return icons[type] || 'event';
            },

            getTypeColor(type) {
                const colors = {
                    'event': 'bg-blue-500',
                    'caddieBooking': 'bg-green-500',
                    'waitlist': 'bg-orange-500'
                };
                return colors[type] || 'bg-gray-500';
            },

            getStatusColor(status) {
                const colors = {
                    'confirmed': 'bg-green-100 text-green-800',
                    'registered': 'bg-blue-100 text-blue-800',
                    'waiting': 'bg-orange-100 text-orange-800',
                    'cancelled': 'bg-red-100 text-red-800',
                    'completed': 'bg-gray-100 text-gray-800'
                };
                return colors[status] || 'bg-gray-100 text-gray-800';
            },

            // NEW: Multi-select functionality
            toggleSelection(groupId) {
                const index = this.selectedBookings.indexOf(groupId);
                if (index > -1) {
                    this.selectedBookings.splice(index, 1);
                } else {
                    this.selectedBookings.push(groupId);
                }
                this.updateMultiSelectUI();
                this.renderScheduleList();
            },

            selectAll() {
                const container = document.getElementById('scheduleList');
                if (!container) return;

                const allGroups = Array.from(container.querySelectorAll('.schedule-item')).map(el => el.dataset.id);
                this.selectedBookings = allGroups;
                this.updateMultiSelectUI();
                this.renderScheduleList();
            },

            clearSelection() {
                this.selectedBookings = [];
                this.updateMultiSelectUI();
                this.renderScheduleList();
            },

            updateMultiSelectUI() {
                const controls = document.getElementById('multiSelectControls');
                const countEl = document.getElementById('selectedCount');

                if (!controls) return;

                if (this.selectedBookings.length > 0) {
                    controls.style.display = 'flex';
                    if (countEl) countEl.textContent = this.selectedBookings.length;
                } else {
                    controls.style.display = 'none';
                }
            },

            async deleteSelected() {
                if (this.selectedBookings.length === 0) {
                    NotificationManager.show('No bookings selected', 'warning');
                    return;
                }

                const count = this.selectedBookings.length;
                if (!confirm(`Delete ${count} selected booking${count > 1 ? 's' : ''}?`)) {
                    return;
                }

                try {
                    // Get all bookings in selected groups (including range bookings)
                    const bookingsToDelete = [];
                    for (const groupId of this.selectedBookings) {
                        const groupBookings = BookingManager.bookings.filter(b => (b.groupId || b.id) === groupId);
                        bookingsToDelete.push(...groupBookings);
                    }

                    console.log(`[deleteSelected] Deleting ${bookingsToDelete.length} bookings in ${count} groups`);

                    // Mark all as deleted
                    for (const booking of bookingsToDelete) {
                        booking.deleted = true;
                        booking.updatedAt = Date.now();
                    }

                    // Save to localStorage
                    localStorage.setItem('mcipro_bookings', JSON.stringify(BookingManager.bookings));

                    // Sync to cloud
                    await SimpleCloudSync.saveToCloud();

                    // Clear selection and refresh
                    this.selectedBookings = [];
                    this.renderScheduleList();

                    NotificationManager.show(`Deleted ${count} booking${count > 1 ? 's' : ''}`, 'success');
                } catch (error) {
                    console.error('[deleteSelected] Error:', error);
                    NotificationManager.show('Failed to delete bookings', 'error');
                }
            }
        };

        // Schedule Functions
        function searchSchedule(query) {
            ScheduleSystem.searchQuery = query.toLowerCase();
            ScheduleSystem.renderScheduleList();
        }

        function filterSchedule(filter) {
            ScheduleSystem.currentFilter = filter;

            // Update filter button states
            document.querySelectorAll('.schedule-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                }
            });

            ScheduleSystem.renderScheduleList();
        }

        function refreshSchedule() {
            LoadingManager.show('Refreshing and syncing...');

            // Force sync to get latest data
            if (typeof ProductionCloudSync !== 'undefined') {
                SimpleCloudSync.saveToCloudSoon();
            }

            setTimeout(() => {
                ScheduleSystem.updateScheduleTab();
                LoadingManager.hide();
                NotificationManager.show('Schedule refreshed and synced', 'success');
            }, 1000);
        }

        // Helper: convert any date to YYYY-MM-DD format for date inputs
        function toDateInputValue(d) {
            if (!d) return '';
            const dt = (d instanceof Date) ? d : new Date(d);
            if (isNaN(dt.getTime())) return '';
            return dt.toISOString().slice(0, 10);
        }

        function editScheduleItem(itemId) {
            // FIXED: Find booking in single source of truth
            const bookings = JSON.parse(localStorage.getItem('mcipro_bookings') || '[]');
            const item = bookings.find(b => b.id === itemId);

            if (!item) {
                NotificationManager.show('Booking not found', 'error');
                return;
            }

            // Determine item type from kind or ID
            const itemType = item.kind || (/_tee_/.test(itemId) || /_teeTime/.test(itemId) ? 'tee' : /_caddie_/.test(itemId) ? 'caddie' : 'unknown');

            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-90vh overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">
                            ${itemType === 'tee' || itemType === 'teeTime' ? 'Edit Tee Time' : itemType === 'caddie' ? 'Edit Caddy Booking' : 'Edit Booking'}
                        </h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>

                    <div class="space-y-6">
                        ${itemType === 'tee' || itemType === 'teeTime' ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Event Title</label>
                                    <input type="text" id="editTitle" value="${item.title || item.eventName || ''}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Course</label>
                                    <input type="text" id="editCourse" value="${item.course || ''}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                    <input type="date" id="editDate" value="${toDateInputValue(item.date)}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                                    <input type="time" id="editTime" value="${item.time || ''}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Players</label>
                                    <input type="number" id="editPlayers" value="${item.players || 1}" min="1" max="8"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="editStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="confirmed" ${item.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                        <option value="pending" ${item.status === 'pending' ? 'selected' : ''}>Pending</option>
                                        <option value="cancelled" ${item.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                                <textarea id="editNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg">${item.notes || ''}</textarea>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-900 mb-1">Booking Details</h4>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><span class="text-gray-600">Total Cost:</span> ฿${item.totalCost ? item.totalCost.toLocaleString() : 'N/A'}</div>
                                    <div><span class="text-gray-600">Payment Method:</span> ${item.paymentMethod || 'N/A'}</div>
                                    <div><span class="text-gray-600">Booked:</span> ${item.createdAt ? new Date(item.createdAt).toLocaleString() : 'N/A'}</div>
                                    <div><span class="text-gray-600">Booking ID:</span> ${item.id}</div>
                                </div>
                            </div>
                        ` : itemType === 'caddie' ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Caddy Name</label>
                                    <input type="text" id="editCaddyName" value="${item.caddieName || ''}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                    <input type="date" id="editDate" value="${toDateInputValue(item.date)}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                                    <input type="time" id="editTime" value="${item.time || ''}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="editStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="confirmed" ${item.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                        <option value="pending" ${item.status === 'pending' ? 'selected' : ''}>Pending</option>
                                        <option value="cancelled" ${item.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-900 mb-2">Caddy Details</h4>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><span class="text-gray-600">Rate:</span> ฿${item.rate ? item.rate.toLocaleString() : 'N/A'}</div>
                                    <div><span class="text-gray-600">Caddy ID:</span> ${item.caddieId || 'N/A'}</div>
                                    <div><span class="text-gray-600">Booked:</span> ${item.createdAt ? new Date(item.createdAt).toLocaleString() : 'N/A'}</div>
                                    <div><span class="text-gray-600">Booking ID:</span> ${item.id}</div>
                                </div>
                            </div>
                        ` : `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Caddy Name</label>
                                    <input type="text" id="editCaddyName" value="${item.caddieName || ''}" readonly
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Position</label>
                                    <input type="text" value="#${item.position || 'N/A'}" readonly
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Requested Date</label>
                                    <input type="date" value="${item.requestedDate ? new Date(item.requestedDate).toISOString().split('T')[0] : ''}" readonly
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <input type="text" value="${item.status || 'Waiting'}" readonly
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-900 mb-2">Waitlist Details</h4>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><span class="text-gray-600">Caddy ID:</span> ${item.caddieId || 'N/A'}</div>
                                    <div><span class="text-gray-600">Joined:</span> ${item.createdAt ? new Date(item.createdAt).toLocaleString() : 'N/A'}</div>
                                    <div><span class="text-gray-600">Entry ID:</span> ${item.id}</div>
                                </div>
                            </div>
                        `}
                    </div>

                    <div class="flex space-x-3 mt-6">
                        <button onclick="saveScheduleItemChanges('${itemId}', '${itemType}', this.closest('.fixed'))" class="btn-primary flex-1">
                            Save Changes
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="btn-secondary flex-1">
                            Cancel
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Make globally accessible
        window.editScheduleItem = editScheduleItem;

        async function cancelScheduleItem(itemId) {
            if (!confirm('Are you sure you want to cancel this item? This action cannot be undone.')) {
                return;
            }

            // FIXED: Delete ALL related bookings (tee + caddies + services) using groupId
            const bookings = JSON.parse(localStorage.getItem('mcipro_bookings') || '[]');
            const mainBooking = bookings.find(b => b.id === itemId);

            if (!mainBooking) {
                NotificationManager.show('Booking not found', 'error');
                return;
            }

            // Get the groupId to find ALL related bookings
            const groupId = mainBooking.groupId;
            console.log('[cancelScheduleItem] Deleting booking group:', groupId);

            // Mark ALL bookings in this group as deleted with tombstone
            let deletedCount = 0;
            bookings.forEach(booking => {
                if (booking.groupId === groupId) {
                    booking.deleted = true;
                    booking.updatedAt = Date.now();
                    deletedCount++;
                    console.log('[cancelScheduleItem] Marked deleted:', booking.id, 'kind:', booking.kind);
                }
            });

            console.log('[cancelScheduleItem] Deleted', deletedCount, 'bookings in group');

            // Save locally
            localStorage.setItem('mcipro_bookings', JSON.stringify(bookings));

            // Update BookingManager
            if (typeof BookingManager !== 'undefined') {
                BookingManager.bookings = bookings;
            }

            // Sync to cloud
            await SimpleCloudSync.saveToCloud();

            // Refresh UI
            ScheduleSystem.renderScheduleList();
            ScheduleSystem.refreshStats();

            NotificationManager.show(`Booking cancelled successfully (${deletedCount} items deleted)`, 'success');
        }

        // Make globally accessible
        window.cancelScheduleItem = cancelScheduleItem;

        async function saveScheduleItemChanges(itemId, itemType, modal) {
            // FIXED: Edit bookings (single source of truth)
            const bookings = JSON.parse(localStorage.getItem('mcipro_bookings') || '[]');
            const booking = bookings.find(b => b.id === itemId);

            if (!booking) {
                NotificationManager.show('Booking not found', 'error');
                return;
            }

            // Update booking with form data based on kind
            const kind = booking.kind || (/_tee_/.test(itemId) || /_teeTime/.test(itemId) ? 'tee' : /_caddie_/.test(itemId) ? 'caddie' : 'unknown');

            if (kind === 'tee' || kind === 'teeTime') {
                const eventName = document.getElementById('editTitle')?.value;
                const courseName = document.getElementById('editCourse')?.value;
                const date = document.getElementById('editDate')?.value;
                const time = document.getElementById('editTime')?.value;
                const players = parseInt(document.getElementById('editPlayers')?.value);
                const status = document.getElementById('editStatus')?.value;
                const notes = document.getElementById('editNotes')?.value;

                if (eventName) booking.eventName = eventName;
                if (courseName) {
                    booking.courseName = courseName;
                    booking.course = courseName;
                }
                if (date) booking.date = date;
                if (time) booking.time = time;
                if (date && time) {
                    booking.teeTime = new Date(date + 'T' + time + ':00').toISOString();
                }
                if (players) booking.players = players;
                if (status) booking.status = status;
                if (notes) booking.notes = notes;
            } else if (kind === 'caddie') {
                const caddieName = document.getElementById('editCaddyName')?.value;
                const date = document.getElementById('editDate')?.value;
                const time = document.getElementById('editTime')?.value;
                const status = document.getElementById('editStatus')?.value;

                if (caddieName) booking.caddieName = caddieName;
                if (date) booking.date = date;
                if (time) booking.time = time;
                if (date && time) {
                    booking.teeTime = new Date(date + 'T' + time + ':00').toISOString();
                }
                if (status) booking.status = status;
            }

            // Update timestamp
            booking.updatedAt = Date.now();

            // Save locally
            localStorage.setItem('mcipro_bookings', JSON.stringify(bookings));

            // Update BookingManager
            if (typeof BookingManager !== 'undefined') {
                BookingManager.bookings = bookings;
            }

            // Sync to cloud
            await SimpleCloudSync.saveToCloud();

            // Refresh UI
            ScheduleSystem.renderScheduleList();
            ScheduleSystem.refreshStats();

            // Close modal
            modal.remove();

            NotificationManager.show('Changes saved successfully', 'success');
        }

        function saveScheduleItem(itemId) {
            const item = document.querySelector(`[data-id="${itemId}"]`);
            if (item) {
                item.classList.remove('editing');
                const saveBtn = item.querySelector('button[onclick*="save"]');
                if (saveBtn) saveBtn.style.display = 'none';

                NotificationManager.show('Changes saved successfully', 'success');
            }
        }

        function refreshSchedule() {
            try {
                console.log('Refreshing schedule and syncing...');

                // Force sync to get latest data
                if (typeof ProductionCloudSync !== 'undefined') {
                    SimpleCloudSync.saveToCloudSoon();
                }

                // Update schedule display
                ScheduleSystem.updateScheduleTab();
                NotificationManager.show('Schedule refreshed and synced', 'success');
            } catch (error) {
                console.error('Error refreshing schedule:', error);
                NotificationManager.show('Failed to refresh schedule', 'error');
            }
        }

        // Booking and Waitlist Management System
        const BookingManager = {
            bookings: [],
            waitlists: {},
            batchMode: false, // When true, suppress individual saves

            // Load bookings from localStorage
            loadFromStorage() {
                try {
                    const savedBookings = localStorage.getItem('mcipro_bookings');
                    if (savedBookings) {
                        this.bookings = JSON.parse(savedBookings);
                        console.log('[BookingManager] Loaded', this.bookings.length, 'bookings from localStorage');

                        // REMOVED: Don't re-create schedule events on login - they're already in mcipro_schedule
                        // Schedule events are preserved across logins and created by upsertFromBooking when bookings are made
                        // Re-creating them here causes duplicates every time user logs in

                        return true;
                    }
                } catch (error) {
                    console.error('[BookingManager] Failed to load from localStorage:', error);
                }
                return false;
            },

            // Initialize - load existing bookings instead of clearing
            initialize() {
                console.log('[BookingManager] Initializing - loading existing bookings');

                // Load existing bookings first
                const loaded = this.loadFromStorage();
                if (!loaded) {
                    // Only start empty if no data exists
                    this.bookings = [];
                    this.waitlists = {};
                }

                console.log('[BookingManager] Initialized with', this.bookings.length, 'existing bookings');
                return;
                // Sample golf event bookings for golfers
                this.bookings = [
                    {
                        id: 'booking_001',
                        golferId: 'golfer_john_mitchell',
                        eventName: 'Weekend Championship Round',
                        course: 'Pattaya Golf Club',
                        date: '2024-10-15',
                        time: '08:00',
                        players: 4,
                        status: 'confirmed',
                        caddieId: 'pat001',
                        caddieName: 'Ning Prasert',
                        totalCost: 3200,
                        createdAt: '2024-10-01T10:30:00Z'
                    },
                    {
                        id: 'booking_ning_current',
                        golferId: 'golfer_sarah_johnson',
                        eventName: 'Private Golf Lesson',
                        course: 'Pattana Golf Resort & Spa',
                        date: '2025-01-15',
                        time: '09:00',
                        players: 1,
                        status: 'active',
                        caddieId: 'pat001',
                        caddieName: 'Ning Prasert',
                        totalCost: 2500,
                        createdAt: '2025-01-15T08:00:00Z',
                        endTime: '13:00',
                        notes: 'Championship course coaching session'
                    },
                    {
                        id: 'booking_002',
                        golferId: 'golfer_john_mitchell',
                        eventName: 'Corporate Golf Day',
                        course: 'Thai Country Club',
                        date: '2024-10-22',
                        time: '14:00',
                        players: 8,
                        status: 'pending',
                        caddieId: 'c002',
                        caddieName: 'Somchai Jaidee',
                        totalCost: 8500,
                        createdAt: '2024-10-05T14:15:00Z'
                    },
                    {
                        id: 'booking_003',
                        golferId: 'golfer_john_mitchell',
                        eventName: 'Monthly Society Round',
                        course: 'Siam Plantation Golf',
                        date: '2024-11-03',
                        time: '10:30',
                        players: 2,
                        status: 'completed',
                        caddieId: 'c003',
                        caddieName: 'Apinya Thaworn',
                        totalCost: 2100,
                        createdAt: '2024-09-28T16:45:00Z'
                    }
                ];

                // Initialize waitlists with current user data
                this.waitlists = {
                    'c002': [
                        {
                            golferId: 'golfer_john_mitchell',
                            golferName: 'John Mitchell',
                            position: 1,
                            requestDate: '2024-10-08T09:30:00Z',
                            priority: 'high',
                            event: 'VIP Tournament Round'
                        }
                    ],
                    'c004': [
                        {
                            golferId: 'golfer_john_mitchell',
                            golferName: 'John Mitchell',
                            position: 3,
                            requestDate: '2024-10-10T11:20:00Z',
                            priority: 'normal',
                            event: 'Luxury Weekend Package'
                        }
                    ]
                };
            },

            getGolferBookings(golferId) {
                return this.bookings.filter(booking => booking.golferId === golferId);
            },

            getGolferWaitlists(golferId) {
                const waitlists = [];
                Object.entries(this.waitlists).forEach(([caddieId, list]) => {
                    const entry = list.find(w => w.golferId === golferId);
                    if (entry) {
                        const caddie = CaddySystem.allCaddys.find(c => c.id === caddieId);
                        waitlists.push({
                            ...entry,
                            caddieId,
                            caddieName: caddie?.name || 'Unknown',
                            caddieRating: caddie?.rating || 0,
                            caddieAvatar: caddie?.avatar || '👨'
                        });
                    }
                });
                return waitlists.sort((a, b) => a.position - b.position);
            },

            addToWaitlist(caddieId, golferData) {
                if (!this.waitlists[caddieId]) {
                    this.waitlists[caddieId] = [];
                }

                const position = this.waitlists[caddieId].length + 1;
                const waitlistEntry = {
                    ...golferData,
                    position,
                    requestDate: new Date().toISOString(),
                    priority: 'normal'
                };

                this.waitlists[caddieId].push(waitlistEntry);

                // Add to Schedule System
                const caddie = CaddySystem.allCaddys.find(c => c.id === caddieId);
                ScheduleSystem.addToWaitlist({
                    title: `Waitlist: ${caddie?.name || 'Unknown Caddy'}`,
                    caddieName: caddie?.name || 'Unknown',
                    caddieId: caddieId,
                    position: position,
                    requestedDate: new Date(),
                    status: 'waiting',
                    canEdit: true,
                    canCancel: true
                });

                return waitlistEntry;
            },

            getCaddyBookings(caddieId) {
                return this.bookings.filter(booking => booking.caddieId === caddieId);
            },

            getCaddyWaitlists(caddieId) {
                return this.waitlists[caddieId] || [];
            },

            addBooking(bookingData) {
                console.log('[BookingManager.addBooking] Input data:', bookingData);

                // Calculate dynamic pricing if AdminPricingControl is available
                if (typeof AdminPricingControl !== 'undefined' && bookingData.date && bookingData.time) {
                    const customerType = bookingData.customerType || (bookingData.isMember ? 'member' : 'walkin');
                    const priceInfo = AdminPricingControl.calculateTeeTimePrice(customerType, bookingData.date, bookingData.time);

                    // Determine if cart or walking
                    const useCart = bookingData.useCart !== false; // default to cart unless explicitly walking
                    const pricing = AdminPricingControl.loadPricing();

                    // Set green fee based on cart/walking
                    if (pricing.courseSettings && !pricing.courseSettings.allowWalking) {
                        // If walking not allowed, always use cart price
                        bookingData.greenFee = priceInfo.cartPrice || 2000;
                    } else if (useCart) {
                        bookingData.greenFee = priceInfo.cartPrice || 2000;
                    } else {
                        bookingData.greenFee = priceInfo.walkingPrice || 1500;
                    }

                    // Add pricing metadata
                    bookingData.pricingPeriod = priceInfo.period;
                    bookingData.appliedPromotions = priceInfo.promotions;
                    bookingData.isWeekend = priceInfo.isWeekend;

                    console.log('[BookingManager.addBooking] Dynamic pricing applied:', {
                        customerType,
                        period: priceInfo.period,
                        cartPrice: priceInfo.cartPrice,
                        walkingPrice: priceInfo.walkingPrice,
                        greenFee: bookingData.greenFee,
                        useCart,
                        promotions: priceInfo.promotions
                    });
                }

                // Generate stable ID to prevent duplicates
                const bookingId = newBookingId(bookingData);

                const booking = {
                    id: bookingId,
                    ...bookingData,
                    updatedAt: Date.now(),
                    createdAt: bookingData.createdAt || new Date().toISOString()
                };

                console.log('[BookingManager.addBooking] Created booking object:', booking);
                console.log('[BookingManager.addBooking] Current bookings before upsert:', this.bookings.length);

                // Use upsert to prevent duplicates
                this.bookings = upsertById(this.bookings, booking, 'id');

                console.log('[BookingManager.addBooking] Current bookings after upsert:', this.bookings.length);
                console.log('[BookingManager.addBooking] Latest booking:', this.bookings[this.bookings.length - 1]);

                // REMOVED: Don't create separate schedule entries - schedule renders from bookings now

                // CRITICAL FIX: Save to localStorage and trigger debounced cloud sync
                // Skip if in batch mode (will be saved once at the end)
                if (!this.batchMode) {
                    console.log('[BookingManager] BOOKING ADDED - SAVING AND SYNCING');
                    this.saveToLocalStorage();
                }

                return booking;
            },

            updateBookingStatus(bookingId, status) {
                const booking = this.bookings.find(b => b.id === bookingId);
                if (booking) {
                    booking.status = status;
                    booking.updatedAt = new Date().toISOString();

                    // Save to localStorage and trigger cloud sync
                    console.log('[BookingManager] BOOKING STATUS UPDATED - SAVING AND SYNCING');
                    this.saveToLocalStorage();
                }
                return booking;
            },

            removeFromWaitlist(caddieId, golferId) {
                if (this.waitlists[caddieId]) {
                    this.waitlists[caddieId] = this.waitlists[caddieId].filter(w => w.golferId !== golferId);
                    // Update positions
                    this.waitlists[caddieId].forEach((entry, index) => {
                        entry.position = index + 1;
                    });
                }
            },

            saveToLocalStorage() {
                try {
                    // DEBUG: Check what's being saved for tee bookings
                    const teeBookings = this.bookings.filter(b => b.kind === 'tee');
                    if (teeBookings.length > 0) {
                        console.log('[BookingManager.saveToLocalStorage] TEE BOOKINGS TO SAVE:', teeBookings.length);
                        teeBookings.forEach(tb => {
                            console.log('[BookingManager.saveToLocalStorage]   ID:', tb.id, 'courseId:', tb.courseId, 'teeSheetCourse:', tb.teeSheetCourse);
                        });
                    }

                    localStorage.setItem('mcipro_bookings', JSON.stringify(this.bookings));
                    localStorage.setItem('mcipro_waitlists', JSON.stringify(this.waitlists));
                    localStorage.setItem('last_local_update', new Date().toISOString());
                    console.log('[BookingManager] Data saved to localStorage:', this.bookings.length, 'bookings');

                    // DEBUG: Verify what was actually written to localStorage
                    const savedData = JSON.parse(localStorage.getItem('mcipro_bookings'));
                    const savedTeeBookings = savedData.filter(b => b.kind === 'tee');
                    if (savedTeeBookings.length > 0) {
                        console.log('[BookingManager.saveToLocalStorage] VERIFIED IN LOCALSTORAGE:', savedTeeBookings.length, 'tee bookings');
                        savedTeeBookings.forEach(tb => {
                            console.log('[BookingManager.saveToLocalStorage]   SAVED ID:', tb.id, 'courseId:', tb.courseId, 'teeSheetCourse:', tb.teeSheetCourse);
                        });
                    }

                    // FIXED: IMMEDIATE SYNC (not debounced) for faster mobile updates
                    console.log('[BookingManager] BOOKING SAVED - TRIGGERING IMMEDIATE SYNC');
                    if (typeof SimpleCloudSync !== 'undefined' && SimpleCloudSync.saveToCloud) {
                        SimpleCloudSync.saveToCloud().then(() => {
                            console.log('[BookingManager] Immediate sync completed');
                        }).catch(err => {
                            console.error('[BookingManager] Immediate sync failed:', err);
                            // Fallback to debounced sync on error
                            SimpleCloudSync.saveToCloudSoon();
                        });
                    }
                } catch (error) {
                    console.error('[BookingManager] Failed to save to localStorage:', error);
                }
            },

            // BULK DELETE DUPLICATE BOOKINGS
            removeDuplicateBookings() {
                console.log('[BookingManager] Starting duplicate removal, current bookings:', this.bookings.length);

                const uniqueBookings = [];
                const seenKeys = new Set();

                this.bookings.forEach(booking => {
                    // Create unique key from essential booking data
                    const key = `${booking.type}-${booking.course}-${booking.date}-${booking.time}-${booking.golferId}`;

                    if (!seenKeys.has(key)) {
                        seenKeys.add(key);
                        uniqueBookings.push(booking);
                    } else {
                        console.log('[BookingManager] Removing duplicate:', booking);
                    }
                });

                const removedCount = this.bookings.length - uniqueBookings.length;
                this.bookings = uniqueBookings;

                console.log(`[BookingManager] Removed ${removedCount} duplicate bookings, ${this.bookings.length} remaining`);

                // Save cleaned data
                this.saveToLocalStorage();

                return removedCount;
            },

            // CLEAR ALL BOOKINGS (for testing)
            clearAllBookings() {
                const count = this.bookings.length;
                this.bookings = [];
                this.saveToLocalStorage();
                console.log(`[BookingManager] Cleared ${count} bookings`);
                return count;
            }
        };

        // Caddy Booking Functions for Featured Caddys
        function bookCaddyFromFeature(caddieId, caddieName) {
            try {
                console.log(`Featured caddie booking: ${caddieId} - ${caddieName}`);

                // Find the caddie in the system
                const caddie = CaddySystem.allCaddys.find(c => c.id === caddieId);
                if (!caddie) {
                    NotificationManager.show('Caddy not found', 'error');
                    return;
                }

                // Find the course this caddie works at
                const course = GolfCoursesDatabase.courses.find(c => c.homeClub === caddie.homeClub);
                if (!course) {
                    NotificationManager.show('Course not found for this caddie', 'error');
                    return;
                }

                // Switch to booking tab
                showGolferTab('booking', null);

                // Wait for tab to load, then pre-select the course and add caddie to cart
                setTimeout(() => {
                    // Pre-select the course (this will auto-add to cart)
                    selectCourse(course.id);

                    // Wait a bit more, then add the caddie to cart
                    setTimeout(() => {
                        addCaddyToCart(caddie, 'booking');

                        // Show success message
                        NotificationManager.show(`${caddieName} added to cart at ${course.name}`, 'success');

                        // Scroll to cart to show the items
                        const cartSection = document.getElementById('bookingCartContainer');
                        if (cartSection) {
                            cartSection.scrollIntoView({ behavior: 'smooth' });
                        }
                    }, 300);

                }, 500);

            } catch (error) {
                console.error('Error in featured caddie booking:', error);
                NotificationManager.show('Failed to open booking page', 'error');
            }
        }

        function joinWaitlistFromFeature(caddieId, caddieName) {
            try {
                // Get current user info
                const currentUser = AppState.currentUser;
                if (!currentUser || !currentUser.name) {
                    NotificationManager.show('Please log in to join waitlist', 'error');
                    return;
                }

                const golferData = {
                    golferId: currentUser.name.toLowerCase().replace(' ', '_'),
                    golferName: currentUser.name,
                    event: 'Future Golf Round'
                };

                // Add to waitlist through BookingManager (which will auto-add to Schedule)
                const waitlistEntry = BookingManager.addToWaitlist(caddieId, golferData);

                NotificationManager.show(`Successfully joined waitlist for ${caddieName} (Position #${waitlistEntry.position})`, 'success');

                // Switch to schedule tab to show the waitlist entry
                setTimeout(() => {
                    showGolferTab('schedule', null);
                }, 1500);

            } catch (error) {
                console.error('Error joining waitlist:', error);
                NotificationManager.show('Failed to join waitlist', 'error');
            }
        }

        // ===== ENHANCED GOLF COURSE & CADDIE BOOKING SYSTEM =====

        // Golf Courses Database - Pattaya Area
        const GolfCoursesDatabase = {
            courses: [
                {
                    id: 'pattana-golf-resort',
                    name: 'Pattana Golf Resort & Spa',
                    location: 'Na Jomtien, Sattahip',
                    type: 'Championship',
                    holes: 18,
                    par: 72,
                    price: 3200,
                    rating: 4.8,
                    image: '🏌️‍♂️',
                    features: ['Championship Course', 'Spa', 'Resort', 'Ocean Views'],
                    homeClub: 'pattana-golf-resort',
                    description: 'Premier championship course with stunning ocean views'
                },
                {
                    id: 'pattaya-golf-club',
                    name: 'Pattaya Golf Club',
                    location: 'Central Pattaya',
                    type: 'Championship',
                    holes: 18,
                    par: 72,
                    price: 2500,
                    rating: 4.6,
                    image: '⛳',
                    features: ['City Course', 'Pro Shop', 'Restaurant'],
                    homeClub: 'pattaya-golf',
                    description: 'Classic championship course in the heart of Pattaya'
                },
                {
                    id: 'thai-country-club',
                    name: 'Thai Country Club',
                    location: 'Chonburi',
                    type: 'Championship',
                    holes: 18,
                    par: 72,
                    price: 3500,
                    rating: 4.9,
                    image: '🏆',
                    features: ['Tournament Course', 'VIP Service', 'Luxury Facilities'],
                    homeClub: 'thai-country-club',
                    description: 'World-class tournament venue with premium facilities'
                },
                {
                    id: 'siam-plantation',
                    name: 'Siam Plantation Golf Club',
                    location: 'Pattaya',
                    type: 'Resort',
                    holes: 18,
                    par: 71,
                    price: 2800,
                    rating: 4.7,
                    image: '🌴',
                    features: ['Resort Course', 'Tropical Setting', 'Family Friendly'],
                    homeClub: 'siam-plantation',
                    description: 'Beautiful resort course with tropical landscaping'
                },
                {
                    id: 'royal-garden',
                    name: 'Royal Garden Golf Club',
                    location: 'Jomtien',
                    type: 'Executive',
                    holes: 18,
                    par: 65,
                    price: 1800,
                    rating: 4.4,
                    image: '👑',
                    features: ['Executive Course', 'Quick Play', 'Beginner Friendly'],
                    homeClub: 'royal-garden',
                    description: 'Executive course perfect for quick rounds'
                },
                {
                    id: 'bangpra-international',
                    name: 'Bangpra International Golf Club',
                    location: 'Sriracha',
                    type: 'Championship',
                    holes: 18,
                    par: 72,
                    price: 2200,
                    rating: 4.5,
                    image: '🌊',
                    features: ['Seaside Course', 'Wind Challenge', 'Scenic Views'],
                    homeClub: 'bangpra-international',
                    description: 'Challenging seaside course with ocean breezes'
                },
                {
                    id: 'crystal-bay',
                    name: 'Crystal Bay Golf Club',
                    location: 'Pattaya',
                    type: 'Resort',
                    holes: 18,
                    par: 70,
                    price: 2400,
                    rating: 4.3,
                    image: '💎',
                    features: ['Bay Views', 'Resort Amenities', 'Practice Facilities'],
                    homeClub: 'crystal-bay',
                    description: 'Scenic course overlooking Crystal Bay'
                },
                {
                    id: 'laem-chabang',
                    name: 'Laem Chabang International Country Club',
                    location: 'Chonburi',
                    type: 'Championship',
                    holes: 27,
                    par: 72,
                    price: 3000,
                    rating: 4.6,
                    image: '🚢',
                    features: ['27 Holes', 'International Standard', 'Corporate Events'],
                    homeClub: 'laem-chabang',
                    description: '27-hole championship complex near the port'
                }
            ],

            searchCourses(query) {
                if (!query) return this.courses;
                return this.courses.filter(course =>
                    course.name.toLowerCase().includes(query.toLowerCase()) ||
                    course.location.toLowerCase().includes(query.toLowerCase()) ||
                    course.type.toLowerCase().includes(query.toLowerCase()) ||
                    course.features.some(f => f.toLowerCase().includes(query.toLowerCase()))
                );
            },

            getCourseById(id) {
                return this.courses.find(course => course.id === id);
            }
        };

        // Enhanced Booking System State
        let selectedCourse = null;
        let selectedCaddys = [];
        let filteredCaddys = [];

        // Initialize courses on page load
        function initializeBookingSystem() {
            loadAllCourses();

            // Set minimum date for booking
            const dateInput = document.getElementById('bookingDate');
            if (dateInput) {
                const today = new Date();
                dateInput.min = today.toISOString().split('T')[0];

                // Set default date to today if no date is selected
                if (!dateInput.value) {
                    dateInput.value = today.toISOString().split('T')[0];
                }
            }

            // Set default time if none selected
            const timeInput = document.getElementById('bookingTime');
            if (timeInput && !timeInput.value) {
                timeInput.value = '08:00'; // Default to 8:00 AM
            }

            // Add event listeners to refresh cart when date/time changes
            if (dateInput) {
                dateInput.addEventListener('change', () => {
                    console.log('[Booking] Date changed - refreshing cart pricing');
                    updateBookingCartDisplay();
                });
            }
            if (timeInput) {
                timeInput.addEventListener('change', () => {
                    console.log('[Booking] Time changed - refreshing cart pricing');
                    updateBookingCartDisplay();
                });
            }
        }

        function loadAllCourses() {
            const courseGrid = document.getElementById('courseGrid');
            const courseGridMobile = document.getElementById('courseGridMobile');

            const courses = GolfCoursesDatabase.courses;

            // Desktop grid
            if (courseGrid) {
                courseGrid.innerHTML = courses.map(course => createCourseCard(course)).join('');
            }

            // Mobile horizontal scroll
            if (courseGridMobile) {
                courseGridMobile.innerHTML = courses.map(course => createMobileCourseCard(course)).join('');
            }
        }

        function createMobileCourseCard(course) {
            return `
                <div class="flex-shrink-0 w-72 bg-white border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-500 transition-all p-4"
                     data-course="${course.id}" onclick="selectCourse('${course.id}')">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-2xl">${course.image}</span>
                            <div>
                                <h4 class="font-bold text-gray-900 text-sm">${course.name}</h4>
                                <p class="text-xs text-gray-600">${course.location}</p>
                            </div>
                        </div>
                        <span class="text-primary-600 font-bold text-sm">฿${course.price.toLocaleString()}</span>
                    </div>

                    <div class="mb-3">
                        <div class="flex items-center space-x-3 text-xs text-gray-600 mb-1">
                            <span>${course.holes} holes • Par ${course.par}</span>
                            <span class="flex items-center">
                                <span class="material-symbols-outlined text-yellow-500 text-xs mr-1">star</span>
                                ${course.rating}
                            </span>
                        </div>
                        <p class="text-xs text-gray-600">${course.description}</p>
                    </div>

                    <div class="flex flex-wrap gap-1">
                        ${course.features.slice(0, 2).map(feature =>
                            `<span class="bg-primary-100 text-primary-800 text-xs px-2 py-1 rounded">${feature}</span>`
                        ).join('')}
                        ${course.features.length > 2 ? `<span class="text-xs text-gray-500">+${course.features.length - 2} more</span>` : ''}
                    </div>
                </div>
            `;
        }

        function createCourseCard(course) {
            return `
                <div class="course-card p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-500 transition-all"
                     data-course="${course.id}" onclick="selectCourse('${course.id}')">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-2xl">${course.image}</span>
                            <div>
                                <h4 class="font-bold text-gray-900 text-sm">${course.name}</h4>
                                <p class="text-xs text-gray-600">${course.location}</p>
                            </div>
                        </div>
                        <span class="text-primary-600 font-bold text-sm">฿${course.price.toLocaleString()}</span>
                    </div>

                    <div class="mb-3">
                        <div class="flex items-center space-x-3 text-xs text-gray-600 mb-1">
                            <span>${course.holes} holes • Par ${course.par}</span>
                            <span class="flex items-center">
                                <span class="material-symbols-outlined text-yellow-500 text-xs mr-1">star</span>
                                ${course.rating}
                            </span>
                        </div>
                        <p class="text-xs text-gray-600">${course.description}</p>
                    </div>

                    <div class="flex flex-wrap gap-1">
                        ${course.features.slice(0, 2).map(feature =>
                            `<span class="bg-primary-100 text-primary-800 text-xs px-2 py-1 rounded">${feature}</span>`
                        ).join('')}
                        ${course.features.length > 2 ? `<span class="text-xs text-gray-500">+${course.features.length - 2} more</span>` : ''}
                    </div>
                </div>
            `;
        }

        function filterCourses(query) {
            const courseGrid = document.getElementById('courseGrid');
            const courseGridMobile = document.getElementById('courseGridMobile');

            const courses = GolfCoursesDatabase.searchCourses(query);

            if (courses.length === 0) {
                if (courseGrid) {
                    courseGrid.innerHTML = `
                        <div class="col-span-3 text-center text-gray-600 py-8">
                            <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">search_off</span>
                            <p>No courses found for "${query}"</p>
                            <p class="text-sm">Try searching for Pattana, Championship, or Resort</p>
                        </div>
                    `;
                }
                if (courseGridMobile) {
                    courseGridMobile.innerHTML = `
                        <div class="flex-shrink-0 w-72 text-center text-gray-600 py-8">
                            <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">search_off</span>
                            <p>No courses found</p>
                        </div>
                    `;
                }
            } else {
                if (courseGrid) {
                    courseGrid.innerHTML = courses.map(course => createCourseCard(course)).join('');
                }
                if (courseGridMobile) {
                    courseGridMobile.innerHTML = courses.map(course => createMobileCourseCard(course)).join('');
                }
            }
        }

        // PERFORMANCE: Create debounced version
        debouncedFilterCourses = debounce(filterCourses, 300);

        function selectCourse(courseId) {
            console.log('selectCourse called with:', courseId);
            selectedCourse = GolfCoursesDatabase.getCourseById(courseId);
            console.log('Selected course:', selectedCourse);

            if (!selectedCourse) {
                console.error('Course not found:', courseId);
                NotificationManager.show('Course not found', 'error');
                return;
            }

            // Update UI to show selected course
            updateSelectedCourseDisplay();

            // Load caddies for this course
            console.log('Loading caddies for homeClub:', selectedCourse.homeClub);
            loadCaddysForCourse(selectedCourse.homeClub);

            // Update course card styles
            document.querySelectorAll('.course-card').forEach(card => {
                card.classList.remove('border-primary-500', 'bg-primary-50');
                card.classList.add('border-gray-200');
            });

            const selectedCard = document.querySelector(`[data-course=\"${courseId}\"]`);
            if (selectedCard) {
                selectedCard.classList.remove('border-gray-200');
                selectedCard.classList.add('border-primary-500', 'bg-primary-50');
            } else {
                console.warn('Selected course card not found:', courseId);
            }

            // Show caddie selection section
            const caddieSection = document.getElementById('caddieSelectionSection');
            if (caddieSection) {
                caddieSection.style.display = 'block';
                console.log('Caddy selection section shown');
            } else {
                console.error('Caddy selection section not found');
            }

            // Add course to cart
            addCourseToCart(selectedCourse);

            // If Pattana Golf Resort, load tee sheet availability
            if (courseId === 'pattana-golf-resort') {
                TeeSheetAvailabilityService.loadAvailability();
            }
        }

        // ===== TEE SHEET AVAILABILITY SERVICE =====
        const TeeSheetAvailabilityService = {
            lastLoadedDate: null,
            isBuilt: false,

            getTeeSheetSettings() {
                // Get Pattana tee sheet settings from localStorage
                const saved = localStorage.getItem('pattana-tee-sheet-settings');
                if (saved) {
                    return JSON.parse(saved);
                }
                // Default settings matching Pattana's setup
                return {
                    startTime: '06:00',
                    endTime: '17:00',
                    interval: '5 min',
                    complex: '27 holes (A/B/C)',
                    teesPerCourse: 1
                };
            },

            buildTimeSlots(startTime, endTime, intervalMinutes) {
                const slots = [];
                const [startHour, startMin] = startTime.split(':').map(Number);
                const [endHour, endMin] = endTime.split(':').map(Number);

                let currentMinutes = startHour * 60 + startMin;
                const endMinutes = endHour * 60 + endMin;

                while (currentMinutes <= endMinutes) {
                    const hours = Math.floor(currentMinutes / 60);
                    const minutes = currentMinutes % 60;
                    const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                    slots.push(timeStr);
                    currentMinutes += intervalMinutes;
                }

                return slots;
            },

            loadAvailability() {
                const date = document.getElementById('bookingDate')?.value;
                if (!date) {
                    console.warn('[TeeSheet Availability] No date selected');
                    return;
                }

                // Only rebuild if date changed or not yet built
                if (this.isBuilt && this.lastLoadedDate === date) {
                    console.log('[TeeSheet Availability] Already loaded for', date, '- skipping rebuild');
                    return;
                }

                console.log('[TeeSheet Availability] Loading availability for Pattana on', date);

                try {
                    // Get tee sheet settings
                    const settings = this.getTeeSheetSettings();
                    const intervalMinutes = parseInt(settings.interval?.replace(/\D/g, '') || '5');

                    // Use bookings already loaded by BookingManager (no need to fetch again)
                    const allBookings = BookingManager.bookings || [];

                    // Filter for Pattana tee sheet bookings on selected date
                    // Include: teesheet (pro shop), dashboard-pattana (golfer), and dashboard (golfer) sources
                    const pattanaBookings = allBookings.filter(b => {
                        // Must have date matching
                        if (b.date !== date) return false;

                        // Must be Pattana course
                        const isPattana = b.course === 'Course A' ||
                                         b.course === 'Course B' ||
                                         b.course === 'Course C' ||
                                         b.courseName === 'Pattana Golf Resort & Spa' ||
                                         b.courseId === 'pattana-golf-resort';

                        if (!isPattana) return false;

                        // Include teesheet (pro shop), dashboard (golfer), and dashboard-pattana (golfer legacy) sources
                        return b.source === 'teesheet' ||
                               b.source === 'dashboard-pattana' ||
                               b.source === 'dashboard';
                    });

                    console.log('[TeeSheet Availability] Found', pattanaBookings.length, 'bookings');

                    // Extract booked time slots
                    const bookedTimes = pattanaBookings.map(b => b.time || b.slotTime?.split('T')[1]?.substring(0, 5));

                    // Rebuild time picker with tee sheet intervals
                    this.rebuildTimePicker(settings.startTime, settings.endTime, intervalMinutes, bookedTimes);

                    // Mark as built and save the date
                    this.isBuilt = true;
                    this.lastLoadedDate = date;

                } catch (error) {
                    console.error('[TeeSheet Availability] Error loading:', error);
                }
            },

            rebuildTimePicker(startTime, endTime, intervalMinutes, bookedTimes) {
                const timeSelect = document.getElementById('bookingTime');
                if (!timeSelect) return;

                // Save current selection
                const currentValue = timeSelect.value;

                // Generate time slots based on tee sheet settings
                const timeSlots = this.buildTimeSlots(startTime, endTime, intervalMinutes);

                // Use DocumentFragment for faster DOM manipulation
                const fragment = document.createDocumentFragment();

                // Add placeholder
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'Choose time...';
                fragment.appendChild(placeholder);

                // Add new time slots using fragment
                timeSlots.forEach(time => {
                    const option = document.createElement('option');
                    option.value = time;

                    const isBooked = bookedTimes.includes(time);

                    if (isBooked) {
                        option.textContent = `${time} (Booked)`;
                        option.disabled = true;
                        option.style.color = '#9ca3af';
                        option.style.fontStyle = 'italic';
                    } else {
                        option.textContent = time;
                    }

                    fragment.appendChild(option);
                });

                // Replace all options at once (much faster than individual appends)
                timeSelect.innerHTML = '';
                timeSelect.appendChild(fragment);

                // Restore previous selection if it still exists
                if (currentValue && timeSlots.includes(currentValue)) {
                    timeSelect.value = currentValue;
                }

                console.log('[TeeSheet Availability] Built', timeSlots.length, 'slots in', intervalMinutes, 'min intervals');
            },

            updateTimePickerAvailability(bookedTimes) {
                const timeSelect = document.getElementById('bookingTime');
                if (!timeSelect) return;

                // Get all time options
                const options = timeSelect.querySelectorAll('option');

                options.forEach(option => {
                    const timeValue = option.value;
                    if (!timeValue) return; // Skip the "Choose time..." option

                    const isBooked = bookedTimes.includes(timeValue);

                    if (isBooked) {
                        // Mark as booked - gray out and disable
                        option.disabled = true;
                        option.textContent = option.textContent.replace(' (Booked)', '') + ' (Booked)';
                        option.style.color = '#9ca3af';
                        option.style.fontStyle = 'italic';
                    } else {
                        // Available - enable and show normally
                        option.disabled = false;
                        option.textContent = option.textContent.replace(' (Booked)', '');
                        option.style.color = '';
                        option.style.fontStyle = '';
                    }
                });

                console.log('[TeeSheet Availability] Updated time picker with availability');
            }
        };

        function updateSelectedCourseDisplay() {
            const selectedCourseInfo = document.getElementById('selectedCourseInfo');
            const selectedCourseName = document.getElementById('selectedCourseName');

            if (selectedCourse && selectedCourseInfo && selectedCourseName) {
                selectedCourseName.textContent = `${selectedCourse.name} - ฿${selectedCourse.price.toLocaleString()}`;
                selectedCourseInfo.classList.remove('hidden');
            }
        }

        function loadCaddysForCourse(homeClub) {
            console.log('loadCaddysForCourse called with homeClub:', homeClub);

            // Filter caddies by their home club
            const courseCaddys = CaddySystem.allCaddys.filter(caddie => caddie.homeClub === homeClub);

            console.log('Filtered caddies for course:', courseCaddys.length, 'caddies');

            filteredCaddys = courseCaddys;
            renderCaddys(courseCaddys);
            updateCaddyStats(courseCaddys);
        }

        function renderCaddys(caddies) {
            const caddieGrid = document.getElementById('caddieGrid');
            const caddieGridMobile = document.getElementById('caddieGridMobile');

            if (caddies.length === 0) {
                if (caddieGrid) {
                    caddieGrid.innerHTML = `
                        <div class="col-span-2 text-center text-gray-600 py-8">
                            <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">person_off</span>
                            <p>No caddies available at this course</p>
                        </div>
                    `;
                }
                if (caddieGridMobile) {
                    caddieGridMobile.innerHTML = `
                        <div class="flex-shrink-0 w-72 text-center text-gray-600 py-8">
                            <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">person_off</span>
                            <p class="text-sm">No caddies available at this course</p>
                        </div>
                    `;
                }
                return;
            }

            // Desktop grid
            if (caddieGrid) {
                caddieGrid.innerHTML = caddies.map(caddie => createCaddyCard(caddie)).join('');
            }

            // Mobile horizontal scroll
            if (caddieGridMobile) {
                caddieGridMobile.innerHTML = caddies.map(caddie => createMobileCaddyCard(caddie)).join('');
            }
        }

        function createMobileCaddyCard(caddie) {
            const isAvailable = caddie.availability === 'available';
            const isBooked = caddie.availability === 'booked';

            return `
                <div class="flex-shrink-0 w-72 caddie-card p-4 border-2 ${isAvailable ? 'border-green-200 bg-green-50' : isBooked ? 'border-red-200 bg-red-50' : 'border-yellow-200 bg-yellow-50'} rounded-xl transition-all"
                     data-caddie="${caddie.id}">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <img src="${caddie.photo || 'images/caddies/default.jpg'}" alt="${caddie.name}" class="w-12 h-12 rounded-full object-cover border-2 border-primary-200" onerror="this.src='https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=200&h=200&fit=crop'">
                            <div>
                                <h4 class="font-bold text-gray-900 text-sm">${caddie.name}</h4>
                                <p class="text-xs text-gray-600">${caddie.specialty}</p>
                                <div class="flex items-center space-x-1 mt-1">
                                    <span class="text-yellow-400 text-xs">★</span>
                                    <span class="text-xs text-gray-600">${caddie.rating}</span>
                                    <span class="text-xs text-gray-500">(${caddie.reviews})</span>
                                </div>
                            </div>
                        </div>
                        <span class="text-xs font-semibold px-2 py-1 rounded-full ${isAvailable ? 'bg-green-100 text-green-800' : isBooked ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${caddie.availability}
                        </span>
                    </div>

                    <div class="mb-3">
                        <div class="flex items-center justify-between text-xs text-gray-600 mb-2">
                            <span>Exp: ${caddie.experience} years</span>
                            <span>Rate: ฿1,200</span>
                        </div>
                        <div class="flex flex-wrap gap-1">
                            ${caddie.languages.slice(0, 2).map(lang =>
                                `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${lang}</span>`
                            ).join('')}
                        </div>
                    </div>

                    <div class="space-y-2">
                        ${isAvailable ?
                            `<button onclick="addCaddyToCart(${JSON.stringify(caddie).replace(/"/g, '&quot;')}, 'booking')" class="w-full bg-green-600 text-white py-2 px-3 rounded-lg text-xs font-semibold hover:bg-green-700 transition-colors">
                                Book Now - ฿1,200
                            </button>` :
                            `<button onclick="addCaddyToCart(${JSON.stringify(caddie).replace(/"/g, '&quot;')}, 'waitlist')" class="w-full bg-orange-600 text-white py-2 px-3 rounded-lg text-xs font-semibold hover:bg-orange-700 transition-colors">
                                Join Waitlist
                            </button>`
                        }
                    </div>
                </div>
            `;
        }

        function createCaddyCard(caddie) {
            const isAvailable = caddie.availability === 'available';
            const isBooked = caddie.availability === 'booked';

            return `
                <div class="caddie-card p-4 border-2 ${isAvailable ? 'border-green-200 bg-green-50' : isBooked ? 'border-red-200 bg-red-50' : 'border-yellow-200 bg-yellow-50'} rounded-xl transition-all"
                     data-caddie="${caddie.id}">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <img src="${caddie.photo || 'images/caddies/default.jpg'}" alt="${caddie.name}" class="w-16 h-16 rounded-full object-cover border-2 border-primary-200" onerror="this.src='https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=200&h=200&fit=crop'">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <h5 class="font-bold text-gray-900">${caddie.name}</h5>
                                    <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">#${caddie.id.replace('c', '')}</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="material-symbols-outlined text-yellow-500 text-sm mr-1">star</span>
                                    <span>${caddie.rating} • ${caddie.experience} years exp</span>
                                </div>
                                <p class="text-xs text-gray-600 mt-1">${caddie.specialty}</p>
                            </div>
                        </div>

                        <div class="text-right">
                            <div class="mb-2">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                    isAvailable ? 'bg-green-100 text-green-800' :
                                    isBooked ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'
                                }">
                                    ${isAvailable ? '✅ Available' : isBooked ? '🔴 Booked' : '🟡 Busy'}
                                </span>
                            </div>

                            ${isAvailable ?
                                `<button onclick="bookCaddyFromBooking('${caddie.id}', '${caddie.name}')"
                                        class="bg-green-600 text-white text-xs py-2 px-3 rounded-lg hover:bg-green-700 transition-colors w-full mb-1">
                                    <span class="material-symbols-outlined text-xs mr-1">event_available</span>
                                    Book Now
                                </button>` :
                                `<button onclick="joinWaitlistFromBooking('${caddie.id}', '${caddie.name}')"
                                        class="bg-orange-500 text-white text-xs py-2 px-3 rounded-lg hover:bg-orange-600 transition-colors w-full mb-1">
                                    <span class="material-symbols-outlined text-xs mr-1">schedule</span>
                                    Join Waitlist
                                </button>`
                            }

                            <button onclick="selectCaddy('${caddie.id}', false)"
                                    class="bg-gray-100 text-gray-700 text-xs py-1 px-3 rounded-lg hover:bg-gray-200 transition-colors w-full">
                                <span class="material-symbols-outlined text-xs mr-1">info</span>
                                Details
                            </button>
                        </div>
                    </div>

                    <div class="border-t pt-3">
                        <div class="flex flex-wrap gap-1 mb-2">
                            ${caddie.languages.map(lang =>
                                `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${lang}</span>`
                            ).join('')}
                        </div>

                        <div class="text-xs text-gray-600">
                            <span class="font-medium">${caddie.totalRounds.toLocaleString()}</span> rounds •
                            <span class="font-medium">${caddie.reviews}</span> reviews
                        </div>
                    </div>
                </div>
            `;
        }

        function filterCaddys(query) {
            if (!filteredCaddys.length) return;

            const filtered = filteredCaddys.filter(caddie =>
                caddie.name.toLowerCase().includes(query.toLowerCase()) ||
                caddie.id.toLowerCase().includes(query.toLowerCase()) ||
                caddie.specialty.toLowerCase().includes(query.toLowerCase()) ||
                caddie.languages.some(lang => lang.toLowerCase().includes(query.toLowerCase()))
            );

            renderCaddys(filtered);
        }

        // PERFORMANCE: Create debounced version (100% optimization)
        debouncedFilterCaddys = debounce(filterCaddys, 300);

        function updateCaddyStats(caddies) {
            const availableCount = caddies.filter(c => c.availability === 'available').length;
            const waitlistCount = caddies.filter(c => c.availability === 'booked').length;

            const availableElement = document.getElementById('availableCaddyCount');
            const waitlistElement = document.getElementById('waitlistCaddyCount');

            if (availableElement) availableElement.textContent = availableCount;
            if (waitlistElement) waitlistElement.textContent = waitlistCount;
        }

        function bookCaddyFromBooking(caddieId, caddieName) {
            if (!selectedCourse) {
                NotificationManager.show('Please select a course first', 'error');
                return;
            }

            // Add to selected caddies
            if (!selectedCaddys.includes(caddieId)) {
                selectedCaddys.push(caddieId);
            }

            NotificationManager.show(`${caddieName} added to your booking`, 'success');

            // Update card to show selected state
            const caddieCard = document.querySelector(`[data-caddie="${caddieId}"]`);
            if (caddieCard) {
                caddieCard.classList.add('border-primary-500', 'bg-primary-50');
            }
        }

        function joinWaitlistFromBooking(caddieId, caddieName) {
            joinWaitlistFromFeature(caddieId, caddieName);
        }

        // ===== BOOKING CART SYSTEM =====
        let bookingCart = {
            course: null,
            date: null,
            time: null,
            players: 1,
            caddies: [],
            waitlists: [],
            services: [],
            totals: {
                courseTotal: 0,
                caddieTotal: 0,
                servicesTotal: 0,
                serviceCharge: 0,
                grandTotal: 0
            }
        };

        function initializeBookingCart() {
            updateBookingCartDisplay();
        }

        function addCourseToCart(course) {
            bookingCart.course = course;
            updateBookingCartDisplay();
            NotificationManager.show(`${course.name} added to cart`, 'success');
        }

        function addCaddyToCart(caddie, type = 'booking') {
            const cartItem = {
                id: caddie.id,
                name: caddie.name,
                number: caddie.number, // FIXED: Copy caddy number for tee sheet display
                type: type, // 'booking' or 'waitlist'
                rate: type === 'booking' ? 1200 : 0, // Standard caddie rate
                specialty: caddie.specialty,
                rating: caddie.rating,
                avatar: caddie.avatar
            };

            if (type === 'booking') {
                // Check if already in cart
                const existing = bookingCart.caddies.find(c => c.id === caddie.id);
                if (existing) {
                    NotificationManager.show(`${caddie.name} is already in your cart`, 'warning');
                    return;
                }
                bookingCart.caddies.push(cartItem);
            } else {
                // Add to waitlist
                const existing = bookingCart.waitlists.find(w => w.id === caddie.id);
                if (existing) {
                    NotificationManager.show(`You're already on ${caddie.name}'s waitlist`, 'warning');
                    return;
                }
                bookingCart.waitlists.push(cartItem);
            }

            updateBookingCartDisplay();
            NotificationManager.show(`${caddie.name} ${type === 'booking' ? 'booked' : 'added to waitlist'}`, 'success');
        }

        function toggleServiceNew(serviceId) {
            const serviceOptions = [
                { id: 'cart', name: 'Golf Cart Rental', price: 600, icon: '🚗', description: 'Electric golf cart for 2 players' },
                { id: 'clubs', name: 'Club Rental Set', price: 400, icon: '⛳', description: 'Premium club set with bag' },
                { id: 'shoes', name: 'Golf Shoes Rental', price: 200, icon: '👟', description: 'Professional golf shoes' },
                { id: 'insurance', name: 'Play Insurance', price: 150, icon: '🛡️', description: 'Covers medical & equipment' },
                { id: 'lesson', name: 'Pro Lesson (30min)', price: 800, icon: '🎯', description: 'One-on-one instruction' }
            ];

            const service = serviceOptions.find(s => s.id === serviceId);
            if (!service) return;

            // Initialize services array if it doesn't exist
            if (!bookingCart.services) {
                bookingCart.services = [];
            }

            const existingIndex = bookingCart.services.findIndex(s => s.id === serviceId);
            const serviceElements = document.querySelectorAll(`[data-service="${serviceId}"]`);

            if (existingIndex >= 0) {
                // Remove service
                bookingCart.services.splice(existingIndex, 1);
                serviceElements.forEach(el => {
                    el.classList.remove('border-primary-500', 'bg-primary-50');
                    el.classList.add('border-gray-200');
                });
                NotificationManager.show(`${service.name} removed from cart`, 'info');
            } else {
                // Add service
                bookingCart.services.push(service);
                serviceElements.forEach(el => {
                    el.classList.remove('border-gray-200');
                    el.classList.add('border-primary-500', 'bg-primary-50');
                });
                NotificationManager.show(`${service.name} added to cart`, 'success');
            }

            updateBookingCartDisplay();
        }

        function removeCaddyFromCart(caddieId, type = 'booking') {
            if (type === 'booking') {
                bookingCart.caddies = bookingCart.caddies.filter(c => c.id !== caddieId);
            } else {
                bookingCart.waitlists = bookingCart.waitlists.filter(w => w.id !== caddieId);
            }
            updateBookingCartDisplay();
        }

        function updateBookingCartDisplay() {
            const container = document.getElementById('bookingCartContainer');
            const itemCount = document.getElementById('cartItemCount');
            const confirmBtn = document.getElementById('confirmBookingBtn');

            if (!container) return;

            const totalItems = bookingCart.caddies.length + bookingCart.waitlists.length + (bookingCart.course ? 1 : 0) + (bookingCart.services ? bookingCart.services.length : 0);

            // Update item count
            if (itemCount) itemCount.textContent = totalItems;

            // Calculate totals
            calculateCartTotals();

            // Update cart display
            if (totalItems === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-600 py-8">
                        <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">shopping_cart</span>
                        <p class="text-sm">Your cart is empty</p>
                        <p class="text-xs">Select a course and caddies to start</p>
                    </div>
                `;
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                    confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } else {
                let cartHTML = '';

                // Course item
                if (bookingCart.course) {
                    // Calculate dynamic price based on date/time if available
                    let displayPrice = bookingCart.course.price;
                    let pricingInfo = '';

                    if (typeof AdminPricingControl !== 'undefined') {
                        const date = document.getElementById('bookingDate')?.value;
                        const time = document.getElementById('bookingTime')?.value;

                        if (date && time) {
                            // Determine customer type
                            const currentUser = window.AppState?.currentUser;
                            const customerType = currentUser?.membershipId ? 'member' : 'walkin';

                            const priceInfo = AdminPricingControl.calculateTeeTimePrice(customerType, date, time);
                            const pricing = AdminPricingControl.loadPricing();

                            // Check if cart or walking
                            const useCart = !pricing.courseSettings?.allowWalking || true; // Default to cart

                            if (useCart) {
                                displayPrice = priceInfo.cartPrice || displayPrice;
                                pricingInfo = `<span class="text-xs text-gray-500">${priceInfo.period} • Cart</span>`;
                            } else {
                                displayPrice = priceInfo.walkingPrice || displayPrice;
                                pricingInfo = `<span class="text-xs text-gray-500">${priceInfo.period} • Walking</span>`;
                            }

                            if (priceInfo.promotions && priceInfo.promotions.length > 0) {
                                pricingInfo += `<br><span class="text-xs text-green-600">🎉 ${priceInfo.promotions[0].name}</span>`;
                            }
                        }
                    }

                    cartHTML += `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="text-lg">${bookingCart.course.image}</span>
                                    <div>
                                        <h5 class="font-semibold text-sm text-gray-900">${bookingCart.course.name}</h5>
                                        <p class="text-xs text-gray-600">${bookingCart.course.holes} holes • Par ${bookingCart.course.par}</p>
                                        ${pricingInfo}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="font-semibold text-sm text-blue-600">฿${displayPrice.toLocaleString()}</span>
                                    <button onclick="removeCourseFromCart()" class="block mt-1 text-red-600 hover:text-red-700">
                                        <span class="material-symbols-outlined text-xs">delete</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Enable confirm button when we have course and booking details
                const date = document.getElementById('bookingDate')?.value;
                const time = document.getElementById('bookingTime')?.value;

                if (confirmBtn && bookingCart.course && date && time) {
                    confirmBtn.disabled = false;
                    confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else if (confirmBtn) {
                    confirmBtn.disabled = true;
                    confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }

                // Caddy bookings
                bookingCart.caddies.forEach(caddie => {
                    cartHTML += `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="text-lg">${caddie.avatar}</span>
                                    <div>
                                        <h5 class="font-semibold text-sm text-gray-900">${caddie.name}</h5>
                                        <p class="text-xs text-gray-600">${caddie.specialty} • ★${caddie.rating}</p>
                                        <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Booked</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="font-semibold text-sm text-green-600">฿${caddie.rate.toLocaleString()}</span>
                                    <button onclick="removeCaddyFromCart('${caddie.id}', 'booking')" class="block mt-1 text-red-600 hover:text-red-700">
                                        <span class="material-symbols-outlined text-xs">delete</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // Waitlists
                bookingCart.waitlists.forEach(waitlist => {
                    cartHTML += `
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="text-lg">${waitlist.avatar}</span>
                                    <div>
                                        <h5 class="font-semibold text-sm text-gray-900">${waitlist.name}</h5>
                                        <p class="text-xs text-gray-600">${waitlist.specialty} • ★${waitlist.rating}</p>
                                        <span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded">Waitlist</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="font-semibold text-sm text-orange-600">Pending</span>
                                    <button onclick="removeCaddyFromCart('${waitlist.id}', 'waitlist')" class="block mt-1 text-red-600 hover:text-red-700">
                                        <span class="material-symbols-outlined text-xs">delete</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // Services
                if (bookingCart.services && bookingCart.services.length > 0) {
                    bookingCart.services.forEach(service => {
                        cartHTML += `
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-lg">${service.icon}</span>
                                        <div>
                                            <h5 class="font-semibold text-sm text-gray-900">${service.name}</h5>
                                            <p class="text-xs text-gray-600">${service.description}</p>
                                            <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">Service</span>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="font-semibold text-sm text-purple-600">฿${service.price.toLocaleString()}</span>
                                        <button onclick="toggleServiceNew('${service.id}')" class="block mt-1 text-red-600 hover:text-red-700">
                                            <span class="material-symbols-outlined text-xs">delete</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                container.innerHTML = cartHTML;

                if (confirmBtn) {
                    confirmBtn.disabled = !bookingCart.course;
                    if (bookingCart.course) {
                        confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }
            }
        }

        function calculateCartTotals() {
            const courseTotal = bookingCart.course ? bookingCart.course.price : 0;
            const caddieTotal = bookingCart.caddies.reduce((total, caddie) => total + caddie.rate, 0);
            const servicesTotal = bookingCart.services ? bookingCart.services.reduce((total, service) => total + service.price, 0) : 0;
            const subtotal = courseTotal + caddieTotal + servicesTotal;
            const serviceCharge = Math.round(subtotal * 0.1);
            const grandTotal = subtotal + serviceCharge;

            bookingCart.totals = {
                courseTotal,
                caddieTotal,
                servicesTotal,
                serviceCharge,
                grandTotal
            };

            // Update display
            document.getElementById('cartCourseTotal').textContent = `฿${courseTotal.toLocaleString()}`;
            document.getElementById('cartCaddyTotal').textContent = `฿${caddieTotal.toLocaleString()}`;
            document.getElementById('cartServicesTotal').textContent = `฿${servicesTotal.toLocaleString()}`;
            document.getElementById('cartServiceCharge').textContent = `฿${serviceCharge.toLocaleString()}`;
            document.getElementById('cartGrandTotal').textContent = `฿${grandTotal.toLocaleString()}`;
        }

        function removeCourseFromCart() {
            bookingCart.course = null;
            selectedCourse = null;

            // Hide caddie selection
            const caddieSection = document.getElementById('caddieSelectionSection');
            if (caddieSection) {
                caddieSection.style.display = 'none';
            }

            // Clear course selection UI
            document.querySelectorAll('.course-card').forEach(card => {
                card.classList.remove('border-primary-500', 'bg-primary-50');
                card.classList.add('border-gray-200');
            });

            const selectedCourseInfo = document.getElementById('selectedCourseInfo');
            if (selectedCourseInfo) {
                selectedCourseInfo.classList.add('hidden');
            }

            updateBookingCartDisplay();
            NotificationManager.show('Course removed from cart', 'info');
        }

        function clearBookingCart() {
            if (confirm('Are you sure you want to clear your entire cart?')) {
                bookingCart = {
                    course: null,
                    date: null,
                    time: null,
                    players: 1,
                    caddies: [],
                    waitlists: [],
                    services: [],
                    totals: { courseTotal: 0, caddieTotal: 0, servicesTotal: 0, serviceCharge: 0, grandTotal: 0 }
                };
                selectedCourse = null;
                selectedCaddys = [];

                // Reset UI
                removeCourseFromCart();
                updateBookingCartDisplay();
                NotificationManager.show('Cart cleared', 'success');
            }
        }

        // ===== CADDY 22:00 CUTOFF RULE =====
        function calculateCaddyStatus(bookingDate, bookingTime) {
            const now = new Date();
            const booking = new Date(`${bookingDate}T${bookingTime}:00`);

            // Check if booking is for tomorrow
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);

            const bookingDay = new Date(bookingDate);
            bookingDay.setHours(0, 0, 0, 0);

            const isTomorrow = bookingDay.getTime() === tomorrow.getTime();
            const isPast22 = now.getHours() >= 22;

            if (isTomorrow && isPast22) {
                console.log('[Caddy Status] Next-day booking after 22:00 - requires caddy approval');
                return 'pending'; // Caddy must accept/decline
            } else {
                console.log('[Caddy Status] Auto-confirmed (not tomorrow or before 22:00)');
                return 'confirmed'; // Auto-accepted
            }
        }

        async function confirmBooking() {
            console.log('[confirmBooking] *** BOOKING STARTED ***');

            // Guard against double-tap
            if (creatingBooking) {
                console.log('[confirmBooking] Already creating booking, ignoring duplicate call');
                return;
            }
            creatingBooking = true;

            try {
                // 1) Validate cart early
                const errors = [];
                if (!bookingCart.course) errors.push('course');

                const date = document.getElementById('bookingDate')?.value;
                const time = document.getElementById('bookingTime')?.value;
                const players = document.getElementById('playerCount')?.value || 1;

                if (!date || !time) errors.push('tee time');

                if (errors.length) {
                    NotificationManager.show(`Missing: ${errors.join(', ')}`, 'error');
                    return;
                }

                // Build teeTime ISO string
                // IMPORTANT: Treat date/time as Bangkok timezone (UTC+7)
                // User selects "2025-10-05" and "09:05" meaning 9:05 AM Bangkok time
                // We want ISO: 2025-10-05T09:05:00+07:00 (or 2025-10-05T02:05:00.000Z in UTC)
                // BUT for display purposes, store as Bangkok local time to avoid timezone confusion
                const teeTime = `${date}T${time}:00+07:00`;

                if (isNaN(+new Date(teeTime))) {
                    NotificationManager.show('Invalid date/time', 'error');
                    return;
                }

                // Get current user
                let currentUser = AppState.currentUser;
                if (!currentUser?.name) {
                    currentUser = { name: 'Desktop User', role: 'golfer', lineId: 'desktop_user_' + Date.now() };
                    AppState.currentUser = currentUser;
                }

                const userId = currentUser.name.toLowerCase().replace(/\s+/g, '_');
                const courseSlug = bookingCart.course.slug || bookingCart.course.name.replace(/\s+/g, '_');
                const courseName = bookingCart.course.name;

                // 2) Build normalized booking records - NO kind='teeTime', use 'tee'
                const groupId = `round_${courseSlug}_${teeTime}_${userId}`;

                const toCreate = [];

                // Main tee time
                const mainTeeBooking = {
                    id: `bk_${courseSlug}_${teeTime}_${userId}_tee_main`,
                    kind: 'tee',
                    golferId: userId,
                    golferName: currentUser.name,
                    eventName: `Round at ${courseName}`,
                    course: courseName,
                    courseName: courseName,
                    courseId: courseSlug,  // FIXED: Now properly saving courseId
                    date: date,
                    time: time,
                    teeTime: teeTime,
                    slotTime: teeTime, // For tee sheet compatibility
                    players: parseInt(players),
                    durationMin: 240,
                    status: 'confirmed',
                    groupId: groupId,
                    updatedAt: Date.now(),
                    bookingType: 'regular',
                    teeNumber: 1, // Default tee number for compatibility
                    notes: '', // Notes field for tee sheet compatibility
                    notesLang: 'en', // Notes language for tee sheet compatibility
                    isPrivate: false, // Public booking by default
                    source: 'dashboard', // Mark all dashboard bookings for tee sheet sync

                    // Add golfers array for tee sheet compatibility
                    golfers: [{
                        id: userId,
                        name: currentUser.name,
                        phone: currentUser.phone || '',
                        email: currentUser.email || '',
                        handicap: currentUser.handicap || 0,
                        isVIP: false,
                        inputLang: 'en'
                    }],

                    // Add caddyBookings array for tee sheet compatibility
                    caddyBookings: []
                };

                // If Pattana Golf Resort, mark for tee sheet sync with specific course
                if (courseSlug === 'pattana-golf-resort' || courseName === 'Pattana Golf Resort & Spa') {
                    mainTeeBooking.source = 'dashboard-pattana';
                    mainTeeBooking.teeSheetCourse = 'Course A'; // Default to Course A
                    console.log('[confirmBooking] Pattana booking - will sync to tee sheet');
                }

                // Caddies - with 22:00 cutoff rule
                (bookingCart.caddies || []).forEach(caddie => {
                    // Calculate caddy status based on 22:00 rule
                    const caddyStatus = calculateCaddyStatus(date, time);

                    // Add to mainTeeBooking caddyBookings array for tee sheet compatibility
                    mainTeeBooking.caddyBookings.push({
                        golferId: userId,
                        caddyId: caddie.id,
                        golferName: currentUser.name,
                        caddyName: caddie.name,
                        caddyNumber: caddie.number || '000',
                        status: caddyStatus === 'pending' ? 'pending' : 'confirmed',
                        isWaitlisted: false
                    });

                    toCreate.push({
                        id: `bk_${courseSlug}_${teeTime}_${userId}_caddie_${caddie.id}`,
                        kind: 'caddie',
                        golferId: userId,
                        golferName: currentUser.name,
                        eventName: `Caddie: ${caddie.name}`,
                        course: courseName,
                        courseName: courseName,
                        courseId: courseSlug,
                        date: date,
                        time: time,
                        teeTime: teeTime,
                        caddieId: caddie.id,
                        caddieName: caddie.name,
                        caddieNumber: caddie.number || '000',
                        status: caddyStatus, // 'confirmed' or 'pending'
                        caddyConfirmationRequired: caddyStatus === 'pending',
                        groupId: groupId,
                        updatedAt: Date.now()
                    });
                });

                // Waitlist Caddies
                (bookingCart.waitlists || []).forEach(caddie => {
                    // Add to mainTeeBooking caddyBookings array for tee sheet compatibility
                    mainTeeBooking.caddyBookings.push({
                        golferId: userId,
                        caddyId: caddie.id,
                        golferName: currentUser.name,
                        caddyName: caddie.name,
                        caddyNumber: caddie.number || '000',
                        status: 'waitlisted',
                        isWaitlisted: true
                    });

                    toCreate.push({
                        id: `bk_${courseSlug}_${teeTime}_${userId}_caddie_waitlist_${caddie.id}`,
                        kind: 'caddie',
                        golferId: userId,
                        golferName: currentUser.name,
                        eventName: `Caddie Waitlist: ${caddie.name}`,
                        course: courseName,
                        courseName: courseName,
                        courseId: courseSlug,
                        date: date,
                        time: time,
                        teeTime: teeTime,
                        caddieId: caddie.id,
                        caddieName: caddie.name,
                        caddieNumber: caddie.number || '000',
                        status: 'waitlist',
                        groupId: groupId,
                        updatedAt: Date.now()
                    });
                });

                toCreate.push(mainTeeBooking);
                console.log('[confirmBooking] Added mainTeeBooking with kind:', mainTeeBooking.kind, 'groupId:', mainTeeBooking.groupId);
                console.log('[confirmBooking] mainTeeBooking FULL OBJECT:', JSON.stringify(mainTeeBooking, null, 2));
                console.log('[confirmBooking] courseSlug value:', courseSlug);
                console.log('[confirmBooking] courseName value:', courseName);
                console.log('[confirmBooking] mainTeeBooking.courseId:', mainTeeBooking.courseId);
                console.log('[confirmBooking] mainTeeBooking.teeSheetCourse:', mainTeeBooking.teeSheetCourse);

                // Services
                (bookingCart.services || []).forEach(service => {
                    toCreate.push({
                        id: `bk_${courseSlug}_${teeTime}_${userId}_service_${service.id}`,
                        kind: 'service',
                        golferId: userId,
                        golferName: currentUser.name,
                        eventName: `Service: ${service.name}`,
                        course: courseName,
                        courseName: courseName,
                        courseId: courseSlug,
                        date: date,
                        time: time,
                        teeTime: teeTime,
                        serviceId: service.id,
                        serviceName: service.name,
                        service: service.name,
                        status: 'confirmed',
                        groupId: groupId,
                        updatedAt: Date.now()
                    });
                });

                console.log('[confirmBooking] Creating', toCreate.length, 'bookings');

                // 3) Batch upsert locally (faster) - FIXED: Use batch mode to prevent race conditions
                BookingManager.batchMode = true; // Suppress individual saves
                console.log('[confirmBooking] BATCH MODE ENABLED - will save once after all bookings added');

                toCreate.forEach(b => {
                    try {
                        const addedBooking = BookingManager.addBooking(b);
                        if (b.kind === 'tee') {
                            console.log('[confirmBooking] TEE BOOKING ADDED - Verifying fields:');
                            console.log('[confirmBooking]   Input courseId:', b.courseId);
                            console.log('[confirmBooking]   Input teeSheetCourse:', b.teeSheetCourse);
                            console.log('[confirmBooking]   Returned courseId:', addedBooking.courseId);
                            console.log('[confirmBooking]   Returned teeSheetCourse:', addedBooking.teeSheetCourse);

                            // Also check what's in BookingManager.bookings
                            const savedBooking = BookingManager.bookings.find(bk => bk.id === addedBooking.id);
                            if (savedBooking) {
                                console.log('[confirmBooking]   In BookingManager.bookings courseId:', savedBooking.courseId);
                                console.log('[confirmBooking]   In BookingManager.bookings teeSheetCourse:', savedBooking.teeSheetCourse);
                            }
                        }
                    } catch (e) {
                        console.warn('[confirmBooking] addBooking failed, continuing', b.id, e);
                    }
                });

                // FIXED: Single save after all bookings added
                BookingManager.batchMode = false;
                console.log('[confirmBooking] BATCH MODE DISABLED - saving all', toCreate.length, 'bookings in one operation');
                BookingManager.saveToLocalStorage();

                // 4) Show success immediately & clear cart
                NotificationManager.show(`Booking confirmed!`, 'success');

                bookingCart = {
                    course: null,
                    caddies: [],
                    waitlists: [],
                    services: [],
                    paymentMethod: null,
                    totals: { courseTotal: 0, caddieTotal: 0, servicesTotal: 0, serviceCharge: 0, grandTotal: 0 }
                };
                updateBookingCartDisplay();

                // 5) Navigate to schedule immediately
                showGolferTab('schedule', null);

                // Refresh schedule UI immediately
                if (typeof ScheduleSystem !== 'undefined') {
                    ScheduleSystem.renderScheduleList();
                    ScheduleSystem.refreshStats();
                }

                // 6) Cloud sync in background (non-blocking)
                SimpleCloudSync.saveToCloud().catch(err => {
                    console.error('[confirmBooking] Cloud sync failed (non-critical):', err);
                });

            } catch (error) {
                console.error('[confirmBooking] Error:', error);
                NotificationManager.show(error.message || 'Booking failed', 'error');
            } finally {
                setTimeout(() => creatingBooking = false, 800);
            }
        }

        // Update existing functions to integrate with cart
        function bookCaddyFromBooking(caddieId, caddieName) {
            const caddie = CaddySystem.allCaddys.find(c => c.id === caddieId);
            if (caddie) {
                addCaddyToCart(caddie, 'booking');
            }
        }

        function joinWaitlistFromBooking(caddieId, caddieName) {
            const caddie = CaddySystem.allCaddys.find(c => c.id === caddieId);
            if (caddie) {
                addCaddyToCart(caddie, 'waitlist');
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initializeBookingSystem();
            }, 500);
        });

        // Advanced Chat System - LINE Style with Multi-Language Support

        // Chat search functions removed with old ChatSystem

        // Enhanced Caddy Management System
        const CaddySystem = {
            allCaddys: [
                // PATTANA GOLF RESORT & SPA (20 caddies)
                { id: 'pat002', number: '002', name: 'Sunan Rojana', rating: 4.8, experience: 12, languages: ['Thai', 'English', 'German'], avatar: '👨', photo: 'images/caddies/caddy5.jpg', specialty: 'Resort Experience', homeClub: 'pattana-golf-resort', availability: 'available', totalRounds: 3456, reviews: 421, personality: 'Luxury service focused', strengths: ['Resort Services', 'Guest Relations', 'Ocean Course'] },
                { id: 'pat003', number: '003', name: 'Ploy Siriwat', rating: 4.7, experience: 6, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy6.jpg', specialty: 'Spa & Golf Package', homeClub: 'pattana-golf-resort', availability: 'available', totalRounds: 1847, reviews: 198, personality: 'Relaxed and wellness-focused', strengths: ['Wellness Integration', 'Relaxation', 'Course Enjoyment'] },
                { id: 'pat004', number: '004', name: 'Anuwat Teerachai', rating: 4.6, experience: 9, languages: ['Thai', 'English', 'Russian'], avatar: '👨‍🦳', photo: 'images/caddies/caddy7.jpg', specialty: 'International Guests', homeClub: 'pattana-golf-resort', availability: 'booked', totalRounds: 2734, reviews: 312, personality: 'Cultural bridge specialist', strengths: ['Language Skills', 'Cultural Awareness', 'International Etiquette'] },
                { id: 'pat005', number: '005', name: 'Siriporn Nakamura', rating: 4.9, experience: 11, languages: ['Thai', 'English', 'Japanese'], avatar: '👩', photo: 'images/caddies/caddy8.jpg', specialty: 'International Service', homeClub: 'pattana-golf-resort', availability: 'available', totalRounds: 3921, reviews: 456, personality: 'Precise and culturally aware', strengths: ['Japanese Guests', 'Precision', 'Cultural Service'] },
                { id: 'pat006', number: '006', name: 'Kamon Srisuk', rating: 4.5, experience: 7, languages: ['Thai', 'English'], avatar: '👨', photo: 'images/caddies/caddy9.jpg', specialty: 'Ocean Course Expert', homeClub: 'pattana-golf-resort', availability: 'available', totalRounds: 2156, reviews: 234, personality: 'Ocean course specialist', strengths: ['Wind Reading', 'Coastal Play', 'Weather Adaptation'] },
                { id: 'pat007', number: '007', name: 'Niran Phongsri', rating: 4.7, experience: 10, languages: ['Thai', 'English', 'Chinese'], avatar: '👨‍🦲', photo: 'images/caddies/caddy10.jpg', specialty: 'VIP Championship', homeClub: 'pattana-golf-resort', availability: 'booked', totalRounds: 3245, reviews: 387, personality: 'Championship focused', strengths: ['Tournament Prep', 'Elite Service', 'Course Management'] },
                { id: 'pat008', number: '008', name: 'Wassana Chitpong', rating: 4.6, experience: 5, languages: ['Thai', 'English'], avatar: '👩‍🦱', photo: 'images/caddies/caddy11.jpg', specialty: 'Family Resort Golf', homeClub: 'pattana-golf-resort', availability: 'available', totalRounds: 1567, reviews: 178, personality: 'Family-oriented and fun', strengths: ['Family Groups', 'Resort Activities', 'Fun Golf'] },
                { id: 'pat009', number: '009', name: 'Thanapon Wira', rating: 4.8, experience: 14, languages: ['Thai', 'English', 'French'], avatar: '👨', photo: 'images/caddies/caddy12.jpg', specialty: 'Luxury Resort Service', homeClub: 'pattana-golf-resort', availability: 'available', totalRounds: 4123, reviews: 523, personality: 'Luxury service expert', strengths: ['Premium Service', 'Fine Dining', 'Resort Concierge'] },
                { id: 'pat010', number: '010', name: 'Kulthida Manee', rating: 4.7, experience: 8, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy13.jpg', specialty: 'Ladies Golf Specialist', homeClub: 'pattana-golf-resort', availability: 'available', totalRounds: 2234, reviews: 267, personality: 'Supportive and encouraging', strengths: ['Ladies Golf', 'Technique Teaching', 'Confidence Building'] },
                { id: 'pat011', number: '011', name: 'Sombat Rattana', rating: 4.9, experience: 16, languages: ['Thai', 'English', 'Korean'], avatar: '👨‍🦳', photo: 'images/caddies/caddy14.jpg', specialty: 'Master Caddy', homeClub: 'pattana-golf-resort', availability: 'available', totalRounds: 5234, reviews: 634, personality: 'Master of the course', strengths: ['Course History', 'Expert Knowledge', 'Elite Guidance'] },
                { id: 'pat012', number: '012', name: 'Pensri Kamal', rating: 4.5, experience: 4, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy15.jpg', specialty: 'New Golfer Support', homeClub: 'pattana-golf-resort', availability: 'available', totalRounds: 1123, reviews: 134, personality: 'Patient and teaching-focused', strengths: ['Beginner Support', 'Basic Instruction', 'Encouragement'] },
                { id: 'pat013', number: '013', name: 'Wichai Thongchai', rating: 4.6, experience: 9, languages: ['Thai', 'English', 'Spanish'], avatar: '👨', photo: 'images/caddies/caddy16.jpg', specialty: 'International Tourism', homeClub: 'pattana-golf-resort', availability: 'booked', totalRounds: 2567, reviews: 298, personality: 'Tourism and hospitality expert', strengths: ['Tourism Knowledge', 'Local Culture', 'Hospitality'] },
                { id: 'pat014', number: '014', name: 'Siriporn Jaidee', rating: 4.8, experience: 11, languages: ['Thai', 'English', 'Japanese'], avatar: '👩‍🦲', photo: 'images/caddies/caddy17.jpg', specialty: 'Precision Golf', homeClub: 'pattana-golf-resort', availability: 'available', totalRounds: 3456, reviews: 412, personality: 'Precision and technique focused', strengths: ['Technical Analysis', 'Precision Play', 'Shot Planning'] },
                { id: 'pat015', number: '015', name: 'Charn Wongsa', rating: 4.7, experience: 13, languages: ['Thai', 'English', 'Chinese'], avatar: '👨', photo: 'images/caddies/caddy18.jpg', specialty: 'Business Golf', homeClub: 'pattana-golf-resort', availability: 'available', totalRounds: 3834, reviews: 445, personality: 'Business-focused and professional', strengths: ['Business Etiquette', 'Networking Support', 'Professional Service'] },
                { id: 'pat016', number: '016', name: 'Mayuree Tanin', rating: 4.5, experience: 6, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy19.jpg', specialty: 'Resort Leisure Golf', homeClub: 'pattana-golf-resort', availability: 'available', totalRounds: 1789, reviews: 201, personality: 'Leisure and relaxation focused', strengths: ['Leisure Golf', 'Relaxation', 'Resort Experience'] },
                { id: 'pat017', number: '017', name: 'Narong Sila', rating: 4.8, experience: 10, languages: ['Thai', 'English', 'Italian'], avatar: '👨‍🦲', photo: 'images/caddies/caddy20.jpg', specialty: 'European Guests', homeClub: 'pattana-golf-resort', availability: 'booked', totalRounds: 2923, reviews: 356, personality: 'European culture specialist', strengths: ['European Customs', 'Cultural Adaptation', 'International Service'] },
                { id: 'pat018', number: '018', name: 'Amporn Ritual', rating: 4.6, experience: 7, languages: ['Thai', 'English'], avatar: '👩‍🦱', photo: 'images/caddies/caddy21.jpg', specialty: 'Course Photography', homeClub: 'pattana-golf-resort', availability: 'available', totalRounds: 2012, reviews: 234, personality: 'Artistic and scenic focused', strengths: ['Photo Spots', 'Scenic Views', 'Memory Making'] },
                { id: 'pat019', number: '019', name: 'Preecha Nawin', rating: 4.9, experience: 15, languages: ['Thai', 'English', 'Arabic'], avatar: '👨', photo: 'images/caddies/caddy22.jpg', specialty: 'Premium Championship', homeClub: 'pattana-golf-resort', availability: 'available', totalRounds: 4567, reviews: 556, personality: 'Championship excellence focused', strengths: ['Elite Performance', 'Championship Standards', 'Premium Service'] },
                { id: 'pat020', number: '020', name: 'Ratana Sompong', rating: 4.7, experience: 8, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy23.jpg', specialty: 'Wellness Golf', homeClub: 'pattana-golf-resort', availability: 'available', totalRounds: 2345, reviews: 278, personality: 'Health and wellness focused', strengths: ['Wellness Integration', 'Health Benefits', 'Mindful Golf'] },

                // PATTAYA GOLF CLUB (20 caddies)
                { id: 'pat001', number: '001', name: 'Ning Prasert', rating: 4.9, experience: 8, languages: ['Thai', 'English'], avatar: '👨‍🦲', photo: 'images/caddies/caddy24.jpg', specialty: 'Championship Course', homeClub: 'pattana-golf-resort', availability: 'booked', totalRounds: 3, reviews: 2, personality: 'Professional and detail-oriented', strengths: ['Course Knowledge', 'Club Selection', 'Reading Greens'], currentBooking: { date: '2025-01-15', time: '09:00', golfer: 'Sarah Johnson', holes: 18 } },
                { id: 'pgc002', number: '002', name: 'Malee Wongsiri', rating: 4.6, experience: 5, languages: ['Thai', 'English'], avatar: '👩‍🦱', photo: 'images/caddies/caddy25.jpg', specialty: 'Family & Beginner', homeClub: 'pattaya-golf', availability: 'available', totalRounds: 1234, reviews: 156, personality: 'Fun and family-friendly', strengths: ['Family Groups', 'Beginner Instruction', 'Fun Atmosphere'] },
                { id: 'pgc003', number: '003', name: 'Somsak Thiwat', rating: 4.8, experience: 12, languages: ['Thai', 'English', 'German'], avatar: '👨', photo: 'images/caddies/caddy1.jpg', specialty: 'City Course Expert', homeClub: 'pattaya-golf', availability: 'booked', totalRounds: 3567, reviews: 423, personality: 'Urban golf specialist', strengths: ['City Course', 'Traffic Management', 'Urban Golf'] },
                { id: 'pgc004', number: '004', name: 'Pranee Kaewta', rating: 4.7, experience: 9, languages: ['Thai', 'English', 'Russian'], avatar: '👩', photo: 'images/caddies/caddy2.jpg', specialty: 'Tourist Groups', homeClub: 'pattaya-golf', availability: 'available', totalRounds: 2456, reviews: 289, personality: 'Tourist-friendly and helpful', strengths: ['Tourist Groups', 'City Knowledge', 'Entertainment Golf'] },
                { id: 'pgc005', number: '005', name: 'Chalerm Sarit', rating: 4.5, experience: 6, languages: ['Thai', 'English'], avatar: '👨‍🦳', photo: 'images/caddies/caddy3.jpg', specialty: 'Quick Play Expert', homeClub: 'pattaya-golf', availability: 'available', totalRounds: 1876, reviews: 212, personality: 'Efficient and quick', strengths: ['Fast Play', 'Time Management', 'Efficient Service'] },
                { id: 'pgc006', number: '006', name: 'Wipob Srinuan', rating: 4.8, experience: 11, languages: ['Thai', 'English', 'Chinese'], avatar: '👨', photo: 'images/caddies/caddy4.jpg', specialty: 'Business Meetings', homeClub: 'pattaya-golf', availability: 'available', totalRounds: 3234, reviews: 378, personality: 'Business professional', strengths: ['Business Golf', 'Meeting Support', 'Professional Networking'] },
                { id: 'pgc007', number: '007', name: 'Suchada Prom', rating: 4.6, experience: 7, languages: ['Thai', 'English'], avatar: '👩‍🦲', photo: 'images/caddies/caddy5.jpg', specialty: 'Ladies Golf', homeClub: 'pattaya-golf', availability: 'booked', totalRounds: 2123, reviews: 245, personality: 'Ladies golf specialist', strengths: ['Ladies Golf', 'Technique Tips', 'Social Golf'] },
                { id: 'pgc008', number: '008', name: 'Thawee Bunma', rating: 4.7, experience: 10, languages: ['Thai', 'English', 'Japanese'], avatar: '👨', photo: 'images/caddies/caddy6.jpg', specialty: 'Traditional Golf', homeClub: 'pattaya-golf', availability: 'available', totalRounds: 2897, reviews: 334, personality: 'Traditional golf purist', strengths: ['Golf Traditions', 'Classic Techniques', 'Golf History'] },
                { id: 'pgc009', number: '009', name: 'Naree Thong', rating: 4.5, experience: 4, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy7.jpg', specialty: 'Beginner Support', homeClub: 'pattaya-golf', availability: 'available', totalRounds: 1345, reviews: 156, personality: 'Patient teacher', strengths: ['Beginner Instruction', 'Basic Techniques', 'Encouragement'] },
                { id: 'pgc010', number: '010', name: 'Bancha Kraison', rating: 4.9, experience: 14, languages: ['Thai', 'English', 'Korean'], avatar: '👨‍🦲', photo: 'images/caddies/caddy8.jpg', specialty: 'Pro Shop Integration', homeClub: 'pattaya-golf', availability: 'available', totalRounds: 4123, reviews: 498, personality: 'Equipment expert', strengths: ['Equipment Knowledge', 'Pro Shop Services', 'Golf Technology'] },
                { id: 'pgc011', number: '011', name: 'Oranuch Sinam', rating: 4.6, experience: 8, languages: ['Thai', 'English'], avatar: '👩‍🦱', photo: 'images/caddies/caddy9.jpg', specialty: 'Social Golf', homeClub: 'pattaya-golf', availability: 'available', totalRounds: 2234, reviews: 267, personality: 'Social and networking focused', strengths: ['Social Events', 'Group Management', 'Golf Networking'] },
                { id: 'pgc012', number: '012', name: 'Kitti Wongsawan', rating: 4.8, experience: 13, languages: ['Thai', 'English', 'French'], avatar: '👨', photo: 'images/caddies/caddy10.jpg', specialty: 'Restaurant Integration', homeClub: 'pattaya-golf', availability: 'booked', totalRounds: 3678, reviews: 445, personality: 'Hospitality expert', strengths: ['Restaurant Services', 'Dining Integration', 'Hospitality'] },
                { id: 'pgc013', number: '013', name: 'Sirilak Janya', rating: 4.7, experience: 9, languages: ['Thai', 'English', 'Spanish'], avatar: '👩', photo: 'images/caddies/caddy11.jpg', specialty: 'Event Golf', homeClub: 'pattaya-golf', availability: 'available', totalRounds: 2567, reviews: 301, personality: 'Event coordination expert', strengths: ['Event Management', 'Group Coordination', 'Special Occasions'] },
                { id: 'pgc014', number: '014', name: 'Prapat Sanoh', rating: 4.5, experience: 5, languages: ['Thai', 'English'], avatar: '👨‍🦳', photo: 'images/caddies/caddy12.jpg', specialty: 'City Tourism Golf', homeClub: 'pattaya-golf', availability: 'available', totalRounds: 1654, reviews: 189, personality: 'City tourism expert', strengths: ['City Tours', 'Local Attractions', 'Tourism Golf'] },
                { id: 'pgc015', number: '015', name: 'Wilai Precha', rating: 4.8, experience: 11, languages: ['Thai', 'English', 'Italian'], avatar: '👩', photo: 'images/caddies/caddy13.jpg', specialty: 'Cultural Golf Tours', homeClub: 'pattaya-golf', availability: 'available', totalRounds: 3123, reviews: 376, personality: 'Cultural tour specialist', strengths: ['Cultural Integration', 'Local Culture', 'Educational Golf'] },
                { id: 'pgc016', number: '016', name: 'Chai Promma', rating: 4.6, experience: 7, languages: ['Thai', 'English'], avatar: '👨', photo: 'images/caddies/caddy14.jpg', specialty: 'Fitness Golf', homeClub: 'pattaya-golf', availability: 'available', totalRounds: 1987, reviews: 234, personality: 'Fitness and health focused', strengths: ['Golf Fitness', 'Health Benefits', 'Physical Conditioning'] },
                { id: 'pgc017', number: '017', name: 'Sunisa Kruea', rating: 4.7, experience: 10, languages: ['Thai', 'English', 'Chinese'], avatar: '👩‍🦲', photo: 'images/caddies/caddy15.jpg', specialty: 'Shopping Tour Golf', homeClub: 'pattaya-golf', availability: 'booked', totalRounds: 2876, reviews: 334, personality: 'Shopping and leisure expert', strengths: ['Shopping Tours', 'Leisure Activities', 'Entertainment'] },
                { id: 'pgc018', number: '018', name: 'Amnuay Thani', rating: 4.9, experience: 15, languages: ['Thai', 'English', 'Arabic'], avatar: '👨', photo: 'images/caddies/caddy16.jpg', specialty: 'VIP City Service', homeClub: 'pattaya-golf', availability: 'available', totalRounds: 4456, reviews: 534, personality: 'VIP city service expert', strengths: ['VIP Services', 'City Elite', 'Premium Urban Golf'] },
                { id: 'pgc019', number: '019', name: 'Duangjai Sila', rating: 4.5, experience: 6, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy17.jpg', specialty: 'Photography Golf', homeClub: 'pattaya-golf', availability: 'available', totalRounds: 1765, reviews: 201, personality: 'Photography enthusiast', strengths: ['Golf Photography', 'Scenic Shots', 'Memory Capture'] },
                { id: 'pgc020', number: '020', name: 'Wasan Kaew', rating: 4.8, experience: 12, languages: ['Thai', 'English', 'Portuguese'], avatar: '👨‍🦲', photo: 'images/caddies/caddy18.jpg', specialty: 'International Business', homeClub: 'pattaya-golf', availability: 'available', totalRounds: 3567, reviews: 423, personality: 'International business expert', strengths: ['Business Deals', 'International Relations', 'Corporate Golf'] },

                // THAI COUNTRY CLUB (20 caddies)
                { id: 'tcc001', name: 'Somchai Jaidee', rating: 4.8, experience: 12, languages: ['Thai', 'English', 'Japanese'], avatar: '👨', photo: 'images/caddies/caddy19.jpg', specialty: 'Strategy & Mental Game', homeClub: 'thai-country-club', availability: 'booked', totalRounds: 4238, reviews: 512, personality: 'Calm and strategic thinker', strengths: ['Mental Coaching', 'Course Strategy', 'Pressure Management'] },
                { id: 'tcc002', name: 'Pongsak Rattana', rating: 4.8, experience: 10, languages: ['Thai', 'English', 'Korean'], avatar: '👨', photo: 'images/caddies/caddy20.jpg', specialty: 'Tournament Play', homeClub: 'thai-country-club', availability: 'available', totalRounds: 3456, reviews: 387, personality: 'Competitive and precise', strengths: ['Tournament Experience', 'Precision', 'Competitive Play'] },
                { id: 'tcc003', name: 'Apichat Seeda', rating: 4.9, experience: 16, languages: ['Thai', 'English', 'Chinese'], avatar: '👨‍🦳', photo: 'images/caddies/caddy21.jpg', specialty: 'Championship Master', homeClub: 'thai-country-club', availability: 'available', totalRounds: 5234, reviews: 634, personality: 'Championship excellence', strengths: ['Elite Performance', 'Championship History', 'Master Guidance'] },
                { id: 'tcc004', name: 'Sirada Komon', rating: 4.7, experience: 9, languages: ['Thai', 'English', 'German'], avatar: '👩', photo: 'images/caddies/caddy22.jpg', specialty: 'VIP Tournament Service', homeClub: 'thai-country-club', availability: 'booked', totalRounds: 2876, reviews: 345, personality: 'VIP service specialist', strengths: ['VIP Treatment', 'Tournament Prep', 'Elite Service'] },
                { id: 'tcc005', name: 'Weerawat Pansa', rating: 4.8, experience: 13, languages: ['Thai', 'English', 'Japanese'], avatar: '👨', photo: 'images/caddies/caddy23.jpg', specialty: 'Professional Training', homeClub: 'thai-country-club', availability: 'available', totalRounds: 3967, reviews: 478, personality: 'Professional coach', strengths: ['Professional Training', 'Skill Development', 'Performance Analysis'] },
                { id: 'tcc006', name: 'Montra Theerasak', rating: 4.6, experience: 7, languages: ['Thai', 'English'], avatar: '👩‍🦱', photo: 'images/caddies/caddy24.jpg', specialty: 'Ladies Tournament', homeClub: 'thai-country-club', availability: 'available', totalRounds: 2123, reviews: 256, personality: 'Ladies golf champion supporter', strengths: ['Ladies Golf', 'Tournament Support', 'Competitive Ladies'] },
                { id: 'tcc007', name: 'Thana Rojvorakul', rating: 4.9, experience: 15, languages: ['Thai', 'English', 'French'], avatar: '👨‍🦲', photo: 'images/caddies/caddy25.jpg', specialty: 'Luxury Tournament', homeClub: 'thai-country-club', availability: 'available', totalRounds: 4567, reviews: 567, personality: 'Luxury tournament expert', strengths: ['Luxury Events', 'Premium Tournaments', 'Elite Competitions'] },
                { id: 'tcc008', name: 'Sasithorn Niran', rating: 4.7, experience: 11, languages: ['Thai', 'English', 'Russian'], avatar: '👩', photo: 'images/caddies/caddy1.jpg', specialty: 'International Tournaments', homeClub: 'thai-country-club', availability: 'booked', totalRounds: 3234, reviews: 389, personality: 'International competition expert', strengths: ['International Events', 'Global Standards', 'Cross-Cultural Competition'] },
                { id: 'tcc009', name: 'Krisada Manop', rating: 4.5, experience: 6, languages: ['Thai', 'English'], avatar: '👨', photo: 'images/caddies/caddy2.jpg', specialty: 'Junior Development', homeClub: 'thai-country-club', availability: 'available', totalRounds: 1876, reviews: 212, personality: 'Youth development focused', strengths: ['Junior Golf', 'Youth Training', 'Future Champions'] },
                { id: 'tcc010', name: 'Pensiri Tawan', rating: 4.8, experience: 12, languages: ['Thai', 'English', 'Spanish'], avatar: '👩‍🦲', photo: 'images/caddies/caddy3.jpg', specialty: 'Performance Analytics', homeClub: 'thai-country-club', availability: 'available', totalRounds: 3456, reviews: 423, personality: 'Data and performance expert', strengths: ['Performance Data', 'Analytics', 'Improvement Tracking'] },
                { id: 'tcc011', name: 'Natthawut Siri', rating: 4.6, experience: 8, languages: ['Thai', 'English', 'Korean'], avatar: '👨‍🦳', photo: 'images/caddies/caddy4.jpg', specialty: 'Equipment Specialist', homeClub: 'thai-country-club', availability: 'available', totalRounds: 2567, reviews: 298, personality: 'Equipment technology expert', strengths: ['Equipment Analysis', 'Technology Integration', 'Gear Optimization'] },
                { id: 'tcc012', name: 'Waraporn Chai', rating: 4.7, experience: 10, languages: ['Thai', 'English', 'Chinese'], avatar: '👩', photo: 'images/caddies/caddy5.jpg', specialty: 'Mental Performance', homeClub: 'thai-country-club', availability: 'available', totalRounds: 2987, reviews: 356, personality: 'Mental game specialist', strengths: ['Mental Training', 'Psychological Support', 'Focus Enhancement'] },
                { id: 'tcc013', name: 'Samart Thong', rating: 4.9, experience: 14, languages: ['Thai', 'English', 'Arabic'], avatar: '👨', photo: 'images/caddies/caddy6.jpg', specialty: 'Elite Championship', homeClub: 'thai-country-club', availability: 'booked', totalRounds: 4123, reviews: 501, personality: 'Elite championship expert', strengths: ['Elite Competition', 'Championship Mindset', 'Winning Strategy'] },
                { id: 'tcc014', name: 'Kannika Prapat', rating: 4.5, experience: 5, languages: ['Thai', 'English'], avatar: '👩‍🦱', photo: 'images/caddies/caddy7.jpg', specialty: 'Fitness Integration', homeClub: 'thai-country-club', availability: 'available', totalRounds: 1567, reviews: 178, personality: 'Fitness and golf integration', strengths: ['Golf Fitness', 'Physical Conditioning', 'Strength Training'] },
                { id: 'tcc015', name: 'Vitoon Sanit', rating: 4.8, experience: 11, languages: ['Thai', 'English', 'Italian'], avatar: '👨', photo: 'images/caddies/caddy8.jpg', specialty: 'Course Record Expert', homeClub: 'thai-country-club', availability: 'available', totalRounds: 3234, reviews: 389, personality: 'Course record specialist', strengths: ['Course Records', 'Historical Knowledge', 'Achievement Support'] },
                { id: 'tcc016', name: 'Praneet Wila', rating: 4.6, experience: 7, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy9.jpg', specialty: 'Sponsor Relations', homeClub: 'thai-country-club', availability: 'available', totalRounds: 2123, reviews: 245, personality: 'Sponsor and media expert', strengths: ['Sponsor Relations', 'Media Management', 'PR Support'] },
                { id: 'tcc017', name: 'Somsiri Thawi', rating: 4.7, experience: 9, languages: ['Thai', 'English', 'Portuguese'], avatar: '👩‍🦲', photo: 'images/caddies/caddy10.jpg', specialty: 'International Media', homeClub: 'thai-country-club', availability: 'available', totalRounds: 2678, reviews: 312, personality: 'International media specialist', strengths: ['Media Relations', 'International Press', 'Tournament Coverage'] },
                { id: 'tcc018', name: 'Worawit Kiat', rating: 4.9, experience: 17, languages: ['Thai', 'English', 'Mandarin'], avatar: '👨‍🦳', photo: 'images/caddies/caddy11.jpg', specialty: 'World-Class Tournament', homeClub: 'thai-country-club', availability: 'available', totalRounds: 5678, reviews: 678, personality: 'World-class tournament veteran', strengths: ['World Championships', 'Global Events', 'Elite Standards'] },
                { id: 'tcc019', name: 'Siripen Nawa', rating: 4.5, experience: 6, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy12.jpg', specialty: 'Digital Integration', homeClub: 'thai-country-club', availability: 'available', totalRounds: 1789, reviews: 201, personality: 'Digital technology expert', strengths: ['Digital Scoring', 'Technology Integration', 'Modern Golf'] },
                { id: 'tcc020', name: 'Precha Manat', rating: 4.8, experience: 13, languages: ['Thai', 'English', 'Hindi'], avatar: '👨', photo: 'images/caddies/caddy13.jpg', specialty: 'Championship Legacy', homeClub: 'thai-country-club', availability: 'booked', totalRounds: 3876, reviews: 456, personality: 'Championship legacy keeper', strengths: ['Tournament History', 'Legacy Management', 'Championship Culture'] },

                // SIAM PLANTATION GOLF CLUB (20 caddies)
                { id: 'siam001', name: 'Apinya Thaworn', rating: 4.7, experience: 6, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy14.jpg', specialty: 'Executive Course', homeClub: 'siam-plantation', availability: 'available', totalRounds: 1847, reviews: 198, personality: 'Encouraging and patient', strengths: ['Teaching', 'Beginner Support', 'Positive Energy'] },
                { id: 'siam002', name: 'Siriporn Nakamura', rating: 4.9, experience: 11, languages: ['Thai', 'English', 'Japanese'], avatar: '👩', photo: 'images/caddies/caddy15.jpg', specialty: 'International Service', homeClub: 'siam-plantation', availability: 'booked', totalRounds: 3987, reviews: 445, personality: 'Culturally aware and professional', strengths: ['International Guests', 'Cultural Bridge', 'Multi-lingual'] },
    { id: 'siam003', name: 'Kritsana Wichit', rating: 4.6, experience: 8, languages: ['Thai', 'English'], avatar: '👨', photo: 'images/caddies/caddy16.jpg', specialty: 'Tropical Golf', homeClub: 'siam-plantation', availability: 'available', totalRounds: 2234, reviews: 267, personality: 'Nature lover and relaxed', strengths: ['Tropical Course', 'Nature Integration', 'Relaxed Golf'] },
    { id: 'siam004', name: 'Pensri Malai', rating: 4.8, experience: 10, languages: ['Thai', 'English', 'Chinese'], avatar: '👩‍🦱', photo: 'images/caddies/caddy17.jpg', specialty: 'Resort Family Golf', homeClub: 'siam-plantation', availability: 'available', totalRounds: 2876, reviews: 334, personality: 'Family-focused and fun', strengths: ['Family Golf', 'Resort Activities', 'Fun Experiences'] },
    { id: 'siam005', name: 'Suthat Boonma', rating: 4.5, experience: 5, languages: ['Thai', 'English'], avatar: '👨‍🦲', photo: 'images/caddies/caddy18.jpg', specialty: 'Beginner Plantation', homeClub: 'siam-plantation', availability: 'available', totalRounds: 1456, reviews: 167, personality: 'Patient teacher', strengths: ['Beginner Support', 'Basic Skills', 'Encouragement'] },
    { id: 'siam006', name: 'Wanlapa Siri', rating: 4.7, experience: 9, languages: ['Thai', 'English', 'German'], avatar: '👩', photo: 'images/caddies/caddy19.jpg', specialty: 'Landscape Golf', homeClub: 'siam-plantation', availability: 'booked', totalRounds: 2567, reviews: 298, personality: 'Scenic and artistic', strengths: ['Landscape Appreciation', 'Scenic Golf', 'Photography'] },
    { id: 'siam007', name: 'Chalermpol Thani', rating: 4.9, experience: 14, languages: ['Thai', 'English', 'French'], avatar: '👨', photo: 'images/caddies/caddy20.jpg', specialty: 'Luxury Plantation', homeClub: 'siam-plantation', availability: 'available', totalRounds: 3789, reviews: 456, personality: 'Luxury resort specialist', strengths: ['Luxury Service', 'Fine Golf', 'Resort Excellence'] },
    { id: 'siam008', name: 'Suchitra Kwan', rating: 4.6, experience: 7, languages: ['Thai', 'English'], avatar: '👩‍🦲', photo: 'images/caddies/caddy21.jpg', specialty: 'Health & Wellness Golf', homeClub: 'siam-plantation', availability: 'available', totalRounds: 1987, reviews: 234, personality: 'Health and wellness focused', strengths: ['Wellness Golf', 'Health Benefits', 'Mindful Play'] },
    { id: 'siam009', name: 'Preecha Sombat', rating: 4.8, experience: 12, languages: ['Thai', 'English', 'Korean'], avatar: '👨‍🦳', photo: 'images/caddies/caddy22.jpg', specialty: 'Corporate Plantation', homeClub: 'siam-plantation', availability: 'available', totalRounds: 3234, reviews: 389, personality: 'Corporate golf specialist', strengths: ['Business Golf', 'Corporate Events', 'Professional Service'] },
    { id: 'siam010', name: 'Sirilak Prasert', rating: 4.7, experience: 8, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy23.jpg', specialty: 'Ladies Plantation Golf', homeClub: 'siam-plantation', availability: 'available', totalRounds: 2345, reviews: 278, personality: 'Ladies golf supporter', strengths: ['Ladies Golf', 'Social Golf', 'Group Play'] },
    { id: 'siam011', name: 'Thaworn Chai', rating: 4.5, experience: 6, languages: ['Thai', 'English'], avatar: '👨', photo: 'images/caddies/caddy24.jpg', specialty: 'Quick Resort Rounds', homeClub: 'siam-plantation', availability: 'available', totalRounds: 1678, reviews: 189, personality: 'Efficient and friendly', strengths: ['Quick Play', 'Time Management', 'Efficient Service'] },
    { id: 'siam012', name: 'Napaporn Wila', rating: 4.8, experience: 11, languages: ['Thai', 'English', 'Spanish'], avatar: '👩‍🦱', photo: 'images/caddies/caddy25.jpg', specialty: 'International Resort', homeClub: 'siam-plantation', availability: 'booked', totalRounds: 2987, reviews: 356, personality: 'International hospitality expert', strengths: ['International Service', 'Resort Hospitality', 'Cultural Awareness'] },
    { id: 'siam013', name: 'Somjit Krung', rating: 4.6, experience: 9, languages: ['Thai', 'English', 'Russian'], avatar: '👨', photo: 'images/caddies/caddy1.jpg', specialty: 'Tropical Course Expert', homeClub: 'siam-plantation', availability: 'available', totalRounds: 2456, reviews: 289, personality: 'Tropical golf specialist', strengths: ['Tropical Conditions', 'Weather Adaptation', 'Seasonal Golf'] },
    { id: 'siam014', name: 'Siriphan Thong', rating: 4.7, experience: 10, languages: ['Thai', 'English', 'Italian'], avatar: '👩', photo: 'images/caddies/caddy2.jpg', specialty: 'Resort Entertainment', homeClub: 'siam-plantation', availability: 'available', totalRounds: 2678, reviews: 312, personality: 'Entertainment and fun focused', strengths: ['Entertainment Golf', 'Fun Activities', 'Resort Events'] },
    { id: 'siam015', name: 'Wichan Sila', rating: 4.9, experience: 15, languages: ['Thai', 'English', 'Mandarin'], avatar: '👨‍🦲', photo: 'images/caddies/caddy3.jpg', specialty: 'Master Plantation', homeClub: 'siam-plantation', availability: 'available', totalRounds: 4123, reviews: 501, personality: 'Plantation course master', strengths: ['Course Mastery', 'Tropical Expertise', 'Elite Guidance'] },
    { id: 'siam016', name: 'Pensook Niran', rating: 4.5, experience: 4, languages: ['Thai', 'English'], avatar: '👩‍🦲', photo: 'images/caddies/caddy4.jpg', specialty: 'Family Friendly Golf', homeClub: 'siam-plantation', availability: 'available', totalRounds: 1234, reviews: 145, personality: 'Family-oriented and patient', strengths: ['Family Support', 'Kid-Friendly', 'Patient Teaching'] },
    { id: 'siam017', name: 'Manit Jaidee', rating: 4.8, experience: 13, languages: ['Thai', 'English', 'Portuguese'], avatar: '👨', photo: 'images/caddies/caddy5.jpg', specialty: 'Nature Photography Golf', homeClub: 'siam-plantation', availability: 'available', totalRounds: 3567, reviews: 423, personality: 'Nature and photography enthusiast', strengths: ['Nature Photography', 'Scenic Golf', 'Environmental Awareness'] },
    { id: 'siam018', name: 'Sirisuda Prom', rating: 4.6, experience: 7, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy6.jpg', specialty: 'Spa Golf Integration', homeClub: 'siam-plantation', availability: 'available', totalRounds: 1876, reviews: 212, personality: 'Spa and wellness integration', strengths: ['Spa Services', 'Wellness Integration', 'Relaxation Golf'] },
    { id: 'siam019', name: 'Watchara Somboon', rating: 4.7, experience: 11, languages: ['Thai', 'English', 'Hindi'], avatar: '👨‍🦳', photo: 'images/caddies/caddy7.jpg', specialty: 'Cultural Plantation Golf', homeClub: 'siam-plantation', availability: 'booked', totalRounds: 2987, reviews: 356, personality: 'Cultural integration specialist', strengths: ['Cultural Golf', 'Local Traditions', 'Educational Golf'] },
    { id: 'siam020', name: 'Siriporn Chawla', rating: 4.8, experience: 12, languages: ['Thai', 'English', 'Arabic'], avatar: '👩', photo: 'images/caddies/caddy8.jpg', specialty: 'Luxury Tropical Service', homeClub: 'siam-plantation', availability: 'available', totalRounds: 3234, reviews: 389, personality: 'Luxury tropical specialist', strengths: ['Luxury Tropical', 'Premium Service', 'Elite Plantation Golf'] },

    // ROYAL GARDEN GOLF CLUB (20 caddies)
    { id: 'royal001', name: 'Chaiwat Suksan', rating: 4.9, experience: 15, languages: ['Thai', 'English', 'Chinese'], avatar: '👨‍🦳', photo: 'images/caddies/caddy9.jpg', specialty: 'VIP Luxury Service', homeClub: 'royal-garden', availability: 'booked', totalRounds: 5847, reviews: 695, personality: 'Luxury service specialist', strengths: ['VIP Experience', 'Cultural Knowledge', 'Luxury Service'] },
    { id: 'royal002', name: 'Thanakit Suwan', rating: 4.7, experience: 7, languages: ['Thai', 'English'], avatar: '👨‍🦱', photo: 'images/caddies/caddy10.jpg', specialty: 'Course Photography', homeClub: 'royal-garden', availability: 'available', totalRounds: 2134, reviews: 243, personality: 'Creative and observant', strengths: ['Photography', 'Scenic Knowledge', 'Social Media'] },
    { id: 'royal003', name: 'Siriporn Kamal', rating: 4.8, experience: 12, languages: ['Thai', 'English', 'Japanese'], avatar: '👩', photo: 'images/caddies/caddy11.jpg', specialty: 'Executive Golf', homeClub: 'royal-garden', availability: 'available', totalRounds: 3456, reviews: 412, personality: 'Executive service focused', strengths: ['Executive Golf', 'Business Support', 'Professional Service'] },
    { id: 'royal004', name: 'Wichit Thani', rating: 4.6, experience: 8, languages: ['Thai', 'English', 'Korean'], avatar: '👨', photo: 'images/caddies/caddy12.jpg', specialty: 'Quick Executive Rounds', homeClub: 'royal-garden', availability: 'available', totalRounds: 2234, reviews: 267, personality: 'Efficient and professional', strengths: ['Quick Play', 'Executive Efficiency', 'Time Management'] },
    { id: 'royal005', name: 'Malai Siri', rating: 4.7, experience: 10, languages: ['Thai', 'English', 'German'], avatar: '👩‍🦱', photo: 'images/caddies/caddy13.jpg', specialty: 'Beginner Executive', homeClub: 'royal-garden', availability: 'booked', totalRounds: 2876, reviews: 334, personality: 'Patient and encouraging', strengths: ['Beginner Support', 'Executive Teaching', 'Confidence Building'] },
    { id: 'royal006', name: 'Prasert Chai', rating: 4.5, experience: 5, languages: ['Thai', 'English'], avatar: '👨‍🦲', photo: 'images/caddies/caddy14.jpg', specialty: 'Family Executive Golf', homeClub: 'royal-garden', availability: 'available', totalRounds: 1567, reviews: 178, personality: 'Family-friendly', strengths: ['Family Golf', 'Kid Support', 'Fun Executive Golf'] },
    { id: 'royal007', name: 'Sirilak Wongsa', rating: 4.9, experience: 14, languages: ['Thai', 'English', 'French'], avatar: '👩', photo: 'images/caddies/caddy15.jpg', specialty: 'Luxury Executive', homeClub: 'royal-garden', availability: 'available', totalRounds: 3789, reviews: 456, personality: 'Luxury and elegance focused', strengths: ['Luxury Service', 'Elegant Golf', 'Premium Executive'] },
    { id: 'royal008', name: 'Narong Phet', rating: 4.6, experience: 6, languages: ['Thai', 'English'], avatar: '👨', photo: 'images/caddies/caddy16.jpg', specialty: 'Corporate Executive', homeClub: 'royal-garden', availability: 'available', totalRounds: 1789, reviews: 201, personality: 'Corporate focused', strengths: ['Corporate Golf', 'Business Networking', 'Executive Events'] },
    { id: 'royal009', name: 'Pensri Niran', rating: 4.8, experience: 11, languages: ['Thai', 'English', 'Spanish'], avatar: '👩‍🦲', photo: 'images/caddies/caddy17.jpg', specialty: 'Ladies Executive Golf', homeClub: 'royal-garden', availability: 'available', totalRounds: 3123, reviews: 376, personality: 'Ladies golf champion', strengths: ['Ladies Golf', 'Executive Ladies', 'Social Golf'] },
    { id: 'royal010', name: 'Somsak Krung', rating: 4.7, experience: 9, languages: ['Thai', 'English', 'Chinese'], avatar: '👨‍🦳', photo: 'images/caddies/caddy18.jpg', specialty: 'Business Executive Golf', homeClub: 'royal-garden', availability: 'available', totalRounds: 2567, reviews: 298, personality: 'Business golf specialist', strengths: ['Business Golf', 'Deal Making', 'Executive Networking'] },
    { id: 'royal011', name: 'Wipada Sila', rating: 4.5, experience: 4, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy19.jpg', specialty: 'Relaxed Executive', homeClub: 'royal-garden', availability: 'available', totalRounds: 1345, reviews: 156, personality: 'Relaxed and easygoing', strengths: ['Relaxed Golf', 'Stress Relief', 'Easy Executive'] },
    { id: 'royal012', name: 'Thawee Jaidee', rating: 4.8, experience: 13, languages: ['Thai', 'English', 'Russian'], avatar: '👨', photo: 'images/caddies/caddy20.jpg', specialty: 'International Executive', homeClub: 'royal-garden', availability: 'booked', totalRounds: 3678, reviews: 445, personality: 'International business expert', strengths: ['International Golf', 'Cultural Bridge', 'Global Executive'] },
    { id: 'royal013', name: 'Siriphan Thong', rating: 4.6, experience: 7, languages: ['Thai', 'English'], avatar: '👩‍🦱', photo: 'images/caddies/caddy21.jpg', specialty: 'Event Executive Golf', homeClub: 'royal-garden', availability: 'available', totalRounds: 1987, reviews: 234, personality: 'Event coordination expert', strengths: ['Event Golf', 'Group Management', 'Executive Events'] },
    { id: 'royal014', name: 'Preecha Sombat', rating: 4.7, experience: 10, languages: ['Thai', 'English', 'Italian'], avatar: '👨‍🦲', photo: 'images/caddies/caddy22.jpg', specialty: 'Cultural Executive', homeClub: 'royal-garden', availability: 'available', totalRounds: 2678, reviews: 312, personality: 'Cultural integration specialist', strengths: ['Cultural Golf', 'Executive Culture', 'International Etiquette'] },
    { id: 'royal015', name: 'Sirisuda Prom', rating: 4.9, experience: 16, languages: ['Thai', 'English', 'Mandarin'], avatar: '👩', photo: 'images/caddies/caddy23.jpg', specialty: 'Master Executive', homeClub: 'royal-garden', availability: 'available', totalRounds: 4456, reviews: 534, personality: 'Executive course master', strengths: ['Course Mastery', 'Executive Excellence', 'Elite Guidance'] },
    { id: 'royal016', name: 'Manit Wila', rating: 4.5, experience: 6, languages: ['Thai', 'English'], avatar: '👨', photo: 'images/caddies/caddy24.jpg', specialty: 'Technology Executive', homeClub: 'royal-garden', availability: 'available', totalRounds: 1654, reviews: 189, personality: 'Technology integration expert', strengths: ['Golf Technology', 'Digital Golf', 'Modern Executive'] },
    { id: 'royal017', name: 'Pensook Chai', rating: 4.8, experience: 12, languages: ['Thai', 'English', 'Portuguese'], avatar: '👩‍🦲', photo: 'images/caddies/caddy25.jpg', specialty: 'Wellness Executive', homeClub: 'royal-garden', availability: 'available', totalRounds: 3234, reviews: 389, personality: 'Wellness and health focused', strengths: ['Wellness Golf', 'Health Executive', 'Mindful Golf'] },
    { id: 'royal018', name: 'Watchara Nawin', rating: 4.6, experience: 8, languages: ['Thai', 'English'], avatar: '👨‍🦳', photo: 'images/caddies/caddy1.jpg', specialty: 'Social Executive Golf', homeClub: 'royal-garden', availability: 'available', totalRounds: 2123, reviews: 245, personality: 'Social golf specialist', strengths: ['Social Golf', 'Executive Networking', 'Group Golf'] },
    { id: 'royal019', name: 'Siriporn Krung', rating: 4.7, experience: 11, languages: ['Thai', 'English', 'Hindi'], avatar: '👩', photo: 'images/caddies/caddy2.jpg', specialty: 'Premium Executive', homeClub: 'royal-garden', availability: 'booked', totalRounds: 2987, reviews: 356, personality: 'Premium service specialist', strengths: ['Premium Service', 'Executive Premium', 'Elite Golf'] },
    { id: 'royal020', name: 'Wichan Thani', rating: 4.8, experience: 14, languages: ['Thai', 'English', 'Arabic'], avatar: '👨', photo: 'images/caddies/caddy3.jpg', specialty: 'Luxury Royal Golf', homeClub: 'royal-garden', availability: 'available', totalRounds: 3876, reviews: 456, personality: 'Royal service expert', strengths: ['Royal Treatment', 'Luxury Executive', 'Elite Service'] },

    // BANGPRA INTERNATIONAL GOLF CLUB (20 caddies)
    { id: 'bang001', name: 'Somboon Seaside', rating: 4.8, experience: 12, languages: ['Thai', 'English', 'Japanese'], avatar: '👨', photo: 'images/caddies/caddy4.jpg', specialty: 'Seaside Golf Expert', homeClub: 'bangpra-international', availability: 'available', totalRounds: 3456, reviews: 412, personality: 'Ocean breeze specialist', strengths: ['Wind Reading', 'Coastal Golf', 'Weather Adaptation'] },
    { id: 'bang002', name: 'Siriporn Ocean', rating: 4.7, experience: 9, languages: ['Thai', 'English', 'Korean'], avatar: '👩', photo: 'images/caddies/caddy5.jpg', specialty: 'International Seaside', homeClub: 'bangpra-international', availability: 'booked', totalRounds: 2567, reviews: 298, personality: 'International coastal expert', strengths: ['International Service', 'Coastal Knowledge', 'Cultural Bridge'] },
    { id: 'bang003', name: 'Wichai Wind', rating: 4.9, experience: 15, languages: ['Thai', 'English', 'Chinese'], avatar: '👨‍🦲', photo: 'images/caddies/caddy6.jpg', specialty: 'Wind Challenge Master', homeClub: 'bangpra-international', availability: 'available', totalRounds: 4123, reviews: 501, personality: 'Wind golf master', strengths: ['Wind Management', 'Challenge Golf', 'Elite Coastal'] },
    { id: 'bang004', name: 'Pranee Breeze', rating: 4.6, experience: 7, languages: ['Thai', 'English'], avatar: '👩‍🦱', photo: 'images/caddies/caddy7.jpg', specialty: 'Family Seaside Golf', homeClub: 'bangpra-international', availability: 'available', totalRounds: 1987, reviews: 234, personality: 'Family coastal specialist', strengths: ['Family Golf', 'Seaside Fun', 'Child-Friendly'] },
    { id: 'bang005', name: 'Thaworn Wave', rating: 4.8, experience: 11, languages: ['Thai', 'English', 'German'], avatar: '👨', photo: 'images/caddies/caddy8.jpg', specialty: 'Scenic Golf Expert', homeClub: 'bangpra-international', availability: 'available', totalRounds: 3234, reviews: 389, personality: 'Scenic golf specialist', strengths: ['Scenic Views', 'Photography Golf', 'Nature Golf'] },
    { id: 'bang006', name: 'Sirilak Surf', rating: 4.5, experience: 5, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy9.jpg', specialty: 'Beginner Coastal', homeClub: 'bangpra-international', availability: 'available', totalRounds: 1456, reviews: 167, personality: 'Patient coastal teacher', strengths: ['Beginner Support', 'Coastal Teaching', 'Basic Seaside'] },
    { id: 'bang007', name: 'Preecha Tide', rating: 4.7, experience: 10, languages: ['Thai', 'English', 'French'], avatar: '👨‍🦳', photo: 'images/caddies/caddy10.jpg', specialty: 'Tidal Golf Expert', homeClub: 'bangpra-international', availability: 'available', totalRounds: 2876, reviews: 334, personality: 'Tidal conditions expert', strengths: ['Tidal Knowledge', 'Timing Golf', 'Coastal Conditions'] },
    { id: 'bang008', name: 'Pensri Salt', rating: 4.6, experience: 8, languages: ['Thai', 'English'], avatar: '👩‍🦲', photo: 'images/caddies/caddy11.jpg', specialty: 'Ladies Seaside Golf', homeClub: 'bangpra-international', availability: 'booked', totalRounds: 2234, reviews: 267, personality: 'Ladies coastal golf expert', strengths: ['Ladies Golf', 'Seaside Ladies', 'Coastal Social'] },
    { id: 'bang009', name: 'Somsak Storm', rating: 4.8, experience: 13, languages: ['Thai', 'English', 'Spanish'], avatar: '👨', photo: 'images/caddies/caddy12.jpg', specialty: 'Weather Challenge Golf', homeClub: 'bangpra-international', availability: 'available', totalRounds: 3678, reviews: 445, personality: 'Weather challenge expert', strengths: ['Weather Golf', 'Storm Management', 'Challenge Expert'] },
    { id: 'bang010', name: 'Siriphan Coral', rating: 4.7, experience: 9, languages: ['Thai', 'English', 'Russian'], avatar: '👩', photo: 'images/caddies/caddy13.jpg', specialty: 'Marine Golf Tours', homeClub: 'bangpra-international', availability: 'available', totalRounds: 2567, reviews: 301, personality: 'Marine tourism expert', strengths: ['Marine Knowledge', 'Tourism Golf', 'Coastal Tours'] },
    { id: 'bang011', name: 'Narong Shell', rating: 4.5, experience: 6, languages: ['Thai', 'English'], avatar: '👨', photo: 'images/caddies/caddy14.jpg', specialty: 'Quick Coastal Rounds', homeClub: 'bangpra-international', availability: 'available', totalRounds: 1678, reviews: 189, personality: 'Efficient coastal golf', strengths: ['Quick Play', 'Efficient Coastal', 'Time Management'] },
    { id: 'bang012', name: 'Wipada Pearl', rating: 4.9, experience: 14, languages: ['Thai', 'English', 'Italian'], avatar: '👩‍🦱', photo: 'images/caddies/caddy15.jpg', specialty: 'Luxury Seaside', homeClub: 'bangpra-international', availability: 'available', totalRounds: 3789, reviews: 456, personality: 'Luxury coastal specialist', strengths: ['Luxury Seaside', 'Premium Coastal', 'Elite Ocean Golf'] },
    { id: 'bang013', name: 'Thawee Anchor', rating: 4.6, experience: 7, languages: ['Thai', 'English'], avatar: '👨‍🦲', photo: 'images/caddies/caddy16.jpg', specialty: 'Maritime Golf', homeClub: 'bangpra-international', availability: 'available', totalRounds: 1987, reviews: 234, personality: 'Maritime golf specialist', strengths: ['Maritime Golf', 'Naval Golf', 'Coastal Business'] },
    { id: 'bang014', name: 'Sirisuda Dolphin', rating: 4.8, experience: 12, languages: ['Thai', 'English', 'Portuguese'], avatar: '👩', photo: 'images/caddies/caddy17.jpg', specialty: 'Marine Life Golf', homeClub: 'bangpra-international', availability: 'available', totalRounds: 3123, reviews: 376, personality: 'Marine life enthusiast', strengths: ['Marine Life', 'Environmental Golf', 'Nature Education'] },
    { id: 'bang015', name: 'Manit Lighthouse', rating: 4.7, experience: 11, languages: ['Thai', 'English', 'Mandarin'], avatar: '👨‍🦳', photo: 'images/caddies/caddy18.jpg', specialty: 'Navigation Golf', homeClub: 'bangpra-international', availability: 'booked', totalRounds: 2987, reviews: 356, personality: 'Navigation expert', strengths: ['Course Navigation', 'Strategic Golf', 'Course Management'] },
    { id: 'bang016', name: 'Pensook Harbor', rating: 4.5, experience: 4, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy19.jpg', specialty: 'Harbor View Golf', homeClub: 'bangpra-international', availability: 'available', totalRounds: 1234, reviews: 145, personality: 'Harbor tourism expert', strengths: ['Harbor Views', 'Tourism Golf', 'Scenic Golf'] },
    { id: 'bang017', name: 'Watchara Sailor', rating: 4.8, experience: 13, languages: ['Thai', 'English', 'Hindi'], avatar: '👨', photo: 'images/caddies/caddy20.jpg', specialty: 'Sailing Golf Integration', homeClub: 'bangpra-international', availability: 'available', totalRounds: 3567, reviews: 423, personality: 'Sailing and golf expert', strengths: ['Sailing Knowledge', 'Water Sports', 'Marine Recreation'] },
    { id: 'bang018', name: 'Siriporn Mermaid', rating: 4.6, experience: 8, languages: ['Thai', 'English'], avatar: '👩‍🦲', photo: 'images/caddies/caddy21.jpg', specialty: 'Aquatic Golf Tours', homeClub: 'bangpra-international', availability: 'available', totalRounds: 2123, reviews: 245, personality: 'Aquatic tourism specialist', strengths: ['Aquatic Tours', 'Water Activities', 'Marine Golf'] },
    { id: 'bang019', name: 'Wichan Captain', rating: 4.7, experience: 10, languages: ['Thai', 'English', 'Arabic'], avatar: '👨', photo: 'images/caddies/caddy22.jpg', specialty: 'Captain\'s Golf', homeClub: 'bangpra-international', availability: 'available', totalRounds: 2678, reviews: 312, personality: 'Leadership and golf expert', strengths: ['Leadership Golf', 'Team Golf', 'Maritime Leadership'] },
    { id: 'bang020', name: 'Sirilak Admiral', rating: 4.9, experience: 16, languages: ['Thai', 'English', 'Swedish'], avatar: '👩', photo: 'images/caddies/caddy23.jpg', specialty: 'Elite Maritime Golf', homeClub: 'bangpra-international', availability: 'available', totalRounds: 4456, reviews: 534, personality: 'Elite maritime golf expert', strengths: ['Elite Maritime', 'Premium Coastal', 'Admiral Service'] },

    // CRYSTAL BAY GOLF CLUB (20 caddies)
    { id: 'crystal001', name: 'Siriporn Crystal', rating: 4.8, experience: 11, languages: ['Thai', 'English', 'Japanese'], avatar: '👩', photo: 'images/caddies/caddy24.jpg', specialty: 'Bay View Golf', homeClub: 'crystal-bay', availability: 'available', totalRounds: 3123, reviews: 376, personality: 'Bay view specialist', strengths: ['Bay Views', 'Scenic Golf', 'Photography Golf'] },
    { id: 'crystal002', name: 'Wichai Clear', rating: 4.7, experience: 9, languages: ['Thai', 'English', 'Korean'], avatar: '👨', photo: 'images/caddies/caddy25.jpg', specialty: 'Crystal Clear Golf', homeClub: 'crystal-bay', availability: 'booked', totalRounds: 2567, reviews: 298, personality: 'Clarity and precision expert', strengths: ['Clear Strategy', 'Precision Golf', 'Focus Enhancement'] },
    { id: 'crystal003', name: 'Pranee Shimmer', rating: 4.9, experience: 14, languages: ['Thai', 'English', 'Chinese'], avatar: '👩‍🦱', photo: 'images/caddies/caddy1.jpg', specialty: 'Luxury Bay Golf', homeClub: 'crystal-bay', availability: 'available', totalRounds: 3789, reviews: 456, personality: 'Luxury bay specialist', strengths: ['Luxury Service', 'Bay Luxury', 'Premium Golf'] },
    { id: 'crystal004', name: 'Thaworn Sapphire', rating: 4.6, experience: 7, languages: ['Thai', 'English'], avatar: '👨‍🦲', photo: 'images/caddies/caddy2.jpg', specialty: 'Gemstone Golf', homeClub: 'crystal-bay', availability: 'available', totalRounds: 1987, reviews: 234, personality: 'Precious golf specialist', strengths: ['Gemstone Knowledge', 'Precious Golf', 'Luxury Education'] },
    { id: 'crystal005', name: 'Sirilak Diamond', rating: 4.8, experience: 12, languages: ['Thai', 'English', 'German'], avatar: '👩', photo: 'images/caddies/caddy3.jpg', specialty: 'Diamond Service Golf', homeClub: 'crystal-bay', availability: 'available', totalRounds: 3234, reviews: 389, personality: 'Diamond service expert', strengths: ['Diamond Service', 'Premium Golf', 'Elite Treatment'] },
    { id: 'crystal006', name: 'Preecha Ruby', rating: 4.5, experience: 5, languages: ['Thai', 'English'], avatar: '👨', photo: 'images/caddies/caddy4.jpg', specialty: 'Beginner Bay Golf', homeClub: 'crystal-bay', availability: 'available', totalRounds: 1456, reviews: 167, personality: 'Patient bay teacher', strengths: ['Beginner Support', 'Bay Teaching', 'Basic Golf'] },
    { id: 'crystal007', name: 'Pensri Emerald', rating: 4.7, experience: 10, languages: ['Thai', 'English', 'French'], avatar: '👩‍🦲', photo: 'images/caddies/caddy5.jpg', specialty: 'Green Bay Golf', homeClub: 'crystal-bay', availability: 'available', totalRounds: 2876, reviews: 334, personality: 'Green golf specialist', strengths: ['Green Reading', 'Environmental Golf', 'Nature Integration'] },
    { id: 'crystal008', name: 'Somsak Opal', rating: 4.6, experience: 8, languages: ['Thai', 'English'], avatar: '👨‍🦳', photo: 'images/caddies/caddy6.jpg', specialty: 'Family Bay Golf', homeClub: 'crystal-bay', availability: 'booked', totalRounds: 2234, reviews: 267, personality: 'Family bay specialist', strengths: ['Family Golf', 'Bay Family Fun', 'Child-Friendly'] },
    { id: 'crystal009', name: 'Siriphan Topaz', rating: 4.8, experience: 13, languages: ['Thai', 'English', 'Spanish'], avatar: '👩', photo: 'images/caddies/caddy7.jpg', specialty: 'Resort Bay Golf', homeClub: 'crystal-bay', availability: 'available', totalRounds: 3678, reviews: 445, personality: 'Resort bay expert', strengths: ['Resort Golf', 'Bay Resort', 'Hospitality Golf'] },
    { id: 'crystal010', name: 'Narong Quartz', rating: 4.7, experience: 9, languages: ['Thai', 'English', 'Russian'], avatar: '👨', photo: 'images/caddies/caddy8.jpg', specialty: 'Practice Bay Golf', homeClub: 'crystal-bay', availability: 'available', totalRounds: 2567, reviews: 301, personality: 'Practice facility expert', strengths: ['Practice Facilities', 'Skill Development', 'Training Golf'] },
    { id: 'crystal011', name: 'Wipada Jade', rating: 4.5, experience: 6, languages: ['Thai', 'English'], avatar: '👩‍🦱', photo: 'images/caddies/caddy9.jpg', specialty: 'Wellness Bay Golf', homeClub: 'crystal-bay', availability: 'available', totalRounds: 1678, reviews: 189, personality: 'Wellness bay specialist', strengths: ['Wellness Golf', 'Health Benefits', 'Mindful Bay Golf'] },
    { id: 'crystal012', name: 'Thawee Amethyst', rating: 4.9, experience: 15, languages: ['Thai', 'English', 'Italian'], avatar: '👨', photo: 'images/caddies/caddy10.jpg', specialty: 'VIP Crystal Golf', homeClub: 'crystal-bay', availability: 'available', totalRounds: 4123, reviews: 501, personality: 'VIP crystal specialist', strengths: ['VIP Service', 'Crystal Elite', 'Premium Bay Golf'] },
    { id: 'crystal013', name: 'Sirisuda Pearl', rating: 4.6, experience: 7, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy11.jpg', specialty: 'Ladies Bay Golf', homeClub: 'crystal-bay', availability: 'available', totalRounds: 1987, reviews: 234, personality: 'Ladies bay golf expert', strengths: ['Ladies Golf', 'Bay Ladies', 'Social Golf'] },
    { id: 'crystal014', name: 'Manit Coral', rating: 4.8, experience: 12, languages: ['Thai', 'English', 'Portuguese'], avatar: '👨‍🦲', photo: 'images/caddies/caddy12.jpg', specialty: 'Marine Bay Golf', homeClub: 'crystal-bay', availability: 'available', totalRounds: 3123, reviews: 376, personality: 'Marine bay specialist', strengths: ['Marine Knowledge', 'Bay Marine Life', 'Environmental Golf'] },
    { id: 'crystal015', name: 'Pensook Turquoise', rating: 4.7, experience: 11, languages: ['Thai', 'English', 'Mandarin'], avatar: '👩‍🦲', photo: 'images/caddies/caddy13.jpg', specialty: 'Scenic Bay Master', homeClub: 'crystal-bay', availability: 'booked', totalRounds: 2987, reviews: 356, personality: 'Scenic bay master', strengths: ['Scenic Mastery', 'Bay Photography', 'View Golf'] },
    { id: 'crystal016', name: 'Watchara Amber', rating: 4.5, experience: 4, languages: ['Thai', 'English'], avatar: '👨', photo: 'images/caddies/caddy14.jpg', specialty: 'Quick Bay Rounds', homeClub: 'crystal-bay', availability: 'available', totalRounds: 1234, reviews: 145, personality: 'Quick bay golf specialist', strengths: ['Quick Play', 'Efficient Bay Golf', 'Time Management'] },
    { id: 'crystal017', name: 'Siriporn Garnet', rating: 4.8, experience: 13, languages: ['Thai', 'English', 'Hindi'], avatar: '👩', photo: 'images/caddies/caddy15.jpg', specialty: 'Cultural Bay Golf', homeClub: 'crystal-bay', availability: 'available', totalRounds: 3567, reviews: 423, personality: 'Cultural bay specialist', strengths: ['Cultural Golf', 'Bay Culture', 'International Etiquette'] },
    { id: 'crystal018', name: 'Wichan Citrine', rating: 4.6, experience: 8, languages: ['Thai', 'English'], avatar: '👨‍🦳', photo: 'images/caddies/caddy16.jpg', specialty: 'Business Bay Golf', homeClub: 'crystal-bay', availability: 'available', totalRounds: 2123, reviews: 245, personality: 'Business bay specialist', strengths: ['Business Golf', 'Bay Networking', 'Corporate Golf'] },
    { id: 'crystal019', name: 'Sirilak Moonstone', rating: 4.7, experience: 10, languages: ['Thai', 'English', 'Arabic'], avatar: '👩‍🦱', photo: 'images/caddies/caddy17.jpg', specialty: 'Evening Bay Golf', homeClub: 'crystal-bay', availability: 'available', totalRounds: 2678, reviews: 312, personality: 'Evening golf specialist', strengths: ['Evening Golf', 'Twilight Golf', 'Night Bay Golf'] },
    { id: 'crystal020', name: 'Preecha Platinum', rating: 4.9, experience: 16, languages: ['Thai', 'English', 'Swedish'], avatar: '👨', photo: 'images/caddies/caddy18.jpg', specialty: 'Elite Crystal Bay', homeClub: 'crystal-bay', availability: 'available', totalRounds: 4456, reviews: 534, personality: 'Elite crystal bay expert', strengths: ['Elite Bay Golf', 'Platinum Service', 'Master Crystal Golf'] },

    // LAEM CHABANG INTERNATIONAL COUNTRY CLUB (20 caddies)
    { id: 'laem001', name: 'Siriporn International', rating: 4.9, experience: 14, languages: ['Thai', 'English', 'Japanese', 'Chinese'], avatar: '👩', photo: 'images/caddies/caddy19.jpg', specialty: 'International Championship', homeClub: 'laem-chabang', availability: 'available', totalRounds: 4123, reviews: 501, personality: 'International golf expert', strengths: ['International Standards', 'Multi-lingual', 'Championship Golf'] },
    { id: 'laem002', name: 'Wichai Country', rating: 4.8, experience: 12, languages: ['Thai', 'English', 'Korean'], avatar: '👨', photo: 'images/caddies/caddy20.jpg', specialty: 'Country Club Excellence', homeClub: 'laem-chabang', availability: 'booked', totalRounds: 3456, reviews: 412, personality: 'Country club specialist', strengths: ['Club Excellence', 'Member Service', 'Elite Golf'] },
    { id: 'laem003', name: 'Pranee Global', rating: 4.7, experience: 10, languages: ['Thai', 'English', 'German'], avatar: '👩‍🦱', photo: 'images/caddies/caddy21.jpg', specialty: 'Global Golf Standards', homeClub: 'laem-chabang', availability: 'available', totalRounds: 2876, reviews: 334, personality: 'Global standards expert', strengths: ['Global Standards', 'International Etiquette', 'World Golf'] },
    { id: 'laem004', name: 'Thaworn Elite', rating: 4.9, experience: 16, languages: ['Thai', 'English', 'French'], avatar: '👨‍🦲', photo: 'images/caddies/caddy22.jpg', specialty: 'Elite International Golf', homeClub: 'laem-chabang', availability: 'available', totalRounds: 4567, reviews: 556, personality: 'Elite international specialist', strengths: ['Elite Golf', 'International Elite', 'Championship Standards'] },
    { id: 'laem005', name: 'Sirilak Premier', rating: 4.6, experience: 8, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy23.jpg', specialty: 'Premier Country Golf', homeClub: 'laem-chabang', availability: 'available', totalRounds: 2234, reviews: 267, personality: 'Premier service specialist', strengths: ['Premier Service', 'Country Club', 'Member Excellence'] },
    { id: 'laem006', name: 'Preecha World', rating: 4.8, experience: 13, languages: ['Thai', 'English', 'Spanish'], avatar: '👨', photo: 'images/caddies/caddy24.jpg', specialty: 'World Class Golf', homeClub: 'laem-chabang', availability: 'available', totalRounds: 3678, reviews: 445, personality: 'World class golf expert', strengths: ['World Class', 'International Golf', 'Global Excellence'] },
    { id: 'laem007', name: 'Pensri Champion', rating: 4.7, experience: 11, languages: ['Thai', 'English', 'Russian'], avatar: '👩‍🦲', photo: 'images/caddies/caddy25.jpg', specialty: 'Championship Support', homeClub: 'laem-chabang', availability: 'available', totalRounds: 3123, reviews: 376, personality: 'Championship supporter', strengths: ['Championship Golf', 'Tournament Support', 'Elite Competition'] },
    { id: 'laem008', name: 'Somsak Master', rating: 4.5, experience: 6, languages: ['Thai', 'English'], avatar: '👨‍🦳', photo: 'images/caddies/caddy1.jpg', specialty: 'Master Class Golf', homeClub: 'laem-chabang', availability: 'booked', totalRounds: 1678, reviews: 189, personality: 'Master class specialist', strengths: ['Master Golf', 'Class Excellence', 'Elite Teaching'] },
    { id: 'laem009', name: 'Siriphan Legend', rating: 4.8, experience: 15, languages: ['Thai', 'English', 'Italian'], avatar: '👩', photo: 'images/caddies/caddy2.jpg', specialty: 'Legendary Golf Service', homeClub: 'laem-chabang', availability: 'available', totalRounds: 3789, reviews: 456, personality: 'Legendary service expert', strengths: ['Legendary Service', 'Golf Legends', 'Historic Golf'] },
    { id: 'laem010', name: 'Narong Trophy', rating: 4.6, experience: 9, languages: ['Thai', 'English', 'Portuguese'], avatar: '👨', photo: 'images/caddies/caddy3.jpg', specialty: 'Trophy Golf Expert', homeClub: 'laem-chabang', availability: 'available', totalRounds: 2567, reviews: 298, personality: 'Trophy golf specialist', strengths: ['Trophy Golf', 'Achievement Support', 'Victory Golf'] },
    { id: 'laem011', name: 'Wipada Crown', rating: 4.7, experience: 12, languages: ['Thai', 'English', 'Mandarin'], avatar: '👩‍🦱', photo: 'images/caddies/caddy4.jpg', specialty: 'Crown Golf Service', homeClub: 'laem-chabang', availability: 'available', totalRounds: 2987, reviews: 356, personality: 'Crown service specialist', strengths: ['Crown Service', 'Royal Golf', 'Elite Treatment'] },
    { id: 'laem012', name: 'Thawee Excellence', rating: 4.9, experience: 17, languages: ['Thai', 'English', 'Arabic'], avatar: '👨', photo: 'images/caddies/caddy5.jpg', specialty: 'Golf Excellence Master', homeClub: 'laem-chabang', availability: 'available', totalRounds: 4789, reviews: 567, personality: 'Excellence master', strengths: ['Golf Excellence', 'Master Service', 'Elite Mastery'] },
    { id: 'laem013', name: 'Sirisuda Victory', rating: 4.5, experience: 5, languages: ['Thai', 'English'], avatar: '👩', photo: 'images/caddies/caddy6.jpg', specialty: 'Victory Support Golf', homeClub: 'laem-chabang', availability: 'available', totalRounds: 1456, reviews: 167, personality: 'Victory supporter', strengths: ['Victory Support', 'Winning Golf', 'Success Support'] },
    { id: 'laem014', name: 'Manit Supreme', rating: 4.8, experience: 14, languages: ['Thai', 'English', 'Hindi'], avatar: '👨‍🦲', photo: 'images/caddies/caddy7.jpg', specialty: 'Supreme Golf Service', homeClub: 'laem-chabang', availability: 'available', totalRounds: 3567, reviews: 423, personality: 'Supreme service expert', strengths: ['Supreme Service', 'Elite Golf', 'Master Excellence'] },
    { id: 'laem015', name: 'Pensook Prestige', rating: 4.7, experience: 10, languages: ['Thai', 'English', 'Swedish'], avatar: '👩‍🦲', photo: 'images/caddies/caddy8.jpg', specialty: 'Prestige Golf', homeClub: 'laem-chabang', availability: 'booked', totalRounds: 2678, reviews: 312, personality: 'Prestige specialist', strengths: ['Prestige Golf', 'Elite Prestige', 'Distinguished Service'] },
    { id: 'laem016', name: 'Watchara Grandmaster', rating: 4.6, experience: 7, languages: ['Thai', 'English'], avatar: '👨', photo: 'images/caddies/caddy9.jpg', specialty: 'Grandmaster Golf', homeClub: 'laem-chabang', availability: 'available', totalRounds: 1987, reviews: 234, personality: 'Grandmaster specialist', strengths: ['Grandmaster Golf', 'Master Teaching', 'Elite Guidance'] },
    { id: 'laem017', name: 'Siriporn Ultimate', rating: 4.9, experience: 18, languages: ['Thai', 'English', 'Norwegian'], avatar: '👩', photo: 'images/caddies/caddy10.jpg', specialty: 'Ultimate Golf Experience', homeClub: 'laem-chabang', availability: 'available', totalRounds: 5123, reviews: 634, personality: 'Ultimate golf expert', strengths: ['Ultimate Golf', 'Perfect Experience', 'Master Ultimate'] },
    { id: 'laem018', name: 'Wichan Divine', rating: 4.8, experience: 13, languages: ['Thai', 'English', 'Dutch'], avatar: '👨‍🦳', photo: 'images/caddies/caddy11.jpg', specialty: 'Divine Golf Service', homeClub: 'laem-chabang', availability: 'available', totalRounds: 3234, reviews: 389, personality: 'Divine service specialist', strengths: ['Divine Service', 'Heavenly Golf', 'Perfect Golf'] },
    { id: 'laem019', name: 'Sirilak Infinite', rating: 4.7, experience: 11, languages: ['Thai', 'English', 'Finnish'], avatar: '👩‍🦱', photo: 'images/caddies/caddy12.jpg', specialty: 'Infinite Golf Possibilities', homeClub: 'laem-chabang', availability: 'available', totalRounds: 2789, reviews: 334, personality: 'Infinite possibilities expert', strengths: ['Infinite Golf', 'Limitless Service', 'Endless Excellence'] },
    { id: 'laem020', name: 'Preecha Eternal', rating: 4.9, experience: 19, languages: ['Thai', 'English', 'Danish'], avatar: '👨', photo: 'images/caddies/caddy13.jpg', specialty: 'Eternal Golf Mastery', homeClub: 'laem-chabang', availability: 'available', totalRounds: 5456, reviews: 678, personality: 'Eternal golf master', strengths: ['Eternal Mastery', 'Timeless Golf', 'Legendary Excellence'] }
            ],

            waitlists: {},
            activeOffers: {},

            getRandomPromotionalCaddys(count = 4) {
                const shuffled = [...this.allCaddys].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, count).map(caddie => {
                    // Find the actual course this caddie works at
                    const actualCourse = GolfCoursesDatabase.courses.find(c => c.homeClub === caddie.homeClub) ||
                                       GolfCourseDatabase.courses.find(c => c.id === caddie.homeClub);
                    return {
                        ...caddie,
                        promotedCourse: actualCourse || {
                            name: 'Pattaya Golf Club',
                            location: 'Central Pattaya',
                            image: '⛳',
                            rating: 4.6,
                            holes: 18
                        }
                    };
                });
            },

            addToWaitlist(caddieId, golferId, golferInfo) {
                if (!this.waitlists[caddieId]) {
                    this.waitlists[caddieId] = [];
                }

                const waitlistEntry = {
                    golferId,
                    golferName: golferInfo.name,
                    timestamp: new Date(),
                    priority: this.waitlists[caddieId].length + 1
                };

                this.waitlists[caddieId].push(waitlistEntry);
                return waitlistEntry.priority;
            },

            sendTimedOffer(caddieId, golferId) {
                const offerId = `offer-${caddieId}-${golferId}-${Date.now()}`;
                const caddie = this.allCaddys.find(c => c.id === caddieId);

                this.activeOffers[offerId] = {
                    caddieId,
                    golferId,
                    caddieName: caddie.name,
                    expiresAt: new Date(Date.now() + 10 * 60 * 1000), // 10 minutes
                    status: 'pending'
                };

                this.showOfferModal(offerId);

                // Auto-expire after 10 minutes
                setTimeout(() => {
                    if (this.activeOffers[offerId]?.status === 'pending') {
                        this.expireOffer(offerId);
                    }
                }, 10 * 60 * 1000);

                return offerId;
            },

            showOfferModal(offerId) {
                const offer = this.activeOffers[offerId];
                const caddie = this.allCaddys.find(c => c.id === offer.caddieId);
                const course = GolfCourseDatabase.getCourseById(caddie.homeClub);

                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.id = `offer-modal-${offerId}`;

                modal.innerHTML = `
                    <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl">
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">🎉</div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-2">Caddy Available!</h3>
                            <p class="text-gray-600">Your preferred caddie is now available</p>
                        </div>

                        <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6 mb-6">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="text-4xl">${caddie.avatar}</div>
                                <div>
                                    <h4 class="font-bold text-lg">${caddie.name}</h4>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-yellow-500">⭐</span>
                                        <span class="font-semibold">${caddie.rating}</span>
                                        <span class="text-gray-600">(${caddie.reviews} reviews)</span>
                                    </div>
                                </div>
                            </div>
                            <p class="text-sm text-gray-700 mb-3">${caddie.specialty} • ${caddie.experience} years</p>
                            <p class="text-sm text-gray-600">${caddie.personality}</p>
                        </div>

                        <div class="bg-gray-50 rounded-xl p-4 mb-6">
                            <h5 class="font-semibold mb-2">Available at:</h5>
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">${course.image}</span>
                                <div>
                                    <p class="font-semibold">${course.name}</p>
                                    <p class="text-sm text-gray-600">${course.location}</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-red-500">⏰</span>
                                <span class="font-semibold text-red-700">Limited Time Offer</span>
                            </div>
                            <p class="text-sm text-red-600">This offer expires in <span id="countdown-${offerId}" class="font-bold">10:00</span></p>
                        </div>

                        <div class="flex space-x-3">
                            <button onclick="CaddySystem.acceptOffer('${offerId}')"
                                    class="flex-1 bg-green-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-green-700 transition-colors">
                                Accept & Book
                            </button>
                            <button onclick="CaddySystem.declineOffer('${offerId}')"
                                    class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-400 transition-colors">
                                Pass
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                this.startCountdown(offerId);
            },

            startCountdown(offerId) {
                const offer = this.activeOffers[offerId];
                const countdownElement = document.getElementById(`countdown-${offerId}`);

                const updateCountdown = () => {
                    const now = new Date();
                    const timeLeft = offer.expiresAt - now;

                    if (timeLeft <= 0) {
                        this.expireOffer(offerId);
                        return;
                    }

                    const minutes = Math.floor(timeLeft / 60000);
                    const seconds = Math.floor((timeLeft % 60000) / 1000);

                    if (countdownElement) {
                        countdownElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                };

                const interval = setInterval(updateCountdown, 1000);
                offer.countdownInterval = interval;
                updateCountdown();
            },

            acceptOffer(offerId) {
                const offer = this.activeOffers[offerId];
                offer.status = 'accepted';

                // Remove from waitlist
                this.removeFromWaitlist(offer.caddieId, offer.golferId);

                // AUTOMATIC CADDY SWITCHING LOGIC
                const currentUser = AppState.currentUser;
                const newCaddie = this.allCaddys.find(c => c.id === offer.caddieId);

                // Check if golfer has existing caddy booking to replace
                if (currentUser && bookingCart.caddies && bookingCart.caddies.length > 0) {
                    // Find existing caddy booking for this golfer
                    const existingCaddyIndex = bookingCart.caddies.findIndex(c =>
                        c.golferName === currentUser.name ||
                        c.golferId === currentUser.name.toLowerCase().replace(' ', '_')
                    );

                    if (existingCaddyIndex >= 0) {
                        const previousCaddy = bookingCart.caddies[existingCaddyIndex];
                        console.log(`[CADDY SWITCH] Replacing ${previousCaddy.name} with ${newCaddie.name}`);

                        // Make previous caddy available again
                        const prevCaddieObj = this.allCaddys.find(c => c.id === previousCaddy.id);
                        if (prevCaddieObj) {
                            prevCaddieObj.availability = 'available';
                            console.log(`[SUCCESS] ${prevCaddieObj.name} is now available again`);
                        }

                        // Replace with new caddy in booking cart
                        bookingCart.caddies[existingCaddyIndex] = {
                            id: newCaddie.id,
                            name: newCaddie.name,
                            type: 'booking',
                            rate: 1200,
                            specialty: newCaddie.specialty,
                            rating: newCaddie.rating,
                            avatar: newCaddie.avatar,
                            golferName: currentUser.name,
                            golferId: currentUser.name.toLowerCase().replace(' ', '_')
                        };

                        // Update booking cart display
                        updateBookingCartDisplay();

                        // Notify golfer of switch
                        NotificationManager.show(`🔄 Caddy switched! ${newCaddie.name} is now your caddy`, 'success');
                        console.log(`[SUCCESS] Booking transferred from ${previousCaddy.name} to ${newCaddie.name}`);

                        // Notify new caddy of booking assignment
                        this.notifyCaddyOfBooking(newCaddie.id, {
                            golferName: currentUser.name,
                            date: bookingCart.course ? 'Today' : 'TBD',
                            time: 'TBD',
                            course: bookingCart.course ? bookingCart.course.name : 'TBD'
                        });

                        // Mark new caddy as booked
                        newCaddie.availability = 'booked';

                        // Update new caddy's current booking info
                        newCaddie.currentBooking = {
                            date: new Date().toISOString().split('T')[0],
                            time: '08:00',
                            golfer: currentUser.name,
                            holes: 18
                        };

                        // Close modal
                        const modal = document.getElementById(`offer-modal-${offerId}`);
                        if (modal) modal.remove();

                        // Clear countdown
                        if (offer.countdownInterval) {
                            clearInterval(offer.countdownInterval);
                        }

                        // Don't show booking flow - just confirm the switch
                        console.log(`[SUCCESS] Offer accepted for caddie ${offer.caddieName} - automatic switch completed`);
                        return; // Exit early - no need for new booking flow
                    }
                }

                // If no existing booking to replace, proceed with normal flow
                // Mark caddie as booked
                newCaddie.availability = 'booked';

                // Close modal
                const modal = document.getElementById(`offer-modal-${offerId}`);
                if (modal) modal.remove();

                // Clear countdown
                if (offer.countdownInterval) {
                    clearInterval(offer.countdownInterval);
                }

                // Show booking flow for new booking
                this.showCaddyBookingFlow(offer.caddieId);

                console.log(`[SUCCESS] Offer accepted for caddie ${offer.caddieName}`);
            },

            declineOffer(offerId) {
                const offer = this.activeOffers[offerId];
                offer.status = 'declined';

                // Remove from waitlist
                this.removeFromWaitlist(offer.caddieId, offer.golferId);

                // Close modal
                const modal = document.getElementById(`offer-modal-${offerId}`);
                if (modal) modal.remove();

                // Clear countdown
                if (offer.countdownInterval) {
                    clearInterval(offer.countdownInterval);
                }

                // Send offer to next person in waitlist
                this.processNextInWaitlist(offer.caddieId);

                console.log(`[INFO] Offer declined for caddie ${offer.caddieName}`);
            },

            expireOffer(offerId) {
                const offer = this.activeOffers[offerId];
                offer.status = 'expired';

                // Remove from waitlist
                this.removeFromWaitlist(offer.caddieId, offer.golferId);

                // Close modal
                const modal = document.getElementById(`offer-modal-${offerId}`);
                if (modal) modal.remove();

                // Clear countdown
                if (offer.countdownInterval) {
                    clearInterval(offer.countdownInterval);
                }

                // Send offer to next person in waitlist
                this.processNextInWaitlist(offer.caddieId);

                console.log(`[INFO] Offer expired for caddie ${offer.caddieName}`);
            },

            removeFromWaitlist(caddieId, golferId) {
                if (this.waitlists[caddieId]) {
                    this.waitlists[caddieId] = this.waitlists[caddieId].filter(entry => entry.golferId !== golferId);
                }
            },

            processNextInWaitlist(caddieId) {
                if (this.waitlists[caddieId] && this.waitlists[caddieId].length > 0) {
                    const nextGolfer = this.waitlists[caddieId][0];
                    this.sendTimedOffer(caddieId, nextGolfer.golferId);
                }
            },

            showCaddyBookingFlow(caddieId) {
                try {
                    const caddie = this.allCaddys.find(c => c.id === caddieId);
                    if (!caddie) {
                        console.error('Caddy not found:', caddieId);
                        NotificationManager.show('Caddy not found. Please try again.', 'error');
                        return;
                    }

                    const course = GolfCourseDatabase.getCourseById(caddie.homeClub);
                    if (!course) {
                        console.error('Course not found for caddie:', caddie.homeClub);
                        NotificationManager.show('Course information not available.', 'error');
                        return;
                    }

                    // Show course booking interface - switch to booking tab
                    showGolferTab('booking', null);

                    // Pre-fill course selection
                    setTimeout(() => {
                        const courseElement = document.querySelector(`[data-course="${caddie.homeClub}"]`);
                        if (courseElement) {
                            courseElement.click();
                        }

                        // Show course info with caddie pre-selected
                        this.showCourseInfoModal(course, caddie);
                    }, 100);

                    console.log('Caddy booking flow initiated for:', caddie.name);
                } catch (error) {
                    console.error('Error in showCaddyBookingFlow:', error);
                    NotificationManager.show('Error loading booking. Please try again.', 'error');
                }
            },

            showCourseInfoModal(course, caddie = null) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';

                modal.innerHTML = `
                    <div class="bg-white rounded-2xl p-8 max-w-2xl mx-4 shadow-2xl max-h-screen overflow-y-auto">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-2xl font-bold text-gray-900">Course Information</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>

                        <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6 mb-6">
                            <div class="flex items-center space-x-4 mb-4">
                                <span class="text-4xl">${course.image}</span>
                                <div>
                                    <h4 class="text-2xl font-bold">${course.name}</h4>
                                    <p class="text-gray-600">${course.location}</p>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <span class="text-yellow-500">⭐</span>
                                        <span class="font-semibold">${course.rating}</span>
                                        <span class="text-gray-600">• ${course.holes} holes • ${course.type}</span>
                                    </div>
                                </div>
                            </div>
                            <p class="text-gray-700">${course.description}</p>
                        </div>

                        ${caddie ? `
                            <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="text-green-600">✓</span>
                                    <span class="font-semibold text-green-700">Caddy Pre-Selected</span>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="text-2xl">${caddie.avatar}</span>
                                    <div>
                                        <p class="font-semibold">${caddie.name}</p>
                                        <p class="text-sm text-gray-600">${caddie.specialty}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-gray-50 rounded-xl p-4">
                                <h5 class="font-semibold mb-2">Green Fees</h5>
                                <p class="text-sm text-gray-600">Weekday: ฿${course.greenFees.weekday.toLocaleString()}</p>
                                <p class="text-sm text-gray-600">Weekend: ฿${course.greenFees.weekend.toLocaleString()}</p>
                            </div>
                            <div class="bg-gray-50 rounded-xl p-4">
                                <h5 class="font-semibold mb-2">Amenities</h5>
                                <div class="text-sm text-gray-600">
                                    ${course.amenities.slice(0, 3).map(amenity => `<p>• ${amenity}</p>`).join('')}
                                </div>
                            </div>
                        </div>

                        <div class="flex space-x-3">
                            <button onclick="this.closest('.fixed').remove(); showGolferTab('booking', null);"
                                    class="flex-1 bg-primary-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-primary-700 transition-colors">
                                Book Tee Time
                            </button>
                            <button onclick="this.closest('.fixed').remove()"
                                    class="bg-gray-300 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-400 transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            },

            notifyCaddyOfBooking(caddieId, bookingDetails) {
                const caddie = this.allCaddys.find(c => c.id === caddieId);
                if (!caddie) {
                    console.error('Caddy not found for notification:', caddieId);
                    return;
                }

                // Log the booking notification for caddy
                console.log(`[CADDY NOTIFICATION] ${caddie.name} assigned to ${bookingDetails.golferName}`);
                console.log(`[BOOKING DETAILS] Course: ${bookingDetails.course}, Date: ${bookingDetails.date}, Time: ${bookingDetails.time}`);

                // In a real implementation, this would send push notification to caddy's device
                // For now, we'll show a success message indicating the caddy has been notified
                NotificationManager.show(`📱 ${caddie.name} has been notified of the booking assignment`, 'info');

                // Update caddy's notification queue (for when they check their dashboard)
                if (!caddie.notifications) {
                    caddie.notifications = [];
                }

                caddie.notifications.push({
                    id: `booking-${Date.now()}`,
                    type: 'booking_assignment',
                    title: 'New Booking Assignment',
                    message: `You have been assigned to ${bookingDetails.golferName}`,
                    details: bookingDetails,
                    timestamp: new Date(),
                    read: false
                });

                console.log(`[SUCCESS] ${caddie.name} notified of booking assignment via real-time system`);
            }
        };

        // Enhanced Booking System with Caddy and Payment
        const BookingSystem = {
            currentBooking: {
                course: null,
                date: null,
                time: null,
                players: 1,
                caddies: [],
                services: [],
                paymentMethod: null,
                total: 0
            },

            get caddieDatabase() {
                // Use CaddySystem data without pricing - pricing determined by golf course
                return CaddySystem.allCaddys.map(caddie => ({
                    id: caddie.id,
                    name: caddie.name,
                    rating: caddie.rating,
                    experience: caddie.experience,
                    languages: caddie.languages,
                    avatar: caddie.avatar,
                    specialty: caddie.specialty,
                    availability: caddie.availability === 'available',
                    homeClub: caddie.homeClub,
                    totalRounds: caddie.totalRounds,
                    reviews: caddie.reviews,
                    personality: caddie.personality,
                    strengths: caddie.strengths
                }));
            },

            serviceOptions: [
                { id: 'cart', name: 'Golf Cart Rental', price: 600, icon: '🚗', description: 'Electric golf cart for 2 players' },
                { id: 'clubs', name: 'Club Rental Set', price: 400, icon: '⛳', description: 'Premium club set with bag' },
                { id: 'shoes', name: 'Golf Shoes Rental', price: 200, icon: '👟', description: 'Professional golf shoes' },
                { id: 'insurance', name: 'Play Insurance', price: 150, icon: '🛡️', description: 'Covers medical & equipment' },
                { id: 'lesson', name: 'Pro Lesson (30min)', price: 800, icon: '🎯', description: 'One-on-one instruction' }
            ],

            updateSummary() {
                const booking = this.currentBooking;
                const summaryContainer = document.getElementById('bookingSummary');
                const totalContainer = document.getElementById('bookingTotal');

                if (!summaryContainer || !totalContainer) return;

                if (!booking.course || !booking.date || !booking.time) {
                    summaryContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Please complete your booking details</p>';
                    totalContainer.innerHTML = '<div class="text-center"><span class="text-2xl font-bold text-gray-400">฿0</span></div>';
                    return;
                }

                let total = 0;
                const coursePrice = { championship: 2500, executive: 1800, practice: 1200 }[booking.course] || 0;
                total += coursePrice * booking.players;

                // Caddy pricing now determined by golf course - not added to total here
                booking.services.forEach(service => total += service.price);

                this.currentBooking.total = total;

                summaryContainer.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Course (${booking.players} players)</span>
                            <span class="font-semibold">฿${(coursePrice * booking.players).toLocaleString()}</span>
                        </div>
                        ${booking.caddies.map(caddie => `
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">${caddie.name} (Caddy)</span>
                                <span class="font-semibold text-blue-600">Included in Course Fee</span>
                            </div>
                        `).join('')}
                        ${booking.services.map(service => `
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">${service.name}</span>
                                <span class="font-semibold">฿${service.price.toLocaleString()}</span>
                            </div>
                        `).join('')}
                        <div class="border-t pt-3">
                            <div class="flex justify-between items-center text-lg font-bold">
                                <span>Total</span>
                                <span class="text-primary-600">฿${total.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                `;

                totalContainer.innerHTML = `
                    <div class="text-center">
                        <span class="text-2xl font-bold text-primary-600">฿${total.toLocaleString()}</span>
                        <p class="text-sm text-gray-500 mt-1">Total Amount</p>
                    </div>
                `;
            }
        };

        // Legacy function - redirect to new selectCourse
        function selectCourseOld(element, courseType) {
            // This is the old function, now redirects to the new one
            const courseMap = {
                'championship': 'pattaya-golf-club',
                'executive': 'royal-garden',
                'practice': 'crystal-bay'
            };
            const courseId = courseMap[courseType] || 'pattaya-golf-club';
            selectCourse(courseId);
        }

        function selectCaddy(caddieId, fromPromotion = false) {
            const caddie = BookingSystem.caddieDatabase.find(c => c.id === caddieId);
            if (!caddie) return;

            // If caddie is not available, show waitlist option
            if (!caddie.availability) {
                showCaddyWaitlistModal(caddie);
                return;
            }

            // If from promotion (random caddie), show course info first
            if (fromPromotion) {
                const course = GolfCourseDatabase.getCourseById(caddie.homeClub);
                CaddySystem.showCourseInfoModal(course, caddie);
                return;
            }

            const existingIndex = BookingSystem.currentBooking.caddies.findIndex(c => c.id === caddieId);
            const caddieElement = document.querySelector(`[data-caddie="${caddieId}"]`);

            if (existingIndex >= 0) {
                BookingSystem.currentBooking.caddies.splice(existingIndex, 1);
                if (caddieElement) {
                    caddieElement.classList.remove('border-primary-500', 'bg-primary-50');
                    caddieElement.classList.add('border-gray-200');
                }
            } else {
                BookingSystem.currentBooking.caddies.push(caddie);
                if (caddieElement) {
                    caddieElement.classList.remove('border-gray-200');
                    caddieElement.classList.add('border-primary-500', 'bg-primary-50');
                }
            }

            BookingSystem.updateSummary();
        }

        function showCaddyWaitlistModal(caddie) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';

            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-4">${caddie.avatar}</div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">${caddie.name}</h3>
                        <p class="text-gray-600">This caddie is currently booked</p>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-6 mb-6">
                        <div class="flex items-center space-x-2 mb-3">
                            <span class="text-yellow-500">⭐</span>
                            <span class="font-semibold">${caddie.rating}</span>
                            <span class="text-gray-600">(${caddie.reviews} reviews)</span>
                        </div>
                        <p class="text-sm text-gray-700 mb-2">${caddie.specialty} • ${caddie.experience} years</p>
                        <p class="text-sm text-gray-600">${caddie.personality}</p>
                        <div class="mt-3">
                            <p class="text-xs text-gray-500 font-medium">Strengths:</p>
                            <p class="text-xs text-gray-600">${caddie.strengths.join(', ')}</p>
                        </div>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="text-blue-500">📋</span>
                            <span class="font-semibold text-blue-700">Join Waitlist</span>
                        </div>
                        <p class="text-sm text-blue-600">Get notified when ${caddie.name} becomes available. You'll have 10 minutes to accept the offer.</p>
                    </div>

                    <div class="flex space-x-3">
                        <button onclick="joinCaddyWaitlist('${caddie.id}'); this.closest('.fixed').remove();"
                                class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-blue-700 transition-colors">
                            Join Waitlist
                        </button>
                        <button onclick="this.closest('.fixed').remove()"
                                class="bg-gray-300 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-400 transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function joinCaddyWaitlist(caddieId) {
            const golferInfo = {
                name: AppState.currentUser.name,
                id: AppState.currentUser.role + '_user_' + Date.now()
            };

            const position = CaddySystem.addToWaitlist(caddieId, golferInfo.id, golferInfo);

            console.log(`[SUCCESS] Added to waitlist for caddie ${caddieId}. Position: ${position}`);

            // Show confirmation
            const confirmationModal = document.createElement('div');
            confirmationModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';

            confirmationModal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl">
                    <div class="text-center">
                        <div class="text-6xl mb-4">✅</div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">Added to Waitlist</h3>
                        <p class="text-gray-600 mb-4">You're #${position} in line</p>
                        <p class="text-sm text-gray-500 mb-6">We'll notify you when the caddie becomes available. You'll have 10 minutes to accept the offer.</p>
                        <button onclick="this.closest('.fixed').remove()"
                                class="bg-primary-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-primary-700 transition-colors">
                            Got it!
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(confirmationModal);

            // Auto-close after 3 seconds
            setTimeout(() => {
                if (confirmationModal.parentNode) {
                    confirmationModal.remove();
                }
            }, 3000);
        }

        function loadPromotionalCaddys() {
            const promotionalCaddys = CaddySystem.getRandomPromotionalCaddys(4);
            const mobileContainer = document.getElementById('promotionalCaddysContainer');
            const desktopContainer = document.getElementById('promotionalCaddysDesktop');

            // Function to generate caddie card HTML
            const generateCaddyCard = (caddie, isMobile = false) => `
                <div class="bg-gradient-to-br from-white to-gray-50 rounded-xl p-4 border border-gray-200 hover:border-primary-300 hover:shadow-lg transition-all ${isMobile ? 'mobile-caddie-card' : ''}">
                    <div class="flex items-center space-x-3 mb-3">
                        <img src="${caddie.photo || 'images/caddies/default.jpg'}" alt="${caddie.name}" class="w-16 h-16 rounded-full object-cover border-2 border-primary-200" onerror="this.src='https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=200&h=200&fit=crop'">
                        <div>
                            <h4 class="font-bold text-gray-900">${caddie.name}</h4>
                            <div class="flex items-center space-x-2">
                                <span class="text-yellow-500">⭐</span>
                                <span class="text-sm font-semibold">${caddie.rating}</span>
                                <span class="text-xs text-gray-500">(${caddie.reviews})</span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <p class="text-xs text-gray-600 font-medium">${caddie.specialty}</p>
                        <p class="text-xs text-gray-500">${caddie.experience} years experience</p>
                        <p class="text-xs text-gray-500 mt-1">${caddie.languages.join(', ')}</p>
                    </div>

                    <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-3 mb-3">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="text-lg">${caddie.promotedCourse.image}</span>
                            <div>
                                <p class="font-semibold text-sm text-gray-900">${caddie.promotedCourse.name}</p>
                                <p class="text-xs text-gray-600">${caddie.promotedCourse.location}</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-1">
                                <span class="text-yellow-400">⭐</span>
                                <span class="text-xs font-semibold">${caddie.promotedCourse.rating}</span>
                            </div>
                            <span class="text-xs text-gray-600">${caddie.promotedCourse.holes} holes</span>
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-1">
                            <span class="w-2 h-2 rounded-full ${caddie.availability === 'available' ? 'bg-green-500' : 'bg-red-500'}"></span>
                            <span class="text-xs font-medium ${caddie.availability === 'available' ? 'text-green-700' : 'text-red-700'}">
                                ${caddie.availability === 'available' ? 'Available' : 'Join Waitlist'}
                            </span>
                        </div>
                        <span class="text-xs text-gray-500">${caddie.totalRounds} rounds</span>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-3 flex gap-2">
                        ${caddie.availability === 'available' ?
                            `<button onclick="bookCaddyFromFeature('${caddie.id}', '${caddie.name}')" class="flex-1 bg-primary-600 text-white text-xs py-2 px-3 rounded-lg hover:bg-primary-700 transition-colors">
                                <span class="material-symbols-outlined text-xs mr-1">event_available</span>
                                Book Now
                            </button>` :
                            `<button onclick="joinWaitlistFromFeature('${caddie.id}', '${caddie.name}')" class="flex-1 bg-orange-500 text-white text-xs py-2 px-3 rounded-lg hover:bg-orange-600 transition-colors">
                                <span class="material-symbols-outlined text-xs mr-1">schedule</span>
                                Join Waitlist
                            </button>`
                        }
                        <button onclick="selectCaddy('${caddie.id}', true)" class="bg-gray-100 text-gray-700 text-xs py-2 px-3 rounded-lg hover:bg-gray-200 transition-colors">
                            <span class="material-symbols-outlined text-xs">info</span>
                        </button>
                    </div>
                </div>
            `;

            // Populate mobile container (horizontal scrolling)
            if (mobileContainer) {
                mobileContainer.innerHTML = promotionalCaddys.map(caddie =>
                    generateCaddyCard(caddie, true)
                ).join('');
            }

            // Populate desktop container (grid layout)
            if (desktopContainer) {
                desktopContainer.innerHTML = promotionalCaddys.map(caddie =>
                    generateCaddyCard(caddie, false)
                ).join('');
            }
        }

        function refreshPromotionalCaddys() {
            const mobileContainer = document.getElementById('promotionalCaddysContainer');
            const desktopContainer = document.getElementById('promotionalCaddysDesktop');

            // Loading animation HTML
            const loadingHTML = `
                <div class="text-center py-8 ${mobileContainer ? 'mobile-caddie-card flex-shrink-0' : 'col-span-4'}">
                    <div class="inline-flex items-center space-x-2">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600"></div>
                        <span class="text-gray-600">Finding new caddies...</span>
                    </div>
                </div>
            `;

            // Add loading animation to both containers
            if (mobileContainer) {
                mobileContainer.innerHTML = loadingHTML;
            }
            if (desktopContainer) {
                desktopContainer.innerHTML = loadingHTML.replace('mobile-caddie-card flex-shrink-0', 'col-span-4');
            }

            // Load new promotional caddies after brief delay
            setTimeout(() => {
                loadPromotionalCaddys();
            }, 800);
        }

        // Test function to simulate caddie becoming available
        function testCaddyAvailability() {
            const bookedCaddys = CaddySystem.allCaddys.filter(c => c.availability === 'booked');
            if (bookedCaddys.length > 0) {
                const randomCaddy = bookedCaddys[0];
                randomCaddy.availability = 'available';

                // Send offer to first person in waitlist
                CaddySystem.processNextInWaitlist(randomCaddy.id);

                console.log(`[TEST] ${randomCaddy.name} is now available`);
            }
        }

        function toggleService(serviceId) {
            const service = BookingSystem.serviceOptions.find(s => s.id === serviceId);
            if (!service) return;

            const existingIndex = BookingSystem.currentBooking.services.findIndex(s => s.id === serviceId);
            const serviceElement = document.querySelector(`[data-service="${serviceId}"]`);

            if (existingIndex >= 0) {
                BookingSystem.currentBooking.services.splice(existingIndex, 1);
                serviceElement.classList.remove('border-primary-500', 'bg-primary-50');
                serviceElement.classList.add('border-gray-200');
            } else {
                BookingSystem.currentBooking.services.push(service);
                serviceElement.classList.remove('border-gray-200');
                serviceElement.classList.add('border-primary-500', 'bg-primary-50');
            }

            BookingSystem.updateSummary();
        }

        function selectPaymentMethod(method) {
            // Update new booking cart system
            if (!bookingCart.paymentMethod) {
                bookingCart.paymentMethod = method;
            } else {
                bookingCart.paymentMethod = method;
            }

            // Update old booking system for compatibility
            BookingSystem.currentBooking.paymentMethod = method;

            // Update UI
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('border-primary-500', 'bg-primary-50');
                opt.classList.add('border-gray-200');
            });
            const selectedOption = document.querySelector(`[data-payment="${method}"]`);
            if (selectedOption) {
                selectedOption.classList.remove('border-gray-200');
                selectedOption.classList.add('border-primary-500', 'bg-primary-50');
            }

            // Update cart display to enable confirm button
            updateBookingCartDisplay();

            NotificationManager.show(`Payment method set to ${method}`, 'success');
        }

        function resetBookingForm() {
            BookingSystem.currentBooking = {
                course: null, date: null, time: null, players: 1,
                caddies: [], services: [], paymentMethod: null, total: 0
            };
            document.querySelectorAll('.course-option, .payment-option').forEach(option => {
                option.classList.remove('border-primary-500', 'bg-primary-50');
                option.classList.add('border-gray-200');
            });
            document.querySelectorAll('[data-caddie], [data-service]').forEach(option => {
                option.classList.remove('border-primary-500', 'bg-primary-50');
                option.classList.add('border-gray-200');
            });
            document.getElementById('bookingDate').value = '';
            document.getElementById('bookingTime').value = '';
            document.getElementById('playerCount').value = '1';
        }

        // Legacy booking system function - redirects to new system
        function confirmBookingOld() {
            const booking = BookingSystem.currentBooking;

            booking.date = document.getElementById('bookingDate')?.value;
            booking.time = document.getElementById('bookingTime')?.value;
            booking.players = parseInt(document.getElementById('playerCount')?.value || 1);

            if (!booking.course || !booking.date || !booking.time) {
                NotificationManager.show('Please complete all required booking details', 'error');
                return;
            }

            if (!booking.paymentMethod) {
                NotificationManager.show('Please select a payment method', 'error');
                return;
            }

            LoadingManager.show('Processing your booking and payment...');

            setTimeout(() => {
                const bookingId = 'MCP' + Date.now().toString().slice(-6);
                NotificationManager.show(`Booking confirmed! Reference: ${bookingId}. Confirmation sent to your email.`, 'success');
                LoadingManager.hide();

                // Reset booking form
                resetBookingForm();
                showGolferTab('overview');
            }, 3000);
        }

        function cancelBooking() {
            resetBookingForm();
            showGolferTab('overview');
        }

        // Enhanced Google Maps GPS & Navigation System
        // Make globally accessible to prevent duplicate initialization
        window.googleMap = null;
        let playerMarker = null;
        let holeMarkers = [];
        let currentMapType = 'satellite';

        // Shorthand for local use
        let googleMap = window.googleMap;

        // Make GPSNavigationSystem globally accessible
        window.GPSNavigationSystem = {
            currentPosition: null,
            courseData: {
                name: 'Royal Thai Golf Course',
                par: 72,
                totalDistance: 6847,
                // Sample golf course coordinates (Pattaya area)
                center: { lat: 12.9236, lng: 100.8854 },
                holes: [
                    { number: 1, par: 4, distance: 425, teeBox: {lat: 13.7563, lng: 100.5018}, pin: {lat: 13.7568, lng: 100.5025}, hazards: ['bunker', 'water'] },
                    { number: 2, par: 3, distance: 185, teeBox: {lat: 13.7570, lng: 100.5028}, pin: {lat: 13.7575, lng: 100.5032}, hazards: ['bunker'] },
                    { number: 3, par: 5, distance: 520, teeBox: {lat: 13.7578, lng: 100.5035}, pin: {lat: 13.7585, lng: 100.5045}, hazards: ['water', 'trees'] },
                    { number: 4, par: 4, distance: 380, teeBox: {lat: 13.7588, lng: 100.5048}, pin: {lat: 13.7592, lng: 100.5053}, hazards: ['bunker'] },
                    { number: 5, par: 4, distance: 410, teeBox: {lat: 13.7595, lng: 100.5056}, pin: {lat: 13.7600, lng: 100.5062}, hazards: ['trees'] },
                    { number: 6, par: 3, distance: 165, teeBox: {lat: 13.7603, lng: 100.5065}, pin: {lat: 13.7607, lng: 100.5068}, hazards: ['water'] },
                    { number: 7, par: 4, distance: 395, teeBox: {lat: 13.7610, lng: 100.5071}, pin: {lat: 13.7615, lng: 100.5078}, hazards: ['bunker', 'trees'] },
                    { number: 8, par: 5, distance: 485, teeBox: {lat: 13.7618, lng: 100.5081}, pin: {lat: 13.7625, lng: 100.5090}, hazards: ['water'] },
                    { number: 9, par: 4, distance: 365, teeBox: {lat: 13.7628, lng: 100.5093}, pin: {lat: 13.7632, lng: 100.5098}, hazards: ['bunker'] },
                    { number: 10, par: 4, distance: 420, teeBox: {lat: 13.7635, lng: 100.5101}, pin: {lat: 13.7640, lng: 100.5108}, hazards: ['trees'] },
                    { number: 11, par: 3, distance: 175, teeBox: {lat: 13.7643, lng: 100.5111}, pin: {lat: 13.7647, lng: 100.5115}, hazards: ['water'] },
                    { number: 12, par: 5, distance: 510, teeBox: {lat: 13.7650, lng: 100.5118}, pin: {lat: 13.7658, lng: 100.5128}, hazards: ['bunker', 'water'] },
                    { number: 13, par: 4, distance: 400, teeBox: {lat: 13.7661, lng: 100.5131}, pin: {lat: 13.7666, lng: 100.5138}, hazards: ['trees'] },
                    { number: 14, par: 4, distance: 385, teeBox: {lat: 13.7669, lng: 100.5141}, pin: {lat: 13.7673, lng: 100.5146}, hazards: ['bunker'] },
                    { number: 15, par: 3, distance: 155, teeBox: {lat: 13.7676, lng: 100.5149}, pin: {lat: 13.7679, lng: 100.5152}, hazards: ['water'] },
                    { number: 16, par: 4, distance: 435, teeBox: {lat: 13.7682, lng: 100.5155}, pin: {lat: 13.7688, lng: 100.5162}, hazards: ['bunker', 'trees'] },
                    { number: 17, par: 5, distance: 495, teeBox: {lat: 13.7691, lng: 100.5165}, pin: {lat: 13.7699, lng: 100.5175}, hazards: ['water'] },
                    { number: 18, par: 4, distance: 445, teeBox: {lat: 13.7702, lng: 100.5178}, pin: {lat: 13.7708, lng: 100.5185}, hazards: ['bunker', 'water'] }
                ]
            },
            currentHole: 1,
            trackingActive: false,
            paceOfPlay: {
                startTime: null,
                holeStartTimes: {},
                targetTimes: [15, 12, 18, 15, 16, 10, 16, 18, 14, 16, 11, 19, 15, 15, 9, 17, 19, 17] // minutes per hole
            },
            weatherConditions: {
                temperature: 32,
                humidity: 75,
                windSpeed: 8,
                windDirection: 'NE',
                condition: 'partly_cloudy'
            }
        };

        // Shorthand reference for local use
        const GPSNavigationSystem = window.GPSNavigationSystem;

        function getCurrentLocation() {
            if (!navigator.geolocation) {
                NotificationManager.show('GPS not supported by this device', 'error');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    GPSNavigationSystem.currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date()
                    };

                    updateLocationDisplay();
                    detectCurrentHole();
                    calculateDistances();

                    // Update OpenStreetMap with real location
                    if (googleMap) {
                        updatePlayerLocation(GPSNavigationSystem.currentPosition);
                        googleMap.setView([position.coords.latitude, position.coords.longitude], 17);
                    }

                    NotificationManager.show('📍 Location updated with ±' + Math.round(position.coords.accuracy) + 'm accuracy', 'success');
                },
                (error) => {
                    let errorMessage = 'Unable to get your location. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Please allow location access.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Location request timed out.';
                            break;
                    }
                    NotificationManager.show(errorMessage, 'error');
                    console.error('GPS Error:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0  // Always get fresh location, never use cache
                }
            );
        }

        function startGPSTracking() {
            if (!navigator.geolocation) {
                NotificationManager.show('GPS not supported by this device', 'error');
                return;
            }

            GPSNavigationSystem.trackingActive = true;
            GPSNavigationSystem.paceOfPlay.startTime = new Date();
            GPSNavigationSystem.paceOfPlay.holeStartTimes[GPSNavigationSystem.currentHole] = new Date();

            const trackingOptions = {
                enableHighAccuracy: true,  // Use GPS, not WiFi/cell tower
                timeout: 15000,             // 15s timeout - give GPS time to get accurate fix
                maximumAge: 0               // Never use cached position - always fresh
            };

            const trackingId = navigator.geolocation.watchPosition(
                (position) => {
                    GPSNavigationSystem.currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        speed: position.coords.speed,
                        heading: position.coords.heading,
                        timestamp: new Date()
                    };

                    updateLocationDisplay();
                    detectCurrentHole();
                    calculateDistances();
                    updatePaceOfPlay();

                    // Update map in real-time
                    if (googleMap) {
                        updatePlayerLocation(GPSNavigationSystem.currentPosition);
                    }

                    console.log('[GPS] Updated:', position.coords.latitude.toFixed(6), position.coords.longitude.toFixed(6), '±' + Math.round(position.coords.accuracy) + 'm');
                },
                (error) => {
                    // Silent error handling for watchPosition - don't spam user with timeout messages
                    // GPS will keep trying in background
                    console.log('[GPS] Waiting for better signal... (accuracy may improve)', error.code);
                },
                trackingOptions
            );

            GPSNavigationSystem.trackingId = trackingId;
            NotificationManager.show('🎯 Real-time GPS tracking started', 'success');
        }

        function stopGPSTracking() {
            if (GPSNavigationSystem.trackingId) {
                navigator.geolocation.clearWatch(GPSNavigationSystem.trackingId);
                GPSNavigationSystem.trackingActive = false;
                NotificationManager.show('GPS tracking stopped', 'info');
            }
        }

        function detectCurrentHole() {
            if (!GPSNavigationSystem.currentPosition) return;

            const currentPos = GPSNavigationSystem.currentPosition;
            let closestHole = 1;
            let minDistance = Infinity;

            GPSNavigationSystem.courseData.holes.forEach(hole => {
                const distance = calculateDistance(
                    currentPos.lat, currentPos.lng,
                    hole.teeBox.lat, hole.teeBox.lng
                );

                if (distance < minDistance) {
                    minDistance = distance;
                    closestHole = hole.number;
                }
            });

            if (GPSNavigationSystem.currentHole !== closestHole) {
                GPSNavigationSystem.currentHole = closestHole;
                GPSNavigationSystem.paceOfPlay.holeStartTimes[closestHole] = new Date();
                updateHoleDisplay();

                // Update GPS positions for traffic monitor
                updateGPSPositionsForTrafficMonitor();
            }
        }

        function updateGPSPositionsForTrafficMonitor() {
            // Get current user profile to find caddy number
            const userProfile = JSON.parse(localStorage.getItem('mcipro_user_profile') || 'null');
            if (!userProfile || !userProfile.caddyNumber) return;

            // Store GPS position with caddy number for traffic monitor
            const gpsPositions = JSON.parse(localStorage.getItem('mcipro_gps_positions') || '{}');
            gpsPositions[userProfile.caddyNumber] = {
                currentHole: GPSNavigationSystem.currentHole,
                position: GPSNavigationSystem.currentPosition,
                timestamp: Date.now()
            };
            localStorage.setItem('mcipro_gps_positions', JSON.stringify(gpsPositions));

            console.log(`[GPS] Updated position for Caddy #${userProfile.caddyNumber} - Hole ${GPSNavigationSystem.currentHole}`);
        }


        function calculateDistances() {
            if (!GPSNavigationSystem.currentPosition) return;

            const currentHole = GPSNavigationSystem.courseData.holes.find(h => h.number === GPSNavigationSystem.currentHole);
            if (!currentHole) return;

            const pos = GPSNavigationSystem.currentPosition;
            const distanceToPin = calculateDistance(pos.lat, pos.lng, currentHole.pin.lat, currentHole.pin.lng);

            updateDistanceDisplay({
                toPin: Math.round(distanceToPin),
                toFront: Math.round(distanceToPin * 0.85),
                toCenter: Math.round(distanceToPin * 0.92),
                toBack: Math.round(distanceToPin * 1.15)
            });
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            return distance * 1.09361; // Convert to yards
        }

        function updatePaceOfPlay() {
            const currentHole = GPSNavigationSystem.currentHole || 1;
            const totalHoles = 18;
            const progress = (currentHole / totalHoles) * 100;

            // Calculate expected time (4.5 hours for 18 holes)
            const expectedMinutesPerHole = (4.5 * 60) / 18; // 15 minutes per hole
            const expectedElapsedMinutes = currentHole * expectedMinutesPerHole;

            // Calculate actual elapsed time (from start of round)
            const roundStartTime = GPSNavigationSystem.roundStartTime || new Date();
            const actualElapsedMinutes = (new Date() - roundStartTime) / (1000 * 60);

            // Determine pace status
            let paceStatus = 'On Time';
            let paceColor = 'green';

            if (actualElapsedMinutes > expectedElapsedMinutes + 15) {
                paceStatus = 'Behind';
                paceColor = 'red';
            } else if (actualElapsedMinutes < expectedElapsedMinutes - 15) {
                paceStatus = 'Ahead';
                paceColor = 'blue';
            }

            // Update pace display
            const paceElements = document.querySelectorAll('.pace-status');
            paceElements.forEach(el => {
                if (el) {
                    el.textContent = paceStatus;
                    el.className = `pace-status font-bold text-2xl text-${paceColor}-600`;
                }
            });

            // Update progress bar
            const progressBars = document.querySelectorAll('.pace-progress');
            progressBars.forEach(bar => {
                if (bar) {
                    bar.style.width = `${progress}%`;
                    bar.className = `pace-progress h-2 rounded-full bg-${paceColor}-600`;
                }
            });

            // Update elapsed time display
            const elapsedElements = document.querySelectorAll('.elapsed-time');
            elapsedElements.forEach(el => {
                if (el) {
                    const hours = Math.floor(actualElapsedMinutes / 60);
                    const minutes = Math.floor(actualElapsedMinutes % 60);
                    el.textContent = `${hours}h ${minutes}m elapsed`;
                }
            });
        }

        function updateLocationDisplay() {
            const pos = GPSNavigationSystem.currentPosition;
            if (!pos) return;

            const elements = {
                currentLat: pos.lat.toFixed(6),
                currentLng: pos.lng.toFixed(6),
                gpsAccuracy: Math.round(pos.accuracy) + 'm',
                lastUpdate: pos.timestamp.toLocaleTimeString()
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });
        }

        function updateHoleDisplay() {
            const currentHole = GPSNavigationSystem.courseData.holes.find(h => h.number === GPSNavigationSystem.currentHole);
            if (!currentHole) return;

            const elements = {
                currentHole: currentHole.number,
                currentHoleNum: currentHole.number,
                currentPar: currentHole.par,
                holeDistance: currentHole.distance + ' yds'
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });

            renderHoleLayout();
        }

        function updateDistanceDisplay(distances) {
            const elements = {
                distanceToPin: distances.toPin,
                pinDistance: distances.toPin + ' yds',
                frontDistance: distances.toFront + ' yds',
                centerDistance: distances.toCenter + ' yds',
                backDistance: distances.toBack + ' yds'
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });
        }

        function renderHoleLayout() {
            const layoutContainer = document.getElementById('holeLayoutContainer');
            if (!layoutContainer) return;

            const hole = GPSNavigationSystem.courseData.holes.find(h => h.number === GPSNavigationSystem.currentHole);
            if (!hole) return;

            layoutContainer.innerHTML = `
                <div class="hole-layout bg-gradient-to-b from-green-100 to-green-200 rounded-xl p-6 relative" style="height: 300px;">
                    <div class="absolute top-4 left-4 bg-white px-3 py-1 rounded-lg shadow-md">
                        <span class="text-lg font-bold text-gray-900">Hole ${hole.number}</span>
                        <span class="text-sm text-gray-600 ml-2">Par ${hole.par} • ${hole.distance} yds</span>
                    </div>

                    <!-- Tee Box -->
                    <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 w-8 h-4 bg-blue-600 rounded-sm shadow-md"></div>
                    <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-xs text-blue-700 font-bold">TEE</div>

                    <!-- Pin & Green -->
                    <div class="absolute top-20 left-1/2 transform -translate-x-1/2 w-16 h-12 bg-green-400 rounded-full opacity-80"></div>
                    <div class="absolute top-16 left-1/2 transform -translate-x-1/2 w-2 h-8 bg-red-600 rounded-full shadow-md"></div>
                    <div class="absolute top-12 left-1/2 transform -translate-x-1/2 text-xs text-red-700 font-bold">PIN</div>

                    <!-- Current Position -->
                    ${GPSNavigationSystem.currentPosition ? `
                        <div class="absolute top-1/2 left-1/3 transform -translate-x-1/2 -translate-y-1/2 w-4 h-4 bg-primary-500 rounded-full border-2 border-white shadow-lg animate-pulse"></div>
                        <div class="absolute top-1/2 left-1/3 transform -translate-x-1/2 -translate-y-1/2 mt-6 text-xs text-primary-700 font-bold">YOU</div>
                    ` : ''}

                    <!-- Hazards -->
                    ${hole.hazards.includes('water') ? '<div class="absolute top-1/4 right-1/4 w-14 h-10 bg-blue-400 rounded-full opacity-70 shadow-inner"></div><div class="absolute top-1/4 right-1/4 w-14 h-10 flex items-center justify-center text-xs text-blue-800 font-bold">💧</div>' : ''}
                    ${hole.hazards.includes('bunker') ? '<div class="absolute top-3/4 left-1/4 w-10 h-8 bg-yellow-400 rounded-full opacity-80 shadow-inner"></div><div class="absolute top-3/4 left-1/4 w-10 h-8 flex items-center justify-center text-xs">🏖️</div>' : ''}
                    ${hole.hazards.includes('trees') ? '<div class="absolute top-1/3 left-1/6 w-6 h-8 bg-green-700 rounded-full opacity-80"></div><div class="absolute top-1/3 left-1/6 w-6 h-8 flex items-center justify-center text-xs">🌳</div>' : ''}
                </div>
            `;
        }

        function showWeatherInfo() {
            const weather = GPSNavigationSystem.weatherConditions;
            NotificationManager.show(
                `🌡️ ${weather.temperature}°C • 💨 ${weather.windSpeed}km/h ${weather.windDirection} • 💧 ${weather.humidity}% humidity`,
                'info'
            );
        }

        function measureDistance() {
            NotificationManager.show('Tap two points on the course to measure distance', 'info');
        }

        function findNearestCart() {
            LoadingManager.show('Locating nearest cart...');

            setTimeout(() => {
                LoadingManager.hide();
                NotificationManager.show('Nearest cart located: 50 yards northeast near hole 6 tee box', 'success');
            }, 1500);
        }

        function callMarshal() {
            LoadingManager.show('Contacting course marshal...');

            setTimeout(() => {
                LoadingManager.hide();
                NotificationManager.show('Marshal notified. They will be with you shortly.', 'success');
            }, 1500);
        }

        // Course Selection for Booking
        document.addEventListener('DOMContentLoaded', function() {
            // Set minimum date for booking
            const dateInput = document.getElementById('bookingDate');
            if (dateInput) {
                const today = new Date();
                dateInput.min = today.toISOString().split('T')[0];
            }

            // Course selection handlers
            document.querySelectorAll('.course-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selection from all options
                    document.querySelectorAll('.course-option').forEach(opt => {
                        opt.classList.remove('border-primary-500', 'bg-primary-50');
                        opt.classList.add('border-gray-200');
                    });

                    // Add selection to clicked option
                    this.classList.remove('border-gray-200');
                    this.classList.add('border-primary-500', 'bg-primary-50');

                    updateBookingSummary();
                });
            });

            // Booking form change handlers
            // PERFORMANCE: Create throttled version of the update function
            const throttledBookingUpdate = throttle(function() {
                // Update legacy booking system
                BookingSystem.currentBooking.date = document.getElementById('bookingDate')?.value;
                BookingSystem.currentBooking.time = document.getElementById('bookingTime')?.value;
                BookingSystem.currentBooking.players = parseInt(document.getElementById('playerCount')?.value || 1);
                BookingSystem.updateSummary();

                // Update new booking cart display to enable/disable confirm button
                updateBookingCartDisplay();
            }, 200);

            // Separate handler for date changes (not throttled)
            const handleDateChange = function() {
                // Reset the availability service when date changes
                if (selectedCourse && selectedCourse.id === 'pattana-golf-resort') {
                    // Force reload on date change
                    TeeSheetAvailabilityService.isBuilt = false;
                    TeeSheetAvailabilityService.loadAvailability();
                }

                // Also update booking system
                throttledBookingUpdate();
            };

            // Add event listener for date changes (dateInput already declared above)
            if (dateInput) {
                dateInput.addEventListener('change', handleDateChange);
            }

            // Time and player count use throttled update
            ['bookingTime', 'playerCount'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', throttledBookingUpdate);
                }
            });
        });

        function updateBookingSummary() {
            const selectedCourse = document.querySelector('.course-option.border-primary-500');
            const date = document.getElementById('bookingDate')?.value;
            const time = document.getElementById('bookingTime')?.value;
            const players = document.getElementById('playerCount')?.value;

            const summaryContainer = document.getElementById('bookingSummary');
            const totalContainer = document.getElementById('bookingTotal');

            if (!summaryContainer || !totalContainer) return;

            if (!selectedCourse || !date || !time || !players) {
                summaryContainer.innerHTML = '<p class="text-gray-600">Select course and date to see summary</p>';
                totalContainer.textContent = '฿0';
                return;
            }

            const courseName = selectedCourse.querySelector('h4').textContent;
            const coursePrice = parseInt(selectedCourse.querySelector('.text-primary-600').textContent.replace('฿', '').replace(',', ''));
            const total = coursePrice * parseInt(players);

            const formattedDate = new Date(date).toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });

            summaryContainer.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Course:</span>
                        <span class="font-medium">${courseName}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Date:</span>
                        <span class="font-medium">${formattedDate}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Time:</span>
                        <span class="font-medium">${time}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Players:</span>
                        <span class="font-medium">${players}</span>
                    </div>
                    <div class="flex justify-between border-t pt-2">
                        <span class="text-gray-600">Price per player:</span>
                        <span class="font-medium">฿${coursePrice.toLocaleString()}</span>
                    </div>
                </div>
            `;

            totalContainer.textContent = `฿${total.toLocaleString()}`;
        }

        // ===== PRO SHOP POS SYSTEM =====
        let proshopCart = [];

        // Pro Shop POS Functions
        function addToCart(name, price, sku) {
            const existingItem = proshopCart.find(item => item.sku === sku);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                proshopCart.push({
                    name: name,
                    price: price,
                    sku: sku,
                    quantity: 1
                });
            }

            updateCartDisplay();
            enablePaymentButtons();
        }

        function removeFromCart(sku) {
            proshopCart = proshopCart.filter(item => item.sku !== sku);
            updateCartDisplay();

            if (proshopCart.length === 0) {
                disablePaymentButtons();
            }
        }

        function updateCartQuantity(sku, quantity) {
            const item = proshopCart.find(item => item.sku === sku);
            if (item) {
                if (quantity <= 0) {
                    removeFromCart(sku);
                } else {
                    item.quantity = quantity;
                    updateCartDisplay();
                }
            }
        }

        function updateCartDisplay() {
            const cartItemsContainer = document.getElementById('cart-items');
            const subtotalEl = document.getElementById('cart-subtotal');
            const taxEl = document.getElementById('cart-tax');
            const totalEl = document.getElementById('cart-total');

            if (proshopCart.length === 0) {
                cartItemsContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <span class="material-symbols-outlined text-4xl mb-2 block">shopping_cart</span>
                        <p class="text-sm">Cart is empty</p>
                        <p class="text-xs">Add products to start a sale</p>
                    </div>
                `;
                subtotalEl.textContent = '₿0';
                taxEl.textContent = '₿0';
                totalEl.textContent = '₿0';
                return;
            }

            const cartHtml = proshopCart.map(item => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <p class="font-medium text-sm">${item.name}</p>
                        <p class="text-xs text-gray-600">₿${item.price.toLocaleString()} each</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="updateCartQuantity('${item.sku}', ${item.quantity - 1})"
                                class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-xs">-</button>
                        <span class="text-sm font-medium w-8 text-center">${item.quantity}</span>
                        <button onclick="updateCartQuantity('${item.sku}', ${item.quantity + 1})"
                                class="w-6 h-6 bg-purple-600 text-white rounded-full flex items-center justify-center text-xs">+</button>
                        <button onclick="removeFromCart('${item.sku}')"
                                class="ml-2 text-red-600 hover:text-red-800">
                            <span class="material-symbols-outlined text-sm">delete</span>
                        </button>
                    </div>
                </div>
            `).join('');

            cartItemsContainer.innerHTML = cartHtml;

            const subtotal = proshopCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * 0.07; // 7% tax
            const total = subtotal + tax;

            subtotalEl.textContent = `₿${subtotal.toLocaleString()}`;
            taxEl.textContent = `₿${Math.round(tax).toLocaleString()}`;
            totalEl.textContent = `₿${Math.round(total).toLocaleString()}`;
        }

        function clearCart() {
            proshopCart = [];
            updateCartDisplay();
            disablePaymentButtons();
        }

        function enablePaymentButtons() {
            document.getElementById('cash-btn').disabled = false;
            document.getElementById('card-btn').disabled = false;
        }

        function disablePaymentButtons() {
            document.getElementById('cash-btn').disabled = true;
            document.getElementById('card-btn').disabled = true;
        }

        function processPayment(method) {
            if (proshopCart.length === 0) return;

            const subtotal = proshopCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * 0.07;
            const total = subtotal + tax;
            const transactionId = 'TXN' + Date.now();

            // Simulate payment processing
            const paymentModal = document.createElement('div');
            paymentModal.className = 'modal-overlay';
            paymentModal.innerHTML = `
                <div class="modal-content max-w-md">
                    <div class="text-center py-6">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="material-symbols-outlined text-2xl text-green-600">check_circle</span>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Payment Successful!</h2>
                        <p class="text-gray-600 mb-4">Transaction #${transactionId}</p>
                        <div class="bg-gray-50 rounded-lg p-4 mb-4 text-left">
                            <div class="space-y-2">
                                ${proshopCart.map(item => `
                                    <div class="flex justify-between text-sm">
                                        <span>${item.name} x${item.quantity}</span>
                                        <span>₿${(item.price * item.quantity).toLocaleString()}</span>
                                    </div>
                                `).join('')}
                                <hr class="my-2">
                                <div class="flex justify-between text-sm">
                                    <span>Subtotal:</span>
                                    <span>₿${subtotal.toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Tax (7%):</span>
                                    <span>₿${Math.round(tax).toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between font-bold">
                                    <span>Total:</span>
                                    <span>₿${Math.round(total).toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between text-sm text-gray-600 mt-2">
                                    <span>Payment Method:</span>
                                    <span class="capitalize">${method}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="printReceipt('${transactionId}')" class="btn-outline flex-1">
                                <span class="material-symbols-outlined text-sm mr-2">print</span>
                                Print Receipt
                            </button>
                            <button onclick="closePaymentModal()" class="btn-primary flex-1">
                                New Sale
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(paymentModal);
            clearCart();
        }

        function printReceipt(transactionId) {
            // Simulate receipt printing
            alert(`Receipt for transaction ${transactionId} sent to printer.`);
        }

        function closePaymentModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        // Category filtering for products
        function filterByCategory(category) {
            const products = document.querySelectorAll('.product-card');
            const tabs = document.querySelectorAll('.category-tab');

            // Update active tab
            tabs.forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-category="${category}"]`).classList.add('active');

            // Filter products
            products.forEach(product => {
                if (category === 'all' || product.dataset.category === category) {
                    product.style.display = 'block';
                } else {
                    product.style.display = 'none';
                }
            });
        }

        // Initialize category tab listeners
        document.addEventListener('DOMContentLoaded', function() {
            const categoryTabs = document.querySelectorAll('.category-tab');
            categoryTabs.forEach(tab => {
                tab.addEventListener('click', () => filterByCategory(tab.dataset.category));
            });

            // Search functionality
            const searchInput = document.getElementById('product-search');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const products = document.querySelectorAll('.product-card');

                    products.forEach(product => {
                        const productName = product.querySelector('h4').textContent.toLowerCase();
                        if (productName.includes(searchTerm)) {
                            product.style.display = 'block';
                        } else {
                            product.style.display = 'none';
                        }
                    });
                });
            }
        });

        // ===== MAINTENANCE SYSTEM =====

        // Maintenance System for Course Updates and Photo Management
        const MaintenanceSystem = {
            courseUpdates: [],
            uploadedPhotos: [],

            // Initialize hole numbers based on course selection
            updateHoleNumbers() {
                const courseSection = document.getElementById('courseSection')?.value;
                const holeSelect = document.getElementById('holeNumber');

                if (!holeSelect) return;

                holeSelect.innerHTML = '<option value="">Select hole number...</option>';

                if (courseSection === 'A') {
                    for (let i = 1; i <= 9; i++) {
                        holeSelect.innerHTML += `<option value="${i}">Hole ${i}</option>`;
                    }
                } else if (courseSection === 'B') {
                    for (let i = 10; i <= 18; i++) {
                        holeSelect.innerHTML += `<option value="${i}">Hole ${i}</option>`;
                    }
                } else if (courseSection === 'C') {
                    holeSelect.innerHTML += '<option value="range">Practice Range</option>';
                    holeSelect.innerHTML += '<option value="driving">Driving Range</option>';
                } else if (courseSection === 'D') {
                    holeSelect.innerHTML += '<option value="putting">Putting Green</option>';
                    holeSelect.innerHTML += '<option value="chipping">Chipping Area</option>';
                }
            },

            // Handle photo upload and preview
            handlePhotoUpload(files) {
                const previewContainer = document.getElementById('photoPreview');
                if (!previewContainer) return;

                Array.from(files).forEach((file, index) => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const photoId = Date.now() + '_' + index;
                            this.uploadedPhotos.push({
                                id: photoId,
                                data: e.target.result,
                                name: file.name,
                                size: file.size
                            });

                            const photoDiv = document.createElement('div');
                            photoDiv.className = 'relative group';
                            photoDiv.innerHTML = `
                                <img src="${e.target.result}" class="w-full h-24 object-cover rounded-lg border">
                                <button onclick="MaintenanceSystem.removePhoto('${photoId}')"
                                        class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                                    <span class="material-symbols-outlined text-xs">close</span>
                                </button>
                                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 rounded-b-lg">
                                    ${file.name}
                                </div>
                            `;
                            previewContainer.appendChild(photoDiv);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            },

            // Remove photo from upload
            removePhoto(photoId) {
                this.uploadedPhotos = this.uploadedPhotos.filter(photo => photo.id !== photoId);

                const previewContainer = document.getElementById('photoPreview');
                if (previewContainer) {
                    previewContainer.innerHTML = '';
                    // Re-render remaining photos
                    this.uploadedPhotos.forEach(photo => {
                        const photoDiv = document.createElement('div');
                        photoDiv.className = 'relative group';
                        photoDiv.innerHTML = `
                            <img src="${photo.data}" class="w-full h-24 object-cover rounded-lg border">
                            <button onclick="MaintenanceSystem.removePhoto('${photo.id}')"
                                    class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="material-symbols-outlined text-xs">close</span>
                            </button>
                            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 rounded-b-lg">
                                ${photo.name}
                            </div>
                        `;
                        previewContainer.appendChild(photoDiv);
                    });
                }
            },

            // Submit course update
            submitCourseUpdate() {
                const courseSection = document.getElementById('courseSection')?.value;
                const holeNumber = document.getElementById('holeNumber')?.value;
                const areaType = document.getElementById('areaType')?.value;
                const issuePriority = document.getElementById('issuePriority')?.value;
                const issueDescription = document.getElementById('issueDescription')?.value;

                if (!courseSection || !areaType || !issueDescription) {
                    alert('Please fill in all required fields');
                    return;
                }

                const update = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    courseSection,
                    holeNumber,
                    areaType,
                    priority: issuePriority || 'medium',
                    description: issueDescription,
                    photos: [...this.uploadedPhotos],
                    reporter: AppState.currentUser.name,
                    status: 'open'
                };

                this.courseUpdates.unshift(update);
                this.renderRecentUpdates();
                this.clearForm();

                // Show success message
                alert('Course update submitted successfully!');

                // Notify management and caddies via chat
                this.notifyStaffOfUpdate(update);
            },

            // Notify staff through chat system
            notifyStaffOfUpdate(update) {
                // TODO: Implement chat notifications with professional chat system
                console.log('[Course Update Notification]', update);
            },

            // Clear the form after submission
            clearForm() {
                document.getElementById('courseSection').value = '';
                document.getElementById('holeNumber').innerHTML = '<option value="">Select hole number...</option>';
                document.getElementById('areaType').value = '';
                document.getElementById('issuePriority').value = 'low';
                document.getElementById('issueDescription').value = '';
                document.getElementById('photoPreview').innerHTML = '';
                this.uploadedPhotos = [];
            },

            // Render recent updates
            renderRecentUpdates() {
                const container = document.getElementById('recentUpdates');
                if (!container) return;

                if (this.courseUpdates.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <span class="material-symbols-outlined text-6xl mb-4 block">grass</span>
                            <p>No recent course updates</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.courseUpdates.map(update => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="p-2 ${this.getPriorityColor(update.priority)} rounded-lg">
                                    <span class="material-symbols-outlined">${this.getAreaIcon(update.areaType)}</span>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-800">Course ${update.courseSection}${update.holeNumber ? ` - Hole ${update.holeNumber}` : ''}</h4>
                                    <p class="text-sm text-gray-600">${update.areaType.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="px-2 py-1 ${this.getPriorityBadgeColor(update.priority)} text-xs font-medium rounded-full">
                                    ${update.priority.toUpperCase()}
                                </span>
                                <p class="text-xs text-gray-500 mt-1">${this.formatTimestamp(update.timestamp)}</p>
                            </div>
                        </div>

                        <p class="text-gray-700 mb-3">${update.description}</p>

                        ${update.photos.length > 0 ? `
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
                                ${update.photos.map(photo => `
                                    <img src="${photo.data}" alt="${photo.name}"
                                         class="w-full h-20 object-cover rounded-lg border cursor-pointer hover:opacity-80"
                                         onclick="MaintenanceSystem.showPhotoModal('${photo.data}', '${photo.name}')">
                                `).join('')}
                            </div>
                        ` : ''}

                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600">Reported by: <strong>${update.reporter}</strong></span>
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">${update.status}</span>
                        </div>
                    </div>
                `).join('');
            },

            // Show photo in modal
            showPhotoModal(photoData, photoName) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="max-w-4xl max-h-full p-4">
                        <div class="bg-white rounded-lg overflow-hidden">
                            <div class="p-4 border-b flex items-center justify-between">
                                <h3 class="font-semibold">${photoName}</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                    <span class="material-symbols-outlined">close</span>
                                </button>
                            </div>
                            <img src="${photoData}" alt="${photoName}" class="max-w-full max-h-96 object-contain">
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            },

            // Helper functions
            getPriorityColor(priority) {
                const colors = {
                    'low': 'bg-blue-100 text-blue-600',
                    'medium': 'bg-yellow-100 text-yellow-600',
                    'high': 'bg-orange-100 text-orange-600',
                    'critical': 'bg-red-100 text-red-600'
                };
                return colors[priority] || colors.medium;
            },

            getPriorityBadgeColor(priority) {
                const colors = {
                    'low': 'bg-blue-100 text-blue-700',
                    'medium': 'bg-yellow-100 text-yellow-700',
                    'high': 'bg-orange-100 text-orange-700',
                    'critical': 'bg-red-100 text-red-700'
                };
                return colors[priority] || colors.medium;
            },

            getAreaIcon(areaType) {
                const icons = {
                    'tee-box': 'sports_golf',
                    'fairway': 'grass',
                    'rough': 'nature',
                    'fairway-bunker': 'terrain',
                    'greenside-bunker': 'terrain',
                    'green': 'flag',
                    'flag-cup': 'golf_course'
                };
                return icons[areaType] || 'grass';
            },

            formatTimestamp(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                if (diffDays > 0) {
                    return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                } else if (diffHours > 0) {
                    return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                } else {
                    const diffMins = Math.floor(diffMs / (1000 * 60));
                    return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
                }
            },

            // Load sample data
            loadSampleData() {
                this.courseUpdates = [
                    {
                        id: 1,
                        timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                        courseSection: 'A',
                        holeNumber: '5',
                        areaType: 'green',
                        priority: 'high',
                        description: 'Green has several bare spots that need reseeding. The condition affects putting quality.',
                        photos: [],
                        reporter: 'Tom Rodriguez',
                        status: 'open'
                    },
                    {
                        id: 2,
                        timestamp: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString(),
                        courseSection: 'B',
                        holeNumber: '12',
                        areaType: 'fairway-bunker',
                        priority: 'medium',
                        description: 'Sand needs to be added and raked. Some contamination from nearby fairway.',
                        photos: [],
                        reporter: 'Maria Santos',
                        status: 'open'
                    }
                ];
            }
        };

        // Global functions for maintenance
        function handlePhotoUpload(event) {
            MaintenanceSystem.handlePhotoUpload(event.target.files);
        }

        function submitCourseUpdate() {
            MaintenanceSystem.submitCourseUpdate();
        }

        // Initialize course section change listener
        document.addEventListener('DOMContentLoaded', function() {
            const courseSelect = document.getElementById('courseSection');
            if (courseSelect) {
                courseSelect.addEventListener('change', () => MaintenanceSystem.updateHoleNumbers());
            }

            // Load sample data when maintenance dashboard is accessed
            setTimeout(() => {
                MaintenanceSystem.loadSampleData();
                MaintenanceSystem.renderRecentUpdates();
            }, 1000);
        });

        // ===== WAITLIST & BOOKING MANAGEMENT =====

        // Ning Caddy Booking Demo Functions
        function demonstrateNingBooking() {
            const ningCaddy = CaddySystem.allCaddys.find(c => c.id === 'pat001');
            if (!ningCaddy) {
                alert('Ning not found in system');
                return;
            }

            if (ningCaddy.availability === 'booked') {
                // Show current booking info and waitlist option
                const waitlistPosition = EnhancedBookingManager.waitlists['pat001']?.length + 1 || 1;
                const confirmJoin = confirm(`Ning Prasert is currently booked until 13:00 today.

Current booking: Private Golf Lesson at Pattana Golf Resort
Waitlist position available: #${waitlistPosition}

Would you like to join the waitlist?`);

                if (confirmJoin) {
                    const golferName = prompt('Enter your name for the waitlist:') || AppState.currentUser.name;
                    EnhancedBookingManager.joinWaitlist('pat001');
                    alert(`Successfully added to Ning's waitlist at position #${waitlistPosition}!

You will be notified when she becomes available.`);
                }
            } else {
                // Direct booking available
                alert(`Ning Prasert is available for immediate booking!

Pattana Golf Resort & Spa
Rating: ★${ningCaddy.rating}
Specialty: ${ningCaddy.specialty}`);
            }
        }

        function showNingAvailability() {
            const ningCaddy = CaddySystem.allCaddys.find(c => c.id === 'pat001');
            const waitlist = EnhancedBookingManager.waitlists['pat001'] || [];

            let statusMessage = `🏌️ Ning Prasert - Pattana Golf Resort

Status: ${ningCaddy.availability === 'booked' ? '🔴 Currently Booked' : '🟢 Available'}
Rating: ★${ningCaddy.rating} (${ningCaddy.reviews} reviews)
Experience: ${ningCaddy.experience} years
Total Rounds: ${ningCaddy.totalRounds}`;

            if (ningCaddy.currentBooking) {
                statusMessage += `

📅 Current Booking:
• ${ningCaddy.currentBooking.golfer}
• ${ningCaddy.currentBooking.date} at ${ningCaddy.currentBooking.time}
• ${ningCaddy.currentBooking.holes} holes`;
            }

            if (waitlist.length > 0) {
                statusMessage += `

⏳ Waitlist (${waitlist.length} people):`;
                waitlist.forEach((person, index) => {
                    statusMessage += `\n${index + 1}. ${person.golferName}`;
                });
            }

            alert(statusMessage);
        }

        // Enhanced Booking Manager with Edit/Cancel capabilities
        const EnhancedBookingManager = {
            waitlists: {
                'pat001': [ // Ning Prasert - has waitlist due to being booked
                    { id: 'w101', golferName: 'David Kim', joinTime: new Date(Date.now() - 3 * 60 * 60 * 1000), priority: 1 },
                    { id: 'w102', golferName: 'Maria Rodriguez', joinTime: new Date(Date.now() - 2 * 60 * 60 * 1000), priority: 2 },
                    { id: 'w103', golferName: 'James Wilson', joinTime: new Date(Date.now() - 1 * 60 * 60 * 1000), priority: 3 }
                ],
                'c002': [], // Somchai Jaidee
                'c003': [   // Apinya Thaworn (busy)
                    { id: 'w1', golferName: 'Mike Chen', joinTime: new Date(Date.now() - 2 * 60 * 60 * 1000), priority: 1 },
                    { id: 'w2', golferName: 'Anna Smith', joinTime: new Date(Date.now() - 1 * 60 * 60 * 1000), priority: 2 },
                    { id: 'w3', golferName: 'David Kim', joinTime: new Date(Date.now() - 30 * 60 * 1000), priority: 3 }
                ],
                'c004': [] // Chaiwat Suksan
            },

            bookings: [
                {
                    id: 'booking001',
                    type: 'tee_time',
                    golferName: AppState.currentUser.name,
                    course: 'Pattaya Golf Club',
                    date: '2024-10-01',
                    time: '08:00 AM',
                    players: 2,
                    status: 'confirmed',
                    createdAt: new Date(Date.now() - 24 * 60 * 60 * 1000)
                },
                {
                    id: 'booking002',
                    type: 'caddie',
                    golferName: AppState.currentUser.name,
                    caddieName: 'Ning Prasert',
                    caddieId: 'c001',
                    date: '2024-10-01',
                    time: '08:00 AM',
                    status: 'confirmed',
                    createdAt: new Date(Date.now() - 24 * 60 * 60 * 1000)
                }
            ],

            // Join caddie waitlist
            joinWaitlist(caddieId, event) {
                if (event) event.stopPropagation();

                const caddieNames = {
                    'pat001': 'Ning Prasert',
                    'c002': 'Somchai Jaidee',
                    'c003': 'Apinya Thaworn',
                    'c004': 'Chaiwat Suksan'
                };

                // Check if already on waitlist
                const existingWaitlist = this.waitlists[caddieId].find(w => w.golferName === AppState.currentUser.name);
                if (existingWaitlist) {
                    alert('You are already on the waitlist for this caddie!');
                    return;
                }

                // Add to waitlist
                const waitlistEntry = {
                    id: 'w' + Date.now(),
                    golferName: AppState.currentUser.name,
                    joinTime: new Date(),
                    priority: this.waitlists[caddieId].length + 1
                };

                this.waitlists[caddieId].push(waitlistEntry);

                alert(`Added to waitlist for ${caddieNames[caddieId]}! You are position #${waitlistEntry.priority}`);
                this.updateWaitlistDisplay();
            },

            // Update waitlist display on cards
            updateWaitlistDisplay() {
                Object.keys(this.waitlists).forEach(caddieId => {
                    const waitlist = this.waitlists[caddieId];
                    const card = document.querySelector(`[data-caddie="${caddieId}"]`);
                    if (card && waitlist.length > 0) {
                        // Find existing waitlist info or create new
                        let waitlistInfo = card.querySelector('.waitlist-info');
                        if (!waitlistInfo) {
                            waitlistInfo = document.createElement('div');
                            waitlistInfo.className = 'waitlist-info text-xs text-gray-600 mt-2';
                            card.appendChild(waitlistInfo);
                        }
                        waitlistInfo.textContent = `Waitlist: ${waitlist.length} ${waitlist.length === 1 ? 'person' : 'people'}`;
                    }
                });
            },

            // Edit booking
            editBooking(bookingId) {
                const booking = this.bookings.find(b => b.id === bookingId);
                if (!booking) return;

                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4">
                        <h3 class="text-lg font-bold mb-4">Edit ${booking.type === 'tee_time' ? 'Tee Time' : 'Caddy'} Booking</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="date" id="editDate" value="${booking.date}" class="form-input w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                                <select id="editTime" class="form-select w-full">
                                    <option value="06:00 AM" ${booking.time === '06:00 AM' ? 'selected' : ''}>06:00 AM</option>
                                    <option value="07:00 AM" ${booking.time === '07:00 AM' ? 'selected' : ''}>07:00 AM</option>
                                    <option value="08:00 AM" ${booking.time === '08:00 AM' ? 'selected' : ''}>08:00 AM</option>
                                    <option value="09:00 AM" ${booking.time === '09:00 AM' ? 'selected' : ''}>09:00 AM</option>
                                    <option value="10:00 AM" ${booking.time === '10:00 AM' ? 'selected' : ''}>10:00 AM</option>
                                </select>
                            </div>
                            ${booking.type === 'tee_time' ? `
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Players</label>
                                <select id="editPlayers" class="form-select w-full">
                                    <option value="1" ${booking.players === 1 ? 'selected' : ''}>1 Player</option>
                                    <option value="2" ${booking.players === 2 ? 'selected' : ''}>2 Players</option>
                                    <option value="3" ${booking.players === 3 ? 'selected' : ''}>3 Players</option>
                                    <option value="4" ${booking.players === 4 ? 'selected' : ''}>4 Players</option>
                                </select>
                            </div>
                            ` : ''}
                        </div>
                        <div class="flex space-x-3 mt-6">
                            <button onclick="EnhancedBookingManager.saveBookingChanges('${bookingId}', this.closest('.fixed'))" class="btn-primary flex-1">Save Changes</button>
                            <button onclick="this.closest('.fixed').remove()" class="btn-secondary flex-1">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },

            // Save booking changes
            saveBookingChanges(bookingId, modal) {
                const booking = this.bookings.find(b => b.id === bookingId);
                if (!booking) return;

                const newDate = document.getElementById('editDate').value;
                const newTime = document.getElementById('editTime').value;

                booking.date = newDate;
                booking.time = newTime;

                // CRITICAL FIX: Update teeTime and slotTime for tee sheet compatibility
                // Convert time from "06:00 AM" to "06:00" 24-hour format
                let hour = parseInt(newTime.split(':')[0]);
                const minute = newTime.split(':')[1].split(' ')[0];
                const isPM = newTime.includes('PM');

                // Convert to 24-hour format
                if (isPM && hour !== 12) {
                    hour += 12;
                } else if (!isPM && hour === 12) {
                    hour = 0;
                }

                const time24 = `${hour.toString().padStart(2, '0')}:${minute}`;

                // Build ISO teeTime (Bangkok timezone UTC+7)
                const teeTime = `${newDate}T${time24}:00+07:00`;
                booking.teeTime = teeTime;
                booking.slotTime = teeTime;

                if (booking.type === 'tee_time') {
                    booking.players = parseInt(document.getElementById('editPlayers').value);
                }

                // Update timestamp
                booking.updatedAt = Date.now();

                console.log('[BookingManager] Updated booking:', {
                    id: bookingId,
                    date: newDate,
                    time: newTime,
                    teeTime: teeTime,
                    slotTime: teeTime
                });

                // Save to localStorage
                this.saveToLocalStorage();

                // Trigger cloud sync for cross-device updates
                if (typeof SimpleCloudSync !== 'undefined') {
                    console.log('[BookingManager] BOOKING UPDATED - TRIGGERING CLOUD SYNC');
                    SimpleCloudSync.saveToCloudSoon();
                }

                alert('Booking updated successfully!');
                modal.remove();
                this.refreshBookingDisplay();
            },

            // Cancel booking
            cancelBooking(bookingId) {
                const booking = this.bookings.find(b => b.id === bookingId);
                if (!booking) return;

                const confirmMsg = `Are you sure you want to cancel this ${booking.type === 'tee_time' ? 'tee time' : 'caddie'} booking?`;
                if (confirm(confirmMsg)) {
                    // Remove from bookings
                    this.bookings = this.bookings.filter(b => b.id !== bookingId);

                    // Send deletion tombstone to server
                    console.log('[BookingManager] BOOKING CANCELLED - SENDING DELETION TOMBSTONE');
                    SimpleCloudSync.handleDeletion('bookings', bookingId);

                    // Also save local state
                    this.saveToLocalStorage();

                    // If it's a caddie booking, notify next person on waitlist
                    if (booking.type === 'caddie' && booking.caddieId) {
                        this.notifyNextOnWaitlist(booking.caddieId);
                    }

                    alert('Booking cancelled successfully!');
                    this.refreshBookingDisplay();
                }
            },

            // Notify next person on waitlist
            notifyNextOnWaitlist(caddieId) {
                const waitlist = this.waitlists[caddieId];
                if (waitlist.length > 0) {
                    const nextPerson = waitlist.shift(); // Remove first person
                    // Re-prioritize remaining waitlist
                    waitlist.forEach((person, index) => {
                        person.priority = index + 1;
                    });

                    alert(`${nextPerson.golferName} has been notified of caddie availability!`);
                    this.updateWaitlistDisplay();
                }
            },

            // Refresh booking display (to be called after changes)
            refreshBookingDisplay() {
                // This would update the UI where bookings are displayed
                console.log('Booking display refreshed');
            },

            // Get golfer's current waitlist positions
            getGolferWaitlists() {
                const golferWaitlists = [];
                Object.keys(this.waitlists).forEach(caddieId => {
                    const waitlistEntry = this.waitlists[caddieId].find(w => w.golferName === AppState.currentUser.name);
                    if (waitlistEntry) {
                        const caddieNames = {
                            'pat001': 'Ning Prasert',
                            'c002': 'Somchai Jaidee',
                            'c003': 'Apinya Thaworn',
                            'c004': 'Chaiwat Suksan'
                        };
                        golferWaitlists.push({
                            caddieId,
                            caddieName: caddieNames[caddieId],
                            position: waitlistEntry.priority,
                            joinTime: waitlistEntry.joinTime
                        });
                    }
                });
                return golferWaitlists;
            },

            // Get caddie's current bookings and waitlist
            getCaddyInfo(caddieId) {
                const bookings = this.bookings.filter(b => b.caddieId === caddieId);
                const waitlist = this.waitlists[caddieId] || [];
                return { bookings, waitlist };
            }
        };

        // Today's Tee Time Display Manager
        const TodaysTeeTimeManager = {
            updateTodaysTeeTime() {
                const today = new Date().toISOString().split('T')[0];
                const bookings = BookingManager.bookings || [];

                // Find today's tee time bookings for current user
                const todaysBookings = bookings.filter(b => {
                    return b.date === today &&
                           (b.kind === 'tee' || b.type === 'tee_time') &&
                           b.status === 'confirmed';
                });

                console.log('[TodaysTeeTime] Checking for today:', today);
                console.log('[TodaysTeeTime] Found bookings:', todaysBookings.length);

                const contentDiv = document.getElementById('todaysTeeTimeContent');
                if (!contentDiv) return;

                if (todaysBookings.length > 0) {
                    // Show the first booking for today
                    const booking = todaysBookings[0];
                    contentDiv.innerHTML = `
                        <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-2">
                                    <span class="material-symbols-outlined text-green-600">golf_course</span>
                                    <span class="font-bold text-gray-900">${booking.course || booking.courseName || 'Golf Course'}</span>
                                </div>
                                <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">Confirmed</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <div class="text-gray-600">Tee Time</div>
                                    <div class="font-bold text-lg text-gray-900">${booking.time || 'Not set'}</div>
                                </div>
                                <div>
                                    <div class="text-gray-600">Players</div>
                                    <div class="font-bold text-lg text-gray-900">${booking.players || 1}</div>
                                </div>
                            </div>
                            ${booking.eventName ? `<div class="mt-3 text-sm text-gray-700">${booking.eventName}</div>` : ''}
                        </div>
                    `;
                } else {
                    // No bookings today
                    contentDiv.innerHTML = `
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="material-symbols-outlined text-gray-400 text-2xl">schedule</span>
                        </div>
                        <p class="text-gray-500 font-medium">No tee time booked today</p>
                        <p class="text-sm text-gray-400 mt-1">Book your next round to see it here</p>
                    `;
                }
            }
        };

        // Global functions for UI
        function joinWaitlist(caddieId, event) {
            EnhancedBookingManager.joinWaitlist(caddieId, event);
        }

        function editBooking(bookingId) {
            EnhancedBookingManager.editBooking(bookingId);
        }

        function cancelBooking(bookingId) {
            EnhancedBookingManager.cancelBooking(bookingId);
        }

        // Initialize waitlist display on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                EnhancedBookingManager.updateWaitlistDisplay();
            }, 500);
        });

        // BEGIN: emergency sound helpers
        window.playEmergencySiren = async function () {
            try {
                const audio = new Audio('/assets/sounds/emergency-siren.mp3');
                await audio.play();
                return true;
            } catch (err) {
                console.warn('Emergency siren failed; using fallback', err);
                return window.playFallbackAlert();
            }
        };

        window.playFallbackAlert = function () {
            try {
                const Ctx = window.AudioContext || window.webkitAudioContext;
                const ctx = new Ctx();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'sine';
                osc.frequency.value = 880;
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                setTimeout(() => {
                    try { osc.stop(); ctx.close(); } catch {}
                }, 600);
                return true;
            } catch {
                return false;
            }
        };
        // END: emergency sound helpers

        // Expose login function globally for inline onclick handlers
        window.login = async function (role) {
            console.log('[window.login] Called with role:', role);
            if (window.FallbackAuthentication?.login) {
                console.log('[window.login] Using FallbackAuthentication');
                return FallbackAuthentication.login(role);
            }
            if (window.Authentication?.login) return Authentication.login(role);
            if (window.Auth?.login) return Auth.login(role);
            if (window.LineAuthentication?.login) return LineAuthentication.login();
            // Fallback: just route to golfer dashboard for demos/dev
            if (window.ScreenManager?.navigateTo) {
                ScreenManager.navigateTo('golferDashboard');
                return true;
            }
            console.warn('No login handler found.');
            return false;
        };

    </script>

    <!-- Professional Chat System Styles -->
    <link rel="stylesheet" href="/chat/chat-system-styles.css?v=2025-10-12">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/mcipro.png">
    <link rel="shortcut icon" type="image/png" href="/mcipro.png">
    <link rel="apple-touch-icon" href="/mcipro.png">
</head>

<body>
    <script>
    console.log('%c🚀 PAGE VERSION: 2025-10-18-FIX-PAIRING-DUPLICATES', 'background: #00ff00; color: #000; font-size: 16px; font-weight: bold; padding: 10px;');
    console.log('[VERSION] Multiple format selection with inline handlers loaded');

    // IMMEDIATE OAuth detection - runs before DOMContentLoaded
    (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const storedState = localStorage.getItem('line_oauth_state');

        console.log('%c[IMMEDIATE CHECK] OAuth Callback Detection', 'background: #ff6600; color: #fff; font-weight: bold; padding: 5px;');
        const usedCode = sessionStorage.getItem('__line_code_used');
        console.log('[IMMEDIATE] URL:', window.location.href);
        console.log('[IMMEDIATE] code:', code ? `PRESENT (${code.substring(0, 10)}...)` : 'MISSING');
        console.log('[IMMEDIATE] state from URL:', state);
        console.log('[IMMEDIATE] storedState from localStorage:', storedState);
        console.log('[IMMEDIATE] states match:', state === storedState);
        console.log('[IMMEDIATE] sessionStorage __line_code_used:', usedCode ? `${usedCode.substring(0, 10)}...` : 'null');
        console.log('[IMMEDIATE] code === usedCode:', code === usedCode);

        if (code && state) {
            console.log('%c[IMMEDIATE] ✅ OAuth callback detected! Code and state are present.', 'background: #00ff00; color: #000; font-weight: bold;');
            if (state === storedState) {
                console.log('%c[IMMEDIATE] ✅ State validation PASSED', 'background: #00ff00; color: #000;');
            } else {
                console.log('%c[IMMEDIATE] ❌ State validation FAILED - states do not match!', 'background: #ff0000; color: #fff; font-weight: bold;');
            }
        } else {
            console.log('[IMMEDIATE] No OAuth callback (code/state missing)');
        }
    })();
    </script>
    <!-- Login Screen -->
    <div id="loginScreen" class="screen active">
        <div class="min-h-screen hero-gradient flex items-center justify-center p-6">
            <div class="glass-card p-10 w-full max-w-lg">
                <div class="text-center mb-10">
                    <!-- Language Selector -->
                    <div class="flex justify-center space-x-2 mb-6">
                        <button class="language-btn" data-lang="en" onclick="changeLanguage('en')" title="English">EN</button>
                        <button class="language-btn" data-lang="th" onclick="changeLanguage('th')" title="ภาษาไทย">TH</button>
                        <button class="language-btn" data-lang="ko" onclick="changeLanguage('ko')" title="한국어">KO</button>
                        <button class="language-btn" data-lang="ja" onclick="changeLanguage('ja')" title="日本語">JA</button>
                    </div>

                    <div class="w-40 h-40 mx-auto mb-6">
                        <img src="mcipro.png" alt="MciPro Logo" class="w-full h-full object-contain">
                    </div>
                    <p class="text-lg text-gray-600 mb-4" data-i18n="app.subtitle">Professional Golf Course Management</p>
                    <div class="flex items-center justify-center space-x-2 text-sm text-gray-600">
                        <div class="status-online"></div>
                        <span>System Online • Enterprise Security</span>
                    </div>
                </div>

                <!-- LINE Login Section -->
                <div id="lineLoginContainer" class="space-y-8" style="display: block;">
                    <button onclick="loginWithLINE()" class="line-login-btn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.627-.63h2.386c.349 0 .63.285.63.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.627-.63.349 0 .631.285.631.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.281.628-.629.628M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
                        </svg>
                        Login with LINE
                    </button>

                    <div class="relative">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-6 bg-white text-gray-500 font-medium">Enterprise Access Options</span>
                        </div>
                    </div>
                </div>

                <!-- Fallback Login Options -->
                <div id="fallbackLoginContainer" class="space-y-4" style="display: block;">
                    <button onclick="login('golfer')" class="btn-primary w-full justify-center">
                        <span class="material-symbols-outlined">sports_golf</span>
                        Golfer Access
                    </button>
                    <button onclick="login('caddie')" class="btn-secondary w-full justify-center">
                        <span class="material-symbols-outlined">person_add</span>
                        Caddy Access
                    </button>
                    <button onclick="login('manager')" class="w-full btn-primary justify-center" style="background: var(--orange-600);">
                        <span class="material-symbols-outlined">manage_accounts</span>
                        Manager Access
                    </button>
                    <button onclick="login('proshop')" class="w-full btn-primary justify-center" style="background: var(--purple-600);">
                        <span class="material-symbols-outlined">storefront</span>
                        Pro Shop Access
                    </button>
                    <button onclick="login('maintenance')" class="w-full btn-primary justify-center" style="background: #065f46; color: white;">
                        <span class="material-symbols-outlined">grass</span>
                        Maintenance Access
                    </button>
                    <button onclick="login('society')" class="w-full btn-primary justify-center mt-4" style="background: var(--orange-600);">
                        <span class="material-symbols-outlined">groups</span>
                        Society Organizer
                    </button>
                </div>

                <div class="mt-8 text-center space-y-3">
                    <button onclick="showCreateProfileScreen()" class="w-full btn-primary justify-center" style="background: #10b981; color: white;">
                        <span class="material-symbols-outlined">person_add</span>
                        Create New Profile
                    </button>
                    <button onclick="showOTPScreen()" class="text-primary-600 hover:text-primary-700 font-semibold text-sm transition-colors">
                        <span class="material-symbols-outlined text-sm mr-1">smartphone</span>
                        Mobile Authentication (SMS)
                    </button>
                </div>

                <div class="mt-8 text-center text-xs text-gray-500">
                    <p class="font-semibold">© 2025 MciPro Enterprise Platform</p>
                    <p>Professional Golf Course Management Solution</p>
                </div>
            </div>
        </div>
    </div>

    <!-- OTP Authentication Screen -->
    <div id="otpScreen" class="screen">
        <div class="min-h-screen hero-gradient flex items-center justify-center p-6">
            <div class="glass-card p-10 w-full max-w-lg">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <span class="material-symbols-outlined text-2xl text-primary-600">smartphone</span>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-3">Mobile Verification</h2>
                    <p class="text-gray-600">Enter your phone number to receive a secure access code</p>
                </div>

                <div class="space-y-6">
                    <div>
                        <label class="form-label">Phone Number</label>
                        <input type="tel" id="phoneInput" class="form-input" placeholder="+66 XX XXX XXXX" maxlength="15">
                    </div>

                    <button onclick="sendOTP()" id="sendOTPBtn" class="btn-primary w-full justify-center">
                        <span class="material-symbols-outlined">send</span>
                        Send Verification Code
                    </button>

                    <div id="otpInputSection" class="hidden space-y-6">
                        <div>
                            <label class="form-label">Enter 6-Digit Code</label>
                            <div class="flex justify-center space-x-3 mt-4">
                                <input type="text" class="otp-input" maxlength="1" autocomplete="off">
                                <input type="text" class="otp-input" maxlength="1" autocomplete="off">
                                <input type="text" class="otp-input" maxlength="1" autocomplete="off">
                                <input type="text" class="otp-input" maxlength="1" autocomplete="off">
                                <input type="text" class="otp-input" maxlength="1" autocomplete="off">
                                <input type="text" class="otp-input" maxlength="1" autocomplete="off">
                            </div>
                        </div>

                        <button onclick="verifyOTP()" class="btn-primary w-full justify-center">
                            <span class="material-symbols-outlined">verified</span>
                            Verify & Login
                        </button>
                    </div>
                </div>

                <div class="mt-10 text-center">
                    <button onclick="showScreen('loginScreen')" class="text-primary-600 hover:text-primary-700 font-medium text-sm transition-colors">
                        <span class="material-symbols-outlined text-sm mr-1">arrow_back</span>
                        Back to Login Options
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PLACEHOLDER DASHBOARDS - Will be built in subsequent phases -->

    <!-- Profile Creation Screen -->
    <div id="createProfileScreen" class="screen">
        <div class="min-h-screen hero-gradient flex items-center justify-center p-6">
            <div class="glass-card p-10 w-full max-w-2xl">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <span class="material-symbols-outlined text-2xl text-primary-600">person_add</span>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2" data-i18n="profile.create">Create Your Profile</h2>
                    <p class="text-gray-600" data-i18n="profile.choose.role">Choose your role and fill in your information</p>
                    <div class="mt-4 flex gap-3 justify-center">
                        <button onclick="forceLoadProfileFromCloud()" class="text-blue-600 hover:text-blue-700 text-sm font-medium px-4 py-2 border border-blue-600 rounded-lg">
                            ↻ Sync from Cloud
                        </button>
                        <button onclick="ScreenManager.showScreen('loginScreen')" class="text-primary-600 hover:text-primary-700 text-sm font-medium">
                            ← Back to Login
                        </button>
                    </div>
                </div>

                <form id="profileCreationForm" class="space-y-6">
                    <!-- Role Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Select Your Role</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <label class="role-selection-card">
                                <input type="radio" name="role" value="golfer" class="sr-only">
                                <div class="role-card">
                                    <span class="material-symbols-outlined text-2xl">sports_golf</span>
                                    <span class="text-sm font-medium">Golfer</span>
                                </div>
                            </label>
                            <label class="role-selection-card">
                                <input type="radio" name="role" value="caddie" class="sr-only">
                                <div class="role-card">
                                    <span class="material-symbols-outlined text-2xl">person_add</span>
                                    <span class="text-sm font-medium">Caddy</span>
                                </div>
                            </label>
                            <label class="role-selection-card">
                                <input type="radio" name="role" value="manager" class="sr-only">
                                <div class="role-card">
                                    <span class="material-symbols-outlined text-2xl">manage_accounts</span>
                                    <span class="text-sm font-medium">Manager</span>
                                </div>
                            </label>
                            <label class="role-selection-card">
                                <input type="radio" name="role" value="proshop" class="sr-only">
                                <div class="role-card">
                                    <span class="material-symbols-outlined text-2xl">storefront</span>
                                    <span class="text-sm font-medium">Pro Shop</span>
                                </div>
                            </label>
                            <label class="role-selection-card">
                                <input type="radio" name="role" value="maintenance" class="sr-only">
                                <div class="role-card">
                                    <span class="material-symbols-outlined text-2xl">grass</span>
                                    <span class="text-sm font-medium">Maintenance</span>
                                </div>
                            </label>
                            <label class="role-selection-card">
                                <input type="radio" name="role" value="society" class="sr-only">
                                <div class="role-card">
                                    <span class="material-symbols-outlined text-2xl">groups</span>
                                    <span class="text-sm font-medium">Society Organizer</span>
                                </div>
                            </label>
                            <label class="role-selection-card">
                                <input type="radio" name="role" value="caddymaster" class="sr-only">
                                <div class="role-card">
                                    <span class="material-symbols-outlined text-2xl">supervisor_account</span>
                                    <span class="text-sm font-medium">Caddy Master</span>
                                </div>
                            </label>
                            <label class="role-selection-card">
                                <input type="radio" name="role" value="restaurant" class="sr-only">
                                <div class="role-card">
                                    <span class="material-symbols-outlined text-2xl">restaurant</span>
                                    <span class="text-sm font-medium">Restaurant Staff</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Username Field -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username * <span class="text-xs text-gray-500">(Unique identifier for chat and bookings)</span></label>
                        <div class="relative">
                            <input type="text" id="username" name="username" required
                                   class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500"
                                   placeholder="Choose a unique username (letters, numbers, underscore only)"
                                   pattern="[a-zA-Z0-9_]+"
                                   oninput="checkUsernameAvailability(this.value)">
                            <div id="usernameStatus" class="absolute right-3 top-3"></div>
                        </div>
                        <p id="usernameMessage" class="text-xs mt-1"></p>
                    </div>

                    <!-- Basic Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                            <input type="text" id="firstName" name="firstName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                            <input type="text" id="lastName" name="lastName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email (Optional)</label>
                            <input type="email" id="email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                            <input type="tel" id="phone" name="phone" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                        </div>
                    </div>

                    <!-- Golf Course Affiliation -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Home Golf Course</label>
                        <select id="homeClub" name="homeClub" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                            <option value="">Select your home course...</option>
                            <option value="Pattana Golf Resort & Spa">Pattana Golf Resort & Spa</option>
                            <option value="Pattaya Golf Club">Pattaya Golf Club</option>
                            <option value="Thai Country Club">Thai Country Club</option>
                            <option value="Siam Plantation Golf Club">Siam Plantation Golf Club</option>
                            <option value="Royal Garden Golf Club">Royal Garden Golf Club</option>
                            <option value="Bangpra International Golf Club">Bangpra International Golf Club</option>
                            <option value="Crystal Bay Golf Club">Crystal Bay Golf Club</option>
                            <option value="Laem Chabang International Country Club">Laem Chabang International Country Club</option>
                        </select>
                    </div>

                    <!-- Role-Specific Fields Container -->
                    <div id="roleSpecificFields" class="hidden">
                        <!-- Will be populated dynamically based on role selection -->
                    </div>

                    <!-- Profile Picture Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Profile Picture (Optional)</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="profilePicture" name="profilePicture" accept="image/*" class="hidden">
                            <div id="uploadArea" onclick="document.getElementById('profilePicture').click()" class="cursor-pointer">
                                <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">add_a_photo</span>
                                <p class="text-sm text-gray-600">Click to upload a profile picture</p>
                            </div>
                            <div id="imagePreview" class="hidden">
                                <img id="previewImg" src="" alt="Preview" class="w-20 h-20 rounded-full mx-auto object-cover">
                                <button type="button" onclick="removeImage()" class="text-red-600 text-sm mt-2">Remove</button>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Notes -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Additional Information (Optional)</label>
                        <textarea id="additionalInfo" name="additionalInfo" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="Any additional information you'd like to share..."></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex space-x-4">
                        <button type="button" onclick="goBackToLogin()" class="flex-1 btn-secondary justify-center">
                            <span class="material-symbols-outlined">arrow_back</span>
                            Back to Login
                        </button>
                        <button type="submit" class="flex-1 btn-primary justify-center">
                            <span class="material-symbols-outlined">save</span>
                            Create Profile
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Golfer Dashboard -->
    <div id="golferDashboard" class="screen">
        <header class="nav-header">
            <div class="max-w-7xl mx-auto px-4 lg:px-8">
                <div class="flex justify-between items-center py-3 md:py-5">
                    <div class="flex items-center space-x-2 md:space-x-3">
                        <img class="user-avatar" style="display: none;">
                        <div class="flex flex-col md:block">
                            <div class="text-sm md:text-base font-bold text-gray-900">
                                <span class="hidden md:inline" data-i18n="golfer.welcome">Welcome back</span>,
                                <span class="user-name-display">Golfer</span>
                                <span class="user-username-display"></span>
                                <span class="club-affiliation-container" style="display: none;">
                                    <span class="hidden md:inline"> • </span>
                                    <span class="club-affiliation text-primary-600"></span>
                                </span>
                            </div>
                            <div class="flex items-center space-x-2 md:space-x-3 text-xs text-gray-600 mt-1">
                                <div class="flex items-center space-x-1">
                                    <span class="material-symbols-outlined text-xs">golf_course</span>
                                    <span class="home-club"></span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <span class="text-gray-900 font-medium">HCP: <span class="user-handicap"></span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-end space-x-2 md:justify-between md:flex-1 md:ml-8">
                        <button onclick="ProfileSystem.showProfileModal()" class="btn-secondary px-2 py-2 md:px-3 md:py-2" title="Profile Settings">
                            <span class="material-symbols-outlined text-sm">person</span>
                            <span class="hidden md:inline ml-1" data-i18n="golfer.profile">Profile</span>
                        </button>
                        <button onclick="sendEmergencyAlert()" class="emergency-btn p-2 md:p-3" title="Emergency Alert">
                            <span class="material-symbols-outlined text-sm md:text-base">emergency</span>
                        </button>
                        <button onclick="window.openProfessionalChat()" class="btn-primary relative px-2 py-2 md:px-4 md:py-2" style="background: #10b981;" title="Chat">
                            <span class="material-symbols-outlined text-sm">chat</span>
                            <span class="hidden md:inline ml-1" data-i18n="golfer.chat">Chat</span>
                            <span id="chatBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-4 w-4 md:h-5 md:w-5 flex items-center justify-center font-medium" style="display: none;">0</span>
                        </button>
                        <div class="flex items-center space-x-1 border border-gray-300 rounded-lg p-1">
                            <button class="language-btn" data-lang="en" onclick="changeLanguage('en')" title="English">EN</button>
                            <button class="language-btn" data-lang="th" onclick="changeLanguage('th')" title="ภาษาไทย">TH</button>
                            <button class="language-btn" data-lang="ko" onclick="changeLanguage('ko')" title="한국어">KO</button>
                            <button class="language-btn" data-lang="ja" onclick="changeLanguage('ja')" title="日本語">JA</button>
                        </div>
                        <button onclick="logout()" class="btn-logout px-2 py-2 md:px-3 md:py-2">
                            <span class="material-symbols-outlined text-sm">logout</span>
                            <span class="hidden md:inline ml-1" data-i18n="nav.logout">Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <nav class="bg-white border-b border-gray-200 py-2">
            <div class="max-w-7xl mx-auto px-4 lg:px-8">
                <div class="flex flex-wrap md:flex-nowrap gap-1 md:gap-3 lg:gap-4">
                    <button onclick="showGolferTab('overview', event)" class="tab-button active px-2 md:px-4">
                        <span class="material-symbols-outlined text-sm">dashboard</span>
                        <span class="hidden sm:inline ml-1" data-i18n="golfer.overview">Overview</span>
                    </button>
                    <button onclick="showGolferTab('booking', event)" class="tab-button px-1 md:px-2">
                        <span class="material-symbols-outlined text-sm">event</span>
                        <span class="hidden sm:inline ml-1" data-i18n="golfer.booking">Booking</span>
                    </button>
                    <button onclick="showGolferTab('schedule', event)" class="tab-button px-1 md:px-2">
                        <span class="material-symbols-outlined text-sm">calendar_month</span>
                        <span class="hidden sm:inline ml-1" data-i18n="golfer.schedule">Schedule</span>
                    </button>
                    <button onclick="showGolferTab('food', event)" class="tab-button px-1 md:px-2">
                        <span class="material-symbols-outlined text-sm">restaurant</span>
                        <span class="hidden sm:inline ml-1" data-i18n="golfer.food">Food & Dining</span>
                    </button>
                    <button onclick="showGolferTab('status', event)" class="tab-button relative px-2 md:px-4">
                        <span class="material-symbols-outlined text-sm">receipt_long</span>
                        <span class="hidden sm:inline ml-1" data-i18n="golfer.orderstatus">Order Status</span>
                        <span class="absolute -top-1 -right-1 bg-gradient-to-br from-red-500 to-red-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold shadow-lg animate-pulse" id="orderStatusTabBadge" style="display: none; border: 2px solid white;">0</span>
                    </button>
                    <button onclick="showGolferTab('stats', event)" class="tab-button px-1 md:px-2">
                        <span class="material-symbols-outlined text-sm">analytics</span>
                        <span class="hidden sm:inline ml-1" data-i18n="golfer.statistics">Statistics</span>
                    </button>
                    <button onclick="showGolferTab('gps', event)" class="tab-button px-1 md:px-2">
                        <span class="material-symbols-outlined text-sm">location_on</span>
                        <span class="hidden sm:inline ml-1" data-i18n="golfer.gps">GPS & Navigation</span>
                    </button>
                    <button onclick="showGolferTab('rounds', event)" class="tab-button px-1 md:px-2">
                        <span class="material-symbols-outlined text-sm">history</span>
                        <span class="hidden sm:inline ml-1" data-i18n="golfer.roundhistory">Round History</span>
                    </button>
                    <button onclick="showGolferTab('societyevents', event)" class="tab-button px-1 md:px-2">
                        <span class="material-symbols-outlined text-sm">groups</span>
                        <span class="hidden sm:inline ml-1" data-i18n="golfer.societyevents">Society Events</span>
                    </button>
                    <button onclick="showGolferTab('scorecard', event)" class="tab-button px-1 md:px-2">
                        <span class="material-symbols-outlined text-sm">scoreboard</span>
                        <span class="hidden sm:inline ml-1" data-i18n="golfer.livescorecard">Live Scorecard</span>
                    </button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-3 md:px-6 lg:px-8 py-3 md:py-8">
            <!-- Overview Tab -->
            <div id="golfer-overview" class="tab-content active">

                <!-- Persistent Emergency Alerts -->
                <div id="golfer-emergency-alerts" class="persistent-emergency-alerts mb-4" style="display: none;">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <span class="material-symbols-outlined text-red-600">emergency</span>
                                <h3 class="text-lg font-bold text-red-800">Active Emergency Alerts</h3>
                            </div>
                            <span id="golfer-alert-count" class="bg-red-600 text-white text-xs px-2 py-1 rounded-full font-medium">0</span>
                        </div>
                        <div id="golfer-alert-list" class="space-y-2">
                            <!-- Emergency alerts will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Grid -->
                <!-- Mobile & Desktop: Same card-style layout -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-4 md:mb-8">
                    <button onclick="showGolferTab('booking', event)" class="card-hover metric-card text-center group">
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2 group-hover:bg-green-200 transition-colors">
                            <span class="material-symbols-outlined text-xl md:text-2xl text-green-600">event</span>
                        </div>
                        <h3 class="text-sm md:text-base font-bold text-gray-900 mb-1" data-i18n="golfer.teetime">Tee Time</h3>
                        <p class="text-xs md:text-sm text-gray-600 hidden sm:block" data-i18n="golfer.teetime.desc">Reserve your next round</p>
                        <div class="mt-2 text-xs bg-green-50 text-green-700 px-2 md:px-3 py-1 rounded-full inline-block" data-i18n="golfer.teetime.available">
                            Available Now
                        </div>
                    </button>

                    <button onclick="showGolferTab('booking', event)" class="card-hover metric-card text-center group">
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-teal-100 rounded-full flex items-center justify-center mx-auto mb-2 group-hover:bg-teal-200 transition-colors">
                            <span class="material-symbols-outlined text-xl md:text-2xl text-teal-600">person</span>
                        </div>
                        <h3 class="text-sm md:text-base font-bold text-gray-900 mb-1" data-i18n="golfer.caddy">Caddy</h3>
                        <p class="text-xs md:text-sm text-gray-600 hidden sm:block" data-i18n="golfer.caddy.desc">Request a caddy</p>
                        <div class="mt-2 text-xs bg-teal-50 text-teal-700 px-2 md:px-3 py-1 rounded-full inline-block" data-i18n="golfer.caddy.booknow">
                            Book Now
                        </div>
                    </button>

                    <button onclick="showGolferTab('food', event)" class="card-hover metric-card text-center group">
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-2 group-hover:bg-orange-200 transition-colors">
                            <span class="material-symbols-outlined text-xl md:text-2xl text-orange-600">restaurant</span>
                        </div>
                        <h3 class="text-sm md:text-base font-bold text-gray-900 mb-1" data-i18n="golfer.food.title">Food</h3>
                        <p class="text-xs md:text-sm text-gray-600 hidden sm:block" data-i18n="golfer.food.desc">Course dining & beverages</p>
                        <div class="mt-2 text-xs bg-orange-50 text-orange-700 px-2 md:px-3 py-1 rounded-full inline-block" data-i18n="golfer.food.open">
                            Kitchen Open
                        </div>
                    </button>

                    <button onclick="showGolferTab('schedule', event)" class="card-hover metric-card text-center group">
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-2 group-hover:bg-purple-200 transition-colors">
                            <span class="material-symbols-outlined text-xl md:text-2xl text-purple-600">calendar_month</span>
                        </div>
                        <h3 class="text-sm md:text-base font-bold text-gray-900 mb-1" data-i18n="golfer.schedule">Schedule</h3>
                        <p class="text-xs md:text-sm text-gray-600 hidden sm:block" data-i18n="golfer.schedule.desc">View your calendar</p>
                        <div class="mt-2 text-xs bg-purple-50 text-purple-700 px-2 md:px-3 py-1 rounded-full inline-block" data-i18n="golfer.schedule.planahead">
                            Plan Ahead
                        </div>
                    </button>

                    <button onclick="showGolferTab('status', event)" class="card-hover metric-card text-center group">
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-2 group-hover:bg-yellow-200 transition-colors">
                            <span class="material-symbols-outlined text-xl md:text-2xl text-yellow-600">receipt_long</span>
                        </div>
                        <h3 class="text-sm md:text-base font-bold text-gray-900 mb-1" data-i18n="golfer.orders">Orders</h3>
                        <p class="text-xs md:text-sm text-gray-600 hidden sm:block" data-i18n="golfer.orders.desc">Track your orders</p>
                        <div class="mt-2 text-xs bg-yellow-50 text-yellow-700 px-2 md:px-3 py-1 rounded-full inline-block" data-i18n="golfer.orders.viewstatus">
                            View Status
                        </div>
                    </button>

                    <button onclick="showGolferTab('stats', event)" class="card-hover metric-card text-center group">
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-2 group-hover:bg-indigo-200 transition-colors">
                            <span class="material-symbols-outlined text-xl md:text-2xl text-indigo-600">analytics</span>
                        </div>
                        <h3 class="text-sm md:text-base font-bold text-gray-900 mb-1" data-i18n="golfer.stats">Stats</h3>
                        <p class="text-xs md:text-sm text-gray-600 hidden sm:block" data-i18n="golfer.stats.desc">Performance tracking</p>
                        <div class="mt-2 text-xs bg-indigo-50 text-indigo-700 px-2 md:px-3 py-1 rounded-full inline-block" data-i18n="golfer.stats.rounds">
                            47 Rounds
                        </div>
                    </button>

                    <button onclick="showGolferTab('gps', event)" class="card-hover metric-card text-center group">
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2 group-hover:bg-blue-200 transition-colors">
                            <span class="material-symbols-outlined text-xl md:text-2xl text-blue-600">gps_fixed</span>
                        </div>
                        <h3 class="text-sm md:text-base font-bold text-gray-900 mb-1" data-i18n="golfer.gps">GPS</h3>
                        <p class="text-xs md:text-sm text-gray-600 hidden sm:block" data-i18n="golfer.gps.desc">Course navigation</p>
                        <div class="mt-2 text-xs bg-blue-50 text-blue-700 px-2 md:px-3 py-1 rounded-full inline-block" data-i18n="golfer.gps.livetracking">
                            Live Tracking
                        </div>
                    </button>

                    <button onclick="showGolferTab('rounds', event)" class="card-hover metric-card text-center group">
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-2 group-hover:bg-gray-200 transition-colors">
                            <span class="material-symbols-outlined text-xl md:text-2xl text-gray-600">history</span>
                        </div>
                        <h3 class="text-sm md:text-base font-bold text-gray-900 mb-1" data-i18n="golfer.history">History</h3>
                        <p class="text-xs md:text-sm text-gray-600 hidden sm:block" data-i18n="golfer.history.desc">Round history</p>
                        <div class="mt-2 text-xs bg-gray-50 text-gray-700 px-2 md:px-3 py-1 rounded-full inline-block" data-i18n="golfer.history.viewpast">
                            View Past
                        </div>
                    </button>
                </div>

                <!-- Featured Caddys - Golf Course Promotions -->
                <div class="md:metric-card mb-4 md:mb-8">
                    <div class="flex items-center justify-between mb-3 md:mb-6">
                        <h3 class="text-base md:text-xl font-bold text-gray-900" data-i18n="golfer.featured.caddies">Featured Caddies</h3>
                        <button onclick="refreshPromotionalCaddys()" class="text-primary-600 hover:text-primary-700 text-xs md:text-sm font-medium flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">refresh</span>
                            <span class="hidden md:inline" data-i18n="golfer.refresh">Refresh</span>
                        </button>
                    </div>
                    <p class="text-gray-600 text-sm mb-3 md:mb-6 hidden md:block" data-i18n="golfer.featured.desc">Discover top-rated caddies and explore new golf courses</p>

                    <!-- Mobile: Horizontal scrolling container -->
                    <div class="block md:hidden mobile-scroll-container">
                        <div id="promotionalCaddysContainer" class="flex space-x-4 overflow-x-auto pb-4 scrollbar-hide">
                            <!-- Promotional caddies will be loaded here for mobile -->
                        </div>
                    </div>

                    <!-- Desktop: Grid layout -->
                    <div class="hidden md:grid md:grid-cols-2 lg:grid-cols-4 gap-4" id="promotionalCaddysDesktop">
                        <!-- Promotional caddies will be loaded here for desktop -->
                    </div>
                </div>

                <!-- Current Status Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-4 md:mb-8">
                    <!-- Today's Tee Time -->
                    <div class="metric-card" id="todaysTeeTimeCard">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-gray-900" data-i18n="golfer.today.teetime">Today's Tee Time</h3>
                        </div>
                        <div id="todaysTeeTimeContent" class="text-center py-8">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="material-symbols-outlined text-gray-400 text-2xl">schedule</span>
                            </div>
                            <p class="text-gray-500 font-medium" data-i18n="golfer.no.teetime">No tee time booked today</p>
                            <p class="text-sm text-gray-400 mt-1" data-i18n="golfer.book.prompt">Book your next round to see it here</p>
                        </div>
                        <div class="mt-6">
                            <button class="btn-primary w-full" onclick="TabManager.showTab('golferDashboard', 'booking', event)">
                                <span class="material-symbols-outlined text-sm">add</span>
                                <span data-i18n="golfer.book.teetime">Book Tee Time</span>
                            </button>
                        </div>
                    </div>

                    <!-- Live Course Status -->
                    <div class="metric-card">
                        <h3 class="text-xl font-bold text-gray-900 mb-6" data-i18n="golfer.live.status">Live Course Status</h3>
                        <div class="grid grid-cols-2 gap-6 mb-6">
                            <div class="text-center">
                                <div class="metric-value text-2xl text-gray-400" id="currentHole">-</div>
                                <div class="metric-label" data-i18n="golfer.current.hole">Current Hole</div>
                                <div class="text-xs text-gray-400 mt-1" data-i18n="golfer.not.playing">Not playing</div>
                            </div>
                            <div class="text-center">
                                <div class="metric-value text-2xl text-gray-400" id="distanceToPin">-</div>
                                <div class="metric-label" data-i18n="golfer.yards.topin">Yards to Pin</div>
                                <div class="text-xs text-gray-400 mt-1" data-i18n="golfer.not.playing">Not playing</div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <span class="material-symbols-outlined text-blue-600">thermostat</span>
                                    <span class="font-medium" data-i18n="golfer.temperature">Temperature</span>
                                </div>
                                <span class="font-bold text-gray-900">24°C</span>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <span class="material-symbols-outlined text-green-600">air</span>
                                    <span class="font-medium" data-i18n="golfer.wind">Wind</span>
                                </div>
                                <span class="font-bold text-gray-900">8 km/h NE</span>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <span class="material-symbols-outlined text-yellow-500">wb_sunny</span>
                                    <span class="font-medium" data-i18n="golfer.conditions">Conditions</span>
                                </div>
                                <span class="font-bold text-gray-900" data-i18n="golfer.sunny">Sunny</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Overview -->
                <div class="metric-card">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-900" data-i18n="golfer.performance">Performance Overview</h3>
                        <button onclick="showGolferTab('stats', event)" class="text-primary-600 hover:text-primary-700 font-medium text-sm" data-i18n="golfer.viewdetails">
                            View Details →
                        </button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        <div class="text-center">
                            <div class="metric-value" id="bestScore">-</div>
                            <div class="metric-label" data-i18n="golfer.bestscore">Best Score</div>
                            <div class="text-xs text-gray-400 mt-1" data-i18n="golfer.norounds">No rounds yet</div>
                        </div>
                        <div class="text-center">
                            <div class="metric-value" id="avgScore">-</div>
                            <div class="metric-label" data-i18n="golfer.avgscore">Average Score</div>
                            <div class="text-xs text-gray-400 mt-1" data-i18n="golfer.norounds">No rounds yet</div>
                        </div>
                        <div class="text-center">
                            <div class="metric-value" id="totalRounds">0</div>
                            <div class="metric-label" data-i18n="golfer.roundsplayed">Rounds Played</div>
                            <div class="text-xs text-gray-400 mt-1" data-i18n="golfer.thisyear">This year</div>
                        </div>
                        <div class="text-center">
                            <div class="metric-value" id="eaglesCount">0</div>
                            <div class="metric-label" data-i18n="golfer.eagles">Eagles</div>
                            <div class="text-xs text-gray-400 mt-1" data-i18n="golfer.thismonth">This month</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Booking Tab -->
            <div id="golfer-booking" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Booking Form -->
                    <div class="lg:col-span-2">
                        <div class="metric-card">
                            <h3 class="text-2xl font-bold text-gray-900 mb-6" data-i18n="golfer.book.title">Book Your Tee Time</h3>

                            <!-- Golf Course Search & Selection -->
                            <div class="space-y-6">
                                <div>
                                    <label class="form-label" data-i18n="golfer.search.course">Search & Select Golf Course</label>
                                    <div class="relative mb-4">
                                        <input
                                            type="text"
                                            id="courseSearchInput"
                                            data-i18n-placeholder="golfer.search.placeholder"
                                            placeholder="Search courses (e.g., Pattana, Championship, Executive...)"
                                            class="form-input pl-10"
                                            oninput="debouncedFilterCourses(this.value)"
                                        >
                                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 material-symbols-outlined text-gray-400">search</span>
                                    </div>

                                    <!-- Mobile: Horizontal scrolling container -->
                                    <div class="block md:hidden mobile-scroll-container">
                                        <div id="courseGridMobile" class="flex space-x-4 overflow-x-auto pb-4 scrollbar-hide">
                                            <!-- Courses will be loaded here for mobile -->
                                        </div>
                                    </div>

                                    <!-- Desktop: Grid layout -->
                                    <div id="courseGrid" class="hidden md:grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <!-- Courses will be populated here for desktop -->
                                    </div>

                                    <div id="selectedCourseInfo" class="mt-4 p-4 bg-primary-50 border border-primary-200 rounded-lg hidden">
                                        <div class="flex items-center space-x-2">
                                            <span class="material-symbols-outlined text-primary-600">golf_course</span>
                                            <span class="font-semibold text-primary-900">Selected: </span>
                                            <span id="selectedCourseName" class="text-primary-800"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Date & Time Selection -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="form-label" data-i18n="golfer.selectdate">Select Date</label>
                                        <input type="date" id="bookingDate" class="form-input" min="">
                                    </div>
                                    <div>
                                        <label class="form-label" data-i18n="golfer.preferredtime">Preferred Time</label>
                                        <select id="bookingTime" class="form-input">
                                            <option value="" data-i18n="golfer.choosetime">Choose time...</option>
                                            <option value="06:00">06:00</option>
                                            <option value="06:30">06:30</option>
                                            <option value="07:00">07:00</option>
                                            <option value="07:30">07:30</option>
                                            <option value="08:00">08:00</option>
                                            <option value="08:30">08:30</option>
                                            <option value="09:00">09:00</option>
                                            <option value="09:30">09:30</option>
                                            <option value="10:00">10:00</option>
                                            <option value="10:30">10:30</option>
                                            <option value="11:00">11:00</option>
                                            <option value="11:30">11:30</option>
                                            <option value="12:00">12:00</option>
                                            <option value="12:30">12:30</option>
                                            <option value="13:00">13:00</option>
                                            <option value="13:30">13:30</option>
                                            <option value="14:00">14:00</option>
                                            <option value="14:30">14:30</option>
                                            <option value="15:00">15:00</option>
                                            <option value="15:30">15:30</option>
                                            <option value="16:00">16:00</option>
                                            <option value="16:30">16:30</option>
                                            <option value="17:00">17:00</option>
                                            <option value="17:30">17:30</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Players & Caddy -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="form-label" data-i18n="golfer.numplayers">Number of Players</label>
                                        <select id="playerCount" class="form-input">
                                            <option value="1">1 <span data-i18n="golfer.player">Player</span></option>
                                            <option value="2">2 <span data-i18n="golfer.players">Players</span></option>
                                            <option value="3">3 <span data-i18n="golfer.players">Players</span></option>
                                            <option value="4">4 <span data-i18n="golfer.players">Players</span></option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Professional Caddy Selection -->
                                <div class="border-t pt-6" id="caddieSelectionSection" style="display: none;">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="font-bold text-gray-900" data-i18n="golfer.selectcaddy">Select Professional Caddys</h4>
                                        <div class="text-sm text-gray-600">
                                            <span id="availableCaddyCount">0</span> <span data-i18n="golfer.available">available</span> •
                                            <span id="waitlistCaddyCount">0</span> <span data-i18n="golfer.onwaitlist">on waitlist</span>
                                        </div>
                                    </div>

                                    <!-- Caddy Search -->
                                    <div class="relative mb-4">
                                        <input
                                            type="text"
                                            id="caddieSearchInput"
                                            data-i18n-placeholder="golfer.searchcaddy"
                                            placeholder="Search by caddie name, number, or specialty..."
                                            class="form-input pl-10"
                                            oninput="debouncedFilterCaddys(this.value)"
                                        >
                                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 material-symbols-outlined text-gray-400">search</span>
                                    </div>

                                    <!-- Mobile: Horizontal scrolling caddies -->
                                    <div class="block md:hidden mobile-scroll-container">
                                        <div id="caddieGridMobile" class="flex space-x-4 overflow-x-auto pb-4 scrollbar-hide">
                                            <!-- Caddys will be populated here for mobile -->
                                            <div class="flex-shrink-0 w-72 text-center text-gray-600 py-8">
                                                <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">person_search</span>
                                                <p class="text-sm">Select a golf course to see available caddies</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Desktop: Grid layout -->
                                    <div id="caddieGrid" class="hidden md:grid md:grid-cols-2 gap-4">
                                        <!-- Caddys will be populated here based on selected course -->
                                        <div class="col-span-2 text-center text-gray-600 py-8">
                                            <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">person_search</span>
                                            <p>Select a golf course to see available caddies</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Premium Services -->
                                <div class="border-t pt-6">
                                    <h4 class="font-bold text-gray-900 mb-4">Premium Services</h4>

                                    <!-- Mobile: Horizontal scrolling container -->
                                    <div class="block md:hidden mobile-scroll-container">
                                        <div class="flex space-x-4 overflow-x-auto pb-4 scrollbar-hide">
                                            <div class="flex-shrink-0 w-72 service-card p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-500 transition-colors" data-service="cart" onclick="toggleServiceNew('cart')">
                                                <div class="flex items-center justify-between mb-2">
                                                    <div class="flex items-center">
                                                        <span class="text-2xl mr-3">🚗</span>
                                                        <h5 class="font-bold text-gray-900">Golf Cart Rental</h5>
                                                    </div>
                                                    <span class="text-primary-600 font-bold">฿600</span>
                                                </div>
                                                <p class="text-sm text-gray-600">Electric golf cart for 2 players</p>
                                            </div>

                                            <div class="flex-shrink-0 w-72 service-card p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-500 transition-colors" data-service="clubs" onclick="toggleServiceNew('clubs')">
                                                <div class="flex items-center justify-between mb-2">
                                                    <div class="flex items-center">
                                                        <span class="text-2xl mr-3">⛳</span>
                                                        <h5 class="font-bold text-gray-900">Club Rental Set</h5>
                                                    </div>
                                                    <span class="text-primary-600 font-bold">฿400</span>
                                                </div>
                                                <p class="text-sm text-gray-600">Premium club set with bag</p>
                                            </div>

                                            <div class="flex-shrink-0 w-72 service-card p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-500 transition-colors" data-service="shoes" onclick="toggleServiceNew('shoes')">
                                                <div class="flex items-center justify-between mb-2">
                                                    <div class="flex items-center">
                                                        <span class="text-2xl mr-3">👟</span>
                                                        <h5 class="font-bold text-gray-900">Golf Shoes Rental</h5>
                                                    </div>
                                                    <span class="text-primary-600 font-bold">฿200</span>
                                                </div>
                                                <p class="text-sm text-gray-600">Professional golf shoes</p>
                                            </div>

                                            <div class="flex-shrink-0 w-72 service-card p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-500 transition-colors" data-service="insurance" onclick="toggleServiceNew('insurance')">
                                                <div class="flex items-center justify-between mb-2">
                                                    <div class="flex items-center">
                                                        <span class="text-2xl mr-3">🛡️</span>
                                                        <h5 class="font-bold text-gray-900">Play Insurance</h5>
                                                    </div>
                                                    <span class="text-primary-600 font-bold">฿150</span>
                                                </div>
                                                <p class="text-sm text-gray-600">Covers medical & equipment</p>
                                            </div>

                                            <div class="flex-shrink-0 w-72 service-card p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-500 transition-colors" data-service="lesson" onclick="toggleServiceNew('lesson')">
                                                <div class="flex items-center justify-between mb-2">
                                                    <div class="flex items-center">
                                                        <span class="text-2xl mr-3">🎯</span>
                                                        <h5 class="font-bold text-gray-900">Pro Lesson (30min)</h5>
                                                    </div>
                                                    <span class="text-primary-600 font-bold">฿800</span>
                                                </div>
                                                <p class="text-sm text-gray-600">One-on-one instruction</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Desktop: Grid layout -->
                                    <div class="hidden md:grid md:grid-cols-2 gap-4">
                                        <div class="service-card p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-500 transition-colors" data-service="cart" onclick="toggleServiceNew('cart')">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="flex items-center">
                                                    <span class="text-2xl mr-3">🚗</span>
                                                    <h5 class="font-bold text-gray-900">Golf Cart Rental</h5>
                                                </div>
                                                <span class="text-primary-600 font-bold">฿600</span>
                                            </div>
                                            <p class="text-sm text-gray-600">Electric golf cart for 2 players</p>
                                        </div>

                                        <div class="service-card p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-500 transition-colors" data-service="clubs" onclick="toggleServiceNew('clubs')">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="flex items-center">
                                                    <span class="text-2xl mr-3">⛳</span>
                                                    <h5 class="font-bold text-gray-900">Club Rental Set</h5>
                                                </div>
                                                <span class="text-primary-600 font-bold">฿400</span>
                                            </div>
                                            <p class="text-sm text-gray-600">Premium club set with bag</p>
                                        </div>

                                        <div class="service-card p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-500 transition-colors" data-service="shoes" onclick="toggleServiceNew('shoes')">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="flex items-center">
                                                    <span class="text-2xl mr-3">👟</span>
                                                    <h5 class="font-bold text-gray-900">Golf Shoes Rental</h5>
                                                </div>
                                                <span class="text-primary-600 font-bold">฿200</span>
                                            </div>
                                            <p class="text-sm text-gray-600">Professional golf shoes</p>
                                        </div>

                                        <div class="service-card p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-500 transition-colors" data-service="insurance" onclick="toggleServiceNew('insurance')">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="flex items-center">
                                                    <span class="text-2xl mr-3">🛡️</span>
                                                    <h5 class="font-bold text-gray-900">Play Insurance</h5>
                                                </div>
                                                <span class="text-primary-600 font-bold">฿150</span>
                                            </div>
                                            <p class="text-sm text-gray-600">Covers medical & equipment</p>
                                        </div>

                                        <div class="service-card p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-500 transition-colors" data-service="lesson" onclick="toggleServiceNew('lesson')">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="flex items-center">
                                                    <span class="text-2xl mr-3">🎯</span>
                                                    <h5 class="font-bold text-gray-900">Pro Lesson (30min)</h5>
                                                </div>
                                                <span class="text-primary-600 font-bold">฿800</span>
                                            </div>
                                            <p class="text-sm text-gray-600">One-on-one instruction</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Payment Method -->
                                <div class="border-t pt-6">
                                    <h4 class="font-bold text-gray-900 mb-4">Payment Method</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="payment-option p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-500 transition-colors" data-payment="credit" onclick="selectPaymentMethod('credit')">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <span class="material-symbols-outlined text-2xl mr-3 text-blue-600">credit_card</span>
                                                    <div>
                                                        <h5 class="font-bold text-gray-900">Credit/Debit Card</h5>
                                                        <p class="text-sm text-gray-600">Visa, Mastercard, JCB</p>
                                                    </div>
                                                </div>
                                                <span class="material-symbols-outlined text-green-600">verified</span>
                                            </div>
                                        </div>

                                        <div class="payment-option p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-500 transition-colors" data-payment="promptpay" onclick="selectPaymentMethod('promptpay')">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <span class="material-symbols-outlined text-2xl mr-3 text-purple-600">qr_code</span>
                                                    <div>
                                                        <h5 class="font-bold text-gray-900">PromptPay</h5>
                                                        <p class="text-sm text-gray-600">QR Code Payment</p>
                                                    </div>
                                                </div>
                                                <span class="material-symbols-outlined text-green-600">verified</span>
                                            </div>
                                        </div>

                                        <div class="payment-option p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-500 transition-colors" data-payment="cash" onclick="selectPaymentMethod('cash')">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <span class="material-symbols-outlined text-2xl mr-3 text-green-600">payments</span>
                                                    <div>
                                                        <h5 class="font-bold text-gray-900">Cash</h5>
                                                        <p class="text-sm text-gray-600">Pay at Pro Shop</p>
                                                    </div>
                                                </div>
                                                <span class="material-symbols-outlined text-green-600">verified</span>
                                            </div>
                                        </div>

                                        <div class="payment-option p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-500 transition-colors" data-payment="linepay" onclick="selectPaymentMethod('linepay')">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <span class="material-symbols-outlined text-2xl mr-3 text-green-500">account_balance_wallet</span>
                                                    <div>
                                                        <h5 class="font-bold text-gray-900">LINE Pay</h5>
                                                        <p class="text-sm text-gray-600">Mobile Wallet</p>
                                                    </div>
                                                </div>
                                                <span class="material-symbols-outlined text-green-600">verified</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex space-x-4 pt-6 border-t">
                                    <button onclick="cancelBooking()" class="btn-secondary flex-1">
                                        <span class="material-symbols-outlined text-sm">cancel</span>
                                        Cancel
                                    </button>
                                    <button onclick="confirmBooking()" class="btn-primary flex-1">
                                        <span class="material-symbols-outlined text-sm">check</span>
                                        Confirm Booking
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Booking Cart -->
                    <div class="lg:col-span-1">
                        <div class="sticky top-8">
                            <div class="metric-card">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-bold text-gray-900">Booking Cart</h4>
                                    <span class="bg-primary-100 text-primary-800 text-xs px-2 py-1 rounded-full" id="cartItemCount">0</span>
                                </div>

                                <!-- Cart Items Container -->
                                <div id="bookingCartContainer" class="space-y-3 max-h-96 overflow-y-auto">
                                    <div class="text-center text-gray-600 py-8">
                                        <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">shopping_cart</span>
                                        <p class="text-sm">Your cart is empty</p>
                                        <p class="text-xs">Select a course and caddies to start</p>
                                    </div>
                                </div>

                                <!-- Cart Summary -->
                                <div class="mt-6 space-y-3 border-t pt-4">
                                    <div class="flex justify-between text-sm">
                                        <span>Course Fee:</span>
                                        <span id="cartCourseTotal">฿0</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span>Caddy Services:</span>
                                        <span id="cartCaddyTotal">฿0</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span>Premium Services:</span>
                                        <span id="cartServicesTotal">฿0</span>
                                    </div>
                                    <div class="flex justify-between text-sm text-gray-500">
                                        <span>Service Charge (10%):</span>
                                        <span id="cartServiceCharge">฿0</span>
                                    </div>
                                    <div class="border-t pt-3">
                                        <div class="flex justify-between items-center">
                                            <span class="font-bold text-gray-900">Total:</span>
                                            <span id="cartGrandTotal" class="font-bold text-xl text-primary-600">฿0</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="mt-6 space-y-3">
                                    <button onclick="confirmBooking()" id="confirmBookingBtn" class="w-full bg-primary-600 text-white py-3 px-4 rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                        <span class="material-symbols-outlined text-sm mr-2">check</span>
                                        Confirm Booking
                                    </button>
                                    <button onclick="clearBookingCart()" class="w-full bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors">
                                        <span class="material-symbols-outlined text-sm mr-2">clear</span>
                                        Clear Cart
                                    </button>
                                </div>
                            </div>

                            <!-- Recent Bookings -->
                            <div class="metric-card mt-6">
                                <h4 class="font-bold text-gray-900 mb-4">Your Recent Bookings</h4>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-medium text-sm">Championship</p>
                                            <p class="text-xs text-gray-600">Today 2:00 PM</p>
                                        </div>
                                        <span class="status-badge status-confirmed text-xs">Confirmed</span>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-medium text-sm">Executive</p>
                                            <p class="text-xs text-gray-600">Yesterday 9:00 AM</p>
                                        </div>
                                        <span class="text-xs text-gray-500">Completed</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedule Tab -->
            <div id="golfer-schedule" class="tab-content">
                <div class="space-y-8">
                    <!-- Search and Filter -->
                    <div class="bg-white rounded-xl p-4 md:p-6 shadow-sm border">
                        <div class="flex flex-col space-y-4 mb-4">
                            <!-- Search Bar -->
                            <div class="flex items-center space-x-2">
                                <div class="flex-1 relative">
                                    <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm">search</span>
                                    <input
                                        type="text"
                                        id="scheduleSearch"
                                        placeholder="Search by course, date, or event name..."
                                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                        oninput="searchSchedule(this.value)"
                                    />
                                </div>
                                <button onclick="refreshSchedule()" class="bg-primary-600 text-white p-2 rounded-lg hover:bg-primary-700 transition-colors flex-shrink-0">
                                    <span class="material-symbols-outlined text-sm">refresh</span>
                                </button>
                            </div>

                            <!-- Quick Filter Tabs -->
                            <div class="flex items-center overflow-x-auto scrollbar-hide">
                                <div class="flex space-x-2 min-w-max">
                                    <button onclick="filterSchedule('upcoming')" class="schedule-filter-btn active whitespace-nowrap" data-filter="upcoming" data-i18n="golfer.upcoming">
                                        Upcoming
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- NEW: Multi-select controls -->
                        <div id="multiSelectControls" class="flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4" style="display: none;">
                            <div class="flex items-center space-x-3">
                                <span class="material-symbols-outlined text-blue-600">check_circle</span>
                                <span class="text-sm font-medium text-blue-900">
                                    <span id="selectedCount">0</span> selected
                                </span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="ScheduleSystem.selectAll()" class="text-xs px-3 py-1 bg-white border border-blue-300 text-blue-700 rounded hover:bg-blue-50">
                                    Select All
                                </button>
                                <button onclick="ScheduleSystem.clearSelection()" class="text-xs px-3 py-1 bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-50">
                                    Clear
                                </button>
                                <button onclick="ScheduleSystem.deleteSelected()" class="text-xs px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">
                                    Delete Selected
                                </button>
                            </div>
                        </div>

                        <!-- Schedule List -->
                        <div id="scheduleList" class="space-y-4">
                            <!-- Schedule items will be loaded here -->
                        </div>

                        <!-- Empty State -->
                        <div id="emptySchedule" class="text-center py-12 hidden">
                            <div class="text-6xl mb-4">📅</div>
                            <h3 class="text-xl font-semibold text-gray-900 mb-2" data-i18n="golfer.schedule.events">No events scheduled</h3>
                            <p class="text-gray-600 mb-6">Start by booking a tee time or selecting a caddie</p>
                            <div class="flex justify-center space-x-4">
                                <button onclick="showGolferTab('booking', null)" class="bg-primary-600 text-white px-6 py-3 rounded-lg hover:bg-primary-700" data-i18n="golfer.book.teetime">
                                    Book Tee Time
                                </button>
                                <button onclick="showGolferTab('overview', null)" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300">
                                    Browse Caddys
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Food Ordering Tab -->
            <div id="golfer-food" class="tab-content">
                <!-- Category Filter Buttons -->
                <div class="mb-6 flex flex-wrap gap-2">
                    <button onclick="filterFoodMenu('all')" class="food-category-btn bg-primary-500 text-white px-4 py-2 rounded-lg" data-category="all" data-i18n="golfer.food.categories">All Items</button>
                    <button onclick="filterFoodMenu('appetizers')" class="food-category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg" data-category="appetizers">Appetizers</button>
                    <button onclick="filterFoodMenu('mains')" class="food-category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg" data-category="mains" data-i18n="golfer.food.meals">Main Courses</button>
                    <button onclick="filterFoodMenu('beverages')" class="food-category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg" data-category="beverages" data-i18n="golfer.food.beverages">Beverages</button>
                    <button onclick="filterFoodMenu('desserts')" class="food-category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg" data-category="desserts">Desserts</button>
                    <button onclick="filterFoodMenu('snacks')" class="food-category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg" data-category="snacks" data-i18n="golfer.food.snacks">Snacks</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Dynamic Menu Items Container -->
                    <div class="lg:col-span-2">
                        <div id="foodMenuItems" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>

                    <!-- Cart Sidebar -->
                    <div class="lg:col-span-1">
                        <div class="sticky top-8">
                            <div class="metric-card">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-bold text-gray-900" data-i18n="golfer.food.cart">Your Order</h4>
                                    <span id="cartItemCount" class="bg-primary-600 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center">0</span>
                                </div>
                                <div id="foodCartContainer" class="space-y-3 mb-6 max-h-64 overflow-y-auto">
                                    <p class="text-gray-600 text-sm text-center py-8">Your cart is empty</p>
                                </div>

                                <div class="border-t pt-4">
                                    <div class="flex justify-between items-center mb-4">
                                        <span class="font-bold text-gray-900">Subtotal:</span>
                                        <span id="cartSubtotal" class="font-bold text-xl text-primary-600">฿0</span>
                                    </div>
                                    <div class="flex justify-between items-center mb-4 text-sm">
                                        <span class="text-gray-600">Service charge (10%):</span>
                                        <span id="serviceCharge" class="text-gray-600">฿0</span>
                                    </div>
                                    <div class="flex justify-between items-center mb-6 border-t pt-2">
                                        <span class="font-bold text-gray-900">Total:</span>
                                        <span id="cartTotal" class="font-bold text-xl text-primary-600">฿0</span>
                                    </div>

                                    <button onclick="placeOrder()" id="placeOrderBtn" class="btn-primary w-full justify-center" disabled>
                                        <span class="material-symbols-outlined">shopping_cart_checkout</span>
                                        <span data-i18n="golfer.food.order">Place Order</span>
                                    </button>
                                </div>

                                <div class="mt-4 text-xs text-gray-500 text-center">
                                    <p>Order will be delivered to your table</p>
                                    <p>Estimated delivery: 25-35 minutes</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Status Tab -->
            <div id="golfer-status" class="tab-content">
                <div class="space-y-8">
                    <!-- Active Orders -->
                    <div class="metric-card">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <h3 class="text-2xl font-bold text-gray-900 mr-3">Active Orders</h3>
                                <span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full" id="activeOrdersBadge" style="display: none;">0</span>
                            </div>
                            <span class="text-sm text-gray-500" id="activeOrdersCount">0 active orders</span>
                        </div>
                        <div id="activeOrdersList" class="space-y-4">
                            <div class="text-center py-8 text-gray-500">
                                <span class="material-symbols-outlined text-4xl mb-2 opacity-50">receipt_long</span>
                                <p>No active orders</p>
                                <button onclick="showGolferTab('food', event)" class="mt-4 bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700">
                                    Order Food & Drinks
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Order History -->
                    <div class="metric-card">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <h3 class="text-xl font-bold text-gray-900 mr-3">Recent Orders</h3>
                                <span class="bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full" id="orderHistoryBadge" style="display: none;">0</span>
                            </div>
                            <button onclick="clearOrderHistory()" class="text-sm text-red-600 hover:text-red-700">
                                Clear History
                            </button>
                        </div>
                        <div id="orderHistoryList" class="space-y-4">
                            <div class="text-center py-8 text-gray-500">
                                <span class="material-symbols-outlined text-4xl mb-2 opacity-50">history</span>
                                <p>No order history</p>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <button onclick="showGolferTab('food', event)" class="metric-card text-center group hover:bg-primary-50">
                            <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-2 group-hover:bg-primary-200 transition-colors">
                                <span class="material-symbols-outlined text-2xl text-primary-600">restaurant</span>
                            </div>
                            <h4 class="font-semibold text-gray-900 mb-1">Order Food</h4>
                            <p class="text-sm text-gray-600">Browse menu & place orders</p>
                        </button>

                        <button onclick="refreshOrderStatus()" class="metric-card text-center group hover:bg-blue-50">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2 group-hover:bg-blue-200 transition-colors">
                                <span class="material-symbols-outlined text-2xl text-blue-600">refresh</span>
                            </div>
                            <h4 class="font-semibold text-gray-900 mb-2">Refresh Status</h4>
                            <p class="text-sm text-gray-600">Update order tracking</p>
                        </button>

                        <button onclick="contactKitchen()" class="metric-card text-center group hover:bg-orange-50">
                            <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-2 group-hover:bg-orange-200 transition-colors">
                                <span class="material-symbols-outlined text-2xl text-orange-600">call</span>
                            </div>
                            <h4 class="font-semibold text-gray-900 mb-2">Contact Kitchen</h4>
                            <p class="text-sm text-gray-600">Call about your order</p>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics Tab -->
            <div id="golfer-stats" class="tab-content">
                <div class="space-y-8">
                    <!-- Performance Summary -->
                    <div class="metric-card">
                        <h3 class="text-2xl font-bold text-gray-900 mb-6" data-i18n="golfer.performance">Performance Summary</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                            <div class="text-center">
                                <div class="metric-value text-gray-400 user-handicap">0</div>
                                <div class="metric-label" data-i18n="golfer.stats.handicap">Current Handicap</div>
                                <div class="text-xs text-gray-400 mt-1">Not set</div>
                            </div>
                            <div class="text-center">
                                <div class="metric-value text-gray-400">-</div>
                                <div class="metric-label" data-i18n="golfer.avgscore">Average Score</div>
                                <div class="text-xs text-gray-400 mt-1" data-i18n="golfer.norounds">No rounds yet</div>
                            </div>
                            <div class="text-center">
                                <div class="metric-value text-gray-400">-</div>
                                <div class="metric-label" data-i18n="golfer.bestscore">Best Score</div>
                                <div class="text-xs text-gray-400 mt-1" data-i18n="golfer.norounds">No rounds yet</div>
                            </div>
                            <div class="text-center">
                                <div class="metric-value text-gray-400">0</div>
                                <div class="metric-label" data-i18n="golfer.roundsplayed">Rounds Played</div>
                                <div class="text-xs text-gray-400 mt-1" data-i18n="golfer.thisyear">This year</div>
                            </div>
                        </div>

                        <!-- Personal Info -->
                        <div class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-green-50 rounded-lg">
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div class="text-center">
                                    <div class="text-sm font-medium text-gray-600" data-i18n="golfer.stats.experience">Experience</div>
                                    <div class="experience-level font-semibold text-blue-600">Intermediate</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-sm font-medium text-gray-600" data-i18n="golfer.stats.homeclub">Home Club</div>
                                    <div class="home-club font-semibold text-green-600">Pattaya Golf Club</div>
                                </div>
                                <div class="text-center club-affiliation-stats-container" style="display: none;">
                                    <div class="text-sm font-medium text-gray-600" data-i18n="golfer.stats.society">Society</div>
                                    <div class="club-affiliation font-semibold text-blue-600">Society Name</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-sm font-medium text-gray-600" data-i18n="golfer.stats.membersince">Member Since</div>
                                    <div class="member-since font-semibold text-purple-600">2024</div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Achievements -->
                    <div class="metric-card">
                        <h3 class="text-xl font-bold text-gray-900 mb-6" data-i18n="golfer.stats.achievements">Achievements</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="achievement-card p-4 bg-yellow-50 border-2 border-yellow-200 rounded-lg text-center">
                                <div class="w-12 h-12 bg-yellow-500 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <span class="material-symbols-outlined text-white">emoji_events</span>
                                </div>
                                <h4 class="font-bold text-gray-900" data-i18n="golfer.stats.eagleachievement">Eagle Achievement</h4>
                                <p class="text-sm text-gray-600">3 eagles this month</p>
                            </div>

                            <div class="achievement-card p-4 bg-green-50 border-2 border-green-200 rounded-lg text-center">
                                <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <span class="material-symbols-outlined text-white">trending_down</span>
                                </div>
                                <h4 class="font-bold text-gray-900" data-i18n="golfer.stats.handicapimprovement">Handicap Improvement</h4>
                                <p class="text-sm text-gray-600">Reduced by 2 points</p>
                            </div>

                            <div class="achievement-card p-4 bg-blue-50 border-2 border-blue-200 rounded-lg text-center">
                                <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <span class="material-symbols-outlined text-white">schedule</span>
                                </div>
                                <h4 class="font-bold text-gray-900" data-i18n="golfer.stats.newplayer">New Player</h4>
                                <p class="text-sm text-gray-600">0 rounds this year</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GPS & Navigation Tab -->
            <div id="golfer-gps" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Course Map -->
                    <div class="lg:col-span-2">
                        <div class="metric-card">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-bold text-gray-900" data-i18n="golfer.gps.navigation">Course Navigation</h3>
                                <button onclick="getCurrentLocation()" class="btn-primary">
                                    <span class="material-symbols-outlined text-sm">my_location</span>
                                    <span data-i18n="golfer.gps.updatelocation">Update Location</span>
                                </button>
                            </div>

                            <!-- Google Maps Course View -->
                            <div id="courseMap" class="rounded-lg mb-6" style="height: 400px; width: 100%;">
                                <!-- Map will be loaded here -->
                            </div>

                            <!-- Map Controls -->
                            <div class="flex items-center justify-between mb-4 p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-4">
                                    <button onclick="toggleMapType()" class="btn-sm btn-outline">
                                        <span class="material-symbols-outlined text-sm">satellite</span>
                                        <span data-i18n="golfer.gps.satellite">Satellite</span>
                                    </button>
                                    <button onclick="centerOnPlayer()" class="btn-sm btn-outline">
                                        <span class="material-symbols-outlined text-sm">my_location</span>
                                        <span data-i18n="golfer.gps.centeronme">Center on Me</span>
                                    </button>
                                </div>
                                <div class="text-sm text-gray-600">
                                    <span data-i18n="golfer.gps.accuracy">GPS Accuracy</span>: <span id="mapAccuracy">--</span>
                                </div>
                            </div>

                            <!-- Hole Information -->
                            <div class="grid grid-cols-3 gap-4">
                                <div class="text-center p-4 bg-blue-50 rounded-lg">
                                    <div class="font-bold text-2xl text-blue-600" id="currentHoleNum">7</div>
                                    <div class="text-sm text-blue-800" data-i18n="golfer.current.hole">Current Hole</div>
                                </div>
                                <div class="text-center p-4 bg-green-50 rounded-lg">
                                    <div class="font-bold text-2xl text-green-600">Par 4</div>
                                    <div class="text-sm text-green-800" data-i18n="golfer.gps.holepar">Hole Par</div>
                                </div>
                                <div class="text-center p-4 bg-purple-50 rounded-lg">
                                    <div class="font-bold text-2xl text-purple-600">387</div>
                                    <div class="text-sm text-purple-800" data-i18n="golfer.gps.yardstotal">Yards Total</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- GPS Data & Tools -->
                    <div class="lg:col-span-1">
                        <div class="space-y-6">
                            <!-- Distance Information -->
                            <div class="metric-card">
                                <h4 class="font-bold text-gray-900 mb-4" data-i18n="golfer.gps.distanceinfo">Distance Information</h4>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <span class="font-medium" data-i18n="golfer.gps.tofront">To Front</span>
                                        <span class="font-bold text-green-600">125 yds</span>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-primary-50 rounded-lg">
                                        <span class="font-medium" data-i18n="golfer.gps.topin">To Pin</span>
                                        <span class="font-bold text-primary-600" id="pinDistance">145 yds</span>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <span class="font-medium" data-i18n="golfer.gps.toback">To Back</span>
                                        <span class="font-bold text-red-600">165 yds</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Course Conditions -->
                            <div class="metric-card">
                                <h4 class="font-bold text-gray-900 mb-4" data-i18n="golfer.gps.conditions">Course Conditions</h4>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                                        <div class="flex items-center space-x-2">
                                            <span class="material-symbols-outlined text-blue-600">thermostat</span>
                                            <span class="font-medium" data-i18n="golfer.temperature">Temperature</span>
                                        </div>
                                        <span class="font-bold text-blue-600">75°F</span>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                        <div class="flex items-center space-x-2">
                                            <span class="material-symbols-outlined text-green-600">air</span>
                                            <span class="font-medium" data-i18n="golfer.wind">Wind</span>
                                        </div>
                                        <span class="font-bold text-green-600">5 mph NE</span>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
                                        <div class="flex items-center space-x-2">
                                            <span class="material-symbols-outlined text-yellow-600">water_drop</span>
                                            <span class="font-medium">Humidity</span>
                                        </div>
                                        <span class="font-bold text-yellow-600">65%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="metric-card">
                                <h4 class="font-bold text-gray-900 mb-4" data-i18n="common.actions">Quick Actions</h4>
                                <div class="space-y-3">
                                    <button onclick="measureDistance()" class="btn-primary w-full">
                                        <span class="material-symbols-outlined text-sm">straighten</span>
                                        <span data-i18n="golfer.gps.measuredistance">Measure Distance</span>
                                    </button>
                                    <button onclick="findNearestCart()" class="btn-secondary w-full">
                                        <span class="material-symbols-outlined text-sm">local_taxi</span>
                                        <span data-i18n="golfer.gps.findcart">Find Cart</span>
                                    </button>
                                    <button onclick="callMarshal()" class="btn-secondary w-full">
                                        <span class="material-symbols-outlined text-sm">support_agent</span>
                                        <span data-i18n="golfer.gps.callmarshal">Call Marshal</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Pace of Play -->
                            <div class="metric-card">
                                <h4 class="font-bold text-gray-900 mb-4" data-i18n="golfer.gps.paceofplay">Pace of Play</h4>
                                <div class="text-center">
                                    <div class="font-bold text-2xl text-green-600" data-i18n="golfer.gps.ontime">On Time</div>
                                    <div class="text-sm text-gray-600 mb-3">2h 15m <span data-i18n="golfer.gps.elapsed">elapsed</span></div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-green-600 h-2 rounded-full" style="width: 42%"></div>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-2">Hole 7 of 18</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Round History Tab -->
            <div id="golfer-rounds" class="tab-content">
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-bold text-gray-900" data-i18n="golfer.history.title">Round History</h2>
                        <button onclick="addNewRound()" class="btn-primary">
                            <span class="material-symbols-outlined text-sm">add</span>
                            <span data-i18n="golfer.history.addround">Add Round</span>
                        </button>
                    </div>

                    <!-- Stats Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="metric-card text-center">
                            <div class="font-bold text-2xl text-primary-600" id="rounds-total-count">0</div>
                            <div class="text-sm text-gray-600" data-i18n="golfer.history.totalrounds">Total Rounds</div>
                        </div>
                        <div class="metric-card text-center">
                            <div class="font-bold text-2xl text-blue-600" id="rounds-avg-score">-</div>
                            <div class="text-sm text-gray-600" data-i18n="golfer.history.avgscoreLabel">Average Score</div>
                        </div>
                        <div class="metric-card text-center">
                            <div class="font-bold text-2xl text-green-600" id="rounds-handicap">-</div>
                            <div class="text-sm text-gray-600" data-i18n="golfer.history.currenthandicap">Current Handicap</div>
                        </div>
                        <div class="metric-card text-center">
                            <div class="font-bold text-2xl text-purple-600" id="rounds-best-score">-</div>
                            <div class="text-sm text-gray-600" data-i18n="golfer.history.bestround">Best Round</div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="metric-card">
                        <div class="flex flex-wrap items-center gap-4">
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700" data-i18n="golfer.history.courselabel">Course:</label>
                                <select id="roundHistoryCourseFilter" class="form-select text-sm" onchange="GolfScoreSystem.filterRoundHistory()">
                                    <option value="" data-i18n="golfer.history.allcourses">All Courses</option>
                                    <option value="bangpakong">Bangpakong Golf Club</option>
                                    <option value="bangpra">Bangpra International Golf Club</option>
                                    <option value="burapha_ac">Burapha Golf Club - A/C Course</option>
                                    <option value="burapha_cd">Burapha Golf Club - C/D Course</option>
                                    <option value="burapha_east">Burapha Golf Club - East Course</option>
                                    <option value="crystal_bay">Crystal Bay Golf Club</option>
                                    <option value="grand_prix">Grand Prix Golf Club</option>
                                    <option value="khao_kheow">Khao Kheow Golf Club</option>
                                    <option value="laem_chabang">Laem Chabang International Country Club</option>
                                    <option value="mountain_shadow">Mountain Shadow Golf Club</option>
                                    <option value="pattana">Pattana Golf Club & Resort</option>
                                    <option value="pattavia">Pattavia Century Golf Club</option>
                                    <option value="pattaya_county">Pattaya County Club</option>
                                    <option value="pleasant_valley">Pleasant Valley Golf Club</option>
                                    <option value="plutaluang">Plutaluang Navy Golf Course</option>
                                    <option value="royal_lakeside">Royal Lakeside Golf Club</option>
                                    <option value="siam_cc_old">Siam Country Club - Old Course</option>
                                    <option value="siam_plantation">Siam Plantation Golf Club</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700" data-i18n="golfer.history.year">Year:</label>
                                <select id="roundHistoryYearFilter" class="form-select text-sm" onchange="GolfScoreSystem.filterRoundHistory()">
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700" data-i18n="golfer.history.tees">Tees:</label>
                                <select id="roundHistoryTeeFilter" class="form-select text-sm" onchange="GolfScoreSystem.filterRoundHistory()">
                                    <option value="" data-i18n="golfer.history.alltees">All Tees</option>
                                    <option value="red">Red</option>
                                    <option value="white">White</option>
                                    <option value="yellow">Yellow</option>
                                    <option value="blue">Blue</option>
                                    <option value="black">Black</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Handicap Progression Chart -->
                    <div class="metric-card" id="handicapProgressionCard" style="display: none;">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-900">📊 Handicap Progression</h3>
                            <p class="text-sm text-gray-500">Track your improvement over time</p>
                        </div>

                        <!-- Chart Container -->
                        <div class="bg-gradient-to-br from-blue-50 to-green-50 rounded-lg p-6">
                            <!-- Visual Chart -->
                            <div class="relative h-48 mb-6" id="handicapChartArea">
                                <div class="absolute inset-0 flex items-end justify-between gap-1" id="handicapChartBars">
                                    <!-- Bars will be inserted here -->
                                </div>
                                <!-- Y-axis labels -->
                                <div class="absolute left-0 top-0 bottom-0 flex flex-col justify-between text-xs text-gray-500 -ml-8">
                                    <span id="handicap_max">30</span>
                                    <span id="handicap_mid">15</span>
                                    <span id="handicap_min">0</span>
                                </div>
                            </div>

                            <!-- Legend -->
                            <div class="flex flex-wrap gap-4 text-sm">
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 bg-green-500 rounded"></div>
                                    <span class="text-gray-700">Improved (Lower)</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 bg-red-500 rounded"></div>
                                    <span class="text-gray-700">Increased (Higher)</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 bg-blue-500 rounded"></div>
                                    <span class="text-gray-700">Unchanged</span>
                                </div>
                            </div>
                        </div>

                        <!-- Recent History Table -->
                        <div class="mt-6 overflow-x-auto">
                            <h4 class="text-sm font-bold text-gray-700 mb-3">Recent Handicap Changes</h4>
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-700">Date</th>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-700">Course</th>
                                        <th class="py-2 px-3 text-center font-semibold text-gray-700">Score</th>
                                        <th class="py-2 px-3 text-center font-semibold text-gray-700">Handicap</th>
                                        <th class="py-2 px-3 text-center font-semibold text-gray-700">Change</th>
                                    </tr>
                                </thead>
                                <tbody id="handicapHistoryTable" class="divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="5" class="text-center py-4 text-gray-500">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Round History Management -->
                    <div class="metric-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-900">Round History</h3>
                            <p class="text-sm text-gray-500">Manage your recorded rounds</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="text-left py-3 px-4 font-medium text-gray-700">Date</th>
                                        <th class="text-left py-3 px-4 font-medium text-gray-700">Course</th>
                                        <th class="text-center py-3 px-4 font-medium text-gray-700">Holes</th>
                                        <th class="text-center py-3 px-4 font-medium text-gray-700">Score</th>
                                        <th class="text-center py-3 px-4 font-medium text-gray-700">Par</th>
                                        <th class="text-center py-3 px-4 font-medium text-gray-700">Diff</th>
                                        <th class="text-center py-3 px-4 font-medium text-gray-700">Handicap Diff</th>
                                        <th class="text-right py-3 px-4 font-medium text-gray-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="round-history-table">
                                    <tr>
                                        <td colspan="8" class="text-center py-8 text-gray-500">No rounds recorded yet.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Performance Trends -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Score Trend Chart -->
                        <div class="metric-card">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">Score Trend</h3>
                            <div class="h-64 flex items-center justify-center bg-gray-50 rounded-lg">
                                <div class="text-center text-gray-500">
                                    <span class="material-symbols-outlined text-4xl mb-2">trending_up</span>
                                    <p>Score trend chart would appear here</p>
                                </div>
                            </div>
                        </div>

                        <!-- Handicap Progress -->
                        <div class="metric-card">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">Handicap Progress</h3>
                            <div class="h-64 flex items-center justify-center bg-gray-50 rounded-lg">
                                <div class="text-center text-gray-500">
                                    <span class="material-symbols-outlined text-4xl mb-2">analytics</span>
                                    <p>Handicap progress chart would appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Society Events Tab -->
            <div id="golfer-societyevents" class="tab-content">
                <div class="space-y-4">
                    <!-- Sub-tabs with Refresh Button -->
                    <div class="border-b border-gray-200">
                        <nav class="flex items-center justify-between">
                            <div class="flex space-x-4">
                                <button onclick="GolferEventsSystem.showEventsView('browse')" id="eventsViewBrowse" class="events-subtab-btn active px-4 py-2 border-b-2 border-green-500 text-green-600 font-medium text-sm">
                                    <span class="material-symbols-outlined text-sm mr-1">grid_view</span>
                                    Browse Events
                                </button>
                                <button onclick="GolferEventsSystem.showEventsView('calendar')" id="eventsViewCalendar" class="events-subtab-btn px-4 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-900 font-medium text-sm">
                                    <span class="material-symbols-outlined text-sm mr-1">calendar_month</span>
                                    Calendar
                                </button>
                                <button onclick="GolferEventsSystem.showEventsView('myevents')" id="eventsViewMyEvents" class="events-subtab-btn px-4 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-900 font-medium text-sm">
                                    <span class="material-symbols-outlined text-sm mr-1">confirmation_number</span>
                                    My Registrations
                                </button>
                                <button onclick="GolferEventsSystem.showEventsView('history')" id="eventsViewHistory" class="events-subtab-btn px-4 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-900 font-medium text-sm">
                                    <span class="material-symbols-outlined text-sm mr-1">history</span>
                                    History
                                </button>
                            </div>
                            <button onclick="GolferEventsSystem.refreshEvents()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Refresh Events">
                                <span class="material-symbols-outlined text-gray-600 text-xl">refresh</span>
                            </button>
                        </nav>
                    </div>

                    <!-- Browse Events View -->
                    <div id="eventsViewBrowseContent" class="events-view-content">

                    <!-- Society Subscriptions -->
                    <div class="metric-card mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold text-gray-900">My Society Subscriptions</h3>
                            <button onclick="GolferEventsSystem.toggleSocietySelector()" class="text-sm text-green-600 hover:text-green-700 font-medium">
                                <span class="material-symbols-outlined text-sm align-middle">tune</span>
                                Manage
                            </button>
                        </div>

                        <!-- Selected Societies Display -->
                        <div id="selectedSocietiesDisplay" class="flex flex-wrap gap-2 min-h-[32px]">
                            <span class="text-sm text-gray-500">Select societies to see their events...</span>
                        </div>

                        <!-- Society Selector (Hidden by default) -->
                        <div id="societySelectorPanel" class="mt-4 pt-4 border-t border-gray-200" style="display: none;">
                            <p class="text-xs text-gray-600 mb-3">Select which societies you want to follow. Only events from selected societies will appear in your feed.</p>
                            <div id="societyCheckboxList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-64 overflow-y-auto">
                                <!-- Checkboxes will be populated here -->
                            </div>
                            <div class="mt-4 flex gap-2">
                                <button onclick="GolferEventsSystem.selectAllSocieties()" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg">Select All</button>
                                <button onclick="GolferEventsSystem.clearAllSocieties()" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg">Clear All</button>
                            </div>
                        </div>
                    </div>

                    <!-- Search and Filters -->
                    <div class="metric-card">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Search -->
                            <div class="lg:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Search Events</label>
                                <div class="relative">
                                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">search</span>
                                    <input
                                        type="text"
                                        id="societyEventSearch"
                                        placeholder="Search by name, course, organizer..."
                                        class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        oninput="GolferEventsSystem.filterEvents()"
                                    >
                                </div>
                            </div>

                            <!-- Date Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                                <select id="societyEventDateFilter" class="form-select w-full" onchange="GolferEventsSystem.filterEvents()">
                                    <option value="all">All Dates</option>
                                    <option value="upcoming">Next 7 Days</option>
                                    <option value="thismonth">This Month</option>
                                    <option value="nextmonth">Next Month</option>
                                </select>
                            </div>

                            <!-- Status Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="societyEventStatusFilter" class="form-select w-full" onchange="GolferEventsSystem.filterEvents()">
                                    <option value="all">All Status</option>
                                    <option value="favorites">⭐ My Favorites</option>
                                    <option value="open">Open for Registration</option>
                                    <option value="filling">Filling Fast</option>
                                    <option value="waitlist">Waitlist Available</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Event Cards Grid -->
                    <div id="societyEventsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Events will be rendered here -->
                        <div class="col-span-full text-center py-12 text-gray-500">
                            <span class="material-symbols-outlined text-5xl mb-3 text-gray-300">event_busy</span>
                            <p class="text-lg">Loading society events...</p>
                        </div>
                    </div>
                    </div>
                    <!-- End Browse Events View -->

                    <!-- Calendar View -->
                    <div id="eventsViewCalendarContent" class="events-view-content" style="display: none;">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Calendar (2/3 width) -->
                            <div class="lg:col-span-2">
                                <div class="bg-white rounded-lg shadow-sm p-6">
                                    <!-- Month Navigation -->
                                    <div class="flex items-center justify-between mb-6">
                                        <button onclick="GolferEventsSystem.calendarPrevMonth()" class="p-2 hover:bg-gray-100 rounded-lg">
                                            <span class="material-symbols-outlined">chevron_left</span>
                                        </button>
                                        <h3 id="golferCalendarMonthYear" class="text-2xl font-bold text-gray-800"></h3>
                                        <button onclick="GolferEventsSystem.calendarNextMonth()" class="p-2 hover:bg-gray-100 rounded-lg">
                                            <span class="material-symbols-outlined">chevron_right</span>
                                        </button>
                                    </div>

                                    <!-- Day Headers -->
                                    <div class="grid grid-cols-7 gap-1 mb-2">
                                        <div class="text-center text-xs font-semibold text-gray-600 py-2">Sun</div>
                                        <div class="text-center text-xs font-semibold text-gray-600 py-2">Mon</div>
                                        <div class="text-center text-xs font-semibold text-gray-600 py-2">Tue</div>
                                        <div class="text-center text-xs font-semibold text-gray-600 py-2">Wed</div>
                                        <div class="text-center text-xs font-semibold text-gray-600 py-2">Thu</div>
                                        <div class="text-center text-xs font-semibold text-gray-600 py-2">Fri</div>
                                        <div class="text-center text-xs font-semibold text-gray-600 py-2">Sat</div>
                                    </div>

                                    <!-- Calendar Grid -->
                                    <div id="golferCalendarGrid" class="grid grid-cols-7 gap-1">
                                        <!-- Calendar cells will be rendered here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Selected Date Events (1/3 width) -->
                            <div class="lg:col-span-1">
                                <div id="golferCalendarSidebar" class="bg-white rounded-lg shadow-sm p-6 sticky top-4">
                                    <div class="text-center text-gray-500 py-8">
                                        <span class="material-symbols-outlined text-5xl mb-3">event</span>
                                        <p class="text-sm">Click a date to view events</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End Calendar View -->

                    <!-- My Registrations View -->
                    <div id="eventsViewMyEventsContent" class="events-view-content" style="display: none;">
                        <div id="myRegistrationsList" class="space-y-4">
                            <p class="text-center py-12 text-gray-500">Loading your registrations...</p>
                        </div>
                    </div>
                    <!-- End My Registrations View -->

                    <!-- History View -->
                    <div id="eventsViewHistoryContent" class="events-view-content" style="display: none;">
                        <div id="myHistoryList" class="space-y-4">
                            <p class="text-center py-12 text-gray-500">Loading your history...</p>
                        </div>
                    </div>
                    <!-- End History View -->

                </div>
            </div>

            <!-- Live Scorecard Tab -->
            <div id="golfer-scorecard" class="tab-content">
                <div class="space-y-6">

                    <!-- Start Round Section -->
                    <div id="scorecardStartSection" class="metric-card">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">🏌️ Start New Round</h2>

                        <!-- Event Selection -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Event Type</label>
                            <select id="scorecardEventSelect" class="w-full rounded-lg border px-3 py-2">
                                <option value="">Practice Round (No Event)</option>
                                <option value="private">Private Round (with friends)</option>
                            </select>
                        </div>

                        <!-- Course Selection -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="scorecard.course">Course</label>
                            <div class="flex gap-2 items-stretch">
                                <select id="scorecardCourseSelect" class="flex-1 min-w-0 rounded-lg border px-3 py-2 text-sm truncate" style="max-width: calc(100% - 80px);">
                                    <option value="" data-i18n="scorecard.select.course">-- Select Course --</option>
                                    <option value="bangpakong">Bangpakong Riverside Country Club</option>
                                    <option value="bangpra_international">Bangpra International Golf Club</option>
                                    <option value="burapha_east">Burapha Golf Club - East Course</option>
                                    <option value="burapha_west">Burapha Golf Club - West Course</option>
                                    <option value="crystal_bay">Crystal Bay Golf Club</option>
                                    <option value="grand_prix">Grand Prix Golf Club</option>
                                    <option value="khao_kheow_ab">Khao Kheow A+B</option>
                                    <option value="khao_kheow_ac">Khao Kheow A+C</option>
                                    <option value="khao_kheow_bc">Khao Kheow B+C</option>
                                    <option value="laem_chabang">Laem Chabang International Country Club</option>
                                    <option value="mountain_shadow">Mountain Shadow Golf Club</option>
                                    <option value="pattana_golf">Pattana Golf Resort & Spa</option>
                                    <option value="pattavia">Pattavia Golf Club</option>
                                    <option value="pattaya_country_club">Pattaya Country Club</option>
                                    <option value="pleasant_valley">Pleasant Valley Golf Club</option>
                                    <option value="plutaluang">Plutaluang Royal Thai Navy Golf Course</option>
                                    <option value="royal_lakeside">Royal Lakeside Golf Club</option>
                                    <option value="siam_cc_old">Siam Country Club - Old Course</option>
                                    <option value="siam_plantation">Siam Plantation Golf Club</option>
                                </select>
                                <button onclick="LiveScorecardManager.openCourseLibrary()" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-1 flex-shrink-0" style="min-width: 70px;">
                                    <span class="material-symbols-outlined text-sm">library_books</span>
                                    <span class="hidden sm:inline text-sm" data-i18n="scorecard.manage">Manage</span>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1" data-i18n="scorecard.course.data.note">Course data loads only when you start round</p>
                        </div>

                        <!-- Tee Markers -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="scorecard.teemarkers">Tee Markers</label>
                            <div class="flex flex-wrap gap-3">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="teeMarker" value="red" class="mr-2">
                                    <span class="px-4 py-2 border-2 border-red-500 text-red-700 rounded-lg font-medium" data-i18n="scorecard.red">Red</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="teeMarker" value="white" checked class="mr-2">
                                    <span class="px-4 py-2 border-2 border-gray-400 text-gray-700 rounded-lg font-medium" data-i18n="scorecard.white">White</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="teeMarker" value="yellow" class="mr-2">
                                    <span class="px-4 py-2 border-2 border-yellow-500 text-yellow-700 rounded-lg font-medium" data-i18n="scorecard.yellow">Yellow</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="teeMarker" value="blue" class="mr-2">
                                    <span class="px-4 py-2 border-2 border-blue-500 text-blue-700 rounded-lg font-medium" data-i18n="scorecard.blue">Blue</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="teeMarker" value="black" class="mr-2">
                                    <span class="px-4 py-2 border-2 border-black text-black rounded-lg font-medium" data-i18n="scorecard.black">Black</span>
                                </label>
                            </div>
                        </div>

                        <!-- Scoring Format -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-medium text-gray-700" data-i18n="scorecard.scoring.formats">Scoring Formats (select one or more)</label>
                                <button type="button" onclick="window.toggleAllFormats?window.toggleAllFormats():console.log('Toggle not loaded')" class="text-xs text-blue-600 hover:text-blue-800 font-medium" data-i18n="scorecard.select.all">
                                    Select All / Deselect All
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mb-3">✨ Click any box to select - multiple selections enabled</p>
                            <div id="scoringFormatContainer" class="flex flex-col gap-2">
                                <label class="scoring-format-label flex items-center p-3 border-2 border-green-500 bg-green-50 rounded-lg cursor-pointer" onclick="toggleFormatCheckbox(this, event)">
                                    <input type="checkbox" name="scoringFormat" value="stableford" checked class="scoring-format-checkbox mr-3 w-5 h-5 cursor-pointer">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Thailand Stableford</div>
                                        <div class="text-xs text-gray-600">Standard in Thailand • Base: Eagle 4, Birdie 3, Par 2, Bogey 1 • +1 bonus on stroke holes</div>
                                    </div>
                                </label>
                                <label class="scoring-format-label flex items-center p-3 border-2 border-gray-300 bg-white rounded-lg cursor-pointer hover:border-gray-400" onclick="toggleFormatCheckbox(this, event)">
                                    <input type="checkbox" name="scoringFormat" value="strokeplay" class="scoring-format-checkbox mr-3 w-5 h-5 cursor-pointer">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Stroke Play</div>
                                        <div class="text-xs text-gray-600">Tournament format • Total strokes counted</div>
                                    </div>
                                </label>
                                <label class="scoring-format-label flex items-center p-3 border-2 border-gray-300 bg-white rounded-lg cursor-pointer hover:border-gray-400" onclick="toggleFormatCheckbox(this, event)">
                                    <input type="checkbox" name="scoringFormat" value="matchplay" class="scoring-format-checkbox mr-3 w-5 h-5 cursor-pointer">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Match Play</div>
                                        <div class="text-xs text-gray-600">Head-to-head • Win/lose/halve each hole</div>
                                    </div>
                                </label>
                                <label class="scoring-format-label flex items-center p-3 border-2 border-gray-300 bg-white rounded-lg cursor-pointer hover:border-gray-400" onclick="toggleFormatCheckbox(this, event)">
                                    <input type="checkbox" name="scoringFormat" value="bestball" class="scoring-format-checkbox mr-3 w-5 h-5 cursor-pointer">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Best Ball</div>
                                        <div class="text-xs text-gray-600">Team format • Best score per hole counts</div>
                                    </div>
                                </label>
                                <label class="scoring-format-label flex items-center p-3 border-2 border-gray-300 bg-white rounded-lg cursor-pointer hover:border-gray-400" onclick="toggleFormatCheckbox(this, event)">
                                    <input type="checkbox" name="scoringFormat" value="scramble" class="scoring-format-checkbox mr-3 w-5 h-5 cursor-pointer">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Scramble</div>
                                        <div class="text-xs text-gray-600">Team format • Everyone plays best shot</div>
                                    </div>
                                </label>
                                <label class="scoring-format-label flex items-center p-3 border-2 border-gray-300 bg-white rounded-lg cursor-pointer hover:border-gray-400" onclick="toggleFormatCheckbox(this, event)">
                                    <input type="checkbox" name="scoringFormat" value="modifiedstableford" class="scoring-format-checkbox mr-3 w-5 h-5 cursor-pointer">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Modified Stableford</div>
                                        <div class="text-xs text-gray-600">Albatross 8, Eagle 5, Birdie 2, Par 0, Bogey -1, Double+ -3</div>
                                    </div>
                                </label>
                                <label class="scoring-format-label flex items-center p-3 border-2 border-gray-300 bg-white rounded-lg cursor-pointer hover:border-gray-400" onclick="toggleFormatCheckbox(this, event)">
                                    <input type="checkbox" name="scoringFormat" value="skins" class="scoring-format-checkbox mr-3 w-5 h-5 cursor-pointer">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Skins Game</div>
                                        <div class="text-xs text-gray-600">Win individual holes • Ties carry over</div>
                                    </div>
                                </label>
                                <label class="scoring-format-label flex items-center p-3 border-2 border-gray-300 bg-white rounded-lg cursor-pointer hover:border-gray-400" onclick="toggleFormatCheckbox(this, event)">
                                    <input type="checkbox" name="scoringFormat" value="nassau" class="scoring-format-checkbox mr-3 w-5 h-5 cursor-pointer">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Nassau</div>
                                        <div class="text-xs text-gray-600">Three matches • Front 9, Back 9, Overall</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Skins Value -->
                        <div class="mb-4" id="skinsValueSection" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="material-symbols-outlined text-sm align-middle text-orange-600">monetization_on</span>
                                Skins Value Per Hole (Points)
                            </label>
                            <input type="number" id="skinsValueInput" min="1" max="100000" value="100" placeholder="Enter points per hole (1-100,000)" class="w-full rounded-lg border px-3 py-2">
                            <p class="text-xs text-gray-500 mt-1">💰 Points awarded per hole (e.g., 100 points/hole = 1,800 total)</p>
                        </div>


                        <!-- Scramble Configuration -->
                        <div class="mb-4" id="scrambleConfigSection" style="display: none;">
                            <div class="p-4 bg-gradient-to-r from-blue-50 to-green-50 border-2 border-blue-200 rounded-lg">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="material-symbols-outlined text-blue-600">groups</span>
                                    <label class="text-sm font-semibold text-gray-900">Scramble Settings</label>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Team Size</label>
                                    <div class="flex gap-2">
                                        <label class="flex-1 flex items-center justify-center p-2 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-blue-400">
                                            <input type="radio" name="scrambleTeamSize" value="2" class="mr-2"><span class="font-medium">2-Man</span>
                                        </label>
                                        <label class="flex-1 flex items-center justify-center p-2 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-blue-400">
                                            <input type="radio" name="scrambleTeamSize" value="3" class="mr-2"><span class="font-medium">3-Man</span>
                                        </label>
                                        <label class="flex-1 flex items-center justify-center p-2 border-2 border-blue-500 bg-blue-50 rounded-lg cursor-pointer">
                                            <input type="radio" name="scrambleTeamSize" value="4" checked class="mr-2"><span class="font-medium">4-Man</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="flex items-center text-sm mb-2">
                                        <input type="checkbox" id="scrambleTrackDrives" class="mr-2" checked><span class="font-medium">Track Drive Usage</span>
                                    </label>
                                    <div id="scrambleDriveRequirements">
                                        <label class="block text-xs text-gray-600 mb-1">Minimum drives per player</label>
                                        <div class="flex gap-2 items-center">
                                            <input type="number" id="scrambleMinDrives" min="0" max="18" value="4" class="w-20 rounded border px-2 py-1 text-sm">
                                            <span class="text-xs text-gray-600">drives (out of 18 holes)</span>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">💡 Each player must have at least this many drives used</p>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" id="scrambleTrackPutts" class="mr-2" checked><span class="font-medium">Track Who Made Each Putt</span>
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1">📊 Track statistics for each team member</p>
                                </div>

                                <!-- Handicap Calculator -->
                                <div class="border-t-2 border-green-200 pt-3 mt-3">
                                    <label class="block text-sm font-semibold text-gray-900 mb-2">Team Handicap Method</label>

                                    <!-- Method Selector -->
                                    <div class="flex gap-2 mb-3">
                                        <label class="flex-1 flex items-center justify-center p-2 border-2 border-green-500 bg-green-50 rounded-lg cursor-pointer">
                                            <input type="radio" name="scrambleHcpMethod" value="usga" checked class="mr-2" onchange="updateScrambleHcpMethod()">
                                            <span class="text-xs font-medium">USGA</span>
                                        </label>
                                        <label class="flex-1 flex items-center justify-center p-2 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-green-400">
                                            <input type="radio" name="scrambleHcpMethod" value="percentage" class="mr-2" onchange="updateScrambleHcpMethod()">
                                            <span class="text-xs font-medium">Percentage</span>
                                        </label>
                                        <label class="flex-1 flex items-center justify-center p-2 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-green-400">
                                            <input type="radio" name="scrambleHcpMethod" value="manual" class="mr-2" onchange="updateScrambleHcpMethod()">
                                            <span class="text-xs font-medium">Manual</span>
                                        </label>
                                    </div>

                                    <!-- USGA Method (default, always visible) -->
                                    <div id="scrambleHcpUSGA" class="mb-2">
                                        <p class="text-xs text-gray-600">
                                            <strong>Standard USGA Formula:</strong><br>
                                            2-Man: 35% + 15%<br>
                                            3-Man: 30% + 20% + 10%<br>
                                            4-Man: 25% + 20% + 15% + 10%
                                        </p>
                                    </div>

                                    <!-- Percentage Method -->
                                    <div id="scrambleHcpPercentage" style="display: none;">
                                        <label class="block text-xs text-gray-700 mb-1">Handicap Reduction Percentage</label>
                                        <div class="flex gap-2 items-center mb-2">
                                            <input type="number" id="scrambleHcpPercent" min="1" max="100" value="25" step="1" class="w-20 rounded border-2 border-green-300 px-2 py-1 text-sm" oninput="calculateScrambleHcp()">
                                            <span class="text-sm text-gray-700">% reduction</span>
                                        </div>
                                        <p class="text-xs text-gray-500">
                                            Example: Average 5.5, minus 25% = 5.5 × 75% = 4.1
                                        </p>
                                    </div>

                                    <!-- Manual Entry Method -->
                                    <div id="scrambleHcpManual" style="display: none;">
                                        <label class="block text-xs text-gray-700 mb-1">Enter Team Handicap</label>
                                        <div class="flex gap-2 items-center mb-2">
                                            <input type="number" id="scrambleHcpManualValue" min="0" max="54" value="6" step="0.1" class="w-24 rounded border-2 border-green-300 px-2 py-1 text-sm" oninput="calculateScrambleHcp()">
                                            <span class="text-sm text-gray-700">Team HCP</span>
                                        </div>
                                        <p class="text-xs text-gray-500">
                                            💡 Enter the handicap provided by your organizer
                                        </p>
                                    </div>

                                    <!-- Live Preview -->
                                    <div id="scrambleHcpPreview" class="mt-3 p-2 bg-green-100 border border-green-300 rounded text-center">
                                        <div class="text-xs text-gray-600">Team Handicap Preview</div>
                                        <div class="text-lg font-bold text-green-800" id="scrambleHcpPreviewValue">-</div>
                                        <div class="text-xs text-gray-500" id="scrambleHcpPreviewDetails">Add players to calculate</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Public Game Toggle -->
                        <div class="mb-4 p-4 bg-gradient-to-r from-green-50 to-green-100 border-2 border-green-300 rounded-lg">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-green-600">public</span>
                                    <label class="text-sm font-semibold text-gray-900">Make Game Public</label>
                                </div>
                                <label class="relative inline-block w-12 h-6">
                                    <input type="checkbox" id="publicGameToggle" class="sr-only peer" onchange="LiveScorecardManager.togglePublicGame(this.checked)">
                                    <div class="w-full h-full bg-gray-300 rounded-full peer peer-checked:bg-green-600 transition-colors"></div>
                                    <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-6"></div>
                                </label>
                            </div>
                            <div id="publicGameOptions" style="display: none;">
                                <p class="text-xs text-gray-700 mb-3">
                                    <strong>Let other groups compete!</strong> Groups on this course can join your side games in real-time.
                                </p>
                                <div class="space-y-2">
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" id="publicSkins" class="mr-2" checked>
                                        <span>Open Skins pool</span>
                                    </label>
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" id="publicMatchPlay" class="mr-2">
                                        <span>Open Match Play pool</span>
                                    </label>
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" id="publicNassau" class="mr-2">
                                        <span>Open Nassau pool</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Add Players (1-7) -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Add Players (1-7)</label>
                            <div id="scorecardPlayersList" class="space-y-2 mb-3">
                                <!-- Players will be added here -->
                            </div>
                            <button onclick="LiveScorecardManager.addPlayer()" class="btn-secondary w-full">
                                <span class="material-symbols-outlined text-sm">add</span>
                                Add Player
                            </button>
                        </div>

                        <!-- Start Button -->
                        <button onclick="console.log('Button clicked!'); LiveScorecardManager.startRound()" class="btn-primary w-full py-3 text-lg">
                            <span class="material-symbols-outlined">flag</span>
                            Start Round
                        </button>
                    </div>

                    <!-- Active Round Section (Hidden until round starts) -->
                    <div id="scorecardActiveSection" class="space-y-4" style="display: none;">

                        <!-- Hole Info Header -->
                        <div class="metric-card bg-gradient-to-r from-green-500 to-green-400 text-white">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h2 class="text-3xl font-bold" id="currentHoleNumber">Hole 1</h2>
                                    <p class="text-green-100" id="currentHoleInfo">Par 4 • Index 10</p>
                                </div>
                                <div class="text-right flex gap-2">
                                    <button onclick="LiveScorecardManager.viewScorecardImage()" class="px-4 py-2 bg-white text-green-600 rounded-lg font-medium hover:bg-green-50 flex items-center gap-2">
                                        <span class="material-symbols-outlined text-sm">image</span>
                                        Scorecard
                                    </button>
                                    <button onclick="LiveScorecardManager.endRound()" class="px-4 py-2 bg-white text-green-600 rounded-lg font-medium hover:bg-green-50">
                                        End Round
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Group Scorecard -->
                        <div class="metric-card">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-bold text-gray-900">Group Scores</h3>
                                <div class="flex items-center gap-3 text-sm bg-green-50 px-3 py-1.5 rounded-lg">
                                    <div class="flex items-center gap-1">
                                        <span class="text-gray-600">Hole</span>
                                        <span class="font-bold text-green-600" id="groupScoreHoleNum">1</span>
                                    </div>
                                    <div class="w-px h-4 bg-gray-300"></div>
                                    <div class="flex items-center gap-1">
                                        <span class="text-gray-600">Par</span>
                                        <span class="font-bold text-gray-900" id="groupScorePar">4</span>
                                    </div>
                                    <div class="w-px h-4 bg-gray-300"></div>
                                    <div class="flex items-center gap-1">
                                        <span class="text-gray-600">SI</span>
                                        <span class="font-bold text-gray-900" id="groupScoreIndex">10</span>
                                    </div>
                                </div>
                            </div>
                            <div id="groupScorecardGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 mb-4">
                                <!-- Player score boxes will be added here -->
                            </div>
                            <div class="text-sm text-gray-600" id="holeProgress">0/7 players entered</div>
                        </div>

                        <!-- Scoring Entry Section -->
                        <div class="metric-card bg-gray-50">
                            <!-- Grid: Keypad on left, Scramble tracking on right (when active) -->
                            <div id="scoringEntryGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">

                                <!-- Left Column: Phone Keypad -->
                                <div>
                                    <div class="mb-3">
                                        <div class="text-sm font-medium text-gray-600 mb-1">Entering score for:</div>
                                        <div class="text-lg font-bold text-gray-900" id="activePlayerName">Select a player above</div>
                                    </div>

                                    <!-- Keypad -->
                                    <div class="grid grid-cols-3 gap-3 max-w-xs mx-auto md:mx-0">
                                        <button onclick="LiveScorecardManager.enterDigit(1)" class="keypad-btn">1</button>
                                        <button onclick="LiveScorecardManager.enterDigit(2)" class="keypad-btn">2</button>
                                        <button onclick="LiveScorecardManager.enterDigit(3)" class="keypad-btn">3</button>
                                        <button onclick="LiveScorecardManager.enterDigit(4)" class="keypad-btn">4</button>
                                        <button onclick="LiveScorecardManager.enterDigit(5)" class="keypad-btn">5</button>
                                        <button onclick="LiveScorecardManager.enterDigit(6)" class="keypad-btn">6</button>
                                        <button onclick="LiveScorecardManager.enterDigit(7)" class="keypad-btn">7</button>
                                        <button onclick="LiveScorecardManager.enterDigit(8)" class="keypad-btn">8</button>
                                        <button onclick="LiveScorecardManager.enterDigit(9)" class="keypad-btn">9</button>
                                        <button onclick="LiveScorecardManager.clearScore()" class="keypad-btn bg-red-100 text-red-700">
                                            <span class="material-symbols-outlined">backspace</span>
                                        </button>
                                        <button onclick="LiveScorecardManager.enterDigit(0)" class="keypad-btn">0</button>
                                        <button onclick="LiveScorecardManager.saveCurrentScore()" class="keypad-btn bg-green-100 text-green-700">
                                            <span class="material-symbols-outlined">check</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Right Column: Scramble Tracking (shown only when scramble format active) -->
                                <div id="scrambleTrackingPanel" class="border-l-0 md:border-l-2 md:border-gray-300 md:pl-6" style="display: none;">
                                    <div class="flex items-center gap-2 mb-4">
                                        <span class="material-symbols-outlined text-blue-600">groups</span>
                                        <h3 class="font-bold text-gray-900">Scramble Tracking</h3>
                                    </div>

                                    <!-- Drive Selection with Counters -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                                            <span class="material-symbols-outlined text-sm align-middle">golf_course</span>
                                            Whose drive?
                                        </label>
                                        <div id="scrambleDriveButtons" class="space-y-2">
                                            <!-- Drive buttons with counters will be rendered here -->
                                        </div>
                                    </div>

                                    <!-- Putt Selection -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                                            <span class="material-symbols-outlined text-sm align-middle">flag</span>
                                            Whose putt?
                                        </label>
                                        <div id="scramblePuttButtons" class="space-y-2">
                                            <!-- Putt buttons will be rendered here -->
                                        </div>
                                    </div>

                                    <!-- Summary Display -->
                                    <div id="scrambleSelectionSummary" class="mt-4 p-3 bg-blue-50 rounded-lg text-sm" style="display: none;">
                                        <div class="font-medium text-gray-700 mb-1">Hole <span id="scrambleCurrentHole"></span> Selections:</div>
                                        <div class="text-gray-600">
                                            <span class="material-symbols-outlined text-xs align-middle">golf_course</span>
                                            Drive: <span id="scrambleSelectedDrive" class="font-semibold">-</span>
                                        </div>
                                        <div class="text-gray-600">
                                            <span class="material-symbols-outlined text-xs align-middle">flag</span>
                                            Putt: <span id="scrambleSelectedPutt" class="font-semibold">-</span>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- Hole Navigation -->
                        <div class="flex gap-3">
                            <button onclick="LiveScorecardManager.prevHole()" class="flex-1 btn-secondary py-3">
                                <span class="material-symbols-outlined">arrow_back</span>
                                Previous Hole
                            </button>
                            <button id="nextHoleButton" onclick="LiveScorecardManager.nextHole()" class="flex-1 btn-primary py-3">
                                Next Hole
                                <span class="material-symbols-outlined">arrow_forward</span>
                            </button>
                            <button id="finishRoundButton" onclick="LiveScorecardManager.completeRound()" class="flex-1 bg-gradient-to-r from-green-600 to-green-500 text-white py-3 rounded-lg font-semibold hover:from-green-700 hover:to-green-600 flex items-center justify-center gap-2" style="display: none;">
                                <span class="material-symbols-outlined">flag</span>
                                Finish Round & Post Score
                            </button>
                        </div>

                        <!-- Join Side Games Button -->
                        <button onclick="LiveScorecardManager.showJoinGamesModal()" class="w-full btn-secondary py-3 mb-4 flex items-center justify-center gap-2 bg-gradient-to-r from-green-50 to-green-100 border-2 border-green-400 hover:border-green-500">
                            <span class="material-symbols-outlined text-green-600">public</span>
                            <span class="font-semibold text-green-700">Join Side Games</span>
                            <span id="availablePoolsCount" class="px-2 py-0.5 bg-green-600 text-white text-xs rounded-full" style="display: none;">0</span>
                        </button>

                        <!-- Live Leaderboard -->
                        <div class="metric-card">
                            <div class="border-b border-gray-200 mb-4">
                                <div class="flex gap-2 overflow-x-auto">
                                    <button onclick="LiveScorecardManager.showLeaderboard('group')" id="leaderboardTabGroup" class="px-4 py-2 font-medium text-sm border-b-2 border-green-500 text-green-600 whitespace-nowrap">
                                        My Group
                                    </button>
                                    <button onclick="LiveScorecardManager.showLeaderboard('competition')" id="leaderboardTabCompetition" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-600 hover:text-gray-900 whitespace-nowrap">
                                        <span class="material-symbols-outlined text-xs align-middle">public</span>
                                        Competition
                                    </button>
                                    <button onclick="LiveScorecardManager.showLeaderboard('event')" id="leaderboardTabEvent" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-600 hover:text-gray-900 whitespace-nowrap">
                                        This Event
                                    </button>
                                    <button onclick="LiveScorecardManager.showLeaderboard('other')" id="leaderboardTabOther" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-600 hover:text-gray-900 whitespace-nowrap">
                                        Other Events
                                    </button>
                                </div>
                            </div>

                            <!-- Leaderboard Content -->
                            <div id="leaderboardContent">
                                <p class="text-center py-8 text-gray-500">Leaderboard loading...</p>
                            </div>
                        </div>

                    </div>

                </div>
            </div>

        </main>
    </div>

    <!-- Scorecard Scanner Modal -->
    <div id="scorecardScannerModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-900" data-i18n="modal.scan.title">📸 Scan Scorecard</h2>
                    <button onclick="LiveScorecardManager.closeScorecardScanner()" class="text-gray-500 hover:text-gray-700">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <!-- Course Profile Selector -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="modal.scan.course">
                        📋 Select Course Profile (for better accuracy)
                    </label>
                    <select id="scorecardProfileSelect" class="w-full rounded-lg border px-3 py-2 bg-white">
                        <option value="bangpakong">Bangpakong Riverside Country Club</option>
                        <option value="burapha_east">Burapha Golf Club - East Course</option>
                        <option value="generic" selected data-i18n="modal.scan.generic">Generic (Any Course)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1" data-i18n="modal.scan.help">
                        Select your course for optimized OCR. Choose "Generic" if your course isn't listed.
                    </p>
                </div>

                <!-- Camera View -->
                <div id="cameraView" class="mb-4">
                    <div class="relative bg-gray-100 rounded-lg overflow-hidden" style="aspect-ratio: 4/3;">
                        <video id="scannerVideo" class="w-full h-full object-cover" autoplay playsinline></video>
                        <canvas id="scannerCanvas" class="hidden"></canvas>
                    </div>
                    <div class="flex flex-col gap-2 mt-4">
                        <div class="flex gap-2">
                            <button onclick="LiveScorecardManager.captureScorecard()" class="btn-primary flex-1">
                                <span class="material-symbols-outlined">photo_camera</span>
                                <span data-i18n="modal.scan.capture">Capture Photo</span>
                            </button>
                            <button onclick="LiveScorecardManager.uploadScorecard()" class="btn-secondary">
                                <span class="material-symbols-outlined">upload_file</span>
                                <span data-i18n="modal.scan.upload">Upload Image</span>
                            </button>
                        </div>
                        <button onclick="LiveScorecardManager.manualCourseEntry()" class="btn-secondary w-full border-2 border-gray-400">
                            <span class="material-symbols-outlined">edit</span>
                            Manual Entry (Skip OCR)
                        </button>
                    </div>
                    <input type="file" id="scorecardFileInput" accept="image/*" class="hidden" onchange="LiveScorecardManager.handleFileUpload(event)">
                </div>

                <!-- Processing View -->
                <div id="processingView" class="hidden">
                    <div class="text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mb-4"></div>
                        <p class="text-lg font-medium text-gray-900">Processing scorecard...</p>
                        <p class="text-sm text-gray-600" id="ocrProgress">Analyzing image with OCR...</p>
                    </div>
                </div>

                <!-- Preview Image -->
                <div id="capturedPreview" class="hidden mb-4">
                    <img id="previewImage" class="w-full rounded-lg border-2 border-gray-300">
                    <div class="flex gap-2 mt-2">
                        <button onclick="LiveScorecardManager.processImage()" class="btn-primary flex-1">
                            <span class="material-symbols-outlined">auto_awesome</span>
                            Extract Data
                        </button>
                        <button onclick="LiveScorecardManager.retakePhoto()" class="btn-secondary">
                            <span class="material-symbols-outlined">refresh</span>
                            Retake
                        </button>
                    </div>
                </div>

                <div class="text-xs text-gray-500 mt-4">
                    <p><strong>📌 OCR Tips for best results:</strong></p>
                    <ul class="list-disc ml-5 mt-1">
                        <li>Ensure good lighting - avoid shadows</li>
                        <li>Place scorecard flat on a surface</li>
                        <li>Capture the entire scorecard in the frame</li>
                        <li>Hold camera steady and parallel to scorecard</li>
                    </ul>
                    <p class="mt-3"><strong>⚠️ OCR not working?</strong></p>
                    <p class="mt-1">Click "Manual Entry" button above to skip OCR and enter data directly. It's faster and more reliable!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Player Modal -->
    <div id="addPlayerModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg max-w-3xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-900">👥 Add Player to Group</h2>
                    <button onclick="LiveScorecardManager.closeAddPlayerModal()" class="text-gray-500 hover:text-gray-700">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <!-- Tab Navigation -->
                <div class="flex border-b mb-4">
                    <button id="selectExistingTab" onclick="LiveScorecardManager.switchAddPlayerTab('existing')" class="px-4 py-2 font-medium text-green-600 border-b-2 border-green-600">
                        Select Existing Player
                    </button>
                    <button id="addNewTab" onclick="LiveScorecardManager.switchAddPlayerTab('new')" class="px-4 py-2 font-medium text-gray-500">
                        Add New Player
                    </button>
                </div>

                <!-- Select Existing Player Tab -->
                <div id="existingPlayerTab">
                    <!-- Search Bar -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            🔍 Search Players
                        </label>
                        <input type="text" id="playerSearchInput" oninput="LiveScorecardManager.filterPlayerProfiles()" placeholder="Search by name..." class="w-full rounded-lg border px-3 py-2">
                    </div>

                    <!-- Player List -->
                    <div id="playerProfilesList" class="max-h-96 overflow-y-auto">
                        <div class="text-center py-8 text-gray-500">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mb-2"></div>
                            <p>Loading players...</p>
                        </div>
                    </div>
                </div>

                <!-- Add New Player Tab -->
                <div id="newPlayerTab" class="hidden">
                    <form id="addNewPlayerForm" onsubmit="LiveScorecardManager.submitNewPlayer(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Player Name <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="newPlayerName" required placeholder="Enter player name" class="w-full rounded-lg border px-3 py-2">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Handicap <span class="text-red-500">*</span>
                                </label>
                                <input type="number" id="newPlayerHandicap" step="0.1" value="0" required placeholder="0.0" class="w-full rounded-lg border px-3 py-2">
                                <p class="text-xs text-gray-500 mt-1">Enter handicap index (e.g., 12.5)</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Email (Optional)
                                </label>
                                <input type="email" id="newPlayerEmail" placeholder="player@example.com" class="w-full rounded-lg border px-3 py-2">
                                <p class="text-xs text-gray-500 mt-1">Optional: For sending scorecard after round</p>
                            </div>

                            <div class="flex gap-2 pt-4">
                                <button type="submit" class="btn-primary flex-1">
                                    <span class="material-symbols-outlined">person_add</span>
                                    Add Player
                                </button>
                                <button type="button" onclick="LiveScorecardManager.closeAddPlayerModal()" class="btn-secondary">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scorecard Image Viewer Modal -->
    <div id="scorecardImageModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center p-4" onclick="LiveScorecardManager.closeScorecardImage()">
        <div class="relative max-w-6xl w-full" onclick="event.stopPropagation()">
            <button onclick="LiveScorecardManager.closeScorecardImage()" class="absolute -top-12 right-0 text-white hover:text-gray-300 flex items-center gap-2 bg-black bg-opacity-50 px-4 py-2 rounded-lg">
                <span class="material-symbols-outlined">close</span>
                Close
            </button>
            <div class="bg-white rounded-lg p-4">
                <h3 class="text-xl font-bold text-gray-900 mb-4" id="scorecardImageTitle">Course Scorecard</h3>
                <div class="overflow-auto max-h-[80vh]">
                    <img id="scorecardImage" src="" alt="Course Scorecard" class="w-full h-auto">
                </div>
                <p class="text-xs text-gray-500 mt-4 text-center">Tap outside or click Close to return to round</p>
            </div>
        </div>
    </div>

    <!-- Join Side Games Modal -->
    <div id="joinGamesModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="bg-purple-100 rounded-full p-2">
                            <span class="material-symbols-outlined text-purple-600">public</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">Join Side Games</h3>
                            <p class="text-sm text-gray-500">Compete with other groups on this course</p>
                        </div>
                    </div>
                    <button onclick="LiveScorecardManager.closeJoinGamesModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <!-- Available Pools List -->
                <div id="availablePoolsList">
                    <div class="text-center py-8 text-gray-500">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mb-2"></div>
                        <p>Loading available games...</p>
                    </div>
                </div>

                <!-- My Pools (Joined) -->
                <div id="myPoolsSection" style="display: none;">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 mt-6">My Joined Games</h4>
                    <div id="myPoolsList" class="space-y-2">
                        <!-- Joined pools will be listed here -->
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-gray-200 bg-gray-50 text-xs text-gray-600">
                <strong>How it works:</strong> Join public side games to compete with other groups playing on this course today.
                Leaderboards automatically adjust to show only holes everyone has completed (fairness cutoff).
            </div>
        </div>
    </div>

    <!-- Finalized Scorecard Modal -->
    <div id="finalizedScorecardModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-6xl w-full max-h-screen overflow-y-auto">
            <div class="p-4 md:p-6" id="scorecardPrintArea">
                <!-- Header -->
                <div class="flex justify-between items-start mb-6 print:mb-4">
                    <div class="flex-1">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">⛳ Official Scorecard</h2>
                        <div class="space-y-1 text-sm md:text-base text-gray-700">
                            <div class="flex gap-2"><span class="font-semibold min-w-24">Society:</span><span id="finalScorecard_societyName" class="font-bold text-green-700">-</span></div>
                            <div class="flex gap-2"><span class="font-semibold min-w-24">Event:</span><span id="finalScorecard_eventName">-</span></div>
                            <div class="flex gap-2"><span class="font-semibold min-w-24">Competition:</span><span id="finalScorecard_format">-</span></div>
                            <div class="flex gap-2"><span class="font-semibold min-w-24">Course:</span><span id="finalScorecard_course">-</span></div>
                            <div class="flex gap-2"><span class="font-semibold min-w-24">Tee Marker:</span><span id="finalScorecard_teeMarker">-</span></div>
                            <div class="flex gap-2"><span class="font-semibold min-w-24">Date:</span><span id="finalScorecard_date">-</span></div>
                        </div>
                    </div>
                    <button onclick="LiveScorecardManager.closeFinalizedScorecard()" class="text-gray-500 hover:text-gray-700 print:hidden">
                        <span class="material-symbols-outlined text-3xl">close</span>
                    </button>
                </div>

                <!-- Players Section -->
                <div id="finalScorecard_playersContainer" class="mb-6">
                    <!-- Will be populated with player scorecards -->
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-3 mt-6 print:hidden border-t pt-4">
                    <button onclick="LiveScorecardManager.printScorecard()" class="btn-primary flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">print</span>
                        Print Scorecard
                    </button>
                    <button onclick="LiveScorecardManager.shareScorecard()" class="btn-secondary flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">share</span>
                        Share
                    </button>
                    <button onclick="LiveScorecardManager.downloadScorecardPDF()" class="btn-secondary flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">download</span>
                        Download PDF
                    </button>
                    <button onclick="LiveScorecardManager.showLINEExportModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">send</span>
                        Export to LINE
                    </button>
                    <!-- Delete button (only for private rounds) -->
                    <button id="deleteScorecardBtn" onclick="LiveScorecardManager.deletePrivateRound()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2" style="display: none;">
                        <span class="material-symbols-outlined">delete</span>
                        Delete Round
                    </button>
                    <button onclick="LiveScorecardManager.closeFinalizedScorecard()" class="btn-secondary">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- LINE Export Modal -->
    <div id="lineExportModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                        <span class="material-symbols-outlined text-green-600">send</span>
                        Export Scorecard to LINE
                    </h2>
                    <button onclick="LiveScorecardManager.closeLINEExportModal()" class="text-gray-500 hover:text-gray-700">
                        <span class="material-symbols-outlined text-3xl">close</span>
                    </button>
                </div>

                <!-- Recipient Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Send To</label>
                    <div class="space-y-3">
                        <!-- Manual LINE User ID Input -->
                        <div>
                            <label class="flex items-center gap-2 mb-2">
                                <input type="radio" name="recipientType" value="manual" checked
                                    onchange="document.getElementById('manualRecipientInput').classList.remove('hidden'); document.getElementById('friendsListContainer').classList.add('hidden');">
                                <span class="text-sm">Enter LINE User ID manually</span>
                            </label>
                            <div id="manualRecipientInput" class="ml-6">
                                <input type="text" id="lineUserIdInput"
                                    placeholder="e.g., U1234567890abcdef1234567890abcdef"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">Enter the recipient's LINE User ID</p>
                            </div>
                        </div>

                        <!-- Friends List Selection (if available via LIFF) -->
                        <div>
                            <label class="flex items-center gap-2 mb-2">
                                <input type="radio" name="recipientType" value="friends"
                                    onchange="document.getElementById('manualRecipientInput').classList.add('hidden'); document.getElementById('friendsListContainer').classList.remove('hidden');">
                                <span class="text-sm">Select from LINE friends (LIFF only)</span>
                            </label>
                            <div id="friendsListContainer" class="ml-6 hidden">
                                <select id="lineFriendsSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <option value="">Loading friends...</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">This feature requires LIFF permission to access friends list</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Message Preview -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Message Preview</label>
                    <div class="bg-gray-50 border border-gray-300 rounded-lg p-4 max-h-64 overflow-y-auto">
                        <pre id="lineMessagePreview" class="text-xs font-mono whitespace-pre-wrap">Loading preview...</pre>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Export Options</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="includeAllPlayers" checked class="rounded"
                                onchange="LiveScorecardManager.updateLINEMessagePreview()">
                            <span class="text-sm">Include all players in group</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="includeDetailedStats" checked class="rounded"
                                onchange="LiveScorecardManager.updateLINEMessagePreview()">
                            <span class="text-sm">Include detailed statistics</span>
                        </label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button onclick="LiveScorecardManager.sendScorecardToLINE()"
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg flex items-center justify-center gap-2 font-semibold">
                        <span class="material-symbols-outlined">send</span>
                        Send to LINE
                    </button>
                    <button onclick="LiveScorecardManager.closeLINEExportModal()"
                        class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                </div>

                <!-- Status Message -->
                <div id="lineExportStatus" class="mt-4 hidden">
                    <div class="p-3 rounded-lg" id="lineExportStatusContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Course Data Review Modal -->
    <div id="courseReviewModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-900">✅ Review Extracted Data</h2>
                    <button onclick="LiveScorecardManager.closeCourseReview()" class="text-gray-500 hover:text-gray-700">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <p class="text-sm text-gray-600 mb-4">Please review and edit the extracted data before saving:</p>

                <!-- Course Info -->
                <div class="mb-4 grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Course Name</label>
                        <input type="text" id="reviewCourseName" class="w-full rounded-lg border px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tee Marker</label>
                        <select id="reviewTeeMarker" class="w-full rounded-lg border px-3 py-2">
                            <option value="red">Red</option>
                            <option value="white">White</option>
                            <option value="blue">Blue</option>
                            <option value="black">Black</option>
                        </select>
                    </div>
                </div>

                <!-- Holes Table -->
                <div class="border rounded-lg overflow-hidden mb-4">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">Hole</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">Par</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">Stroke Index</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">Yardage</th>
                            </tr>
                        </thead>
                        <tbody id="reviewHolesTable">
                            <!-- Rows will be populated here -->
                        </tbody>
                    </table>
                </div>

                <div class="flex gap-2">
                    <button onclick="LiveScorecardManager.saveCourseData()" class="btn-primary flex-1">
                        <span class="material-symbols-outlined">save</span>
                        Save Course Data
                    </button>
                    <button onclick="LiveScorecardManager.closeCourseReview()" class="btn-secondary">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Course Library Modal -->
    <div id="courseLibraryModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-900">📚 Course Library</h2>
                    <button onclick="LiveScorecardManager.closeCourseLibrary()" class="text-gray-500 hover:text-gray-700">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <p class="text-sm text-gray-600 mb-6">Manage your pre-scanned courses for instant loading during play</p>

                <!-- Add New Course Button -->
                <button onclick="LiveScorecardManager.openScorecardScanner()" class="btn-primary w-full mb-6">
                    <span class="material-symbols-outlined">add</span>
                    Scan New Course
                </button>

                <!-- Saved Courses List -->
                <div id="savedCoursesList" class="space-y-3">
                    <p class="text-center py-8 text-gray-500">Loading courses...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Round Details Modal -->
    <div id="roundDetailsModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">⛳ Round Details</h2>
                    <button onclick="GolfScoreSystem.closeRoundDetails()" class="text-gray-500 hover:text-gray-700">
                        <span class="material-symbols-outlined text-3xl">close</span>
                    </button>
                </div>

                <!-- Round Summary -->
                <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Course</p>
                            <p id="roundDetail_course" class="font-bold text-gray-900">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Date</p>
                            <p id="roundDetail_date" class="font-bold text-gray-900">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Tee Marker</p>
                            <p id="roundDetail_tee" class="font-bold text-gray-900">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Gross Score</p>
                            <p id="roundDetail_gross" class="text-2xl font-bold text-primary-600">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Stableford</p>
                            <p id="roundDetail_stableford" class="text-2xl font-bold text-green-600">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Handicap Used</p>
                            <p id="roundDetail_handicap" class="text-2xl font-bold text-blue-600">-</p>
                        </div>
                    </div>
                </div>

                <!-- Hole-by-Hole Scores -->
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Hole-by-Hole Breakdown</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-2 px-3 text-left font-semibold text-gray-700">Hole</th>
                                    <th class="py-2 px-3 text-center font-semibold text-gray-700">Par</th>
                                    <th class="py-2 px-3 text-center font-semibold text-gray-700">SI</th>
                                    <th class="py-2 px-3 text-center font-semibold text-gray-700">Gross</th>
                                    <th class="py-2 px-3 text-center font-semibold text-gray-700">Net</th>
                                    <th class="py-2 px-3 text-center font-semibold text-gray-700">Points</th>
                                </tr>
                            </thead>
                            <tbody id="roundDetail_holesTable" class="divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-gray-500">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Scramble Details (if applicable) -->
                <div id="roundDetail_scrambleSection" class="mb-6 hidden">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Scramble Format Details</h3>
                    <div class="bg-blue-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-3">Drive & Putt Players per Hole:</p>
                        <div id="roundDetail_scrambleData" class="space-y-2 text-sm">
                            <!-- Will be populated with scramble data -->
                        </div>
                    </div>
                </div>

                <!-- Close Button -->
                <div class="flex justify-end pt-4 border-t">
                    <button onclick="GolfScoreSystem.closeRoundDetails()" class="btn-secondary">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Caddy Dashboard -->
    <div id="caddieDashboard" class="screen">
        <header class="nav-header">
            <div class="max-w-7xl mx-auto px-4 lg:px-8">
                <div class="flex justify-between items-center py-3 md:py-5">
                    <div class="flex items-center space-x-2 md:space-x-4">
                        <img class="user-avatar" style="display: none;">
                        <div>
                            <h1 class="text-base md:text-xl font-bold text-gray-900">Welcome back, <span class="user-name-display">Caddy</span> <span class="user-caddy-number">#</span></h1>
                            <p class="text-xs md:text-sm text-gray-600">@<span class="user-username-display">username</span></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 md:space-x-4">
                        <button onclick="sendEmergencyAlert()" class="emergency-btn p-2 md:p-3" title="Emergency Alert">
                            <span class="material-symbols-outlined text-sm md:text-base">emergency</span>
                        </button>
                        <button onclick="window.openProfessionalChat()" class="btn-primary relative px-2 py-2 md:px-4 md:py-2" style="background: #10b981;" title="Chat">
                            <span class="material-symbols-outlined text-sm">chat</span>
                            <span class="hidden md:inline ml-1" data-i18n="golfer.chat">Chat</span>
                            <span id="chatBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-4 w-4 md:h-5 md:w-5 flex items-center justify-center font-medium" style="display: none;">0</span>
                        </button>
                        <button onclick="logout()" class="btn-logout px-2 py-2 md:px-3 md:py-2">
                            <span class="material-symbols-outlined text-sm">logout</span>
                            <span class="hidden md:inline ml-1" data-i18n="nav.logout">Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Enhanced Caddy Dashboard Navigation -->
        <nav class="tab-navigation border-b">
            <div class="max-w-7xl mx-auto px-4 lg:px-8">
                <div class="flex space-x-2 md:space-x-8 overflow-x-auto">
                    <button onclick="showCaddyTab('overview', event)" class="tab-button active text-xs md:text-sm px-2 md:px-4">
                        <span class="material-symbols-outlined text-sm">dashboard</span>
                        <span class="hidden sm:inline" data-i18n="caddie.overview">Overview</span>
                    </button>
                    <button onclick="showCaddyTab('assignments', event)" class="tab-button text-xs md:text-sm px-2 md:px-4">
                        <span class="material-symbols-outlined text-sm">assignment</span>
                        <span class="hidden sm:inline" data-i18n="caddie.assignments">My Assignments</span>
                    </button>
                    <button onclick="showCaddyTab('tracking', event)" class="tab-button text-xs md:text-sm px-2 md:px-4">
                        <span class="material-symbols-outlined text-sm">location_on</span>
                        <span class="hidden sm:inline" data-i18n="caddie.tracking">Live Tracking</span>
                    </button>
                    <button onclick="showCaddyTab('earnings', event)" class="tab-button text-xs md:text-sm px-2 md:px-4">
                        <span class="material-symbols-outlined text-sm">payments</span>
                        <span class="hidden sm:inline" data-i18n="caddie.earnings">Earnings</span>
                    </button>
                    <button onclick="showCaddyTab('profile', event)" class="tab-button text-xs md:text-sm px-2 md:px-4">
                        <span class="material-symbols-outlined text-sm">person</span>
                        <span class="hidden sm:inline" data-i18n="golfer.profile">Profile</span>
                    </button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 lg:px-8 py-4 md:py-8">
            <!-- Overview Tab -->
            <div id="caddie-overview" class="tab-content active">

                <!-- Persistent Emergency Alerts -->
                <div id="caddie-emergency-alerts" class="persistent-emergency-alerts mb-4" style="display: none;">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <span class="material-symbols-outlined text-red-600">emergency</span>
                                <h3 class="text-lg font-bold text-red-800">Active Emergency Alerts</h3>
                            </div>
                            <span id="caddie-alert-count" class="bg-red-600 text-white text-xs px-2 py-1 rounded-full font-medium">0</span>
                        </div>
                        <div id="caddie-alert-list" class="space-y-2">
                            <!-- Emergency alerts will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Current Status & Waitlist Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6">
                    <!-- Current Status -->
                    <div class="metric-card">
                        <h3 class="text-lg font-bold text-gray-900 mb-4" data-i18n="caddie.currentstatus">Current Status</h3>
                        <div class="flex items-center space-x-3 mb-4">
                            <span class="status-badge bg-green-100 text-green-800" data-i18n="caddie.available">Available</span>
                            <p class="text-sm text-gray-600" data-i18n="caddie.readyforbookings">Ready for bookings</p>
                        </div>
                        <div class="p-3 md:p-4 bg-gray-50 rounded-lg text-center">
                            <span class="material-symbols-outlined text-4xl text-gray-300 mb-2">event_available</span>
                            <p class="text-sm text-gray-500" data-i18n="caddie.nocurrentbookings">No current bookings</p>
                            <p class="text-xs text-gray-400 mt-1" data-i18n="caddie.checkschedule">Check schedule for upcoming assignments</p>
                        </div>
                    </div>

                    <!-- Waitlist -->
                    <div class="metric-card">
                        <h3 class="text-lg font-bold text-gray-900 mb-4"><span data-i18n="caddie.waitlist">Waitlist</span> (0 <span data-i18n="caddie.people">people</span>)</h3>
                        <div class="text-center py-8">
                            <span class="material-symbols-outlined text-4xl text-gray-300 mb-2">people_outline</span>
                            <p class="text-sm text-gray-500" data-i18n="caddie.nogolfers">No golfers on waitlist</p>
                            <p class="text-xs text-gray-400 mt-1" data-i18n="caddie.newrequests">New requests will appear here</p>
                        </div>
                    </div>
                </div>

                <!-- Live Tracking Section -->
                <div class="mb-8">
                    <div class="metric-card">
                        <div class="text-center">
                            <h3 class="text-xl font-bold text-gray-900 mb-4" data-i18n="caddie.liveroundtracking">Live Round Tracking</h3>

                            <!-- Tracking Not Started State -->
                            <div id="trackingNotStarted" class="space-y-4">
                                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <span class="material-symbols-outlined text-4xl text-green-600">play_circle</span>
                                </div>
                                <p class="text-gray-600 mb-6" data-i18n="caddie.starttracking">Start tracking when you reach the first hole with your golfer</p>
                                <button onclick="startLiveTracking()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-xl font-bold text-lg transition-colors">
                                    🏌️ <span data-i18n="caddie.startroundtracking">Start Round Tracking</span>
                                </button>
                            </div>

                            <!-- Tracking Active State -->
                            <div id="trackingActive" class="space-y-4" style="display: none;">
                                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                                    <span class="material-symbols-outlined text-4xl text-blue-600">radio_button_checked</span>
                                </div>
                                <div class="bg-blue-50 p-6 rounded-lg mb-6">
                                    <h4 class="font-bold text-blue-900 mb-3" data-i18n="caddie.roundinprogress">Round in Progress</h4>
                                    <div class="grid grid-cols-3 gap-4 text-center">
                                        <div>
                                            <div class="text-2xl font-bold text-blue-600" id="currentHoleTracking">1</div>
                                            <div class="text-sm text-blue-800" data-i18n="caddie.currenthole">Current Hole</div>
                                        </div>
                                        <div>
                                            <div class="text-2xl font-bold text-blue-600" id="roundTimeTracking">0:00</div>
                                            <div class="text-sm text-blue-800" data-i18n="caddie.roundtime">Round Time</div>
                                        </div>
                                        <div>
                                            <div class="text-2xl font-bold text-blue-600" id="locationStatus">📍 Live</div>
                                            <div class="text-sm text-blue-800" data-i18n="caddie.gpsstatus">GPS Status</div>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="finishLiveTracking()" class="bg-red-600 hover:bg-red-700 text-white px-8 py-4 rounded-xl font-bold text-lg transition-colors">
                                    🏁 <span data-i18n="caddie.finishround">Finish Round</span>
                                </button>

                                <!-- Quick Actions for Mobile -->
                                <div class="mt-6 grid grid-cols-2 gap-3 md:hidden">
                                    <button onclick="showCaddyTab('tracking', event)" class="btn-secondary text-sm">
                                        <span class="material-symbols-outlined text-sm">location_on</span>
                                        GPS Details
                                    </button>
                                    <button onclick="updateCurrentHole()" class="btn-secondary text-sm">
                                        <span class="material-symbols-outlined text-sm">golf_course</span>
                                        Next Hole
                                    </button>
                                </div>
                            </div>

                            <!-- Tracking Completed State -->
                            <div id="trackingCompleted" class="space-y-4" style="display: none;">
                                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <span class="material-symbols-outlined text-4xl text-green-600">check_circle</span>
                                </div>
                                <div class="bg-green-50 p-6 rounded-lg mb-6">
                                    <h4 class="font-bold text-green-900 mb-3" data-i18n="caddie.roundcompleted">Round Completed!</h4>
                                    <div class="grid grid-cols-2 gap-4 text-center">
                                        <div>
                                            <div class="text-xl font-bold text-green-600" id="finalRoundTime">3:45</div>
                                            <div class="text-sm text-green-800" data-i18n="caddie.totaltime">Total Time</div>
                                        </div>
                                        <div>
                                            <div class="text-xl font-bold text-green-600">18</div>
                                            <div class="text-sm text-green-800" data-i18n="caddie.holescompleted">Holes Completed</div>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="resetTracking()" class="bg-primary-600 hover:bg-primary-700 text-white px-6 py-3 rounded-xl font-semibold transition-colors">
                                    <span data-i18n="caddie.startnewround">Start New Round</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Status Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="metric-card text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="material-symbols-outlined text-2xl text-green-600">assignment_turned_in</span>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-2" data-i18n="caddie.todaysassignment">Today's Assignment</h3>
                        <p class="text-sm text-gray-600">John Mitchell</p>
                        <div class="mt-2 text-xs bg-green-50 text-green-700 px-3 py-1 rounded-full inline-block">
                            Hole 7 • 9:30 AM
                        </div>
                    </div>

                    <div class="metric-card text-center">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="material-symbols-outlined text-2xl text-blue-600">location_on</span>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-2" data-i18n="caddie.currentlocation">Current Location</h3>
                        <p class="text-sm text-gray-600">Championship Course</p>
                        <div class="mt-2 text-xs bg-blue-50 text-blue-700 px-3 py-1 rounded-full inline-block">
                            <span data-i18n="caddie.livetrackingactive">Live Tracking Active</span>
                        </div>
                    </div>

                    <div class="metric-card text-center">
                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="material-symbols-outlined text-2xl text-purple-600">schedule</span>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-2" data-i18n="caddie.nextassignment">Next Assignment</h3>
                        <p class="text-sm text-gray-600">2:00 PM Today</p>
                        <div class="mt-2 text-xs bg-purple-50 text-purple-700 px-3 py-1 rounded-full inline-block">
                            Executive Course
                        </div>
                    </div>

                    <div class="metric-card text-center">
                        <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="material-symbols-outlined text-2xl text-orange-600">payments</span>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-2" data-i18n="caddie.todaysearnings">Today's Earnings</h3>
                        <p class="text-sm text-gray-600">₿1,200</p>
                        <div class="mt-2 text-xs bg-orange-50 text-orange-700 px-3 py-1 rounded-full inline-block">
                            2 <span data-i18n="caddie.roundscompleted">Rounds Completed</span>
                        </div>
                    </div>
                </div>

                <!-- Current Status -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="metric-card">
                        <h3 class="text-xl font-bold text-gray-900 mb-6" data-i18n="caddie.currentroundstatus">Current Round Status</h3>
                        <div class="text-center py-12">
                            <span class="material-symbols-outlined text-6xl text-gray-300 mb-4 block">golf_course</span>
                            <p class="text-gray-500 text-lg" data-i18n="caddie.noactiveround">No active round</p>
                            <p class="text-gray-400 text-sm mt-2" data-i18n="caddie.starttrackingbegin">Start tracking when you begin a round</p>
                        </div>
                    </div>

                    <div class="metric-card">
                        <h3 class="text-xl font-bold text-gray-900 mb-6" data-i18n="caddie.performancemetrics">Performance Metrics</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                <span class="font-medium" data-i18n="caddie.averageroundtime">Average Round Time</span>
                                <span class="font-bold text-gray-400">-</span>
                            </div>
                            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                <span class="font-medium" data-i18n="caddie.clientsatisfaction">Client Satisfaction</span>
                                <span class="font-bold text-gray-400">-</span>
                            </div>
                            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                <span class="font-medium" data-i18n="caddie.roundsthisweek">Rounds This Week</span>
                                <span class="font-bold text-gray-400">0</span>
                            </div>
                            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                <span class="font-medium" data-i18n="caddie.weeklyearnings">Weekly Earnings</span>
                                <span class="font-bold text-gray-400">฿0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assignments Tab -->
            <div id="caddie-assignments" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        <div class="metric-card">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-bold text-gray-900" data-i18n="caddie.todaysassignments">Today's Assignments</h3>
                                <button onclick="refreshAssignments()" class="btn-secondary">
                                    <span class="material-symbols-outlined text-sm">refresh</span>
                                    <span data-i18n="common.refresh">Refresh</span>
                                </button>
                            </div>

                            <div class="space-y-4" id="assignmentsList">
                                <div class="text-center py-12">
                                    <span class="material-symbols-outlined text-6xl text-gray-300 mb-4 block">assignment</span>
                                    <p class="text-gray-500 text-lg" data-i18n="caddie.noassignmentsyet">No assignments yet</p>
                                    <p class="text-gray-400 text-sm mt-2" data-i18n="caddie.newbookingrequests">New booking requests will appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-1">
                        <div class="space-y-6">
                            <div class="metric-card">
                                <h4 class="font-bold text-gray-900 mb-4" data-i18n="caddie.assignmentsummary">Assignment Summary</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600" data-i18n="caddie.todaytotal">Today Total</span>
                                        <span class="font-bold">0 Rounds</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600" data-i18n="common.completed">Completed</span>
                                        <span class="font-bold text-green-600">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600" data-i18n="common.inprogress">In Progress</span>
                                        <span class="font-bold text-blue-600">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600" data-i18n="caddie.scheduled">Scheduled</span>
                                        <span class="font-bold text-orange-600">0</span>
                                    </div>
                                    <div class="border-t pt-3">
                                        <div class="flex justify-between">
                                            <span class="font-bold" data-i18n="caddie.projectedearnings">Projected Earnings</span>
                                            <span class="font-bold text-primary-600">฿0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="metric-card">
                                <h4 class="font-bold text-gray-900 mb-4" data-i18n="caddie.weekahead">Week Ahead</h4>
                                <div class="text-center py-8">
                                    <span class="material-symbols-outlined text-4xl text-gray-300 mb-2 block">calendar_today</span>
                                    <p class="text-sm text-gray-500" data-i18n="caddie.noupcomingassignments">No upcoming assignments</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tracking Tab -->
            <div id="caddie-tracking" class="tab-content">
                <div class="metric-card">
                    <h3 class="text-xl font-bold text-gray-900 mb-6" data-i18n="caddie.livecoursetracking">Live Course Tracking</h3>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <div class="bg-green-100 rounded-lg p-6" style="height: 400px; position: relative;">
                                <div class="absolute top-4 left-4 bg-white px-3 py-1 rounded-lg shadow">
                                    <span class="text-sm font-bold" data-i18n="caddie.livetrackingactive">Live Tracking Active</span>
                                </div>
                                <div class="flex items-center justify-center h-full">
                                    <div class="text-center">
                                        <span class="material-symbols-outlined text-6xl text-green-600 mb-4 block">golf_course</span>
                                        <p class="text-gray-600" data-i18n="caddie.interactivecourse">Interactive course map with real-time position</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="bg-gray-50 p-6 rounded-lg">
                                <h4 class="font-bold text-gray-900 mb-4">Current Position</h4>
                                <div class="text-center py-8">
                                    <span class="material-symbols-outlined text-5xl text-gray-300 mb-2 block">location_off</span>
                                    <p class="text-gray-500 text-sm">No active tracking</p>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-6 rounded-lg">
                                <h4 class="font-bold text-gray-900 mb-4">Round Progress</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Score</span>
                                        <span class="font-bold text-gray-400">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Fairways Hit</span>
                                        <span class="font-bold text-gray-400">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">GIR</span>
                                        <span class="font-bold text-gray-400">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Putts</span>
                                        <span class="font-bold text-gray-400">-</span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex space-x-3">
                                <button onclick="startLiveTracking()" class="btn-primary flex-1">
                                    <span class="material-symbols-outlined text-sm">play_arrow</span>
                                    Start Tracking
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->

            <!-- Earnings Tab -->
            <div id="caddie-earnings" class="tab-content">
                <!-- Add New Earnings Section -->
                <div class="metric-card mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg md:text-xl font-bold text-gray-900">Add New Earnings</h3>
                        <button onclick="toggleEarningsForm()" class="btn-primary text-sm">
                            <span class="material-symbols-outlined text-sm">add</span>
                            <span class="hidden md:inline ml-1">Add Earnings</span>
                        </button>
                    </div>

                    <div id="earningsForm" class="hidden bg-gray-50 rounded-lg p-4">
                        <form onsubmit="submitEarnings(event)" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">Client Name</label>
                                    <input type="text" id="clientName" class="form-input" placeholder="Enter client name" required>
                                </div>
                                <div>
                                    <label class="form-label">Service Type</label>
                                    <select id="serviceType" class="form-input" required>
                                        <option value="">Select service</option>
                                        <option value="round">Full Round</option>
                                        <option value="lesson">Private Lesson</option>
                                        <option value="half">Half Round</option>
                                        <option value="group">Group Session</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Base Fee (฿)</label>
                                    <input type="number" id="baseFee" class="form-input" placeholder="800" required min="0">
                                </div>
                                <div>
                                    <label class="form-label">Tip Amount (฿)</label>
                                    <input type="number" id="tipAmount" class="form-input" placeholder="200" min="0">
                                </div>
                                <div>
                                    <label class="form-label">Date</label>
                                    <input type="date" id="earningsDate" class="form-input" required>
                                </div>
                                <div>
                                    <label class="form-label">Time</label>
                                    <input type="time" id="earningsTime" class="form-input" required>
                                </div>
                            </div>
                            <div>
                                <label class="form-label">Notes (Optional)</label>
                                <textarea id="earningsNotes" class="form-input" rows="2" placeholder="Additional notes about the service"></textarea>
                            </div>
                            <div class="flex space-x-3">
                                <button type="submit" class="btn-primary flex-1">
                                    <span class="material-symbols-outlined text-sm">save</span>
                                    Save Earnings
                                </button>
                                <button type="button" onclick="toggleEarningsForm()" class="btn-secondary">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        <div class="metric-card">
                            <h3 class="text-xl font-bold text-gray-900 mb-6">Earnings History</h3>

                            <div class="space-y-4">
                                <div class="text-center py-12">
                                    <span class="material-symbols-outlined text-6xl text-gray-300 mb-4 block">payments</span>
                                    <p class="text-gray-500 text-lg">No earnings recorded yet</p>
                                    <p class="text-gray-400 text-sm mt-2">Track your earnings by clicking "Record Earnings" above</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-1">
                        <div class="space-y-6">
                            <div class="metric-card">
                                <h4 class="font-bold text-gray-900 mb-4">Earnings Summary</h4>
                                <div class="space-y-4">
                                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                                        <div class="text-2xl font-bold text-gray-600">฿0</div>
                                        <div class="text-sm text-gray-600">Today</div>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">This Week</span>
                                        <span class="font-bold">฿0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">This Month</span>
                                        <span class="font-bold">฿0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Average/Round</span>
                                        <span class="font-bold text-primary-600">฿0</span>
                                    </div>
                                </div>
                            </div>

                            <div class="metric-card">
                                <h4 class="font-bold text-gray-900 mb-4">Performance Bonus</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Rating Bonus</span>
                                        <span class="font-bold text-gray-400">฿0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Punctuality</span>
                                        <span class="font-bold text-gray-400">฿0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Elite Status</span>
                                        <span class="font-bold text-gray-400">฿0</span>
                                    </div>
                                    <div class="border-t pt-3">
                                        <div class="flex justify-between">
                                            <span class="font-bold">Total Bonus</span>
                                            <span class="font-bold text-primary-600">฿0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="caddie-profile" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">My Profile</h3>
                        <button class="btn-sm btn-primary">
                            <span class="material-symbols-outlined text-sm">edit</span>
                            Edit Profile
                        </button>
                    </div>
                    <div class="space-y-6">
                        <!-- Basic Information -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-input user-full-name" value="" placeholder="Your full name">
                            </div>
                            <div>
                                <label class="form-label">Caddy Number</label>
                                <input type="text" class="form-input user-caddy-id" value="" placeholder="e.g. 015" maxlength="3" pattern="[0-9]{3}">
                                <p class="text-xs text-gray-500 mt-1">3-digit caddy number (001-999)</p>
                            </div>
                            <div>
                                <label class="form-label">Home Club</label>
                                <input type="text" class="form-input user-home-club-display" value="" readonly>
                            </div>
                            <div>
                                <label class="form-label">Society Affiliation</label>
                                <input type="text" class="form-input user-society-name-display" value="" readonly>
                            </div>
                            <div>
                                <label class="form-label">Specialty</label>
                                <select class="form-input user-specialty">
                                    <option value="">Select specialty...</option>
                                    <option value="course-management">Golf Course Management</option>
                                    <option value="friendly">Friendliness</option>
                                    <option value="yardages">Giving Yardages</option>
                                    <option value="club-selection">Club Selection</option>
                                    <option value="green-reading">Reading Greens</option>
                                    <option value="fun">Being Fun</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="form-label">Languages (select all that apply)</label>
                                <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mt-2">
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="checkbox" class="user-lang-english rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                        <span class="text-sm text-gray-700">English</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="checkbox" class="user-lang-thai rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                        <span class="text-sm text-gray-700">Thai</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="checkbox" class="user-lang-korean rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                        <span class="text-sm text-gray-700">Korean</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="checkbox" class="user-lang-japanese rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                        <span class="text-sm text-gray-700">Japanese</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="checkbox" class="user-lang-chinese rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                        <span class="text-sm text-gray-700">Chinese</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="form-label">Years of Experience</label>
                                <select class="form-input user-experience">
                                    <option value="">Select years...</option>
                                    <option value="1">1 year</option>
                                    <option value="2">2 years</option>
                                    <option value="3">3 years</option>
                                    <option value="4">4 years</option>
                                    <option value="5">5 years</option>
                                    <option value="6">6 years</option>
                                    <option value="7">7 years</option>
                                    <option value="8">8 years</option>
                                    <option value="9">9 years</option>
                                    <option value="10">10 years</option>
                                    <option value="11">11 years</option>
                                    <option value="12">12 years</option>
                                    <option value="13">13 years</option>
                                    <option value="14">14 years</option>
                                    <option value="15">15 years</option>
                                    <option value="16">16 years</option>
                                    <option value="17">17 years</option>
                                    <option value="18">18 years</option>
                                    <option value="19">19 years</option>
                                    <option value="20">20 years</option>
                                    <option value="21">21 years</option>
                                    <option value="22">22 years</option>
                                    <option value="23">23 years</option>
                                    <option value="24">24 years</option>
                                    <option value="25">25 years</option>
                                    <option value="26">26 years</option>
                                    <option value="27">27 years</option>
                                    <option value="28">28 years</option>
                                    <option value="29">29 years</option>
                                    <option value="30">30 years</option>
                                </select>
                            </div>
                        </div>

                        <!-- Performance Stats -->
                        <div>
                            <h4 class="font-medium text-gray-900 mb-4">Performance Statistics</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="metric-card text-center">
                                    <div class="metric-value">0.0</div>
                                    <div class="metric-label">Current Rating</div>
                                </div>
                                <div class="metric-card text-center">
                                    <div class="metric-value">0</div>
                                    <div class="metric-label">Total Rounds</div>
                                </div>
                                <div class="metric-card text-center">
                                    <div class="metric-value">₿0</div>
                                    <div class="metric-label">Total Earnings</div>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div>
                            <h4 class="font-medium text-gray-900 mb-4">Contact Information <span class="text-xs text-gray-500">(Optional)</span></h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">Phone Number <span class="text-xs text-gray-500">(Optional)</span></label>
                                    <input type="tel" class="form-input user-phone" value="" placeholder="+66 89 123 4567">
                                </div>
                                <div>
                                    <label class="form-label">Emergency Contact <span class="text-xs text-gray-500">(Optional)</span></label>
                                    <input type="tel" class="form-input user-emergency-contact" value="" placeholder="+66 81 987 6543">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Manager Dashboard -->
    <div id="managerDashboard" class="screen">
        <header class="nav-header">
            <div class="max-w-7xl mx-auto px-4 lg:px-8">
                <div class="flex justify-between items-center py-3 md:py-5">
                    <div class="flex items-center space-x-2 md:space-x-4">
                        <img class="user-avatar" style="display: none;">
                        <div>
                            <h1 class="text-base md:text-xl font-bold text-gray-900"><span data-i18n="manager.welcome">Welcome back, Manager!</span> <span class="user-name-display"></span></h1>
                            <p class="text-xs md:text-sm text-gray-600">@<span class="user-username-display">username</span></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="sendEmergencyAlert()" class="emergency-btn" title="Emergency Broadcast">
                            <span class="material-symbols-outlined">emergency</span>
                        </button>
                        <button onclick="window.openProfessionalChat()" class="btn-primary relative" style="background: #10b981; padding: 10px 16px;" title="Chat">
                            <span class="material-symbols-outlined text-sm">chat</span>
                            <span data-i18n="common.chat">Chat</span>
                            <span id="chatBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-medium" style="display: none;">0</span>
                        </button>
                        <button onclick="logout()" class="btn-logout">
                            <span class="material-symbols-outlined text-sm">logout</span>
                            <span data-i18n="common.logout">Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Enhanced Manager Dashboard Navigation -->
        <nav class="tab-navigation border-b">
            <div class="max-w-7xl mx-auto px-2 lg:px-4">
                <div class="flex flex-wrap gap-1">
                    <button onclick="showManagerTab('overview', event)" onmouseenter="SimpleCloudSync.prefetchData()" class="tab-button active" id="manager-overview-tab">
                        <span class="material-symbols-outlined">dashboard</span>
                        <span class="hidden sm:inline" data-i18n="manager.overview">Overview</span>
                    </button>
                    <button onclick="showManagerTab('traffic', event)" onmouseenter="SimpleCloudSync.prefetchData()" class="tab-button" id="manager-traffic-tab">
                        <span class="material-symbols-outlined">map</span>
                        <span class="hidden sm:inline" data-i18n="manager.traffic">Traffic</span>
                    </button>
                    <button onclick="showManagerTab('staff', event)" onmouseenter="SimpleCloudSync.prefetchData()" class="tab-button" id="manager-staff-tab">
                        <span class="material-symbols-outlined">groups</span>
                        <span class="hidden sm:inline" data-i18n="manager.staff">Staff</span>
                    </button>
                    <button onclick="showManagerTab('analytics', event)" onmouseenter="SimpleCloudSync.prefetchData()" class="tab-button" id="manager-analytics-tab">
                        <span class="material-symbols-outlined">analytics</span>
                        <span class="hidden sm:inline" data-i18n="manager.analytics">Analytics</span>
                    </button>
                    <button onclick="showManagerTab('reports', event)" onmouseenter="SimpleCloudSync.prefetchData()" class="tab-button" id="manager-reports-tab">
                        <span class="material-symbols-outlined">description</span>
                        <span class="hidden sm:inline" data-i18n="manager.reports">Reports</span>
                    </button>
                    <button onclick="showManagerTab('settings', event)" onmouseenter="SimpleCloudSync.prefetchData()" class="tab-button" id="manager-settings-tab">
                        <span class="material-symbols-outlined">settings</span>
                        <span class="hidden sm:inline" data-i18n="common.settings">Settings</span>
                    </button>
                    <button onclick="showManagerTab('maintenance', event)" onmouseenter="WeatherIntegration.fetchWeatherData?.()" class="tab-button" id="manager-maintenance-tab">
                        <span class="material-symbols-outlined">build</span>
                        <span class="hidden sm:inline" data-i18n="manager.maintenance">Maint</span>
                    </button>
                    <button onclick="showManagerTab('weather', event)" onmouseenter="WeatherIntegration.fetchWeatherData?.()" class="tab-button" id="manager-weather-tab">
                        <span class="material-symbols-outlined">wb_cloudy</span>
                        <span class="hidden sm:inline" data-i18n="manager.weather">Weather</span>
                    </button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-6 lg:px-8 py-8">
            <!-- Manager Overview Tab -->
            <div id="manager-overview" class="tab-content active">

                <!-- Persistent Emergency Alerts -->
                <div id="manager-emergency-alerts" class="persistent-emergency-alerts mb-6" style="display: none;">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <span class="material-symbols-outlined text-red-600">emergency</span>
                                <h3 class="text-lg font-bold text-red-800">Active Emergency Alerts</h3>
                            </div>
                            <span id="manager-alert-count" class="bg-red-600 text-white text-xs px-2 py-1 rounded-full font-medium">0</span>
                        </div>
                        <div id="manager-alert-list" class="space-y-2">
                            <!-- Emergency alerts will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Quick Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600" data-i18n="manager.todays.rounds">Today's Rounds</p>
                                <p class="text-2xl font-bold text-gray-400">0</p>
                                <p class="text-xs text-gray-400" data-i18n="manager.nodata">No data yet</p>
                            </div>
                            <div class="stat-icon bg-blue-100">
                                <span class="material-symbols-outlined text-blue-600">golf_course</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600" data-i18n="manager.active.caddies">Active Caddys</p>
                                <p class="text-2xl font-bold text-gray-400">0</p>
                                <p class="text-xs text-gray-400" data-i18n="manager.noassignments">No assignments</p>
                            </div>
                            <div class="stat-icon bg-green-100">
                                <span class="material-symbols-outlined text-green-600">person_check</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600" data-i18n="manager.course.occupancy">Course Occupancy</p>
                                <p class="text-2xl font-bold text-gray-400">0%</p>
                                <p class="text-xs text-gray-400" data-i18n="manager.nobookings">No bookings</p>
                            </div>
                            <div class="stat-icon bg-orange-100">
                                <span class="material-symbols-outlined text-orange-600">bar_chart</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600" data-i18n="manager.emergency.alerts">Emergency Alerts</p>
                                <p class="text-2xl font-bold text-gray-900">0</p>
                                <p class="text-xs text-gray-500" data-i18n="manager.allclear">All clear</p>
                            </div>
                            <div class="stat-icon bg-red-100">
                                <span class="material-symbols-outlined text-red-600">emergency</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Operations Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Current Rounds -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title" data-i18n="manager.current.rounds">Current Rounds</h3>
                            <span class="badge badge-secondary">0 <span data-i18n="common.active">Active</span></span>
                        </div>
                        <div class="text-center py-12">
                            <span class="material-symbols-outlined text-6xl text-gray-300 mb-4 block">golf_course</span>
                            <p class="text-gray-500 text-lg" data-i18n="common.noactiverounds">No active rounds</p>
                            <p class="text-gray-400 text-sm mt-2" data-i18n="common.roundsappearhere">Rounds will appear here when players are on course</p>
                        </div>
                    </div>

                    <!-- Staff Status -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title" data-i18n="manager.staff.status">Staff Status</h3>
                            <button onclick="showManagerTab('staff', event)" class="btn-sm btn-outline" data-i18n="common.manageall">Manage All</button>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                        <span class="material-symbols-outlined text-green-600 text-sm">person_check</span>
                                    </div>
                                    <span class="text-sm font-medium">Caddys</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-sm font-bold">0/0</span>
                                    <span class="text-xs text-gray-500 ml-2">Active</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                        <span class="material-symbols-outlined text-blue-600 text-sm">restaurant</span>
                                    </div>
                                    <span class="text-sm font-medium">F&B Staff</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-sm font-bold">0/0</span>
                                    <span class="text-xs text-gray-500 ml-2">Active</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                        <span class="material-symbols-outlined text-purple-600 text-sm">store</span>
                                    </div>
                                    <span class="text-sm font-medium">Pro Shop</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-sm font-bold">0/0</span>
                                    <span class="text-xs text-gray-500 ml-2">Active</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center">
                                        <span class="material-symbols-outlined text-orange-600 text-sm">build</span>
                                    </div>
                                    <span class="text-sm font-medium">Maintenance</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-sm font-bold">0/0</span>
                                    <span class="text-xs text-gray-500 ml-2">Active</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                                        <span class="material-symbols-outlined text-red-600 text-sm">security</span>
                                    </div>
                                    <span class="text-sm font-medium">Security</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-sm font-bold">0/0</span>
                                    <span class="text-xs text-gray-500 ml-2">Active</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tee Sheet & Traffic Tab -->
            <div id="manager-traffic" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Tee Sheet & Live Course Traffic</h2>
                    <p class="text-gray-600">Monitor live course activity and pace of play</p>
                </div>

                <!-- Live Course Traffic Monitor - PROFESSIONAL -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 border-b border-gray-200 px-6 py-4 rounded-t-xl">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">
                                    <span class="material-symbols-outlined text-white">golf_course</span>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">Course Traffic Monitor</h3>
                                    <div class="flex items-center gap-2 mt-0.5">
                                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                        <span class="text-xs text-gray-600 font-medium">Live Status</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="bg-white rounded-lg px-3 py-2 shadow-sm border border-gray-200">
                                    <select id="courseConfigSelector" onchange="TrafficMonitor.updateCourseConfig()" class="text-sm font-medium text-gray-700 bg-transparent border-none focus:ring-0 cursor-pointer">
                                        <option value="9">9 Holes</option>
                                        <option value="18" selected>18 Holes</option>
                                        <option value="27">27 Holes</option>
                                        <option value="36">36 Holes</option>
                                    </select>
                                </div>
                                <div class="bg-white rounded-lg px-3 py-2 shadow-sm border border-gray-200 hidden" id="nineSelectorWrapper">
                                    <select id="nineSelector" onchange="TrafficMonitor.changeNineView()" class="text-sm font-medium text-gray-700 bg-transparent border-none focus:ring-0 cursor-pointer">
                                        <option value="1">Nine A (1-9)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Course Map -->
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h4 id="currentViewLabel" class="text-base font-bold text-gray-900">Holes 1-18</h4>
                                <p class="text-sm text-gray-500 mt-0.5">Click any hole to view details and history</p>
                            </div>
                            <div class="flex items-center gap-4 bg-gray-50 rounded-lg px-4 py-2">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-green-400 shadow-sm"></div>
                                    <span class="text-xs font-medium text-gray-700">Clear</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-yellow-400 shadow-sm"></div>
                                    <span class="text-xs font-medium text-gray-700">Busy</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-red-400 shadow-sm"></div>
                                    <span class="text-xs font-medium text-gray-700">Backed Up</span>
                                </div>
                            </div>
                        </div>

                        <!-- Dynamic Hole Grid -->
                        <div id="trafficHoleGrid" class="grid grid-cols-9 gap-3 mb-6">
                            <!-- Holes will be rendered dynamically by TrafficMonitor.renderHoles() -->
                        </div>

                        <!-- Hole Details Panel -->
                        <div id="holeDetailsPanel" class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-8 border border-gray-200">
                            <div class="text-center text-gray-500">
                                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm">
                                    <span class="material-symbols-outlined text-4xl text-gray-400">golf_course</span>
                                </div>
                                <p class="text-sm font-medium text-gray-600">Select a hole to view details & activity history</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Staff Management Tab -->
            <div id="manager-staff" class="tab-content hidden">
                <div class="mb-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <h2 class="text-2xl font-bold text-gray-900">Staff Management</h2>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="StaffManagement.showAddStaffModal()" class="btn-sm btn-primary">
                                <span class="material-symbols-outlined text-sm">add</span>
                                Add Staff
                            </button>
                            <button class="btn-sm btn-outline">
                                <span class="material-symbols-outlined text-sm">download</span>
                                Export Roster
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Department Filter Tabs -->
                <div class="flex flex-wrap gap-2 mb-6 border-b border-gray-200 pb-2">
                    <button onclick="StaffManagement.renderStaffList()" class="px-4 py-2 text-sm font-medium rounded-t border-b-2 border-blue-600 text-blue-600">
                        All Staff
                    </button>
                    <button onclick="StaffManagement.renderStaffList('caddy')" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300">
                        Caddies (<span id="caddy-count">0</span>)
                    </button>
                    <button onclick="StaffManagement.renderStaffList('fnb')" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300">
                        F&B (<span id="fnb-count">0</span>)
                    </button>
                    <button onclick="StaffManagement.renderStaffList('proshop')" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300">
                        Pro Shop (<span id="proshop-count">0</span>)
                    </button>
                    <button onclick="StaffManagement.renderStaffList('maintenance')" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300">
                        Maintenance (<span id="maintenance-count">0</span>)
                    </button>
                    <button onclick="StaffManagement.renderStaffList('reception')" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300">
                        Reception (<span id="reception-count">0</span>)
                    </button>
                </div>

                <!-- Staff List Container -->
                <div id="staff-list-container">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="manager-analytics" class="tab-content hidden">
                <!-- Professional Header -->
                <div class="pro-header">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h2>Analytics & Business Intelligence</h2>
                            <p>Real-time performance metrics and insights</p>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <select class="pro-select" id="global-period-selector" onchange="updateAllAnalytics(this.value)">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month" selected>This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                            </select>
                            <button class="pro-btn-outline" onclick="AnalyticsDrillDown.showCashManagement()" style="margin-right: 0.5rem;">
                                <span class="material-symbols-outlined text-sm" style="vertical-align: middle; margin-right: 0.5rem;">point_of_sale</span>
                                Cash Management
                            </button>
                            <button class="pro-btn" onclick="exportAnalyticsPDF()">
                                <span class="material-symbols-outlined text-sm" style="vertical-align: middle; margin-right: 0.5rem;">download</span>
                                Export Report
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Key Metrics (Clickable for drill-down) -->
                <div class="pro-stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="pro-metric" style="cursor: pointer; transition: transform 0.2s;"
                         onclick="AnalyticsDrillDown.showRevenueNowDrillDown()"
                         onmouseover="this.style.transform='translateY(-2px)'"
                         onmouseout="this.style.transform='translateY(0)'">
                        <div class="flex items-center justify-between">
                            <div class="pro-metric-label">Revenue Now</div>
                            <span class="material-symbols-outlined pro-icon">trending_up</span>
                        </div>
                        <div class="pro-metric-value" id="analytics-revenue-now">฿0</div>
                        <div class="pro-metric-change positive">
                            +0% vs yesterday
                            <span class="material-symbols-outlined text-xs ml-1" style="vertical-align: middle;">visibility</span>
                        </div>
                    </div>

                    <div class="pro-metric" style="cursor: pointer; transition: transform 0.2s;"
                         onclick="AnalyticsDrillDown.showForecastDrillDown()"
                         onmouseover="this.style.transform='translateY(-2px)'"
                         onmouseout="this.style.transform='translateY(0)'">
                        <div class="flex items-center justify-between">
                            <div class="pro-metric-label">Forecast (EoD)</div>
                            <span class="material-symbols-outlined pro-icon">insights</span>
                        </div>
                        <div class="pro-metric-value" id="analytics-forecast">฿0</div>
                        <div class="pro-metric-change neutral">
                            Projection
                            <span class="material-symbols-outlined text-xs ml-1" style="vertical-align: middle;">visibility</span>
                        </div>
                    </div>

                    <div class="pro-metric" style="cursor: pointer; transition: transform 0.2s;"
                         onclick="AnalyticsDrillDown.showRevenuePerRoundDrillDown()"
                         onmouseover="this.style.transform='translateY(-2px)'"
                         onmouseout="this.style.transform='translateY(0)'">
                        <div class="flex items-center justify-between">
                            <div class="pro-metric-label">Revenue / Round</div>
                            <span class="material-symbols-outlined pro-icon">golf_course</span>
                        </div>
                        <div class="pro-metric-value" id="analytics-rev-per-round">฿0</div>
                        <div class="pro-metric-change neutral">
                            Average per player
                            <span class="material-symbols-outlined text-xs ml-1" style="vertical-align: middle;">visibility</span>
                        </div>
                    </div>

                    <div class="pro-metric" style="cursor: pointer; transition: transform 0.2s;"
                         onclick="AnalyticsDrillDown.showUtilizationDrillDown()"
                         onmouseover="this.style.transform='translateY(-2px)'"
                         onmouseout="this.style.transform='translateY(0)'">
                        <div class="flex items-center justify-between">
                            <div class="pro-metric-label">Utilization</div>
                            <span class="material-symbols-outlined pro-icon">bar_chart</span>
                        </div>
                        <div class="pro-metric-value" id="analytics-utilization">0%</div>
                        <div class="pro-metric-change neutral">
                            Course capacity
                            <span class="material-symbols-outlined text-xs ml-1" style="vertical-align: middle;">visibility</span>
                        </div>
                    </div>
                </div>

                <!-- Revenue by Source -->
                <div class="card mb-8">
                    <div class="card-header">
                        <h3 class="card-title">Revenue by Source</h3>
                        <span class="text-sm text-gray-500">Today</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="p-4 bg-green-50 rounded-lg border border-green-200 cursor-pointer transition-transform hover:-translate-y-1"
                             onclick="AnalyticsDrillDown.showGreenFeesDrillDown()">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-green-900">Green Fees</span>
                                <span class="material-symbols-outlined text-green-600 text-sm">golf_course</span>
                            </div>
                            <div class="text-2xl font-bold text-green-600" id="analytics-green-fees">฿0</div>
                            <div class="text-xs text-green-700 mt-1 flex items-center justify-between">
                                <span>0 rounds</span>
                                <span class="material-symbols-outlined text-xs">visibility</span>
                            </div>
                        </div>

                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200 cursor-pointer transition-transform hover:-translate-y-1"
                             onclick="AnalyticsDrillDown.showCaddyServicesDrillDown()">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-blue-900">Caddy Services</span>
                                <span class="material-symbols-outlined text-blue-600 text-sm">person</span>
                            </div>
                            <div class="text-2xl font-bold text-blue-600" id="analytics-caddy-fees">฿0</div>
                            <div class="text-xs text-blue-700 mt-1 flex items-center justify-between">
                                <span>0 caddies</span>
                                <span class="material-symbols-outlined text-xs">visibility</span>
                            </div>
                        </div>

                        <div class="p-4 bg-orange-50 rounded-lg border border-orange-200 cursor-pointer transition-transform hover:-translate-y-1"
                             onclick="AnalyticsDrillDown.showFnBDrillDown()">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-orange-900">F&B Sales</span>
                                <span class="material-symbols-outlined text-orange-600 text-sm">restaurant</span>
                            </div>
                            <div class="text-2xl font-bold text-orange-600" id="analytics-fnb-sales">฿0</div>
                            <div class="text-xs text-orange-700 mt-1 flex items-center justify-between">
                                <span>0 orders</span>
                                <span class="material-symbols-outlined text-xs">visibility</span>
                            </div>
                        </div>

                        <div class="p-4 bg-purple-50 rounded-lg border border-purple-200 cursor-pointer transition-transform hover:-translate-y-1"
                             onclick="AnalyticsDrillDown.showProShopDrillDown()">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-purple-900">Pro Shop</span>
                                <span class="material-symbols-outlined text-purple-600 text-sm">store</span>
                            </div>
                            <div class="text-2xl font-bold text-purple-600" id="analytics-proshop-sales">฿0</div>
                            <div class="text-xs text-purple-700 mt-1 flex items-center justify-between">
                                <span>0 transactions</span>
                                <span class="material-symbols-outlined text-xs">visibility</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Customer Satisfaction</h3>
                        </div>
                        <div class="text-center py-6">
                            <div class="text-5xl font-bold text-green-600 mb-2" id="analytics-satisfaction">-</div>
                            <div class="text-sm text-gray-600 mb-4">Average Rating</div>
                            <div class="space-y-2 text-left">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">Course Quality</span>
                                    <span class="font-bold" id="analytics-course-rating">-</span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">Service</span>
                                    <span class="font-bold" id="analytics-service-rating">-</span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">Value</span>
                                    <span class="font-bold" id="analytics-value-rating">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Staff Performance</h3>
                        </div>
                        <div class="text-center py-6">
                            <div class="text-5xl font-bold text-blue-600 mb-2" id="analytics-staff-efficiency">-</div>
                            <div class="text-sm text-gray-600 mb-4">Efficiency Score</div>
                            <div class="space-y-2 text-left">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">Caddies</span>
                                    <span class="font-bold" id="analytics-caddy-efficiency">-</span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">F&B</span>
                                    <span class="font-bold" id="analytics-fnb-efficiency">-</span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">Pro Shop</span>
                                    <span class="font-bold" id="analytics-proshop-efficiency">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Revenue Growth</h3>
                        </div>
                        <div class="text-center py-6">
                            <div class="text-5xl font-bold text-orange-600 mb-2" id="analytics-growth">-</div>
                            <div class="text-sm text-gray-600 mb-4">Month over Month</div>
                            <div class="space-y-2 text-left">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">This Month</span>
                                    <span class="font-bold" id="analytics-this-month">฿0</span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">Last Month</span>
                                    <span class="font-bold" id="analytics-last-month">฿0</span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">Difference</span>
                                    <span class="font-bold text-green-600" id="analytics-difference">฿0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Course Utilization -->
                <div class="card mb-8">
                    <div class="card-header">
                        <h3 class="card-title">Course Utilization</h3>
                        <span class="text-sm text-gray-500">Peak vs Off-peak</span>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium">Peak Hours (8AM-2PM)</span>
                            <div class="flex items-center space-x-3 flex-1 max-w-xs">
                                <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-red-500 rounded-full transition-all" style="width: 0%" id="analytics-peak-bar"></div>
                                </div>
                                <span class="text-sm font-bold min-w-[3rem]" id="analytics-peak-pct">0%</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium">Mid Hours (2PM-5PM)</span>
                            <div class="flex items-center space-x-3 flex-1 max-w-xs">
                                <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-yellow-500 rounded-full transition-all" style="width: 0%" id="analytics-mid-bar"></div>
                                </div>
                                <span class="text-sm font-bold min-w-[3rem]" id="analytics-mid-pct">0%</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium">Evening (5PM-7PM)</span>
                            <div class="flex items-center space-x-3 flex-1 max-w-xs">
                                <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-green-500 rounded-full transition-all" style="width: 0%" id="analytics-evening-bar"></div>
                                </div>
                                <span class="text-sm font-bold min-w-[3rem]" id="analytics-evening-pct">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Insights & Recommendations -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Insights & Recommendations</h3>
                    </div>
                    <div id="analytics-insights" class="space-y-3">
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="flex items-start space-x-3">
                                <span class="material-symbols-outlined text-blue-600">lightbulb</span>
                                <div class="flex-1">
                                    <div class="font-medium text-blue-900 mb-1">Getting Started</div>
                                    <div class="text-sm text-blue-700">Start recording bookings, transactions, and operations to see detailed analytics and insights here.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Revenue Segmentation -->
                <div class="pro-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 class="pro-section-title" style="margin: 0;">Revenue Segmentation</h3>
                        <select id="customer-type-period" class="pro-select" onchange="SocietyGolfAnalytics.updateRevenueBreakdown(this.value)">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="pro-revenue-card members">
                            <div class="pro-revenue-label">Members</div>
                            <div class="pro-revenue-amount" id="rev-member-amount">฿0</div>
                            <div class="pro-revenue-count"><span id="rev-member-count">0</span> rounds</div>
                        </div>

                        <div class="pro-revenue-card guests">
                            <div class="pro-revenue-label">Guests</div>
                            <div class="pro-revenue-amount" id="rev-guest-amount">฿0</div>
                            <div class="pro-revenue-count"><span id="rev-guest-count">0</span> rounds</div>
                        </div>

                        <div class="pro-revenue-card walkin">
                            <div class="pro-revenue-label">Walk-ins</div>
                            <div class="pro-revenue-amount" id="rev-walkin-amount">฿0</div>
                            <div class="pro-revenue-count"><span id="rev-walkin-count">0</span> rounds</div>
                        </div>

                        <div class="pro-revenue-card society">
                            <div class="pro-revenue-label">Society Golf</div>
                            <div class="pro-revenue-amount" id="rev-society-amount">฿0</div>
                            <div class="pro-revenue-count"><span id="rev-society-count">0</span> rounds</div>
                        </div>

                        <div class="pro-revenue-card tournament">
                            <div class="pro-revenue-label">Tournaments</div>
                            <div class="pro-revenue-amount" id="rev-tournament-amount">฿0</div>
                            <div class="pro-revenue-count"><span id="rev-tournament-count">0</span> rounds</div>
                        </div>

                        <div class="pro-revenue-card corporate">
                            <div class="pro-revenue-label">Corporate/VIP</div>
                            <div class="pro-revenue-amount" id="rev-corporate-amount">฿0</div>
                            <div class="pro-revenue-count"><span id="rev-corporate-count">0</span> rounds</div>
                        </div>
                    </div>
                    <div class="pro-divider"></div>
                    <div class="flex items-center justify-between">
                        <span style="font-size: 1rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em;">Total Revenue</span>
                        <span style="font-size: 2rem; font-weight: 700; color: #1a1a1a;" id="rev-total-amount">฿0</span>
                    </div>
                </div>

                <!-- Society Golf Rankings -->
                <div class="pro-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 class="pro-section-title" style="margin: 0;">Society Golf Leaderboard</h3>
                        <select id="society-rankings-period" class="pro-select" onchange="SocietyGolfAnalytics.updateSocietyRankings(this.value)">
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year" selected>This Year</option>
                        </select>
                    </div>
                    <div id="society-rankings-table"></div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="manager-reports" class="tab-content hidden">
                <div class="mb-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <h2 class="text-2xl font-bold text-gray-900">Reports & Documentation</h2>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="ReportsSystem.showReportsUI()" class="btn-sm btn-primary">
                                <span class="material-symbols-outlined text-sm">description</span>
                                Browse All Reports (33)
                            </button>
                            <button onclick="ReportsSystem.viewReport('generateWeeklyExecutiveSummary')" class="btn-sm btn-outline">
                                <span class="material-symbols-outlined text-sm">dashboard</span>
                                Executive Summary
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Access Reports Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <!-- Financial Reports -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="ReportsSystem.viewReport('generateDailyRevenueSummary')">
                        <div class="flex items-center justify-between mb-3">
                            <span class="material-symbols-outlined text-green-600 text-2xl">payments</span>
                            <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Financial</span>
                        </div>
                        <h3 class="font-semibold text-gray-900 mb-1">Daily Revenue Summary</h3>
                        <p class="text-xs text-gray-600">Complete revenue breakdown by POS location</p>
                    </div>

                    <!-- Operational Reports -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="ReportsSystem.viewReport('generateTeeSheetUtilization')">
                        <div class="flex items-center justify-between mb-3">
                            <span class="material-symbols-outlined text-blue-600 text-2xl">event</span>
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Operational</span>
                        </div>
                        <h3 class="font-semibold text-gray-900 mb-1">Tee Sheet Utilization</h3>
                        <p class="text-xs text-gray-600">Hour-by-hour booking analysis</p>
                    </div>

                    <!-- Customer Reports -->
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="ReportsSystem.viewReport('generateMemberActivityReport')">
                        <div class="flex items-center justify-between mb-3">
                            <span class="material-symbols-outlined text-purple-600 text-2xl">people</span>
                            <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Customer</span>
                        </div>
                        <h3 class="font-semibold text-gray-900 mb-1">Member Activity</h3>
                        <p class="text-xs text-gray-600">Rounds played and spending patterns</p>
                    </div>

                    <!-- Revenue Deep Dive -->
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="ReportsSystem.viewReport('generateGreenFeesBreakdown')">
                        <div class="flex items-center justify-between mb-3">
                            <span class="material-symbols-outlined text-orange-600 text-2xl">golf_course</span>
                            <span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded">Revenue</span>
                        </div>
                        <h3 class="font-semibold text-gray-900 mb-1">Green Fees Breakdown</h3>
                        <p class="text-xs text-gray-600">Revenue by customer type analysis</p>
                    </div>

                    <!-- Compliance Reports -->
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="ReportsSystem.viewReport('generateEODReconciliation')">
                        <div class="flex items-center justify-between mb-3">
                            <span class="material-symbols-outlined text-red-600 text-2xl">receipt_long</span>
                            <span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded">Compliance</span>
                        </div>
                        <h3 class="font-semibold text-gray-900 mb-1">EOD Reconciliation</h3>
                        <p class="text-xs text-gray-600">Cash register reconciliation report</p>
                    </div>

                    <!-- Planning Reports -->
                    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="ReportsSystem.viewReport('generateDemandForecast')">
                        <div class="flex items-center justify-between mb-3">
                            <span class="material-symbols-outlined text-indigo-600 text-2xl">trending_up</span>
                            <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded">Planning</span>
                        </div>
                        <h3 class="font-semibold text-gray-900 mb-1">Demand Forecast</h3>
                        <p class="text-xs text-gray-600">30-day booking predictions</p>
                    </div>
                </div>

                <!-- Report Categories Overview -->
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-6 border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="material-symbols-outlined mr-2">folder_open</span>
                        All Report Categories
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                        <div class="text-center">
                            <div class="bg-green-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2">
                                <span class="material-symbols-outlined text-green-600">account_balance</span>
                            </div>
                            <p class="text-sm font-medium text-gray-900">Financial</p>
                            <p class="text-xs text-gray-500">6 reports</p>
                        </div>
                        <div class="text-center">
                            <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2">
                                <span class="material-symbols-outlined text-blue-600">settings</span>
                            </div>
                            <p class="text-sm font-medium text-gray-900">Operational</p>
                            <p class="text-xs text-gray-500">6 reports</p>
                        </div>
                        <div class="text-center">
                            <div class="bg-purple-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2">
                                <span class="material-symbols-outlined text-purple-600">groups</span>
                            </div>
                            <p class="text-sm font-medium text-gray-900">Customer</p>
                            <p class="text-xs text-gray-500">6 reports</p>
                        </div>
                        <div class="text-center">
                            <div class="bg-orange-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2">
                                <span class="material-symbols-outlined text-orange-600">monetization_on</span>
                            </div>
                            <p class="text-sm font-medium text-gray-900">Revenue</p>
                            <p class="text-xs text-gray-500">4 reports</p>
                        </div>
                        <div class="text-center">
                            <div class="bg-red-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2">
                                <span class="material-symbols-outlined text-red-600">verified_user</span>
                            </div>
                            <p class="text-sm font-medium text-gray-900">Compliance</p>
                            <p class="text-xs text-gray-500">4 reports</p>
                        </div>
                        <div class="text-center">
                            <div class="bg-indigo-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2">
                                <span class="material-symbols-outlined text-indigo-600">timeline</span>
                            </div>
                            <p class="text-sm font-medium text-gray-900">Planning</p>
                            <p class="text-xs text-gray-500">4 reports</p>
                        </div>
                        <div class="text-center">
                            <div class="bg-gray-800 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2">
                                <span class="material-symbols-outlined text-white">workspace_premium</span>
                            </div>
                            <p class="text-sm font-medium text-gray-900">Executive</p>
                            <p class="text-xs text-gray-500">3 reports</p>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <button onclick="ReportsSystem.showReportsUI()" class="btn-primary">
                            <span class="material-symbols-outlined text-sm">library_books</span>
                            View All 33 Reports
                        </button>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="manager-settings" class="tab-content hidden">
                <!-- Admin Pricing Control Dashboard -->
                <div id="admin-pricing-dashboard"></div>
            </div>

            <!-- Maintenance Tab -->
            <div id="manager-maintenance" class="tab-content hidden">
                <div class="mb-4">
                    <h2 class="text-xl font-bold">Maintenance</h2>
                </div>

                <div class="flex gap-2 mb-4 flex-wrap">
                    <button onclick="MaintenanceManagement.showCreateWorkOrderModal()" class="btn-primary text-sm">
                        <span class="material-symbols-outlined text-sm">build</span>
                        New
                    </button>
                    <button onclick="MaintenanceManagement.scheduleMaintenanceWindow()" class="btn-secondary text-sm">
                        <span class="material-symbols-outlined text-sm">calendar_today</span>
                        Schedule
                    </button>
                    <button onclick="MaintenanceManagement.generateMaintenanceReport()" class="btn-secondary text-sm">
                        <span class="material-symbols-outlined text-sm">summarize</span>
                        Report
                    </button>
                </div>

                <!-- Metrics Grid -->
                <div id="maintenance-metrics-container" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4"></div>

                <!-- Weather Summary (compact) -->
                <div class="bg-white border border-gray-200 rounded-lg p-3 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3 flex-1">
                            <div id="maint-weather-temp" class="text-2xl font-bold text-gray-900">--°</div>
                            <div class="flex-1">
                                <div id="maint-weather-desc" class="text-xs text-gray-600">Loading...</div>
                                <div id="maint-weather-details" class="text-xs text-gray-500">--</div>
                            </div>
                        </div>
                        <button onclick="showManagerTab('weather', event)" class="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1">
                            Details
                            <span class="material-symbols-outlined text-sm">arrow_forward</span>
                        </button>
                    </div>
                    <div id="maintenance-weather-recommendations" class="mt-2 space-y-1"></div>
                </div>

                <!-- Work Orders & Conditions Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
                    <!-- Active Work Orders -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold">Work Orders</h3>
                            <select id="work-order-filter" onchange="MaintenanceManagement.filterWorkOrders(this.value)" class="form-select text-xs">
                                <option value="all">All</option>
                                <option value="pending">Pending</option>
                                <option value="in-progress">In Progress</option>
                                <option value="on-hold">On Hold</option>
                            </select>
                        </div>
                        <div id="work-orders-container"></div>
                    </div>

                    <!-- Course Conditions -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h3 class="text-sm font-semibold mb-3">Course Conditions</h3>
                        <div id="course-conditions-container"></div>
                    </div>
                </div>
            </div>

            <!-- Weather Tab -->
            <div id="manager-weather" class="tab-content hidden">
                <!-- Compact Header -->
                <div class="mb-4">
                    <h2 class="text-xl font-bold">Weather Radar</h2>
                </div>

                <!-- Live Radar Map -->
                <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold text-gray-700">Live Rain Radar</h3>
                        <div class="flex items-center gap-2">
                            <button id="radar-play-pause" onclick="WeatherIntegration.toggleRadarAnimation()" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                <span id="radar-play-icon">▶</span> Play
                            </button>
                            <span id="radar-timestamp" class="text-xs text-gray-500">--</span>
                        </div>
                    </div>
                    <div id="weather-radar-map" class="w-full h-96 rounded border border-gray-200"></div>
                    <div class="mt-2 flex items-center gap-2">
                        <span class="text-xs text-gray-500">Rain Intensity:</span>
                        <div class="flex gap-1 items-center">
                            <div class="w-4 h-3 bg-blue-200"></div>
                            <span class="text-xs text-gray-400">Light</span>
                            <div class="w-4 h-3 bg-blue-400 ml-2"></div>
                            <span class="text-xs text-gray-400">Moderate</span>
                            <div class="w-4 h-3 bg-blue-600 ml-2"></div>
                            <span class="text-xs text-gray-400">Heavy</span>
                        </div>
                    </div>
                </div>

                <!-- Current Conditions - Compact -->
                <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div id="weather-current-temp" class="text-2xl font-bold text-gray-900">--°C</div>
                            <div>
                                <div id="weather-current-desc" class="text-sm text-gray-600">Loading...</div>
                                <div id="weather-location" class="text-xs text-gray-500">Bang Lamung</div>
                            </div>
                        </div>
                        <div id="weather-updated" class="text-xs text-gray-400">--</div>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm text-gray-400">water_drop</span>
                            <div>
                                <div class="text-xs text-gray-500">Humidity</div>
                                <div id="weather-humidity" class="text-sm font-semibold">--%</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm text-gray-400">air</span>
                            <div>
                                <div class="text-xs text-gray-500">Wind</div>
                                <div id="weather-wind" class="text-sm font-semibold">--</div>
                                <div id="weather-wind-direction" class="text-xs text-gray-400">--</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm text-gray-400">compress</span>
                            <div>
                                <div class="text-xs text-gray-500">Pressure</div>
                                <div id="weather-pressure" class="text-sm font-semibold">--</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm text-gray-400">visibility</span>
                            <div>
                                <div class="text-xs text-gray-500">Visibility</div>
                                <div id="weather-visibility" class="text-sm font-semibold">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3-Hour Forecast - Compact -->
                <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
                    <h3 class="text-sm font-semibold mb-3 text-gray-700">Next 12 Hours</h3>
                    <div id="weather-forecast-3h" class="grid grid-cols-2 sm:grid-cols-4 gap-2"></div>
                </div>

                <!-- Alerts & Impact -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h3 class="text-sm font-semibold mb-3 text-gray-700">Alerts</h3>
                        <div id="weather-alerts-container" class="space-y-2"></div>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h3 class="text-sm font-semibold mb-3 text-gray-700">Course Impact</h3>
                        <div id="weather-course-impact" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Playability -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h3 class="text-sm font-semibold mb-3 text-gray-700">Playability</h3>
                    <div id="weather-playability-status"></div>
                </div>
            </div>

            <!-- OLD SETTINGS REMOVED - REPLACED WITH PRICING CONTROL -->
            <div style="display:none;">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Course Configuration -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Course Configuration</h3>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="form-label">Course Name</label>
                                <input type="text" class="form-input" value="" placeholder="Enter your course name" />
                            </div>
                            <div>
                                <label class="form-label">Operating Hours</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="time" class="form-input" value="" placeholder="Opening time" />
                                    <input type="time" class="form-input" value="" placeholder="Closing time" />
                                </div>
                            </div>
                            <div>
                                <label class="form-label">Maximum Players per Slot</label>
                                <select class="form-select">
                                    <option value="">Select...</option>
                                    <option>4 Players</option>
                                    <option>3 Players</option>
                                    <option>2 Players</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Advance Booking Limit</label>
                                <select class="form-select">
                                    <option value="">Select...</option>
                                    <option>30 days</option>
                                    <option>60 days</option>
                                    <option>90 days</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Pricing Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Pricing Settings</h3>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="form-label">Peak Hours Green Fee</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">฿</span>
                                    <input type="number" class="form-input pl-8" value="" placeholder="0" />
                                </div>
                            </div>
                            <div>
                                <label class="form-label">Off-Peak Green Fee</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">฿</span>
                                    <input type="number" class="form-input pl-8" value="" placeholder="0" />
                                </div>
                            </div>
                            <div>
                                <label class="form-label">Caddy Base Fee</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">฿</span>
                                    <input type="number" class="form-input pl-8" value="" placeholder="0" />
                                </div>
                            </div>
                            <div>
                                <label class="form-label">Cart Rental Fee</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">฿</span>
                                    <input type="number" class="form-input pl-8" value="" placeholder="0" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Staff Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Staff Settings</h3>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium">Automatic Caddy Assignment</p>
                                    <p class="text-sm text-gray-600">Assign caddies based on availability and rating</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" checked class="sr-only peer" />
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium">Performance Tracking</p>
                                    <p class="text-sm text-gray-600">Track staff performance and customer ratings</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" checked class="sr-only peer" />
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium">Shift Notifications</p>
                                    <p class="text-sm text-gray-600">Send shift reminders to staff</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" checked class="sr-only peer" />
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Emergency Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Emergency Settings</h3>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="form-label">Emergency Contact</label>
                                <input type="tel" class="form-input" value="" placeholder="+66-x-xxx-xxxx" />
                            </div>
                            <div>
                                <label class="form-label">Medical Team Contact</label>
                                <input type="tel" class="form-input" value="" placeholder="+66-x-xxx-xxxx" />
                            </div>
                            <div>
                                <label class="form-label">Security Team Contact</label>
                                <input type="tel" class="form-input" value="" placeholder="+66-x-xxx-xxxx" />
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium">Emergency Broadcasts</p>
                                    <p class="text-sm text-gray-600">Send alerts to all staff and players</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" />
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Settings -->
                <div class="mt-8 flex justify-end space-x-4">
                    <button class="btn-outline">Reset to Default</button>
                    <button class="btn-primary">Save Settings</button>
                </div>
            </div> <!-- end hidden old content -->
        </main>
    </div>

    <!-- Pro Shop Dashboard -->
    <div id="proshopDashboard" class="screen">
        <header class="nav-header">
            <div class="max-w-7xl mx-auto px-4 lg:px-8">
                <div class="flex justify-between items-center py-3 md:py-5">
                    <div class="flex items-center space-x-2 md:space-x-4">
                        <img class="user-avatar" style="display: none;">
                        <div>
                            <h1 class="text-base md:text-xl font-bold text-gray-900" data-i18n="proshop.title">Pro Shop Dashboard</h1>
                            <p class="text-xs md:text-sm text-gray-600"><span data-i18n="proshop.welcome">Welcome back, Pro Shop</span> <span class="user-name-display">Pro Shop</span> <span class="user-username-display text-gray-500"></span>!</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="sendEmergencyAlert()" class="emergency-btn" title="Emergency Alert">
                            <span class="material-symbols-outlined">emergency</span>
                        </button>
                        <button onclick="window.openProfessionalChat()" class="btn-primary relative" style="background: #10b981; padding: 10px 16px;" title="Chat">
                            <span class="material-symbols-outlined text-sm">chat</span>
                            <span data-i18n="common.chat">Chat</span>
                            <span id="chatBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-medium" style="display: none;">0</span>
                        </button>
                        <button onclick="logout()" class="btn-logout">
                            <span class="material-symbols-outlined text-sm">logout</span>
                            <span data-i18n="common.logout">Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Enhanced Pro Shop Navigation -->
        <nav class="tab-navigation border-b">
            <div class="max-w-7xl mx-auto px-4 lg:px-8">
                <div class="flex space-x-2 md:space-x-8 overflow-x-auto">
                    <button onclick="showProshopTab('pos', event)" class="tab-button active px-2 md:px-4" id="proshop-pos-tab">
                        <span class="material-symbols-outlined text-sm">point_of_sale</span>
                        <span class="hidden sm:inline ml-1" data-i18n="proshop.pos">Point of Sale</span>
                    </button>
                    <button onclick="showProshopTab('inventory', event)" class="tab-button px-2 md:px-4" id="proshop-inventory-tab">
                        <span class="material-symbols-outlined text-sm">inventory</span>
                        <span class="hidden sm:inline ml-1" data-i18n="proshop.inventory">Inventory</span>
                    </button>
                    <button onclick="showProshopTab('sales', event)" class="tab-button px-2 md:px-4" id="proshop-sales-tab">
                        <span class="material-symbols-outlined text-sm">trending_up</span>
                        <span class="hidden sm:inline ml-1" data-i18n="proshop.sales">Sales Reports</span>
                    </button>
                    <button onclick="showProshopTab('customers', event)" class="tab-button px-2 md:px-4" id="proshop-customers-tab">
                        <span class="material-symbols-outlined text-sm">people</span>
                        <span class="hidden sm:inline ml-1" data-i18n="proshop.customers">Customers</span>
                    </button>
                    <button onclick="showProshopTab('settings', event)" class="tab-button px-2 md:px-4" id="proshop-settings-tab">
                        <span class="material-symbols-outlined text-sm">settings</span>
                        <span class="hidden sm:inline ml-1" data-i18n="common.settings">Settings</span>
                    </button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-6 lg:px-8 py-8">
            <!-- Point of Sale Tab -->
            <div id="proshop-pos" class="tab-content active">
                <!-- Pro Shop Hero Section -->
                <div class="hero-section bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-3xl p-8 mb-8">
                    <div class="flex flex-col lg:flex-row justify-between items-center">
                        <div class="text-center lg:text-left mb-6 lg:mb-0">
                            <h2 class="text-2xl font-bold mb-2" data-i18n="proshop.pos.title">Pro Shop POS</h2>
                            <p class="text-purple-100 text-lg" data-i18n="proshop.equipment">Golf Equipment & Merchandise</p>
                            <div class="flex flex-wrap justify-center lg:justify-start gap-6 mt-4 text-sm">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-lg">store</span>
                                    <span data-i18n="proshop.items">450+ Items</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-lg">shopping_cart</span>
                                    <span data-i18n="proshop.sales.today">28 Sales Today</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-lg">star</span>
                                    <span data-i18n="proshop.service">4.9★ Service</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-bold">₿45,280</div>
                            <div class="text-purple-200" data-i18n="proshop.todays.sales">Today's Sales</div>
                            <div class="text-sm text-purple-200 mt-1">+8% vs yesterday</div>
                        </div>
                    </div>
                </div>

                <!-- Persistent Emergency Alerts -->
                <div id="proshop-emergency-alerts" class="persistent-emergency-alerts mb-6" style="display: none;">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <span class="material-symbols-outlined text-red-600">emergency</span>
                                <h3 class="text-lg font-bold text-red-800">Active Emergency Alerts</h3>
                            </div>
                            <span id="proshop-alert-count" class="bg-red-600 text-white text-xs px-2 py-1 rounded-full font-medium">0</span>
                        </div>
                        <div id="proshop-alert-list" class="space-y-2">
                            <!-- Emergency alerts will be populated here -->
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Product Categories & Search -->
                    <div class="lg:col-span-2">
                        <!-- Search & Categories -->
                        <div class="mb-6">
                            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                                <div class="flex-1 relative">
                                    <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</span>
                                    <input type="text" placeholder="Search products..." data-i18n-placeholder="proshop.search.products" class="form-input pl-10" id="product-search" />
                                </div>
                                <select class="form-select" id="category-filter">
                                    <option value="" data-i18n="proshop.all.categories">All Categories</option>
                                    <option value="clubs" data-i18n="proshop.golf.clubs">Golf Clubs</option>
                                    <option value="balls" data-i18n="proshop.golf.balls">Golf Balls</option>
                                    <option value="apparel" data-i18n="proshop.apparel">Apparel</option>
                                    <option value="accessories" data-i18n="proshop.accessories">Accessories</option>
                                    <option value="drinks" data-i18n="proshop.beverages">Beverages</option>
                                    <option value="snacks" data-i18n="proshop.snacks">Snacks</option>
                                </select>
                            </div>

                            <!-- Category Tabs -->
                            <div class="flex space-x-2 overflow-x-auto pb-2 mb-4">
                                <button class="category-tab active" data-category="all">All</button>
                                <button class="category-tab" data-category="clubs">Clubs</button>
                                <button class="category-tab" data-category="balls">Balls</button>
                                <button class="category-tab" data-category="apparel">Apparel</button>
                                <button class="category-tab" data-category="accessories">Accessories</button>
                                <button class="category-tab" data-category="drinks">Drinks</button>
                                <button class="category-tab" data-category="snacks">Snacks</button>
                            </div>
                        </div>

                        <!-- Product Grid -->
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="product-grid">
                            <!-- Golf Clubs -->
                            <div class="product-card" data-category="clubs" onclick="addToCart('Driver - Titleist TSR3', 12500, 'CLUB001')">
                                <div class="product-image bg-blue-100 rounded-lg aspect-square flex items-center justify-center mb-2">
                                    <span class="material-symbols-outlined text-2xl text-blue-600">golf_course</span>
                                </div>
                                <h4 class="font-medium text-sm mb-1">Driver - Titleist TSR3</h4>
                                <p class="text-xs text-gray-600 mb-2">Premium driver club</p>
                                <p class="font-bold text-purple-600">₿12,500</p>
                                <p class="text-xs text-gray-500">Stock: 8</p>
                            </div>

                            <div class="product-card" data-category="clubs" onclick="addToCart('Iron Set - Mizuno JPX923', 28500, 'CLUB002')">
                                <div class="product-image bg-green-100 rounded-lg aspect-square flex items-center justify-center mb-2">
                                    <span class="material-symbols-outlined text-2xl text-green-600">golf_course</span>
                                </div>
                                <h4 class="font-medium text-sm mb-1">Iron Set - Mizuno JPX923</h4>
                                <p class="text-xs text-gray-600 mb-2">7-piece iron set</p>
                                <p class="font-bold text-purple-600">₿28,500</p>
                                <p class="text-xs text-gray-500">Stock: 5</p>
                            </div>

                            <!-- Golf Balls -->
                            <div class="product-card" data-category="balls" onclick="addToCart('Pro V1 Golf Balls (12)', 1800, 'BALL001')">
                                <div class="product-image bg-yellow-100 rounded-lg aspect-square flex items-center justify-center mb-2">
                                    <span class="material-symbols-outlined text-2xl text-yellow-600">sports_golf</span>
                                </div>
                                <h4 class="font-medium text-sm mb-1">Pro V1 Golf Balls (12)</h4>
                                <p class="text-xs text-gray-600 mb-2">Premium golf balls</p>
                                <p class="font-bold text-purple-600">₿1,800</p>
                                <p class="text-xs text-gray-500">Stock: 45</p>
                            </div>

                            <div class="product-card" data-category="balls" onclick="addToCart('Callaway Chrome Soft (12)', 1650, 'BALL002')">
                                <div class="product-image bg-orange-100 rounded-lg aspect-square flex items-center justify-center mb-2">
                                    <span class="material-symbols-outlined text-2xl text-orange-600">sports_golf</span>
                                </div>
                                <h4 class="font-medium text-sm mb-1">Callaway Chrome Soft (12)</h4>
                                <p class="text-xs text-gray-600 mb-2">Soft feel golf balls</p>
                                <p class="font-bold text-purple-600">₿1,650</p>
                                <p class="text-xs text-gray-500">Stock: 32</p>
                            </div>

                            <!-- Apparel -->
                            <div class="product-card" data-category="apparel" onclick="addToCart('Nike Polo Shirt', 2200, 'APPAREL001')">
                                <div class="product-image bg-red-100 rounded-lg aspect-square flex items-center justify-center mb-2">
                                    <span class="material-symbols-outlined text-2xl text-red-600">checkroom</span>
                                </div>
                                <h4 class="font-medium text-sm mb-1">Nike Polo Shirt</h4>
                                <p class="text-xs text-gray-600 mb-2">Moisture-wicking polo</p>
                                <p class="font-bold text-purple-600">₿2,200</p>
                                <p class="text-xs text-gray-500">Stock: 25</p>
                            </div>

                            <div class="product-card" data-category="apparel" onclick="addToCart('Adidas Golf Shoes', 4800, 'APPAREL002')">
                                <div class="product-image bg-indigo-100 rounded-lg aspect-square flex items-center justify-center mb-2">
                                    <span class="material-symbols-outlined text-2xl text-indigo-600">footwear</span>
                                </div>
                                <h4 class="font-medium text-sm mb-1">Adidas Golf Shoes</h4>
                                <p class="text-xs text-gray-600 mb-2">Waterproof golf shoes</p>
                                <p class="font-bold text-purple-600">₿4,800</p>
                                <p class="text-xs text-gray-500">Stock: 18</p>
                            </div>

                            <!-- Beverages -->
                            <div class="product-card" data-category="drinks" onclick="addToCart('Sports Drink', 45, 'DRINK001')">
                                <div class="product-image bg-teal-100 rounded-lg aspect-square flex items-center justify-center mb-2">
                                    <span class="material-symbols-outlined text-2xl text-teal-600">local_drink</span>
                                </div>
                                <h4 class="font-medium text-sm mb-1">Sports Drink</h4>
                                <p class="text-xs text-gray-600 mb-2">Electrolyte drink</p>
                                <p class="font-bold text-purple-600">₿45</p>
                                <p class="text-xs text-gray-500">Stock: 85</p>
                            </div>

                            <div class="product-card" data-category="drinks" onclick="addToCart('Bottled Water', 25, 'DRINK002')">
                                <div class="product-image bg-cyan-100 rounded-lg aspect-square flex items-center justify-center mb-2">
                                    <span class="material-symbols-outlined text-2xl text-cyan-600">water_drop</span>
                                </div>
                                <h4 class="font-medium text-sm mb-1">Bottled Water</h4>
                                <p class="text-xs text-gray-600 mb-2">Premium water</p>
                                <p class="font-bold text-purple-600">₿25</p>
                                <p class="text-xs text-gray-500">Stock: 120</p>
                            </div>
                        </div>
                    </div>

                    <!-- Shopping Cart -->
                    <div class="lg:col-span-1">
                        <div class="card sticky top-4">
                            <div class="card-header">
                                <h3 class="card-title">Shopping Cart</h3>
                                <button onclick="clearCart()" class="btn-sm btn-outline">Clear</button>
                            </div>

                            <div id="cart-items" class="space-y-3 mb-4">
                                <div class="text-center py-8 text-gray-500">
                                    <span class="material-symbols-outlined text-4xl mb-2 block">shopping_cart</span>
                                    <p class="text-sm">Cart is empty</p>
                                    <p class="text-xs">Add products to start a sale</p>
                                </div>
                            </div>

                            <div class="border-t pt-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-medium">Subtotal:</span>
                                    <span class="font-bold" id="cart-subtotal">₿0</span>
                                </div>
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm text-gray-600">Tax (7%):</span>
                                    <span class="text-sm" id="cart-tax">₿0</span>
                                </div>
                                <div class="flex justify-between items-center mb-4 text-lg font-bold">
                                    <span>Total:</span>
                                    <span id="cart-total">₿0</span>
                                </div>

                                <div class="space-y-2">
                                    <button onclick="processPayment('cash')" class="btn-primary w-full" id="cash-btn" disabled>
                                        <span class="material-symbols-outlined text-sm mr-2">payments</span>
                                        Cash Payment
                                    </button>
                                    <button onclick="processPayment('card')" class="btn-outline w-full" id="card-btn" disabled>
                                        <span class="material-symbols-outlined text-sm mr-2">credit_card</span>
                                        Card Payment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div id="proshop-inventory" class="tab-content hidden">
                <div class="mb-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <h2 class="text-2xl font-bold text-gray-900">Inventory Management</h2>
                        <div class="flex flex-wrap gap-3">
                            <button class="btn-sm btn-outline">
                                <span class="material-symbols-outlined text-sm">add</span>
                                Add Product
                            </button>
                            <button class="btn-sm btn-outline">
                                <span class="material-symbols-outlined text-sm">upload</span>
                                Import CSV
                            </button>
                            <button class="btn-sm btn-primary">
                                <span class="material-symbols-outlined text-sm">download</span>
                                Export Report
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Inventory Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Total Products</p>
                                <p class="text-2xl font-bold text-gray-900">453</p>
                                <p class="text-xs text-green-600">+12 this month</p>
                            </div>
                            <div class="stat-icon bg-blue-100">
                                <span class="material-symbols-outlined text-blue-600">inventory</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Low Stock Items</p>
                                <p class="text-2xl font-bold text-gray-900">23</p>
                                <p class="text-xs text-red-600">Needs attention</p>
                            </div>
                            <div class="stat-icon bg-red-100">
                                <span class="material-symbols-outlined text-red-600">warning</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Total Value</p>
                                <p class="text-2xl font-bold text-gray-900">₿2.1M</p>
                                <p class="text-xs text-gray-500">Inventory value</p>
                            </div>
                            <div class="stat-icon bg-green-100">
                                <span class="material-symbols-outlined text-green-600">account_balance</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Top Seller</p>
                                <p class="text-2xl font-bold text-gray-900">Pro V1</p>
                                <p class="text-xs text-green-600">145 sold this month</p>
                            </div>
                            <div class="stat-icon bg-yellow-100">
                                <span class="material-symbols-outlined text-yellow-600">star</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Table -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Product Inventory</h3>
                        <div class="flex gap-2">
                            <select class="form-select text-sm">
                                <option>All Categories</option>
                                <option>Golf Clubs</option>
                                <option>Golf Balls</option>
                                <option>Apparel</option>
                                <option>Accessories</option>
                                <option>Beverages</option>
                            </select>
                            <select class="form-select text-sm">
                                <option>All Stock Levels</option>
                                <option>Low Stock (&lt;10)</option>
                                <option>Medium Stock (10-50)</option>
                                <option>High Stock (&gt;50)</option>
                            </select>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="table-header">Product</th>
                                    <th class="table-header">SKU</th>
                                    <th class="table-header">Category</th>
                                    <th class="table-header">Stock</th>
                                    <th class="table-header">Price</th>
                                    <th class="table-header">Status</th>
                                    <th class="table-header">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <tr>
                                    <td class="table-cell">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-blue-100 rounded flex items-center justify-center">
                                                <span class="material-symbols-outlined text-blue-600">golf_course</span>
                                            </div>
                                            <div>
                                                <p class="font-medium">Driver - Titleist TSR3</p>
                                                <p class="text-sm text-gray-600">Premium driver club</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="table-cell font-mono text-sm">CLUB001</td>
                                    <td class="table-cell">Golf Clubs</td>
                                    <td class="table-cell">
                                        <span class="px-2 py-1 bg-red-100 text-red-800 text-sm rounded-full">8 units</span>
                                    </td>
                                    <td class="table-cell font-bold">₿12,500</td>
                                    <td class="table-cell">
                                        <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">Low Stock</span>
                                    </td>
                                    <td class="table-cell">
                                        <div class="flex space-x-2">
                                            <button class="btn-sm btn-outline">Edit</button>
                                            <button class="btn-sm btn-outline">Reorder</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="table-cell">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-yellow-100 rounded flex items-center justify-center">
                                                <span class="material-symbols-outlined text-yellow-600">sports_golf</span>
                                            </div>
                                            <div>
                                                <p class="font-medium">Pro V1 Golf Balls (12)</p>
                                                <p class="text-sm text-gray-600">Premium golf balls</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="table-cell font-mono text-sm">BALL001</td>
                                    <td class="table-cell">Golf Balls</td>
                                    <td class="table-cell">
                                        <span class="px-2 py-1 bg-green-100 text-green-800 text-sm rounded-full">45 units</span>
                                    </td>
                                    <td class="table-cell font-bold">₿1,800</td>
                                    <td class="table-cell">
                                        <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">In Stock</span>
                                    </td>
                                    <td class="table-cell">
                                        <div class="flex space-x-2">
                                            <button class="btn-sm btn-outline">Edit</button>
                                            <button class="btn-sm btn-outline">Reorder</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="table-cell">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-red-100 rounded flex items-center justify-center">
                                                <span class="material-symbols-outlined text-red-600">checkroom</span>
                                            </div>
                                            <div>
                                                <p class="font-medium">Nike Polo Shirt</p>
                                                <p class="text-sm text-gray-600">Moisture-wicking polo</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="table-cell font-mono text-sm">APPAREL001</td>
                                    <td class="table-cell">Apparel</td>
                                    <td class="table-cell">
                                        <span class="px-2 py-1 bg-green-100 text-green-800 text-sm rounded-full">25 units</span>
                                    </td>
                                    <td class="table-cell font-bold">₿2,200</td>
                                    <td class="table-cell">
                                        <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">In Stock</span>
                                    </td>
                                    <td class="table-cell">
                                        <div class="flex space-x-2">
                                            <button class="btn-sm btn-outline">Edit</button>
                                            <button class="btn-sm btn-outline">Reorder</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sales Reports Tab -->
            <div id="proshop-sales" class="tab-content hidden">
                <div class="mb-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <h2 class="text-2xl font-bold text-gray-900">Sales Reports</h2>
                        <div class="flex flex-wrap gap-3">
                            <select class="form-select text-sm">
                                <option>Today</option>
                                <option>This Week</option>
                                <option>This Month</option>
                                <option>Custom Range</option>
                            </select>
                            <button class="btn-sm btn-primary">
                                <span class="material-symbols-outlined text-sm">download</span>
                                Export
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sales Summary -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Today's Sales</p>
                                <p class="text-2xl font-bold text-gray-900">₿45,280</p>
                                <p class="text-xs text-green-600">+8% vs yesterday</p>
                            </div>
                            <div class="stat-icon bg-green-100">
                                <span class="material-symbols-outlined text-green-600">trending_up</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Transactions</p>
                                <p class="text-2xl font-bold text-gray-900">28</p>
                                <p class="text-xs text-blue-600">5 in last hour</p>
                            </div>
                            <div class="stat-icon bg-blue-100">
                                <span class="material-symbols-outlined text-blue-600">receipt</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Avg. Sale</p>
                                <p class="text-2xl font-bold text-gray-900">₿1,617</p>
                                <p class="text-xs text-gray-500">Per transaction</p>
                            </div>
                            <div class="stat-icon bg-purple-100">
                                <span class="material-symbols-outlined text-purple-600">calculate</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Top Category</p>
                                <p class="text-2xl font-bold text-gray-900">Balls</p>
                                <p class="text-xs text-green-600">42% of sales</p>
                            </div>
                            <div class="stat-icon bg-yellow-100">
                                <span class="material-symbols-outlined text-yellow-600">category</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Transactions</h3>
                        <button class="btn-sm btn-outline">View All</button>
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-4">
                                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                    <span class="material-symbols-outlined text-green-600">check_circle</span>
                                </div>
                                <div>
                                    <p class="font-medium">Transaction #1247</p>
                                    <p class="text-sm text-gray-600">Pro V1 Golf Balls x2, Sports Drink x1</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold">₿3,645</p>
                                <p class="text-sm text-gray-500">2 min ago</p>
                            </div>
                        </div>

                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-4">
                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                    <span class="material-symbols-outlined text-blue-600">credit_card</span>
                                </div>
                                <div>
                                    <p class="font-medium">Transaction #1246</p>
                                    <p class="text-sm text-gray-600">Nike Polo Shirt, Adidas Golf Shoes</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold">₿7,000</p>
                                <p class="text-sm text-gray-500">15 min ago</p>
                            </div>
                        </div>

                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-4">
                                <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                    <span class="material-symbols-outlined text-purple-600">payments</span>
                                </div>
                                <div>
                                    <p class="font-medium">Transaction #1245</p>
                                    <p class="text-sm text-gray-600">Driver - Titleist TSR3</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold">₿12,500</p>
                                <p class="text-sm text-gray-500">45 min ago</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customers Tab -->
            <div id="proshop-customers" class="tab-content hidden">
                <div class="mb-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <h2 class="text-2xl font-bold text-gray-900">Customer Management</h2>
                        <div class="flex flex-wrap gap-3">
                            <div class="relative">
                                <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</span>
                                <input type="text" placeholder="Search customers..." class="form-input pl-10 text-sm" />
                            </div>
                            <button class="btn-sm btn-primary">
                                <span class="material-symbols-outlined text-sm">add</span>
                                Add Customer
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Customer Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Total Customers</p>
                                <p class="text-2xl font-bold text-gray-900">1,247</p>
                                <p class="text-xs text-green-600">+23 this month</p>
                            </div>
                            <div class="stat-icon bg-blue-100">
                                <span class="material-symbols-outlined text-blue-600">people</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">VIP Customers</p>
                                <p class="text-2xl font-bold text-gray-900">89</p>
                                <p class="text-xs text-yellow-600">High value customers</p>
                            </div>
                            <div class="stat-icon bg-yellow-100">
                                <span class="material-symbols-outlined text-yellow-600">star</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Avg. Purchase</p>
                                <p class="text-2xl font-bold text-gray-900">₿2,350</p>
                                <p class="text-xs text-green-600">Per customer</p>
                            </div>
                            <div class="stat-icon bg-green-100">
                                <span class="material-symbols-outlined text-green-600">account_balance_wallet</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer List -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Customer Database</h3>
                        <select class="form-select text-sm">
                            <option>All Customers</option>
                            <option>VIP Customers</option>
                            <option>Recent Purchases</option>
                            <option>High Spenders</option>
                        </select>
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">JM</div>
                                <div>
                                    <p class="font-medium">John Mitchell</p>
                                    <p class="text-sm text-gray-600">john.mitchell@email.com • +66-xx-xxx-xxxx</p>
                                    <p class="text-xs text-gray-500">Member since March 2023</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full mb-2 inline-block">VIP</span>
                                <p class="font-bold">₿45,600</p>
                                <p class="text-sm text-gray-500">Total spent</p>
                            </div>
                        </div>

                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">SW</div>
                                <div>
                                    <p class="font-medium">Sarah Wilson</p>
                                    <p class="text-sm text-gray-600">sarah.wilson@email.com • +66-xx-xxx-xxxx</p>
                                    <p class="text-xs text-gray-500">Member since January 2024</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full mb-2 inline-block">Regular</span>
                                <p class="font-bold">₿12,400</p>
                                <p class="text-sm text-gray-500">Total spent</p>
                            </div>
                        </div>

                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center text-white font-bold">RC</div>
                                <div>
                                    <p class="font-medium">Robert Chen</p>
                                    <p class="text-sm text-gray-600">robert.chen@email.com • +66-xx-xxx-xxxx</p>
                                    <p class="text-xs text-gray-500">Member since November 2023</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full mb-2 inline-block">VIP</span>
                                <p class="font-bold">₿32,800</p>
                                <p class="text-sm text-gray-500">Total spent</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="proshop-settings" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Pro Shop Settings</h2>
                    <p class="text-gray-600">Configure POS system and shop preferences</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- POS Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">POS Configuration</h3>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="form-label">Shop Name</label>
                                <input type="text" class="form-input" value="Pattaya Golf Pro Shop" />
                            </div>
                            <div>
                                <label class="form-label">Tax Rate (%)</label>
                                <input type="number" class="form-input" value="7" step="0.1" />
                            </div>
                            <div>
                                <label class="form-label">Receipt Footer</label>
                                <textarea class="form-textarea" rows="3">Thank you for shopping at Pattaya Golf Pro Shop! Have a great round!</textarea>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium">Print Receipts Automatically</p>
                                    <p class="text-sm text-gray-600">Auto-print receipt after each sale</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" checked class="sr-only peer" />
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Alerts -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Inventory Alerts</h3>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="form-label">Low Stock Threshold</label>
                                <input type="number" class="form-input" value="10" />
                                <p class="text-xs text-gray-500 mt-1">Alert when stock falls below this number</p>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium">Email Notifications</p>
                                    <p class="text-sm text-gray-600">Send email alerts for low stock items</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" checked class="sr-only peer" />
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium">Auto-Reorder Suggestions</p>
                                    <p class="text-sm text-gray-600">Suggest reorders based on sales trends</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" />
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Payment Methods</h3>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <span class="material-symbols-outlined text-gray-600">payments</span>
                                    <span class="font-medium">Cash Payments</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" checked class="sr-only peer" />
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <span class="material-symbols-outlined text-gray-600">credit_card</span>
                                    <span class="font-medium">Card Payments</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" checked class="sr-only peer" />
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <span class="material-symbols-outlined text-gray-600">account_balance</span>
                                    <span class="font-medium">Member Account Charging</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" checked class="sr-only peer" />
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Discount Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Discounts & Promotions</h3>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="form-label">VIP Discount (%)</label>
                                <input type="number" class="form-input" value="10" step="0.5" />
                            </div>
                            <div>
                                <label class="form-label">Staff Discount (%)</label>
                                <input type="number" class="form-input" value="15" step="0.5" />
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium">Happy Hour Discount</p>
                                    <p class="text-sm text-gray-600">5% off drinks 3-5 PM</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" />
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Settings -->
                <div class="mt-8 flex justify-end space-x-4">
                    <button class="btn-outline">Reset to Default</button>
                    <button class="btn-primary">Save Settings</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Maintenance Dashboard -->
    <div id="maintenanceDashboard" class="screen">
        <header class="nav-header">
            <div class="max-w-7xl mx-auto px-4 lg:px-8">
                <div class="flex justify-between items-center py-3 md:py-5">
                    <div class="flex items-center space-x-2 md:space-x-4">
                        <img class="user-avatar" style="display: none;">
                        <div>
                            <h1 class="text-base md:text-xl font-bold text-gray-900" data-i18n="maintenance.title">Maintenance Dashboard</h1>
                            <p class="text-xs md:text-sm text-gray-600"><span data-i18n="maintenance.welcome">Welcome back, Maintenance</span> <span class="user-name-display">Maintenance</span> <span class="user-username-display text-gray-500"></span>!</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="sendEmergencyAlert()" class="emergency-btn" title="Emergency Alert">
                            <span class="material-symbols-outlined">emergency</span>
                        </button>
                        <button onclick="window.openProfessionalChat()" class="btn-primary relative" style="background: #10b981; padding: 10px 16px;" title="Chat">
                            <span class="material-symbols-outlined text-sm">chat</span>
                            <span data-i18n="common.chat">Chat</span>
                            <span id="chatBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-medium" style="display: none;">0</span>
                        </button>
                        <button onclick="logout()" class="btn-logout">
                            <span class="material-symbols-outlined text-sm">logout</span>
                            <span data-i18n="common.logout">Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Maintenance Navigation -->
        <nav class="tab-navigation border-b">
            <div class="max-w-7xl mx-auto px-4 lg:px-8">
                <div class="flex space-x-2 md:space-x-8 overflow-x-auto">
                    <button onclick="showMaintenanceTab('overview', event)" class="tab-button active px-2 md:px-4" id="maintenance-overview-tab">
                        <span class="material-symbols-outlined text-sm">dashboard</span>
                        <span class="hidden sm:inline ml-1" data-i18n="maintenance.overview">Overview</span>
                    </button>
                    <button onclick="showMaintenanceTab('course-updates', event)" class="tab-button px-2 md:px-4" id="maintenance-course-updates-tab">
                        <span class="material-symbols-outlined text-sm">photo_camera</span>
                        <span class="hidden sm:inline ml-1" data-i18n="maintenance.course.updates">Course Updates</span>
                    </button>
                    <button onclick="showMaintenanceTab('tasks', event)" class="tab-button px-2 md:px-4" id="maintenance-tasks-tab">
                        <span class="material-symbols-outlined text-sm">task</span>
                        <span class="hidden sm:inline ml-1" data-i18n="maintenance.tasks">Task Management</span>
                    </button>
                    <button onclick="showMaintenanceTab('equipment', event)" class="tab-button px-2 md:px-4" id="maintenance-equipment-tab">
                        <span class="material-symbols-outlined text-sm">build</span>
                        <span class="hidden sm:inline ml-1" data-i18n="maintenance.equipment">Equipment</span>
                    </button>
                    <button onclick="showMaintenanceTab('schedule', event)" class="tab-button px-2 md:px-4" id="maintenance-schedule-tab">
                        <span class="material-symbols-outlined text-sm">schedule</span>
                        <span class="hidden sm:inline ml-1" data-i18n="maintenance.schedule">Schedule</span>
                    </button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-6 lg:px-8 py-8">
            <!-- Overview Tab -->
            <div id="maintenance-overview" class="tab-content active">
                <!-- Maintenance Hero Section -->
                <div class="hero-section bg-gradient-to-r from-green-600 to-emerald-700 text-white rounded-3xl p-8 mb-8">
                    <div class="flex flex-col lg:flex-row justify-between items-center">
                        <div class="text-center lg:text-left mb-6 lg:mb-0">
                            <h2 class="text-2xl font-bold mb-2">Course Maintenance</h2>
                            <p class="text-green-100 text-lg">Professional Golf Course Care</p>
                            <div class="flex flex-wrap justify-center lg:justify-start gap-6 mt-4 text-sm">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-lg">grass</span>
                                    <span>4 Courses Active</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-lg">task_alt</span>
                                    <span>12 Tasks Today</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-lg">group</span>
                                    <span>8 Crew Members</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-bold">95%</div>
                            <div class="text-green-200">Course Condition</div>
                            <div class="text-sm text-green-200 mt-1">Excellent rating</div>
                        </div>
                    </div>
                </div>

                <!-- Persistent Emergency Alerts -->
                <div id="maintenance-emergency-alerts" class="persistent-emergency-alerts mb-6" style="display: none;">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <span class="material-symbols-outlined text-red-600">emergency</span>
                                <h3 class="text-lg font-bold text-red-800">Active Emergency Alerts</h3>
                            </div>
                            <span id="maintenance-alert-count" class="bg-red-600 text-white text-xs px-2 py-1 rounded-full font-medium">0</span>
                        </div>
                        <div id="maintenance-alert-list" class="space-y-2">
                            <!-- Emergency alerts will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stats-card bg-white rounded-2xl p-6 border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-green-100 rounded-xl">
                                <span class="material-symbols-outlined text-2xl text-green-600">grass</span>
                            </div>
                            <span class="text-2xl font-bold text-gray-800">18</span>
                        </div>
                        <h3 class="text-sm font-medium text-gray-600 mb-1">Holes Maintained</h3>
                        <p class="text-xs text-green-600">+2 this week</p>
                    </div>

                    <div class="stats-card bg-white rounded-2xl p-6 border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-blue-100 rounded-xl">
                                <span class="material-symbols-outlined text-2xl text-blue-600">water_drop</span>
                            </div>
                            <span class="text-2xl font-bold text-gray-800">6.2</span>
                        </div>
                        <h3 class="text-sm font-medium text-gray-600 mb-1">Water Usage (hrs)</h3>
                        <p class="text-xs text-blue-600">Optimal level</p>
                    </div>

                    <div class="stats-card bg-white rounded-2xl p-6 border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-yellow-100 rounded-xl">
                                <span class="material-symbols-outlined text-2xl text-yellow-600">build</span>
                            </div>
                            <span class="text-2xl font-bold text-gray-800">3</span>
                        </div>
                        <h3 class="text-sm font-medium text-gray-600 mb-1">Equipment Issues</h3>
                        <p class="text-xs text-yellow-600">Needs attention</p>
                    </div>

                    <div class="stats-card bg-white rounded-2xl p-6 border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-purple-100 rounded-xl">
                                <span class="material-symbols-outlined text-2xl text-purple-600">schedule</span>
                            </div>
                            <span class="text-2xl font-bold text-gray-800">8</span>
                        </div>
                        <h3 class="text-sm font-medium text-gray-600 mb-1">Pending Tasks</h3>
                        <p class="text-xs text-purple-600">Due today</p>
                    </div>
                </div>

                <!-- Today's Tasks -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-2xl p-6 border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-6">Today's Priority Tasks</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 bg-red-50 rounded-xl border border-red-100">
                                <div class="flex items-center space-x-4">
                                    <div class="p-2 bg-red-100 rounded-lg">
                                        <span class="material-symbols-outlined text-red-600">grass</span>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-gray-800">Greens Cutting - Course A</h4>
                                        <p class="text-sm text-gray-600">Holes 1-9 greens maintenance</p>
                                    </div>
                                </div>
                                <span class="px-3 py-1 bg-red-100 text-red-700 text-xs font-medium rounded-full">High</span>
                            </div>

                            <div class="flex items-center justify-between p-4 bg-yellow-50 rounded-xl border border-yellow-100">
                                <div class="flex items-center space-x-4">
                                    <div class="p-2 bg-yellow-100 rounded-lg">
                                        <span class="material-symbols-outlined text-yellow-600">water_drop</span>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-gray-800">Bunker Maintenance</h4>
                                        <p class="text-sm text-gray-600">Sand replacement holes 5, 12, 16</p>
                                    </div>
                                </div>
                                <span class="px-3 py-1 bg-yellow-100 text-yellow-700 text-xs font-medium rounded-full">Medium</span>
                            </div>

                            <div class="flex items-center justify-between p-4 bg-blue-50 rounded-xl border border-blue-100">
                                <div class="flex items-center space-x-4">
                                    <div class="p-2 bg-blue-100 rounded-lg">
                                        <span class="material-symbols-outlined text-blue-600">build</span>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-gray-800">Equipment Check</h4>
                                        <p class="text-sm text-gray-600">Daily inspection of mowers</p>
                                    </div>
                                </div>
                                <span class="px-3 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full">Low</span>
                            </div>
                        </div>
                    </div>

                    <!-- Weather & Conditions -->
                    <div class="bg-white rounded-2xl p-6 border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-6">Weather & Course Conditions</h3>

                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <span class="material-symbols-outlined text-2xl text-yellow-500">wb_sunny</span>
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Sunny</h4>
                                        <p class="text-sm text-gray-600">Perfect for maintenance</p>
                                    </div>
                                </div>
                                <span class="text-2xl font-bold text-gray-800">28°C</span>
                            </div>

                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Humidity:</span>
                                    <span class="font-medium">65%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Wind:</span>
                                    <span class="font-medium">12 km/h</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">UV Index:</span>
                                    <span class="font-medium">High</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Rain Chance:</span>
                                    <span class="font-medium">5%</span>
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-gray-100">
                            <h4 class="font-medium text-gray-800 mb-3">Course Status</h4>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Course A (Holes 1-9)</span>
                                    <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-medium rounded">Excellent</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Course B (Holes 10-18)</span>
                                    <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-medium rounded">Excellent</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Practice Range</span>
                                    <span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs font-medium rounded">Good</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Putting Green</span>
                                    <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-medium rounded">Excellent</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Course Updates Tab (Photo Upload) -->
            <div id="maintenance-course-updates" class="tab-content">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Live Course Updates</h2>
                    <p class="text-gray-600">Report course conditions with photos and detailed descriptions</p>
                </div>

                <!-- Course Update Form -->
                <div class="bg-white rounded-2xl p-6 border border-gray-100 mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-6">Submit Course Update</h3>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Left Column - Course Selection -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Course Section</label>
                                <select id="courseSection" class="form-select w-full">
                                    <option value="">Select course section...</option>
                                    <option value="A">Course A (Holes 1-9)</option>
                                    <option value="B">Course B (Holes 10-18)</option>
                                    <option value="C">Course C (Practice Range)</option>
                                    <option value="D">Course D (Putting Green)</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hole Number</label>
                                <select id="holeNumber" class="form-select w-full">
                                    <option value="">Select hole number...</option>
                                    <!-- Options will be populated based on course selection -->
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Area Type</label>
                                <select id="areaType" class="form-select w-full">
                                    <option value="">Select area type...</option>
                                    <option value="tee-box">Tee Box</option>
                                    <option value="fairway">Fairway</option>
                                    <option value="rough">Rough</option>
                                    <option value="fairway-bunker">Fairway Bunker</option>
                                    <option value="greenside-bunker">Greenside Bunker</option>
                                    <option value="green">Green</option>
                                    <option value="flag-cup">Flag and Cup</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Issue Priority</label>
                                <select id="issuePriority" class="form-select w-full">
                                    <option value="low">Low - Routine maintenance</option>
                                    <option value="medium">Medium - Needs attention</option>
                                    <option value="high">High - Urgent repair</option>
                                    <option value="critical">Critical - Safety concern</option>
                                </select>
                            </div>
                        </div>

                        <!-- Right Column - Description & Photo -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea id="issueDescription" rows="6" class="form-input w-full" placeholder="Describe the issue or condition in detail..."></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Photos</label>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors">
                                    <input type="file" id="coursePhotos" multiple accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
                                    <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">photo_camera</span>
                                    <p class="text-gray-600 mb-2">Click to upload photos or drag and drop</p>
                                    <button type="button" onclick="document.getElementById('coursePhotos').click()" class="btn-primary">
                                        <span class="material-symbols-outlined text-sm">upload</span>
                                        Choose Photos
                                    </button>
                                </div>
                                <div id="photoPreview" class="grid grid-cols-2 gap-2 mt-4"></div>
                            </div>

                            <button onclick="submitCourseUpdate()" class="btn-primary w-full">
                                <span class="material-symbols-outlined text-sm">send</span>
                                Submit Course Update
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Recent Updates -->
                <div class="bg-white rounded-2xl p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">Recent Course Updates</h3>
                        <select class="form-select" style="width: auto;">
                            <option value="all">All Courses</option>
                            <option value="A">Course A</option>
                            <option value="B">Course B</option>
                            <option value="C">Course C</option>
                            <option value="D">Course D</option>
                        </select>
                    </div>

                    <div id="recentUpdates" class="space-y-4">
                        <!-- Sample updates will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Other maintenance tabs will be added here -->
            <div id="maintenance-tasks" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Task Management</h2>
                <p class="text-gray-600">Coming soon - Comprehensive task management system</p>
            </div>

            <div id="maintenance-equipment" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Equipment Management</h2>
                <p class="text-gray-600">Coming soon - Equipment tracking and maintenance</p>
            </div>

            <div id="maintenance-schedule" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Maintenance Schedule</h2>
                <p class="text-gray-600">Coming soon - Scheduling system for maintenance activities</p>
            </div>
        </main>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="screen">
        <header class="nav-header">
            <div class="max-w-7xl mx-auto px-4 lg:px-8">
                <div class="flex justify-between items-center py-3 md:py-5">
                    <div class="flex items-center space-x-2 md:space-x-4">
                        <span class="material-symbols-outlined text-2xl text-red-600">admin_panel_settings</span>
                        <div>
                            <h1 class="text-base md:text-xl font-bold text-gray-900">Admin Dashboard</h1>
                            <p class="text-xs md:text-sm text-gray-600">Platform Management & Control</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 md:space-x-4">
                        <button onclick="AdminSystem.refreshData()" class="btn-secondary text-xs md:text-sm">
                            <span class="material-symbols-outlined text-sm">refresh</span>
                            Refresh
                        </button>
                        <button onclick="logout()" class="btn-secondary text-xs md:text-sm">
                            <span class="material-symbols-outlined text-sm">logout</span>
                            <span class="hidden md:inline">Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 lg:px-8 py-6">
            <!-- Admin Navigation Tabs -->
            <div class="bg-white rounded-xl shadow-sm mb-6 overflow-x-auto">
                <div class="flex border-b border-gray-200 min-w-max">
                    <button onclick="showAdminTab('overview')" id="admin-overview-tab" class="admin-tab-button active px-4 md:px-6 py-3 text-sm font-medium border-b-2 border-primary-600 text-primary-600">
                        <span class="material-symbols-outlined text-sm mr-1">dashboard</span>
                        Overview
                    </button>
                    <button onclick="showAdminTab('users')" id="admin-users-tab" class="admin-tab-button px-4 md:px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-900">
                        <span class="material-symbols-outlined text-sm mr-1">people</span>
                        Users
                    </button>
                    <button onclick="showAdminTab('subscriptions')" id="admin-subscriptions-tab" class="admin-tab-button px-4 md:px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-900">
                        <span class="material-symbols-outlined text-sm mr-1">credit_card</span>
                        Subscriptions
                    </button>
                    <button onclick="showAdminTab('societies')" id="admin-societies-tab" class="admin-tab-button px-4 md:px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-900">
                        <span class="material-symbols-outlined text-sm mr-1">groups</span>
                        Golf Societies
                    </button>
                    <button onclick="showAdminTab('courses')" id="admin-courses-tab" class="admin-tab-button px-4 md:px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-900">
                        <span class="material-symbols-outlined text-sm mr-1">golf_course</span>
                        Golf Courses
                    </button>
                    <button onclick="showAdminTab('analytics')" id="admin-analytics-tab" class="admin-tab-button px-4 md:px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-900">
                        <span class="material-symbols-outlined text-sm mr-1">analytics</span>
                        Analytics
                    </button>
                    <button onclick="showAdminTab('settings')" id="admin-settings-tab" class="admin-tab-button px-4 md:px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-900">
                        <span class="material-symbols-outlined text-sm mr-1">settings</span>
                        Settings
                    </button>
                </div>
            </div>

            <!-- Admin Overview Tab -->
            <div id="admin-overview" class="admin-tab-content active">
                <!-- Platform Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="metric-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Total Users</p>
                                <p class="text-2xl font-bold text-gray-900" id="admin-total-users">0</p>
                                <p class="text-xs text-green-600 mt-1">All roles</p>
                            </div>
                            <div class="stat-icon bg-blue-100">
                                <span class="material-symbols-outlined text-blue-600">people</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Monthly Revenue</p>
                                <p class="text-2xl font-bold text-gray-900" id="admin-monthly-revenue">฿0</p>
                                <p class="text-xs text-green-600 mt-1">Subscriptions</p>
                            </div>
                            <div class="stat-icon bg-green-100">
                                <span class="material-symbols-outlined text-green-600">payments</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Golf Societies</p>
                                <p class="text-2xl font-bold text-gray-900" id="admin-societies-count">0</p>
                                <p class="text-xs text-orange-600 mt-1">Active societies</p>
                            </div>
                            <div class="stat-icon bg-orange-100">
                                <span class="material-symbols-outlined text-orange-600">groups</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Active Today</p>
                                <p class="text-2xl font-bold text-gray-900" id="admin-active-today">0</p>
                                <p class="text-xs text-purple-600 mt-1">Daily users</p>
                            </div>
                            <div class="stat-icon bg-purple-100">
                                <span class="material-symbols-outlined text-purple-600">trending_up</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="metric-card">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Recent Signups</h3>
                        <div id="admin-recent-signups" class="space-y-3">
                            <div class="text-center text-gray-500 py-8">Loading...</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Platform Alerts</h3>
                        <div id="admin-platform-alerts" class="space-y-3">
                            <div class="flex items-start space-x-3 p-3 bg-green-50 rounded-lg">
                                <span class="material-symbols-outlined text-green-600">check_circle</span>
                                <div>
                                    <p class="text-sm font-medium text-green-900">System Online</p>
                                    <p class="text-xs text-green-600">All services operational</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Users Tab -->
            <div id="admin-users" class="admin-tab-content">
                <div class="metric-card mb-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                        <h3 class="text-xl font-bold text-gray-900">User Management</h3>
                        <div class="flex flex-wrap gap-2">
                            <input type="text" id="admin-user-search" placeholder="Search users..." class="px-4 py-2 border border-gray-300 rounded-lg text-sm" onkeyup="AdminSystem.filterUsers()">
                            <select id="admin-user-role-filter" class="px-4 py-2 border border-gray-300 rounded-lg text-sm" onchange="AdminSystem.filterUsers()">
                                <option value="">All Roles</option>
                                <option value="golfer">Golfers</option>
                                <option value="caddie">Caddies</option>
                                <option value="manager">Managers</option>
                                <option value="proshop">ProShop</option>
                            </select>
                            <button onclick="AdminSystem.exportUsers()" class="btn-primary text-sm">
                                <span class="material-symbols-outlined text-sm">download</span>
                                Export CSV
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">User</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Role</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Subscription</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Status</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Joined</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-users-table">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-gray-500">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin Subscriptions Tab -->
            <div id="admin-subscriptions" class="admin-tab-content">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="metric-card text-center">
                        <div class="font-bold text-2xl text-gray-900" id="admin-free-count">0</div>
                        <div class="text-sm text-gray-600 mt-2">Free Tier</div>
                        <div class="text-xs text-gray-400 mt-1">฿0/month</div>
                    </div>
                    <div class="metric-card text-center">
                        <div class="font-bold text-2xl text-blue-600" id="admin-silver-count">0</div>
                        <div class="text-sm text-gray-600 mt-2">Silver Tier</div>
                        <div class="text-xs text-gray-400 mt-1" id="admin-silver-revenue">฿0/month</div>
                    </div>
                    <div class="metric-card text-center">
                        <div class="font-bold text-2xl text-yellow-600" id="admin-gold-count">0</div>
                        <div class="text-sm text-gray-600 mt-2">Gold Tier</div>
                        <div class="text-xs text-gray-400 mt-1" id="admin-gold-revenue">฿0/month</div>
                    </div>
                    <div class="metric-card text-center">
                        <div class="font-bold text-2xl text-purple-600" id="admin-platinum-count">0</div>
                        <div class="text-sm text-gray-600 mt-2">Platinum Tier</div>
                        <div class="text-xs text-gray-400 mt-1" id="admin-platinum-revenue">฿0/month</div>
                    </div>
                </div>

                <div class="metric-card">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Subscription Details</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">User</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Tier</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Amount</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Next Billing</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Status</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-subscriptions-table">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-gray-500">Loading subscriptions...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin Golf Societies Tab -->
            <div id="admin-societies" class="admin-tab-content">
                <!-- Society Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="metric-card text-center">
                        <div class="font-bold text-2xl text-gray-900" id="admin-societies-total">0</div>
                        <div class="text-sm text-gray-600 mt-2">Total Societies</div>
                        <div class="text-xs text-gray-400 mt-1">All registered</div>
                    </div>
                    <div class="metric-card text-center">
                        <div class="font-bold text-2xl text-green-600" id="admin-societies-active">0</div>
                        <div class="text-sm text-gray-600 mt-2">Active Societies</div>
                        <div class="text-xs text-gray-400 mt-1">Events this month</div>
                    </div>
                    <div class="metric-card text-center">
                        <div class="font-bold text-2xl text-blue-600" id="admin-societies-members">0</div>
                        <div class="text-sm text-gray-600 mt-2">Total Members</div>
                        <div class="text-xs text-gray-400 mt-1">Across all societies</div>
                    </div>
                    <div class="metric-card text-center">
                        <div class="font-bold text-2xl text-purple-600" id="admin-societies-events">0</div>
                        <div class="text-sm text-gray-600 mt-2">Events This Month</div>
                        <div class="text-xs text-gray-400 mt-1">Scheduled rounds</div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Golf Societies Management</h3>
                        <div class="flex flex-wrap gap-2">
                            <input type="text" id="admin-society-search" placeholder="Search societies..." class="px-4 py-2 border border-gray-300 rounded-lg text-sm" onkeyup="AdminSystem.filterSocieties()">
                            <select id="admin-society-status-filter" class="px-4 py-2 border border-gray-300 rounded-lg text-sm" onchange="AdminSystem.filterSocieties()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                            <button onclick="AdminSystem.addSociety()" class="btn-primary text-sm">
                                <span class="material-symbols-outlined text-sm">add</span>
                                Add Society
                            </button>
                            <button onclick="AdminSystem.exportSocieties()" class="btn-secondary text-sm">
                                <span class="material-symbols-outlined text-sm">download</span>
                                Export
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Society Name</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Organizer</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Members</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Events</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Next Event</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Status</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-societies-table">
                                <tr>
                                    <td colspan="7" class="text-center py-8 text-gray-500">Loading golf societies...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin Golf Courses Tab -->
            <div id="admin-courses" class="admin-tab-content">
                <div class="metric-card">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Golf Courses</h3>
                        <button onclick="AdminSystem.addCourse()" class="btn-primary">
                            <span class="material-symbols-outlined text-sm">add</span>
                            Add Course
                        </button>
                    </div>

                    <div id="admin-courses-list" class="space-y-4">
                        <div class="text-center text-gray-500 py-8">Loading courses...</div>
                    </div>
                </div>
            </div>

            <!-- Admin Analytics Tab -->
            <div id="admin-analytics" class="admin-tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="metric-card">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">User Growth</h3>
                        <div id="admin-user-growth-chart" class="h-64 flex items-center justify-center text-gray-500">
                            Chart placeholder - Growth trending up 📈
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Revenue Trends</h3>
                        <div id="admin-revenue-chart" class="h-64 flex items-center justify-center text-gray-500">
                            Chart placeholder - Revenue increasing 💰
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Booking Activity</h3>
                        <div id="admin-booking-chart" class="h-64 flex items-center justify-center text-gray-500">
                            Chart placeholder - Bookings by day 📅
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Top Courses</h3>
                        <div id="admin-top-courses" class="space-y-3">
                            <div class="text-gray-500 text-center py-8">Loading top courses...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Settings Tab -->
            <div id="admin-settings" class="admin-tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="metric-card">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Platform Status</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <span class="material-symbols-outlined text-green-600">check_circle</span>
                                    <span class="font-medium text-green-900">Platform Online</span>
                                </div>
                                <span class="text-sm text-green-600">All systems operational</span>
                            </div>
                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                <span class="font-medium text-gray-900">Maintenance Mode</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="admin-maintenance-toggle" class="sr-only peer" onchange="AdminSystem.toggleMaintenance()">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="metric-card">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Subscription Pricing</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Silver Tier (฿/month)</label>
                                <input type="number" id="admin-silver-price" value="299" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Gold Tier (฿/month)</label>
                                <input type="number" id="admin-gold-price" value="599" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Platinum Tier (฿/month)</label>
                                <input type="number" id="admin-platinum-price" value="999" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <button onclick="AdminSystem.savePricing()" class="btn-primary w-full">Save Pricing</button>
                        </div>
                    </div>

                    <div class="metric-card lg:col-span-2">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">System Actions</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button onclick="AdminSystem.clearCache()" class="btn-secondary flex items-center justify-center">
                                <span class="material-symbols-outlined text-sm mr-2">delete_sweep</span>
                                Clear Cache
                            </button>
                            <button onclick="AdminSystem.backupData()" class="btn-primary flex items-center justify-center">
                                <span class="material-symbols-outlined text-sm mr-2">backup</span>
                                Backup Data
                            </button>
                            <button onclick="AdminSystem.viewLogs()" class="btn-secondary flex items-center justify-center">
                                <span class="material-symbols-outlined text-sm mr-2">description</span>
                                View Logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ============================================== -->
    <!-- SOCIETY ORGANIZER DASHBOARD -->
    <!-- ============================================== -->
    <div id="societyOrganizerDashboard" class="screen">
        <header class="nav-header">
            <div class="max-w-7xl mx-auto px-4 lg:px-8">
                <div class="flex justify-between items-center py-3 md:py-5">
                    <div class="flex items-center space-x-2 md:space-x-4">
                        <!-- Society Logo (dynamic) -->
                        <div id="societyHeaderLogo">
                            <span class="material-symbols-outlined text-2xl text-sky-600">groups</span>
                        </div>
                        <div>
                            <h1 id="societyHeaderName" class="text-base md:text-xl font-bold text-gray-900">Society Organizer</h1>
                            <p class="text-xs md:text-sm text-gray-600">Manage Events, Registrations & Pairings</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 md:space-x-4">
                        <button onclick="SocietyOrganizerSystem.refreshEvents()" class="btn-secondary text-xs md:text-sm">
                            <span class="material-symbols-outlined text-sm">refresh</span>
                            <span class="hidden md:inline">Refresh</span>
                        </button>
                        <button onclick="logout()" class="btn-secondary text-xs md:text-sm">
                            <span class="material-symbols-outlined text-sm">logout</span>
                            <span class="hidden md:inline">Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 lg:px-8 py-6">
            <!-- Navigation Tabs -->
            <div class="bg-white rounded-xl shadow-sm mb-6 overflow-x-auto">
                <div class="flex border-b border-gray-200">
                    <button onclick="showOrganizerTab('events')" id="organizer-events-tab" class="organizer-tab-button active px-4 md:px-6 py-3 text-sm font-medium border-b-2 border-sky-600 text-sky-600">
                        <span class="material-symbols-outlined text-sm mr-1">event</span>
                        Events
                    </button>
                    <button onclick="showOrganizerTab('calendar')" id="organizer-calendar-tab" class="organizer-tab-button px-4 md:px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-900">
                        <span class="material-symbols-outlined text-sm mr-1">calendar_month</span>
                        Calendar
                    </button>
                    <button onclick="showOrganizerTab('scoring')" id="organizer-scoring-tab" class="organizer-tab-button px-4 md:px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-900">
                        <span class="material-symbols-outlined text-sm mr-1">emoji_events</span>
                        Scoring
                    </button>
                    <button onclick="showOrganizerTab('players')" id="organizer-players-tab" class="organizer-tab-button px-4 md:px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-900">
                        <span class="material-symbols-outlined text-sm mr-1">group</span>
                        Players
                    </button>
                    <button onclick="showOrganizerTab('profile')" id="organizer-profile-tab" class="organizer-tab-button px-4 md:px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-900">
                        <span class="material-symbols-outlined text-sm mr-1">badge</span>
                        Profile
                    </button>
                    <button onclick="showOrganizerTab('admin')" id="organizer-admin-tab" class="organizer-tab-button px-4 md:px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-900">
                        <span class="material-symbols-outlined text-sm mr-1">admin_panel_settings</span>
                        Admin
                    </button>
                </div>
            </div>


            <!-- Tab: Events -->
            <div id="organizerTab-events" class="organizer-tab-content">
                <!-- New Event Button -->
                <div class="flex justify-between items-center mb-6">
                    <div class="text-sm text-gray-600">
                        Create and manage your society golf events. Registrations and pairings are handled automatically.
                        <span class="text-xs text-green-600">✅ Real-time sync active</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="SocietyOrganizerSystem.refreshEvents()" class="btn-secondary">
                            <span class="material-symbols-outlined text-sm">refresh</span>
                            Refresh
                        </button>
                        <button onclick="SocietyOrganizerSystem.showEventForm(null)" class="btn-primary">
                            <span class="material-symbols-outlined text-sm">add</span>
                            New Event
                        </button>
                    </div>
                </div>

                <!-- Event Form (Hidden by default) -->
                <div id="eventFormContainer" class="mb-6" style="display: none;">
                    <div class="bg-white rounded-2xl shadow-lg border p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-900">
                                <span id="eventFormTitle">Create New Event</span>
                            </h3>
                            <button onclick="SocietyOrganizerSystem.hideEventForm()" class="text-gray-400 hover:text-gray-600">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Event Name -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Event Name</label>
                                <input type="text" id="eventName" class="w-full rounded-lg border px-3 py-2" placeholder="e.g., Monthly Medal Tournament">
                            </div>

                            <!-- Date -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Event Date</label>
                                <input type="date" id="eventDate" class="w-full rounded-lg border px-3 py-2">
                            </div>

                            <!-- Departure Time -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Departure Time</label>
                                <input type="time" id="eventStartTime" class="w-full rounded-lg border px-3 py-2">
                            </div>

                            <!-- Registration Cutoff -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Registration Cutoff</label>
                                <input type="datetime-local" id="eventCutoff" class="w-full rounded-lg border px-3 py-2">
                            </div>

                            <!-- Max Players -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Max Players</label>
                                <input type="number" id="eventMaxPlayers" min="1" class="w-full rounded-lg border px-3 py-2" placeholder="e.g., 40">
                            </div>

                            <!-- Course (required) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Golf Course <span class="text-red-500">*</span></label>
                                <select id="eventCourse" class="w-full rounded-lg border px-3 py-2" required>
                                    <option value="">Select Golf Course...</option>
                                    <option value="Pattana Golf">Pattana Golf</option>
                                    <option value="Siam Waterside">Siam Waterside</option>
                                    <option value="Siam Rolling Hills">Siam Rolling Hills</option>
                                    <option value="Siam Plantation">Siam Plantation</option>
                                    <option value="Siam Old Course">Siam Old Course</option>
                                    <option value="Pattaya CC">Pattaya CC</option>
                                    <option value="Hermes Golf">Hermes Golf</option>
                                    <option value="Patana Golf Resort">Patana Golf Resort</option>
                                    <option value="Burapha">Burapha</option>
                                    <option value="Lamchabang">Lamchabang</option>
                                    <option value="Pleasant Valley">Pleasant Valley</option>
                                    <option value="Green Valley">Green Valley</option>
                                    <option value="Silky Oaks">Silky Oaks</option>
                                    <option value="St. Andrews 2000">St. Andrews 2000</option>
                                    <option value="Pattavia">Pattavia</option>
                                    <option value="Phoenix">Phoenix</option>
                                    <option value="Bangkokong Riverside">Bangkokong Riverside</option>
                                    <option value="Royal Lakeside">Royal Lakeside</option>
                                    <option value="Pattaya Country Club">Pattaya Country Club</option>
                                    <option value="Khao Kheow">Khao Kheow</option>
                                    <option value="Treasure Hills">Treasure Hills</option>
                                    <option value="Eastern Star">Eastern Star</option>
                                </select>
                            </div>

                            <!-- Event Format -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Event Format</label>
                                <select id="eventFormat" class="w-full rounded-lg border px-3 py-2">
                                    <option value="strokeplay">Stroke Play</option>
                                    <option value="2man_scramble">2-Man Scramble</option>
                                    <option value="4man_scramble">4-Man Scramble</option>
                                    <option value="fourball">Four Ball</option>
                                    <option value="stableford">Stableford</option>
                                    <option value="monthly_medal">Monthly Medal Tournament</option>
                                    <option value="monthly_mug">Monthly Mug</option>
                                    <option value="psc_monthly">PSC Monthly Tournament</option>
                                    <option value="psc_annual">PSC Annual Tournament</option>
                                    <option value="ryder_cup">Ryder Cup</option>
                                    <option value="private">Private Game</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <!-- Fees Section -->
                            <div class="md:col-span-2">
                                <h4 class="text-sm font-semibold text-gray-900 mb-3">Event Fees (THB)</h4>

                                <!-- Member vs Non-Member Pricing -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Member Fee (All-Inclusive)</label>
                                        <input type="number" id="eventMemberFee" min="0" step="0.01" class="w-full rounded-lg border px-3 py-2 text-sm font-medium" placeholder="2250.00" required>
                                        <p class="text-xs text-gray-500 mt-1">Includes green fee, cart, caddy, etc.</p>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Non-Member Additional Fee</label>
                                        <input type="number" id="eventNonMemberFee" min="0" step="0.01" class="w-full rounded-lg border px-3 py-2 text-sm font-medium" placeholder="1000.00">
                                        <p class="text-xs text-gray-500 mt-1">Extra charge for non-members (e.g., ฿1000)</p>
                                    </div>
                                </div>

                                <!-- Optional Add-On Fees -->
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Transport Fee (Optional)</label>
                                        <input type="number" id="eventTransportFee" min="0" step="0.01" class="w-full rounded-lg border px-3 py-2 text-sm" placeholder="0">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Competition Fee (Optional)</label>
                                        <input type="number" id="eventCompetitionFee" min="0" step="0.01" class="w-full rounded-lg border px-3 py-2 text-sm" placeholder="0">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Other Fee (Optional)</label>
                                        <input type="number" id="eventOtherFee" min="0" step="0.01" class="w-full rounded-lg border px-3 py-2 text-sm" placeholder="0">
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">💡 Optional fees are added only when player selects them during registration</p>
                            </div>

                            <!-- Auto Waitlist -->
                            <div class="md:col-span-2">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="eventAutoWaitlist" class="w-4 h-4 text-sky-600 border-gray-300 rounded focus:ring-sky-500">
                                    <span class="text-sm font-medium text-gray-700">Enable Auto Waitlist (automatically promote waitlisted players when spots open)</span>
                                </label>
                            </div>

                            <!-- Recurring Event -->
                            <div class="md:col-span-2">
                                <label class="flex items-center gap-2 mb-3">
                                    <input type="checkbox" id="eventRecurring" class="w-4 h-4 text-sky-600 border-gray-300 rounded focus:ring-sky-500" onchange="toggleRecurringOptions()">
                                    <span class="text-sm font-medium text-gray-700">Repeat this event</span>
                                </label>

                                <div id="recurringOptions" class="ml-6 space-y-3" style="display: none;">
                                    <!-- Frequency -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Repeat</label>
                                            <select id="eventRecurFrequency" class="w-full rounded-lg border px-3 py-2 text-sm" onchange="updateRecurringPattern()">
                                                <option value="weekly">Weekly</option>
                                                <option value="biweekly">Every 2 weeks</option>
                                                <option value="monthly">Monthly</option>
                                            </select>
                                        </div>

                                        <!-- Day of Week (for weekly/biweekly) -->
                                        <div id="recurDayOfWeekContainer">
                                            <label class="block text-xs text-gray-600 mb-1">On</label>
                                            <select id="eventRecurDayOfWeek" class="w-full rounded-lg border px-3 py-2 text-sm">
                                                <option value="1">Monday</option>
                                                <option value="2">Tuesday</option>
                                                <option value="3">Wednesday</option>
                                                <option value="4">Thursday</option>
                                                <option value="5">Friday</option>
                                                <option value="6">Saturday</option>
                                                <option value="0">Sunday</option>
                                            </select>
                                        </div>

                                        <!-- Monthly Pattern -->
                                        <div id="recurMonthlyPatternContainer" style="display: none;" class="md:col-span-2">
                                            <label class="block text-xs text-gray-600 mb-1">Pattern</label>
                                            <select id="eventRecurMonthlyPattern" class="w-full rounded-lg border px-3 py-2 text-sm">
                                                <option value="first_monday">First Monday</option>
                                                <option value="first_tuesday">First Tuesday</option>
                                                <option value="first_wednesday">First Wednesday</option>
                                                <option value="first_thursday">First Thursday</option>
                                                <option value="first_friday">First Friday</option>
                                                <option value="first_saturday">First Saturday</option>
                                                <option value="first_sunday">First Sunday</option>
                                                <option value="second_monday">Second Monday</option>
                                                <option value="second_tuesday">Second Tuesday</option>
                                                <option value="second_wednesday">Second Wednesday</option>
                                                <option value="second_thursday">Second Thursday</option>
                                                <option value="second_friday">Second Friday</option>
                                                <option value="second_saturday">Second Saturday</option>
                                                <option value="second_sunday">Second Sunday</option>
                                                <option value="third_monday">Third Monday</option>
                                                <option value="third_tuesday">Third Tuesday</option>
                                                <option value="third_wednesday">Third Wednesday</option>
                                                <option value="third_thursday">Third Thursday</option>
                                                <option value="third_friday">Third Friday</option>
                                                <option value="third_saturday">Third Saturday</option>
                                                <option value="third_sunday">Third Sunday</option>
                                                <option value="fourth_monday">Fourth Monday</option>
                                                <option value="fourth_tuesday">Fourth Tuesday</option>
                                                <option value="fourth_wednesday">Fourth Wednesday</option>
                                                <option value="fourth_thursday">Fourth Thursday</option>
                                                <option value="fourth_friday">Fourth Friday</option>
                                                <option value="fourth_saturday">Fourth Saturday</option>
                                                <option value="fourth_sunday">Fourth Sunday</option>
                                                <option value="last_monday">Last Monday</option>
                                                <option value="last_tuesday">Last Tuesday</option>
                                                <option value="last_wednesday">Last Wednesday</option>
                                                <option value="last_thursday">Last Thursday</option>
                                                <option value="last_friday">Last Friday</option>
                                                <option value="last_saturday">Last Saturday</option>
                                                <option value="last_sunday">Last Sunday</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- End Condition -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">End Type</label>
                                            <select id="eventRecurEndType" class="w-full rounded-lg border px-3 py-2 text-sm" onchange="updateRecurEndOptions()">
                                                <option value="until">Until date</option>
                                                <option value="count">Number of occurrences</option>
                                            </select>
                                        </div>

                                        <div id="recurUntilContainer">
                                            <label class="block text-xs text-gray-600 mb-1">Until</label>
                                            <input type="date" id="eventRecurUntil" class="w-full rounded-lg border px-3 py-2 text-sm">
                                        </div>

                                        <div id="recurCountContainer" style="display: none;">
                                            <label class="block text-xs text-gray-600 mb-1">Occurrences</label>
                                            <input type="number" id="eventRecurCount" min="1" max="52" class="w-full rounded-lg border px-3 py-2 text-sm" placeholder="e.g., 10">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Notes -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label>
                                <textarea id="eventNotes" rows="3" class="w-full rounded-lg border px-3 py-2" placeholder="Additional event details..."></textarea>
                            </div>
                        </div>

                        <div class="flex justify-end gap-3 mt-6">
                            <button onclick="SocietyOrganizerSystem.hideEventForm()" class="btn-secondary">
                                Cancel
                            </button>
                            <button onclick="SocietyOrganizerSystem.saveEvent()" class="btn-primary">
                                <span class="material-symbols-outlined text-sm">save</span>
                                Save Event
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Events List -->
                <div id="eventsListContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Events will be rendered here -->
                </div>

                <!-- Empty State -->
                <div id="eventsEmptyState" class="text-center py-12 bg-white rounded-2xl shadow-sm">
                    <div class="w-16 h-16 bg-sky-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="material-symbols-outlined text-sky-600 text-3xl">event</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">No Events Yet</h3>
                    <p class="text-gray-600 mb-4">Create your first society golf event to get started</p>
                    <button onclick="SocietyOrganizerSystem.showEventForm(null)" class="btn-primary">
                        <span class="material-symbols-outlined text-sm">add</span>
                        Create Event
                    </button>
                </div>
            </div>

            <!-- Tab: Calendar -->
            <div id="organizerTab-calendar" class="organizer-tab-content" style="display: none;">
                <!-- Calendar Header with Stats -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
                    <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition">
                        <div class="flex items-center justify-between mb-2">
                            <span class="material-symbols-outlined text-blue-600 text-xl">event</span>
                            <span class="text-2xl font-bold text-gray-900" id="calendarStatThisMonth">0</span>
                        </div>
                        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">This Month</div>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition">
                        <div class="flex items-center justify-between mb-2">
                            <span class="material-symbols-outlined text-green-600 text-xl">groups</span>
                            <span class="text-2xl font-bold text-gray-900" id="calendarStatPlayers">0</span>
                        </div>
                        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Players</div>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition">
                        <div class="flex items-center justify-between mb-2">
                            <span class="material-symbols-outlined text-orange-600 text-xl">schedule</span>
                            <span class="text-2xl font-bold text-gray-900" id="calendarStatUpcoming">0</span>
                        </div>
                        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Next 7 Days</div>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition">
                        <div class="flex items-center justify-between mb-2">
                            <span class="material-symbols-outlined text-red-600 text-xl">priority_high</span>
                            <span class="text-2xl font-bold text-gray-900" id="calendarStatAttention">0</span>
                        </div>
                        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Attention</div>
                    </div>
                </div>

                <!-- Calendar Main Area -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Calendar Grid (2/3 width on large screens) -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <!-- Month Navigation -->
                            <div class="flex items-center justify-between mb-6">
                                <button onclick="window.SocietyCalendar?.prevMonth()"
                                        class="p-2 hover:bg-gray-100 rounded-lg transition">
                                    <span class="material-symbols-outlined">chevron_left</span>
                                </button>

                                <div class="text-center">
                                    <h2 id="calendarMonthYear" class="text-2xl font-bold text-gray-800">
                                        October 2025
                                    </h2>
                                </div>

                                <button onclick="window.SocietyCalendar?.nextMonth()"
                                        class="p-2 hover:bg-gray-100 rounded-lg transition">
                                    <span class="material-symbols-outlined">chevron_right</span>
                                </button>
                            </div>

                            <!-- Day Headers -->
                            <div class="grid grid-cols-7 gap-1 mb-2">
                                <div class="text-center text-xs font-semibold text-gray-600 py-2">Sun</div>
                                <div class="text-center text-xs font-semibold text-gray-600 py-2">Mon</div>
                                <div class="text-center text-xs font-semibold text-gray-600 py-2">Tue</div>
                                <div class="text-center text-xs font-semibold text-gray-600 py-2">Wed</div>
                                <div class="text-center text-xs font-semibold text-gray-600 py-2">Thu</div>
                                <div class="text-center text-xs font-semibold text-gray-600 py-2">Fri</div>
                                <div class="text-center text-xs font-semibold text-gray-600 py-2">Sat</div>
                            </div>

                            <!-- Calendar Grid (7x6) -->
                            <div id="calendarGrid" class="grid grid-cols-7 gap-1">
                                <!-- Calendar cells will be rendered here by JavaScript -->
                            </div>

                            <!-- Legend -->
                            <div class="mt-6 pt-4 border-t border-gray-200">
                                <div class="flex flex-wrap gap-4 text-sm">
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                        <span class="text-gray-600">Open</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                                        <span class="text-gray-600">Soon (7 days)</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                                        <span class="text-gray-600">Closed</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 rounded-full bg-gray-400"></div>
                                        <span class="text-gray-600">Past</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Event Sidebar (1/3 width on large screens) -->
                    <div class="lg:col-span-1">
                        <div id="calendarSidebar" class="bg-white rounded-lg shadow-sm p-6">
                            <div class="text-center text-gray-500 py-8">
                                <span class="material-symbols-outlined text-5xl mb-3">event</span>
                                <p class="text-sm">Click a date to view events</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Scoring -->
            <div id="organizerTab-scoring" class="organizer-tab-content" style="display: none;">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Event Scoring & Rankings</h2>
                        <p class="text-sm text-gray-600">Manage scores as they come in and assign championship points</p>
                    </div>
                    <button onclick="OrganizerScoringSystem.refreshScores()" class="btn-primary">
                        <span class="material-symbols-outlined text-sm mr-1">refresh</span>
                        Refresh
                    </button>
                </div>

                <!-- Event Selector -->
                <div class="metric-card mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Event</label>
                    <select id="organizerScoringEventSelect" onchange="OrganizerScoringSystem.loadEventScores(this.value)" class="w-full rounded-lg border px-3 py-2">
                        <option value="">-- Select an event --</option>
                    </select>
                </div>

                <!-- Point Allocation Settings -->
                <div class="metric-card mb-6" id="pointAllocationSettings" style="display: none;">
                    <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-yellow-600">stars</span>
                        Championship Point Allocation
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Number of Scoring Places</label>
                            <input type="number" id="scoringPlacesCount" min="1" max="20" value="5"
                                onchange="OrganizerScoringSystem.updatePointsTable()"
                                class="w-full rounded-lg border px-3 py-2">
                            <p class="text-xs text-gray-500 mt-1">How many places receive points (e.g., Top 5)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Point Distribution System</label>
                            <select id="pointSystemSelect" onchange="OrganizerScoringSystem.applyPointSystem(this.value)" class="w-full rounded-lg border px-3 py-2">
                                <option value="custom">Custom</option>
                                <option value="f1">F1 Style (25-18-15-12-10...)</option>
                                <option value="linear">Linear (10-9-8-7-6...)</option>
                                <option value="winner-heavy">Winner Heavy (100-50-25-15-10...)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Points Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm" id="pointsAllocationTable">
                            <thead class="border-b-2 border-gray-300">
                                <tr class="text-left">
                                    <th class="py-2 px-3">Position</th>
                                    <th class="py-2 px-3">Points Awarded</th>
                                </tr>
                            </thead>
                            <tbody id="pointsAllocationBody">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div class="flex gap-3 mt-4">
                        <button onclick="OrganizerScoringSystem.savePointAllocation()" class="btn-primary flex-1">
                            <span class="material-symbols-outlined text-sm mr-1">save</span>
                            Save Point System
                        </button>
                        <button onclick="OrganizerScoringSystem.publishResults()" class="btn-secondary flex-1">
                            <span class="material-symbols-outlined text-sm mr-1">publish</span>
                            Publish Results
                        </button>
                    </div>
                </div>

                <!-- Live Leaderboard -->
                <div class="metric-card" id="eventLeaderboardContainer" style="display: none;">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                            <span class="material-symbols-outlined text-green-600">leaderboard</span>
                            Live Leaderboard
                            <span id="leaderboardLiveIndicator" class="text-xs text-green-600 ml-2">● LIVE</span>
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="OrganizerScoringSystem.exportToCSV()" class="text-sm px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">
                                <span class="material-symbols-outlined text-sm mr-1">download</span>
                                Export CSV
                            </button>
                            <button onclick="OrganizerScoringSystem.assignPoints()" class="text-sm px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
                                <span class="material-symbols-outlined text-sm mr-1">calculate</span>
                                Assign Points
                            </button>
                        </div>
                    </div>

                    <!-- Format Selector for Multi-Format Events -->
                    <div class="mb-4" id="formatSelectorDiv">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Scoring Format</label>
                        <select id="leaderboardFormatSelect" onchange="OrganizerScoringSystem.changeFormat(this.value)" class="rounded-lg border px-3 py-2">
                            <option value="stableford">Stableford</option>
                            <option value="strokeplay">Stroke Play</option>
                            <option value="scramble">Scramble</option>
                            <option value="nassau">Nassau</option>
                            <option value="skins">Skins</option>
                        </select>
                    </div>

                    <!-- Leaderboard Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="border-b-2 border-gray-300">
                                <tr class="text-left">
                                    <th class="py-2 px-3">Pos</th>
                                    <th class="py-2 px-3">Player</th>
                                    <th class="py-2 px-3">Handicap</th>
                                    <th class="py-2 px-3">Gross</th>
                                    <th class="py-2 px-3">Net</th>
                                    <th class="py-2 px-3">Score</th>
                                    <th class="py-2 px-3">Points</th>
                                    <th class="py-2 px-3">Status</th>
                                </tr>
                            </thead>
                            <tbody id="eventLeaderboardBody">
                                <tr>
                                    <td colspan="8" class="py-8 text-center text-gray-500">
                                        <span class="material-symbols-outlined text-5xl mb-2">emoji_events</span>
                                        <p>Select an event to view scores</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Stats Summary -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-6 pt-6 border-t border-gray-200">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-900" id="statTotalPlayers">0</div>
                            <div class="text-xs text-gray-600">Total Players</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="statCompleted">0</div>
                            <div class="text-xs text-gray-600">Completed</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600" id="statInProgress">0</div>
                            <div class="text-xs text-gray-600">In Progress</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-orange-600" id="statAvgScore">-</div>
                            <div class="text-xs text-gray-600">Average Score</div>
                        </div>
                    </div>
                </div>

                <!-- No Event Selected State -->
                <div class="metric-card text-center py-12" id="noEventSelected">
                    <span class="material-symbols-outlined text-6xl text-gray-300 mb-4">event_available</span>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">No Event Selected</h3>
                    <p class="text-sm text-gray-500">Select an event above to view and manage scores</p>
                </div>
            </div>

            <!-- Tab: Players -->
            <div id="organizerTab-players" class="organizer-tab-content" style="display: none;">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">Player Directory</h2>
                        <p class="text-sm text-gray-600 mt-1">Manage your society's official member roster</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="SocietyOrganizerSystem.refreshPlayerDirectory()" class="btn-secondary">
                            <span class="material-symbols-outlined text-sm">refresh</span>
                            Refresh
                        </button>
                        <button onclick="SocietyOrganizerSystem.showAddPlayerModal()" class="btn-primary">
                            <span class="material-symbols-outlined text-sm">person_add</span>
                            Add Player
                        </button>
                    </div>
                </div>

                <!-- Player Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-xl shadow-sm border p-4">
                        <div class="flex items-center gap-3">
                            <div class="bg-green-100 rounded-full p-3">
                                <span class="material-symbols-outlined text-green-600">group</span>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Total Members</p>
                                <p id="playerDirTotalMembers" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border p-4">
                        <div class="flex items-center gap-3">
                            <div class="bg-blue-100 rounded-full p-3">
                                <span class="material-symbols-outlined text-blue-600">person_add</span>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Joined This Month</p>
                                <p id="playerDirMonthlyJoins" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border p-4">
                        <div class="flex items-center gap-3">
                            <div class="bg-purple-100 rounded-full p-3">
                                <span class="material-symbols-outlined text-purple-600">trending_down</span>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Avg Handicap</p>
                                <p id="playerDirAvgHandicap" class="text-2xl font-bold text-gray-900">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border p-4">
                        <div class="flex items-center gap-3">
                            <div class="bg-orange-100 rounded-full p-3">
                                <span class="material-symbols-outlined text-orange-600">verified</span>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Active Members</p>
                                <p id="playerDirActiveMembers" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Player Directory Table -->
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Member #</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Handicap</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Home Club</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Joined</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="playerDirectoryTable" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                                        <span class="material-symbols-outlined text-5xl text-gray-300">group_off</span>
                                        <p class="mt-2">No members yet. Click "Add Player" to get started.</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab: Profile -->
            <div id="organizerTab-profile" class="organizer-tab-content" style="display: none;">
                <div class="max-w-3xl">
                    <div class="flex justify-between items-center mb-6">
                        <div class="text-sm text-gray-600">
                            Set up your society's branding. This will appear on all your event cards.
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg border p-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">Society Profile</h2>

                        <!-- Society Logo -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Society Logo</label>
                            <div class="flex items-center space-x-4">
                                <div id="societyLogoPreview" class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden border-2 border-gray-300">
                                    <span class="material-symbols-outlined text-4xl text-gray-400">groups</span>
                                </div>
                                <div class="flex-1">
                                    <input type="file" id="societyLogoInput" accept="image/*" class="hidden" onchange="SocietyOrganizerSystem.handleLogoUpload(event)">
                                    <button onclick="document.getElementById('societyLogoInput').click()" class="btn-secondary text-sm">
                                        <span class="material-symbols-outlined text-sm">upload</span>
                                        Upload Logo
                                    </button>
                                    <p class="text-xs text-gray-500 mt-1">Square image recommended (PNG or JPG, max 2MB)</p>
                                </div>
                            </div>
                        </div>

                        <!-- Society Name -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Society Name</label>
                            <input type="text" id="societyName" class="w-full rounded-lg border px-3 py-2" placeholder="e.g., Phuket Golf Society">
                        </div>

                        <!-- Description (Optional) -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                            <textarea id="societyDescription" class="w-full rounded-lg border px-3 py-2" rows="3" placeholder="Tell golfers about your society..."></textarea>
                        </div>

                        <!-- Save Button -->
                        <div class="flex justify-end">
                            <button onclick="SocietyOrganizerSystem.saveSocietyProfile()" class="btn-primary">
                                <span class="material-symbols-outlined text-sm">save</span>
                                Save Profile
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Admin -->
            <div id="organizerTab-admin" class="organizer-tab-content" style="display: none;">
                <div class="max-w-4xl">
                    <div class="flex justify-between items-center mb-6">
                        <div class="text-sm text-gray-600">
                            Manage dashboard security, user roles, and access settings.
                        </div>
                    </div>

                    <!-- Current Role Display -->
                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-2xl shadow-lg border border-purple-200 p-6 mb-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="bg-purple-100 rounded-full p-3">
                                    <span id="userRoleIcon" class="material-symbols-outlined text-2xl text-purple-600">shield</span>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Your Access Level</p>
                                    <p id="userRoleDisplay" class="text-2xl font-bold text-gray-900">Loading...</p>
                                    <p id="userRoleDescription" class="text-xs text-gray-600 mt-1">Checking permissions...</p>
                                </div>
                            </div>
                            <div id="userRoleBadge" class="px-4 py-2 bg-purple-600 text-white rounded-full text-sm font-semibold">
                                ADMIN
                            </div>
                        </div>
                    </div>

                    <!-- SUPER ADMIN ONLY: PIN Security Section -->
                    <div id="superAdminPinSection" style="display: none;">
                        <div class="bg-white rounded-2xl shadow-lg border p-6 mb-6">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="bg-red-100 rounded-full p-2">
                                    <span class="material-symbols-outlined text-red-600">admin_panel_settings</span>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-gray-900">🔐 Super Admin: PIN Security</h2>
                                    <p class="text-xs text-gray-600">Only Super Admin can change dashboard PIN</p>
                                </div>
                            </div>

                            <!-- PIN Status -->
                            <div id="pinStatusSection" class="mb-6">
                                <div class="bg-gray-50 rounded-lg p-4 flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <span id="pinStatusIcon" class="material-symbols-outlined text-2xl text-gray-400">lock_open</span>
                                        <div>
                                            <p id="pinStatusText" class="text-sm font-medium text-gray-900">No PIN Set</p>
                                            <p class="text-xs text-gray-500">Anyone can access organizer dashboard</p>
                                        </div>
                                    </div>
                                    <button id="setPinButton" onclick="SocietyOrganizerSystem.showPinSetup()" class="btn-primary text-sm">
                                        <span class="material-symbols-outlined text-sm">add</span>
                                        Set PIN
                                    </button>
                                </div>
                            </div>

                            <!-- PIN Setup Form (Hidden by default) -->
                            <div id="pinSetupForm" style="display: none;">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">New PIN</label>
                                        <input type="password" id="newPin"
                                               placeholder="Enter 4-6 digit PIN"
                                               maxlength="6"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 text-center text-2xl tracking-widest">
                                        <p class="text-xs text-gray-500 mt-1">Use 4-6 digits for your PIN</p>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirm PIN</label>
                                        <input type="password" id="confirmPin"
                                               placeholder="Re-enter PIN"
                                               maxlength="6"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 text-center text-2xl tracking-widest">
                                    </div>

                                    <div class="bg-amber-50 rounded-lg p-4">
                                        <div class="flex items-start space-x-2">
                                            <span class="material-symbols-outlined text-amber-600 text-sm">warning</span>
                                            <div class="text-xs text-amber-800">
                                                <p class="font-medium mb-1">Important:</p>
                                                <p>• This PIN protects the entire Society Organizer dashboard</p>
                                                <p>• Only Super Admin can change this PIN</p>
                                                <p>• All users (including regular admins) must enter this PIN to access</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex space-x-3">
                                        <button onclick="SocietyOrganizerSystem.cancelPinSetup()" class="flex-1 btn-secondary">
                                            Cancel
                                        </button>
                                        <button onclick="SocietyOrganizerSystem.saveDashboardPin()" class="flex-1 btn-primary">
                                            <span class="material-symbols-outlined text-sm">save</span>
                                            Save PIN
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Change PIN Section (shown when PIN exists) -->
                            <div id="changePinSection" style="display: none;">
                                <button onclick="SocietyOrganizerSystem.showChangePinForm()" class="btn-secondary text-sm w-full">
                                    <span class="material-symbols-outlined text-sm">edit</span>
                                    Change PIN
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- SUPER ADMIN ONLY: User Management -->
                    <div id="superAdminUserManagement" style="display: none;">
                        <div class="bg-white rounded-2xl shadow-lg border p-6 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="bg-blue-100 rounded-full p-2">
                                        <span class="material-symbols-outlined text-blue-600">manage_accounts</span>
                                    </div>
                                    <div>
                                        <h2 class="text-xl font-bold text-gray-900">👥 Super Admin: User Management</h2>
                                        <p class="text-xs text-gray-600">Assign roles and manage dashboard access</p>
                                    </div>
                                </div>
                                <button onclick="SocietyOrganizerSystem.showAddUserModal()" class="btn-primary text-sm">
                                    <span class="material-symbols-outlined text-sm">person_add</span>
                                    Add User
                                </button>
                            </div>

                            <!-- Role Descriptions -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="border rounded-lg p-4 bg-red-50 border-red-200">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <span class="material-symbols-outlined text-red-600">shield_person</span>
                                        <p class="font-bold text-red-900">Super Admin</p>
                                    </div>
                                    <p class="text-xs text-gray-700">• Change PIN security<br>• Assign user roles<br>• Full dashboard access</p>
                                </div>
                                <div class="border rounded-lg p-4 bg-blue-50 border-blue-200">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <span class="material-symbols-outlined text-blue-600">admin_panel_settings</span>
                                        <p class="font-bold text-blue-900">Admin</p>
                                    </div>
                                    <p class="text-xs text-gray-700">• Manage events<br>• View registrations<br>• Create pairings</p>
                                </div>
                                <div class="border rounded-lg p-4 bg-gray-50 border-gray-200">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <span class="material-symbols-outlined text-gray-600">badge</span>
                                        <p class="font-bold text-gray-900">Staff</p>
                                    </div>
                                    <p class="text-xs text-gray-700">• View events<br>• View registrations<br>• Limited access</p>
                                </div>
                            </div>

                            <!-- User List -->
                            <div id="adminUsersList">
                                <div class="text-center py-8 text-gray-500">
                                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
                                    <p class="text-sm">Loading users...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- LIMITED ACCESS MESSAGE (for non-Super Admins) -->
                    <div id="limitedAccessMessage" style="display: none;">
                        <div class="bg-yellow-50 rounded-2xl shadow-lg border border-yellow-200 p-6">
                            <div class="flex items-start space-x-3">
                                <div class="bg-yellow-100 rounded-full p-2">
                                    <span class="material-symbols-outlined text-yellow-600">info</span>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900 mb-2">Limited Admin Access</h3>
                                    <p class="text-sm text-gray-700 mb-4">
                                        You have <strong id="limitedAccessRoleName">Admin</strong> access. PIN security and user management
                                        are controlled by the Super Admin.
                                    </p>
                                    <p class="text-xs text-gray-600">
                                        To request Super Admin access or report issues, contact your organization administrator.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard Info (shown to all) -->
                    <div class="bg-white rounded-2xl shadow-lg border p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Dashboard Information</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between py-3 border-b">
                                <div>
                                    <p class="text-sm font-medium text-gray-900">Organizer ID</p>
                                    <p id="adminOrganizerId" class="text-xs text-gray-500">Loading...</p>
                                </div>
                            </div>
                            <div class="flex items-center justify-between py-3 border-b">
                                <div>
                                    <p class="text-sm font-medium text-gray-900">Your Role</p>
                                    <p id="adminUserRole" class="text-xs text-gray-500">Loading...</p>
                                </div>
                            </div>
                            <div class="flex items-center justify-between py-3">
                                <div>
                                    <p class="text-sm font-medium text-gray-900">Last Login</p>
                                    <p class="text-xs text-gray-500">Current session</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Roster Modal -->
    <div id="rosterModal" class="modal-backdrop" style="display: none;">
        <div class="modal-container max-w-4xl">
            <div class="modal-header bg-gradient-to-r from-sky-600 to-sky-400 text-white">
                <div>
                    <h2 id="rosterEventName" class="text-lg font-bold">Event Roster</h2>
                    <p id="rosterEventDate" class="text-xs text-sky-100"></p>
                </div>
                <button onclick="SocietyOrganizerSystem.closeRosterModal()" class="text-white hover:bg-white/20 rounded-lg p-1">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="modal-body">
                <!-- Roster Tabs -->
                <div class="flex gap-6 border-b mb-4 pb-2">
                    <button onclick="showRosterTab('confirmed')" id="rosterTab-confirmed" class="roster-tab-button active text-sm font-medium">
                        Confirmed (<span id="confirmedCount">0</span>)
                    </button>
                    <button onclick="showRosterTab('waitlist')" id="rosterTab-waitlist" class="roster-tab-button text-sm font-medium text-gray-600">
                        Waitlist (<span id="waitlistCount">0</span>)
                    </button>
                </div>

                <!-- Confirmed Players -->
                <div id="rosterView-confirmed" class="roster-view">
                    <div class="mb-3 flex justify-end">
                        <button onclick="SocietyOrganizerSystem.openManualPlayerModal('confirmed')" class="btn-primary text-xs py-2 px-3 flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">person_add</span>
                            Add Player
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left">Name</th>
                                    <th class="px-4 py-2 text-left">Handicap</th>
                                    <th class="px-4 py-2 text-center">Transport</th>
                                    <th class="px-4 py-2 text-center">Competition</th>
                                    <th class="px-4 py-2 text-center">Partners</th>
                                    <th class="px-4 py-2 text-right">Total Fee</th>
                                    <th class="px-4 py-2 text-center">Paid Status</th>
                                    <th class="px-4 py-2 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="confirmedPlayersTable">
                                <!-- Confirmed players will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Waitlist -->
                <div id="rosterView-waitlist" class="roster-view" style="display: none;">
                    <div class="mb-3 flex justify-end">
                        <button onclick="SocietyOrganizerSystem.openManualPlayerModal('waitlist')" class="btn-primary text-xs py-2 px-3 flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">person_add</span>
                            Add to Waitlist
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left">Position</th>
                                    <th class="px-4 py-2 text-left">Name</th>
                                    <th class="px-4 py-2 text-left">Handicap</th>
                                    <th class="px-4 py-2 text-left">Requested</th>
                                    <th class="px-4 py-2 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="waitlistPlayersTable">
                                <!-- Waitlist players will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-6 flex justify-between items-center">
                    <button onclick="SocietyOrganizerSystem.exportRoster()" class="btn-secondary">
                        <span class="material-symbols-outlined text-sm">download</span>
                        Export CSV
                    </button>
                    <button id="rosterPairingsBtn" onclick="SocietyOrganizerSystem.openPairingsModalFromRoster()" class="btn-primary">
                        <span class="material-symbols-outlined text-sm">groups</span>
                        Manage Pairings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Player Addition Modal -->
    <div id="manualPlayerModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-start justify-center pt-12 overflow-y-auto" style="display: none; z-index: 10001;">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 my-8 overflow-hidden flex flex-col">
            <!-- Header -->
            <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-green-600 to-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-xl font-bold text-white">Add Player to Event</h3>
                        <p class="text-sm text-green-100 mt-1" id="manualPlayerEventName">Loading...</p>
                    </div>
                    <button onclick="SocietyOrganizerSystem.closeManualPlayerModal()" class="text-white hover:bg-white/20 rounded-lg p-2">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <!-- Mode Toggle -->
                <div class="flex gap-2 mt-4">
                    <button id="searchModeBtn" onclick="SocietyOrganizerSystem.setPlayerAddMode('search')" class="flex-1 bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <span class="material-symbols-outlined text-sm align-middle">search</span>
                        Search Database
                    </button>
                    <button id="manualModeBtn" onclick="SocietyOrganizerSystem.setPlayerAddMode('manual')" class="flex-1 bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <span class="material-symbols-outlined text-sm align-middle">person_add</span>
                        Manual Entry
                    </button>
                </div>
            </div>

            <!-- Body -->
            <div class="p-6 overflow-y-auto flex-1">
                <!-- Search Mode -->
                <div id="searchMode" style="display: none;">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search for Player</label>
                        <div class="relative">
                            <input type="text" id="manualPlayerSearchInput"
                                   placeholder="Type name to search..."
                                   oninput="SocietyOrganizerSystem.handlePlayerSearch(this.value)"
                                   class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            <span class="material-symbols-outlined absolute left-3 top-3 text-gray-400">search</span>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="playerSearchResults" class="space-y-2 min-h-[300px] max-h-[400px] overflow-y-auto">
                        <div class="text-center py-8 text-gray-500">
                            <span class="material-symbols-outlined text-5xl text-gray-300">search</span>
                            <p class="text-sm mt-2">Start typing to search for players</p>
                        </div>
                    </div>
                </div>

                <!-- Manual Entry Mode -->
                <div id="manualMode" style="display: none;">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Player Name *</label>
                            <input type="text" id="manualPlayerName"
                                   placeholder="Enter full name"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Handicap *</label>
                            <input type="number" id="manualPlayerHandicap"
                                   placeholder="Enter handicap (0-54)"
                                   min="0" max="54" step="0.1"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="flex items-center space-x-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="checkbox" id="manualPlayerTransport" class="w-4 h-4 text-green-600">
                                    <span class="text-sm">Wants Transport</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center space-x-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="checkbox" id="manualPlayerCompetition" class="w-4 h-4 text-green-600">
                                    <span class="text-sm">Join Competition</span>
                                </label>
                            </div>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <div class="flex items-start space-x-2">
                                <span class="material-symbols-outlined text-blue-600 text-sm">info</span>
                                <p class="text-xs text-blue-800">
                                    This player will be added directly to the event. They won't have an account unless they register later.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-6 border-t border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                    <p class="text-sm text-gray-600">
                        Add to: <span class="font-semibold" id="addToDestination">Confirmed Players</span>
                    </p>
                    <div class="flex gap-3">
                        <button onclick="SocietyOrganizerSystem.closeManualPlayerModal()" class="px-6 py-3 text-gray-700 bg-gray-200 rounded-xl font-semibold hover:bg-gray-300 transition-colors">
                            Cancel
                        </button>
                        <button id="addPlayerBtn" onclick="SocietyOrganizerSystem.confirmAddPlayer()" class="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition-colors flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">add</span>
                            Add Player
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Society Organizer PIN Verification Modal -->
    <div id="societyOrganizerPinModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="bg-sky-100 rounded-full p-2">
                            <span class="material-symbols-outlined text-sky-600">lock</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">Society Organizer Access</h3>
                            <p class="text-sm text-gray-500">Enter PIN to continue</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Access PIN</label>
                    <input type="password" id="societyOrganizerPinInput"
                           placeholder="Enter PIN"
                           maxlength="6"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 text-center text-2xl tracking-widest"
                           onkeypress="if(event.key === 'Enter') SocietyOrganizerAuth.verifyPin()">
                    <p id="pinErrorMessage" class="text-red-500 text-sm mt-2 hidden">Incorrect PIN. Please try again.</p>
                </div>

                <div class="bg-sky-50 rounded-lg p-4">
                    <div class="flex items-start space-x-2">
                        <span class="material-symbols-outlined text-sky-600 text-sm">info</span>
                        <p class="text-xs text-sky-800">
                            This area is restricted to authorized society organizers only.
                            Contact your administrator if you need access.
                        </p>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-between p-6 border-t border-gray-200 bg-gray-50">
                <button onclick="SocietyOrganizerAuth.cancelPinEntry()" class="px-6 py-3 text-gray-700 bg-gray-200 rounded-xl font-semibold hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
                <button onclick="SocietyOrganizerAuth.verifyPin()" class="px-6 py-3 bg-sky-600 text-white rounded-xl font-semibold hover:bg-sky-700 transition-colors">
                    Verify
                </button>
            </div>
        </div>
    </div>

    <!-- Add User Modal (Super Admin Only) -->
    <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="bg-blue-100 rounded-full p-2">
                            <span class="material-symbols-outlined text-blue-600">person_add</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">Add User to Dashboard</h3>
                            <p class="text-sm text-gray-500">Grant access and assign role</p>
                        </div>
                    </div>
                    <button onclick="SocietyOrganizerSystem.closeAddUserModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>

            <div class="p-6 space-y-4">
                <!-- Search for Profile -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search User Profile</label>
                    <input type="text" id="addUserSearchInput"
                           placeholder="Search by name or email..."
                           oninput="SocietyOrganizerSystem.searchUserProfiles()"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Search existing user profiles to grant dashboard access</p>
                </div>

                <!-- Profile Search Results -->
                <div id="userProfileSearchResults" class="max-h-64 overflow-y-auto border rounded-lg" style="display: none;">
                    <!-- Results populated dynamically -->
                </div>

                <!-- Selected User Display -->
                <div id="selectedUserDisplay" style="display: none;">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="bg-blue-100 rounded-full p-2">
                                    <span class="material-symbols-outlined text-blue-600">person</span>
                                </div>
                                <div>
                                    <p id="selectedUserName" class="font-medium text-gray-900"></p>
                                    <p id="selectedUserEmail" class="text-xs text-gray-600"></p>
                                </div>
                            </div>
                            <button onclick="SocietyOrganizerSystem.clearSelectedUser()" class="text-gray-400 hover:text-gray-600 text-sm">
                                Change
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Role Assignment -->
                <div id="roleAssignmentSection" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Assign Role</label>
                    <div class="space-y-2">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                            <input type="radio" name="userRole" value="super_admin" class="mr-3 w-5 h-5" onchange="SocietyOrganizerSystem.updateRolePreview('super_admin')">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <span class="material-symbols-outlined text-red-600">shield_person</span>
                                    <span class="font-semibold text-gray-900">Super Admin</span>
                                </div>
                                <p class="text-xs text-gray-600 mt-1">Full control: PIN management, user roles, all features</p>
                            </div>
                        </label>

                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                            <input type="radio" name="userRole" value="admin" class="mr-3 w-5 h-5" checked onchange="SocietyOrganizerSystem.updateRolePreview('admin')">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <span class="material-symbols-outlined text-blue-600">admin_panel_settings</span>
                                    <span class="font-semibold text-gray-900">Admin</span>
                                </div>
                                <p class="text-xs text-gray-600 mt-1">Manage events, registrations, pairings, profiles</p>
                            </div>
                        </label>

                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                            <input type="radio" name="userRole" value="staff" class="mr-3 w-5 h-5" onchange="SocietyOrganizerSystem.updateRolePreview('staff')">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <span class="material-symbols-outlined text-gray-600">badge</span>
                                    <span class="font-semibold text-gray-900">Staff</span>
                                </div>
                                <p class="text-xs text-gray-600 mt-1">View-only access: events, registrations (limited features)</p>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-between p-6 border-t border-gray-200 bg-gray-50">
                <button onclick="SocietyOrganizerSystem.closeAddUserModal()" class="px-6 py-3 text-gray-700 bg-gray-200 rounded-xl font-semibold hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
                <button id="confirmAddUserButton" onclick="SocietyOrganizerSystem.confirmAddUser()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-colors" disabled style="opacity: 0.5;">
                    <span class="material-symbols-outlined text-sm mr-1">person_add</span>
                    Add User
                </button>
            </div>
        </div>
    </div>

    <!-- Pairings Modal -->
    <div id="pairingsModal" class="modal-backdrop" style="display: none;">
        <div class="modal-container max-w-7xl">
            <div class="modal-header bg-gradient-to-r from-green-600 to-green-400 text-white">
                <div>
                    <h2 id="pairingsEventName" class="text-lg font-bold">Event Pairings</h2>
                    <p id="pairingsEventDate" class="text-xs text-green-100"></p>
                </div>
                <button onclick="SocietyOrganizerSystem.closePairingsModal()" class="text-white hover:bg-white/20 rounded-lg p-1">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="modal-body">
                <!-- Pairing Controls -->
                <div class="bg-gray-50 rounded-lg p-3 mb-3">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Format / Group Size</label>
                            <select id="pairingsGroupSize" onchange="SocietyOrganizerSystem.handleFormatChange()" class="w-full rounded border px-2 py-1.5 text-sm">
                                <option value="4">4-Ball (Groups of 4)</option>
                                <option value="3">3-Ball (Groups of 3)</option>
                                <option value="2">2-Ball (Groups of 2)</option>
                                <option value="2man_scramble">2-Man Scramble</option>
                                <option value="4man_scramble">4-Man Scramble</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Pairing Mode</label>
                            <select id="pairingMode" class="w-full rounded border px-2 py-1.5 text-sm">
                                <option value="auto">Auto-Pair</option>
                                <option value="manual">Manual (Click to Pair)</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="SocietyOrganizerSystem.autoPairPlayers()" class="btn-primary w-full text-xs py-1.5 px-2">
                                <span class="material-symbols-outlined text-xs">auto_awesome</span>
                                Auto-Pair
                            </button>
                        </div>
                        <div class="flex items-end">
                            <button onclick="SocietyOrganizerSystem.shufflePairings()" class="btn-secondary w-full text-xs py-1.5 px-2">
                                <span class="material-symbols-outlined text-xs">shuffle</span>
                                Shuffle
                            </button>
                        </div>
                    </div>

                    <!-- Manual Pairing Instructions -->
                    <div id="manualPairingInstructions" class="mt-2 bg-blue-50 border border-blue-200 rounded p-2" style="display: none;">
                        <div class="flex items-start gap-2">
                            <span class="material-symbols-outlined text-blue-600 text-xs">info</span>
                            <div class="text-[10px] text-blue-800">
                                <p class="font-semibold">Manual Pairing Mode Active</p>
                                <p class="mt-0.5">Click players to select, then create group. Selected: <span id="selectedPlayersCount" class="font-semibold">0</span></p>
                            </div>
                            <button id="createGroupBtn" onclick="SocietyOrganizerSystem.createManualGroup()" class="btn-primary text-[10px] py-1 px-2 ml-auto" disabled>
                                Create Group
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pairings Display -->
                <div id="pairingsContainer">
                    <div class="text-center py-8 text-gray-500">
                        <span class="material-symbols-outlined text-5xl mb-2">groups</span>
                        <p class="text-sm">Click "Auto-Pair Players" to generate pairings</p>
                    </div>
                </div>

                <!-- Unpaired Players -->
                <div id="unpairedPlayersSection" class="mt-6 bg-amber-50 rounded-lg p-4" style="display: none;">
                    <h3 class="text-sm font-bold text-amber-900 mb-3">Unpaired Players</h3>
                    <div id="unpairedPlayersList" class="space-y-2"></div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-2 mt-4">
                    <button onclick="SocietyOrganizerSystem.savePairings()" class="flex-1 btn-primary text-sm py-2 px-3">
                        <span class="material-symbols-outlined text-sm">save</span>
                        Save Pairings
                    </button>
                    <button onclick="SocietyOrganizerSystem.printTeeSheet()" class="flex-1 btn-secondary text-sm py-2 px-3">
                        <span class="material-symbols-outlined text-sm">print</span>
                        Print Tee Sheet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Society Event Detail & Registration Modal -->
    <div id="eventDetailModal" class="modal-backdrop" style="display: none;">
        <div class="modal-container max-w-4xl">
            <div class="modal-header bg-gradient-to-r from-green-600 to-green-400 text-white">
                <div class="flex-1">
                    <h2 id="eventDetailName" class="text-xl font-bold">Event Name</h2>
                    <p id="eventDetailOrganizer" class="text-sm text-green-100 mt-1"></p>
                </div>
                <button onclick="GolferEventsSystem.closeEventDetail()" class="text-white hover:bg-white/20 rounded-lg p-1">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="modal-body max-h-[70vh] overflow-y-auto">
                <!-- Event Info Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Date & Time -->
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="material-symbols-outlined text-green-600">event</span>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-500">Date & Time</div>
                            <div id="eventDetailDate" class="text-lg font-semibold text-gray-900"></div>
                        </div>
                    </div>

                    <!-- Course -->
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="material-symbols-outlined text-blue-600">golf_course</span>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-500">Golf Course</div>
                            <div id="eventDetailCourse" class="text-lg font-semibold text-gray-900"></div>
                        </div>
                    </div>

                    <!-- Event Format -->
                    <div id="eventDetailFormatContainer" class="flex items-start space-x-3" style="display: none;">
                        <div class="w-10 h-10 bg-teal-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="material-symbols-outlined text-teal-600">sports_golf</span>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-500">Event Format</div>
                            <div id="eventDetailFormat" class="text-lg font-semibold text-gray-900"></div>
                        </div>
                    </div>

                    <!-- Registration Cutoff -->
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="material-symbols-outlined text-amber-600">schedule</span>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-500">Registration Cutoff</div>
                            <div id="eventDetailCutoff" class="text-lg font-semibold text-gray-900"></div>
                        </div>
                    </div>

                    <!-- Availability -->
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="material-symbols-outlined text-purple-600">groups</span>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-500">Availability</div>
                            <div id="eventDetailAvailability" class="text-lg font-semibold text-gray-900"></div>
                        </div>
                    </div>
                </div>

                <!-- Fees Breakdown -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="font-bold text-gray-900 mb-3 flex items-center">
                        <span class="material-symbols-outlined text-sm mr-2">payments</span>
                        Fees Breakdown
                    </h3>
                    <div id="eventDetailFees" class="space-y-2 text-sm">
                        <!-- Fees will be populated here -->
                    </div>
                </div>

                <!-- Notes -->
                <div id="eventDetailNotesSection" class="bg-blue-50 rounded-lg p-4 mb-6" style="display: none;">
                    <h3 class="font-bold text-gray-900 mb-2 flex items-center">
                        <span class="material-symbols-outlined text-sm mr-2">info</span>
                        Event Notes
                    </h3>
                    <p id="eventDetailNotes" class="text-sm text-gray-700"></p>
                </div>

                <!-- Registered Players List -->
                <div id="registeredPlayersList" class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="font-bold text-gray-900 mb-3 flex items-center justify-between">
                        <span class="flex items-center">
                            <span class="material-symbols-outlined text-sm mr-2">groups</span>
                            Registered Players
                        </span>
                        <span id="regPlayerCount" class="text-sm font-normal text-gray-600">Loading...</span>
                    </h3>
                    <div id="registeredPlayersContent" class="space-y-2 text-sm max-h-40 overflow-y-auto">
                        <p class="text-gray-500 text-center py-2">Loading player list...</p>
                    </div>
                </div>

                <!-- Your Group Assignment (Only shown when pairings exist) -->
                <div id="golferPairingSection" class="bg-gradient-to-br from-green-50 to-blue-50 rounded-lg p-4 mb-6 border-2 border-green-200" style="display: none;">
                    <h3 class="font-bold text-gray-900 mb-3 flex items-center">
                        <span class="material-symbols-outlined text-sm mr-2 text-green-600">golf_course</span>
                        Your Group Assignment
                    </h3>
                    <div id="golferPairingContent">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <!-- Registration Form (Only shown when registering) -->
                <div id="registrationForm" class="border-t pt-6" style="display: none;">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Registration Details</h3>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Player Name *</label>
                            <input
                                type="text"
                                id="regPlayerName"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                placeholder="Enter your name"
                            >
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Handicap *</label>
                            <input
                                type="number"
                                id="regHandicap"
                                step="0.1"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                placeholder="Your handicap (e.g., 18.5)"
                            >
                        </div>

                        <div class="flex items-center space-x-6">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="regWantTransport" class="mr-2 rounded" onchange="GolferEventsSystem.updateRegistrationTotal()">
                                <span class="text-sm text-gray-700">🚐 Request Transportation</span>
                            </label>

                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="regWantCompetition" class="mr-2 rounded" onchange="GolferEventsSystem.updateRegistrationTotal()">
                                <span class="text-sm text-gray-700">🏆 Join Competition</span>
                            </label>
                        </div>

                        <!-- Partner Preferences -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Partner Preferences (Optional)
                                <span class="text-xs text-gray-500 font-normal ml-1">- Select players you'd like to play with</span>
                            </label>
                            <div id="partnerPrefsContainer" class="border border-gray-300 rounded-lg p-3 max-h-32 overflow-y-auto space-y-2">
                                <p class="text-xs text-gray-500">Loading registered players...</p>
                            </div>
                        </div>

                        <!-- Total Cost Calculator -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-bold text-gray-900 mb-3">Total Cost</h4>
                            <div class="space-y-2 text-sm mb-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Base Fee (Green + Cart + Caddy):</span>
                                    <span id="regBaseFeeDisplay" class="font-medium">฿0</span>
                                </div>
                                <div id="regTransportFeeRow" class="flex justify-between text-gray-400" style="display: none;">
                                    <span>Transportation:</span>
                                    <span id="regTransportFeeDisplay">฿0</span>
                                </div>
                                <div id="regCompetitionFeeRow" class="flex justify-between text-gray-400" style="display: none;">
                                    <span>Competition Entry:</span>
                                    <span id="regCompetitionFeeDisplay">฿0</span>
                                </div>
                            </div>
                            <div class="pt-3 border-t border-green-300 flex justify-between items-center">
                                <span class="font-bold text-lg text-gray-900">Total:</span>
                                <span id="regTotalCost" class="font-bold text-2xl text-green-600">฿0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button onclick="GolferEventsSystem.closeEventDetail()" class="btn-secondary">
                    Close
                </button>
                <button id="eventRegisterBtn" onclick="GolferEventsSystem.showRegistrationForm()" class="btn-primary">
                    <span class="material-symbols-outlined text-sm">person_add</span>
                    Register for Event
                </button>
                <button id="eventSubmitBtn" onclick="GolferEventsSystem.submitRegistration()" class="btn-primary" style="display: none;">
                    <span class="material-symbols-outlined text-sm">send</span>
                    Submit Registration
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================
         PAYMENT TRACKING SYSTEM MODALS
         ============================================ -->

    <!-- Payment Tracking Modal (Organizer) -->
    <div id="paymentTrackingModal" class="modal-backdrop" style="display: none;">
        <div class="modal-container max-w-6xl">
            <!-- Header with Summary -->
            <div class="modal-header bg-gradient-to-r from-green-600 to-green-400 text-white">
                <div class="flex-1">
                    <h2 class="text-xl font-bold" id="paymentEventName">Payment Tracking</h2>
                    <p class="text-sm text-green-100 mt-1" id="paymentEventDate">Event Date</p>

                    <!-- Real-time Balance Summary -->
                    <div class="grid grid-cols-4 gap-3 mt-4 text-center">
                        <div class="bg-white/10 rounded-lg p-2">
                            <div class="text-2xl font-bold" id="totalExpected">฿0</div>
                            <div class="text-xs text-green-100">Total Expected</div>
                        </div>
                        <div class="bg-white/10 rounded-lg p-2">
                            <div class="text-2xl font-bold" id="totalCollected">฿0</div>
                            <div class="text-xs text-green-100">Collected</div>
                        </div>
                        <div class="bg-white/10 rounded-lg p-2">
                            <div class="text-2xl font-bold" id="outstandingBalance">฿0</div>
                            <div class="text-xs text-green-100">Outstanding</div>
                        </div>
                        <div class="bg-white/10 rounded-lg p-2">
                            <div class="text-2xl font-bold" id="paymentPercentage">0%</div>
                            <div class="text-xs text-green-100">Paid</div>
                        </div>
                    </div>
                </div>
                <button onclick="closePaymentTracking()" class="text-white hover:bg-white/20 rounded-lg p-2">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="modal-body">
                <!-- Filter Tabs -->
                <div class="flex gap-2 mb-4 border-b">
                    <button onclick="filterPayments('all')" id="filterAll" class="payment-filter-btn active px-4 py-2 border-b-2 border-green-600 text-green-600 font-medium">
                        All (<span id="countAll">0</span>)
                    </button>
                    <button onclick="filterPayments('unpaid')" id="filterUnpaid" class="payment-filter-btn px-4 py-2 text-gray-600 hover:text-green-600">
                        Unpaid (<span id="countUnpaid">0</span>)
                    </button>
                    <button onclick="filterPayments('partial')" id="filterPartial" class="payment-filter-btn px-4 py-2 text-gray-600 hover:text-green-600">
                        Partial (<span id="countPartial">0</span>)
                    </button>
                    <button onclick="filterPayments('paid')" id="filterPaid" class="payment-filter-btn px-4 py-2 text-gray-600 hover:text-green-600">
                        Paid (<span id="countPaid">0</span>)
                    </button>
                </div>

                <!-- Payment Checklist Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr class="text-left text-xs font-semibold text-gray-600">
                                <th class="px-3 py-2">Player</th>
                                <th class="px-3 py-2 text-center">HCP</th>
                                <th class="px-3 py-2 text-right">Green</th>
                                <th class="px-3 py-2 text-right">Cart</th>
                                <th class="px-3 py-2 text-right">Caddy</th>
                                <th class="px-3 py-2 text-right">Trans</th>
                                <th class="px-3 py-2 text-right">Comp</th>
                                <th class="px-3 py-2 text-right">Total</th>
                                <th class="px-3 py-2 text-center">Status</th>
                                <th class="px-3 py-2 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="paymentChecklistTable">
                            <!-- Populated dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="paymentEmptyState" class="text-center py-12 text-gray-500" style="display: none;">
                    <span class="material-symbols-outlined text-6xl text-gray-300">payments</span>
                    <p class="mt-4">No payments to display</p>
                </div>

                <!-- Actions -->
                <div class="flex justify-between items-center mt-6">
                    <button onclick="exportPaymentChecklist()" class="btn-secondary">
                        <span class="material-symbols-outlined text-sm">download</span>
                        Export CSV
                    </button>
                    <button onclick="refreshPaymentData()" class="btn-secondary">
                        <span class="material-symbols-outlined text-sm">refresh</span>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Detail Modal (for marking individual fees paid) -->
    <div id="paymentDetailModal" class="modal-backdrop" style="display: none;">
        <div class="modal-container max-w-2xl">
            <div class="modal-header bg-gradient-to-r from-green-600 to-green-400 text-white">
                <div>
                    <h3 class="text-lg font-bold" id="detailPlayerName">Player Payment</h3>
                    <p class="text-sm text-green-100" id="detailTotalAmount">Total: ฿0</p>
                </div>
                <button onclick="closePaymentDetail()" class="text-white hover:bg-white/20 rounded-lg p-1">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="modal-body">
                <!-- Fee Breakdown -->
                <div id="feeBreakdownContainer" class="space-y-3">
                    <!-- Populated dynamically -->
                </div>

                <!-- Payment Method -->
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                    <select id="paymentMethod" class="w-full border rounded-lg px-3 py-2">
                        <option value="cash">Cash</option>
                        <option value="card">Credit/Debit Card</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="line_pay">LINE Pay</option>
                        <option value="promptpay">PromptPay</option>
                    </select>
                </div>

                <!-- Notes -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes (optional)</label>
                    <textarea id="paymentNotes" rows="2" class="w-full border rounded-lg px-3 py-2" placeholder="Add any payment notes..."></textarea>
                </div>

                <!-- Actions -->
                <div class="flex gap-3 mt-6">
                    <button onclick="markAllPaid()" class="btn-primary flex-1">
                        <span class="material-symbols-outlined text-sm">check_circle</span>
                        Mark All Paid
                    </button>
                    <button onclick="closePaymentDetail()" class="btn-secondary flex-1">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Where Modal (shows breakdown by location) -->
    <div id="paymentWhereModal" class="modal-backdrop" style="display: none;">
        <div class="modal-container max-w-4xl">
            <div class="modal-header bg-gradient-to-r from-blue-600 to-blue-400 text-white">
                <h3 class="text-lg font-bold">Payment Breakdown by Location</h3>
                <button onclick="closePaymentWhere()" class="text-white hover:bg-white/20 rounded-lg p-1">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="grid grid-cols-2 gap-4">
                    <!-- Society Bar -->
                    <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl p-4 border-2 border-amber-200">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="material-symbols-outlined text-amber-600">local_bar</span>
                            <h4 class="font-bold text-gray-900">Society Bar</h4>
                        </div>
                        <div class="text-2xl font-bold text-amber-600" id="barAmount">฿0</div>
                        <div class="text-sm text-gray-600 mt-1" id="barCount">0 players</div>
                        <div class="mt-3 text-xs text-gray-500" id="barFees">
                            <!-- Fee breakdown -->
                        </div>
                    </div>

                    <!-- Golf Course -->
                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 border-2 border-green-200">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="material-symbols-outlined text-green-600">golf_course</span>
                            <h4 class="font-bold text-gray-900">Golf Course</h4>
                        </div>
                        <div class="text-2xl font-bold text-green-600" id="courseAmount">฿0</div>
                        <div class="text-sm text-gray-600 mt-1" id="courseCount">0 players</div>
                        <div class="mt-3 text-xs text-gray-500" id="courseFees">
                            <!-- Fee breakdown -->
                        </div>
                    </div>

                    <!-- Online -->
                    <div class="bg-gradient-to-br from-sky-50 to-sky-100 rounded-xl p-4 border-2 border-sky-200">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="material-symbols-outlined text-sky-600">payments</span>
                            <h4 class="font-bold text-gray-900">Online Payment</h4>
                        </div>
                        <div class="text-2xl font-bold text-sky-600" id="onlineAmount">฿0</div>
                        <div class="text-sm text-gray-600 mt-1" id="onlineCount">0 players</div>
                        <div class="mt-3 text-xs text-gray-500" id="onlineFees">
                            <!-- Fee breakdown -->
                        </div>
                    </div>

                    <!-- Organizer -->
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 border-2 border-purple-200">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="material-symbols-outlined text-purple-600">person</span>
                            <h4 class="font-bold text-gray-900">Pay Organizer</h4>
                        </div>
                        <div class="text-2xl font-bold text-purple-600" id="organizerAmount">฿0</div>
                        <div class="text-sm text-gray-600 mt-1" id="organizerCount">0 players</div>
                        <div class="mt-3 text-xs text-gray-500" id="organizerFees">
                            <!-- Fee breakdown -->
                        </div>
                    </div>
                </div>

                <div class="mt-6 text-center">
                    <button onclick="closePaymentWhere()" class="btn-primary">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Golfer Payment Selection Modal -->
    <div id="golferPaymentModal" class="modal-backdrop" style="display: none;">
        <div class="modal-container max-w-2xl">
            <div class="modal-header bg-gradient-to-r from-sky-600 to-sky-400 text-white">
                <div>
                    <h2 class="text-xl font-bold">Select Payment Options</h2>
                    <p class="text-sm text-sky-100 mt-1">Choose where you'd like to pay each fee</p>
                </div>
                <button onclick="closeGolferPaymentModal()" class="text-white hover:bg-white/20 rounded-lg p-2">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="modal-body">
                <!-- Event Summary -->
                <div class="bg-gradient-to-br from-sky-50 to-sky-100 rounded-xl p-4 mb-6 border border-sky-200">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="material-symbols-outlined text-sky-600 text-3xl">event</span>
                        <div>
                            <h3 class="font-bold text-gray-900" id="paymentEventTitle">Event Name</h3>
                            <p class="text-sm text-gray-600" id="paymentEventInfo">Event Date</p>
                        </div>
                    </div>
                </div>

                <!-- Fee Selection Grid -->
                <div class="space-y-4" id="feeSelectionContainer">
                    <!-- Green Fee -->
                    <div class="payment-selection-item">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h4 class="font-bold text-gray-900">Green Fee</h4>
                                <p class="text-sm text-gray-600">Golf course entry fee</p>
                            </div>
                            <div class="text-2xl font-bold text-sky-600" id="greenFeeAmount">฿0</div>
                        </div>
                        <select id="payGreenAt" class="payment-location-select w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-sky-500 focus:ring-2 focus:ring-sky-200">
                            <option value="">Choose payment location...</option>
                            <option value="bar">Society Bar</option>
                            <option value="course">Golf Course</option>
                            <option value="organizer">Pay Organizer</option>
                        </select>
                    </div>

                    <!-- Cart Fee -->
                    <div class="payment-selection-item">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h4 class="font-bold text-gray-900">Cart Fee</h4>
                                <p class="text-sm text-gray-600">Golf cart rental</p>
                            </div>
                            <div class="text-2xl font-bold text-sky-600" id="cartFeeAmount">฿0</div>
                        </div>
                        <select id="payCartAt" class="payment-location-select w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-sky-500 focus:ring-2 focus:ring-sky-200">
                            <option value="">Choose payment location...</option>
                            <option value="bar">Society Bar</option>
                            <option value="course">Golf Course</option>
                            <option value="organizer">Pay Organizer</option>
                        </select>
                    </div>

                    <!-- Caddy Fee -->
                    <div class="payment-selection-item">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h4 class="font-bold text-gray-900">Caddy Fee</h4>
                                <p class="text-sm text-gray-600">Caddie service fee</p>
                            </div>
                            <div class="text-2xl font-bold text-sky-600" id="caddyFeeAmount">฿0</div>
                        </div>
                        <select id="payCaddyAt" class="payment-location-select w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-sky-500 focus:ring-2 focus:ring-sky-200">
                            <option value="">Choose payment location...</option>
                            <option value="bar">Society Bar</option>
                            <option value="course">Golf Course</option>
                            <option value="organizer">Pay Organizer</option>
                        </select>
                    </div>

                    <!-- Transport Fee (if applicable) -->
                    <div id="transportFeeSection" class="payment-selection-item" style="display: none;">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h4 class="font-bold text-gray-900">Transport Fee</h4>
                                <p class="text-sm text-gray-600">Transportation to course</p>
                            </div>
                            <div class="text-2xl font-bold text-sky-600" id="transportFeeAmount">฿0</div>
                        </div>
                        <select id="payTransportAt" class="payment-location-select w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-sky-500 focus:ring-2 focus:ring-sky-200">
                            <option value="">Choose payment location...</option>
                            <option value="bar">Society Bar</option>
                            <option value="organizer">Pay Organizer</option>
                        </select>
                    </div>

                    <!-- Competition Fee (if applicable) -->
                    <div id="competitionFeeSection" class="payment-selection-item" style="display: none;">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h4 class="font-bold text-gray-900">Competition Fee</h4>
                                <p class="text-sm text-gray-600">Entry into competition prizes</p>
                            </div>
                            <div class="text-2xl font-bold text-sky-600" id="competitionFeeAmount">฿0</div>
                        </div>
                        <select id="payCompetitionAt" class="payment-location-select w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-sky-500 focus:ring-2 focus:ring-sky-200">
                            <option value="">Choose payment location...</option>
                            <option value="bar">Society Bar</option>
                            <option value="organizer">Pay Organizer</option>
                        </select>
                    </div>
                </div>

                <!-- Total Summary -->
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 mt-6 border-2 border-green-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold text-gray-900">Total Amount Due</h3>
                            <p class="text-sm text-gray-600">All fees combined</p>
                        </div>
                        <div class="text-4xl font-bold text-green-600" id="totalPaymentAmount">฿0</div>
                    </div>
                </div>

                <!-- Payment Summary Breakdown -->
                <div class="mt-4 space-y-2">
                    <h4 class="font-medium text-gray-700 text-sm">Payment Summary by Location:</h4>
                    <div id="paymentBreakdownSummary" class="grid grid-cols-2 gap-2 text-xs">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-3 mt-6">
                    <button onclick="saveGolferPaymentSelections()" class="btn-primary flex-1">
                        <span class="material-symbols-outlined text-sm">check</span>
                        Confirm Selections
                    </button>
                    <button onclick="closeGolferPaymentModal()" class="btn-secondary flex-1">
                        Cancel
                    </button>
                </div>

                <!-- Helper Text -->
                <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="flex gap-2">
                        <span class="material-symbols-outlined text-blue-600 text-sm">info</span>
                        <p class="text-xs text-blue-900">
                            <strong>Important:</strong> Select where you prefer to pay each fee. This helps the organizer track payments.
                            You can pay at the society bar before the round, at the golf course directly, or to the organizer.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Payment Info Card (for registration page) -->
    <div id="quickPaymentInfo" class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl p-4 border border-amber-200 mb-4" style="display: none;">
        <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-amber-600 text-3xl">payments</span>
            <div class="flex-1">
                <h3 class="font-bold text-gray-900 mb-2">Payment Options</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-amber-600 text-sm">local_bar</span>
                        <span><strong>Society Bar:</strong> Pay before the round starts</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-green-600 text-sm">golf_course</span>
                        <span><strong>Golf Course:</strong> Pay directly at the course</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-purple-600 text-sm">person</span>
                        <span><strong>Organizer:</strong> Pay the event organizer</span>
                    </div>
                </div>
                <button onclick="openGolferPaymentModal()" class="mt-3 btn-primary text-sm w-full">
                    Set Payment Preferences
                </button>
            </div>
        </div>
    </div>

    <!-- Share Event Modal -->
    <div id="shareEventModal" class="modal-backdrop" style="display: none;">
        <div class="modal-content max-w-2xl" onclick="event.stopPropagation()">
            <!-- Modal Header -->
            <div class="modal-header bg-blue-500">
                <div>
                    <h2 class="text-2xl font-bold text-white">Share Event</h2>
                    <p class="text-blue-100 text-sm mt-1">Invite friends to join this event</p>
                </div>
                <button onclick="GolferEventsSystem.closeShareModal()" class="text-white hover:text-gray-200">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <!-- Event Summary -->
                <div id="shareEventSummary" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                    <!-- Event details will be populated here -->
                </div>

                <!-- Search Users -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search for users on the platform:</label>
                    <input
                        type="text"
                        id="shareUserSearch"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Search by name, username, or role..."
                        oninput="GolferEventsSystem.filterShareUsers(this.value)"
                    >
                </div>

                <!-- Selected Users -->
                <div id="selectedUsersContainer" class="mb-4" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Selected users:</label>
                    <div id="selectedUsersList" class="flex flex-wrap gap-2 p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <!-- Selected users will appear here -->
                    </div>
                </div>

                <!-- Users List -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Available users:</label>
                    <div id="shareUsersList" class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-96 overflow-y-auto border border-gray-200 rounded-lg p-3">
                        <div class="col-span-full text-center py-8 text-gray-500">
                            <span class="material-symbols-outlined text-4xl mb-2 block">group</span>
                            <p>Loading users...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button onclick="GolferEventsSystem.closeShareModal()" class="btn-secondary">
                    Cancel
                </button>
                <button id="sendInvitesBtn" onclick="GolferEventsSystem.sendEventInvitations()" class="btn-primary bg-blue-500 hover:bg-blue-600" disabled>
                    <span class="material-symbols-outlined text-sm">send</span>
                    Send Invitations (<span id="selectedUserCount">0</span>)
                </button>
            </div>
        </div>
    </div>

    <!-- Add Score Modal -->
    <div id="addScoreModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-screen overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-2xl font-bold text-gray-900">Add Golf Score</h3>
                <button onclick="closeAddScoreModal()" class="text-gray-400 hover:text-gray-600">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Course Name</label>
                    <select id="courseSelect" onchange="handleCourseChange()"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                        <option value="">Select a course...</option>
                    </select>
                    <input type="text" id="courseName" placeholder="Or enter custom course name"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 mt-2"
                           style="display: none;">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tee Marker</label>
                    <select id="teeMarker" onchange="handleTeeChange()"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                        <option value="">Select tee marker...</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Course Rating</label>
                        <input type="number" id="courseRating" placeholder="72.1" step="0.1" min="60" max="80"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-gray-50"
                               readonly>
                        <small class="text-gray-500 text-xs">Auto-populated from course profile</small>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Slope Rating</label>
                        <input type="number" id="slopeRating" placeholder="113" min="55" max="155"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-gray-50"
                               readonly>
                        <small class="text-gray-500 text-xs">Auto-populated from course profile</small>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Score</label>
                        <input type="number" id="scoreValue" placeholder="72" min="30" max="150"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Holes</label>
                        <select id="holesPlayed" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                            <option value="18">18 Holes</option>
                            <option value="9">9 Holes</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date Played</label>
                    <input type="date" id="datePlayed"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                    <textarea id="scoreNotes" placeholder="Great weather, played with friends..." rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500"></textarea>
                </div>
            </div>

            <div class="flex items-center justify-between p-6 border-t border-gray-200 bg-gray-50">
                <button onclick="closeAddScoreModal()" class="px-6 py-3 text-gray-700 bg-gray-200 rounded-xl font-semibold hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
                <button onclick="saveGolfScore()" class="px-6 py-3 bg-primary-600 text-white rounded-xl font-semibold hover:bg-primary-700 transition-colors">
                    Save Score
                </button>
            </div>
        </div>
    </div>

    <script>
        // Golf Score Management System with WHS Handicap
        const GolfScoreSystem = {
            scores: JSON.parse(localStorage.getItem('mcipro_golf_scores') || '[]'),

            saveScore(scoreData) {
                const newScore = {
                    id: Date.now(),
                    course: scoreData.course,
                    courseId: scoreData.courseId || null,
                    tee: scoreData.tee || null,
                    score: parseInt(scoreData.score),
                    holes: parseInt(scoreData.holes),
                    courseRating: parseFloat(scoreData.courseRating) || (scoreData.holes === 18 ? 72.0 : 36.0),
                    slopeRating: parseInt(scoreData.slopeRating) || 113,
                    date: scoreData.date,
                    notes: scoreData.notes || '',
                    timestamp: new Date().toISOString(),
                    differential: null
                };

                // Calculate score differential for WHS
                newScore.differential = this.calculateDifferential(newScore);

                this.scores.unshift(newScore); // Add to beginning for recent first
                localStorage.setItem('mcipro_golf_scores', JSON.stringify(this.scores));
                this.updateStatistics();
                this.refreshRecentRounds();
            },

            // WHS Score Differential Calculation
            calculateDifferential(scoreData) {
                if (scoreData.holes !== 18) return null; // Only calculate for 18-hole rounds

                const { score, courseRating, slopeRating } = scoreData;

                // WHS Formula: (Adjusted Gross Score - Course Rating) × 113 ÷ Slope Rating
                const differential = (score - courseRating) * 113 / slopeRating;
                return Math.round(differential * 10) / 10; // Round to 1 decimal place
            },

            // WHS Handicap Index Calculation
            calculateHandicapIndex() {
                const validScores = this.scores.filter(s => s.holes === 18 && s.differential !== null);

                if (validScores.length < 3) {
                    return null; // Need at least 3 scores for WHS
                }

                // Sort by differential (best to worst)
                const sortedDifferentials = validScores
                    .map(s => s.differential)
                    .sort((a, b) => a - b);

                let handicapIndex;
                const numScores = sortedDifferentials.length;

                if (numScores >= 20) {
                    // Use best 8 of most recent 20 scores
                    const recent20 = sortedDifferentials.slice(0, 20);
                    const best8 = recent20.slice(0, 8);
                    handicapIndex = best8.reduce((sum, diff) => sum + diff, 0) / 8;
                } else if (numScores >= 5) {
                    // Use best 1-3 scores based on WHS table
                    const numToUse = Math.floor(numScores / 4) || 1;
                    const bestScores = sortedDifferentials.slice(0, Math.max(1, numToUse));
                    handicapIndex = bestScores.reduce((sum, diff) => sum + diff, 0) / bestScores.length;
                } else {
                    // 3-4 scores: use best 1
                    handicapIndex = sortedDifferentials[0];
                }

                return Math.round(handicapIndex * 10) / 10; // Round to 1 decimal place
            },

            updateStatistics() {
                if (this.scores.length === 0) return;

                // Calculate WHS Handicap Index
                const whsHandicap = this.calculateHandicapIndex();
                const handicapElements = document.querySelectorAll('.user-handicap');
                handicapElements.forEach(el => {
                    if (whsHandicap !== null) {
                        el.textContent = whsHandicap.toFixed(1);
                        el.setAttribute('title', `WHS Handicap Index (${this.scores.filter(s => s.holes === 18).length} qualifying rounds)`);
                    } else {
                        el.textContent = 'N/A';
                        el.setAttribute('title', 'Need at least 3 eighteen-hole rounds for WHS handicap');
                    }
                });

                // Calculate average score (only for 18-hole rounds)
                const validScores = this.scores.filter(s => s.holes === 18);
                const avgScoreElements = document.querySelectorAll('#golfer-stats .metric-value');

                if (validScores.length > 0) {
                    const average = validScores.reduce((sum, s) => sum + s.score, 0) / validScores.length;
                    // Find average score element (2nd metric-value in stats section)
                    if (avgScoreElements[1]) {
                        avgScoreElements[1].textContent = average.toFixed(1);
                    }

                    // Update best score (3rd metric-value in stats section)
                    const bestScore = Math.min(...validScores.map(s => s.score));
                    if (avgScoreElements[2]) {
                        avgScoreElements[2].textContent = bestScore;
                    }
                } else {
                    // No valid scores yet
                    if (avgScoreElements[1]) avgScoreElements[1].textContent = 'N/A';
                    if (avgScoreElements[2]) avgScoreElements[2].textContent = 'N/A';
                }

                // Update rounds played (4th metric-value in stats section)
                if (avgScoreElements[3]) {
                    avgScoreElements[3].textContent = this.scores.length;
                }
            },

            refreshRecentRounds() {
                const container = document.querySelector('#golfer-stats .space-y-3');
                if (!container) return;

                // Clear existing rounds (keep only the first 3 demo rounds for now)
                const demoRounds = container.children.length;

                // Add new scores at the top
                this.scores.slice(0, 5).forEach((score, index) => {
                    const roundElement = this.createRoundElement(score);
                    if (index === 0) {
                        container.insertBefore(roundElement, container.firstChild);
                    } else {
                        container.insertBefore(roundElement, container.children[index]);
                    }
                });
            },

            createRoundElement(score) {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';

                const par = score.holes === 18 ? 72 : 36;
                const scoreToPar = score.score - par;
                const parDisplay = scoreToPar === 0 ? 'Par' :
                                 scoreToPar > 0 ? `+${scoreToPar} Par` : `${scoreToPar} Par`;
                const parColor = scoreToPar === 0 ? 'text-yellow-600' :
                               scoreToPar > 0 ? 'text-red-600' : 'text-green-600';

                const formattedDate = new Date(score.date).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });

                const differentialDisplay = score.differential !== null ?
                    `<div class="text-xs text-blue-600 mt-1">Diff: ${score.differential}</div>` : '';

                div.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-primary-100 rounded-full flex items-center justify-center">
                            <span class="material-symbols-outlined text-primary-600">golf_course</span>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900">${score.course}</p>
                            <p class="text-sm text-gray-600">${formattedDate} • ${score.holes} holes</p>
                            ${score.courseRating ? `<p class="text-xs text-gray-500">Rating: ${score.courseRating} / Slope: ${score.slopeRating}</p>` : ''}
                            ${score.notes ? `<p class="text-xs text-gray-500 mt-1">${score.notes}</p>` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-2xl text-primary-600">${score.score}</div>
                        <div class="text-xs ${parColor}">${parDisplay}</div>
                        ${differentialDisplay}
                    </div>
                `;

                return div;
            },

            // Load round history table from DATABASE
            async loadRoundHistoryTable() {
                const tbody = document.getElementById('round-history-table');
                if (!tbody) return;

                const userId = AppState.currentUser?.lineUserId;
                let allRounds = [];

                // Load from Supabase database (Live Scorecard rounds)
                if (userId && window.SupabaseDB) {
                    try {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500"><span class="material-symbols-outlined animate-spin">refresh</span> Loading rounds...</td></tr>';

                        const { data: dbRounds, error } = await window.SupabaseDB.client
                            .from('rounds')
                            .select('*')
                            .eq('golfer_id', userId)
                            .order('completed_at', { ascending: false });

                        if (error) {
                            console.error('[Round History] Error loading from database:', error);
                        } else if (dbRounds && dbRounds.length > 0) {
                            // Convert database format to display format
                            const convertedRounds = dbRounds.map(round => ({
                                id: round.id,
                                course: round.course_name,
                                courseId: round.course_id,
                                tee: round.tee_marker,
                                score: round.total_gross,
                                holes: 18, // Database rounds are always 18 holes
                                date: round.completed_at?.split('T')[0] || round.started_at?.split('T')[0],
                                courseRating: round.course_rating || 72.0,
                                slopeRating: round.slope_rating || 113,
                                notes: round.notes || '',
                                differential: null, // Will calculate below
                                timestamp: round.completed_at,
                                source: 'database',
                                type: round.type,
                                stableford: round.total_stableford,
                                handicapUsed: round.handicap_used
                            }));

                            // Calculate differentials for database rounds
                            convertedRounds.forEach(round => {
                                const courseRating = round.courseRating || 72.0;
                                const slopeRating = round.slopeRating || 113;
                                round.differential = ((round.score - courseRating) * 113 / slopeRating).toFixed(1);
                            });

                            allRounds = allRounds.concat(convertedRounds);
                            console.log(`[Round History] ✅ Loaded ${dbRounds.length} rounds from database`);
                        }
                    } catch (error) {
                        console.error('[Round History] Database query failed:', error);
                    }
                }

                // Also load from localStorage (manual entry rounds - backwards compatibility)
                const localRounds = this.scores.map(score => ({
                    ...score,
                    source: 'localStorage'
                }));
                allRounds = allRounds.concat(localRounds);

                // Remove duplicates (prefer database version)
                const uniqueRounds = [];
                const seenIds = new Set();
                for (const round of allRounds) {
                    if (!seenIds.has(round.id)) {
                        uniqueRounds.push(round);
                        seenIds.add(round.id);
                    }
                }

                // Sort by date (newest first)
                uniqueRounds.sort((a, b) => new Date(b.date || b.timestamp) - new Date(a.date || a.timestamp));

                if (uniqueRounds.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No rounds recorded yet. Play a round or click "Add Round" to get started!</td></tr>';

                    // Update stats
                    document.getElementById('rounds-total-count').textContent = '0';
                    document.getElementById('rounds-avg-score').textContent = '-';
                    document.getElementById('rounds-handicap').textContent = '-';
                    document.getElementById('rounds-best-score').textContent = '-';
                    return;
                }

                // Calculate stats
                const validScores = uniqueRounds.filter(s => s.holes === 18 || !s.holes);
                const totalRounds = uniqueRounds.length;
                const avgScore = validScores.length > 0 ? (validScores.reduce((sum, s) => sum + s.score, 0) / validScores.length).toFixed(1) : '-';
                const bestScore = validScores.length > 0 ? Math.min(...validScores.map(s => s.score)) : '-';

                // Use current handicap from profile instead of calculating
                const currentHandicap = AppState.currentUser?.profile_data?.golfInfo?.handicap || AppState.currentUser?.handicap;

                document.getElementById('rounds-total-count').textContent = totalRounds;
                document.getElementById('rounds-avg-score').textContent = avgScore;
                document.getElementById('rounds-handicap').textContent = currentHandicap !== null && currentHandicap !== undefined ? Number(currentHandicap).toFixed(1) : '-';
                document.getElementById('rounds-best-score').textContent = bestScore;

                // Populate table
                tbody.innerHTML = uniqueRounds.map(score => {
                    const par = score.holes === 18 ? 72 : (score.holes === 9 ? 36 : 72);
                    const diff = score.score - par;
                    const diffDisplay = diff === 0 ? 'E' : (diff > 0 ? `+${diff}` : diff);
                    const scoreColor = diff <= 0 ? 'text-green-600' : (diff <= 5 ? 'text-orange-600' : 'text-red-600');
                    const formattedDate = new Date(score.date || score.timestamp).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });

                    // Show source badge
                    const sourceBadge = score.source === 'database'
                        ? '<span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded ml-2">Live</span>'
                        : '<span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded ml-2">Manual</span>';

                    // Show round type for database rounds
                    const roundType = score.type === 'society'
                        ? '<span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded ml-1">Society</span>'
                        : '';

                    return `
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-3 px-4">${formattedDate}</td>
                            <td class="py-3 px-4 font-medium">
                                ${score.course}
                                ${sourceBadge}
                                ${roundType}
                            </td>
                            <td class="py-3 px-4 text-center">${score.holes || 18}</td>
                            <td class="py-3 px-4 text-center font-bold ${scoreColor}">${score.score}</td>
                            <td class="py-3 px-4 text-center">${par}</td>
                            <td class="py-3 px-4 text-center">${diffDisplay}</td>
                            <td class="py-3 px-4 text-center">${score.differential || '-'}</td>
                            <td class="py-3 px-4 text-right">
                                ${score.source === 'localStorage' ? `
                                    <button onclick="GolfScoreSystem.editRound(${score.id})" class="text-primary-600 hover:text-primary-800 text-sm mr-2">Edit</button>
                                    <button onclick="GolfScoreSystem.deleteRound(${score.id})" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                                ` : `
                                    <button onclick="GolfScoreSystem.viewRoundDetails('${score.id}')" class="text-primary-600 hover:text-primary-800 text-sm">View Details</button>
                                `}
                            </td>
                        </tr>
                    `;
                }).join('');

                console.log(`[Round History] Displayed ${uniqueRounds.length} total rounds (${allRounds.filter(r => r.source === 'database').length} from database, ${allRounds.filter(r => r.source === 'localStorage').length} from localStorage)`);
            },

            // View round details (for database rounds)
            async viewRoundDetails(roundId) {
                try {
                    const { data: round, error } = await window.SupabaseDB.client
                        .from('rounds')
                        .select('*')
                        .eq('id', roundId)
                        .single();

                    if (error) throw error;

                    // Get hole-by-hole data
                    const { data: holes, error: holesError } = await window.SupabaseDB.client
                        .from('round_holes')
                        .select('*')
                        .eq('round_id', roundId)
                        .order('hole_number');

                    if (holesError) throw holesError;

                    // Populate modal with round summary
                    document.getElementById('roundDetail_course').textContent = round.course_name || '-';
                    document.getElementById('roundDetail_date').textContent = new Date(round.completed_at).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                    document.getElementById('roundDetail_tee').textContent = round.tee_marker || '-';
                    document.getElementById('roundDetail_gross').textContent = round.total_gross || '-';
                    document.getElementById('roundDetail_stableford').textContent = round.total_stableford || 'N/A';
                    document.getElementById('roundDetail_handicap').textContent = round.handicap_used !== null ? Number(round.handicap_used).toFixed(1) : '-';

                    // Populate hole-by-hole table
                    const holesTable = document.getElementById('roundDetail_holesTable');

                    if (holes && holes.length > 0) {
                        // Check if any holes have scramble data
                        const hasScrambleData = holes.some(h => h.drive_player_name || h.putt_player_name);

                        // Populate holes table
                        holesTable.innerHTML = holes.map(h => {
                            // Color code based on score vs par
                            const netDiff = h.net_score - h.par;
                            let scoreColor = 'text-gray-900';
                            if (netDiff < 0) scoreColor = 'text-green-600 font-bold'; // Under par
                            else if (netDiff === 0) scoreColor = 'text-blue-600'; // Par
                            else if (netDiff === 1) scoreColor = 'text-orange-600'; // Bogey
                            else scoreColor = 'text-red-600'; // Double+ bogey

                            // Color code stableford points
                            let pointsColor = 'text-gray-600';
                            if (h.stableford_points >= 3) pointsColor = 'text-green-600 font-bold';
                            else if (h.stableford_points === 2) pointsColor = 'text-blue-600';
                            else if (h.stableford_points === 1) pointsColor = 'text-orange-600';
                            else pointsColor = 'text-red-600';

                            return `
                                <tr class="hover:bg-gray-50">
                                    <td class="py-2 px-3 font-semibold">${h.hole_number}</td>
                                    <td class="py-2 px-3 text-center">${h.par}</td>
                                    <td class="py-2 px-3 text-center text-gray-500">${h.stroke_index || '-'}</td>
                                    <td class="py-2 px-3 text-center">${h.gross_score}</td>
                                    <td class="py-2 px-3 text-center ${scoreColor}">${h.net_score}</td>
                                    <td class="py-2 px-3 text-center ${pointsColor}">${h.stableford_points}</td>
                                </tr>
                            `;
                        }).join('');

                        // Handle scramble data if present
                        if (hasScrambleData) {
                            const scrambleSection = document.getElementById('roundDetail_scrambleSection');
                            const scrambleData = document.getElementById('roundDetail_scrambleData');

                            scrambleData.innerHTML = holes.map(h => {
                                if (!h.drive_player_name && !h.putt_player_name) return '';
                                return `
                                    <div class="flex items-center justify-between bg-white rounded px-3 py-2">
                                        <span class="font-semibold">Hole ${h.hole_number}</span>
                                        <span class="text-gray-600">
                                            ${h.drive_player_name ? `🏌️ Drive: ${h.drive_player_name}` : ''}
                                            ${h.drive_player_name && h.putt_player_name ? ' • ' : ''}
                                            ${h.putt_player_name ? `⛳ Putt: ${h.putt_player_name}` : ''}
                                        </span>
                                    </div>
                                `;
                            }).join('');

                            scrambleSection.classList.remove('hidden');
                        } else {
                            document.getElementById('roundDetail_scrambleSection').classList.add('hidden');
                        }

                        // Add totals row
                        const totalGross = holes.reduce((sum, h) => sum + (h.gross_score || 0), 0);
                        const totalNet = holes.reduce((sum, h) => sum + (h.net_score || 0), 0);
                        const totalPoints = holes.reduce((sum, h) => sum + (h.stableford_points || 0), 0);
                        const totalPar = holes.reduce((sum, h) => sum + (h.par || 0), 0);

                        holesTable.innerHTML += `
                            <tr class="bg-gray-100 font-bold">
                                <td class="py-3 px-3">Total</td>
                                <td class="py-3 px-3 text-center">${totalPar}</td>
                                <td class="py-3 px-3 text-center">-</td>
                                <td class="py-3 px-3 text-center">${totalGross}</td>
                                <td class="py-3 px-3 text-center">${totalNet}</td>
                                <td class="py-3 px-3 text-center text-green-600">${totalPoints}</td>
                            </tr>
                        `;
                    } else {
                        holesTable.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No hole-by-hole data available</td></tr>';
                    }

                    // Show modal
                    document.getElementById('roundDetailsModal').classList.remove('hidden');

                } catch (error) {
                    console.error('[Round History] Error viewing round details:', error);
                    alert('Error loading round details. Please try again.');
                }
            },

            // Close round details modal
            closeRoundDetails() {
                document.getElementById('roundDetailsModal').classList.add('hidden');
            },

            // Render handicap progression chart
            async renderHandicapProgression() {
                const userId = AppState.currentUser?.lineUserId;
                const card = document.getElementById('handicapProgressionCard');

                if (!userId || !window.SupabaseDB) {
                    card.style.display = 'none';
                    return;
                }

                try {
                    // Get all rounds with handicap data, ordered by date
                    const { data: rounds, error } = await window.SupabaseDB.client
                        .from('rounds')
                        .select('*')
                        .eq('golfer_id', userId)
                        .not('handicap_used', 'is', null)
                        .order('completed_at', { ascending: true });

                    if (error) throw error;

                    if (!rounds || rounds.length < 2) {
                        // Need at least 2 rounds to show progression
                        card.style.display = 'none';
                        return;
                    }

                    // Show the card
                    card.style.display = 'block';

                    // Calculate handicap changes
                    const handicapData = rounds.map((round, index) => {
                        const prevHandicap = index > 0 ? rounds[index - 1].handicap_used : round.handicap_used;
                        const change = index > 0 ? round.handicap_used - prevHandicap : 0;

                        return {
                            date: new Date(round.completed_at),
                            course: round.course_name,
                            score: round.total_gross,
                            handicap: round.handicap_used,
                            change: change
                        };
                    });

                    // Find min/max for chart scaling
                    const handicaps = handicapData.map(d => d.handicap);
                    const minHandicap = Math.floor(Math.min(...handicaps));
                    const maxHandicap = Math.ceil(Math.max(...handicaps));
                    const range = maxHandicap - minHandicap || 1;

                    // Update Y-axis labels
                    document.getElementById('handicap_max').textContent = maxHandicap;
                    document.getElementById('handicap_mid').textContent = Math.round((maxHandicap + minHandicap) / 2);
                    document.getElementById('handicap_min').textContent = minHandicap;

                    // Create chart bars (show last 12 rounds max for readability)
                    const recentData = handicapData.slice(-12);
                    const chartBars = document.getElementById('handicapChartBars');

                    chartBars.innerHTML = recentData.map((data, index) => {
                        const heightPercent = ((data.handicap - minHandicap) / range) * 100;
                        const prevHandicap = index > 0 ? recentData[index - 1].handicap : data.handicap;

                        let barColor = 'bg-blue-500';
                        if (data.handicap < prevHandicap) barColor = 'bg-green-500';
                        else if (data.handicap > prevHandicap) barColor = 'bg-red-500';

                        return `
                            <div class="flex-1 flex flex-col items-center group relative">
                                <div class="${barColor} w-full rounded-t transition-all hover:opacity-80"
                                     style="height: ${heightPercent}%; min-height: 8px;"
                                     title="${data.course}: ${data.handicap}">
                                </div>
                                <div class="text-xs text-gray-600 mt-2 font-bold">${data.handicap.toFixed(1)}</div>
                                <div class="text-xs text-gray-400 whitespace-nowrap">${data.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>

                                <!-- Tooltip -->
                                <div class="absolute bottom-full mb-2 hidden group-hover:block bg-gray-800 text-white text-xs rounded py-1 px-2 whitespace-nowrap z-10">
                                    ${data.course}<br>
                                    Score: ${data.score}<br>
                                    HCP: ${data.handicap.toFixed(1)}
                                    ${data.change !== 0 ? `<br>Change: ${data.change > 0 ? '+' : ''}${data.change.toFixed(1)}` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');

                    // Populate history table (last 10 rounds)
                    const historyTable = document.getElementById('handicapHistoryTable');
                    const recentHistory = handicapData.slice(-10).reverse();

                    historyTable.innerHTML = recentHistory.map(data => {
                        let changeDisplay = '-';
                        let changeColor = 'text-gray-500';

                        if (data.change !== 0) {
                            changeDisplay = `${data.change > 0 ? '+' : ''}${data.change.toFixed(1)}`;
                            changeColor = data.change < 0 ? 'text-green-600 font-bold' : 'text-red-600';
                        }

                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="py-2 px-3">${data.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                                <td class="py-2 px-3">${data.course}</td>
                                <td class="py-2 px-3 text-center">${data.score}</td>
                                <td class="py-2 px-3 text-center font-bold">${data.handicap.toFixed(1)}</td>
                                <td class="py-2 px-3 text-center ${changeColor}">${changeDisplay}</td>
                            </tr>
                        `;
                    }).join('');

                    console.log(`[Handicap Progression] Rendered chart with ${rounds.length} rounds`);

                } catch (error) {
                    console.error('[Handicap Progression] Error rendering chart:', error);
                    card.style.display = 'none';
                }
            },

            // Delete round
            deleteRound(scoreId) {
                if (!confirm('Are you sure you want to delete this round? This cannot be undone.')) {
                    return;
                }

                this.scores = this.scores.filter(s => s.id !== scoreId);
                localStorage.setItem('mcipro_golf_scores', JSON.stringify(this.scores));
                this.updateStatistics();
                this.refreshRecentRounds();
                this.loadRoundHistoryTable();

                if (typeof DevMode !== 'undefined' && DevMode.showNotification) {
                    DevMode.showNotification('Round deleted successfully', 'success');
                }
            },

            // Edit round
            editRound(scoreId) {
                const score = this.scores.find(s => s.id === scoreId);
                if (!score) return;

                // Populate modal with existing data
                document.getElementById('courseName').value = score.course;
                document.getElementById('courseRating').value = score.courseRating || '';
                document.getElementById('slopeRating').value = score.slopeRating || '';
                document.getElementById('scoreValue').value = score.score;
                document.getElementById('holesPlayed').value = score.holes;
                document.getElementById('datePlayed').value = score.date;
                document.getElementById('scoreNotes').value = score.notes || '';

                // Store the ID being edited
                window.editingScoreId = scoreId;

                // Show modal
                showAddScoreModal();
            },

            // Initialize year filter
            initializeYearFilter() {
                const yearFilter = document.getElementById('roundHistoryYearFilter');
                if (!yearFilter) return;

                const currentYear = new Date().getFullYear();
                const startYear = 2022; // Earliest year to show
                const years = [];

                // Add "All Years" option
                years.push('<option value="">All Years</option>');

                // Add years from current year back to start year
                for (let year = currentYear; year >= startYear; year--) {
                    years.push(`<option value="${year}"${year === currentYear ? ' selected' : ''}>${year}</option>`);
                }

                yearFilter.innerHTML = years.join('');
                console.log(`[Round History] Year filter populated: ${startYear}-${currentYear}`);
            },

            // Filter round history
            async filterRoundHistory() {
                const courseFilter = document.getElementById('roundHistoryCourseFilter')?.value || '';
                const yearFilter = document.getElementById('roundHistoryYearFilter')?.value || '';
                const teeFilter = document.getElementById('roundHistoryTeeFilter')?.value || '';

                console.log(`[Round History] Filtering - Course: ${courseFilter}, Year: ${yearFilter}, Tee: ${teeFilter}`);

                const tbody = document.getElementById('round-history-table');
                if (!tbody) return;

                // Show loading state
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">Loading...</td></tr>';

                // Get all rounds (database + localStorage)
                let allRounds = [];
                const userId = AppState.currentUser?.lineUserId;

                // Load from database
                if (userId && window.SupabaseDB) {
                    try {
                        const { data: dbRounds, error } = await window.SupabaseDB.client
                            .from('rounds')
                            .select('*')
                            .eq('golfer_id', userId)
                            .order('completed_at', { ascending: false });

                        if (error) {
                            console.error('[Round History] Error loading from database:', error);
                        } else if (dbRounds && dbRounds.length > 0) {
                            // Convert database format
                            const convertedRounds = dbRounds.map(round => ({
                                id: round.id,
                                course: round.course_name,
                                courseId: round.course_id,
                                tee: round.tee_marker,
                                score: round.total_gross,
                                holes: 18,
                                date: round.completed_at,
                                timestamp: round.completed_at,
                                differential: null,
                                source: 'database',
                                type: round.type
                            }));
                            allRounds = allRounds.concat(convertedRounds);
                        }
                    } catch (error) {
                        console.error('[Round History] Database query failed:', error);
                    }
                }

                // Load from localStorage
                const localRounds = this.scores.map(score => ({
                    ...score,
                    source: 'localStorage',
                    courseId: score.courseId || null,
                    tee: score.tee || null
                }));
                allRounds = allRounds.concat(localRounds);

                // Apply filters
                let filteredScores = [...allRounds];

                if (courseFilter) {
                    filteredScores = filteredScores.filter(score =>
                        score.courseId === courseFilter ||
                        score.course?.toLowerCase().includes(courseFilter.toLowerCase())
                    );
                }

                if (yearFilter) {
                    filteredScores = filteredScores.filter(score => {
                        const scoreYear = new Date(score.date || score.timestamp).getFullYear();
                        return scoreYear === parseInt(yearFilter);
                    });
                }

                if (teeFilter) {
                    filteredScores = filteredScores.filter(score =>
                        score.tee?.toLowerCase() === teeFilter.toLowerCase()
                    );
                }

                // Remove duplicates (same ID from database and localStorage)
                const uniqueRounds = [];
                const seenIds = new Set();
                for (const round of filteredScores) {
                    if (!seenIds.has(round.id)) {
                        uniqueRounds.push(round);
                        seenIds.add(round.id);
                    }
                }

                // Render filtered results
                if (uniqueRounds.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No rounds found matching filters</td></tr>';
                    return;
                }

                tbody.innerHTML = uniqueRounds.map(score => {
                    const par = score.holes === 18 ? 72 : (score.holes === 9 ? 36 : 72);
                    const diff = score.score - par;
                    const diffDisplay = diff === 0 ? 'E' : (diff > 0 ? `+${diff}` : diff);
                    const scoreColor = diff <= 0 ? 'text-green-600' : (diff <= 5 ? 'text-orange-600' : 'text-red-600');
                    const formattedDate = new Date(score.date || score.timestamp).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });

                    // Show source badge
                    const sourceBadge = score.source === 'database'
                        ? '<span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded ml-2">Live</span>'
                        : '<span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded ml-2">Manual</span>';

                    // Show round type for database rounds
                    const roundType = score.type === 'society'
                        ? '<span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded ml-1">Society</span>'
                        : '';

                    return `
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-3 px-4">${formattedDate}</td>
                            <td class="py-3 px-4 font-medium">
                                ${score.course}
                                ${sourceBadge}
                                ${roundType}
                            </td>
                            <td class="py-3 px-4 text-center">${score.holes || 18}</td>
                            <td class="py-3 px-4 text-center font-bold ${scoreColor}">${score.score}</td>
                            <td class="py-3 px-4 text-center">${par}</td>
                            <td class="py-3 px-4 text-center">${diffDisplay}</td>
                            <td class="py-3 px-4 text-center">${score.differential || '-'}</td>
                            <td class="py-3 px-4 text-right">
                                ${score.source === 'localStorage' ? `
                                    <button onclick="GolfScoreSystem.editRound(${score.id})" class="text-primary-600 hover:text-primary-800 text-sm mr-2">Edit</button>
                                    <button onclick="GolfScoreSystem.deleteRound(${score.id})" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                                ` : `
                                    <button onclick="GolfScoreSystem.viewRoundDetails('${score.id}')" class="text-primary-600 hover:text-primary-800 text-sm">View Details</button>
                                `}
                            </td>
                        </tr>
                    `;
                }).join('');

                console.log(`[Round History] Filtered ${uniqueRounds.length} rounds (${uniqueRounds.filter(r => r.source === 'database').length} from database, ${uniqueRounds.filter(r => r.source === 'localStorage').length} from localStorage)`);
            }
        };

        // Modal functions
        async function showAddScoreModal() {
            document.getElementById('addScoreModal').style.display = 'flex';
            // Set today's date as default
            document.getElementById('datePlayed').value = new Date().toISOString().split('T')[0];

            // Populate course dropdown
            await populateCourseDropdown();
        }

        async function populateCourseDropdown() {
            const courseSelect = document.getElementById('courseSelect');
            const loader = window.scorecardProfileLoader;

            if (!loader) {
                console.error('Scorecard profile loader not initialized');
                return;
            }

            const courses = loader.getAvailableProfiles().filter(c => c !== 'generic');

            courseSelect.innerHTML = '<option value="">Select a course...</option>';
            courses.forEach(courseId => {
                const option = document.createElement('option');
                option.value = courseId;
                option.textContent = loader.getCourseDisplayName(courseId);
                courseSelect.appendChild(option);
            });

            // Add custom option
            const customOption = document.createElement('option');
            customOption.value = 'custom';
            customOption.textContent = '+ Enter Custom Course';
            courseSelect.appendChild(customOption);
        }

        async function handleCourseChange() {
            const courseSelect = document.getElementById('courseSelect');
            const courseName = document.getElementById('courseName');
            const teeMarker = document.getElementById('teeMarker');
            const courseId = courseSelect.value;

            if (courseId === 'custom') {
                courseName.style.display = 'block';
                courseName.value = '';
                teeMarker.innerHTML = '<option value="">N/A for custom courses</option>';
                teeMarker.disabled = true;
                document.getElementById('courseRating').value = '';
                document.getElementById('slopeRating').value = '';
                document.getElementById('courseRating').removeAttribute('readonly');
                document.getElementById('slopeRating').removeAttribute('readonly');
                return;
            }

            if (!courseId) {
                courseName.style.display = 'none';
                teeMarker.innerHTML = '<option value="">Select course first</option>';
                return;
            }

            courseName.style.display = 'none';
            courseName.value = window.scorecardProfileLoader.getCourseDisplayName(courseId);

            // Load tee options
            const tees = await window.scorecardProfileLoader.getTeeOptions(courseId);
            teeMarker.innerHTML = '<option value="">Select tee marker...</option>';
            teeMarker.disabled = false;

            tees.forEach(tee => {
                const option = document.createElement('option');
                option.value = tee.color;
                option.textContent = `${tee.color} Tees (${tee.name}) - CR: ${tee.course_rating}, SR: ${tee.slope_rating}`;
                option.dataset.courseRating = tee.course_rating;
                option.dataset.slopeRating = tee.slope_rating;
                teeMarker.appendChild(option);
            });
        }

        function handleTeeChange() {
            const teeMarker = document.getElementById('teeMarker');
            const selectedOption = teeMarker.options[teeMarker.selectedIndex];

            if (selectedOption && selectedOption.value) {
                const courseRating = selectedOption.dataset.courseRating;
                const slopeRating = selectedOption.dataset.slopeRating;

                document.getElementById('courseRating').value = courseRating;
                document.getElementById('slopeRating').value = slopeRating;
                document.getElementById('courseRating').setAttribute('readonly', 'readonly');
                document.getElementById('slopeRating').setAttribute('readonly', 'readonly');
            }
        }

        function closeAddScoreModal() {
            document.getElementById('addScoreModal').style.display = 'none';
            // Clear form
            document.getElementById('courseSelect').value = '';
            document.getElementById('courseName').value = '';
            document.getElementById('courseName').style.display = 'none';
            document.getElementById('teeMarker').value = '';
            document.getElementById('courseRating').value = '';
            document.getElementById('slopeRating').value = '';
            document.getElementById('scoreValue').value = '';
            document.getElementById('courseRating').removeAttribute('readonly');
            document.getElementById('slopeRating').removeAttribute('readonly');
            document.getElementById('holesPlayed').value = '18';
            document.getElementById('datePlayed').value = '';
            document.getElementById('scoreNotes').value = '';
        }

        function saveGolfScore() {
            const courseSelect = document.getElementById('courseSelect');
            const courseNameInput = document.getElementById('courseName');
            const teeMarker = document.getElementById('teeMarker');

            // Get course name from dropdown or custom input
            let courseName;
            let courseId;
            let teeColor;

            if (courseSelect.value === 'custom') {
                courseName = courseNameInput.value.trim();
                courseId = null;
                teeColor = null;
            } else if (courseSelect.value) {
                courseId = courseSelect.value;
                courseName = window.scorecardProfileLoader.getCourseDisplayName(courseId);
                teeColor = teeMarker.value || null;
            } else {
                courseName = courseNameInput.value.trim();
                courseId = null;
                teeColor = null;
            }

            const scoreValue = document.getElementById('scoreValue').value;
            const holesPlayed = document.getElementById('holesPlayed').value;
            const courseRating = document.getElementById('courseRating').value;
            const slopeRating = document.getElementById('slopeRating').value;
            const datePlayed = document.getElementById('datePlayed').value;
            const scoreNotes = document.getElementById('scoreNotes').value.trim();

            if (!courseName || !scoreValue || !datePlayed) {
                alert('Please fill in all required fields (Course Name, Score, Date).');
                return;
            }

            const score = parseInt(scoreValue);
            if (score < 30 || score > 150) {
                alert('Please enter a valid score between 30 and 150.');
                return;
            }

            // Validate course/slope ratings if provided
            if (courseRating && (courseRating < 60 || courseRating > 80)) {
                alert('Course rating should be between 60.0 and 80.0');
                return;
            }

            if (slopeRating && (slopeRating < 55 || slopeRating > 155)) {
                alert('Slope rating should be between 55 and 155');
                return;
            }

            // Check if editing existing round
            if (window.editingScoreId) {
                const scoreIndex = GolfScoreSystem.scores.findIndex(s => s.id === window.editingScoreId);
                if (scoreIndex !== -1) {
                    // Update existing score
                    GolfScoreSystem.scores[scoreIndex] = {
                        id: window.editingScoreId,
                        course: courseName,
                        courseId: courseId,
                        tee: teeColor,
                        score: parseInt(scoreValue),
                        holes: parseInt(holesPlayed),
                        courseRating: parseFloat(courseRating) || (holesPlayed === '18' ? 72.0 : 36.0),
                        slopeRating: parseInt(slopeRating) || 113,
                        date: datePlayed,
                        notes: scoreNotes,
                        timestamp: GolfScoreSystem.scores[scoreIndex].timestamp,
                        differential: null
                    };
                    // Recalculate differential
                    GolfScoreSystem.scores[scoreIndex].differential = GolfScoreSystem.calculateDifferential(GolfScoreSystem.scores[scoreIndex]);
                    localStorage.setItem('mcipro_golf_scores', JSON.stringify(GolfScoreSystem.scores));
                    GolfScoreSystem.updateStatistics();
                    GolfScoreSystem.refreshRecentRounds();
                    GolfScoreSystem.loadRoundHistoryTable();
                }
                window.editingScoreId = null;
            } else {
                // Add new score
                GolfScoreSystem.saveScore({
                    course: courseName,
                    courseId: courseId,
                    tee: teeColor,
                    score: scoreValue,
                    holes: holesPlayed,
                    courseRating: courseRating,
                    slopeRating: slopeRating,
                    date: datePlayed,
                    notes: scoreNotes
                });
                // Refresh round history table
                GolfScoreSystem.loadRoundHistoryTable();
            }

            closeAddScoreModal();

            // Show success message
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="material-symbols-outlined">check_circle</span>
                    <span>${window.editingScoreId ? 'Round updated' : 'Score saved'} successfully!</span>
                </div>
            `;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Initialize scores on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                GolfScoreSystem.updateStatistics();
                GolfScoreSystem.refreshRecentRounds();
                GolfScoreSystem.loadRoundHistoryTable();
            }, 1000);
        });

        // Round History Functions
        function addNewRound() {
            // This will use the existing add score modal
            showAddScoreModal();
        }

        function viewRoundDetails(roundId) {
            // Create round details modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto mx-4">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Round Details</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>

                    <!-- Round Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="metric-card text-center">
                            <div class="font-bold text-2xl text-primary-600">76</div>
                            <div class="text-sm text-gray-600">Total Score</div>
                        </div>
                        <div class="metric-card text-center">
                            <div class="font-bold text-2xl text-blue-600">+4</div>
                            <div class="text-sm text-gray-600">To Par</div>
                        </div>
                        <div class="metric-card text-center">
                            <div class="font-bold text-2xl text-green-600">8.2</div>
                            <div class="text-sm text-gray-600">Handicap Diff</div>
                        </div>
                        <div class="metric-card text-center">
                            <div class="font-bold text-2xl text-purple-600">12.4</div>
                            <div class="text-sm text-gray-600">Handicap Index</div>
                        </div>
                    </div>

                    <!-- Course Info -->
                    <div class="metric-card mb-6">
                        <h4 class="font-bold text-gray-900 mb-3">Course Information</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div><span class="font-medium">Course:</span> Phuket Country Club</div>
                            <div><span class="font-medium">Date:</span> Dec 28, 2024</div>
                            <div><span class="font-medium">Tees:</span> Championship</div>
                            <div><span class="font-medium">Weather:</span> Sunny, 78°F</div>
                        </div>
                    </div>

                    <!-- Hole by Hole Scorecard -->
                    <div class="metric-card">
                        <h4 class="font-bold text-gray-900 mb-3">Scorecard</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="text-left py-2 px-3">Hole</th>
                                        <th class="text-center py-2 px-3">1</th>
                                        <th class="text-center py-2 px-3">2</th>
                                        <th class="text-center py-2 px-3">3</th>
                                        <th class="text-center py-2 px-3">4</th>
                                        <th class="text-center py-2 px-3">5</th>
                                        <th class="text-center py-2 px-3">6</th>
                                        <th class="text-center py-2 px-3">7</th>
                                        <th class="text-center py-2 px-3">8</th>
                                        <th class="text-center py-2 px-3">9</th>
                                        <th class="text-center py-2 px-3 font-bold">Out</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-2 px-3 font-medium">Par</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3">3</td>
                                        <td class="text-center py-2 px-3">5</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3">3</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3">5</td>
                                        <td class="text-center py-2 px-3">3</td>
                                        <td class="text-center py-2 px-3 font-bold">35</td>
                                    </tr>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-2 px-3 font-medium">Score</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3">6</td>
                                        <td class="text-center py-2 px-3">3</td>
                                        <td class="text-center py-2 px-3">5</td>
                                        <td class="text-center py-2 px-3">3</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3">5</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3 font-bold">38</td>
                                    </tr>
                                </tbody>
                            </table>

                            <table class="min-w-full text-sm mt-4">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="text-left py-2 px-3">Hole</th>
                                        <th class="text-center py-2 px-3">10</th>
                                        <th class="text-center py-2 px-3">11</th>
                                        <th class="text-center py-2 px-3">12</th>
                                        <th class="text-center py-2 px-3">13</th>
                                        <th class="text-center py-2 px-3">14</th>
                                        <th class="text-center py-2 px-3">15</th>
                                        <th class="text-center py-2 px-3">16</th>
                                        <th class="text-center py-2 px-3">17</th>
                                        <th class="text-center py-2 px-3">18</th>
                                        <th class="text-center py-2 px-3 font-bold">In</th>
                                        <th class="text-center py-2 px-3 font-bold">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-2 px-3 font-medium">Par</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3">3</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3">5</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3">3</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3">5</td>
                                        <td class="text-center py-2 px-3 font-bold">37</td>
                                        <td class="text-center py-2 px-3 font-bold">72</td>
                                    </tr>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-2 px-3 font-medium">Score</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3">2</td>
                                        <td class="text-center py-2 px-3">5</td>
                                        <td class="text-center py-2 px-3">5</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3">4</td>
                                        <td class="text-center py-2 px-3">6</td>
                                        <td class="text-center py-2 px-3 font-bold">38</td>
                                        <td class="text-center py-2 px-3 font-bold text-green-600">76</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // OpenStreetMap Initialization with Leaflet
        function initOpenStreetMap() {
            // Guard against undefined GPSNavigationSystem
            if (!window.GPSNavigationSystem || !GPSNavigationSystem.courseData) {
                console.warn('GPSNavigationSystem not available, skipping map initialization');
                return;
            }

            // Check if map already initialized
            if (window.googleMap) {
                console.log('[GPS] Map already initialized');
                return;
            }

            console.log('[GPS] Initializing map...');

            // Initialize the map with faster loading settings
            window.googleMap = L.map('courseMap', {
                preferCanvas: true,  // Use canvas for better performance
                zoomControl: true,
                attributionControl: false
            }).setView([GPSNavigationSystem.courseData.center.lat, GPSNavigationSystem.courseData.center.lng], 15);
            googleMap = window.googleMap;

            // Use faster OpenStreetMap tiles (much faster than satellite imagery)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                minZoom: 10,
                updateWhenIdle: false,
                updateWhenZooming: false,
                keepBuffer: 2
            }).addTo(googleMap);

            console.log('[GPS] Map tiles loaded');

            // Add hole markers after map is ready
            googleMap.whenReady(() => {
                addHoleMarkers();
                console.log('[GPS] Map fully initialized');

                // Get location immediately when map is ready
                getCurrentLocation();
            });

            // Add click listener for map
            googleMap.on('click', function(event) {
                console.log('Map clicked at:', event.latlng.lat, event.latlng.lng);
            });
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (document.getElementById('courseMap')) {
                    initOpenStreetMap();
                }
            }, 2000);
        });

        function addHoleMarkers() {
            // Clear existing markers
            holeMarkers.forEach(marker => googleMap.removeLayer(marker));
            holeMarkers = [];

            // Add markers for first 9 holes immediately (faster initial load)
            const holesToShow = GPSNavigationSystem.courseData.holes.slice(0, 9);

            holesToShow.forEach(hole => {
                // Tee box marker
                const teeIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #2563eb; color: white; border: 2px solid white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${hole.number}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const teeMarker = L.marker([hole.teeBox.lat, hole.teeBox.lng], { icon: teeIcon })
                    .addTo(googleMap)
                    .bindPopup(`
                        <div style="padding: 8px;">
                            <div style="font-weight: bold; font-size: 16px;">Hole ${hole.number}</div>
                            <div>Par ${hole.par} • ${hole.distance} yards</div>
                            <div style="font-size: 12px; color: #666;">Hazards: ${hole.hazards.join(', ')}</div>
                        </div>
                    `);

                holeMarkers.push(teeMarker);
            });

            // Load back 9 holes after 500ms delay for better performance
            setTimeout(() => {
                const backNine = GPSNavigationSystem.courseData.holes.slice(9);
                backNine.forEach(hole => {
                    const teeIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background: #2563eb; color: white; border: 2px solid white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${hole.number}</div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });

                    const teeMarker = L.marker([hole.teeBox.lat, hole.teeBox.lng], { icon: teeIcon })
                        .addTo(googleMap)
                        .bindPopup(`
                            <div style="padding: 8px;">
                                <div style="font-weight: bold; font-size: 16px;">Hole ${hole.number}</div>
                                <div>Par ${hole.par} • ${hole.distance} yards</div>
                                <div style="font-size: 12px; color: #666;">Hazards: ${hole.hazards.join(', ')}</div>
                            </div>
                        `);

                    holeMarkers.push(teeMarker);
                });
                console.log('[GPS] All 18 holes loaded');
            }, 500);
        }

        function updatePlayerLocation(position) {
            const playerPos = [position.lat, position.lng];

            // Update or create player marker
            if (playerMarker) {
                playerMarker.setLatLng(playerPos);
            } else {
                const playerIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #10b981; border: 3px solid white; border-radius: 50%; width: 24px; height: 24px; box-shadow: 0 0 20px rgba(16, 185, 129, 0.6); animation: pulse 2s infinite;"></div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                playerMarker = L.marker(playerPos, { icon: playerIcon })
                    .addTo(googleMap)
                    .bindPopup('Your Location');

                // Add CSS animation for pulsing effect
                if (!document.getElementById('pulse-animation')) {
                    const style = document.createElement('style');
                    style.id = 'pulse-animation';
                    style.textContent = `
                        @keyframes pulse {
                            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
                            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
                            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }

            // Update accuracy display
            if (position.accuracy) {
                document.getElementById('mapAccuracy').textContent = `GPS Accuracy: ±${Math.round(position.accuracy)}m`;
            }

            // Calculate distances to holes
            calculateDistancesToHoles({lat: position.lat, lng: position.lng});
        }

        function calculateDistancesToHoles(playerPos) {
            let closestHole = null;
            let minDistance = Infinity;

            GPSNavigationSystem.courseData.holes.forEach(hole => {
                // Calculate distance using Leaflet's distance function (in meters)
                const distanceToPin = googleMap.distance(
                    L.latLng(playerPos.lat, playerPos.lng),
                    L.latLng(hole.pin.lat, hole.pin.lng)
                );

                if (distanceToPin < minDistance) {
                    minDistance = distanceToPin;
                    closestHole = hole;
                }
            });

            if (closestHole) {
                // Update UI with current hole info
                document.getElementById('currentHoleNum').textContent = closestHole.number;

                // Convert meters to yards (1 meter = 1.09361 yards)
                const distanceInYards = Math.round(minDistance * 1.09361);
                document.getElementById('pinDistance').textContent = `${distanceInYards} yds`;
            }
        }

        function toggleMapType() {
            if (!googleMap) return;

            if (currentMapType === 'satellite') {
                // Switch to OpenStreetMap
                googleMap.eachLayer(function(layer) {
                    if (layer._url && layer._url.includes('arcgisonline')) {
                        googleMap.removeLayer(layer);
                    }
                });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(googleMap);
                currentMapType = 'osm';
                document.querySelector('[onclick="toggleMapType()"] span:last-child').textContent = 'Street Map';
            } else {
                // Switch back to satellite
                googleMap.eachLayer(function(layer) {
                    if (layer._url && layer._url.includes('openstreetmap')) {
                        googleMap.removeLayer(layer);
                    }
                });
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '&copy; Esri',
                    maxZoom: 19
                }).addTo(googleMap);
                currentMapType = 'satellite';
                document.querySelector('[onclick="toggleMapType()"] span:last-child').textContent = 'Satellite';
            }
        }

        function centerOnPlayer() {
            if (!googleMap || !playerMarker) {
                NotificationManager.show('Player location not available', 'info');
                return;
            }

            googleMap.setView(playerMarker.getLatLng(), 18);
        }

        // Caddy Live Tracking System
        const CaddyTrackingSystem = {
            isTracking: false,
            startTime: null,
            currentHole: 1,
            trackingInterval: null,
            gpsWatchId: null,

            startTracking() {
                this.isTracking = true;
                this.startTime = new Date();
                this.currentHole = 1;

                // Update main dashboard UI
                document.getElementById('trackingNotStarted').style.display = 'none';
                document.getElementById('trackingActive').style.display = 'block';
                document.getElementById('trackingCompleted').style.display = 'none';

                // Update Live Tracking tab UI
                this.updateLiveTrackingTab();

                // Start GPS tracking
                this.startGPSTracking();

                // Start time counter
                this.startTimeCounter();

                // Save state
                localStorage.setItem('caddyTrackingActive', 'true');
                localStorage.setItem('caddyTrackingStartTime', this.startTime.toISOString());

                NotificationManager.show('🏌️ Round tracking started! GPS location active', 'success');
            },

            finishTracking() {
                this.isTracking = false;
                const endTime = new Date();
                const totalTime = this.formatTime(Math.floor((endTime - this.startTime) / 1000));

                // Stop GPS tracking
                this.stopGPSTracking();

                // Stop time counter
                if (this.trackingInterval) {
                    clearInterval(this.trackingInterval);
                }

                // Update UI
                document.getElementById('trackingActive').style.display = 'none';
                document.getElementById('trackingCompleted').style.display = 'block';
                document.getElementById('finalRoundTime').textContent = totalTime;

                // Save completed round data
                this.saveCompletedRound(totalTime);

                // Clear active state
                localStorage.removeItem('caddyTrackingActive');
                localStorage.removeItem('caddyTrackingStartTime');

                NotificationManager.show('🏁 Round completed and saved!', 'success');
            },

            resetTracking() {
                this.isTracking = false;
                this.startTime = null;
                this.currentHole = 1;

                // Reset UI
                document.getElementById('trackingNotStarted').style.display = 'block';
                document.getElementById('trackingActive').style.display = 'none';
                document.getElementById('trackingCompleted').style.display = 'none';

                NotificationManager.show('Ready for new round!', 'info');
            },

            startGPSTracking() {
                if (!navigator.geolocation) return;

                this.gpsWatchId = navigator.geolocation.watchPosition(
                    (position) => {
                        // Update location status
                        document.getElementById('locationStatus').textContent = '📍 Live';

                        // Auto-detect hole progression (simplified)
                        this.updateHoleProgression();
                    },
                    (error) => {
                        document.getElementById('locationStatus').textContent = '❌ GPS Error';
                        console.error('GPS tracking error:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 5000
                    }
                );
            },

            stopGPSTracking() {
                if (this.gpsWatchId) {
                    navigator.geolocation.clearWatch(this.gpsWatchId);
                    this.gpsWatchId = null;
                }
            },

            startTimeCounter() {
                this.trackingInterval = setInterval(() => {
                    if (this.startTime) {
                        this.syncAllDisplays();
                    }
                }, 1000);
            },

            updateHoleProgression() {
                // Simulate hole progression (in real implementation, use GPS coordinates)
                // For demo, auto-advance every 12 minutes
                const elapsed = Math.floor((new Date() - this.startTime) / 1000);
                const estimatedHole = Math.min(Math.floor(elapsed / 720) + 1, 18); // 12 min per hole

                if (estimatedHole !== this.currentHole && estimatedHole <= 18) {
                    this.currentHole = estimatedHole;

                    // Update main dashboard
                    const mainHoleElement = document.getElementById('currentHoleTracking');
                    if (mainHoleElement) {
                        mainHoleElement.textContent = this.currentHole;
                    }

                    // Update Live Tracking tab
                    const liveHoleElement = document.getElementById('caddieCurrentHole');
                    if (liveHoleElement) {
                        liveHoleElement.textContent = this.currentHole;
                    }

                    if (this.currentHole <= 18) {
                        NotificationManager.show(`⛳ Reached Hole ${this.currentHole}`, 'info');
                    }
                }
            },

            updateLiveTrackingTab() {
                // Update the tracking status indicator
                const trackingStatus = document.querySelector('#caddie-tracking .bg-white span');
                if (trackingStatus) {
                    trackingStatus.textContent = this.isTracking ? 'Live Tracking Active' : 'Tracking Stopped';
                }

                // Update hole number
                const liveHoleElement = document.getElementById('caddieCurrentHole');
                if (liveHoleElement) {
                    liveHoleElement.textContent = this.currentHole;
                }

                // Update round time
                if (this.startTime) {
                    const elapsed = Math.floor((new Date() - this.startTime) / 1000);
                    const timeDisplay = this.formatTime(elapsed);

                    // Find and update the "Time on Course" element
                    const timeElements = document.querySelectorAll('#caddie-tracking .font-bold.text-blue-900');
                    if (timeElements.length >= 3) {
                        timeElements[2].textContent = timeDisplay; // Third element is "Time on Course"
                    }
                }

                // Update tracking button text
                const trackingButton = document.querySelector('#caddie-tracking button[onclick="startLiveTracking()"]');
                if (trackingButton) {
                    const buttonText = trackingButton.querySelector('span:not(.material-symbols-outlined)');
                    if (buttonText) {
                        buttonText.textContent = this.isTracking ? 'Stop Tracking' : 'Start Tracking';
                    }

                    // Update onclick for stop functionality
                    if (this.isTracking) {
                        trackingButton.setAttribute('onclick', 'finishLiveTracking()');
                        trackingButton.className = 'btn-danger';
                    } else {
                        trackingButton.setAttribute('onclick', 'startLiveTracking()');
                        trackingButton.className = 'btn-secondary';
                    }
                }
            },

            syncAllDisplays() {
                // Update main dashboard time
                if (this.startTime) {
                    const elapsed = Math.floor((new Date() - this.startTime) / 1000);
                    const timeDisplay = this.formatTime(elapsed);

                    const mainTimeElement = document.getElementById('roundTimeTracking');
                    if (mainTimeElement) {
                        mainTimeElement.textContent = timeDisplay;
                    }
                }

                // Update Live Tracking tab
                this.updateLiveTrackingTab();
            },

            formatTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                if (hours > 0) {
                    return `${hours}:${minutes.toString().padStart(2, '0')}`;
                }
                return `${minutes}:${(seconds % 60).toString().padStart(2, '0')}`;
            },

            saveCompletedRound(totalTime) {
                const roundData = {
                    id: 'round_' + Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    startTime: this.startTime.toISOString(),
                    endTime: new Date().toISOString(),
                    totalTime: totalTime,
                    holesCompleted: 18,
                    golfer: 'John Mitchell', // In real app, get from current assignment
                    course: 'Pattana Golf Resort & Spa'
                };

                const savedRounds = JSON.parse(localStorage.getItem('caddyCompletedRounds') || '[]');
                savedRounds.unshift(roundData);
                localStorage.setItem('caddyCompletedRounds', JSON.stringify(savedRounds));
            },

            // Initialize on page load
            initialize() {
                // Check if tracking was previously active
                const wasTracking = localStorage.getItem('caddyTrackingActive');
                if (wasTracking === 'true') {
                    const startTimeStr = localStorage.getItem('caddyTrackingStartTime');
                    if (startTimeStr) {
                        this.startTime = new Date(startTimeStr);
                        this.startTracking();
                    }
                }
            }
        };

        // Global functions for UI
        function startLiveTracking() {
            CaddyTrackingSystem.startTracking();
        }

        function finishLiveTracking() {
            CaddyTrackingSystem.finishTracking();
        }

        function resetTracking() {
            CaddyTrackingSystem.resetTracking();
        }

        // Function for Live Tracking tab "Update Location" button
        function updateCaddyLocation() {
            if (!navigator.geolocation) {
                NotificationManager.show('GPS not supported by this device', 'error');
                return;
            }

            NotificationManager.show('📍 Getting precise location...', 'info');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Update location status in Live Tracking tab
                    const accuracy = Math.round(position.coords.accuracy);
                    NotificationManager.show(`📍 Location updated with ±${accuracy}m accuracy`, 'success');

                    // Update GPS status display
                    const locationStatus = document.getElementById('locationStatus');
                    if (locationStatus) {
                        locationStatus.textContent = `📍 ${accuracy}m`;
                    }

                    // If tracking is active, also update the main tracking system
                    if (CaddyTrackingSystem.isTracking) {
                        CaddyTrackingSystem.updateHoleProgression();
                    }
                },
                (error) => {
                    const errorMessage = error.code === 1 ? 'Please allow location access' :
                                       error.code === 2 ? 'Location unavailable' : 'Location request timed out';
                    NotificationManager.show(`❌ GPS Error: ${errorMessage}`, 'error');

                    const locationStatus = document.getElementById('locationStatus');
                    if (locationStatus) {
                        locationStatus.textContent = '❌ GPS Error';
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 30000
                }
            );
        }

        // Initialize tracking system and sync displays
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                CaddyTrackingSystem.initialize();

                // Add event listener for tab switching to sync displays
                const trackingTabButton = document.querySelector('button[onclick*="tracking"]');
                if (trackingTabButton) {
                    trackingTabButton.addEventListener('click', () => {
                        setTimeout(() => {
                            CaddyTrackingSystem.syncAllDisplays();
                        }, 100);
                    });
                }
            }, 1500);
        });

        // Enhanced Caddy Tracking System with Sync
        const CaddyTrackingSync = {
            currentState: {
                isTracking: false,
                currentHole: 1,
                startTime: null,
                roundTime: '0:00',
                gpsStatus: 'Live'
            },

            startTracking() {
                this.currentState.isTracking = true;
                this.currentState.startTime = new Date();
                this.currentState.currentHole = 1;
                this.syncAllDisplays();
                this.startRoundTimer();

                // Save state
                localStorage.setItem('caddy_tracking_state', JSON.stringify(this.currentState));

                NotificationManager.show('🏌️ Round tracking started!', 'success');
            },

            finishTracking() {
                this.currentState.isTracking = false;
                this.currentState.startTime = null;
                this.syncAllDisplays();

                // Clear state
                localStorage.removeItem('caddy_tracking_state');

                NotificationManager.show('🏁 Round completed!', 'success');
            },

            updateHole() {
                if (this.currentState.isTracking && this.currentState.currentHole < 18) {
                    this.currentState.currentHole++;
                    this.syncAllDisplays();
                    localStorage.setItem('caddy_tracking_state', JSON.stringify(this.currentState));
                }
            },

            syncAllDisplays() {
                // Sync Overview tab displays
                this.syncOverviewDisplay();
                // Sync Live Tracking tab displays
                this.syncLiveTrackingDisplay();
            },

            syncOverviewDisplay() {
                const trackingNotStarted = document.getElementById('trackingNotStarted');
                const trackingActive = document.getElementById('trackingActive');
                const trackingCompleted = document.getElementById('trackingCompleted');

                if (this.currentState.isTracking) {
                    if (trackingNotStarted) trackingNotStarted.style.display = 'none';
                    if (trackingActive) trackingActive.style.display = 'block';
                    if (trackingCompleted) trackingCompleted.style.display = 'none';

                    // Update Overview tracking data
                    const currentHoleElement = document.getElementById('currentHoleTracking');
                    const roundTimeElement = document.getElementById('roundTimeTracking');
                    const locationStatusElement = document.getElementById('locationStatus');

                    if (currentHoleElement) currentHoleElement.textContent = this.currentState.currentHole;
                    if (roundTimeElement) roundTimeElement.textContent = this.currentState.roundTime;
                    if (locationStatusElement) locationStatusElement.textContent = '📍 ' + this.currentState.gpsStatus;
                } else {
                    if (trackingNotStarted) trackingNotStarted.style.display = 'block';
                    if (trackingActive) trackingActive.style.display = 'none';
                    if (trackingCompleted) trackingCompleted.style.display = 'none';
                }
            },

            syncLiveTrackingDisplay() {
                // This would sync with the Live Tracking tab
                // Update any tracking displays in the Live Tracking tab
                if (typeof CaddyTrackingSystem !== 'undefined') {
                    CaddyTrackingSystem.syncAllDisplays();
                }
            },

            startRoundTimer() {
                if (!this.currentState.isTracking) return;

                setInterval(() => {
                    if (this.currentState.isTracking && this.currentState.startTime) {
                        const elapsed = new Date() - this.currentState.startTime;
                        const hours = Math.floor(elapsed / (1000 * 60 * 60));
                        const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
                        this.currentState.roundTime = `${hours}:${minutes.toString().padStart(2, '0')}`;

                        // Update displays
                        const roundTimeElement = document.getElementById('roundTimeTracking');
                        if (roundTimeElement) roundTimeElement.textContent = this.currentState.roundTime;
                    }
                }, 60000); // Update every minute
            },

            loadState() {
                const saved = localStorage.getItem('caddy_tracking_state');
                if (saved) {
                    this.currentState = { ...this.currentState, ...JSON.parse(saved) };
                    if (this.currentState.startTime) {
                        this.currentState.startTime = new Date(this.currentState.startTime);
                    }
                    this.syncAllDisplays();
                    if (this.currentState.isTracking) {
                        this.startRoundTimer();
                    }
                }
            }
        };

        // Global tracking functions
        function startLiveTracking() {
            CaddyTrackingSync.startTracking();
        }

        function finishLiveTracking() {
            CaddyTrackingSync.finishTracking();
        }

        function updateCurrentHole() {
            CaddyTrackingSync.updateHole();
        }

        // Caddy Earnings Management System
        const CaddyEarningsSystem = {
            earnings: JSON.parse(localStorage.getItem('caddy_earnings') || '[]'),

            toggleForm() {
                const form = document.getElementById('earningsForm');
                if (form.classList.contains('hidden')) {
                    form.classList.remove('hidden');
                    // Set today's date as default
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('earningsDate').value = today;
                    // Set current time as default
                    const now = new Date();
                    const timeString = now.getHours().toString().padStart(2, '0') + ':' +
                                     now.getMinutes().toString().padStart(2, '0');
                    document.getElementById('earningsTime').value = timeString;
                } else {
                    form.classList.add('hidden');
                }
            },

            submitEarnings(event) {
                event.preventDefault();

                const clientName = document.getElementById('clientName').value;
                const serviceType = document.getElementById('serviceType').value;
                const baseFee = parseFloat(document.getElementById('baseFee').value) || 0;
                const tipAmount = parseFloat(document.getElementById('tipAmount').value) || 0;
                const date = document.getElementById('earningsDate').value;
                const time = document.getElementById('earningsTime').value;
                const notes = document.getElementById('earningsNotes').value;

                const newEarning = {
                    id: Date.now(),
                    clientName,
                    serviceType,
                    baseFee,
                    tipAmount,
                    totalAmount: baseFee + tipAmount,
                    date,
                    time,
                    notes,
                    timestamp: new Date()
                };

                this.earnings.unshift(newEarning);
                this.saveEarnings();
                this.refreshEarningsDisplay();
                this.toggleForm();

                // Reset form
                event.target.reset();

                NotificationManager.show(`💰 Earnings of ฿${newEarning.totalAmount} added successfully!`, 'success');
            },

            saveEarnings() {
                localStorage.setItem('caddy_earnings', JSON.stringify(this.earnings));
            },

            refreshEarningsDisplay() {
                // This would update the earnings history display
                // For now, just refresh stats in the hero section
                this.updateHeroStats();
            },

            updateHeroStats() {
                // Calculate total earnings for current month
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                const monthlyEarnings = this.earnings.filter(earning => {
                    const earningDate = new Date(earning.date);
                    return earningDate.getMonth() === currentMonth &&
                           earningDate.getFullYear() === currentYear;
                }).reduce((total, earning) => total + earning.totalAmount, 0);

                // Update the hero section stats
                const monthlyEarningsDisplay = document.querySelector('.premium-gradient .text-sm.md\\:text-lg.font-bold');
                if (monthlyEarningsDisplay && monthlyEarningsDisplay.textContent.includes('฿')) {
                    monthlyEarningsDisplay.textContent = `฿${monthlyEarnings.toLocaleString()}`;
                }
            }
        };

        // Global functions for earnings
        function toggleEarningsForm() {
            CaddyEarningsSystem.toggleForm();
        }

        function submitEarnings(event) {
            CaddyEarningsSystem.submitEarnings(event);
        }

        // Initialize systems on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                CaddyEarningsSystem.updateHeroStats();
                CaddyTrackingSync.loadState();
            }, 1000);
        });
    </script>

    <script>
    (function () {
      // Pick the best available login impl, or use a safe fallback
      function resolveLoginImpl() {
        if (window.FallbackAuthentication && typeof FallbackAuthentication.login === 'function') return FallbackAuthentication.login;
        if (window.Authentication && typeof Authentication.login === 'function') return Authentication.login;
        if (window.Auth && typeof Auth.login === 'function') return Auth.login;
        if (window.LineAuthentication && typeof LineAuthentication.login === 'function') return LineAuthentication.login;

        // 🔧 Fallback: mark a demo golfer as logged in and jump to golferDashboard
        return async function () {
          try {
            window.AppState = window.AppState || {};
            const user = { id: 'john_mitchell', name: 'John Mitchell', role: 'golfer' };
            AppState.user = user;
            localStorage.setItem('mcipro_current_user', JSON.stringify(user));
            if (window.ScreenManager && typeof ScreenManager.navigateTo === 'function') {
              ScreenManager.navigateTo('golferDashboard');
            } else {
              // last-resort route change if ScreenManager isn't ready yet
              location.hash = '#golferDashboard';
            }
            console.info('[Login] Fallback login used.');
            return true;
          } catch (e) {
            console.error('[Login] Fallback failed', e);
            return false;
          }
        };
      }

      // REMOVED: window.login definition here - conflicts with one in HEAD
      // The window.login at line 19538 handles all auth systems properly

      // If the button exists, (re)bind it in case an element id shadowed a function earlier
      document.addEventListener('DOMContentLoaded', function () {
        const btn = document.getElementById('loginBtn') || document.getElementById('login');
        if (btn) btn.onclick = window.login;
      });
    })();
    </script>

    <script>
(function(){
  const USERS_KEY = 'mcipro_users';
  const CURRENT_USER_KEY = 'mcipro_current_user';

  const Auth = {
    _users: null,

    async loadUsers() {
      if (this._users) return this._users;

      // 1) read local
      let local = [];
      try { local = JSON.parse(localStorage.getItem(USERS_KEY) || '[]'); } catch {}

      // 2) read cloud (best-effort; won't throw the page)
      let cloud = [];
      try {
        if (window.SimpleCloudSync) {
          const server = (typeof SimpleCloudSync.loadFromCloud === 'function')
            ? await SimpleCloudSync.loadFromCloud()
            : null;

          if (server) {
            if (Array.isArray(server.users)) cloud = server.users;
            else if (server.users && typeof server.users === 'object') cloud = Object.values(server.users);
          }
        }
      } catch (e) {
        console.warn('[Auth] cloud users load failed:', e);
      }

      // 3) normalize + merge by emailLower
      const byEmail = new Map();
      const add = (u) => {
        if (!u) return;
        const emailLower = (u.email || u.username || '').trim().toLowerCase();
        if (!emailLower) return;
        const prev = byEmail.get(emailLower) || {};
        byEmail.set(emailLower, { ...prev, ...u, email: u.email || u.username, emailLower });
      };
      [...local, ...cloud].forEach(add);

      this._users = [...byEmail.values()];

      // 4) write back local for consistency
      try { localStorage.setItem(USERS_KEY, JSON.stringify(this._users)); } catch {}
      return this._users;
    },

    async saveUsers() {
      try { localStorage.setItem(USERS_KEY, JSON.stringify(this._users || [])); } catch {}
      // best-effort cloud save
      try {
        if (window.SimpleCloudSync && typeof SimpleCloudSync.saveToCloud === 'function') {
          await SimpleCloudSync.saveToCloud({ users: this._users, updatedAt: Date.now() });
        }
      } catch (e) { console.warn('[Auth] cloud save failed:', e); }
    },

    // simple stable hash (emailLower:password) for compat when some users have passwordHash
    hash(pw, emailLower) {
      const s = (emailLower||'') + ':' + (pw||'');
      let h = 0; for (let i=0;i<s.length;i++){ h = (h*31 + s.charCodeAt(i))|0; }
      return 'h' + (h>>>0).toString(16);
    },

    passwordsMatch(user, inputPw) {
      const emailLower = (user.emailLower || user.email || user.username || '').toLowerCase();
      if (user.passwordHash) return user.passwordHash === this.hash(inputPw, emailLower);
      if (user.password)     return user.password === inputPw; // legacy plaintext support
      return false;
    },

    async login(emailOrRole, pw) {
      // Support both login(email, pw) and login(role) for fallback auth
      if (!pw && typeof emailOrRole === 'string' && ['golfer','caddie','manager','proshop','maintenance'].includes(emailOrRole)) {
        // This is fallback login with role only
        if (window.FallbackAuthentication && typeof FallbackAuthentication.login === 'function') {
          return FallbackAuthentication.login(emailOrRole);
        }
        throw new Error('FALLBACK_AUTH_NOT_AVAILABLE');
      }

      // Normal email/password login
      const email = (emailOrRole || document.getElementById('loginEmail')?.value || '').trim();
      const password = (pw || document.getElementById('loginPassword')?.value || '').trim();

      if (!email || !password) throw new Error('MISSING_CREDENTIALS');

      const emailLower = email.toLowerCase();
      const users = await this.loadUsers();

      const u = users.find(x => (x.emailLower || (x.email||x.username||'').toLowerCase()) === emailLower);
      if (!u) throw new Error('NO_SUCH_USER');

      if (!this.passwordsMatch(u, password)) throw new Error('BAD_PASSWORD');

      const current = {
        id: u.id || emailLower,
        name: u.name || u.fullName || email,
        role: u.role || 'golfer',
        email
      };
      localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(current));
      window.AppState = window.AppState || {};
      window.AppState.user = current;

      // Navigate
      const dashboardMap = {
        'golfer': 'golferDashboard',
        'caddie': 'caddieDashboard',
        'manager': 'managerDashboard',
        'proshop': 'proshopDashboard',
        'maintenance': 'maintenanceDashboard'
      };
      const to = dashboardMap[current.role] || 'golferDashboard';
      if (window.ScreenManager?.showScreen) ScreenManager.showScreen(to);
      else location.hash = '#' + to;

      return true;
    },

    async create(email, pw, role='golfer', name='') {
      email = (email || document.getElementById('signupEmail')?.value || '').trim();
      pw    = (pw    || document.getElementById('signupPassword')?.value || '').trim();
      role  = (role  || document.getElementById('signupRole')?.value || 'golfer').trim();
      name  = name || document.getElementById('signupName')?.value || '';

      const emailLower = email.toLowerCase();
      const users = await this.loadUsers();

      if (users.some(u => (u.emailLower||'') === emailLower)) throw new Error('EXISTS');

      const user = {
        id: emailLower,
        email, emailLower,
        role, name,
        passwordHash: this.hash(pw, emailLower)
      };
      users.push(user);
      this._users = users;
      await this.saveUsers();

      return this.login(email, pw);
    }
  };

  // expose safe globals used by the page's buttons
  window.Auth = Auth;
  // REMOVED: window.login definition here - conflicts with ones defined earlier
  // The global window.login definitions at lines 19539 and 26211 handle all auth systems
  window.createAccount = () => Auth.create();
})();

// ===== DEVELOPER MODE: ROLE SWITCHER =====
// Only visible to admin users for testing purposes
const DevMode = {
    // Admin LINE IDs (add your LINE user IDs here)
    ADMIN_LINE_IDS: [
        'U2b6d976f19bca4b2f4374ae0e10ed873' // Pete's LINE ID
    ],

    isAdmin() {
        return window.AppState?.currentUser &&
               (this.ADMIN_LINE_IDS.includes(window.AppState.currentUser.lineUserId) ||
                window.location.search.includes('dev=true') ||
                localStorage.getItem('dev_mode') === 'true');
    },

    init() {
        // Listen for Ctrl+Shift+D to toggle dev mode
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                this.toggle();
            }
        });

        // Check URL for dev mode
        if (window.location.search.includes('dev=true')) {
            localStorage.setItem('dev_mode', 'true');
        }

        // Show switcher if admin
        if (this.isAdmin()) {
            this.show();
        }
    },

    toggle() {
        const current = localStorage.getItem('dev_mode') === 'true';
        localStorage.setItem('dev_mode', (!current).toString());
        if (!current) {
            this.show();
            this.showNotification('Developer Mode Enabled', 'success');
        } else {
            this.hide();
            this.showNotification('Developer Mode Disabled', 'info');
        }
    },

    show() {
        const switcher = document.getElementById('devRoleSwitcher');
        if (switcher) {
            switcher.style.display = 'block';
        }
    },

    hide() {
        const switcher = document.getElementById('devRoleSwitcher');
        if (switcher) {
            switcher.style.display = 'none';
        }
    },

    switchToRole(role) {

        // Update current user role
        if (AppState.currentUser) {
            AppState.currentUser.role = role;

            // Save to localStorage
            const profiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');
            const myProfile = profiles.find(p => p.lineUserId === AppState.currentUser.lineUserId);
            if (myProfile) {
                myProfile.role = role;
                localStorage.setItem('mcipro_user_profiles', JSON.stringify(profiles));
            }

            // Show appropriate dashboard
            const dashboardMap = {
                'golfer': 'golferDashboard',
                'caddie': 'caddieDashboard',
                'manager': 'managerDashboard',
                'proshop': 'proshopDashboard',
                'admin': 'adminDashboard',
                'society_organizer': 'societyOrganizerDashboard'
            };

            const targetScreen = dashboardMap[role];
            if (targetScreen) {
                showScreen(targetScreen);
                this.showNotification(`Switched to ${role.toUpperCase()} dashboard`, 'success');
            }
        }
    },

    showNotification(message, type = 'info') {
        const colors = {
            success: 'bg-green-500',
            info: 'bg-blue-500',
            warning: 'bg-yellow-500',
            error: 'bg-red-500'
        };

        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-[10000] animate-fade-in`;
        notification.innerHTML = `
            <div class="flex items-center space-x-2">
                <span class="material-symbols-outlined">developer_mode</span>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }
};

// Initialize dev mode when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => DevMode.init());
} else {
    DevMode.init();
}

window.DevMode = DevMode;

// ===== ADMIN SYSTEM =====
const AdminSystem = {
    users: [],
    subscriptions: [],
    societies: [],

    init() {
        this.loadData();
        this.updateOverview();
    },

    loadData() {
        // Load all users from localStorage
        this.users = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');

        // Load subscriptions
        this.subscriptions = this.users.map(user => ({
            userId: user.lineUserId,
            username: user.username,
            name: `${user.firstName} ${user.lastName}`,
            tier: user.subscriptionTier || 'free',
            status: 'active',
            nextBilling: this.getNextBillingDate()
        }));

        // Load golf societies from localStorage
        this.societies = JSON.parse(localStorage.getItem('mcipro_golf_societies') || '[]');
    },

    refreshData() {
        this.loadData();
        this.updateOverview();
        this.loadUsersTable();
        this.loadSubscriptionsTable();
        this.loadSocietiesTable();
        DevMode.showNotification('Data refreshed', 'success');
    },

    updateOverview() {
        // Total users
        document.getElementById('admin-total-users').textContent = this.users.length;

        // Calculate revenue
        const prices = {free: 0, silver: 299, gold: 599, platinum: 999};
        const revenue = this.subscriptions.reduce((sum, sub) => {
            return sum + (prices[sub.tier] || 0);
        }, 0);
        document.getElementById('admin-monthly-revenue').textContent = `฿${revenue.toLocaleString()}`;

        // Golf societies count
        document.getElementById('admin-societies-count').textContent = this.societies.length;

        // Active today (simulate)
        document.getElementById('admin-active-today').textContent = Math.floor(this.users.length * 0.3);

        // Load recent signups
        this.loadRecentSignups();
    },

    loadRecentSignups() {
        const container = document.getElementById('admin-recent-signups');
        const recent = this.users.slice(-5).reverse();

        if (recent.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">No signups yet</div>';
            return;
        }

        container.innerHTML = recent.map(user => `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div>
                    <p class="font-medium text-gray-900">${user.firstName} ${user.lastName}</p>
                    <p class="text-xs text-gray-500">${user.role} • ${user.username}</p>
                </div>
                <span class="text-xs text-gray-400">${this.getTimeAgo(user.createdAt)}</span>
            </div>
        `).join('');
    },

    loadUsersTable() {
        const tbody = document.getElementById('admin-users-table');

        if (this.users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No users yet</td></tr>';
            return;
        }

        tbody.innerHTML = this.users.map(user => `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="py-3 px-4">
                    <div class="font-medium text-gray-900">${user.firstName} ${user.lastName}</div>
                    <div class="text-xs text-gray-500">@${user.username}</div>
                </td>
                <td class="py-3 px-4">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${this.getRoleBadgeClass(user.role)}">
                        ${user.role}
                    </span>
                </td>
                <td class="py-3 px-4">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${this.getTierBadgeClass(user.subscriptionTier || 'free')}">
                        ${(user.subscriptionTier || 'free').toUpperCase()}
                    </span>
                </td>
                <td class="py-3 px-4">
                    <span class="text-green-600 text-xs">● Active</span>
                </td>
                <td class="py-3 px-4 text-sm text-gray-600">
                    ${this.formatDate(user.createdAt)}
                </td>
                <td class="py-3 px-4 text-right">
                    <button onclick="AdminSystem.editUser('${user.lineUserId}')" class="text-primary-600 hover:text-primary-800 text-sm mr-2">
                        Edit
                    </button>
                    <button onclick="AdminSystem.viewUser('${user.lineUserId}')" class="text-gray-600 hover:text-gray-800 text-sm">
                        View
                    </button>
                </td>
            </tr>
        `).join('');
    },

    filterUsers() {
        const search = document.getElementById('admin-user-search').value.toLowerCase();
        const roleFilter = document.getElementById('admin-user-role-filter').value;

        let filtered = this.users;

        if (search) {
            filtered = filtered.filter(u =>
                u.firstName.toLowerCase().includes(search) ||
                u.lastName.toLowerCase().includes(search) ||
                u.username.toLowerCase().includes(search)
            );
        }

        if (roleFilter) {
            filtered = filtered.filter(u => u.role === roleFilter);
        }

        const tbody = document.getElementById('admin-users-table');
        tbody.innerHTML = filtered.map(user => `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="py-3 px-4">
                    <div class="font-medium text-gray-900">${user.firstName} ${user.lastName}</div>
                    <div class="text-xs text-gray-500">@${user.username}</div>
                </td>
                <td class="py-3 px-4">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${this.getRoleBadgeClass(user.role)}">
                        ${user.role}
                    </span>
                </td>
                <td class="py-3 px-4">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${this.getTierBadgeClass(user.subscriptionTier || 'free')}">
                        ${(user.subscriptionTier || 'free').toUpperCase()}
                    </span>
                </td>
                <td class="py-3 px-4">
                    <span class="text-green-600 text-xs">● Active</span>
                </td>
                <td class="py-3 px-4 text-sm text-gray-600">
                    ${this.formatDate(user.createdAt)}
                </td>
                <td class="py-3 px-4 text-right">
                    <button onclick="AdminSystem.editUser('${user.lineUserId}')" class="text-primary-600 hover:text-primary-800 text-sm mr-2">
                        Edit
                    </button>
                    <button onclick="AdminSystem.viewUser('${user.lineUserId}')" class="text-gray-600 hover:text-gray-800 text-sm">
                        View
                    </button>
                </td>
            </tr>
        `).join('');
    },

    loadSubscriptionsTable() {
        const tbody = document.getElementById('admin-subscriptions-table');
        const prices = {free: 0, silver: 299, gold: 599, platinum: 999};

        // Calculate subscription counts
        const counts = {free: 0, silver: 0, gold: 0, platinum: 0};
        this.subscriptions.forEach(sub => {
            counts[sub.tier] = (counts[sub.tier] || 0) + 1;
        });

        document.getElementById('admin-free-count').textContent = counts.free;
        document.getElementById('admin-silver-count').textContent = counts.silver;
        document.getElementById('admin-gold-count').textContent = counts.gold;
        document.getElementById('admin-platinum-count').textContent = counts.platinum;

        document.getElementById('admin-silver-revenue').textContent = `฿${(counts.silver * prices.silver).toLocaleString()}/month`;
        document.getElementById('admin-gold-revenue').textContent = `฿${(counts.gold * prices.gold).toLocaleString()}/month`;
        document.getElementById('admin-platinum-revenue').textContent = `฿${(counts.platinum * prices.platinum).toLocaleString()}/month`;

        const paid = this.subscriptions.filter(s => s.tier !== 'free');

        if (paid.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No paid subscriptions yet</td></tr>';
            return;
        }

        tbody.innerHTML = paid.map(sub => `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="py-3 px-4">
                    <div class="font-medium text-gray-900">${sub.name}</div>
                    <div class="text-xs text-gray-500">@${sub.username}</div>
                </td>
                <td class="py-3 px-4">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${this.getTierBadgeClass(sub.tier)}">
                        ${sub.tier.toUpperCase()}
                    </span>
                </td>
                <td class="py-3 px-4 font-medium">฿${prices[sub.tier]}</td>
                <td class="py-3 px-4 text-sm text-gray-600">${sub.nextBilling}</td>
                <td class="py-3 px-4">
                    <span class="text-green-600 text-xs">● Paid</span>
                </td>
                <td class="py-3 px-4 text-right">
                    <button onclick="AdminSystem.editSubscription('${sub.userId}')" class="text-primary-600 hover:text-primary-800 text-sm">
                        Manage
                    </button>
                </td>
            </tr>
        `).join('');
    },

    loadSocietiesTable() {
        const tbody = document.getElementById('admin-societies-table');

        // Update stats
        const totalSocieties = this.societies.length;
        const activeSocieties = this.societies.filter(s => s.status === 'active').length;
        const totalMembers = this.societies.reduce((sum, s) => sum + (s.members?.length || 0), 0);
        const totalEvents = this.societies.reduce((sum, s) => sum + (s.eventsThisMonth || 0), 0);

        document.getElementById('admin-societies-total').textContent = totalSocieties;
        document.getElementById('admin-societies-active').textContent = activeSocieties;
        document.getElementById('admin-societies-members').textContent = totalMembers;
        document.getElementById('admin-societies-events').textContent = totalEvents;

        if (this.societies.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">No golf societies yet</td></tr>';
            return;
        }

        tbody.innerHTML = this.societies.map(society => `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="py-3 px-4">
                    <div class="font-medium text-gray-900">${society.name}</div>
                    <div class="text-xs text-gray-500">${society.location || 'Thailand'}</div>
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm text-gray-900">${society.organizer}</div>
                    <div class="text-xs text-gray-500">${society.organizerContact || ''}</div>
                </td>
                <td class="py-3 px-4 text-center">
                    <span class="font-medium text-gray-900">${society.members?.length || 0}</span>
                </td>
                <td class="py-3 px-4 text-center">
                    <span class="font-medium text-gray-900">${society.eventsThisMonth || 0}</span>
                </td>
                <td class="py-3 px-4 text-sm text-gray-600">
                    ${society.nextEvent || 'No upcoming events'}
                </td>
                <td class="py-3 px-4">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${society.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                        ${society.status || 'active'}
                    </span>
                </td>
                <td class="py-3 px-4 text-right">
                    <button onclick="AdminSystem.editSociety('${society.id}')" class="text-primary-600 hover:text-primary-800 text-sm mr-2">
                        Edit
                    </button>
                    <button onclick="AdminSystem.viewSociety('${society.id}')" class="text-gray-600 hover:text-gray-800 text-sm">
                        View
                    </button>
                </td>
            </tr>
        `).join('');
    },

    filterSocieties() {
        const search = document.getElementById('admin-society-search').value.toLowerCase();
        const statusFilter = document.getElementById('admin-society-status-filter').value;

        let filtered = this.societies;

        if (search) {
            filtered = filtered.filter(s =>
                s.name.toLowerCase().includes(search) ||
                s.organizer.toLowerCase().includes(search)
            );
        }

        if (statusFilter) {
            filtered = filtered.filter(s => s.status === statusFilter);
        }

        const tbody = document.getElementById('admin-societies-table');
        tbody.innerHTML = filtered.map(society => `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="py-3 px-4">
                    <div class="font-medium text-gray-900">${society.name}</div>
                    <div class="text-xs text-gray-500">${society.location || 'Thailand'}</div>
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm text-gray-900">${society.organizer}</div>
                    <div class="text-xs text-gray-500">${society.organizerContact || ''}</div>
                </td>
                <td class="py-3 px-4 text-center">
                    <span class="font-medium text-gray-900">${society.members?.length || 0}</span>
                </td>
                <td class="py-3 px-4 text-center">
                    <span class="font-medium text-gray-900">${society.eventsThisMonth || 0}</span>
                </td>
                <td class="py-3 px-4 text-sm text-gray-600">
                    ${society.nextEvent || 'No upcoming events'}
                </td>
                <td class="py-3 px-4">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${society.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                        ${society.status || 'active'}
                    </span>
                </td>
                <td class="py-3 px-4 text-right">
                    <button onclick="AdminSystem.editSociety('${society.id}')" class="text-primary-600 hover:text-primary-800 text-sm mr-2">
                        Edit
                    </button>
                    <button onclick="AdminSystem.viewSociety('${society.id}')" class="text-gray-600 hover:text-gray-800 text-sm">
                        View
                    </button>
                </td>
            </tr>
        `).join('');
    },

    loadCoursesList() {
        const container = document.getElementById('admin-courses-list');
        const courses = GolfCourses.courses || [];

        container.innerHTML = courses.map(course => `
            <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h4 class="font-bold text-gray-900">${course.name}</h4>
                        <p class="text-sm text-gray-600 mt-1">${course.location}</p>
                        <div class="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                            <span>Caddies: ${this.users.filter(u => u.roleSpecific?.homeClub === course.id).length}</span>
                            <span>Bookings: 0</span>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="AdminSystem.editCourse('${course.id}')" class="text-primary-600 hover:text-primary-800 text-sm">
                            Edit
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    },

    // Helper functions
    getRoleBadgeClass(role) {
        const classes = {
            golfer: 'bg-blue-100 text-blue-800',
            caddie: 'bg-green-100 text-green-800',
            manager: 'bg-orange-100 text-orange-800',
            proshop: 'bg-purple-100 text-purple-800'
        };
        return classes[role] || 'bg-gray-100 text-gray-800';
    },

    getTierBadgeClass(tier) {
        const classes = {
            free: 'bg-gray-100 text-gray-800',
            silver: 'bg-blue-100 text-blue-800',
            gold: 'bg-yellow-100 text-yellow-800',
            platinum: 'bg-purple-100 text-purple-800'
        };
        return classes[tier] || 'bg-gray-100 text-gray-800';
    },

    formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
    },

    getTimeAgo(dateStr) {
        if (!dateStr) return 'Just now';
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffMins < 60) return `${diffMins} mins ago`;
        if (diffHours < 24) return `${diffHours} hours ago`;
        return `${diffDays} days ago`;
    },

    getNextBillingDate() {
        const date = new Date();
        date.setMonth(date.getMonth() + 1);
        return date.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
    },

    // Golf Society action functions
    addSociety() {
        const name = prompt('Enter society name:');
        if (!name) return;

        const organizer = prompt('Enter organizer name:');
        if (!organizer) return;

        const newSociety = {
            id: Date.now().toString(),
            name: name,
            organizer: organizer,
            organizerContact: '',
            location: 'Thailand',
            members: [],
            eventsThisMonth: 0,
            nextEvent: '',
            status: 'active',
            createdAt: new Date().toISOString()
        };

        this.societies.push(newSociety);
        localStorage.setItem('mcipro_golf_societies', JSON.stringify(this.societies));
        this.refreshData();
        DevMode.showNotification('Golf society added successfully', 'success');
    },

    editSociety(societyId) {
        DevMode.showNotification('Society editor coming soon', 'info');
    },

    viewSociety(societyId) {
        const society = this.societies.find(s => s.id === societyId);
        if (society) {
            alert(`Society Details:\n\nName: ${society.name}\nOrganizer: ${society.organizer}\nMembers: ${society.members?.length || 0}\nEvents This Month: ${society.eventsThisMonth || 0}\nStatus: ${society.status}`);
        }
    },

    exportSocieties() {
        const csv = 'Society Name,Organizer,Members,Events This Month,Next Event,Status,Created\n' +
            this.societies.map(s =>
                `"${s.name}",${s.organizer},${s.members?.length || 0},${s.eventsThisMonth || 0},"${s.nextEvent || ''}",${s.status},${this.formatDate(s.createdAt)}`
            ).join('\n');

        const blob = new Blob([csv], {type: 'text/csv'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `golf-societies-export-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        DevMode.showNotification('Societies exported successfully', 'success');
    },

    // Suspend/delete user accounts (for accounts with issues)
    suspendUser(userId) {
        const user = this.users.find(u => u.lineUserId === userId);
        if (user) {
            const confirmed = confirm(`Suspend account for ${user.firstName} ${user.lastName}?\n\nThis should only be done if there's a serious issue with the account.`);
            if (!confirmed) return;

            user.accountStatus = 'suspended';
            const profiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');
            const profile = profiles.find(p => p.lineUserId === userId);
            if (profile) {
                profile.accountStatus = 'suspended';
                localStorage.setItem('mcipro_user_profiles', JSON.stringify(profiles));
            }
            this.refreshData();
            DevMode.showNotification('User account suspended', 'warning');
        }
    },

    editUser(userId) {
        DevMode.showNotification('User editor coming soon', 'info');
    },

    viewUser(userId) {
        const user = this.users.find(u => u.lineUserId === userId);
        if (user) {
            alert(`User Details:\n\nName: ${user.firstName} ${user.lastName}\nRole: ${user.role}\nEmail: ${user.email}\nPhone: ${user.phone}`);
        }
    },

    editSubscription(userId) {
        DevMode.showNotification('Subscription editor coming soon', 'info');
    },

    editCourse(courseId) {
        DevMode.showNotification('Course editor coming soon', 'info');
    },

    addCourse() {
        DevMode.showNotification('Add course feature coming soon', 'info');
    },

    exportUsers() {
        const csv = 'Name,Username,Email,Role,Subscription,Status,Joined\n' +
            this.users.map(u =>
                `"${u.firstName} ${u.lastName}",${u.username},${u.email},${u.role},${u.subscriptionTier || 'free'},active,${this.formatDate(u.createdAt)}`
            ).join('\n');

        const blob = new Blob([csv], {type: 'text/csv'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `users-export-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        DevMode.showNotification('Users exported successfully', 'success');
    },

    toggleMaintenance() {
        const toggle = document.getElementById('admin-maintenance-toggle');
        if (toggle.checked) {
            DevMode.showNotification('Maintenance mode enabled', 'warning');
        } else {
            DevMode.showNotification('Maintenance mode disabled', 'success');
        }
    },

    savePricing() {
        DevMode.showNotification('Pricing updated successfully', 'success');
    },

    clearCache() {
        if (confirm('Are you sure you want to clear the cache? This may log out users.')) {
            DevMode.showNotification('Cache cleared', 'success');
        }
    },

    backupData() {
        const backup = {
            users: this.users,
            bookings: JSON.parse(localStorage.getItem('mcipro_bookings') || '[]'),
            timestamp: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `mcipro-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        DevMode.showNotification('Data backup downloaded', 'success');
    },

    viewLogs() {
        DevMode.showNotification('System logs viewer coming soon', 'info');
    }
};

// Admin tab switching
function showAdminTab(tabName) {
    // Hide all admin tabs
    document.querySelectorAll('.admin-tab-content').forEach(tab => {
        tab.classList.remove('active');
        tab.style.display = 'none';
    });

    // Remove active class from all buttons
    document.querySelectorAll('.admin-tab-button').forEach(btn => {
        btn.classList.remove('active', 'border-primary-600', 'text-primary-600');
        btn.classList.add('text-gray-600');
    });

    // Show selected tab
    const selectedTab = document.getElementById(`admin-${tabName}`);
    if (selectedTab) {
        selectedTab.classList.add('active');
        selectedTab.style.display = 'block';
    }

    // Highlight selected button
    const selectedBtn = document.getElementById(`admin-${tabName}-tab`);
    if (selectedBtn) {
        selectedBtn.classList.add('active', 'border-primary-600', 'text-primary-600');
        selectedBtn.classList.remove('text-gray-600');
    }

    // Load data for specific tabs
    switch(tabName) {
        case 'users':
            AdminSystem.loadUsersTable();
            break;
        case 'subscriptions':
            AdminSystem.loadSubscriptionsTable();
            break;
        case 'caddies':
            AdminSystem.loadCaddyApprovals();
            break;
        case 'courses':
            AdminSystem.loadCoursesList();
            break;
    }
}

window.AdminSystem = AdminSystem;
    </script>

    <!-- Developer Role Switcher (Only visible to admins) -->
    <div id="devRoleSwitcher" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: none;">
        <div class="bg-gray-900 text-white rounded-lg shadow-2xl p-4 border-2 border-yellow-400">
            <div class="flex items-center justify-between mb-3">
                <h4 class="text-xs font-bold flex items-center">
                    <span class="material-symbols-outlined text-yellow-400 mr-1 text-sm">engineering</span>
                    DEV MODE
                </h4>
                <button onclick="DevMode.hide()" class="text-gray-400 hover:text-white">
                    <span class="material-symbols-outlined text-sm">close</span>
                </button>
            </div>
            <div class="space-y-2">
                <button onclick="DevMode.switchToRole('golfer')" class="w-full bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-xs font-medium transition-colors flex items-center justify-center">
                    <span class="material-symbols-outlined text-sm mr-1">golf_course</span>
                    Golfer Dashboard
                </button>
                <button onclick="DevMode.switchToRole('caddie')" class="w-full bg-green-600 hover:bg-green-700 px-3 py-2 rounded text-xs font-medium transition-colors flex items-center justify-center">
                    <span class="material-symbols-outlined text-sm mr-1">person</span>
                    Caddy Dashboard
                </button>
                <button onclick="DevMode.switchToRole('manager')" class="w-full bg-orange-600 hover:bg-orange-700 px-3 py-2 rounded text-xs font-medium transition-colors flex items-center justify-center">
                    <span class="material-symbols-outlined text-sm mr-1">manage_accounts</span>
                    Manager Dashboard
                </button>
                <button onclick="DevMode.switchToRole('proshop')" class="w-full bg-purple-600 hover:bg-purple-700 px-3 py-2 rounded text-xs font-medium transition-colors flex items-center justify-center">
                    <span class="material-symbols-outlined text-sm mr-1">storefront</span>
                    ProShop Dashboard
                </button>
                <button onclick="DevMode.switchToRole('admin')" class="w-full bg-red-600 hover:bg-red-700 px-3 py-2 rounded text-xs font-medium transition-colors flex items-center justify-center">
                    <span class="material-symbols-outlined text-sm mr-1">admin_panel_settings</span>
                    Admin Dashboard
                </button>
                <button onclick="DevMode.switchToRole('society_organizer')" class="w-full bg-sky-600 hover:bg-sky-700 px-3 py-2 rounded text-xs font-medium transition-colors flex items-center justify-center">
                    <span class="material-symbols-outlined text-sm mr-1">groups</span>
                    Society Organizer
                </button>
            </div>
            <div class="mt-3 pt-3 border-t border-gray-700 text-xs text-gray-400">
                Press <kbd class="bg-gray-700 px-1 rounded">Ctrl+Shift+D</kbd> to toggle
            </div>
        </div>
    </div>

    <!-- GM Analytics Engine -->
    <script src="gm-analytics-engine.js"></script>

    <!-- Society Golf Analytics -->
    <script src="society-golf-analytics.js"></script>
    <script src="admin-pricing-control.js"></script>

    <!-- Payment Tracking System -->
    <script src="compacted/payment-tracking-database.js"></script>
    <script src="compacted/payment-tracking-manager.js"></script>
    <script src="compacted/payment-system-integration.js"></script>

    <!-- Analytics Drill-Down & Cash Management -->
    <script src="analytics-drilldown.js"></script>

    <!-- Analytics Export -->
    <script src="analytics-export.js"></script>

    <!-- Reports System -->
    <script src="reports-system.js"></script>

    <!-- Staff Management System -->
    <script src="staff-security.js"></script>
    <script src="staff-management.js"></script>

    <!-- Maintenance Management System -->
    <script src="maintenance-management.js"></script>

    <!-- Weather Integration System -->
    <script src="weather-integration.js"></script>

    <!-- Leaflet Map for Radar -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
    // Initialize Society Analytics when Analytics tab opens
    document.addEventListener('DOMContentLoaded', function() {
        const analyticsTab = document.getElementById('manager-analytics-tab');
        if (analyticsTab) {
            analyticsTab.addEventListener('click', function() {
                setTimeout(() => {
                    SocietyGolfAnalytics.updateRevenueBreakdown('month');
                    SocietyGolfAnalytics.updateSocietyRankings('year');
                }, 150);
            });
        }

        // Initialize Staff Management when Staff tab opens
        const staffTab = document.getElementById('manager-staff-tab');
        if (staffTab) {
            staffTab.addEventListener('click', function() {
                setTimeout(() => {
                    StaffManagement.renderStaffList();
                }, 150);
            });
        }
    });
    </script>


    <script>
    // ============================================
    // SOCIETY GOLF SYSTEM - Supabase Integration
    // ============================================
// ============================================
// SOCIETY GOLF SYSTEM - Supabase Integration
// ============================================

class SocietyGolfSupabase {
    constructor() {
        this.subscriptions = [];
    }

    async waitForSupabase() {
        if (!window.SupabaseDB || !window.SupabaseDB.ready) {
            await new Promise((resolve) => setTimeout(resolve, 100));
            return this.waitForSupabase();
        }
    }

    // =====================================================
    // EVENTS MANAGEMENT
    // =====================================================

    async getEvents(organizerId = null) {
        await this.waitForSupabase();

        // If no organizerId provided, use current user
        if (!organizerId) {
            organizerId = AppState.currentUser?.lineUserId;
        }

        let query = window.SupabaseDB.client
            .from('society_events')
            .select('*')
            .order('date', { ascending: true });

        // Filter by organizer if provided
        if (organizerId) {
            query = query.eq('organizer_id', organizerId);
        }

        const { data, error } = await query;

        if (error) {
            console.error('[SocietyGolf] Error fetching events:', error);
            return [];
        }

        return (data || []).map(e => ({
            id: e.id,
            name: e.name,
            date: e.date,
            startTime: e.start_time,
            cutoff: e.cutoff,
            eventFormat: e.event_format,
            // OLD fee structure (backwards compatibility)
            baseFee: e.base_fee || 0,
            cartFee: e.cart_fee || 0,
            caddyFee: e.caddy_fee || 0,
            // NEW fee structure
            memberFee: e.member_fee || 0,
            nonMemberFee: e.non_member_fee || 0,
            otherFee: e.other_fee || 0,
            transportFee: e.transport_fee || 0,
            competitionFee: e.competition_fee || 0,
            maxPlayers: e.max_players,
            autoWaitlist: e.auto_waitlist !== undefined ? e.auto_waitlist : true,
            organizerId: e.organizer_id,
            organizerName: e.organizer_name,
            status: e.status,
            courseId: e.course_id,
            courseName: e.course_name,
            notes: e.notes,
            registeredCount: e.registered_count || 0,
            recurring: e.recurring || false,
            recurFrequency: e.recur_frequency,
            recurDayOfWeek: e.recur_day_of_week,
            recurMonthlyPattern: e.recur_monthly_pattern,
            recurEndType: e.recur_end_type,
            recurUntil: e.recur_until,
            recurCount: e.recur_count,
            createdAt: e.created_at,
            updatedAt: e.updated_at
        }));
    }

    async getEvent(eventId) {
        await this.waitForSupabase();
        const { data, error } = await window.SupabaseDB.client
            .from('society_events')
            .select('*')
            .eq('id', eventId)
            .single();

        if (error) {
            console.error('[SocietyGolf] Error fetching event:', error);
            return null;
        }

        return data ? {
            id: data.id,
            name: data.name,
            date: data.date,
            startTime: data.start_time,
            cutoff: data.cutoff,
            eventFormat: data.event_format,
            // OLD fee structure (backwards compatibility)
            baseFee: data.base_fee || 0,
            cartFee: data.cart_fee || 0,
            caddyFee: data.caddy_fee || 0,
            // NEW fee structure
            memberFee: data.member_fee || 0,
            nonMemberFee: data.non_member_fee || 0,
            otherFee: data.other_fee || 0,
            transportFee: data.transport_fee || 0,
            competitionFee: data.competition_fee || 0,
            maxPlayers: data.max_players,
            autoWaitlist: data.auto_waitlist !== undefined ? data.auto_waitlist : true,
            organizerId: data.organizer_id,
            organizerName: data.organizer_name,
            status: data.status,
            courseId: data.course_id,
            courseName: data.course_name,
            notes: data.notes,
            recurring: data.recurring || false,
            recurFrequency: data.recur_frequency,
            recurDayOfWeek: data.recur_day_of_week,
            recurMonthlyPattern: data.recur_monthly_pattern,
            recurEndType: data.recur_end_type,
            recurUntil: data.recur_until,
            recurCount: data.recur_count
        } : null;
    }

    async createEvent(eventData) {
        await this.waitForSupabase();
        const { data, error } = await window.SupabaseDB.client
            .from('society_events')
            .insert([{
                id: eventData.id || this.generateId(),
                name: eventData.name,
                date: eventData.date,
                start_time: eventData.startTime,
                cutoff: eventData.cutoff,
                event_format: eventData.eventFormat,
                // NEW: Member/Non-Member pricing
                member_fee: eventData.memberFee || 0,
                non_member_fee: eventData.nonMemberFee || 0,
                other_fee: eventData.otherFee || 0,
                // Keep base_fee for backwards compatibility
                base_fee: eventData.baseFee || eventData.memberFee || 0,
                // OLD: Will be deprecated (keeping for backwards compatibility)
                cart_fee: eventData.cartFee || 0,
                caddy_fee: eventData.caddyFee || 0,
                transport_fee: eventData.transportFee || 0,
                competition_fee: eventData.competitionFee || 0,
                max_players: eventData.maxPlayers,
                auto_waitlist: eventData.autoWaitlist !== undefined ? eventData.autoWaitlist : true,
                organizer_id: eventData.organizerId,
                organizer_name: eventData.organizerName,
                status: 'open',
                course_id: eventData.courseId,
                course_name: eventData.courseName,
                notes: eventData.notes,
                recurring: eventData.recurring || false,
                recur_frequency: eventData.recurFrequency,
                recur_day_of_week: eventData.recurDayOfWeek,
                recur_monthly_pattern: eventData.recurMonthlyPattern,
                recur_end_type: eventData.recurEndType,
                recur_until: eventData.recurUntil,
                recur_count: eventData.recurCount
            }])
            .select()
            .single();

        if (error) {
            console.error('[SocietyGolf] Error creating event:', error);
            throw error;
        }

        return data;
    }

    async updateEvent(eventId, updates) {
        console.log('[SocietyGolfDB] 🔄 updateEvent called for ID:', eventId);
        console.log('[SocietyGolfDB] Updates to apply:', updates);

        await this.waitForSupabase();
        const dbUpdates = {};
        if (updates.name !== undefined) dbUpdates.name = updates.name;
        if (updates.date !== undefined) dbUpdates.date = updates.date;
        if (updates.startTime !== undefined) dbUpdates.start_time = updates.startTime;
        if (updates.cutoff !== undefined) dbUpdates.cutoff = updates.cutoff;
        if (updates.eventFormat !== undefined) dbUpdates.event_format = updates.eventFormat;
        // NEW: Member/Non-Member pricing
        if (updates.memberFee !== undefined) dbUpdates.member_fee = updates.memberFee;
        if (updates.nonMemberFee !== undefined) dbUpdates.non_member_fee = updates.nonMemberFee;
        if (updates.otherFee !== undefined) dbUpdates.other_fee = updates.otherFee;
        // OLD: Keep for backwards compatibility
        if (updates.baseFee !== undefined) dbUpdates.base_fee = updates.baseFee;
        if (updates.cartFee !== undefined) dbUpdates.cart_fee = updates.cartFee;
        if (updates.caddyFee !== undefined) dbUpdates.caddy_fee = updates.caddyFee;
        if (updates.transportFee !== undefined) dbUpdates.transport_fee = updates.transportFee;
        if (updates.competitionFee !== undefined) dbUpdates.competition_fee = updates.competitionFee;
        if (updates.maxPlayers !== undefined) dbUpdates.max_players = updates.maxPlayers;
        if (updates.autoWaitlist !== undefined) dbUpdates.auto_waitlist = updates.autoWaitlist;
        if (updates.status !== undefined) dbUpdates.status = updates.status;
        if (updates.courseName !== undefined) dbUpdates.course_name = updates.courseName;
        if (updates.notes !== undefined) dbUpdates.notes = updates.notes;
        if (updates.recurring !== undefined) dbUpdates.recurring = updates.recurring;
        if (updates.recurFrequency !== undefined) dbUpdates.recur_frequency = updates.recurFrequency;
        if (updates.recurDayOfWeek !== undefined) dbUpdates.recur_day_of_week = updates.recurDayOfWeek;
        if (updates.recurMonthlyPattern !== undefined) dbUpdates.recur_monthly_pattern = updates.recurMonthlyPattern;
        if (updates.recurEndType !== undefined) dbUpdates.recur_end_type = updates.recurEndType;
        if (updates.recurUntil !== undefined) dbUpdates.recur_until = updates.recurUntil;
        if (updates.recurCount !== undefined) dbUpdates.recur_count = updates.recurCount;

        console.log('[SocietyGolfDB] Database updates to send:', dbUpdates);

        const { data, error } = await window.SupabaseDB.client
            .from('society_events')
            .update(dbUpdates)
            .eq('id', eventId)
            .select();

        if (error) {
            console.error('[SocietyGolfDB] ❌ Error updating event:');
            console.error('[SocietyGolfDB] Error message:', error.message);
            console.error('[SocietyGolfDB] Error code:', error.code);
            console.error('[SocietyGolfDB] Error details:', error.details);
            console.error('[SocietyGolfDB] Error hint:', error.hint);
            console.error('[SocietyGolfDB] Full error object:', JSON.stringify(error, null, 2));
            throw error;
        }

        console.log('[SocietyGolfDB] ✅ Event updated successfully in database');
        console.log('[SocietyGolfDB] Updated data:', data);
    }

    async deleteEvent(eventId) {
        await this.waitForSupabase();
        const { error } = await window.SupabaseDB.client
            .from('society_events')
            .delete()
            .eq('id', eventId);

        if (error) {
            console.error('[SocietyGolf] Error deleting event:', error);
            throw error;
        }
    }

    async getAllPublicEvents() {
        await this.waitForSupabase();

        console.log('[SocietyGolf] Fetching all public events...');
        const startTime = Date.now();

        // Get all events first
        const { data: eventsData, error: eventsError } = await window.SupabaseDB.client
            .from('society_events')
            .select('*')
            .order('date', { ascending: true });

        if (eventsError) {
            console.error('[SocietyGolf] Error fetching events:', eventsError);
            return [];
        }

        console.log('[SocietyGolf] Found events:', eventsData?.length || 0);

        if (!eventsData || eventsData.length === 0) {
            return [];
        }

        // PERFORMANCE OPTIMIZATION: Run all 3 queries in PARALLEL
        const eventIds = eventsData.map(e => e.id);
        const organizerIds = [...new Set(eventsData.map(e => e.organizer_id).filter(id => id))];
        const playerId = AppState.currentUser?.lineUserId;

        const [
            regCountsResult,
            societyProfilesResult,
            userRegsResult
        ] = await Promise.all([
            // Query 1: Get registration counts
            window.SupabaseDB.client
                .from('event_registrations')
                .select('event_id')
                .in('event_id', eventIds),

            // Query 2: Get society profiles
            window.SupabaseDB.client
                .from('society_profiles')
                .select('organizer_id, society_name, society_logo')
                .in('organizer_id', organizerIds),

            // Query 3: Get user's registrations (if logged in)
            playerId ? window.SupabaseDB.client
                .from('event_registrations')
                .select('event_id')
                .eq('player_id', playerId)
                .in('event_id', eventIds) : Promise.resolve({ data: [] })
        ]);

        // Count registrations per event
        const regCountMap = {};
        if (regCountsResult.data) {
            regCountsResult.data.forEach(r => {
                regCountMap[r.event_id] = (regCountMap[r.event_id] || 0) + 1;
            });
        }

        // Create map of organizer_id to society profile
        const societyMap = {};
        if (societyProfilesResult.data) {
            societyProfilesResult.data.forEach(s => {
                societyMap[s.organizer_id] = s;
            });
        }

        // Create set of user's registered event IDs
        const registeredEventIds = new Set((userRegsResult.data || []).map(r => r.event_id));

        // FIXED: Debug logging for registration status
        if (playerId && registeredEventIds.size > 0) {
            console.log(`[SocietyGolf] User ${playerId} is registered for ${registeredEventIds.size} events:`, Array.from(registeredEventIds));
        } else if (playerId) {
            console.log(`[SocietyGolf] User ${playerId} has no registrations`);
        }

        // Map events with all data
        const mappedEvents = eventsData.map(e => {
            const society = societyMap[e.organizer_id];
            return {
                id: e.id,
                name: e.name,
                date: e.date,
                startTime: e.start_time,
                cutoff: e.cutoff,
                baseFee: e.base_fee || 0,
                cartFee: e.cart_fee || 0,
                caddyFee: e.caddy_fee || 0,
                transportFee: e.transport_fee || 0,
                competitionFee: e.competition_fee || 0,
                maxPlayers: e.max_players,
                organizerId: e.organizer_id,
                organizerName: e.organizer_name,
                societyName: society?.society_name || e.organizer_name,
                societyLogo: society?.society_logo || '',
                status: e.status,
                courseName: e.course_name,
                eventFormat: e.event_format,
                notes: e.notes,
                registeredCount: regCountMap[e.id] || 0,
                isUserRegistered: registeredEventIds.has(e.id),
                createdAt: e.created_at
            };
        });

        const endTime = Date.now();
        console.log(`[SocietyGolf] ⚡ Loaded ${mappedEvents.length} events in ${endTime - startTime}ms (parallel queries)`);
        return mappedEvents;
    }

    // =====================================================
    // REGISTRATIONS MANAGEMENT
    // =====================================================

    async getRegistrations(eventId) {
        await this.waitForSupabase();
        const { data, error } = await window.SupabaseDB.client
            .from('event_registrations')
            .select('*')
            .eq('event_id', eventId)
            .order('created_at', { ascending: true });

        if (error) {
            console.error('[SocietyGolf] Error fetching registrations:', error);
            return [];
        }

        return (data || []).map(r => ({
            id: r.id,
            eventId: r.event_id,
            playerName: r.player_name,
            playerId: r.player_id,
            handicap: r.handicap,
            partnerPrefs: r.partner_prefs || [],
            wantTransport: r.want_transport,
            wantCompetition: r.want_competition,
            pairedGroup: r.paired_group,
            createdAt: r.created_at,
            // Payment tracking fields
            total_fee: r.total_fee || 0,
            payment_status: r.payment_status || 'unpaid',
            amount_paid: r.amount_paid || 0,
            paid_at: r.paid_at,
            paid_by: r.paid_by
        }));
    }

    async registerPlayer(eventId, playerData) {
        await this.waitForSupabase();

        // Get event details to calculate total_fee
        const event = await this.getEvent(eventId);
        if (!event) {
            throw new Error('Event not found');
        }

        // Check if player is a society member
        const isMember = await this.checkSocietyMembership(playerData.playerId, event.organizerName);

        // Calculate total_fee
        const memberFee = parseFloat(event.memberFee) || parseFloat(event.baseFee) || 0;
        const nonMemberFee = parseFloat(event.nonMemberFee) || 0;
        const transportFee = parseFloat(event.transportFee) || 0;
        const competitionFee = parseFloat(event.competitionFee) || 0;

        let totalFee = isMember ? memberFee : (memberFee + nonMemberFee);

        // Add optional fees if player selected them
        if (playerData.wantTransport && transportFee > 0) {
            totalFee += transportFee;
        }
        if (playerData.wantCompetition && competitionFee > 0) {
            totalFee += competitionFee;
        }

        console.log('[SocietyGolf] Calculated total_fee:', {
            player: playerData.name,
            isMember,
            memberFee,
            nonMemberFee,
            transportFee: playerData.wantTransport ? transportFee : 0,
            competitionFee: playerData.wantCompetition ? competitionFee : 0,
            totalFee
        });

        const { data, error } = await window.SupabaseDB.client
            .from('event_registrations')
            .insert([{
                id: this.generateId(),
                event_id: eventId,
                player_name: playerData.name,
                player_id: playerData.playerId,
                handicap: playerData.handicap,
                partner_prefs: playerData.partnerPrefs || [],
                want_transport: playerData.wantTransport || false,
                want_competition: playerData.wantCompetition || false,
                // NEW: Auto-calculate and save total_fee
                total_fee: totalFee,
                payment_status: 'unpaid'
            }])
            .select()
            .single();

        if (error) {
            console.error('[SocietyGolf] Error registering player:', error);
            throw error;
        }

        return data;
    }

    async checkSocietyMembership(playerId, societyName) {
        // Check if player is a member of this society
        const { data, error } = await window.SupabaseDB.client
            .from('society_members')
            .select('id')
            .eq('golfer_id', playerId)
            .eq('society_name', societyName)
            .eq('status', 'active')
            .maybeSingle();

        if (error) {
            console.error('[SocietyGolf] Error checking membership:', error);
            return false; // Default to non-member if error
        }

        return !!data; // Returns true if member found, false otherwise
    }

    async registerForEvent(registration) {
        // Convenience wrapper for golfers registering for events
        return await this.registerPlayer(registration.eventId, {
            name: registration.playerName,
            playerId: registration.playerId,
            partnerPrefs: registration.partnerPrefs || [],
            handicap: registration.handicap,
            wantTransport: registration.wantTransport,
            wantCompetition: registration.wantCompetition
        });
    }

    async updateRegistration(regId, updates) {
        await this.waitForSupabase();
        const dbUpdates = {};
        if (updates.partnerPrefs !== undefined) dbUpdates.partner_prefs = updates.partnerPrefs;
        if (updates.pairedGroup !== undefined) dbUpdates.paired_group = updates.pairedGroup;
        if (updates.wantTransport !== undefined) dbUpdates.want_transport = updates.wantTransport;
        if (updates.wantCompetition !== undefined) dbUpdates.want_competition = updates.wantCompetition;

        const { error } = await window.SupabaseDB.client
            .from('event_registrations')
            .update(dbUpdates)
            .eq('id', regId);

        if (error) {
            console.error('[SocietyGolf] Error updating registration:', error);
            throw error;
        }
    }

    async deleteRegistration(regId) {
        await this.waitForSupabase();
        const { error } = await window.SupabaseDB.client
            .from('event_registrations')
            .delete()
            .eq('id', regId);

        if (error) {
            console.error('[SocietyGolf] Error deleting registration:', error);
            throw error;
        }
    }

    // =====================================================
    // WAITLIST MANAGEMENT
    // =====================================================

    async getWaitlist(eventId) {
        await this.waitForSupabase();
        const { data, error } = await window.SupabaseDB.client
            .from('event_waitlist')
            .select('*')
            .eq('event_id', eventId)
            .order('position', { ascending: true });

        if (error) {
            console.error('[SocietyGolf] Error fetching waitlist:', error);
            return [];
        }

        return (data || []).map(w => ({
            id: w.id,
            eventId: w.event_id,
            playerName: w.player_name,
            playerId: w.player_id,
            handicap: w.handicap,
            wantTransport: w.want_transport,
            wantCompetition: w.want_competition,
            position: w.position,
            createdAt: w.created_at
        }));
    }

    async joinWaitlist(eventId, playerData) {
        await this.waitForSupabase();
        // Get current max position
        const { data: existing } = await window.SupabaseDB.client
            .from('event_waitlist')
            .select('position')
            .eq('event_id', eventId)
            .order('position', { ascending: false })
            .limit(1);

        const position = (existing && existing.length > 0) ? existing[0].position + 1 : 1;

        const { data, error } = await window.SupabaseDB.client
            .from('event_waitlist')
            .insert([{
                id: this.generateId(),
                event_id: eventId,
                player_name: playerData.name,
                player_id: playerData.playerId,
                handicap: playerData.handicap,
                want_transport: playerData.wantTransport || false,
                want_competition: playerData.wantCompetition || false,
                position: position
            }])
            .select()
            .single();

        if (error) {
            console.error('[SocietyGolf] Error joining waitlist:', error);
            throw error;
        }

        return data;
    }

    async removeFromWaitlist(waitId) {
        await this.waitForSupabase();
        const { error } = await window.SupabaseDB.client
            .from('event_waitlist')
            .delete()
            .eq('id', waitId);

        if (error) {
            console.error('[SocietyGolf] Error removing from waitlist:', error);
            throw error;
        }
    }

    // =====================================================
    // PLAYER SEARCH
    // =====================================================

    async searchPlayers(searchTerm, societyName = null) {
        await this.waitForSupabase();
        if (!searchTerm || searchTerm.length < 2) {
            return [];
        }

        console.log('[SocietyGolf] Searching players:', { searchTerm, societyName });

        // DUAL SEARCH: Platform-wide + Society-specific members
        const results = [];
        const seenIds = new Set();

        // 1. Search society members first (if society name provided)
        if (societyName) {
            try {
                const { data: members, error: memberError } = await window.SupabaseDB.client
                    .from('society_members')
                    .select(`
                        golfer_id,
                        member_number,
                        is_primary_society,
                        user_profiles!inner(line_user_id, name, profile_data)
                    `)
                    .eq('society_name', societyName)
                    .eq('status', 'active')
                    .ilike('user_profiles.name', `%${searchTerm}%`)
                    .limit(10);

                if (!memberError && members) {
                    members.forEach(m => {
                        const profile = m.user_profiles;
                        if (profile && !seenIds.has(m.golfer_id)) {
                            const golfInfo = profile.profile_data?.golfInfo || {};
                            results.push({
                                id: m.golfer_id,
                                name: profile.name,
                                username: profile.name,
                                handicap: golfInfo.handicap ? parseFloat(golfInfo.handicap) : 36,
                                homeClub: golfInfo.homeClub || '',
                                profileData: profile.profile_data,
                                isSocietyMember: true,
                                memberNumber: m.member_number,
                                isPrimarySociety: m.is_primary_society
                            });
                            seenIds.add(m.golfer_id);
                        }
                    });
                    console.log(`[SocietyGolf] Found ${members.length} society members`);
                }
            } catch (err) {
                console.error('[SocietyGolf] Error searching society members:', err);
            }
        }

        // 2. Search platform-wide user_profiles
        try {
            const { data, error } = await window.SupabaseDB.client
                .from('user_profiles')
                .select('line_user_id, name, profile_data')
                .ilike('name', `%${searchTerm}%`)
                .limit(20);

            if (!error && data) {
                data.forEach(p => {
                    if (!seenIds.has(p.line_user_id)) {
                        const golfInfo = p.profile_data?.golfInfo || {};
                        results.push({
                            id: p.line_user_id,
                            name: p.name,
                            username: p.name,
                            handicap: golfInfo.handicap ? parseFloat(golfInfo.handicap) : 36,
                            homeClub: golfInfo.homeClub || '',
                            profileData: p.profile_data,
                            isSocietyMember: false
                        });
                        seenIds.add(p.line_user_id);
                    }
                });
                console.log(`[SocietyGolf] Found ${data.length} platform users`);
            }
        } catch (err) {
            console.error('[SocietyGolf] Error searching platform users:', err);
        }

        console.log(`[SocietyGolf] Total search results: ${results.length}`);
        return results;
    }

    // =====================================================
    // PAIRINGS MANAGEMENT
    // =====================================================

    async getPairings(eventId) {
        await this.waitForSupabase();
        const { data, error } = await window.SupabaseDB.client
            .from('event_pairings')
            .select('*')
            .eq('event_id', eventId);

        if (error) {
            console.error('[SocietyGolf] Error fetching pairings:', error);
            return null;
        }

        // event_id is primary key, so 0 or 1 row max
        const pairing = data && data.length > 0 ? data[0] : null;

        return pairing ? {
            eventId: pairing.event_id,
            groupSize: pairing.group_size,
            groups: pairing.groups,
            lockedAt: pairing.locked_at,
            lockedBy: pairing.locked_by
        } : null;
    }

    async savePairings(eventId, pairingsData) {
        await this.waitForSupabase();
        const { error } = await window.SupabaseDB.client
            .from('event_pairings')
            .upsert({
                event_id: eventId,
                group_size: pairingsData.groupSize,
                groups: pairingsData.groups
            });

        if (error) {
            console.error('[SocietyGolf] Error saving pairings:', error);
            throw error;
        }
    }

    async lockPairings(eventId, userId) {
        await this.waitForSupabase();
        const { error } = await window.SupabaseDB.client
            .from('event_pairings')
            .update({
                locked_at: new Date().toISOString(),
                locked_by: userId
            })
            .eq('event_id', eventId);

        if (error) {
            console.error('[SocietyGolf] Error locking pairings:', error);
            throw error;
        }
    }

    // =====================================================
    // REALTIME SUBSCRIPTIONS
    // =====================================================

    subscribeToEvents(callback) {
        const subscription = window.SupabaseDB.client
            .channel('society_events_changes')
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'society_events'
            }, callback)
            .subscribe();

        this.subscriptions.push(subscription);
        return subscription;
    }

    subscribeToRegistrations(eventId, callback) {
        const subscription = window.SupabaseDB.client
            .channel(`event_${eventId}_registrations`)
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'event_registrations',
                filter: `event_id=eq.${eventId}`
            }, callback)
            .subscribe();

        this.subscriptions.push(subscription);
        return subscription;
    }

    subscribeToWaitlist(eventId, callback) {
        const subscription = window.SupabaseDB.client
            .channel(`event_${eventId}_waitlist`)
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'event_waitlist',
                filter: `event_id=eq.${eventId}`
            }, callback)
            .subscribe();

        this.subscriptions.push(subscription);
        return subscription;
    }

    // =====================================================
    // ORGANIZER MANAGEMENT - ENHANCED STATS & REPORTING
    // =====================================================

    /**
     * Get all events for organizer with comprehensive statistics
     * Includes registration counts, revenue, payment status, etc.
     */
    async getOrganizerEventsWithStats(organizerId) {
        await this.waitForSupabase();

        // Get all events for this organizer
        const { data: events, error: eventsError } = await window.SupabaseDB.client
            .from('society_events')
            .select('*')
            .eq('organizer_id', organizerId)
            .order('date', { ascending: true });

        if (eventsError) {
            console.error('[SocietyGolfDB] Error loading events:', eventsError);
            return [];
        }

        if (!events || events.length === 0) return [];

        const eventIds = events.map(e => e.id);
        console.log('[SocietyGolfDB] Loading stats for event IDs:', eventIds);

        // Parallel queries for all events' data with error handling
        const [regsResult, waitlistResult] = await Promise.all([
            window.SupabaseDB.client
                .from('event_registrations')
                .select('event_id, want_transport, want_competition')
                .in('event_id', eventIds)
                .then(result => {
                    if (result.error) {
                        console.error('[SocietyGolfDB] ❌ Error loading registrations:');
                        console.error('  Error code:', result.error.code);
                        console.error('  Error message:', result.error.message);
                        console.error('  Error details:', result.error.details);
                        console.error('  Error hint:', result.error.hint);
                        console.error('  Full error:', result.error);
                        return { data: [], error: result.error };
                    }
                    return result;
                }),
            window.SupabaseDB.client
                .from('event_waitlist')
                .select('event_id')
                .in('event_id', eventIds)
                .then(result => {
                    if (result.error) {
                        console.error('[SocietyGolfDB] Error loading waitlist:', result.error);
                        return { data: [], error: result.error };
                    }
                    return result;
                })
        ]);

        console.log('[SocietyGolfDB] Registrations loaded:', regsResult.data?.length || 0);
        console.log('[SocietyGolfDB] Waitlist loaded:', waitlistResult.data?.length || 0);

        // Calculate stats per event
        const eventsWithStats = events.map(event => {
            const eventRegs = regsResult.data?.filter(r => r.event_id === event.id) || [];
            const eventWaitlist = waitlistResult.data?.filter(w => w.event_id === event.id) || [];

            console.log(`[SocietyGolfDB] Event ${event.id}: ${eventRegs.length} registrations, ${eventWaitlist.length} waitlist`);

            // Convert snake_case to camelCase
            const camelEvent = {
                id: event.id,
                name: event.name,
                date: event.date,
                startTime: event.start_time,
                cutoff: event.cutoff,
                maxPlayers: event.max_players,
                courseName: event.course_name,
                eventFormat: event.event_format,
                baseFee: event.base_fee || 0,
                cartFee: event.cart_fee || 0,
                caddyFee: event.caddy_fee || 0,
                transportFee: event.transport_fee || 0,
                competitionFee: event.competition_fee || 0,
                autoWaitlist: event.auto_waitlist,
                notes: event.notes,
                organizerId: event.organizer_id,
                organizerName: event.organizer_name,
                recurring: event.recurring,
                recurFrequency: event.recur_frequency,
                recurDayOfWeek: event.recur_day_of_week,
                recurMonthlyPattern: event.recur_monthly_pattern,
                recurEndType: event.recur_end_type,
                recurUntil: event.recur_until,
                recurCount: event.recur_count,
                createdAt: event.created_at,
                updatedAt: event.updated_at
            };

            return {
                ...camelEvent,
                stats: {
                    registered: eventRegs.length,
                    waitlist: eventWaitlist.length,
                    transportCount: eventRegs.filter(r => r.want_transport).length,
                    competitionCount: eventRegs.filter(r => r.want_competition).length,
                    paidCount: 0, // TODO: Add is_paid column to Supabase table
                    revenue: this.calculateEventRevenue(camelEvent, eventRegs)
                }
            };
        });

        return eventsWithStats;
    }

    /**
     * Get registrations for an event with player profile details
     */
    async getEventRegistrationsWithPlayers(eventId) {
        await this.waitForSupabase();

        const { data, error } = await window.SupabaseDB.client
            .from('event_registrations')
            .select('*')
            .eq('event_id', eventId)
            .order('created_at', { ascending: true });

        if (error) {
            console.error('[SocietyGolfDB] Error loading registrations:', error);
            throw error;
        }

        // Convert snake_case to camelCase
        return (data || []).map(reg => ({
            id: reg.id,
            eventId: reg.event_id,
            playerId: reg.player_id,
            playerName: reg.player_name,
            handicap: reg.handicap,
            wantTransport: reg.want_transport,
            wantCompetition: reg.want_competition,
            partnerPrefs: reg.partner_prefs,
            isPaid: reg.is_paid || false,
            paymentDate: reg.payment_date,
            createdAt: reg.created_at,
            updatedAt: reg.updated_at
        }));
    }

    /**
     * Calculate total revenue for an event based on registrations
     */
    calculateEventRevenue(event, registrations) {
        if (!registrations || registrations.length === 0) return 0;

        const baseFee = parseFloat(event.baseFee) || 0;
        const cartFee = parseFloat(event.cartFee) || 0;
        const caddyFee = parseFloat(event.caddyFee) || 0;
        const transportFee = parseFloat(event.transportFee) || 0;
        const competitionFee = parseFloat(event.competitionFee) || 0;

        let totalRevenue = 0;

        registrations.forEach(reg => {
            // Base cost for all players
            totalRevenue += baseFee + cartFee + caddyFee;

            // Optional add-ons
            if (reg.want_transport) totalRevenue += transportFee;
            if (reg.want_competition) totalRevenue += competitionFee;
        });

        return totalRevenue;
    }

    /**
     * Update payment status for a registration
     */
    async updatePaymentStatus(registrationId, isPaid) {
        await this.waitForSupabase();

        const { data, error } = await window.SupabaseDB.client
            .from('event_registrations')
            .update({
                is_paid: isPaid,
                payment_date: isPaid ? new Date().toISOString() : null,
                updated_at: new Date().toISOString()
            })
            .eq('id', registrationId)
            .select();

        if (error) {
            console.error('[SocietyGolfDB] Error updating payment status:', error);
            throw error;
        }

        return data;
    }

    // =====================================================
    // SOCIETY PROFILE MANAGEMENT
    // =====================================================

    async getSocietyProfile(organizerId) {
        await this.waitForSupabase();
        const { data, error } = await window.SupabaseDB.client
            .from('society_profiles')
            .select('*')
            .eq('organizer_id', organizerId)
            .single();

        if (error && error.code !== 'PGRST116') {
            console.error('[SocietyGolfDB] Error loading profile:', error);
            return null;
        }

        // Convert snake_case to camelCase for JavaScript
        if (data) {
            return {
                id: data.id,
                organizerId: data.organizer_id,
                societyName: data.society_name,
                societyLogo: data.society_logo,
                description: data.description,
                createdAt: data.created_at,
                updatedAt: data.updated_at
            };
        }

        return null;
    }

    async createSocietyProfile(profileData) {
        await this.waitForSupabase();
        const { data, error } = await window.SupabaseDB.client
            .from('society_profiles')
            .insert({
                organizer_id: profileData.organizerId,
                society_name: profileData.societyName,
                society_logo: profileData.societyLogo,
                description: profileData.description
            })
            .select()
            .single();

        if (error) {
            console.error('[SocietyGolfDB] Error creating profile:', error);
            throw error;
        }

        return data;
    }

    async updateSocietyProfile(organizerId, profileData) {
        await this.waitForSupabase();
        const { data, error } = await window.SupabaseDB.client
            .from('society_profiles')
            .update({
                society_name: profileData.societyName,
                society_logo: profileData.societyLogo,
                description: profileData.description,
                updated_at: new Date().toISOString()
            })
            .eq('organizer_id', organizerId)
            .select()
            .single();

        if (error) {
            console.error('[SocietyGolfDB] Error updating profile:', error);
            throw error;
        }

        return data;
    }

    // =====================================================
    // SOCIETY SUBSCRIPTIONS (DATABASE PERSISTENCE)
    // =====================================================

    async getSocietySubscriptions(golferId) {
        await this.waitForSupabase();
        const { data, error } = await window.SupabaseDB.client
            .from('golfer_society_subscriptions')
            .select('society_name, organizer_id, subscribed_at')
            .eq('golfer_id', golferId)
            .order('subscribed_at', { ascending: false });

        if (error) {
            console.error('[SocietyGolfDB] Error loading subscriptions:', error);
            return [];
        }

        return data || [];
    }

    async saveSocietySubscription(golferId, societyName, organizerId = null) {
        await this.waitForSupabase();
        const { data, error } = await window.SupabaseDB.client
            .from('golfer_society_subscriptions')
            .upsert({
                golfer_id: golferId,
                society_name: societyName,
                organizer_id: organizerId
            }, {
                onConflict: 'golfer_id,society_name'
            })
            .select();

        if (error) {
            console.error('[SocietyGolfDB] Error saving subscription:', error);
            throw error;
        }

        return data;
    }

    // =====================================================
    // PAYMENT TRACKING
    // =====================================================

    async markPlayerPaid(eventId, playerId, totalFee, organizerId) {
        await this.waitForSupabase();

        const { data, error } = await window.SupabaseDB.client
            .from('event_registrations')
            .update({
                payment_status: 'paid',
                amount_paid: totalFee,
                paid_at: new Date().toISOString(),
                paid_by: organizerId
            })
            .eq('event_id', eventId)
            .eq('player_id', playerId)
            .select();

        if (error) {
            console.error('[PaymentTracking] Error marking paid:', error);
            throw error;
        }

        console.log('[PaymentTracking] ✅ Marked player as paid:', data);
        return data;
    }

    async markPlayerUnpaid(eventId, playerId) {
        await this.waitForSupabase();

        const { data, error } = await window.SupabaseDB.client
            .from('event_registrations')
            .update({
                payment_status: 'unpaid',
                amount_paid: 0,
                paid_at: null,
                paid_by: null
            })
            .eq('event_id', eventId)
            .eq('player_id', playerId)
            .select();

        if (error) {
            console.error('[PaymentTracking] Error marking unpaid:', error);
            throw error;
        }

        console.log('[PaymentTracking] ✅ Marked player as unpaid:', data);
        return data;
    }

    async getEventBookingsWithPayment(eventId) {
        await this.waitForSupabase();

        const { data, error } = await window.SupabaseDB.client
            .from('event_registrations')
            .select('*')
            .eq('event_id', eventId)
            .order('created_at', { ascending: true });

        if (error) {
            console.error('[PaymentTracking] Error loading bookings:', error);
            return [];
        }

        return data || [];
    }

    async getEventPaymentStats(eventId) {
        await this.waitForSupabase();

        const bookings = await this.getEventBookingsWithPayment(eventId);

        const stats = {
            totalCount: bookings.length,
            paidCount: bookings.filter(b => b.payment_status === 'paid').length,
            unpaidCount: bookings.filter(b => b.payment_status === 'unpaid').length,
            partialCount: bookings.filter(b => b.payment_status === 'partial').length,
            totalExpected: bookings.reduce((sum, b) => sum + parseFloat(b.total_fee || 0), 0),
            totalPaid: bookings.reduce((sum, b) => sum + parseFloat(b.amount_paid || 0), 0),
            totalUnpaid: 0
        };

        stats.totalUnpaid = stats.totalExpected - stats.totalPaid;
        stats.percentagePaid = stats.totalCount > 0
            ? Math.round((stats.paidCount / stats.totalCount) * 100)
            : 0;

        return stats;
    }

    async updateRegistrationFee(registrationId, newFee) {
        await this.waitForSupabase();

        const { data, error } = await window.SupabaseDB.client
            .from('event_registrations')
            .update({
                total_fee: newFee
            })
            .eq('id', registrationId)
            .select();

        if (error) {
            console.error('[PaymentTracking] Error updating fee:', error);
            throw error;
        }

        console.log('[PaymentTracking] ✅ Fee updated to ฿' + newFee.toFixed(2));
        return data;
    }

    async recalculateEventFees(eventId) {
        await this.waitForSupabase();

        console.log('[FeeRecalculation] Starting fee recalculation for event:', eventId);

        // Get event details
        const event = await this.getEvent(eventId);
        if (!event) {
            console.error('[FeeRecalculation] Event not found');
            return { success: false, error: 'Event not found' };
        }

        console.log('[FeeRecalculation] Event:', event.name);
        console.log('[FeeRecalculation] Member Fee: ฿' + (event.memberFee || event.baseFee || 0));
        console.log('[FeeRecalculation] Non-Member Fee: ฿' + (event.nonMemberFee || 0));

        // Get all registrations for this event
        const { data: registrations, error: regError } = await window.SupabaseDB.client
            .from('event_registrations')
            .select('*')
            .eq('event_id', eventId);

        if (regError) {
            console.error('[FeeRecalculation] Error fetching registrations:', regError);
            return { success: false, error: regError };
        }

        console.log('[FeeRecalculation] Found ' + registrations.length + ' registrations');

        const results = [];
        let updated = 0;
        let skipped = 0;

        // Process each registration
        for (const reg of registrations) {
            try {
                // Check if player is a society member
                const isMember = await this.checkSocietyMembership(reg.player_id, event.organizerName);

                // Calculate total fee
                const memberFee = parseFloat(event.memberFee) || parseFloat(event.baseFee) || 0;
                const nonMemberFee = parseFloat(event.nonMemberFee) || 0;
                const transportFee = parseFloat(event.transportFee) || 0;
                const competitionFee = parseFloat(event.competitionFee) || 0;

                let totalFee = isMember ? memberFee : (memberFee + nonMemberFee);

                // Add optional fees if player selected them
                if (reg.want_transport && transportFee > 0) {
                    totalFee += transportFee;
                }
                if (reg.want_competition && competitionFee > 0) {
                    totalFee += competitionFee;
                }

                console.log('[FeeRecalculation] ' + reg.player_name + ': ' +
                    (isMember ? 'MEMBER' : 'NON-MEMBER') + ' → ฿' + totalFee.toFixed(2));

                // Update the registration
                const { error: updateError } = await window.SupabaseDB.client
                    .from('event_registrations')
                    .update({
                        total_fee: totalFee
                    })
                    .eq('id', reg.id);

                if (updateError) {
                    console.error('[FeeRecalculation] Error updating ' + reg.player_name + ':', updateError);
                    results.push({
                        player: reg.player_name,
                        success: false,
                        error: updateError
                    });
                    skipped++;
                } else {
                    results.push({
                        player: reg.player_name,
                        isMember: isMember,
                        totalFee: totalFee,
                        success: true
                    });
                    updated++;
                }

            } catch (error) {
                console.error('[FeeRecalculation] Error processing ' + reg.player_name + ':', error);
                results.push({
                    player: reg.player_name,
                    success: false,
                    error: error
                });
                skipped++;
            }
        }

        console.log('[FeeRecalculation] ✅ Complete! Updated: ' + updated + ', Skipped: ' + skipped);

        return {
            success: true,
            eventName: event.name,
            totalRegistrations: registrations.length,
            updated: updated,
            skipped: skipped,
            results: results
        };
    }

    async removeSocietySubscription(golferId, societyName) {
        await this.waitForSupabase();
        const { error } = await window.SupabaseDB.client
            .from('golfer_society_subscriptions')
            .delete()
            .eq('golfer_id', golferId)
            .eq('society_name', societyName);

        if (error) {
            console.error('[SocietyGolfDB] Error removing subscription:', error);
            throw error;
        }

        return true;
    }

    async clearAllSubscriptions(golferId) {
        await this.waitForSupabase();
        const { error } = await window.SupabaseDB.client
            .from('golfer_society_subscriptions')
            .delete()
            .eq('golfer_id', golferId);

        if (error) {
            console.error('[SocietyGolfDB] Error clearing subscriptions:', error);
            throw error;
        }

        return true;
    }

    unsubscribeAll() {
        this.subscriptions.forEach(sub => {
            sub.unsubscribe();
        });
        this.subscriptions = [];
    }

    // =====================================================
    // SOCIETY MEMBERSHIP MANAGEMENT
    // =====================================================

    async getSocietyMembers(societyName, organizerId = null) {
        await this.waitForSupabase();
        let query = window.SupabaseDB.client
            .from('society_members')
            .select('*')
            .eq('society_name', societyName)
            .eq('status', 'active')
            .order('joined_at', { ascending: false });

        if (organizerId) {
            query = query.eq('organizer_id', organizerId);
        }

        const { data, error } = await query;

        if (error) {
            console.error('[SocietyGolfDB] Error loading society members:', error);
            return [];
        }

        return data || [];
    }

    async addSocietyMember(societyName, organizerId, golferId, memberData = {}) {
        await this.waitForSupabase();
        const { data, error } = await window.SupabaseDB.client
            .from('society_members')
            .upsert({
                society_name: societyName,
                organizer_id: organizerId,
                golfer_id: golferId,
                member_number: memberData.memberNumber || null,
                is_primary_society: memberData.isPrimary || false,
                status: memberData.status || 'active',
                member_data: memberData.extra || {}
            }, {
                onConflict: 'society_name,golfer_id'
            })
            .select();

        if (error) {
            console.error('[SocietyGolfDB] Error adding society member:', error);
            throw error;
        }

        return data;
    }

    async removeSocietyMember(societyName, golferId) {
        await this.waitForSupabase();
        const { error } = await window.SupabaseDB.client
            .from('society_members')
            .delete()
            .eq('society_name', societyName)
            .eq('golfer_id', golferId);

        if (error) {
            console.error('[SocietyGolfDB] Error removing society member:', error);
            throw error;
        }

        return true;
    }

    async getUserSocietyMemberships(golferId) {
        await this.waitForSupabase();
        const { data, error } = await window.SupabaseDB.client
            .from('society_members')
            .select('*')
            .eq('golfer_id', golferId)
            .eq('status', 'active')
            .order('is_primary_society', { ascending: false });

        if (error) {
            console.error('[SocietyGolfDB] Error loading user memberships:', error);
            return [];
        }

        return data || [];
    }

    async setPrimarySociety(golferId, societyName) {
        await this.waitForSupabase();

        // First, remove primary flag from all societies for this user
        await window.SupabaseDB.client
            .from('society_members')
            .update({ is_primary_society: false })
            .eq('golfer_id', golferId);

        // Then set the new primary society
        const { error } = await window.SupabaseDB.client
            .from('society_members')
            .update({ is_primary_society: true })
            .eq('golfer_id', golferId)
            .eq('society_name', societyName);

        if (error) {
            console.error('[SocietyGolfDB] Error setting primary society:', error);
            throw error;
        }

        return true;
    }

    // =====================================================
    // SCORECARD & SCORING SYSTEM
    // =====================================================

    async createScorecard(eventId, playerId, handicap) {
        await this.waitForSupabase();

        const scorecardId = this.generateId();

        const { data, error } = await window.SupabaseDB.client
            .from('scorecards')
            .insert([{
                id: scorecardId,
                event_id: eventId,
                player_id: playerId,
                handicap: handicap,
                playing_handicap: Math.round(handicap),
                status: 'in_progress',
                started_at: new Date().toISOString()
            }])
            .select()
            .single();

        if (error) {
            console.error('[SocietyGolf] ❌ Error creating scorecard:', {
                error: error,
                errorMessage: error.message,
                errorDetails: error.details,
                errorHint: error.hint,
                errorCode: error.code,
                tableName: 'scorecards',
                attemptedOperation: 'INSERT',
                payloadSent: {
                    id: scorecardId,
                    event_id: eventId,
                    player_id: playerId,
                    handicap: handicap,
                    playing_handicap: Math.round(handicap),
                    status: 'in_progress',
                    started_at: new Date().toISOString()
                }
            });

            // Check if table exists
            if (error.message && error.message.includes('relation') && error.message.includes('does not exist')) {
                console.error('[SocietyGolf] 🚨 CRITICAL: "scorecards" table does not exist in database!');
                console.error('[SocietyGolf] 💡 Solution: Run sql/04_create_scorecards_tables.sql in Supabase');
            }

            throw error;
        }

        return data;
    }

    async getScorecard(scorecardId) {
        await this.waitForSupabase();

        const { data, error} = await window.SupabaseDB.client
            .from('scorecards')
            .select(`
                *,
                scores (*)
            `)
            .eq('id', scorecardId)
            .single();

        if (error) {
            console.error('[SocietyGolf] Error fetching scorecard:', error);
            return null;
        }

        return data;
    }

    async getEventScorecards(eventId) {
        await this.waitForSupabase();

        const { data, error } = await window.SupabaseDB.client
            .from('scorecards')
            .select(`
                *,
                scores (*)
            `)
            .eq('event_id', eventId)
            .order('total_net', { ascending: true });

        if (error) {
            console.error('[SocietyGolf] Error fetching scorecards:', error);
            return [];
        }

        return data || [];
    }

    async saveScore(scorecardId, holeNumber, grossScore, par, strokeIndex, handicap) {
        await this.waitForSupabase();

        const playingHandicap = Math.round(handicap);
        const strokesReceived = Math.floor(playingHandicap / 18) +
                                (strokeIndex <= (playingHandicap % 18) ? 1 : 0);

        const netScore = grossScore - strokesReceived;

        const { data, error } = await window.SupabaseDB.client
            .from('scores')
            .upsert([{
                scorecard_id: scorecardId,
                hole_number: holeNumber,
                par: par,
                stroke_index: strokeIndex,
                gross_score: grossScore,
                net_score: netScore,
                handicap_strokes: strokesReceived
            }], {
                onConflict: 'scorecard_id,hole_number'
            })
            .select()
            .single();

        if (error) {
            console.error('[SocietyGolf] ❌ Error saving score:', {
                error: error,
                errorMessage: error.message,
                errorDetails: error.details,
                errorHint: error.hint,
                errorCode: error.code,
                tableName: 'scores',
                attemptedOperation: 'UPSERT',
                payloadSent: {
                    scorecard_id: scorecardId,
                    hole_number: holeNumber,
                    par: par,
                    stroke_index: strokeIndex,
                    gross_score: grossScore,
                    net_score: netScore,
                    handicap_strokes: strokesReceived
                }
            });

            // Check if table exists
            if (error.message && error.message.includes('relation') && error.message.includes('does not exist')) {
                console.error('[SocietyGolf] 🚨 CRITICAL: "scores" table does not exist in database!');
                console.error('[SocietyGolf] 💡 Solution: Run sql/04_create_scorecards_tables.sql in Supabase');
            }

            throw error;
        }

        await this.updateScorecardTotals(scorecardId);

        return data;
    }

    async updateScorecardTotals(scorecardId) {
        await this.waitForSupabase();

        const { data: scores, error: scoresError } = await window.SupabaseDB.client
            .from('scores')
            .select('*')
            .eq('scorecard_id', scorecardId);

        if (scoresError) {
            console.error('[SocietyGolf] Error fetching scores:', scoresError);
            return;
        }

        const totalGross = scores.reduce((sum, s) => sum + (s.gross_score || 0), 0);
        const totalNet = scores.reduce((sum, s) => sum + (s.net_score || 0), 0);

        const { error: updateError } = await window.SupabaseDB.client
            .from('scorecards')
            .update({
                total_gross: totalGross,
                total_net: totalNet,
                updated_at: new Date().toISOString()
            })
            .eq('id', scorecardId);

        if (updateError) {
            console.error('[SocietyGolf] Error updating totals:', updateError);
        }
    }

    async completeScorecard(scorecardId) {
        await this.waitForSupabase();

        const { data, error } = await window.SupabaseDB.client
            .from('scorecards')
            .update({
                status: 'completed',
                completed_at: new Date().toISOString()
            })
            .eq('id', scorecardId)
            .select()
            .single();

        if (error) {
            console.error('[SocietyGolf] Error completing scorecard:', error);
            throw error;
        }

        return data;
    }

    async getLeaderboard(eventId) {
        await this.waitForSupabase();

        const scorecards = await this.getEventScorecards(eventId);

        const leaderboard = scorecards.map((card, index) => {
            const holesCompleted = (card.scores || []).filter(s => s.gross_score).length;
            const thru = holesCompleted === 18 ? 'F' : holesCompleted.toString();

            return {
                position: index + 1,
                player_id: card.player_id,
                scorecard_id: card.id,
                total_gross: card.total_gross || 0,
                total_net: card.total_net || 0,
                holes_completed: holesCompleted,
                thru: thru,
                status: card.status
            };
        });

        return leaderboard;
    }

    subscribeToScorecards(eventId, callback) {
        const subscription = window.SupabaseDB.client
            .channel(`scorecards_${eventId}`)
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'scorecards',
                filter: `event_id=eq.${eventId}`
            }, callback)
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'scores'
            }, callback)
            .subscribe();

        this.subscriptions.push(subscription);
        return subscription;
    }

    // =====================================================
    // UTILITIES
    // =====================================================

    generateId() {
        return Math.random().toString(36).substring(2, 11);
    }
}

// Initialize global instance
window.SocietyGolfDB = new SocietyGolfSupabase();
    </script>

    <script>
    // ============================================
    // LIVE SCORECARD MANAGER
    // ============================================

class LiveScorecardSystem {
    constructor() {
        this.players = [];
        this.currentHole = 1;
        this.groupId = null;
        this.eventId = null;
        this.isPrivateRound = false; // Track if this is a private round (deletable)
        this.scorecards = {};
        this.scoresCache = {}; // Store scores locally: { playerId: { holeNumber: score } }
        this.scoringFormats = ['stableford']; // Array of selected formats - supports multiple simultaneously
        this.currentPlayerId = null;
        this.currentScore = '';
        this.leaderboardView = 'group';
        this.subscriptions = [];
        this.autoAdvanceTimeout = null; // FIX: Store timeout to prevent race condition
        this.courseData = null; // Store loaded course data
        this.availableCourses = []; // List of courses from database
    }

    // ============================================
    // GOLF SCORING ENGINE
    // Professional scoring engine supporting multiple formats
    // Converted from golfScoring.ts
    // ============================================

    static GolfScoringEngine = {
        // Default stableford points
        defaultStableford: {
            doubleBogeyOrWorse: 0,
            bogey: 1,
            par: 2,
            birdie: 3,
            eagle: 4,
            albatross: 5,
            condor: 6
        },

        // Allocate handicap shots across holes by stroke index
        allocHandicapShots(courseHoles, handicap) {
            const shots = {};
            if (!handicap || handicap <= 0) return shots;

            // Sort by stroke index
            const holesSorted = [...courseHoles].sort((a, b) =>
                (a.strokeIndex || a.hole) - (b.strokeIndex || b.hole)
            );

            let remaining = Math.round(handicap);
            while (remaining > 0) {
                for (const h of holesSorted) {
                    if (remaining <= 0) break;
                    const holeNum = h.hole || h.hole_number || h.number;
                    shots[holeNum] = (shots[holeNum] || 0) + 1;
                    remaining--;
                }
            }
            return shots;
        },

        // Calculate net strokes for a hole
        netStrokesForHole(grossStrokes, bonusShots) {
            return Math.max(1, grossStrokes - bonusShots);
        },

        // Calculate stableford points for a hole
        stablefordPointsForHole(strokes, par, pointsMap) {
            const diff = strokes - par;
            if (diff <= -4) return pointsMap.condor || 6;
            if (diff === -3) return pointsMap.albatross || 5;
            if (diff === -2) return pointsMap.eagle || 4;
            if (diff === -1) return pointsMap.birdie || 3;
            if (diff === 0) return pointsMap.par || 2;
            if (diff === 1) return pointsMap.bogey || 1;
            return pointsMap.doubleBogeyOrWorse || 0;
        },

        // Calculate total stableford points for a player
        calculateStablefordTotal(scores, courseHoles, handicap, useNet = true, customPoints = null) {
            const pointsMap = customPoints || this.defaultStableford;
            const shots = useNet ? this.allocHandicapShots(courseHoles, handicap) : {};

            let total = 0;
            for (const scoreEntry of scores) {
                const hole = scoreEntry.hole_number || scoreEntry.hole;
                const grossStrokes = scoreEntry.gross_score || scoreEntry.strokes;
                const holeData = courseHoles.find(h => (h.hole || h.hole_number || h.number) === hole);

                if (!holeData || !grossStrokes) continue;

                const par = holeData.par;
                const bonusShots = shots[hole] || 0;
                const netStrokes = useNet ? this.netStrokesForHole(grossStrokes, bonusShots) : grossStrokes;

                total += this.stablefordPointsForHole(netStrokes, par, pointsMap);
            }
            return total;
        },

        // Calculate modified stableford (different point system)
        modifiedStablefordPoints: {
            doubleBogeyOrWorse: -3,
            bogey: -1,
            par: 0,
            birdie: 2,
            eagle: 5,
            albatross: 8,
            condor: 10
        },

        // Calculate Nassau scoring (front 9, back 9, overall)
        calculateNassau(playerScores, courseHoles) {
            let front9 = 0, back9 = 0;

            for (const scoreEntry of playerScores) {
                const hole = scoreEntry.hole_number || scoreEntry.hole;
                const strokes = scoreEntry.gross_score || scoreEntry.strokes;

                if (hole <= 9) {
                    front9 += strokes;
                } else if (hole <= 18) {
                    back9 += strokes;
                }
            }

            return {
                front9,
                back9,
                total: front9 + back9
            };
        },

        // Calculate match play result hole by hole
        calculateMatchPlay(player1Scores, player2Scores, courseHoles, useNet = true, handicap1 = 0, handicap2 = 0) {
            const shots1 = useNet ? this.allocHandicapShots(courseHoles, handicap1) : {};
            const shots2 = useNet ? this.allocHandicapShots(courseHoles, handicap2) : {};

            let player1Up = 0;
            let holesPlayed = 0;

            for (let hole = 1; hole <= 18; hole++) {
                const score1 = player1Scores.find(s => (s.hole_number || s.hole) === hole);
                const score2 = player2Scores.find(s => (s.hole_number || s.hole) === hole);

                if (!score1 || !score2) continue;

                const gross1 = score1.gross_score || score1.strokes;
                const gross2 = score2.gross_score || score2.strokes;

                const net1 = useNet ? this.netStrokesForHole(gross1, shots1[hole] || 0) : gross1;
                const net2 = useNet ? this.netStrokesForHole(gross2, shots2[hole] || 0) : gross2;

                if (net1 < net2) player1Up++;
                else if (net2 < net1) player1Up--;

                holesPlayed++;
            }

            return {
                player1Up,
                holesPlayed,
                status: player1Up > 0 ? `${player1Up} UP` : player1Up < 0 ? `${Math.abs(player1Up)} DOWN` : 'ALL SQUARE'
            };
        },

        // Calculate skins (hole-by-hole winner) - returns detailed hole-by-hole results
        calculateSkins(allPlayerScores, courseHoles, useNet = true, pointsPerHole = 100) {
            const skinsWon = {}; // Total points won by each player
            const frontNine = {}; // Front 9 points (holes 1-9)
            const backNine = {}; // Back 9 points (holes 10-18)
            const holeResults = {}; // Track which player won each hole
            let carryOverValue = 0; // Number of skins being carried (multiplies points)

            for (let hole = 1; hole <= 18; hole++) {
                const holeScores = [];

                for (const {playerId, scores, handicap, playerName} of allPlayerScores) {
                    const score = scores.find(s => (s.hole_number || s.hole) === hole);
                    if (!score) continue;

                    let strokes = score.gross_score || score.strokes;
                    if (useNet && handicap) {
                        const shots = this.allocHandicapShots(courseHoles, handicap);
                        strokes = this.netStrokesForHole(strokes, shots[hole] || 0);
                    }

                    holeScores.push({playerId, playerName, strokes});
                }

                if (holeScores.length === 0) {
                    holeResults[hole] = { winner: null, tied: false, pointsValue: 0 };
                    continue;
                }

                // Find best score
                const best = Math.min(...holeScores.map(s => s.strokes));
                const winners = holeScores.filter(s => s.strokes === best);

                if (winners.length === 1) {
                    // Single winner - gets points for this hole plus carry-over multiplier
                    const winnerId = winners[0].playerId;
                    const winnerName = winners[0].playerName;
                    const pointsValue = pointsPerHole * (1 + carryOverValue);

                    skinsWon[winnerId] = (skinsWon[winnerId] || 0) + pointsValue;

                    // Track front nine vs back nine
                    if (hole <= 9) {
                        frontNine[winnerId] = (frontNine[winnerId] || 0) + pointsValue;
                    } else {
                        backNine[winnerId] = (backNine[winnerId] || 0) + pointsValue;
                    }

                    holeResults[hole] = {
                        winner: winnerId,
                        winnerName: winnerName,
                        tied: false,
                        pointsValue: pointsValue,
                        carriedOver: carryOverValue
                    };
                    carryOverValue = 0;
                } else {
                    // Tie - carry over to next hole
                    carryOverValue += 1;
                    holeResults[hole] = {
                        winner: null,
                        tied: true,
                        pointsValue: 0,
                        carriedOver: carryOverValue
                    };
                }
            }

            return {
                skinsWon,
                frontNine,
                backNine,
                holeResults,
                carryOverRemaining: carryOverValue
            };
        },

        // Calculate match play (hole-by-hole comparison)
        calculateMatchPlay(playerScores, courseHoles, useNet = true) {
            // Match play is typically head-to-head, we'll calculate vs the field for simplicity
            const matchResults = {};

            for (const player of playerScores) {
                let holesUp = 0; // Holes won
                let holesDown = 0; // Holes lost
                let holesHalved = 0; // Tied holes
                let holesPlayed = 0;
                const holeByHole = [];

                for (let hole = 1; hole <= 18; hole++) {
                    const playerScore = player.scores.find(s => (s.hole_number || s.hole) === hole);
                    if (!playerScore) continue;

                    let playerStrokes = playerScore.gross_score || playerScore.strokes;
                    if (useNet && player.handicap) {
                        const shots = this.allocHandicapShots(courseHoles, player.handicap);
                        playerStrokes = this.netStrokesForHole(playerStrokes, shots[hole] || 0);
                    }

                    // Find best opponent score on this hole
                    let bestOpponentStrokes = 999;
                    for (const opponent of playerScores) {
                        if (opponent.playerId === player.playerId) continue;
                        const oppScore = opponent.scores.find(s => (s.hole_number || s.hole) === hole);
                        if (!oppScore) continue;

                        let oppStrokes = oppScore.gross_score || oppScore.strokes;
                        if (useNet && opponent.handicap) {
                            const shots = this.allocHandicapShots(courseHoles, opponent.handicap);
                            oppStrokes = this.netStrokesForHole(oppStrokes, shots[hole] || 0);
                        }

                        bestOpponentStrokes = Math.min(bestOpponentStrokes, oppStrokes);
                    }

                    if (bestOpponentStrokes === 999) continue; // No opponent scores

                    holesPlayed++;
                    if (playerStrokes < bestOpponentStrokes) {
                        holesUp++;
                        holeByHole.push({ hole, result: 'won' });
                    } else if (playerStrokes > bestOpponentStrokes) {
                        holesDown++;
                        holeByHole.push({ hole, result: 'lost' });
                    } else {
                        holesHalved++;
                        holeByHole.push({ hole, result: 'halved' });
                    }
                }

                // Calculate match status
                const netHoles = holesUp - holesDown;
                const holesRemaining = 18 - holesPlayed;

                let status = 'All Square';
                let matchFinished = false;

                if (netHoles > 0) {
                    if (netHoles > holesRemaining) {
                        // Match is won (e.g., "4 & 3" means 4 up with 3 to play)
                        status = `${netHoles} & ${holesRemaining}`;
                        matchFinished = true;
                    } else {
                        status = `${netHoles} UP`;
                    }
                } else if (netHoles < 0) {
                    if (Math.abs(netHoles) > holesRemaining) {
                        status = `${Math.abs(netHoles)} & ${holesRemaining} (Down)`;
                        matchFinished = true;
                    } else {
                        status = `${Math.abs(netHoles)} DOWN`;
                    }
                }

                matchResults[player.playerId] = {
                    holesUp,
                    holesDown,
                    holesHalved,
                    holesPlayed,
                    netHoles,
                    status,
                    matchFinished,
                    holeByHole
                };
            }

            return matchResults;
        },

        // Calculate better ball / best ball (team format)
        calculateBetterBall(teamScores, courseHoles, scoresToCount = 1) {
            let teamTotal = 0;

            for (let hole = 1; hole <= 18; hole++) {
                const holeScores = teamScores
                    .map(player => {
                        const score = player.scores.find(s => (s.hole_number || s.hole) === hole);
                        return score ? (score.gross_score || score.strokes) : null;
                    })
                    .filter(s => s !== null)
                    .sort((a, b) => a - b);

                // Take best N scores
                const bestScores = holeScores.slice(0, scoresToCount);
                teamTotal += bestScores.reduce((sum, s) => sum + s, 0);
            }

            return teamTotal;
        },

        // Calculate scramble (team plays best ball position - typically one team score)
        calculateScramble(teamScore) {
            // In scramble, team submits one score per hole
            // This is typically the first player's score in the team
            let total = 0;
            for (const score of teamScore) {
                total += (score.gross_score || score.strokes);
            }
            return total;
        }
    };

    async init() {
        console.log('[LiveScorecard] Initializing...');

        // Clean up old/failed offline data first
        this.cleanupOldOfflineData();

        await this.loadEvents();
        // No longer load courses on init - dropdown is static!

        // Auto-sync offline data when connection is restored
        window.addEventListener('online', () => {
            console.log('[LiveScorecard] 🌐 Connection restored - syncing offline data...');
            setTimeout(() => this.syncOfflineData(), 1000); // Wait 1s for connection to stabilize
        });

        // Check for pending offline data on init
        setTimeout(() => this.syncOfflineData(), 2000);
    }

    async loadEvents() {
        // Load today's events for event selector
        const events = await window.SocietyGolfDB.getAllPublicEvents();
        const today = new Date().toISOString().split('T')[0];
        const todaysEvents = events.filter(e => e.date === today);

        const select = document.getElementById('scorecardEventSelect');
        todaysEvents.forEach(event => {
            const option = document.createElement('option');
            option.value = event.id;
            option.textContent = `${event.name} - ${event.societyName}`;
            select.appendChild(option);
        });
    }

    // Course dropdown is now static HTML - no need to load from database!
    // Only load course data when user starts a round

    async loadCourseData(courseId) {
        console.log(`[LiveScorecard] Loading course data for: ${courseId}`);

        // Course cache versions - increment to force refresh
        const COURSE_CACHE_VERSIONS = {
            'bangpakong': 2  // v2: Par 72 with all 5 tees (black, blue, white, yellow, red)
        };

        // Check cache first (courses don't change often)
        const cacheKey = `mcipro_course_${courseId}`;
        const cacheVersionKey = `mcipro_course_version_${courseId}`;
        const expectedVersion = COURSE_CACHE_VERSIONS[courseId] || 1;

        try {
            const cached = localStorage.getItem(cacheKey);
            const cachedVersion = parseInt(localStorage.getItem(cacheVersionKey) || '0');

            if (cached && cachedVersion === expectedVersion) {
                const courseData = JSON.parse(cached);
                console.log(`[LiveScorecard] Using cached course data (v${cachedVersion})`);
                this.courseData = courseData;
                return this.courseData;
            } else if (cached && cachedVersion < expectedVersion) {
                console.log(`[LiveScorecard] Cache outdated (v${cachedVersion} < v${expectedVersion}), refreshing...`);
                localStorage.removeItem(cacheKey);
                localStorage.removeItem(cacheVersionKey);
            }
        } catch (e) {
            console.warn('[LiveScorecard] Cache read failed:', e);
        }

        try {
            // Get course info (including scorecard_url)
            const { data: course, error: courseError } = await window.SupabaseDB.client
                .from('courses')
                .select('id, name, scorecard_url')
                .eq('id', courseId)
                .single();

            if (courseError) throw courseError;

            // Get hole data
            const { data: holes, error: holesError } = await window.SupabaseDB.client
                .from('course_holes')
                .select('hole_number, par, stroke_index, yardage, tee_marker')
                .eq('course_id', courseId)
                .order('hole_number');

            if (holesError) throw holesError;

            this.courseData = {
                id: course.id,
                name: course.name,
                scorecardUrl: course.scorecard_url,
                holes: holes.map(h => ({
                    number: h.hole_number,
                    par: h.par,
                    strokeIndex: h.stroke_index,
                    yardage: h.yardage || 0,
                    teeMarker: h.tee_marker
                }))
            };

            // Cache this course data with version
            try {
                localStorage.setItem(cacheKey, JSON.stringify(this.courseData));
                localStorage.setItem(cacheVersionKey, expectedVersion.toString());
                console.log(`[LiveScorecard] Course data cached (v${expectedVersion})`);
            } catch (e) {
                console.warn('[LiveScorecard] Cache write failed:', e);
            }

            console.log('[LiveScorecard] Course data loaded from database');
            return this.courseData;

        } catch (error) {
            console.error('[LiveScorecard] Error loading course data:', error);
            NotificationManager.show('Error loading course data', 'error');
            return null;
        }
    }

    openCourseLibrary() {
        document.getElementById('courseLibraryModal').classList.remove('hidden');
        this.renderSavedCourses();
    }

    closeCourseLibrary() {
        document.getElementById('courseLibraryModal').classList.add('hidden');
    }

    async renderSavedCourses() {
        const container = document.getElementById('savedCoursesList');

        if (this.availableCourses.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12 text-gray-500">
                    <span class="material-symbols-outlined text-5xl mb-3">golf_course</span>
                    <p>No courses saved yet</p>
                    <p class="text-sm mt-2">Click "Scan New Course" to add your first course</p>
                </div>
            `;
            return;
        }

        container.innerHTML = this.availableCourses.map(course => `
            <div class="border rounded-lg p-4 hover:border-green-500 transition">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-900">${course.name}</h3>
                        <p class="text-xs text-gray-500 mt-1">
                            Added: ${new Date(course.created_at).toLocaleDateString()}
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="LiveScorecardManager.deleteCourse('${course.id}')" class="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg">
                            <span class="material-symbols-outlined text-sm">delete</span>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async deleteCourse(courseId) {
        if (!confirm('Delete this course? This cannot be undone.')) return;

        try {
            // Delete course (will cascade to course_holes)
            const { error } = await window.SupabaseDB.client
                .from('courses')
                .delete()
                .eq('id', courseId);

            if (error) throw error;

            NotificationManager.show('Course deleted successfully', 'success');
            await this.loadAvailableCourses();
            this.renderSavedCourses();

        } catch (error) {
            console.error('[LiveScorecard] Error deleting course:', error);
            NotificationManager.show('Error deleting course', 'error');
        }
    }

    async addPlayer() {
        if (this.players.length >= 7) {
            NotificationManager.show('Maximum 7 players per group', 'warning');
            return;
        }

        // Open the unified Add Player modal
        await this.openAddPlayerModal();
    }

    async openAddPlayerModal() {
        const modal = document.getElementById('addPlayerModal');
        modal.classList.remove('hidden');

        // Reset to "Select Existing" tab
        this.switchAddPlayerTab('existing');

        // Load all profiles
        this.allPlayerProfiles = await window.SupabaseDB.getAllProfiles();

        // Render profiles list
        this.renderPlayerProfiles(this.allPlayerProfiles);

        console.log('[LiveScorecard] Add Player modal opened');
    }

    closeAddPlayerModal() {
        const modal = document.getElementById('addPlayerModal');
        modal.classList.add('hidden');

        // Clear search and form
        document.getElementById('playerSearchInput').value = '';
        document.getElementById('addNewPlayerForm').reset();

        console.log('[LiveScorecard] Add Player modal closed');
    }

    switchAddPlayerTab(tab) {
        const existingTab = document.getElementById('existingPlayerTab');
        const newTab = document.getElementById('newPlayerTab');
        const existingBtn = document.getElementById('selectExistingTab');
        const newBtn = document.getElementById('addNewTab');

        if (tab === 'existing') {
            existingTab.classList.remove('hidden');
            newTab.classList.add('hidden');
            existingBtn.classList.add('text-green-600', 'border-b-2', 'border-green-600');
            existingBtn.classList.remove('text-gray-500');
            newBtn.classList.remove('text-green-600', 'border-b-2', 'border-green-600');
            newBtn.classList.add('text-gray-500');
        } else {
            existingTab.classList.add('hidden');
            newTab.classList.remove('hidden');
            newBtn.classList.add('text-green-600', 'border-b-2', 'border-green-600');
            newBtn.classList.remove('text-gray-500');
            existingBtn.classList.remove('text-green-600', 'border-b-2', 'border-green-600');
            existingBtn.classList.add('text-gray-500');
        }

        console.log(`[LiveScorecard] Switched to ${tab} tab`);
    }

    renderPlayerProfiles(profiles) {
        const container = document.getElementById('playerProfilesList');

        if (!profiles || profiles.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <span class="material-symbols-outlined text-4xl mb-2">person_off</span>
                    <p>No players found</p>
                    <p class="text-xs mt-2">Try the "Add New Player" tab to create one</p>
                </div>
            `;
            return;
        }

        // Filter out already added players
        const alreadyAddedIds = this.players.map(p => p.lineUserId || p.id);
        const availableProfiles = profiles.filter(profile => !alreadyAddedIds.includes(profile.line_user_id));

        if (availableProfiles.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <span class="material-symbols-outlined text-4xl mb-2">check_circle</span>
                    <p>All available players already added</p>
                    <p class="text-xs mt-2">Use "Add New Player" tab to add more</p>
                </div>
            `;
            return;
        }

        container.innerHTML = availableProfiles.map(profile => {
            const name = profile.name || 'Unknown';
            const handicap = profile.profile_data?.handicap || profile.profile_data?.golfInfo?.handicap || 0;
            const email = profile.profile_data?.personalInfo?.email || profile.email || 'No email';

            return `
                <div class="flex items-center justify-between p-4 border-b hover:bg-gray-50 cursor-pointer" onclick="LiveScorecardManager.selectExistingPlayer('${profile.line_user_id}')">
                    <div class="flex-1">
                        <div class="font-medium text-gray-900">${name}</div>
                        <div class="text-sm text-gray-600">HCP: ${handicap} • ${email}</div>
                    </div>
                    <button class="btn-primary text-sm px-4 py-2">
                        Select
                    </button>
                </div>
            `;
        }).join('');

        console.log(`[LiveScorecard] Rendered ${availableProfiles.length} player profiles`);
    }

    filterPlayerProfiles() {
        const searchInput = document.getElementById('playerSearchInput');
        const searchTerm = searchInput.value.toLowerCase().trim();

        if (!searchTerm) {
            this.renderPlayerProfiles(this.allPlayerProfiles);
            return;
        }

        const filteredProfiles = this.allPlayerProfiles.filter(profile => {
            const name = (profile.name || '').toLowerCase();
            const email = (profile.profile_data?.personalInfo?.email || profile.email || '').toLowerCase();
            return name.includes(searchTerm) || email.includes(searchTerm);
        });

        this.renderPlayerProfiles(filteredProfiles);
        console.log(`[LiveScorecard] Filtered to ${filteredProfiles.length} profiles`);
    }

    selectExistingPlayer(lineUserId) {
        const profile = this.allPlayerProfiles.find(p => p.line_user_id === lineUserId);
        if (!profile) {
            NotificationManager.show('Player not found', 'error');
            return;
        }

        const handicap = profile.profile_data?.handicap || profile.profile_data?.golfInfo?.handicap || 0;

        this.players.push({
            id: profile.line_user_id,
            lineUserId: profile.line_user_id,
            name: profile.name,
            handicap: handicap,
            profileData: profile.profile_data
        });

        this.scoresCache[profile.line_user_id] = {};
        this.renderPlayersList();
        this.closeAddPlayerModal();

        NotificationManager.show(`✅ ${profile.name} added to group`, 'success');
        console.log(`[LiveScorecard] Added existing player: ${profile.name}`);
    }

    submitNewPlayer(event) {
        event.preventDefault();

        const name = document.getElementById('newPlayerName').value.trim();
        const handicap = parseFloat(document.getElementById('newPlayerHandicap').value);
        const email = document.getElementById('newPlayerEmail').value.trim();

        if (!name) {
            NotificationManager.show('Player name is required', 'error');
            return;
        }

        const playerId = `player_${Date.now()}`;
        this.players.push({
            id: playerId,
            lineUserId: null,
            name: name,
            handicap: handicap,
            email: email || null
        });

        this.scoresCache[playerId] = {};
        this.renderPlayersList();
        this.closeAddPlayerModal();

        NotificationManager.show(`✅ ${name} added to group`, 'success');
        console.log(`[LiveScorecard] Added new player: ${name}`);
    }

    renderPlayersList() {
        const container = document.getElementById('scorecardPlayersList');
        container.innerHTML = this.players.map((p, index) => `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div>
                    <span class="font-medium">${p.name}</span>
                    <span class="text-sm text-gray-600 ml-2">(HCP ${p.handicap})</span>
                </div>
                <button onclick="LiveScorecardManager.removePlayer(${index})" class="text-red-600 hover:text-red-700">
                    <span class="material-symbols-outlined text-sm">delete</span>
                </button>
            </div>
        `).join('');

        // Update scramble handicap preview
        if (window.calculateScrambleHcp) {
            window.calculateScrambleHcp();
        }
    }

    removePlayer(index) {
        this.players.splice(index, 1);
        this.renderPlayersList();
    }

    async startRound() {
        console.log('[LiveScorecard] 🎯 Start Round button clicked!');

        if (this.players.length === 0) {
            console.warn('[LiveScorecard] ⚠️ No players added');
            NotificationManager.show('Add at least one player', 'error');
            return;
        }

        // Get selected course
        const courseId = document.getElementById('scorecardCourseSelect').value;
        console.log('[LiveScorecard] Selected course:', courseId);

        if (!courseId) {
            console.warn('[LiveScorecard] ⚠️ No course selected');
            NotificationManager.show('Please select a course', 'error');
            return;
        }

        // Load course data from database
        await this.loadCourseData(courseId);
        if (!this.courseData) {
            NotificationManager.show('Error loading course data', 'error');
            return;
        }

        const teeMarker = document.querySelector('input[name="teeMarker"]:checked').value;
        this.selectedTeeMarker = teeMarker; // Store for yardage display

        // Collect all selected formats (supports multiple simultaneous formats)
        this.scoringFormats = Array.from(
            document.querySelectorAll('input[name="scoringFormat"]:checked')
        ).map(input => input.value);

        // Validate at least one format selected
        if (this.scoringFormats.length === 0) {
            NotificationManager.show('Please select at least one scoring format', 'error');
            return;
        }

        // Initialize scramble configuration if scramble format is selected
        if (this.scoringFormats.includes('scramble')) {
            const teamSize = parseInt(document.querySelector('input[name="scrambleTeamSize"]:checked')?.value) || 4;
            const trackDrives = document.getElementById('scrambleTrackDrives')?.checked || false;
            const trackPutts = document.getElementById('scrambleTrackPutts')?.checked || false;
            const minDrives = parseInt(document.getElementById('scrambleMinDrives')?.value) || 0;

            this.scrambleConfig = {
                teamSize: teamSize,
                trackDrives: trackDrives,
                trackPutts: trackPutts,
                minDrivesPerPlayer: trackDrives ? minDrives : 0
            };

            // Initialize drive count tracker
            this.scrambleDriveCount = {};
            this.players.forEach(player => {
                this.scrambleDriveCount[player.id] = 0;
            });

            console.log('[LiveScorecard] Scramble config initialized:', this.scrambleConfig);
        } else {
            this.scrambleConfig = null;
            this.scrambleDriveCount = {};
        }

        const eventSelectValue = document.getElementById('scorecardEventSelect').value;

        // Determine round type
        this.isPrivateRound = (eventSelectValue === 'private');
        this.eventId = (eventSelectValue === '' || eventSelectValue === 'private') ? null : eventSelectValue;

        this.groupId = `group_${Date.now()}`;

        console.log(`[LiveScorecard] Starting round at ${this.courseData.name} with formats: ${this.scoringFormats.join(', ')} (${this.isPrivateRound ? 'Private' : 'Society'})`);

        // Try to create scorecards online, fall back to offline mode if needed
        let isOfflineMode = false;

        for (const player of this.players) {
            try {
                const scorecard = await window.SocietyGolfDB.createScorecard(
                    this.eventId,
                    player.id,
                    player.handicap
                );

                // Update with group and course info
                const { error: updateError } = await window.SupabaseDB.client
                    .from('scorecards')
                    .update({
                        group_id: this.groupId,
                        course_id: courseId,
                        course_name: this.courseData.name,
                        tee_marker: teeMarker,
                        player_name: player.name,
                        scoring_format: JSON.stringify(this.scoringFormats) // Store as JSON array
                    })
                    .eq('id', scorecard.id);

                if (updateError) {
                    console.error('[LiveScorecard] Error updating scorecard:', updateError);
                    throw updateError;
                }

                this.scorecards[player.id] = scorecard.id;
            } catch (error) {
                console.warn('[LiveScorecard] Online scorecard creation failed, switching to OFFLINE mode:', error);

                // OFFLINE MODE: Create local scorecards
                isOfflineMode = true;
                this.scorecards = {}; // Reset any partial online scorecards

                for (const p of this.players) {
                    // Generate temporary local scorecard ID
                    const localId = `local_${this.groupId}_${p.id}`;
                    this.scorecards[p.id] = localId;

                    // Store scorecard metadata locally
                    const localScorecard = {
                        id: localId,
                        event_id: this.eventId,
                        player_id: p.id,
                        player_name: p.name,
                        handicap: p.handicap,
                        playing_handicap: Math.round(p.handicap),
                        group_id: this.groupId,
                        course_id: courseId,
                        course_name: this.courseData.name,
                        tee_marker: teeMarker,
                        scoring_format: this.scoringFormats,
                        status: 'in_progress',
                        started_at: new Date().toISOString(),
                        pending_sync: true, // Mark for later sync to Supabase
                        created_at: new Date().toISOString(), // Track when created for age-based cleanup
                        sync_attempts: 0 // Initialize retry counter
                    };

                    localStorage.setItem(`scorecard_${localId}`, JSON.stringify(localScorecard));
                }

                NotificationManager.show('🔌 Starting round OFFLINE - will sync when online', 'warning');
                break; // Exit the outer loop
            }
        }

        // Reset round state
        this.currentHole = 1;
        this.currentScore = '';
        this.scoresCache = {}; // Clear any old scores from previous rounds

        // Hide start section, show active section
        document.getElementById('scorecardStartSection').style.display = 'none';
        document.getElementById('scorecardActiveSection').style.display = 'block';

        // Subscribe to real-time updates
        this.subscribeToUpdates();

        // Select first player (updates UI)
        this.selectPlayer(this.players[0].id);

        // Render first hole and leaderboard
        this.refreshLeaderboard();

        // Create public pools if enabled
        await this.createPublicPools();

        NotificationManager.show('Round started!', 'success');
    }

    renderHole() {
        // Get current hole data for the selected tee marker
        // Try to find hole with matching tee marker first, then fall back to any tee marker
        let holeData = this.courseData?.holes?.find(h =>
            h.number === this.currentHole &&
            h.teeMarker?.toLowerCase() === this.selectedTeeMarker?.toLowerCase()
        );

        // If no match with tee marker, try to find any hole with this number
        if (!holeData) {
            holeData = this.courseData?.holes?.find(h => h.number === this.currentHole);
        }

        // Debug logging
        if (!holeData) {
            console.warn(`[LiveScorecard] No hole data found for hole ${this.currentHole}, tee marker: ${this.selectedTeeMarker}`);
            console.log('[LiveScorecard] Available holes:', this.courseData?.holes);
        }

        const par = holeData?.par || 4;
        const strokeIndex = holeData?.strokeIndex || this.currentHole;
        const yardage = holeData?.yardage || 0;

        // Update hole header with yardage
        document.getElementById('currentHoleNumber').textContent = `Hole ${this.currentHole}`;
        const yardageText = yardage > 0 ? ` • ${yardage} yds` : '';
        document.getElementById('currentHoleInfo').textContent = `Par ${par} • Index ${strokeIndex}${yardageText}`;

        // Update group score hole info (next to "Group Scores" header)
        const groupScoreHoleNum = document.getElementById('groupScoreHoleNum');
        const groupScorePar = document.getElementById('groupScorePar');
        const groupScoreIndex = document.getElementById('groupScoreIndex');
        if (groupScoreHoleNum) groupScoreHoleNum.textContent = this.currentHole;
        if (groupScorePar) groupScorePar.textContent = par;
        if (groupScoreIndex) groupScoreIndex.textContent = strokeIndex;

        // Update active player name display
        if (this.currentPlayerId) {
            const currentPlayer = this.players.find(p => p.id === this.currentPlayerId);
            if (currentPlayer) {
                const activePlayerNameElement = document.getElementById('activePlayerName');
                if (activePlayerNameElement) {
                    activePlayerNameElement.textContent = currentPlayer.name;
                }
            }
        }

        // Render player score boxes
        const grid = document.getElementById('groupScorecardGrid');
        grid.innerHTML = this.players.map(p => {
            const score = this.getPlayerScore(p.id, this.currentHole);
            const total = this.getPlayerTotal(p.id);
            const isActive = p.id === this.currentPlayerId;
            const formatLabel = (this.scoringFormats.includes('stableford') || this.scoringFormats.includes('modifiedstableford')) ? 'pts' : 'strokes';

            return `
                <div onclick="LiveScorecardManager.selectPlayer('${p.id}')"
                     class="p-3 border-2 ${isActive ? 'border-green-500 bg-green-50' : 'border-gray-300 bg-white'} rounded-lg cursor-pointer hover:border-green-400 transition">
                    <div class="text-sm font-medium text-gray-700">${p.name}</div>
                    <div class="text-2xl font-bold ${score ? 'text-gray-900' : 'text-gray-400'}">
                        ${score || '_'}
                    </div>
                    ${total !== 0 ? `<div class="text-xs text-gray-600 mt-1">Total: ${total > 0 && (this.scoringFormats.includes('stableford') || this.scoringFormats.includes('modifiedstableford')) ? '+' : ''}${total} ${formatLabel}</div>` : ''}
                </div>
            `;
        }).join('');

        // Update progress
        const entered = this.players.filter(p => this.getPlayerScore(p.id, this.currentHole)).length;
        document.getElementById('holeProgress').textContent = `${entered}/${this.players.length} players entered`;

        // Show/hide Finish Round button on hole 18
        const nextHoleBtn = document.getElementById('nextHoleButton');
        const finishRoundBtn = document.getElementById('finishRoundButton');
        if (this.currentHole === 18) {
            if (nextHoleBtn) nextHoleBtn.style.display = 'none';
            if (finishRoundBtn) finishRoundBtn.style.display = 'flex';
        } else {
            if (nextHoleBtn) nextHoleBtn.style.display = 'flex';
            if (finishRoundBtn) finishRoundBtn.style.display = 'none';
        }

        // Render scramble panel if scramble format is active
        this.renderScramblePanel();
    }

    getPlayerScore(playerId, holeNumber) {
        // Return score from local cache
        if (!this.scoresCache[playerId]) {
            return null;
        }
        return this.scoresCache[playerId][holeNumber] || null;
    }

    calculateThailandStableford(grossScore, par, getsHandicapStroke) {
        // Thailand Stableford: Base points + bonus for stroke holes
        const diff = grossScore - par;

        // Base points from gross score vs par
        let basePoints = 0;
        if (diff <= -2) basePoints = 4;      // Eagle or better
        else if (diff === -1) basePoints = 3; // Birdie
        else if (diff === 0) basePoints = 2;  // Par
        else if (diff === 1) basePoints = 1;  // Bogey
        else basePoints = 0;                  // Double bogey+ (block)

        // Add +1 bonus if this is a handicap stroke hole
        const bonusPoint = getsHandicapStroke ? 1 : 0;

        return basePoints + bonusPoint;
    }

    getHandicapStrokesOnHole(handicap, strokeIndex) {
        // Determine if player gets a stroke on this hole
        // Example: handicap 10 gets strokes on index 1-10
        // handicap 18 gets strokes on all holes (index 1-18)
        // handicap 20 gets 1 stroke on all holes + extra stroke on index 1-2

        const playingHandicap = Math.round(handicap);
        const fullStrokes = Math.floor(playingHandicap / 18);
        const remainingStrokes = playingHandicap % 18;

        let strokes = fullStrokes;
        if (strokeIndex <= remainingStrokes) {
            strokes += 1;
        }

        return strokes;
    }

    getPlayerTotal(playerId) {
        // Calculate total based on scoring format using ACTUAL course data
        let total = 0;
        const player = this.players.find(p => p.id === playerId);
        const playerScores = this.scoresCache[playerId] || {};

        for (let hole = 1; hole <= this.currentHole; hole++) {
            const score = playerScores[hole];
            if (score) {
                if (this.scoringFormats.includes('stableford') || this.scoringFormats.includes('modifiedstableford')) {
                    // Get REAL course data for this hole
                    const holeData = this.courseData?.holes?.[hole - 1];
                    const par = holeData?.par || 4;
                    const strokeIndex = holeData?.strokeIndex || hole;

                    // Thailand Stableford: calculate points with handicap strokes
                    const shotsReceived = player.handicap >= strokeIndex ? 1 : 0;
                    const netScore = score - shotsReceived;
                    const diff = par - netScore;
                    let points = diff + 2;
                    if (points < 0) points = 0;

                    total += points;
                } else {
                    total += score; // Stroke play: just sum gross scores
                }
            }
        }

        return total;
    }

    selectPlayer(playerId) {
        this.currentPlayerId = playerId;
        const player = this.players.find(p => p.id === playerId);

        if (!player) {
            console.error('[LiveScorecard] Player not found:', playerId);
            return;
        }

        // Update the active player name display
        const activePlayerNameElement = document.getElementById('activePlayerName');
        if (activePlayerNameElement) {
            activePlayerNameElement.textContent = player.name;
        }

        this.currentScore = '';
        this.renderHole();
    }

    enterDigit(digit) {
        if (!this.currentPlayerId) {
            NotificationManager.show('Select a player first', 'warning');
            return;
        }

        this.currentScore += digit.toString();
        const score = parseInt(this.currentScore);

        // Auto-save INSTANTLY if valid score (1-15)
        if (score >= 1 && score <= 15) {
            this.saveCurrentScore();
        }
    }

    clearScore() {
        this.currentScore = '';
        if (this.currentPlayerId) {
            document.getElementById('activePlayerName').textContent =
                this.players.find(p => p.id === this.currentPlayerId).name;
        }
    }

    async saveCurrentScore() {
        if (!this.currentPlayerId || !this.currentScore) {
            NotificationManager.show('Enter a score first', 'warning');
            return;
        }

        const score = parseInt(this.currentScore);
        if (score < 1 || score > 15) {
            NotificationManager.show('Invalid score (1-15)', 'error');
            return;
        }

        const scorecardId = this.scorecards[this.currentPlayerId];
        const player = this.players.find(p => p.id === this.currentPlayerId);

        // Get hole data from courseData
        const holeData = this.courseData?.holes?.[this.currentHole - 1];
        const par = holeData?.par || 4;
        const strokeIndex = holeData?.strokeIndex || this.currentHole;

        // ===== INSTANT UI UPDATE (Optimistic) =====
        // Store score in local cache immediately
        if (!this.scoresCache[this.currentPlayerId]) {
            this.scoresCache[this.currentPlayerId] = {};
        }
        this.scoresCache[this.currentPlayerId][this.currentHole] = score;

        // Clear input and update UI instantly
        this.currentScore = '';
        this.renderHole();

        // Update leaderboard immediately
        this.refreshLeaderboard();

        // Update public pool progress (for multi-group competition)
        await this.updatePublicPoolProgress(this.currentHole);

        // Auto-advance to next player IMMEDIATELY
        const currentIndex = this.players.findIndex(p => p.id === this.currentPlayerId);
        if (currentIndex < this.players.length - 1) {
            this.selectPlayer(this.players[currentIndex + 1].id);
        } else {
            // All players done, advance to next hole (scramble tracking is now integrated in the UI)
            const allDone = this.players.every(p => this.getPlayerScore(p.id, this.currentHole));
            if (allDone && this.currentHole < 18) {
                // Auto-advance to next hole after a short delay
                // FIX: Store timeout reference to prevent race condition
                this.autoAdvanceTimeout = setTimeout(() => {
                    this.autoAdvanceTimeout = null; // Clear reference
                    this.nextHole();
                }, 200);  // Quick transition - user wants faster input
            }
        }

        // ===== BACKGROUND DATABASE SAVE (Don't wait) =====
        // Check if this is a local offline scorecard
        if (scorecardId.startsWith('local_')) {
            // OFFLINE MODE: Save score to localStorage
            const localScores = JSON.parse(localStorage.getItem(`scores_${scorecardId}`) || '{}');
            localScores[this.currentHole] = {
                hole_number: this.currentHole,
                gross_score: score,
                par: par,
                stroke_index: strokeIndex,
                handicap: player.handicap,
                recorded_at: new Date().toISOString()
            };
            localStorage.setItem(`scores_${scorecardId}`, JSON.stringify(localScores));
            console.log(`[LiveScorecard] Score saved OFFLINE: ${player.name} - Hole ${this.currentHole} - ${score}`);
        } else {
            // ONLINE MODE: Save to Supabase
            window.SocietyGolfDB.saveScore(
                scorecardId,
                this.currentHole,
                score,
                par,
                strokeIndex,
                player.handicap
            ).then(() => {
                console.log(`[LiveScorecard] Score saved to DB: ${player.name} - Hole ${this.currentHole} - ${score}`);
            }).catch(error => {
                console.error('[LiveScorecard] Background save failed:', error);
                // Score still in cache, so UI works. Can retry later.
            });
        }
    }

    prevHole() {
        // FIX: Clear any pending auto-advance timeout to prevent race condition
        if (this.autoAdvanceTimeout) {
            clearTimeout(this.autoAdvanceTimeout);
            this.autoAdvanceTimeout = null;
        }

        if (this.currentHole > 1) {
            this.currentHole--;
            this.renderHole();
        }
    }

    nextHole() {
        // FIX: Clear any pending auto-advance timeout to prevent race condition
        if (this.autoAdvanceTimeout) {
            clearTimeout(this.autoAdvanceTimeout);
            this.autoAdvanceTimeout = null;
        }

        if (this.currentHole < 18) {
            this.currentHole++;
            this.currentPlayerId = this.players[0].id;
            this.renderHole();
        } else {
            this.completeRound();
        }
    }
    // ===== SCRAMBLE TRACKING =====
    showScrambleTracking() {
        // Populate player dropdowns
        const driveSelect = document.getElementById('scrambleDrivePlayer');
        const puttSelect = document.getElementById('scramblePuttPlayer');
        
        if (!driveSelect || !puttSelect) return;
        
        // Clear and populate
        driveSelect.innerHTML = '<option value="">Select player...</option>';
        puttSelect.innerHTML = '<option value="">Select player...</option>';
        
        this.players.forEach(player => {
            driveSelect.innerHTML += `<option value="${player.id}">${player.name}</option>`;
            puttSelect.innerHTML += `<option value="${player.id}">${player.name}</option>`;
        });
        
        // Update hole number
        document.getElementById('scrambleHoleNumber').textContent = this.currentHole;
        
        // Show drive counters if tracking
        if (this.scrambleConfig?.trackDrives) {
            const counters = this.players.map(p => {
                const used = this.scrambleDriveCount[p.id] || 0;
                const remaining = 18 - used;
                return `${p.name}: ${used} used, ${remaining} remaining`;
            }).join(' • ');
            document.getElementById('driveCounters').textContent = counters;
        }
        
        // Show the tracking section
        document.getElementById('scrambleTrackingSection').style.display = 'block';
    }
    
    saveScrambleTracking() {
        const drivePlayerId = document.getElementById('scrambleDrivePlayer')?.value;
        const puttPlayerId = document.getElementById('scramblePuttPlayer')?.value;

        // Validate if tracking is enabled
        if (this.scrambleConfig?.trackDrives && !drivePlayerId) {
            NotificationManager.show('Please select whose drive was used', 'warning');
            return;
        }

        if (this.scrambleConfig?.trackPutts && !puttPlayerId) {
            NotificationManager.show('Please select who made the putt', 'warning');
            return;
        }

        // Initialize tracking objects if needed
        if (!this.scrambleDriveData) this.scrambleDriveData = {};
        if (!this.scramblePuttData) this.scramblePuttData = {};
        if (!this.scrambleDriveCount) this.scrambleDriveCount = {};

        // Save selections
        if (drivePlayerId) {
            const player = this.players.find(p => p.id === drivePlayerId);
            this.scrambleDriveData[this.currentHole] = {
                player_id: drivePlayerId,
                player_name: player.name
            };
            // Increment drive counter
            this.scrambleDriveCount[drivePlayerId] = (this.scrambleDriveCount[drivePlayerId] || 0) + 1;
        }

        if (puttPlayerId) {
            const player = this.players.find(p => p.id === puttPlayerId);
            this.scramblePuttData[this.currentHole] = {
                player_id: puttPlayerId,
                player_name: player.name
            };
        }

        // Hide the section
        document.getElementById('scrambleTrackingSection').style.display = 'none';

        // Continue to next hole or finish
        if (this.currentHole < 18) {
            this.nextHole();
        } else {
            this.completeRound();
        }
    }

    // ===== NEW INTEGRATED SCRAMBLE UI =====
    renderScramblePanel() {
        const panel = document.getElementById('scrambleTrackingPanel');
        if (!panel) return;

        // Show panel only if scramble format is active
        if (!this.scoringFormats.includes('scramble')) {
            panel.style.display = 'none';
            return;
        }

        panel.style.display = 'block';

        // Initialize tracking objects if needed
        if (!this.scrambleDriveData) this.scrambleDriveData = {};
        if (!this.scramblePuttData) this.scramblePuttData = {};
        if (!this.scrambleDriveCount) this.scrambleDriveCount = {};

        // Render drive buttons with counters
        const driveButtonsContainer = document.getElementById('scrambleDriveButtons');
        if (driveButtonsContainer && this.scrambleConfig?.trackDrives) {
            const minDrives = this.scrambleConfig.minDrivesPerPlayer || 0;
            driveButtonsContainer.innerHTML = this.players.map(player => {
                const used = this.scrambleDriveCount[player.id] || 0;
                const isSelected = this.scrambleDriveData[this.currentHole]?.player_id === player.id;

                return `
                    <button onclick="LiveScorecardManager.selectScrambleDrive('${player.id}')"
                            class="w-full px-3 py-2 rounded-lg border-2 transition text-left flex items-center justify-between
                                   ${isSelected ? 'border-green-500 bg-green-50' : 'border-gray-300 bg-white hover:border-green-300'}">
                        <span class="font-medium ${isSelected ? 'text-green-700' : 'text-gray-900'}">${player.name}</span>
                        <span class="text-xs ${used < minDrives ? 'text-red-600 font-semibold' : 'text-gray-600'}">
                            ${used} of ${minDrives} used
                        </span>
                    </button>
                `;
            }).join('');
        }

        // Render putt buttons
        const puttButtonsContainer = document.getElementById('scramblePuttButtons');
        if (puttButtonsContainer && this.scrambleConfig?.trackPutts) {
            puttButtonsContainer.innerHTML = this.players.map(player => {
                const isSelected = this.scramblePuttData[this.currentHole]?.player_id === player.id;

                return `
                    <button onclick="LiveScorecardManager.selectScramblePutt('${player.id}')"
                            class="w-full px-3 py-2 rounded-lg border-2 transition text-left
                                   ${isSelected ? 'border-blue-500 bg-blue-50 font-medium text-blue-700' : 'border-gray-300 bg-white hover:border-blue-300 text-gray-900'}">
                        ${player.name}
                    </button>
                `;
            }).join('');
        }

        // Update summary
        this.updateScrambleSummary();
    }

    selectScrambleDrive(playerId) {
        if (!this.scrambleDriveData) this.scrambleDriveData = {};

        const player = this.players.find(p => p.id === playerId);
        if (!player) return;

        // Check if changing from a previously selected drive
        const previousSelection = this.scrambleDriveData[this.currentHole];

        // Update selection
        this.scrambleDriveData[this.currentHole] = {
            player_id: playerId,
            player_name: player.name
        };

        // Update drive counter (decrement previous, increment new)
        if (previousSelection && previousSelection.player_id !== playerId) {
            this.scrambleDriveCount[previousSelection.player_id] = Math.max(0, (this.scrambleDriveCount[previousSelection.player_id] || 0) - 1);
        }

        if (!previousSelection || previousSelection.player_id !== playerId) {
            this.scrambleDriveCount[playerId] = (this.scrambleDriveCount[playerId] || 0) + 1;
        }

        // Re-render to update UI
        this.renderScramblePanel();

        console.log(`[Scramble] Drive selected: ${player.name} (${this.scrambleDriveCount[playerId]} used)`);
    }

    selectScramblePutt(playerId) {
        if (!this.scramblePuttData) this.scramblePuttData = {};

        const player = this.players.find(p => p.id === playerId);
        if (!player) return;

        this.scramblePuttData[this.currentHole] = {
            player_id: playerId,
            player_name: player.name
        };

        // Re-render to update UI
        this.renderScramblePanel();

        console.log(`[Scramble] Putt selected: ${player.name}`);
    }

    updateScrambleSummary() {
        const summaryDiv = document.getElementById('scrambleSelectionSummary');
        const driveSpan = document.getElementById('scrambleSelectedDrive');
        const puttSpan = document.getElementById('scrambleSelectedPutt');
        const holeSpan = document.getElementById('scrambleCurrentHole');

        if (!summaryDiv || !driveSpan || !puttSpan || !holeSpan) return;

        const driveSelection = this.scrambleDriveData?.[this.currentHole];
        const puttSelection = this.scramblePuttData?.[this.currentHole];

        // Update hole number
        holeSpan.textContent = this.currentHole;

        // Update drive selection
        driveSpan.textContent = driveSelection ? driveSelection.player_name : '-';

        // Update putt selection
        puttSpan.textContent = puttSelection ? puttSelection.player_name : '-';

        // Show summary only if at least one selection made
        if (driveSelection || puttSelection) {
            summaryDiv.style.display = 'block';
        } else {
            summaryDiv.style.display = 'none';
        }
    }


    async completeRound() {
        // FIX: Clear any pending auto-advance timeout
        if (this.autoAdvanceTimeout) {
            clearTimeout(this.autoAdvanceTimeout);
            this.autoAdvanceTimeout = null;
        }

        // NO POPUPS: Just execute the command directly as user requested
        // Removed: confirm('Complete round for all players?')

        // Check scramble drive requirements if scramble format is active
        if (this.scoringFormats.includes('scramble') && this.scrambleConfig?.minDrivesPerPlayer > 0) {
            for (const player of this.players) {
                const used = this.scrambleDriveCount[player.id] || 0;
                const required = this.scrambleConfig.minDrivesPerPlayer;
                if (used < required) {
                    // NO POPUPS: Show notification instead of alert
                    NotificationManager.show(`${player.name} needs ${required - used} more drive(s) to meet minimum ${required}.`, 'warning');
                    return; // Prevent completion
                }
            }
        }

        // Mark scorecards as completed in database
        for (const player of this.players) {
            const scorecardId = this.scorecards[player.id];
            if (scorecardId && !scorecardId.startsWith('local_')) {
                await window.SocietyGolfDB.completeScorecard(scorecardId);
            }
    
            // Calculate and update handicap for each player with a linked profile
            if (player.lineUserId) {
                await this.updatePlayerHandicap(player);
            }
        }
    
        // Distribute scores to all players and organizers
        await this.distributeRoundScores();
    
        NotificationManager.show('Round completed! Scores saved and distributed.', 'success');
    
        // Show finalized scorecard BEFORE resetting
        this.showFinalizedScorecard();
    }

    async saveRoundToHistory(player) {
        try {
            // Skip if no scores recorded
            let holesPlayed = 0;
            for (let hole = 1; hole <= 18; hole++) {
                if (this.scoresCache[player.id]?.[hole]) holesPlayed++;
            }
    
            if (holesPlayed === 0) {
                console.log(`[LiveScorecard] Skipping history save for ${player.name} - no scores recorded`);
                return null;
            }
    
            // Get course and event info
            const courseName = this.courseData?.name || 'Unknown Course';
            const courseId = document.getElementById('scorecardCourseSelect')?.value || '';
            const teeMarker = document.querySelector('input[name="teeMarker"]:checked')?.value || 'white';
            const roundType = this.isPrivateRound ? 'private' : 'society';
            const eventId = this.eventId;
            const scorecardId = this.scorecards[player.id];
    
            // Calculate scores for ALL selected formats
            const formatScores = {};
            let totalGross = 0;
            let totalStableford = 0;
    
            // Build scores array for engine
            const scoresArray = [];
            for (let hole = 1; hole <= 18; hole++) {
                const score = this.scoresCache[player.id]?.[hole];
                if (score) {
                    totalGross += score;
                    scoresArray.push({ hole_number: hole, gross_score: score });
                }
            }
    
            const engine = LiveScorecardSystem.GolfScoringEngine;
    
            // Calculate each selected format
            for (const format of this.scoringFormats) {
                switch (format) {
                    case 'stableford':
                        formatScores.stableford = engine.calculateStablefordTotal(
                            scoresArray,
                            this.courseData.holes,
                            player.handicap,
                            true
                        );
                        totalStableford = formatScores.stableford;
                        break;
    
                    case 'strokeplay':
                        formatScores.strokeplay = totalGross;
                        break;
    
                    case 'modifiedstableford':
                        formatScores.modifiedstableford = engine.calculateStablefordTotal(
                            scoresArray,
                            this.courseData.holes,
                            player.handicap,
                            true,
                            engine.modifiedStablefordPoints
                        );
                        break;
    
                    case 'nassau':
                        const nassauResult = engine.calculateNassau([{
                            player_id: player.id,
                            scores: scoresArray
                        }], this.courseData.holes);
                        formatScores.nassau = nassauResult[0] || { front: 0, back: 0, total: 0 };
                        break;
    
                    case 'skins':
                        formatScores.skins = { holes_won: 0, points: 0 };
                        break;
    
                    case 'scramble':
                        formatScores.scramble = totalGross;
                        break;
    
                    case 'matchplay':
                        formatScores.matchplay = { holes_won: 0, holes_lost: 0, holes_tied: 0 };
                        break;
    
                    case 'bestball':
                        formatScores.bestball = totalGross;
                        break;
                }
            }
    
            // Get Scramble config if selected
            let scrambleConfig = null;
            if (this.scoringFormats.includes('scramble')) {
                const teamSize = document.querySelector('input[name="scrambleTeamSize"]:checked')?.value || '4';
                const trackDrives = document.getElementById('scrambleTrackDrives')?.checked || false;
                const trackPutts = document.getElementById('scrambleTrackPutts')?.checked || false;
                const minDrives = document.getElementById('scrambleMinDrives')?.value || '4';
    
                scrambleConfig = {
                    teamSize: parseInt(teamSize),
                    trackDrives: trackDrives,
                    trackPutts: trackPutts,
                    minDrivesPerPlayer: parseInt(minDrives)
                };
            }
    
            // Only save for players with LINE IDs
            if (!player.lineUserId || player.lineUserId.trim() === '') {
                console.log(`[LiveScorecard] Skipping database save for ${player.name} - no LINE ID`);
                return null;
            }
    
            // Save to Supabase database
            const { data: round, error } = await window.SupabaseDB.client
                .from('rounds')
                .insert({
                    golfer_id: player.lineUserId,
                    course_id: courseId,
                    course_name: courseName,
                    type: roundType,
                    society_event_id: eventId,
                    started_at: new Date().toISOString(),
                    completed_at: new Date().toISOString(),
                    status: 'completed',
                    total_gross: totalGross,
                    total_stableford: totalStableford,
                    handicap_used: player.handicap,
                    tee_marker: teeMarker,
                    scoring_formats: this.scoringFormats,
                    format_scores: formatScores,
                    posted_formats: this.postedFormats || this.scoringFormats,
                    scramble_config: scrambleConfig
                })
                .select()
                .single();
    
            if (error) {
                console.error('[LiveScorecard] Error saving to round history:', error);
                return null;
            }

            console.log(`[LiveScorecard] ✅ Saved round to database for ${player.name}. Round ID: ${round.id}`);

            // Save hole-by-hole data including scramble tracking
            const holeInserts = [];
            for (let holeNum = 1; holeNum <= 18; holeNum++) {
                const grossScore = this.scoresCache[player.id]?.[holeNum];
                if (!grossScore) continue; // Skip holes with no score

                const holeData = this.courseData.holes?.[holeNum - 1];
                const par = holeData?.par || 4;
                const strokeIndex = holeData?.strokeIndex || holeNum;

                // Calculate net score and stableford
                const shotsReceived = player.handicap >= strokeIndex ? 1 : 0;
                const netScore = grossScore - shotsReceived;
                const stablefordPoints = Math.max(0, (par - netScore) + 2);

                // Get scramble tracking data for this hole
                const driveData = this.scrambleDriveData?.[holeNum];
                const puttData = this.scramblePuttData?.[holeNum];

                holeInserts.push({
                    round_id: round.id,
                    hole_number: holeNum,
                    par: par,
                    stroke_index: strokeIndex,
                    gross_score: grossScore,
                    net_score: netScore,
                    stableford_points: stablefordPoints,
                    handicap_strokes: shotsReceived,
                    drive_player_id: driveData?.player_id || null,
                    drive_player_name: driveData?.player_name || null,
                    putt_player_id: puttData?.player_id || null,
                    putt_player_name: puttData?.player_name || null
                });
            }

            // Insert all holes at once
            if (holeInserts.length > 0) {
                const { error: holesError } = await window.SupabaseDB.client
                    .from('round_holes')
                    .insert(holeInserts);

                if (holesError) {
                    console.error('[LiveScorecard] Error saving hole details:', holesError);
                } else {
                    console.log(`[LiveScorecard] ✅ Saved ${holeInserts.length} hole details with scramble tracking`);
                }
            }

            return round.id;
    
        } catch (error) {
            console.error('[LiveScorecard] Error in saveRoundToHistory:', error);
            return null;
        }
    }

    async distributeRoundScores() {
        try {
            // Get all player LINE IDs
            const playerIds = this.players
                .filter(p => p.lineUserId && p.lineUserId.trim() !== '')
                .map(p => p.lineUserId);
    
            if (playerIds.length === 0) {
                console.log('[LiveScorecard] No players with LINE IDs to distribute to');
                return;
            }
    
            // Save round for each player and distribute
            const roundIds = [];
            for (const player of this.players) {
                const roundId = await this.saveRoundToHistory(player);
                if (roundId) {
                    roundIds.push(roundId);
    
                    // Distribute this round to all players
                    const { error } = await window.SupabaseDB.client.rpc(
                        'distribute_round_to_players',
                        {
                            p_round_id: roundId,
                            p_player_ids: playerIds
                        }
                    );
    
                    if (error) {
                        console.error(`[LiveScorecard] Error distributing round ${roundId}:`, error);
                    } else {
                        console.log(`[LiveScorecard] ✅ Distributed round ${roundId} to ${playerIds.length} players`);
                    }
                }
            }
    
            // Mark as posted to organizer if society event
            if (!this.isPrivateRound && this.eventId && roundIds.length > 0) {
                const { data: event } = await window.SupabaseDB.client
                    .from('society_events')
                    .select('organizer_id')
                    .eq('id', this.eventId)
                    .single();
    
                if (event) {
                    console.log(`[LiveScorecard] ✅ Round visible to organizer: ${event.organizer_id}`);
                }
            }
    
            NotificationManager.show(`Scores shared with ${playerIds.length} player${playerIds.length !== 1 ? 's' : ''}!`, 'success');
    
        } catch (error) {
            console.error('[LiveScorecard] Error distributing scores:', error);
        }
    }

    // =====================================================
    // PUBLIC GAMES / MULTI-GROUP COMPETITION
    // =====================================================

    togglePublicGame(isPublic) {
        const optionsDiv = document.getElementById('publicGameOptions');
        if (isPublic) {
            optionsDiv.style.display = 'block';
        } else {
            optionsDiv.style.display = 'none';
        }
        console.log('[LiveScorecard] Public game mode:', isPublic);
    }

    async createPublicPools() {
        const isPublic = document.getElementById('publicGameToggle').checked;
        if (!isPublic) return;

        const courseId = document.getElementById('scorecardCourseSelect').value;
        const today = new Date().toISOString().split('T')[0];
        const userId = AppState.currentUser?.lineUserId;

        if (!userId || !courseId) {
            console.warn('[LiveScorecard] Cannot create public pools - missing user or course');
            return;
        }

        // Check which pools to create
        const createSkins = document.getElementById('publicSkins')?.checked;
        const createMatchPlay = document.getElementById('publicMatchPlay')?.checked;
        const createNassau = document.getElementById('publicNassau')?.checked;

        this.publicPoolIds = [];

        try {
            // Create Skins pool
            if (createSkins) {
                const pointsPerHole = parseInt(document.getElementById('skinsValueInput')?.value) || 100;
                const result = await window.LiveGamesSystem.createPool({
                    courseId: courseId,
                    eventId: this.eventId,
                    dateISO: today,
                    type: 'skins',
                    name: `Skins Game - ${pointsPerHole}pts/hole`,
                    isPublic: true,
                    config: {
                        useNet: true,
                        pointsPerHole: pointsPerHole,
                        carryOver: true
                    },
                    createdBy: userId
                });

                if (result.success) {
                    this.publicPoolIds.push({ type: 'skins', poolId: result.pool.id });
                    // Auto-join creator
                    await window.LiveGamesSystem.joinPool(result.pool.id, userId);
                    console.log('[LiveScorecard] Created and joined Skins pool:', result.pool.id);
                }
            }

            // Create Match Play pool
            if (createMatchPlay) {
                const result = await window.LiveGamesSystem.createPool({
                    courseId: courseId,
                    eventId: this.eventId,
                    dateISO: today,
                    type: 'matchplay',
                    name: `Match Play - Open`,
                    isPublic: true,
                    config: {
                        useNet: true
                    },
                    createdBy: userId
                });

                if (result.success) {
                    this.publicPoolIds.push({ type: 'matchplay', poolId: result.pool.id });
                    await window.LiveGamesSystem.joinPool(result.pool.id, userId);
                    console.log('[LiveScorecard] Created and joined Match Play pool:', result.pool.id);
                }
            }

            // Create Nassau pool
            if (createNassau) {
                const result = await window.LiveGamesSystem.createPool({
                    courseId: courseId,
                    eventId: this.eventId,
                    dateISO: today,
                    type: 'nassau',
                    name: `Nassau - Open`,
                    isPublic: true,
                    config: {
                        useNet: true
                    },
                    createdBy: userId
                });

                if (result.success) {
                    this.publicPoolIds.push({ type: 'nassau', poolId: result.pool.id });
                    await window.LiveGamesSystem.joinPool(result.pool.id, userId);
                    console.log('[LiveScorecard] Created and joined Nassau pool:', result.pool.id);
                }
            }

            if (this.publicPoolIds.length > 0) {
                NotificationManager.show(`✅ Created ${this.publicPoolIds.length} public game${this.publicPoolIds.length > 1 ? 's' : ''} - others can now join!`, 'success');
            }

        } catch (error) {
            console.error('[LiveScorecard] Error creating public pools:', error);
            NotificationManager.show('Error creating public games', 'error');
        }
    }

    async updatePublicPoolProgress(hole) {
        // Update progress for all pools this round is participating in
        if (!this.publicPoolIds || this.publicPoolIds.length === 0) return;

        const userId = AppState.currentUser?.lineUserId;
        if (!userId) return;

        for (const { poolId } of this.publicPoolIds) {
            await window.LiveGamesSystem.updateProgress(poolId, userId, hole);
        }
    }

    // =====================================================
    // JOIN GAMES MODAL FUNCTIONS
    // =====================================================

    async showJoinGamesModal() {
        const modal = document.getElementById('joinGamesModal');
        modal.classList.remove('hidden');

        // Load available pools for current course/date
        await this.loadAvailablePools();
    }

    closeJoinGamesModal() {
        const modal = document.getElementById('joinGamesModal');
        modal.classList.add('hidden');
    }

    // =====================================================
    // SCORECARD IMAGE VIEWER
    // =====================================================

    viewScorecardImage() {
        if (!this.courseData || !this.courseData.scorecardUrl) {
            NotificationManager.show('No scorecard image available for this course', 'warning');
            return;
        }

        const modal = document.getElementById('scorecardImageModal');
        const img = document.getElementById('scorecardImage');
        const title = document.getElementById('scorecardImageTitle');

        // Set image source
        img.src = this.courseData.scorecardUrl;
        title.textContent = `${this.courseData.name} - Scorecard`;

        // Show modal
        modal.classList.remove('hidden');

        console.log('[LiveScorecard] Displaying scorecard image:', this.courseData.scorecardUrl);
    }

    closeScorecardImage() {
        const modal = document.getElementById('scorecardImageModal');
        modal.classList.add('hidden');
    }

    async loadAvailablePools() {
        const courseId = document.getElementById('scorecardCourseSelect')?.value;
        if (!courseId) {
            console.warn('[LiveScorecard] No course selected');
            return;
        }

        const today = new Date().toISOString().split('T')[0];
        const userId = AppState.currentUser?.lineUserId;

        const result = await window.LiveGamesSystem.getAvailablePools(courseId, today, this.eventId);

        if (result.success) {
            this.renderAvailablePoolsList(result.pools, userId);

            // Update count badge
            const count = result.pools.filter(p =>
                !p.pool_entrants.some(e => e.player_id === userId)
            ).length;
            const badge = document.getElementById('availablePoolsCount');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
    }

    renderAvailablePoolsList(pools, userId) {
        const container = document.getElementById('availablePoolsList');
        const myPoolsSection = document.getElementById('myPoolsSection');
        const myPoolsList = document.getElementById('myPoolsList');

        // Separate into available and joined
        const available = [];
        const joined = [];

        for (const pool of pools) {
            const isJoined = pool.pool_entrants.some(e => e.player_id === userId);
            if (isJoined) {
                joined.push(pool);
            } else {
                available.push(pool);
            }
        }

        // Render available pools
        if (available.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <span class="material-symbols-outlined text-4xl mb-2">public_off</span>
                    <p>No public games available</p>
                    <p class="text-xs mt-1">Be the first to create one!</p>
                </div>
            `;
        } else {
            container.innerHTML = available.map(pool => this.renderPoolCard(pool, false)).join('');
        }

        // Render joined pools
        if (joined.length > 0) {
            myPoolsSection.style.display = 'block';
            myPoolsList.innerHTML = joined.map(pool => this.renderPoolCard(pool, true)).join('');
        } else {
            myPoolsSection.style.display = 'none';
        }
    }

    renderPoolCard(pool, isJoined) {
        const typeIcons = {
            skins: { icon: 'monetization_on', color: 'orange' },
            matchplay: { icon: 'sports_score', color: 'purple' },
            nassau: { icon: 'emoji_events', color: 'blue' }
        };

        const config = typeIcons[pool.type] || typeIcons.skins;
        const entrantCount = pool.pool_entrants.length;

        return `
            <div class="p-4 border-2 border-${config.color}-200 bg-${config.color}-50 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="material-symbols-outlined text-${config.color}-600">${config.icon}</span>
                            <span class="font-semibold text-gray-900">${pool.name}</span>
                        </div>
                        <div class="text-xs text-gray-600">
                            ${entrantCount} ${entrantCount === 1 ? 'player' : 'players'} joined
                            ${pool.config.pointsPerHole ? ` • ${pool.config.pointsPerHole} pts/hole` : ''}
                        </div>
                    </div>
                    ${isJoined ? `
                        <button onclick="LiveScorecardManager.leavePool('${pool.id}')"
                                class="px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-medium hover:bg-red-200">
                            Leave
                        </button>
                    ` : `
                        <button onclick="LiveScorecardManager.joinPool('${pool.id}')"
                                class="px-4 py-2 bg-${config.color}-600 text-white rounded-lg text-sm font-medium hover:bg-${config.color}-700">
                            Join
                        </button>
                    `}
                </div>
            </div>
        `;
    }

    async joinPool(poolId) {
        const userId = AppState.currentUser?.lineUserId;
        if (!userId) {
            NotificationManager.show('Not authenticated', 'error');
            return;
        }

        const result = await window.LiveGamesSystem.joinPool(poolId, userId);

        if (result.success) {
            NotificationManager.show('✅ Joined game!', 'success');
            // Track this pool for progress updates
            if (!this.publicPoolIds) this.publicPoolIds = [];
            this.publicPoolIds.push({ poolId });
            // Refresh the list
            await this.loadAvailablePools();
        } else {
            NotificationManager.show('Failed to join game', 'error');
        }
    }

    async leavePool(poolId) {
        const userId = AppState.currentUser?.lineUserId;
        if (!userId) return;

        // NO POPUPS: Just execute the command directly as user requested
        // Removed: confirm('Leave this game?')

        const result = await window.LiveGamesSystem.leavePool(poolId, userId);

        if (result.success) {
            NotificationManager.show('Left game', 'success');
            // Remove from tracked pools
            if (this.publicPoolIds) {
                this.publicPoolIds = this.publicPoolIds.filter(p => p.poolId !== poolId);
            }
            // Refresh the list
            await this.loadAvailablePools();
        } else {
            NotificationManager.show('Failed to leave game', 'error');
        }
    }

    async updatePlayerHandicap(player) {
        try {
            // Calculate total gross score
            let totalGross = 0;
            let holesPlayed = 0;

            for (let hole = 1; hole <= 18; hole++) {
                const scoreData = this.scoresCache[player.id]?.[hole];
                if (scoreData && scoreData.gross_score) {
                    totalGross += scoreData.gross_score;
                    holesPlayed++;
                }
            }

            if (holesPlayed < 18) {
                console.log(`[LiveScorecard] Skipping handicap update for ${player.name} - incomplete round (${holesPlayed}/18)`);
                return; // Don't update handicap for incomplete rounds
            }

            // Calculate course par
            let coursePar = 0;
            for (let i = 1; i <= 18; i++) {
                const hole = this.courseData?.holes?.find(h => h.number === i);
                coursePar += hole?.par || 4;
            }

            // Calculate expected score (par + handicap)
            const expectedScore = coursePar + player.handicap;
            const scoreDiff = totalGross - expectedScore;

            // Calculate new handicap (simple system):
            // - For every stroke better than expected: reduce handicap by 0.1
            // - For every stroke worse than expected: increase handicap by 0.1
            // - Maximum change: +/- 2.0 per round
            let handicapChange = scoreDiff * 0.1;

            // Cap the change at +/- 2.0
            if (handicapChange > 2.0) handicapChange = 2.0;
            if (handicapChange < -2.0) handicapChange = -2.0;

            const newHandicap = Math.max(0, Math.min(54, player.handicap + handicapChange)); // Keep between 0 and 54
            const roundedHandicap = Math.round(newHandicap * 10) / 10; // Round to 1 decimal place

            console.log(`[LiveScorecard] Handicap update for ${player.name}:`, {
                oldHandicap: player.handicap,
                grossScore: totalGross,
                expectedScore,
                scoreDiff,
                newHandicap: roundedHandicap
            });

            // Update the profile in Supabase
            const profile = await window.SupabaseDB.getUserProfile(player.lineUserId);
            if (profile) {
                // CRITICAL: Must pass ALL profile sections to prevent data loss
                // Follow the pattern from force-save-correct-profile.txt
                await window.SupabaseDB.saveUserProfile({
                    line_user_id: player.lineUserId,
                    name: profile.name,
                    role: profile.role,
                    caddy_number: profile.caddy_number,
                    phone: profile.phone,
                    email: profile.email,
                    homeClub: profile.profile_data?.golfInfo?.homeClub || profile.home_club,
                    language: profile.language,

                    // Pass ALL profile sections (prevents data loss)
                    personalInfo: profile.profile_data?.personalInfo || {},
                    golfInfo: {
                        ...(profile.profile_data?.golfInfo || {}),
                        handicap: roundedHandicap  // Only update handicap, preserve homeClub & other fields
                    },
                    professionalInfo: profile.profile_data?.professionalInfo || {},
                    skills: profile.profile_data?.skills || {},
                    preferences: profile.profile_data?.preferences || {},
                    media: profile.profile_data?.media || {},
                    privacy: profile.profile_data?.privacy || {},

                    // Top-level overrides
                    handicap: roundedHandicap,
                    userId: profile.profile_data?.userId || player.lineUserId,
                    username: profile.profile_data?.username || null,
                    linePictureUrl: profile.profile_data?.linePictureUrl || null
                });

                console.log(`[LiveScorecard] ✅ Handicap updated for ${player.name}: ${player.handicap} → ${roundedHandicap}`);
            }
        } catch (error) {
            console.error(`[LiveScorecard] Error updating handicap for ${player.name}:`, error);
            // Don't throw - continue with other players
        }
    }

    endRound() {
        // Show finalized scorecard before resetting
        this.showFinalizedScorecard();
    }

    actuallyEndRound() {
        // FIX: Clear any pending auto-advance timeout
        if (this.autoAdvanceTimeout) {
            clearTimeout(this.autoAdvanceTimeout);
            this.autoAdvanceTimeout = null;
        }

        // Reset state
        this.players = [];
        this.currentHole = 1;
        this.scorecards = {};
        this.scoresCache = {}; // Clear score cache
        this.scoringFormats = ['stableford']; // Reset to default
        this.currentPlayerId = null;

        // Show start section
        document.getElementById('scorecardStartSection').style.display = 'block';
        document.getElementById('scorecardActiveSection').style.display = 'none';
        document.getElementById('scorecardPlayersList').innerHTML = '';

        // Unsubscribe from updates
        this.subscriptions.forEach(sub => sub.unsubscribe());
        this.subscriptions = [];
    }

    showFinalizedScorecard() {
        console.log('[LiveScorecard] Showing finalized scorecard');

        // Populate header information
        const eventSelectText = document.getElementById('scorecardEventSelect')?.selectedOptions[0]?.textContent || 'Practice Round';

        // Parse event name and society name (format: "Event Name - Society Name")
        let eventName = eventSelectText;
        let societyName = 'Practice Round';

        if (eventSelectText.includes(' - ')) {
            const parts = eventSelectText.split(' - ');
            eventName = parts[0].trim();
            societyName = parts[1].trim();
        }

        const courseName = this.courseData?.name || 'Unknown Course';
        const teeMarker = document.getElementById('scorecardTeeMarkerSelect')?.value || 'White';
        // Format all selected formats for display
        const formatNames = {
            'stableford': 'Stableford',
            'strokeplay': 'Stroke Play',
            'scramble': 'Scramble',
            'modifiedstableford': 'Modified Stableford',
            'nassau': 'Nassau',
            'skins': 'Skins',
            'matchplay': 'Match Play',
            'bestball': 'Best Ball'
        };
        const format = this.scoringFormats.map(f => formatNames[f] || f).join(' • ');

        // Format today's date
        const today = new Date();
        const date = today.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        document.getElementById('finalScorecard_societyName').textContent = societyName;
        document.getElementById('finalScorecard_eventName').textContent = eventName;
        document.getElementById('finalScorecard_course').textContent = courseName;
        document.getElementById('finalScorecard_teeMarker').textContent = teeMarker.toUpperCase();
        document.getElementById('finalScorecard_format').textContent = format;
        document.getElementById('finalScorecard_date').textContent = date;

        // Render each player's scorecard
        const playersContainer = document.getElementById('finalScorecard_playersContainer');
        playersContainer.innerHTML = '';

        // If scramble format, render team scorecard first
        if (this.scoringFormats.includes('scramble')) {
            const teamCard = this.renderTeamScrambleScorecard();
            playersContainer.appendChild(teamCard);
        }

        this.players.forEach(player => {
            const playerCard = this.renderPlayerFinalizedScorecard(player);
            playersContainer.appendChild(playerCard);
        });

        // Show/hide delete button based on round type
        const deleteBtn = document.getElementById('deleteScorecardBtn');
        if (this.isPrivateRound) {
            deleteBtn.style.display = 'flex'; // Show delete for private rounds
        } else {
            deleteBtn.style.display = 'none'; // Hide delete for society/tournament rounds
        }

        // Show modal
        document.getElementById('finalizedScorecardModal').classList.remove('hidden');
    }

    renderPlayerFinalizedScorecard(player) {
        const container = document.createElement('div');
        container.className = 'border rounded-lg p-4 mb-4 bg-white shadow-sm print:break-inside-avoid print:shadow-none';

        // Player header
        const header = document.createElement('div');
        header.className = 'mb-4 pb-3 border-b-2 border-gray-300';
        header.innerHTML = `
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">${player.name}</h3>
                    <p class="text-sm text-gray-600">Handicap: ${player.handicap}</p>
                </div>
                <div class="text-right" id="playerTotal_${player.id}"></div>
            </div>
        `;
        container.appendChild(header);

        // Scorecard table
        const table = document.createElement('div');
        table.className = 'overflow-x-auto';

        let tableHTML = `
            <table class="w-full text-xs md:text-sm border-collapse">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="border border-gray-300 px-2 py-2 text-center font-bold">Hole</th>
        `;

        // Hole numbers
        for (let i = 1; i <= 18; i++) {
            tableHTML += `<th class="border border-gray-300 px-1 py-2 text-center font-bold">${i}</th>`;
        }
        tableHTML += `<th class="border border-gray-300 px-2 py-2 text-center font-bold bg-yellow-100">Total</th></tr>`;

        // Par row
        tableHTML += `<tr class="bg-blue-50"><td class="border border-gray-300 px-2 py-2 font-semibold">Par</td>`;
        let frontNinePar = 0, backNinePar = 0;
        for (let i = 1; i <= 18; i++) {
            const hole = this.courseData?.holes?.find(h => h.number === i);
            const par = hole?.par || 4;
            if (i <= 9) frontNinePar += par;
            else backNinePar += par;
            tableHTML += `<td class="border border-gray-300 px-1 py-2 text-center">${par}</td>`;
        }
        tableHTML += `<td class="border border-gray-300 px-2 py-2 text-center font-bold bg-yellow-100">${frontNinePar + backNinePar}</td></tr>`;

        // Stroke Index row
        tableHTML += `<tr class="bg-gray-50"><td class="border border-gray-300 px-2 py-2 font-semibold text-xs">Index</td>`;
        for (let i = 1; i <= 18; i++) {
            const hole = this.courseData?.holes?.find(h => h.number === i);
            const index = hole?.strokeIndex || i;
            tableHTML += `<td class="border border-gray-300 px-1 py-2 text-center text-xs">${index}</td>`;
        }
        tableHTML += `<td class="border border-gray-300 px-2 py-2"></td></tr>`;

        // Gross Score row
        tableHTML += `<tr class="bg-white"><td class="border border-gray-300 px-2 py-2 font-semibold">Score</td>`;
        let frontNineGross = 0, backNineGross = 0;
        let frontNinePoints = 0, backNinePoints = 0; // Declare at function scope for summary section
        for (let i = 1; i <= 18; i++) {
            // scoresCache stores scores as plain numbers: scoresCache[playerId][hole] = 5
            const scoreValue = this.scoresCache[player.id]?.[i];
            const score = (typeof scoreValue === 'number') ? scoreValue : '-';

            if (score !== '-') {
                if (i <= 9) frontNineGross += score;
                else backNineGross += score;
            }

            // Style score with circles/squares based on par
            const hole = this.courseData?.holes?.find(h => h.number === i);
            const par = hole?.par || 4;
            let cellClass = 'border border-gray-300 px-1 py-2 text-center font-bold';
            let scoreHTML = score;

            if (score !== '-') {
                const diff = score - par;
                if (diff <= -2) {
                    // Eagle or better: Double blue circle
                    scoreHTML = `<span style="display: inline-block; width: 28px; height: 28px; line-height: 28px; border: 2px solid #2563eb; border-radius: 50%; box-shadow: 0 0 0 4px white, 0 0 0 6px #2563eb; color: #2563eb; font-weight: bold;">${score}</span>`;
                } else if (diff === -1) {
                    // Birdie: Blue circle
                    scoreHTML = `<span style="display: inline-block; width: 28px; height: 28px; line-height: 28px; border: 2px solid #2563eb; border-radius: 50%; color: #2563eb; font-weight: bold;">${score}</span>`;
                } else if (diff === 0) {
                    // Par: No decoration
                    scoreHTML = score;
                } else if (diff === 1) {
                    // Bogey: Red square
                    scoreHTML = `<span style="display: inline-block; width: 28px; height: 28px; line-height: 28px; border: 2px solid #dc2626; color: #dc2626; font-weight: bold;">${score}</span>`;
                } else if (diff >= 2) {
                    // Double bogey+: Red double square
                    scoreHTML = `<span style="display: inline-block; width: 28px; height: 28px; line-height: 28px; border: 2px solid #dc2626; box-shadow: 0 0 0 4px white, 0 0 0 6px #dc2626; color: #dc2626; font-weight: bold;">${score}</span>`;
                }
            }
            tableHTML += `<td class="${cellClass}">${scoreHTML}</td>`;
        }
        const totalGross = frontNineGross + backNineGross;
        tableHTML += `<td class="border border-gray-300 px-2 py-2 text-center font-bold text-lg bg-yellow-100">${totalGross || '-'}</td></tr>`;

        // Stableford Points row (if stableford format)
        // Add rows for each selected format
        const engine = LiveScorecardSystem.GolfScoringEngine;

        // Pre-calculate Nassau net scores (for use in table and summary)
        let frontNineNet = 0, backNineNet = 0, totalNet = 0;
        if (this.scoringFormats.includes('nassau')) {
            for (let i = 1; i <= 18; i++) {
                const scoreValue = this.scoresCache[player.id]?.[i];
                if (typeof scoreValue === 'number') {
                    const hole = this.courseData?.holes?.find(h => h.number === i);
                    const strokeIndex = hole?.strokeIndex || i;
                    const shotsReceived = player.handicap >= strokeIndex ? 1 : 0;
                    const netScore = scoreValue - shotsReceived;

                    if (i <= 9) frontNineNet += netScore;
                    else backNineNet += netScore;
                }
            }
            totalNet = frontNineNet + backNineNet;
        }

        // Pre-calculate Skins results (for use in table and summary)
        let holesWonCount = 0;
        let skinsResults = null;
        if (this.scoringFormats.includes('skins')) {
            const allPlayerData = this.players.map(p => {
                const playerScores = this.scoresCache[p.id] || {};
                const scoresArray = Object.entries(playerScores).map(([hole, score]) => ({
                    hole_number: parseInt(hole),
                    gross_score: score
                }));

                return {
                    playerId: p.id,
                    playerName: p.name,
                    scores: scoresArray,
                    handicap: p.handicap
                };
            });

            const pointsPerHole = parseInt(document.getElementById('skinsValueInput')?.value) || 100;
            skinsResults = engine.calculateSkins(allPlayerData, this.courseData.holes, true, pointsPerHole);

            for (let i = 1; i <= 18; i++) {
                const holeResult = skinsResults.holeResults[i];
                if (holeResult?.winner === player.id) holesWonCount++;
            }
        }

        // Stableford Points row (if selected)
        if (this.scoringFormats.includes('stableford') || this.scoringFormats.includes('modifiedstableford')) {
            const isModified = this.scoringFormats.includes('modifiedstableford');
            const rowLabel = isModified ? 'Modified Points' : 'Stableford Points';
            tableHTML += `<tr class="bg-green-50"><td class="border border-gray-300 px-2 py-2 font-semibold">${rowLabel}</td>`;
            // Reset points (already declared above)
            frontNinePoints = 0;
            backNinePoints = 0;

            const pointsMap = isModified ? engine.modifiedStablefordPoints : engine.defaultStableford;

            for (let i = 1; i <= 18; i++) {
                const scoreValue = this.scoresCache[player.id]?.[i];
                let points = '-';

                if (typeof scoreValue === 'number') {
                    const hole = this.courseData?.holes?.find(h => h.number === i);
                    const par = hole?.par || 4;
                    const strokeIndex = hole?.strokeIndex || i;

                    const shotsReceived = player.handicap >= strokeIndex ? 1 : 0;
                    const netScore = scoreValue - shotsReceived;
                    points = engine.stablefordPointsForHole(netScore, par, pointsMap);

                    if (i <= 9) frontNinePoints += points;
                    else backNinePoints += points;
                }

                tableHTML += `<td class="border border-gray-300 px-1 py-2 text-center font-bold">${points}</td>`;
            }
            const totalPoints = frontNinePoints + backNinePoints;
            tableHTML += `<td class="border border-gray-300 px-2 py-2 text-center font-bold text-lg bg-green-200">${totalPoints || '-'}</td></tr>`;
        }

        // Nassau row (if selected)
        if (this.scoringFormats.includes('nassau')) {
            tableHTML += `<tr class="bg-blue-50"><td class="border border-gray-300 px-2 py-2 font-semibold">Nassau Net</td>`;

            for (let i = 1; i <= 18; i++) {
                const scoreValue = this.scoresCache[player.id]?.[i];
                let netScore = '-';

                if (typeof scoreValue === 'number') {
                    const hole = this.courseData?.holes?.find(h => h.number === i);
                    const strokeIndex = hole?.strokeIndex || i;

                    const shotsReceived = player.handicap >= strokeIndex ? 1 : 0;
                    netScore = scoreValue - shotsReceived;
                }

                tableHTML += `<td class="border border-gray-300 px-1 py-2 text-center font-bold">${netScore}</td>`;
            }
            tableHTML += `<td class="border border-gray-300 px-2 py-2 text-center font-bold text-lg bg-blue-200">${totalNet || '-'}</td></tr>`;

            // Nassau Summary Row
            tableHTML += `<tr class="bg-blue-100"><td class="border border-gray-300 px-2 py-2 font-semibold text-sm">Nassau Score</td>`;
            tableHTML += `<td colspan="9" class="border border-gray-300 px-2 py-2 text-center font-bold text-blue-800">Front 9: ${frontNineNet || '-'}</td>`;
            tableHTML += `<td colspan="9" class="border border-gray-300 px-2 py-2 text-center font-bold text-blue-800">Back 9: ${backNineNet || '-'}</td>`;
            tableHTML += `<td class="border border-gray-300 px-2 py-2 text-center font-bold text-lg bg-blue-200">Total: ${totalNet || '-'}</td></tr>`;
        }

        // Skins row (if selected)
        if (this.scoringFormats.includes('skins') && skinsResults) {
            tableHTML += `<tr class="bg-orange-50"><td class="border border-gray-300 px-2 py-2 font-semibold">Skins Won</td>`;

            for (let i = 1; i <= 18; i++) {
                const holeResult = skinsResults.holeResults[i];
                const wonThisHole = holeResult?.winner === player.id;

                const cellContent = wonThisHole ? '✓' : '-';
                const cellClass = wonThisHole
                    ? 'border border-gray-300 px-1 py-2 text-center font-bold bg-orange-200 text-orange-800'
                    : 'border border-gray-300 px-1 py-2 text-center';

                tableHTML += `<td class="${cellClass}">${cellContent}</td>`;
            }

            tableHTML += `<td class="border border-gray-300 px-2 py-2 text-center font-bold text-lg bg-orange-200">${holesWonCount} holes</td></tr>`;
        }

        // Scramble tracking rows (if selected)
        if (this.scoringFormats.includes('scramble')) {
            let playerDriveCount = 0;
            let playerPuttCount = 0;

            // Drive row (only if tracking drives)
            if (this.scrambleConfig?.trackDrives && this.scrambleDriveData) {
                tableHTML += `<tr class="bg-green-50"><td class="border border-gray-300 px-2 py-2 font-semibold text-xs">Drive Used</td>`;

                for (let i = 1; i <= 18; i++) {
                    const driveData = this.scrambleDriveData[i];
                    const isThisPlayer = driveData?.player_id === player.id;

                    if (isThisPlayer) playerDriveCount++;

                    // Show first initial or checkmark
                    const cellContent = driveData ?
                        (isThisPlayer ? '✓' : driveData.player_name.charAt(0)) : '-';

                    const cellClass = isThisPlayer
                        ? 'border border-gray-300 px-1 py-2 text-center font-bold bg-green-200 text-green-800'
                        : 'border border-gray-300 px-1 py-2 text-center text-xs text-gray-600';

                    tableHTML += `<td class="${cellClass}">${cellContent}</td>`;
                }

                tableHTML += `<td class="border border-gray-300 px-2 py-2 text-center font-bold bg-green-200">${playerDriveCount}x</td></tr>`;
            }

            // Putt row (only if tracking putts)
            if (this.scrambleConfig?.trackPutts && this.scramblePuttData) {
                tableHTML += `<tr class="bg-green-50"><td class="border border-gray-300 px-2 py-2 font-semibold text-xs">Putt Used</td>`;

                for (let i = 1; i <= 18; i++) {
                    const puttData = this.scramblePuttData[i];
                    const isThisPlayer = puttData?.player_id === player.id;

                    if (isThisPlayer) playerPuttCount++;

                    // Show first initial or checkmark
                    const cellContent = puttData ?
                        (isThisPlayer ? '✓' : puttData.player_name.charAt(0)) : '-';

                    const cellClass = isThisPlayer
                        ? 'border border-gray-300 px-1 py-2 text-center font-bold bg-green-200 text-green-800'
                        : 'border border-gray-300 px-1 py-2 text-center text-xs text-gray-600';

                    tableHTML += `<td class="${cellClass}">${cellContent}</td>`;
                }

                tableHTML += `<td class="border border-gray-300 px-2 py-2 text-center font-bold bg-green-200">${playerPuttCount}x</td></tr>`;
            }

            // Store counts for summary use
            player._scrambleDriveCount = playerDriveCount;
            player._scramblePuttCount = playerPuttCount;
        }

        tableHTML += `</thead></table>`;
        table.innerHTML = tableHTML;
        container.appendChild(table);

        // Summary - Use the CORRECTLY calculated frontNinePoints/backNinePoints from above
        const summary = document.createElement('div');
        summary.className = 'mt-4 grid grid-cols-2 md:grid-cols-4 gap-3 text-sm';
        // FIX: Don't call getPlayerTotal() - it's calculating wrong! Use the values we already calculated above
        summary.innerHTML = `
            <div class="bg-blue-50 p-2 rounded">
                <div class="text-xs text-gray-600">Front 9 (Stroke)</div>
                <div class="font-bold">${frontNineGross || '-'}</div>
                ${(this.scoringFormats.includes('stableford') || this.scoringFormats.includes('modifiedstableford')) && frontNinePoints !== undefined ? `
                    <div class="text-xs text-green-700 mt-1">${frontNinePoints} pts</div>
                ` : ''}
            </div>
            <div class="bg-blue-50 p-2 rounded">
                <div class="text-xs text-gray-600">Back 9 (Stroke)</div>
                <div class="font-bold">${backNineGross || '-'}</div>
                ${(this.scoringFormats.includes('stableford') || this.scoringFormats.includes('modifiedstableford')) && backNinePoints !== undefined ? `
                    <div class="text-xs text-green-700 mt-1">${backNinePoints} pts</div>
                ` : ''}
            </div>
            <div class="bg-green-100 p-2 rounded">
                <div class="text-xs text-gray-600">Total Gross</div>
                <div class="font-bold text-lg">${totalGross || '-'}</div>
            </div>
            ${(this.scoringFormats.includes('stableford') || this.scoringFormats.includes('modifiedstableford')) ? `
                <div class="bg-green-200 p-2 rounded">
                    <div class="text-xs text-gray-600">Total Points</div>
                    <div class="font-bold text-lg">${frontNinePoints + backNinePoints}</div>
                </div>
            ` : ''}
            ${this.scoringFormats.includes('nassau') ? `
                <div class="bg-blue-200 p-2 rounded">
                    <div class="text-xs text-gray-600">Nassau Net Total</div>
                    <div class="font-bold text-lg">${totalNet || '-'}</div>
                </div>
                <div class="bg-blue-100 p-2 rounded">
                    <div class="text-xs text-gray-600">Nassau Front 9</div>
                    <div class="font-bold">${frontNineNet || '-'}</div>
                </div>
                <div class="bg-blue-100 p-2 rounded">
                    <div class="text-xs text-gray-600">Nassau Back 9</div>
                    <div class="font-bold">${backNineNet || '-'}</div>
                </div>
            ` : ''}
            ${this.scoringFormats.includes('skins') ? `
                <div class="bg-orange-200 p-2 rounded">
                    <div class="text-xs text-gray-600">Skins Won</div>
                    <div class="font-bold text-lg">${holesWonCount} holes</div>
                </div>
            ` : ''}
            ${this.scoringFormats.includes('scramble') && this.scrambleConfig?.trackDrives ? `
                <div class="bg-green-200 p-2 rounded">
                    <div class="text-xs text-gray-600">Drives Used</div>
                    <div class="font-bold text-lg">${player._scrambleDriveCount || 0}x</div>
                </div>
            ` : ''}
            ${this.scoringFormats.includes('scramble') && this.scrambleConfig?.trackPutts ? `
                <div class="bg-green-200 p-2 rounded">
                    <div class="text-xs text-gray-600">Putts Used</div>
                    <div class="font-bold text-lg">${player._scramblePuttCount || 0}x</div>
                </div>
            ` : ''}
        `;
        container.appendChild(summary);

        return container;
    }

    renderTeamScrambleScorecard() {
        const container = document.createElement('div');
        container.className = 'border-4 border-green-600 rounded-lg p-4 mb-6 bg-gradient-to-br from-green-50 to-green-100 shadow-lg print:break-inside-avoid print:shadow-none';

        // Calculate team handicap based on selected method
        const method = document.querySelector('input[name="scrambleHcpMethod"]:checked')?.value || 'usga';
        const teamSize = this.players.length;
        // CRITICAL FIX: Convert handicaps to numbers to avoid string concatenation bug
        const handicaps = this.players.map(p => parseFloat(p.handicap) || 0);
        const sortedHandicaps = [...handicaps].sort((a, b) => a - b);
        let teamHandicap = 0;

        console.log('[Team Scorecard] Players handicaps:', this.players.map(p => `${p.name}=${p.handicap}`));
        console.log('[Team Scorecard] Handicaps as numbers:', handicaps);
        console.log('[Team Scorecard] Sorted:', sortedHandicaps);

        if (method === 'usga') {
            // USGA Standard formulas
            if (teamSize === 2) {
                teamHandicap = (sortedHandicaps[0] * 0.35) + (sortedHandicaps[1] * 0.15);
            } else if (teamSize === 3) {
                teamHandicap = (sortedHandicaps[0] * 0.30) + (sortedHandicaps[1] * 0.20) + (sortedHandicaps[2] * 0.10);
            } else if (teamSize === 4) {
                teamHandicap = (sortedHandicaps[0] * 0.25) + (sortedHandicaps[1] * 0.20) + (sortedHandicaps[2] * 0.15) + (sortedHandicaps[3] * 0.10);
            } else {
                const avgHandicap = sortedHandicaps.reduce((sum, h) => sum + h, 0) / sortedHandicaps.length;
                teamHandicap = avgHandicap * 0.20;
            }
        } else if (method === 'percentage') {
            // Percentage REDUCTION of average handicap
            const percent = parseFloat(document.getElementById('scrambleHcpPercent')?.value) || 25;
            const avgHcp = handicaps.reduce((sum, h) => sum + h, 0) / handicaps.length;
            teamHandicap = avgHcp * (100 - percent) / 100;
        } else if (method === 'manual') {
            // Manual entry
            teamHandicap = parseFloat(document.getElementById('scrambleHcpManualValue')?.value) || 0;
        }

        const teamPlayingHandicap = Math.round(teamHandicap);

        // Team header
        const header = document.createElement('div');
        header.className = 'mb-4 pb-3 border-b-2 border-green-400';
        header.innerHTML = `
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-2xl font-bold text-green-900">🏆 SCRAMBLE TEAM SCORE</h3>
                    <p class="text-sm text-green-800 mt-1">Best Ball • ${this.players.length} Players: ${this.players.map(p => p.name).join(', ')}</p>
                    <p class="text-xs text-green-700 mt-1">Team Handicap: ${teamHandicap.toFixed(1)} (Playing: ${teamPlayingHandicap})</p>
                </div>
                <div class="text-right" id="teamTotal"></div>
            </div>
        `;
        container.appendChild(header);

        // Calculate team scores (best score per hole)
        const teamScores = {}; // hole -> best gross score
        const teamStablefordPoints = {}; // hole -> stableford points

        for (let holeNum = 1; holeNum <= 18; holeNum++) {
            let bestScore = null;

            // Find best (lowest) score for this hole across all players
            for (const player of this.players) {
                const score = this.scoresCache[player.id]?.[holeNum];
                if (typeof score === 'number') {
                    if (bestScore === null || score < bestScore) {
                        bestScore = score;
                    }
                }
            }

            teamScores[holeNum] = bestScore;

            // Calculate Stableford points for team's best score WITH handicap
            if (bestScore !== null) {
                const hole = this.courseData?.holes?.find(h => h.number === holeNum);
                const par = hole?.par || 4;
                const strokeIndex = hole?.strokeIndex || holeNum;

                // Calculate handicap strokes for this hole
                const fullStrokes = Math.floor(teamPlayingHandicap / 18);
                const remainingStrokes = teamPlayingHandicap % 18;
                let strokesReceived = fullStrokes;
                if (strokeIndex <= remainingStrokes) {
                    strokesReceived += 1;
                }

                // Calculate net score
                const netScore = bestScore - strokesReceived;
                const diff = netScore - par;

                // Thailand Stableford points based on NET score
                let points = 0;
                if (diff <= -2) points = 4;      // Eagle or better
                else if (diff === -1) points = 3; // Birdie
                else if (diff === 0) points = 2;  // Par
                else if (diff === 1) points = 1;  // Bogey
                else points = 0;                  // Double bogey+ (block)

                teamStablefordPoints[holeNum] = points;
            }
        }

        // Scorecard table
        const table = document.createElement('div');
        table.className = 'overflow-x-auto';

        let tableHTML = `
            <table class="w-full text-xs md:text-sm border-collapse">
                <thead>
                    <tr class="bg-green-100">
                        <th class="border border-green-400 px-2 py-2 text-center font-bold">Hole</th>
        `;

        // Hole numbers
        for (let i = 1; i <= 18; i++) {
            tableHTML += `<th class="border border-green-400 px-1 py-2 text-center font-bold">${i}</th>`;
        }
        tableHTML += `<th class="border border-green-400 px-2 py-2 text-center font-bold bg-yellow-100">Total</th></tr>`;

        // Par row
        tableHTML += `<tr class="bg-green-50"><td class="border border-green-400 px-2 py-2 font-semibold">Par</td>`;
        let frontNinePar = 0, backNinePar = 0;
        for (let i = 1; i <= 18; i++) {
            const hole = this.courseData?.holes?.find(h => h.number === i);
            const par = hole?.par || 4;
            if (i <= 9) frontNinePar += par;
            else backNinePar += par;
            tableHTML += `<td class="border border-green-400 px-1 py-2 text-center">${par}</td>`;
        }
        tableHTML += `<td class="border border-green-400 px-2 py-2 text-center font-bold bg-yellow-100">${frontNinePar + backNinePar}</td></tr>`;

        // Team Best Score row
        tableHTML += `<tr class="bg-white"><td class="border border-green-400 px-2 py-2 font-semibold">Team Score</td>`;
        let frontNineGross = 0, backNineGross = 0;
        for (let i = 1; i <= 18; i++) {
            const score = teamScores[i];

            if (score !== null && score !== undefined) {
                if (i <= 9) frontNineGross += score;
                else backNineGross += score;
            }

            // Style score with circles/squares based on par
            const hole = this.courseData?.holes?.find(h => h.number === i);
            const par = hole?.par || 4;
            let cellClass = 'border border-green-400 px-1 py-2 text-center font-bold';
            let scoreHTML = (score !== null && score !== undefined) ? score : '-';

            if (score !== null && score !== undefined) {
                const diff = score - par;
                if (diff <= -2) {
                    // Eagle or better: Double blue circle
                    scoreHTML = `<span style="display: inline-block; width: 28px; height: 28px; line-height: 28px; border: 2px solid #2563eb; border-radius: 50%; box-shadow: 0 0 0 4px white, 0 0 0 6px #2563eb; color: #2563eb; font-weight: bold;">${score}</span>`;
                } else if (diff === -1) {
                    // Birdie: Blue circle
                    scoreHTML = `<span style="display: inline-block; width: 28px; height: 28px; line-height: 28px; border: 2px solid #2563eb; border-radius: 50%; color: #2563eb; font-weight: bold;">${score}</span>`;
                } else if (diff === 0) {
                    // Par: No decoration
                    scoreHTML = score;
                } else if (diff === 1) {
                    // Bogey: Red square
                    scoreHTML = `<span style="display: inline-block; width: 28px; height: 28px; line-height: 28px; border: 2px solid #dc2626; color: #dc2626; font-weight: bold;">${score}</span>`;
                } else if (diff >= 2) {
                    // Double bogey+: Red double square
                    scoreHTML = `<span style="display: inline-block; width: 28px; height: 28px; line-height: 28px; border: 2px solid #dc2626; box-shadow: 0 0 0 4px white, 0 0 0 6px #dc2626; color: #dc2626; font-weight: bold;">${score}</span>`;
                }
            }
            tableHTML += `<td class="${cellClass}">${scoreHTML}</td>`;
        }
        const totalGross = frontNineGross + backNineGross;
        tableHTML += `<td class="border border-green-400 px-2 py-2 text-center font-bold text-lg bg-yellow-100">${totalGross || '-'}</td></tr>`;

        // Team Net Score row (with handicap)
        tableHTML += `<tr class="bg-green-50"><td class="border border-green-400 px-2 py-2 font-semibold">Team Net</td>`;
        let frontNineNet = 0, backNineNet = 0;
        for (let i = 1; i <= 18; i++) {
            const score = teamScores[i];
            let netScore = '-';

            if (score !== null && score !== undefined) {
                const hole = this.courseData?.holes?.find(h => h.number === i);
                const strokeIndex = hole?.strokeIndex || i;

                // Calculate handicap strokes for this hole
                const fullStrokes = Math.floor(teamPlayingHandicap / 18);
                const remainingStrokes = teamPlayingHandicap % 18;
                let strokesReceived = fullStrokes;
                if (strokeIndex <= remainingStrokes) {
                    strokesReceived += 1;
                }

                netScore = score - strokesReceived;
                if (i <= 9) frontNineNet += netScore;
                else backNineNet += netScore;
            }

            tableHTML += `<td class="border border-green-400 px-1 py-2 text-center font-semibold text-green-700">${netScore !== '-' ? netScore : '-'}</td>`;
        }
        const totalNet = frontNineNet + backNineNet;
        tableHTML += `<td class="border border-green-400 px-2 py-2 text-center font-bold text-lg bg-green-200">${totalNet || '-'}</td></tr>`;

        // Team Stableford Points row
        if (this.scoringFormats.includes('stableford') || this.scoringFormats.includes('modifiedstableford')) {
            tableHTML += `<tr class="bg-green-50"><td class="border border-green-400 px-2 py-2 font-semibold">Team Points</td>`;
            let frontNinePoints = 0, backNinePoints = 0;

            for (let i = 1; i <= 18; i++) {
                const points = teamStablefordPoints[i];

                if (points !== null && points !== undefined) {
                    if (i <= 9) frontNinePoints += points;
                    else backNinePoints += points;
                }

                tableHTML += `<td class="border border-green-400 px-1 py-2 text-center font-bold">${points !== null && points !== undefined ? points : '-'}</td>`;
            }
            const totalPoints = frontNinePoints + backNinePoints;
            tableHTML += `<td class="border border-green-400 px-2 py-2 text-center font-bold text-lg bg-green-200">${totalPoints || '-'}</td></tr>`;
        }

        // Drive Used row (show player initials)
        if (this.scrambleConfig?.trackDrives && this.scrambleDriveData) {
            tableHTML += `<tr class="bg-green-50"><td class="border border-green-400 px-2 py-2 font-semibold text-xs">Drive Used</td>`;

            for (let i = 1; i <= 18; i++) {
                const driveData = this.scrambleDriveData[i];
                const cellContent = driveData ? driveData.player_name.charAt(0) : '-';
                tableHTML += `<td class="border border-green-400 px-1 py-2 text-center text-sm font-semibold text-green-700">${cellContent}</td>`;
            }

            tableHTML += `<td class="border border-green-400 px-2 py-2"></td></tr>`;
        }

        // Putt Used row (show player initials)
        if (this.scrambleConfig?.trackPutts && this.scramblePuttData) {
            tableHTML += `<tr class="bg-green-50"><td class="border border-green-400 px-2 py-2 font-semibold text-xs">Putt Used</td>`;

            for (let i = 1; i <= 18; i++) {
                const puttData = this.scramblePuttData[i];
                const cellContent = puttData ? puttData.player_name.charAt(0) : '-';
                tableHTML += `<td class="border border-green-400 px-1 py-2 text-center text-sm font-semibold text-green-700">${cellContent}</td>`;
            }

            tableHTML += `<td class="border border-green-400 px-2 py-2"></td></tr>`;
        }

        tableHTML += `</thead></table>`;
        table.innerHTML = tableHTML;
        container.appendChild(table);

        // Team Summary
        const summary = document.createElement('div');
        summary.className = 'mt-4 grid grid-cols-2 md:grid-cols-4 gap-3 text-sm';

        let summaryHTML = `
            <div class="bg-green-50 p-3 rounded border border-green-300">
                <div class="text-xs text-gray-600">Front 9 Gross</div>
                <div class="font-bold text-lg">${frontNineGross || '-'}</div>
            </div>
            <div class="bg-green-50 p-3 rounded border border-green-300">
                <div class="text-xs text-gray-600">Back 9 Gross</div>
                <div class="font-bold text-lg">${backNineGross || '-'}</div>
            </div>
            <div class="bg-green-100 p-3 rounded border border-green-300">
                <div class="text-xs text-gray-600">Total Gross</div>
                <div class="font-bold text-2xl text-green-800">${totalGross || '-'}</div>
            </div>
            <div class="bg-green-200 p-3 rounded border border-green-500">
                <div class="text-xs text-gray-600">Total Net (HCP ${teamPlayingHandicap})</div>
                <div class="font-bold text-2xl text-green-900">${totalNet || '-'}</div>
            </div>
        `;

        if (this.scoringFormats.includes('stableford') || this.scoringFormats.includes('modifiedstableford')) {
            let totalPoints = 0;
            for (let i = 1; i <= 18; i++) {
                if (teamStablefordPoints[i]) totalPoints += teamStablefordPoints[i];
            }
            summaryHTML += `
                <div class="bg-green-200 p-3 rounded border border-green-400">
                    <div class="text-xs text-gray-600">Total Points</div>
                    <div class="font-bold text-2xl text-green-900">${totalPoints}</div>
                </div>
            `;
        }

        summary.innerHTML = summaryHTML;
        container.appendChild(summary);

        return container;
    }

    closeFinalizedScorecard() {
        document.getElementById('finalizedScorecardModal').classList.add('hidden');
        this.actuallyEndRound();
    }

    printScorecard() {
        window.print();
    }

    shareScorecard() {
        // TODO: Implement LINE sharing
        const text = `⛳ Golf Scorecard\n${document.getElementById('finalScorecard_eventName').textContent}\n${document.getElementById('finalScorecard_course').textContent}`;

        if (navigator.share) {
            navigator.share({
                title: 'Golf Scorecard',
                text: text
            }).catch(err => console.log('Share failed:', err));
        } else {
            NotificationManager.show('Sharing not supported on this device', 'info');
        }
    }

    downloadScorecardPDF() {
        // TODO: Implement PDF download using html2pdf or similar
        NotificationManager.show('PDF download coming soon!', 'info');
    }

    async deletePrivateRound() {
        if (!this.isPrivateRound) {
            NotificationManager.show('Only private rounds can be deleted', 'error');
            return;
        }

        // NO POPUPS: Just execute the command directly as user requested
        // Removed: confirm('Delete this private round?')

        try {
            console.log('[LiveScorecard] Deleting private round for all players...');

            // Delete all scorecards and their associated scores
            for (const player of this.players) {
                const scorecardId = this.scorecards[player.id];

                if (scorecardId && !scorecardId.startsWith('local_')) {
                    // Delete from database
                    // First delete all scores (cascade should handle this, but being explicit)
                    await window.SupabaseDB.client
                        .from('scores')
                        .delete()
                        .eq('scorecard_id', scorecardId);

                    // Then delete the scorecard
                    await window.SupabaseDB.client
                        .from('scorecards')
                        .delete()
                        .eq('id', scorecardId);

                    console.log(`[LiveScorecard] Deleted scorecard for ${player.name}: ${scorecardId}`);
                } else if (scorecardId && scorecardId.startsWith('local_')) {
                    // Delete from localStorage
                    localStorage.removeItem(`scorecard_${scorecardId}`);
                    localStorage.removeItem(`scores_${scorecardId}`);
                    console.log(`[LiveScorecard] Deleted local scorecard for ${player.name}`);
                }
            }

            NotificationManager.show('Private round deleted successfully', 'success');

            // Close modal and reset
            document.getElementById('finalizedScorecardModal').classList.add('hidden');
            this.actuallyEndRound();

        } catch (error) {
            console.error('[LiveScorecard] Error deleting private round:', error);
            NotificationManager.show('Error deleting round. Please try again.', 'error');
        }
    }

    // ===== LINE EXPORT FEATURE =====

    showLINEExportModal() {
        console.log('[LiveScorecard] Opening LINE export modal');

        // Generate message preview
        this.updateLINEMessagePreview();

        // Try to load LINE friends if LIFF is available
        this.loadLINEFriends();

        // Show the modal
        document.getElementById('lineExportModal').classList.remove('hidden');
    }

    closeLINEExportModal() {
        document.getElementById('lineExportModal').classList.add('hidden');
        // Reset status
        document.getElementById('lineExportStatus').classList.add('hidden');
    }

    updateLINEMessagePreview() {
        const includeAllPlayers = document.getElementById('includeAllPlayers')?.checked ?? true;
        const includeDetailedStats = document.getElementById('includeDetailedStats')?.checked ?? true;

        const message = this.formatScorecardForLINE(includeAllPlayers, includeDetailedStats);
        document.getElementById('lineMessagePreview').textContent = message;
    }

    formatScorecardForLINE(includeAllPlayers = true, includeDetailedStats = true) {
        // Get scorecard header information
        const eventName = document.getElementById('finalScorecard_eventName')?.textContent || 'Golf Round';
        const societyName = document.getElementById('finalScorecard_societyName')?.textContent || '';
        const courseName = document.getElementById('finalScorecard_course')?.textContent || 'Unknown Course';
        const teeMarker = document.getElementById('finalScorecard_teeMarker')?.textContent || 'WHITE';
        const format = document.getElementById('finalScorecard_format')?.textContent || '';
        const date = document.getElementById('finalScorecard_date')?.textContent || new Date().toLocaleDateString();

        let message = '';
        message += '⛳ GOLF SCORECARD\n';
        message += '═══════════════════════════\n\n';

        if (societyName && societyName !== 'Practice Round') {
            message += `🏆 ${societyName}\n`;
        }
        message += `📍 ${eventName}\n`;
        message += `🏌️ ${courseName} (${teeMarker})\n`;
        if (format) {
            message += `📊 ${format}\n`;
        }
        message += `📅 ${date}\n`;
        message += '\n';

        // Add player scorecards
        const playersToInclude = includeAllPlayers ? this.players : [this.players[0]];

        playersToInclude.forEach((player, index) => {
            if (index > 0) message += '\n───────────────────────────\n\n';

            message += `👤 ${player.name} (HCP: ${player.handicap})\n`;
            message += '─────────────────────────\n';

            // Calculate scores
            let frontNineGross = 0, backNineGross = 0;
            let frontNineNet = 0, backNineNet = 0;
            let frontNinePoints = 0, backNinePoints = 0;
            let totalGross = 0, totalNet = 0, totalPoints = 0;

            const engine = LiveScorecardSystem.GolfScoringEngine;
            const isStableford = this.scoringFormats.includes('stableford');
            const isModified = this.scoringFormats.includes('modifiedstableford');
            const isNassau = this.scoringFormats.includes('nassau');
            const pointsMap = isModified ? engine.modifiedStablefordPoints : engine.defaultStableford;

            // Calculate totals
            for (let i = 1; i <= 18; i++) {
                const scoreValue = this.scoresCache[player.id]?.[i];
                if (typeof scoreValue === 'number') {
                    const hole = this.courseData?.holes?.find(h => h.number === i);
                    const par = hole?.par || 4;
                    const strokeIndex = hole?.strokeIndex || i;
                    const shotsReceived = player.handicap >= strokeIndex ? 1 : 0;
                    const netScore = scoreValue - shotsReceived;

                    if (i <= 9) {
                        frontNineGross += scoreValue;
                        frontNineNet += netScore;
                    } else {
                        backNineGross += scoreValue;
                        backNineNet += netScore;
                    }

                    // Calculate points if stableford
                    if (isStableford || isModified) {
                        const points = engine.stablefordPointsForHole(netScore, par, pointsMap);
                        if (i <= 9) frontNinePoints += points;
                        else backNinePoints += points;
                    }
                }
            }

            totalGross = frontNineGross + backNineGross;
            totalNet = frontNineNet + backNineNet;
            totalPoints = frontNinePoints + backNinePoints;

            // Display summary
            message += `Gross: ${totalGross}`;
            if (isStableford || isModified) {
                message += ` | Points: ${totalPoints}`;
            }
            if (isNassau) {
                message += ` | Net: ${totalNet}`;
            }
            message += '\n';

            // Detailed hole-by-hole if requested
            if (includeDetailedStats) {
                message += '\nHole-by-Hole:\n';

                // Front 9
                message += 'OUT: ';
                for (let i = 1; i <= 9; i++) {
                    const scoreValue = this.scoresCache[player.id]?.[i];
                    if (typeof scoreValue === 'number') {
                        const hole = this.courseData?.holes?.find(h => h.number === i);
                        const par = hole?.par || 4;
                        const diff = scoreValue - par;
                        let indicator = '';
                        if (diff <= -2) indicator = '🦅'; // Eagle
                        else if (diff === -1) indicator = '🐦'; // Birdie
                        else if (diff === 1) indicator = '⬜'; // Bogey
                        else if (diff >= 2) indicator = '❌'; // Double+

                        message += `${scoreValue}${indicator} `;
                    } else {
                        message += '- ';
                    }
                }
                message += `= ${frontNineGross}\n`;

                // Back 9
                message += 'IN:  ';
                for (let i = 10; i <= 18; i++) {
                    const scoreValue = this.scoresCache[player.id]?.[i];
                    if (typeof scoreValue === 'number') {
                        const hole = this.courseData?.holes?.find(h => h.number === i);
                        const par = hole?.par || 4;
                        const diff = scoreValue - par;
                        let indicator = '';
                        if (diff <= -2) indicator = '🦅';
                        else if (diff === -1) indicator = '🐦';
                        else if (diff === 1) indicator = '⬜';
                        else if (diff >= 2) indicator = '❌';

                        message += `${scoreValue}${indicator} `;
                    } else {
                        message += '- ';
                    }
                }
                message += `= ${backNineGross}\n`;

                // Points breakdown if stableford
                if (isStableford || isModified) {
                    message += `Points: F9=${frontNinePoints} B9=${backNinePoints} TOT=${totalPoints}\n`;
                }
            }
        });

        message += '\n═══════════════════════════\n';
        message += '📱 Powered by MyCaddiPro\n';

        return message;
    }

    async loadLINEFriends() {
        const friendsSelect = document.getElementById('lineFriendsSelect');

        try {
            // Check if LIFF is available and initialized
            if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                // Note: Getting friends list requires special permission from LINE
                // This is a placeholder - actual implementation depends on LINE API permissions
                friendsSelect.innerHTML = '<option value="">Select a friend...</option>';
                friendsSelect.innerHTML += '<option value="" disabled>Friends list requires LIFF permission</option>';

                console.log('[LiveScorecard] LIFF friends list requires additional permissions');
            } else {
                friendsSelect.innerHTML = '<option value="">LIFF not initialized</option>';
            }
        } catch (error) {
            console.error('[LiveScorecard] Error loading LINE friends:', error);
            friendsSelect.innerHTML = '<option value="">Error loading friends</option>';
        }
    }

    async sendScorecardToLINE() {
        console.log('[LiveScorecard] Sending scorecard to LINE...');

        const statusDiv = document.getElementById('lineExportStatus');
        const statusContent = document.getElementById('lineExportStatusContent');

        try {
            // Get recipient
            const recipientType = document.querySelector('input[name="recipientType"]:checked')?.value;
            let recipientUserId = '';

            if (recipientType === 'manual') {
                recipientUserId = document.getElementById('lineUserIdInput')?.value?.trim();
            } else if (recipientType === 'friends') {
                recipientUserId = document.getElementById('lineFriendsSelect')?.value;
            }

            if (!recipientUserId) {
                statusDiv.classList.remove('hidden');
                statusContent.className = 'p-3 rounded-lg bg-red-50 border border-red-300 text-red-800';
                statusContent.textContent = '❌ Please enter a LINE User ID or select a recipient';
                return;
            }

            // Validate LINE User ID format (starts with U and 33 characters total)
            if (!recipientUserId.startsWith('U') || recipientUserId.length !== 33) {
                statusDiv.classList.remove('hidden');
                statusContent.className = 'p-3 rounded-lg bg-red-50 border border-red-300 text-red-800';
                statusContent.textContent = '❌ Invalid LINE User ID format (should be U followed by 32 characters)';
                return;
            }

            // Get options
            const includeAllPlayers = document.getElementById('includeAllPlayers')?.checked ?? true;
            const includeDetailedStats = document.getElementById('includeDetailedStats')?.checked ?? true;

            // Format message
            const message = this.formatScorecardForLINE(includeAllPlayers, includeDetailedStats);

            // Show loading state
            statusDiv.classList.remove('hidden');
            statusContent.className = 'p-3 rounded-lg bg-blue-50 border border-blue-300 text-blue-800';
            statusContent.textContent = '⏳ Sending scorecard to LINE...';

            // Call Supabase Edge Function to send LINE message
            const response = await window.SupabaseDB.client.functions.invoke('send-line-scorecard', {
                body: {
                    recipientUserId: recipientUserId,
                    message: message
                }
            });

            if (response.error) {
                throw new Error(response.error.message || 'Failed to send message');
            }

            // Success
            statusContent.className = 'p-3 rounded-lg bg-green-50 border border-green-300 text-green-800';
            statusContent.textContent = '✅ Scorecard sent successfully to LINE!';

            NotificationManager.show('Scorecard sent to LINE successfully!', 'success');

            // Close modal after 2 seconds
            setTimeout(() => {
                this.closeLINEExportModal();
            }, 2000);

        } catch (error) {
            console.error('[LiveScorecard] Error sending scorecard to LINE:', error);

            statusDiv.classList.remove('hidden');
            statusContent.className = 'p-3 rounded-lg bg-red-50 border border-red-300 text-red-800';
            statusContent.textContent = `❌ Error: ${error.message}`;

            NotificationManager.show('Failed to send scorecard to LINE', 'error');
        }
    }

    // ===== END LINE EXPORT FEATURE =====

    async syncOfflineData() {
        console.log('[LiveScorecard] 🔄 Checking for offline data to sync...');

        try {
            // Find all pending offline scorecards
            const pendingScorecards = [];
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('scorecard_local_')) {
                    const scorecardData = JSON.parse(localStorage.getItem(key));

                    // Check if scorecard is too old (>7 days) and remove it
                    if (scorecardData.created_at) {
                        const createdDate = new Date(scorecardData.created_at);
                        if (createdDate < sevenDaysAgo) {
                            console.warn(`[LiveScorecard] 🗑️ Removing stale scorecard (>7 days old): ${scorecardData.player_name || 'Unknown'}`);
                            localStorage.removeItem(key);
                            const scoresKey = `scores_${scorecardData.id}`;
                            localStorage.removeItem(scoresKey);
                            continue; // Skip this scorecard
                        }
                    }

                    if (scorecardData.pending_sync) {
                        pendingScorecards.push({ key, data: scorecardData });
                    }
                }
            }

            if (pendingScorecards.length === 0) {
                console.log('[LiveScorecard] ✅ No offline data to sync');
                return;
            }

            console.log(`[LiveScorecard] 📤 Syncing ${pendingScorecards.length} offline scorecards...`);

            for (const { key, data } of pendingScorecards) {
                try {
                    // Create scorecard in Supabase
                    const scorecard = await window.SocietyGolfDB.createScorecard(
                        data.event_id,
                        data.player_id,
                        data.handicap
                    );

                    // Update with group and course info
                    const { error: updateError } = await window.SupabaseDB.client
                        .from('scorecards')
                        .update({
                            group_id: data.group_id,
                            course_id: data.course_id,
                            course_name: data.course_name,
                            tee_marker: data.tee_marker,
                            player_name: data.player_name,
                            started_at: data.started_at
                        })
                        .eq('id', scorecard.id);

                    if (updateError) {
                        console.error(`[LiveScorecard] ❌ Failed to update scorecard metadata for ${data.player_name}:`, {
                            error: updateError,
                            errorMessage: updateError.message,
                            errorDetails: updateError.details,
                            errorHint: updateError.hint,
                            errorCode: updateError.code,
                            tableName: 'scorecards',
                            attemptedOperation: 'UPDATE',
                            payloadSent: {
                                group_id: data.group_id,
                                course_id: data.course_id,
                                course_name: data.course_name,
                                tee_marker: data.tee_marker,
                                player_name: data.player_name,
                                started_at: data.started_at
                            }
                        });

                        // Check if table exists
                        if (updateError.message && updateError.message.includes('relation') && updateError.message.includes('does not exist')) {
                            console.error('[LiveScorecard] 🚨 CRITICAL: "scorecards" table does not exist in database!');
                            console.error('[LiveScorecard] 💡 Solution: Run sql/04_create_scorecards_tables.sql in Supabase');
                        }

                        throw updateError; // This will trigger the catch block and prevent cleanup
                    }

                    // Sync all scores for this scorecard
                    const scoresKey = `scores_${data.id}`;
                    const scoresData = localStorage.getItem(scoresKey);
                    if (scoresData) {
                        const scores = JSON.parse(scoresData);
                        for (const holeNum in scores) {
                            const holeScore = scores[holeNum];
                            await window.SocietyGolfDB.saveScore(
                                scorecard.id,
                                parseInt(holeNum),
                                holeScore.gross_score,
                                holeScore.par,
                                holeScore.stroke_index,
                                holeScore.handicap
                            );
                        }
                        console.log(`[LiveScorecard] ✅ Synced ${Object.keys(scores).length} scores for ${data.player_name}`);
                        localStorage.removeItem(scoresKey); // Clean up scores after successful sync
                    }

                    // Clean up synced scorecard - ONLY if we reach this point (all operations succeeded)
                    localStorage.removeItem(key);
                    console.log(`[LiveScorecard] ✅ Synced and removed local copy: ${data.player_name}`);

                } catch (error) {
                    console.error(`[LiveScorecard] ❌ Failed to sync scorecard ${data.player_name}:`, {
                        error: error,
                        errorMessage: error.message,
                        errorDetails: error.details,
                        errorHint: error.hint,
                        errorCode: error.code,
                        offlineScorecardData: {
                            event_id: data.event_id,
                            player_id: data.player_id,
                            player_name: data.player_name,
                            course_name: data.course_name,
                            started_at: data.started_at
                        },
                        attemptedOperation: 'OFFLINE_SYNC',
                        syncAttempts: data.sync_attempts || 0
                    });

                    // Check if table exists
                    if (error.message && error.message.includes('relation') && error.message.includes('does not exist')) {
                        console.error('[LiveScorecard] 🚨 CRITICAL: Database table does not exist!');
                        console.error('[LiveScorecard] 💡 Solution: Run sql/04_create_scorecards_tables.sql in Supabase');
                    }

                    // Track retry attempts to prevent infinite loop
                    if (!data.sync_attempts) data.sync_attempts = 0;
                    data.sync_attempts++;
                    
                    if (data.sync_attempts >= 3) {
                        // After 3 failed attempts, remove to prevent groundhog day loop
                        console.warn(`[LiveScorecard] 🗑️ Removing ${data.player_name} after 3 failed sync attempts`);
                        localStorage.removeItem(key);
                        const scoresKey = `scores_${data.id}`;
                        localStorage.removeItem(scoresKey);
                    } else {
                        // Update retry count in localStorage
                        localStorage.setItem(key, JSON.stringify(data));
                        console.log(`[LiveScorecard] 🔄 Will retry sync (attempt ${data.sync_attempts}/3)`);
                    }
                }
            }

            NotificationManager.show('📤 Offline data synced to cloud!', 'success');

        } catch (error) {
            console.error('[LiveScorecard] Error during sync:', error);
        }
    }

    // Clean up old/failed offline data on app initialization
    cleanupOldOfflineData() {
        console.log('[LiveScorecard] 🧹 Running cleanup of old offline data...');

        try {
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            let cleanedCount = 0;

            // Create array of keys to avoid modifying localStorage during iteration
            const keysToCheck = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.startsWith('scorecard_local_') || key.startsWith('scores_local_'))) {
                    keysToCheck.push(key);
                }
            }

            for (const key of keysToCheck) {
                try {
                    if (key.startsWith('scorecard_local_')) {
                        const scorecardData = JSON.parse(localStorage.getItem(key));

                        // Remove if no created_at (legacy data) OR if older than 7 days OR if too many retry attempts
                        const shouldRemove =
                            !scorecardData.created_at || // Legacy data without timestamp
                            (scorecardData.created_at && new Date(scorecardData.created_at) < sevenDaysAgo) || // Too old
                            (scorecardData.sync_attempts && scorecardData.sync_attempts >= 3); // Too many failures

                        if (shouldRemove) {
                            console.log(`[LiveScorecard] 🗑️ Cleanup: Removing ${scorecardData.player_name || 'Unknown'} (${!scorecardData.created_at ? 'legacy' : 'stale/failed'})`);
                            localStorage.removeItem(key);
                            const scoresKey = `scores_${scorecardData.id}`;
                            localStorage.removeItem(scoresKey);
                            cleanedCount++;
                        }
                    } else if (key.startsWith('scores_local_')) {
                        // Clean up orphaned scores (scores without matching scorecard)
                        const scorecardId = key.replace('scores_', 'scorecard_');
                        if (!localStorage.getItem(scorecardId)) {
                            console.log(`[LiveScorecard] 🗑️ Cleanup: Removing orphaned scores ${key}`);
                            localStorage.removeItem(key);
                            cleanedCount++;
                        }
                    }
                } catch (e) {
                    // If we can't parse the data, it's corrupt - remove it
                    console.warn(`[LiveScorecard] 🗑️ Cleanup: Removing corrupt data ${key}`);
                    localStorage.removeItem(key);
                    cleanedCount++;
                }
            }

            if (cleanedCount > 0) {
                console.log(`[LiveScorecard] ✅ Cleanup complete: Removed ${cleanedCount} stale/failed items`);
            } else {
                console.log('[LiveScorecard] ✅ Cleanup complete: No stale data found');
            }

        } catch (error) {
            console.error('[LiveScorecard] Error during cleanup:', error);
        }
    }

    async showLeaderboard(view) {
        this.leaderboardView = view;

        // Update tab styles
        ['group', 'competition', 'event', 'other'].forEach(v => {
            const tab = document.getElementById(`leaderboardTab${v.charAt(0).toUpperCase() + v.slice(1)}`);
            if (v === view) {
                tab.classList.add('border-green-500', 'text-green-600');
                tab.classList.remove('border-transparent', 'text-gray-600');
            } else {
                tab.classList.remove('border-green-500', 'text-green-600');
                tab.classList.add('border-transparent', 'text-gray-600');
            }
        });

        await this.refreshLeaderboard();
    }

    async refreshLeaderboard() {
        const content = document.getElementById('leaderboardContent');

        if (this.leaderboardView === 'group') {
            // My Group leaderboard
            const leaderboard = await this.getGroupLeaderboard();
            content.innerHTML = this.renderGroupLeaderboard(leaderboard);
        } else if (this.leaderboardView === 'competition') {
            // Cross-group competition leaderboards
            const competitionData = await this.getCompetitionLeaderboards();
            content.innerHTML = this.renderCompetitionLeaderboards(competitionData);
        } else if (this.leaderboardView === 'event') {
            // This Event leaderboard
            const leaderboard = await this.getEventLeaderboard();
            content.innerHTML = this.renderEventLeaderboard(leaderboard);
        } else {
            // Other Events
            content.innerHTML = this.renderOtherEvents();
        }
    }

    async getGroupLeaderboard() {
        if (!this.groupId) return [];

        // Build leaderboard from LOCAL cache (instant, works offline)
        const engine = LiveScorecardSystem.GolfScoringEngine;

        const leaderboard = this.players.map(player => {
            const playerScores = this.scoresCache[player.id] || {};

            // Convert scores cache to array format for engine
            const scoresArray = Object.entries(playerScores).map(([hole, score]) => ({
                hole_number: parseInt(hole),
                gross_score: score
            }));

            let totalGross = 0;
            let totalStableford = 0;
            let totalModifiedStableford = 0;
            let totalNassau = null;
            let holesPlayed = scoresArray.length;

            // Calculate gross total
            for (const s of scoresArray) {
                totalGross += s.gross_score;
            }

            // Calculate ALL selected formats simultaneously
            if (this.courseData && this.courseData.holes) {
                for (const format of this.scoringFormats) {
                    switch (format) {
                        case 'stableford':
                            // Thailand Stableford with net (default)
                            totalStableford = engine.calculateStablefordTotal(
                                scoresArray,
                                this.courseData.holes,
                                player.handicap,
                                true // useNet
                            );
                            break;

                        case 'modifiedstableford':
                            // Modified Stableford (different point system)
                            totalModifiedStableford = engine.calculateStablefordTotal(
                                scoresArray,
                                this.courseData.holes,
                                player.handicap,
                                true,
                                engine.modifiedStablefordPoints
                            );
                            break;

                        case 'nassau':
                            // Nassau: front 9, back 9, total
                            totalNassau = engine.calculateNassau(scoresArray, this.courseData.holes);
                            break;

                        case 'strokeplay':
                        case 'matchplay':
                        case 'bestball':
                        case 'scramble':
                            // For these formats, gross total is primary
                            // Match play, best ball require comparison with other players
                            // and will be handled separately if needed
                            break;

                        case 'skins':
                            // Skins is calculated across all players, handled below
                            break;
                    }
                }
            }

            return {
                player_id: player.id,
                player_name: player.name,
                handicap: player.handicap,
                holes_played: holesPlayed,
                total_gross: totalGross,
                total_stableford: totalStableford,
                total_modified_stableford: totalModifiedStableford,
                nassau: totalNassau,
                scores: scoresArray
            };
        });

        // Calculate Skins across all players (requires all player data)
        if (this.scoringFormats.includes('skins') && this.courseData && this.courseData.holes) {
            const allPlayerData = this.players.map(player => {
                const playerScores = this.scoresCache[player.id] || {};
                const scoresArray = Object.entries(playerScores).map(([hole, score]) => ({
                    hole_number: parseInt(hole),
                    gross_score: score
                }));

                return {
                    playerId: player.id,
                    playerName: player.name,
                    scores: scoresArray,
                    handicap: player.handicap
                };
            });

            // Get skins value from input (default 100 if not set)
            const pointsPerHole = parseInt(document.getElementById('skinsValueInput')?.value) || 100;
            const skinsResults = engine.calculateSkins(allPlayerData, this.courseData.holes, true, pointsPerHole);

            // Add skins data to each player's leaderboard entry
            leaderboard.forEach(entry => {
                entry.skins = {
                    skinsWon: skinsResults.skinsWon[entry.player_id] || 0,
                    frontNine: skinsResults.frontNine[entry.player_id] || 0,
                    backNine: skinsResults.backNine[entry.player_id] || 0,
                    holeResults: skinsResults.holeResults,
                    pointsPerHole: pointsPerHole
                };
            });
        }

        // Calculate Match Play across all players
        if (this.scoringFormats.includes('matchplay') && this.courseData && this.courseData.holes) {
            const allPlayerData = this.players.map(player => {
                const playerScores = this.scoresCache[player.id] || {};
                const scoresArray = Object.entries(playerScores).map(([hole, score]) => ({
                    hole_number: parseInt(hole),
                    gross_score: score
                }));

                return {
                    playerId: player.id,
                    playerName: player.name,
                    scores: scoresArray,
                    handicap: player.handicap
                };
            });

            const matchResults = engine.calculateMatchPlay(allPlayerData, this.courseData.holes, true);

            // Add match play data to each player's leaderboard entry
            leaderboard.forEach(entry => {
                entry.matchplay = matchResults[entry.player_id] || {
                    status: 'All Square',
                    holesUp: 0,
                    holesDown: 0,
                    holesHalved: 0,
                    netHoles: 0,
                    matchFinished: false
                };
            });
        }

        return leaderboard;
    }

    async getEventLeaderboard() {
        if (!this.eventId) return [];

        const leaderboard = await window.SocietyGolfDB.getLeaderboard(this.eventId);
        return leaderboard;
    }

    renderGroupLeaderboard(leaderboard) {
        if (leaderboard.length === 0) {
            return '<p class="text-center py-8 text-gray-500">No scores yet</p>';
        }

        // Render multiple leaderboards - one for each selected format
        const leaderboardsHtml = this.scoringFormats.map((format, formatIndex) => {
            // Clone and sort leaderboard for this specific format
            const sortedLeaderboard = [...leaderboard];

            // Sort based on format
            switch (format) {
                case 'stableford':
                    sortedLeaderboard.sort((a, b) => b.total_stableford - a.total_stableford);
                    break;
                case 'modifiedstableford':
                    sortedLeaderboard.sort((a, b) => b.total_modified_stableford - a.total_modified_stableford);
                    break;
                case 'nassau':
                    sortedLeaderboard.sort((a, b) => (a.nassau?.total || 999) - (b.nassau?.total || 999));
                    break;
                case 'skins':
                    sortedLeaderboard.sort((a, b) => (b.skins?.skinsWon || 0) - (a.skins?.skinsWon || 0));
                    break;
                case 'strokeplay':
                case 'matchplay':
                case 'bestball':
                case 'scramble':
                default:
                    sortedLeaderboard.sort((a, b) => a.total_gross - b.total_gross);
            }

            // Get format display name
            const formatNames = {
                'stableford': 'Thailand Stableford',
                'strokeplay': 'Stroke Play',
                'matchplay': 'Match Play',
                'bestball': 'Best Ball',
                'scramble': 'Scramble',
                'modifiedstableford': 'Modified Stableford',
                'skins': 'Skins',
                'nassau': 'Nassau'
            };

            const formatName = formatNames[format] || format;

            // Special rendering for Nassau format
            if (format === 'nassau') {
                return `
                    <div class="mb-6 ${formatIndex > 0 ? 'mt-6 pt-6 border-t-4 border-gray-300' : ''}">
                        <h3 class="text-lg font-bold text-gray-900 mb-3 bg-gradient-to-r from-yellow-100 to-yellow-50 px-4 py-2 rounded-lg border-l-4 border-yellow-500">
                            ${formatName} Leaderboard
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="border-b-2 border-gray-300">
                                    <tr class="text-left">
                                        <th class="py-2 px-2">Pos</th>
                                        <th class="py-2 px-2">Player</th>
                                        <th class="py-2 px-2">Thru</th>
                                        <th class="py-2 px-2 text-center bg-blue-50">Front 9</th>
                                        <th class="py-2 px-2 text-center bg-green-50">Back 9</th>
                                        <th class="py-2 px-2 text-center bg-yellow-50 font-bold">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedLeaderboard.map((entry, index) => {
                                        const holesPlayed = entry.holes_played || 0;
                                        const thru = holesPlayed === 18 ? 'F' : holesPlayed === 0 ? '-' : holesPlayed.toString();
                                        const front9 = entry.nassau?.front9 || '-';
                                        const back9 = entry.nassau?.back9 || '-';
                                        const total = entry.nassau?.total || entry.total_gross || 0;

                                        return `
                                            <tr class="border-b border-gray-200">
                                                <td class="py-2 px-2 font-bold">${index + 1}</td>
                                                <td class="py-2 px-2">${entry.player_name || 'Unknown'}</td>
                                                <td class="py-2 px-2">${thru}</td>
                                                <td class="py-2 px-2 text-center font-semibold text-blue-700">${front9}</td>
                                                <td class="py-2 px-2 text-center font-semibold text-green-700">${back9}</td>
                                                <td class="py-2 px-2 text-center font-bold text-lg">${total}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm">
                                <div class="font-semibold text-gray-900 mb-2">Nassau Scoring:</div>
                                <div class="text-gray-700">
                                    • <span class="font-medium">Front 9 Winner:</span> ${this.getNassauWinner(sortedLeaderboard, 'front9')}<br>
                                    • <span class="font-medium">Back 9 Winner:</span> ${this.getNassauWinner(sortedLeaderboard, 'back9')}<br>
                                    • <span class="font-medium">Overall Winner:</span> ${this.getNassauWinner(sortedLeaderboard, 'total')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Special rendering for Skins format
            if (format === 'skins') {
                // Sort by skins points
                sortedLeaderboard.sort((a, b) => (b.skins?.skinsWon || 0) - (a.skins?.skinsWon || 0));

                const holeResults = sortedLeaderboard[0]?.skins?.holeResults || {};
                const pointsPerHole = sortedLeaderboard[0]?.skins?.pointsPerHole || 100;

                // Define player colors (7 distinct colors for up to 7 players)
                const playerColors = [
                    { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-400', badge: 'bg-blue-500' },
                    { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-400', badge: 'bg-green-500' },
                    { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-400', badge: 'bg-red-500' },
                    { bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-400', badge: 'bg-purple-500' },
                    { bg: 'bg-pink-100', text: 'text-pink-800', border: 'border-pink-400', badge: 'bg-pink-500' },
                    { bg: 'bg-indigo-100', text: 'text-indigo-800', border: 'border-indigo-400', badge: 'bg-indigo-500' },
                    { bg: 'bg-teal-100', text: 'text-teal-800', border: 'border-teal-400', badge: 'bg-teal-500' }
                ];

                // Assign colors to players
                const playerColorMap = {};
                sortedLeaderboard.forEach((entry, index) => {
                    playerColorMap[entry.player_id] = playerColors[index % playerColors.length];
                });

                return `
                    <div class="mb-6 ${formatIndex > 0 ? 'mt-6 pt-6 border-t-4 border-gray-300' : ''}">
                        <h3 class="text-lg font-bold text-gray-900 mb-3 bg-gradient-to-r from-orange-100 to-orange-50 px-4 py-2 rounded-lg border-l-4 border-orange-500">
                            ${formatName} Leaderboard
                            <span class="text-sm font-normal text-gray-600 ml-2">(${pointsPerHole} points/hole)</span>
                        </h3>

                        <!-- Summary Table with Front/Back/Total -->
                        <div class="overflow-x-auto mb-4">
                            <table class="w-full text-sm">
                                <thead class="border-b-2 border-gray-300">
                                    <tr class="text-left">
                                        <th class="py-2 px-2">Pos</th>
                                        <th class="py-2 px-2">Player</th>
                                        <th class="py-2 px-2">Thru</th>
                                        <th class="py-2 px-2 text-center bg-blue-50">Front 9</th>
                                        <th class="py-2 px-2 text-center bg-green-50">Back 9</th>
                                        <th class="py-2 px-2 text-center bg-orange-50 font-bold">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedLeaderboard.map((entry, index) => {
                                        const holesPlayed = entry.holes_played || 0;
                                        const thru = holesPlayed === 18 ? 'F' : holesPlayed === 0 ? '-' : holesPlayed.toString();
                                        const totalPoints = entry.skins?.skinsWon || 0;
                                        const frontPoints = entry.skins?.frontNine || 0;
                                        const backPoints = entry.skins?.backNine || 0;
                                        const color = playerColorMap[entry.player_id];

                                        return `
                                            <tr class="border-b border-gray-200 ${index === 0 ? 'bg-orange-50' : ''}">
                                                <td class="py-2 px-2 font-bold">${index + 1}</td>
                                                <td class="py-2 px-2 flex items-center gap-2">
                                                    <span class="inline-block w-3 h-3 rounded-full ${color.badge}"></span>
                                                    ${entry.player_name || 'Unknown'}
                                                </td>
                                                <td class="py-2 px-2">${thru}</td>
                                                <td class="py-2 px-2 text-center font-semibold">${frontPoints.toLocaleString()}</td>
                                                <td class="py-2 px-2 text-center font-semibold">${backPoints.toLocaleString()}</td>
                                                <td class="py-2 px-2 text-center font-bold text-xl text-orange-700">${totalPoints.toLocaleString()}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>

                        <!-- Hole-by-Hole Breakdown with Colors -->
                        <div class="mt-4 p-3 bg-orange-50 rounded-lg">
                            <div class="font-semibold text-gray-900 mb-3 text-sm">Hole-by-Hole Breakdown:</div>
                            <div class="grid grid-cols-6 gap-2 text-xs">
                                ${Object.entries(holeResults).slice(0, 18).map(([hole, result]) => {
                                    const holeNum = parseInt(hole);
                                    const winner = result.winnerName;
                                    const winnerId = result.winner;
                                    const tied = result.tied;
                                    const pointsValue = result.pointsValue || 0;
                                    const carriedOver = result.carriedOver || 0;

                                    let bgColor = 'bg-white';
                                    let textColor = 'text-gray-600';
                                    let borderColor = 'border-gray-300';
                                    let displayText = '-';

                                    if (tied) {
                                        bgColor = 'bg-yellow-100';
                                        textColor = 'text-yellow-800';
                                        borderColor = 'border-yellow-400';
                                        displayText = `Tie (${carriedOver}x)`;
                                    } else if (winner && winnerId) {
                                        const color = playerColorMap[winnerId];
                                        bgColor = color.bg;
                                        textColor = color.text;
                                        borderColor = color.border;
                                        displayText = winner;
                                        if (pointsValue) {
                                            displayText += `<br><strong>${pointsValue.toLocaleString()}pts</strong>`;
                                        }
                                    }

                                    return `
                                        <div class="p-2 ${bgColor} ${textColor} rounded border-2 ${borderColor} text-center">
                                            <div class="font-bold mb-1">H${holeNum}</div>
                                            <div class="text-xs">${displayText}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div class="mt-3 text-xs text-gray-600">
                                <strong>Legend:</strong>
                                <span class="inline-block px-2 py-1 bg-yellow-100 text-yellow-800 rounded ml-2">Tie (carry-over multiplier)</span>
                                <span class="ml-2">Colors match player badges above</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Special rendering for Match Play format
            if (format === 'matchplay') {
                // Sort by net holes (holes up)
                sortedLeaderboard.sort((a, b) => (b.matchplay?.netHoles || 0) - (a.matchplay?.netHoles || 0));

                return `
                    <div class="mb-6 ${formatIndex > 0 ? 'mt-6 pt-6 border-t-4 border-gray-300' : ''}">
                        <h3 class="text-lg font-bold text-gray-900 mb-3 bg-gradient-to-r from-purple-100 to-purple-50 px-4 py-2 rounded-lg border-l-4 border-purple-500">
                            ${formatName} Leaderboard
                        </h3>

                        <!-- Match Play Table -->
                        <div class="overflow-x-auto mb-4">
                            <table class="w-full text-sm">
                                <thead class="border-b-2 border-gray-300">
                                    <tr class="text-left">
                                        <th class="py-2 px-2">Pos</th>
                                        <th class="py-2 px-2">Player</th>
                                        <th class="py-2 px-2">Thru</th>
                                        <th class="py-2 px-2 text-center bg-green-50">Won</th>
                                        <th class="py-2 px-2 text-center bg-gray-50">Halved</th>
                                        <th class="py-2 px-2 text-center bg-red-50">Lost</th>
                                        <th class="py-2 px-2 text-center bg-purple-50 font-bold">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedLeaderboard.map((entry, index) => {
                                        const holesPlayed = entry.holes_played || 0;
                                        const thru = holesPlayed === 18 ? 'F' : holesPlayed === 0 ? '-' : holesPlayed.toString();
                                        const matchData = entry.matchplay || {};
                                        const status = matchData.status || 'All Square';
                                        const isUp = matchData.netHoles > 0;
                                        const isDown = matchData.netHoles < 0;
                                        const isSquare = matchData.netHoles === 0;
                                        const isFinished = matchData.matchFinished;

                                        let statusColor = 'text-gray-700';
                                        let statusBg = '';
                                        if (isUp) {
                                            statusColor = 'text-green-700 font-bold';
                                            statusBg = index === 0 ? 'bg-green-50' : '';
                                        } else if (isDown) {
                                            statusColor = 'text-red-700 font-bold';
                                        } else {
                                            statusColor = 'text-gray-600';
                                        }

                                        return `
                                            <tr class="border-b border-gray-200 ${statusBg}">
                                                <td class="py-2 px-2 font-bold">${index + 1}</td>
                                                <td class="py-2 px-2">${entry.player_name || 'Unknown'}</td>
                                                <td class="py-2 px-2">${thru}</td>
                                                <td class="py-2 px-2 text-center text-green-700 font-semibold">${matchData.holesUp || 0}</td>
                                                <td class="py-2 px-2 text-center text-gray-600">${matchData.holesHalved || 0}</td>
                                                <td class="py-2 px-2 text-center text-red-700 font-semibold">${matchData.holesDown || 0}</td>
                                                <td class="py-2 px-2 text-center ${statusColor}">
                                                    ${status}
                                                    ${isFinished ? '<br><span class="text-xs text-gray-600">(Finished)</span>' : ''}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>

                        <div class="text-xs text-gray-600 p-3 bg-purple-50 rounded-lg">
                            <strong>Match Play Legend:</strong>
                            <span class="ml-2">UP = Leading by holes</span>
                            <span class="ml-2">• DOWN = Trailing by holes</span>
                            <span class="ml-2">• All Square = Tied</span>
                            <span class="ml-2">• "4 & 3" = 4 holes up with 3 to play (match finished)</span>
                        </div>
                    </div>
                `;
            }

            // Standard rendering for other formats
            let scoreHeader = 'Score';
            let getDisplayScore = (entry) => entry.total_gross;
            let headerColor = 'from-gray-100 to-gray-50';
            let borderColor = 'border-gray-500';

            switch (format) {
                case 'stableford':
                    scoreHeader = 'Points';
                    getDisplayScore = (entry) => entry.total_stableford;
                    headerColor = 'from-green-100 to-green-50';
                    borderColor = 'border-green-500';
                    break;
                case 'modifiedstableford':
                    scoreHeader = 'Points';
                    getDisplayScore = (entry) => entry.total_modified_stableford;
                    headerColor = 'from-purple-100 to-purple-50';
                    borderColor = 'border-purple-500';
                    break;
                case 'strokeplay':
                    scoreHeader = 'Gross';
                    getDisplayScore = (entry) => entry.total_gross;
                    headerColor = 'from-blue-100 to-blue-50';
                    borderColor = 'border-blue-500';
                    break;
                case 'matchplay':
                case 'bestball':
                case 'scramble':
                case 'skins':
                default:
                    scoreHeader = 'Gross';
                    getDisplayScore = (entry) => entry.total_gross;
                    headerColor = 'from-gray-100 to-gray-50';
                    borderColor = 'border-gray-500';
            }

            return `
                <div class="mb-6 ${formatIndex > 0 ? 'mt-6 pt-6 border-t-4 border-gray-300' : ''}">
                    <h3 class="text-lg font-bold text-gray-900 mb-3 bg-gradient-to-r ${headerColor} px-4 py-2 rounded-lg border-l-4 ${borderColor}">
                        ${formatName} Leaderboard
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="border-b-2 border-gray-300">
                                <tr class="text-left">
                                    <th class="py-2 px-2">Pos</th>
                                    <th class="py-2 px-2">Player</th>
                                    <th class="py-2 px-2">Thru</th>
                                    <th class="py-2 px-2">${scoreHeader}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedLeaderboard.map((entry, index) => {
                                    const holesPlayed = entry.holes_played || 0;
                                    const thru = holesPlayed === 18 ? 'F' : holesPlayed === 0 ? '-' : holesPlayed.toString();
                                    const displayScore = getDisplayScore(entry) || 0;

                                    return `
                                        <tr class="border-b border-gray-200">
                                            <td class="py-2 px-2 font-bold">${index + 1}</td>
                                            <td class="py-2 px-2">${entry.player_name || 'Unknown'}</td>
                                            <td class="py-2 px-2">${thru}</td>
                                            <td class="py-2 px-2 font-bold text-lg">${displayScore}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }).join('');

        return `<div class="space-y-4">${leaderboardsHtml}</div>`;
    }

    getNassauWinner(leaderboard, segment) {
        if (leaderboard.length === 0) return 'No scores yet';

        let best = Infinity;
        let winners = [];

        for (const entry of leaderboard) {
            let score;
            if (segment === 'front9') {
                score = entry.nassau?.front9;
            } else if (segment === 'back9') {
                score = entry.nassau?.back9;
            } else {
                score = entry.nassau?.total || entry.total_gross;
            }

            if (!score || score === '-') continue;

            if (score < best) {
                best = score;
                winners = [entry.player_name];
            } else if (score === best) {
                winners.push(entry.player_name);
            }
        }

        if (winners.length === 0) return 'No scores yet';
        if (winners.length === 1) return `${winners[0]} (${best})`;
        return `Tied: ${winners.join(', ')} (${best})`;
    }

    renderEventLeaderboard(leaderboard) {
        if (leaderboard.length === 0) {
            return '<p class="text-center py-8 text-gray-500">No scores in this event yet</p>';
        }

        return `
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="border-b-2 border-gray-300">
                        <tr class="text-left">
                            <th class="py-2 px-2">Pos</th>
                            <th class="py-2 px-2">Player</th>
                            <th class="py-2 px-2">Thru</th>
                            <th class="py-2 px-2">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${leaderboard.map((entry, index) => `
                            <tr class="border-b border-gray-200">
                                <td class="py-2 px-2 font-bold">${entry.position}</td>
                                <td class="py-2 px-2">${entry.player_name || 'Unknown'}</td>
                                <td class="py-2 px-2">${entry.thru}</td>
                                <td class="py-2 px-2 font-bold">${entry.total_net || 0}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    renderOtherEvents() {
        return `
            <div class="text-center py-8">
                <p class="text-gray-600 mb-4">View live leaderboards from other events</p>
                <p class="text-sm text-gray-500">Feature coming soon!</p>
            </div>
        `;
    }

    // =====================================================
    // COMPETITION LEADERBOARDS - CROSS-GROUP SIDE GAMES
    // =====================================================

    async getCompetitionLeaderboards() {
        const userId = AppState.currentUser?.lineUserId;
        if (!userId) {
            return { pools: [], message: 'Not authenticated' };
        }

        // Get all pools this player has joined
        const courseId = document.getElementById('scorecardCourseSelect')?.value;
        if (!courseId) {
            return { pools: [], message: 'No course selected' };
        }

        const today = new Date().toISOString().split('T')[0];

        try {
            const { data: joinedPools, error } = await window.SupabaseDB.client
                .from('pool_entrants')
                .select(`
                    pool_id,
                    side_game_pools!inner (
                        id,
                        type,
                        name,
                        config,
                        course_id,
                        date_iso,
                        pool_entrants (
                            player_id,
                            joined_at
                        ),
                        live_progress (
                            player_id,
                            holes_completed
                        )
                    )
                `)
                .eq('player_id', userId)
                .eq('side_game_pools.course_id', courseId)
                .eq('side_game_pools.date_iso', today)
                .eq('side_game_pools.status', 'active');

            if (error) {
                console.error('[LiveScorecard] Error loading competition pools:', error);
                return { pools: [], message: 'Error loading pools' };
            }

            if (!joinedPools || joinedPools.length === 0) {
                return { pools: [], message: 'Not in any public games yet' };
            }

            // Calculate leaderboards for each pool
            const poolsData = [];
            for (const entry of joinedPools) {
                const pool = entry.side_game_pools;
                const leaderboardData = await this.calculatePoolLeaderboard(pool);
                poolsData.push({
                    pool,
                    leaderboard: leaderboardData
                });
            }

            return { pools: poolsData, message: null };

        } catch (error) {
            console.error('[LiveScorecard] Exception loading competition:', error);
            return { pools: [], message: 'Error loading competition data' };
        }
    }

    async calculatePoolLeaderboard(pool) {
        const entrantIds = pool.pool_entrants.map(e => e.player_id);
        const userId = AppState.currentUser?.lineUserId;

        // Build holes completed map
        const holesCompleted = {};
        for (const progress of pool.live_progress || []) {
            holesCompleted[progress.player_id] = progress.holes_completed || 0;
        }

        // Calculate fairness cutoff
        const cutoff = window.LiveGamesSystem.commonCutoffHole(entrantIds, holesCompleted);

        if (cutoff < 1) {
            return {
                cutoffHole: 0,
                leaderboard: [],
                message: 'Waiting for all players to complete at least one hole...',
                entrants: entrantIds.length
            };
        }

        // For now, just return basic progress info
        // Full calculation would require fetching all players' scores
        const standings = entrantIds.map(playerId => ({
            playerId,
            holesCompleted: holesCompleted[playerId] || 0,
            isCurrentUser: playerId === userId
        }));

        // Sort by holes completed (most progress first)
        standings.sort((a, b) => b.holesCompleted - a.holesCompleted);

        return {
            cutoffHole: cutoff,
            leaderboard: standings,
            message: null,
            entrants: entrantIds.length
        };
    }

    renderCompetitionLeaderboards(competitionData) {
        if (competitionData.message) {
            return `
                <div class="text-center py-8 text-gray-500">
                    <span class="material-symbols-outlined text-4xl mb-2">public</span>
                    <p>${competitionData.message}</p>
                    ${competitionData.message === 'Not in any public games yet' ? `
                        <button onclick="LiveScorecardManager.showJoinGamesModal()"
                                class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            Browse Public Games
                        </button>
                    ` : ''}
                </div>
            `;
        }

        if (competitionData.pools.length === 0) {
            return `
                <div class="text-center py-8 text-gray-500">
                    <p>No active competitions</p>
                </div>
            `;
        }

        // Render each pool as a separate leaderboard
        const poolsHtml = competitionData.pools.map(({ pool, leaderboard }) => {
            const typeIcons = {
                skins: { icon: 'monetization_on', color: 'orange', bg: 'bg-orange-50', border: 'border-orange-200' },
                matchplay: { icon: 'sports_score', color: 'purple', bg: 'bg-purple-50', border: 'border-purple-200' },
                nassau: { icon: 'emoji_events', color: 'blue', bg: 'bg-blue-50', border: 'border-blue-200' }
            };

            const config = typeIcons[pool.type] || typeIcons.skins;
            const cutoffText = leaderboard.cutoffHole > 0
                ? `Through Hole ${leaderboard.cutoffHole}`
                : 'In Progress';

            return `
                <div class="mb-6 border-2 ${config.border} rounded-lg overflow-hidden ${config.bg}">
                    <div class="p-4 bg-white border-b ${config.border}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-${config.color}-600">${config.icon}</span>
                                <div>
                                    <h3 class="font-bold text-gray-900">${pool.name}</h3>
                                    <p class="text-xs text-gray-600">${leaderboard.entrants} ${leaderboard.entrants === 1 ? 'player' : 'players'} competing</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs font-semibold text-${config.color}-700 bg-${config.color}-100 px-3 py-1 rounded-full">
                                    ${cutoffText}
                                </div>
                                ${pool.config.pointsPerHole ? `
                                    <div class="text-xs text-gray-600 mt-1">${pool.config.pointsPerHole} pts/hole</div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    ${leaderboard.message ? `
                        <div class="p-8 text-center text-gray-500">
                            <p>${leaderboard.message}</p>
                        </div>
                    ` : `
                        <div class="p-4">
                            <table class="w-full text-sm">
                                <thead class="border-b border-${config.color}-200">
                                    <tr class="text-left">
                                        <th class="py-2 px-2">Pos</th>
                                        <th class="py-2 px-2">Player</th>
                                        <th class="py-2 px-2">Thru</th>
                                        <th class="py-2 px-2">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${leaderboard.leaderboard.map((entry, index) => `
                                        <tr class="border-b border-${config.color}-100 ${entry.isCurrentUser ? 'bg-yellow-50 font-bold' : ''}">
                                            <td class="py-2 px-2">${index + 1}</td>
                                            <td class="py-2 px-2">${entry.playerId}${entry.isCurrentUser ? ' (You)' : ''}</td>
                                            <td class="py-2 px-2">${entry.holesCompleted}/18</td>
                                            <td class="py-2 px-2">
                                                ${entry.holesCompleted === 18 ?
                                                    '<span class="text-green-600">✓ Finished</span>' :
                                                    entry.holesCompleted === 0 ?
                                                    '<span class="text-gray-400">Waiting</span>' :
                                                    '<span class="text-blue-600">⚡ Playing</span>'
                                                }
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}

                    <div class="px-4 py-2 bg-${config.color}-50 border-t ${config.border} text-xs text-gray-600">
                        <strong>Fairness Cutoff:</strong> Only showing standings through hole ${leaderboard.cutoffHole || 0} (minimum completed by all players)
                    </div>
                </div>
            `;
        }).join('');

        return `
            <div class="space-y-4">
                <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="material-symbols-outlined text-purple-600">public</span>
                        <h3 class="font-bold text-gray-900">Multi-Group Competition</h3>
                    </div>
                    <p class="text-xs text-gray-600">
                        Competing with other groups on this course. Leaderboards automatically adjust to show only holes everyone has completed.
                    </p>
                </div>
                ${poolsHtml}
            </div>
        `;
    }

    subscribeToUpdates() {
        if (!this.groupId) return;

        const sub = window.SupabaseDB.client
            .channel(`group_${this.groupId}`)
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'scores'
            }, (payload) => {
                console.log('[LiveScorecard] Score update:', payload);
                this.renderHole();
                this.refreshLeaderboard();
            })
            .subscribe();

        this.subscriptions.push(sub);
    }

    // ============================================
    // SCORECARD SCANNER (OCR) - YAML TEMPLATE BASED
    // ============================================

    // Built-in YAML profiles (embedded for easy deployment)
    SCORECARD_PROFILES = {
        'bangpakong': `
course_name: "Bangpakong Riverside Country Club"
course_id: "bangpakong"
layout: "front_back_side_by_side"
regions:
  par_front:
    bbox: [0.05, 0.60, 0.48, 0.64]
    type: "number_array"
    count: 9
    range: [3, 5]
  par_back:
    bbox: [0.52, 0.60, 0.95, 0.64]
    type: "number_array"
    count: 9
    range: [3, 5]
  handicap_front:
    bbox: [0.05, 0.85, 0.48, 0.90]
    type: "number_array"
    count: 9
    range: [1, 18]
  handicap_back:
    bbox: [0.52, 0.85, 0.95, 0.90]
    type: "number_array"
    count: 9
    range: [1, 18]
  yardage_black_front:
    bbox: [0.05, 0.25, 0.48, 0.29]
    type: "number_array"
    count: 9
    range: [100, 600]
  yardage_black_back:
    bbox: [0.52, 0.25, 0.95, 0.29]
    type: "number_array"
    count: 9
    range: [100, 600]
  yardage_blue_front:
    bbox: [0.05, 0.30, 0.48, 0.34]
    type: "number_array"
    count: 9
    range: [100, 600]
  yardage_blue_back:
    bbox: [0.52, 0.30, 0.95, 0.34]
    type: "number_array"
    count: 9
    range: [100, 600]
  yardage_white_front:
    bbox: [0.05, 0.35, 0.48, 0.39]
    type: "number_array"
    count: 9
    range: [100, 600]
  yardage_white_back:
    bbox: [0.52, 0.35, 0.95, 0.39]
    type: "number_array"
    count: 9
    range: [100, 600]
  yardage_yellow_front:
    bbox: [0.05, 0.40, 0.48, 0.44]
    type: "number_array"
    count: 9
    range: [100, 600]
  yardage_yellow_back:
    bbox: [0.52, 0.40, 0.95, 0.44]
    type: "number_array"
    count: 9
    range: [100, 600]
  yardage_red_front:
    bbox: [0.05, 0.45, 0.48, 0.49]
    type: "number_array"
    count: 9
    range: [100, 600]
  yardage_red_back:
    bbox: [0.52, 0.45, 0.95, 0.49]
    type: "number_array"
    count: 9
    range: [100, 600]
`,
        'burapha_east': `
course_name: "Burapha Golf Club - East Course"
course_id: "burapha_east"
layout: "front_back_side_by_side"
regions:
  par_front:
    bbox: [0.05, 0.52, 0.48, 0.56]
    type: "number_array"
    count: 9
    range: [3, 5]
  par_back:
    bbox: [0.52, 0.52, 0.95, 0.56]
    type: "number_array"
    count: 9
    range: [3, 5]
  handicap_front:
    bbox: [0.05, 0.72, 0.48, 0.76]
    type: "number_array"
    count: 9
    range: [1, 18]
  handicap_back:
    bbox: [0.52, 0.72, 0.95, 0.76]
    type: "number_array"
    count: 9
    range: [1, 18]
  yardage_men_front:
    bbox: [0.05, 0.38, 0.48, 0.42]
    type: "number_array"
    count: 9
    range: [100, 600]
  yardage_men_back:
    bbox: [0.52, 0.38, 0.95, 0.42]
    type: "number_array"
    count: 9
    range: [100, 600]
`,
        'generic': `
course_name: "Generic Course"
course_id: "generic"
layout: "text_based"
`
    };

    async loadProfile(profileId) {
        console.log('[Scanner] Loading profile:', profileId);

        try {
            const yamlText = this.SCORECARD_PROFILES[profileId];
            if (!yamlText) {
                console.warn('[Scanner] Profile not found, using generic');
                return jsyaml.load(this.SCORECARD_PROFILES['generic']);
            }

            const profile = jsyaml.load(yamlText);
            console.log('[Scanner] Profile loaded:', profile);
            return profile;
        } catch (error) {
            console.error('[Scanner] Error loading profile:', error);
            return jsyaml.load(this.SCORECARD_PROFILES['generic']);
        }
    }

    cropImageRegion(imageData, bbox, imgWidth, imgHeight) {
        // Convert normalized coordinates to pixels
        const x = Math.floor(bbox[0] * imgWidth);
        const y = Math.floor(bbox[1] * imgHeight);
        const x2 = Math.floor(bbox[2] * imgWidth);
        const y2 = Math.floor(bbox[3] * imgHeight);
        const w = x2 - x;
        const h = y2 - y;

        console.log(`[Scanner] Cropping region: x=${x}, y=${y}, w=${w}, h=${h}`);

        // Create canvas for cropping
        const canvas = document.createElement('canvas');

        // Scale up small regions for better OCR (min 200px wide)
        const scale = w < 200 ? 200 / w : 1;
        canvas.width = w * scale;
        canvas.height = h * scale;
        const ctx = canvas.getContext('2d');

        // Load source image
        const img = new Image();
        return new Promise((resolve) => {
            img.onload = () => {
                // Draw cropped region (scaled if needed)
                ctx.drawImage(img, x, y, w, h, 0, 0, canvas.width, canvas.height);

                // Apply preprocessing for better OCR
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;

                // Quick grayscale + threshold
                for (let i = 0; i < data.length; i += 4) {
                    const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                    const val = gray > 128 ? 255 : 0;
                    data[i] = data[i + 1] = data[i + 2] = val;
                }

                ctx.putImageData(imageData, 0, 0);
                resolve(canvas.toDataURL());
            };
            img.src = imageData;
        });
    }

    async extractRegionData(imageData, region, imgWidth, imgHeight) {
        // Crop image to region
        const croppedImage = await this.cropImageRegion(region.bbox, imageData, imgWidth, imgHeight);

        // Run OCR on cropped region with FAST settings
        const result = await Tesseract.recognize(croppedImage, 'eng', {
            tessedit_char_whitelist: '0123456789 ',
            tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE, // Much faster for single row
            tessedit_ocr_engine_mode: Tesseract.OEM.TESSERACT_ONLY, // Faster engine
            // logger removed for speed
        });

        console.log('[Scanner] Region OCR text:', result.data.text);

        // Extract numbers from text
        const numbers = result.data.text.match(/\d+/g) || [];
        const parsedNumbers = numbers.map(n => parseInt(n));

        // Filter by range if specified
        let filtered = parsedNumbers;
        if (region.range) {
            filtered = parsedNumbers.filter(n => n >= region.range[0] && n <= region.range[1]);
        }

        console.log('[Scanner] Extracted numbers:', filtered);
        return filtered;
    }

    async openScorecardScanner() {
        const modal = document.getElementById('scorecardScannerModal');
        modal.classList.remove('hidden');

        // Start camera
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment', // Use back camera on mobile
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }
            });
            const video = document.getElementById('scannerVideo');
            video.srcObject = stream;
            this.cameraStream = stream;
        } catch (error) {
            console.error('[Scanner] Camera error:', error);
            NotificationManager.show('Unable to access camera. Please try uploading an image instead.', 'error');
        }
    }

    closeScorecardScanner() {
        const modal = document.getElementById('scorecardScannerModal');
        modal.classList.add('hidden');

        // Stop camera
        if (this.cameraStream) {
            this.cameraStream.getTracks().forEach(track => track.stop());
            this.cameraStream = null;
        }

        // Reset views
        document.getElementById('cameraView').classList.remove('hidden');
        document.getElementById('capturedPreview').classList.add('hidden');
        document.getElementById('processingView').classList.add('hidden');
    }

    captureScorecard() {
        const video = document.getElementById('scannerVideo');
        const canvas = document.getElementById('scannerCanvas');
        const preview = document.getElementById('previewImage');

        // Set canvas size to video size
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // Draw video frame to canvas
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);

        // Convert to image
        const imageData = canvas.toDataURL('image/jpeg', 0.9);
        preview.src = imageData;

        // Show preview, hide camera
        document.getElementById('cameraView').classList.add('hidden');
        document.getElementById('capturedPreview').classList.remove('hidden');

        this.capturedImage = imageData;
    }

    uploadScorecard() {
        document.getElementById('scorecardFileInput').click();
    }

    handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const preview = document.getElementById('previewImage');
            preview.src = e.target.result;
            this.capturedImage = e.target.result;

            // Show preview, hide camera
            document.getElementById('cameraView').classList.add('hidden');
            document.getElementById('capturedPreview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    retakePhoto() {
        document.getElementById('cameraView').classList.remove('hidden');
        document.getElementById('capturedPreview').classList.add('hidden');
        this.capturedImage = null;
    }

    preprocessImage(imageData) {
        // Create canvas for preprocessing
        const img = new Image();
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        return new Promise((resolve) => {
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;

                // Draw original image
                ctx.drawImage(img, 0, 0);

                // Get image data
                const imageDataObj = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageDataObj.data;

                // Convert to grayscale and increase contrast
                for (let i = 0; i < data.length; i += 4) {
                    // Grayscale
                    const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;

                    // Increase contrast (adjust threshold)
                    const contrast = 1.5;
                    const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
                    const adjusted = factor * (gray - 128) + 128;

                    // Apply thresholding for better text recognition
                    const threshold = adjusted > 128 ? 255 : 0;

                    data[i] = threshold;
                    data[i + 1] = threshold;
                    data[i + 2] = threshold;
                }

                ctx.putImageData(imageDataObj, 0, 0);
                resolve(canvas.toDataURL());
            };
            img.src = imageData;
        });
    }

    async processImage() {
        if (!this.capturedImage) {
            NotificationManager.show('No image captured', 'error');
            return;
        }

        // Show processing view
        document.getElementById('capturedPreview').classList.add('hidden');
        document.getElementById('processingView').classList.remove('hidden');

        try {
            console.log('[Scanner] Starting YAML template-based OCR...');
            const progressEl = document.getElementById('ocrProgress');

            // Get selected profile
            const profileId = document.getElementById('scorecardProfileSelect').value;
            progressEl.textContent = `Loading ${profileId} profile...`;

            const profile = await this.loadProfile(profileId);

            // Get image dimensions
            const img = new Image();
            await new Promise((resolve) => {
                img.onload = resolve;
                img.src = this.capturedImage;
            });
            const imgWidth = img.width;
            const imgHeight = img.height;
            console.log('[Scanner] Image dimensions:', imgWidth, 'x', imgHeight);

            // Check if template-based or text-based
            if (profile.layout === 'text_based') {
                // Fallback to old text-based method
                progressEl.textContent = 'Using text-based extraction...';
                const processedImage = await this.preprocessImage(this.capturedImage);
                const result = await Tesseract.recognize(processedImage, 'eng');
                const courseData = this.parseScorecardText(result.data.text, result.data);
                this.closeScorecardScanner();
                this.showCourseReview(courseData);
                return;
            }

            // Template-based extraction (Burapha, etc.)
            progressEl.textContent = 'Extracting data from regions in parallel...';

            // Run ALL region extractions in parallel (much faster!)
            // Only extract PAR and HANDICAP (skip yardage for speed)
            const extractionPromises = [];

            if (profile.regions.par_front) {
                extractionPromises.push(
                    this.extractRegionData(this.capturedImage, profile.regions.par_front, imgWidth, imgHeight)
                        .then(data => ({ type: 'par_front', data }))
                );
            }
            if (profile.regions.par_back) {
                extractionPromises.push(
                    this.extractRegionData(this.capturedImage, profile.regions.par_back, imgWidth, imgHeight)
                        .then(data => ({ type: 'par_back', data }))
                );
            }
            if (profile.regions.handicap_front) {
                extractionPromises.push(
                    this.extractRegionData(this.capturedImage, profile.regions.handicap_front, imgWidth, imgHeight)
                        .then(data => ({ type: 'handicap_front', data }))
                );
            }
            if (profile.regions.handicap_back) {
                extractionPromises.push(
                    this.extractRegionData(this.capturedImage, profile.regions.handicap_back, imgWidth, imgHeight)
                        .then(data => ({ type: 'handicap_back', data }))
                );
            }

            // Wait for ALL extractions to complete simultaneously
            const results = await Promise.all(extractionPromises);

            // Organize results
            let parValues = [];
            let handicapValues = [];

            results.forEach(result => {
                if (result.type === 'par_front') parValues.push(...result.data);
                else if (result.type === 'par_back') parValues.push(...result.data);
                else if (result.type === 'handicap_front') handicapValues.push(...result.data);
                else if (result.type === 'handicap_back') handicapValues.push(...result.data);
            });

            console.log('[Scanner] Extracted pars:', parValues);
            console.log('[Scanner] Extracted handicaps:', handicapValues);

            // Build course data (yardage skipped for speed)
            const courseData = {
                name: profile.course_name,
                teeMarker: 'white',
                holes: []
            };

            for (let i = 0; i < 18; i++) {
                courseData.holes.push({
                    number: i + 1,
                    par: parValues[i] || 4,
                    strokeIndex: handicapValues[i] || (i + 1),
                    yardage: 0  // Can be filled manually in review screen
                });
            }

            console.log('[Scanner] Final course data:', courseData);

            // Close scanner, open review modal
            this.closeScorecardScanner();
            this.showCourseReview(courseData);

        } catch (error) {
            console.error('[Scanner] OCR error:', error);
            NotificationManager.show('OCR failed. Try Manual Entry instead.', 'error');
            document.getElementById('processingView').classList.add('hidden');
            document.getElementById('capturedPreview').classList.remove('hidden');
        }
    }

    parseScorecardText(text, fullOcrData) {
        console.log('[Scanner] Parsing OCR text...');
        console.log('[Scanner] Raw text:', text);

        // Initialize default data
        const courseData = {
            name: '',
            teeMarker: 'white',
            holes: []
        };

        // Initialize 18 holes with defaults
        for (let i = 1; i <= 18; i++) {
            courseData.holes.push({
                number: i,
                par: 4,
                strokeIndex: i,
                yardage: 0
            });
        }

        // Extract course name (first meaningful line with letters)
        const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 3);
        for (const line of lines) {
            // Look for course name (usually has Golf/Club/Course or is first line with letters)
            if (/[a-zA-Z]{4,}/.test(line) && !/(par|handicap|hole|tee|men|women|slope|rating|total)/i.test(line)) {
                courseData.name = line.replace(/[^a-zA-Z\s]/g, '').trim();
                if (courseData.name.length > 3) break;
            }
        }

        // Find Par row - look for line with "Par" followed by numbers 3-5
        let parValues = [];
        for (const line of lines) {
            if (/\bpar\b/i.test(line)) {
                console.log('[Scanner] Found Par line:', line);
                // Extract all numbers from this line
                const nums = line.match(/\d+/g) || [];
                const pars = nums.filter(n => parseInt(n) >= 3 && parseInt(n) <= 5).map(n => parseInt(n));
                if (pars.length >= 9) {
                    parValues = pars;
                    console.log('[Scanner] Extracted pars:', parValues);
                    break;
                }
            }
        }

        // Find Handicap row - look for line with "Handicap" or "Index" followed by numbers 1-18
        let handicapValues = [];
        for (const line of lines) {
            if (/\b(handicap|index|hdcp)\b/i.test(line)) {
                console.log('[Scanner] Found Handicap line:', line);
                const nums = line.match(/\d+/g) || [];
                const indices = nums.filter(n => {
                    const num = parseInt(n);
                    return num >= 1 && num <= 18;
                }).map(n => parseInt(n));

                // Look for 18 unique values between 1-18
                const uniqueIndices = [...new Set(indices)];
                if (indices.length >= 9) {
                    handicapValues = indices;
                    console.log('[Scanner] Extracted handicaps:', handicapValues);
                    break;
                }
            }
        }

        // Find yardages - look for rows with "Men", "Women", "White", "Blue", etc.
        let yardageValues = [];
        for (const line of lines) {
            if (/\b(men|white|regular|championship|blue)\b/i.test(line)) {
                console.log('[Scanner] Found Yardage line:', line);
                const nums = line.match(/\d+/g) || [];
                const yards = nums.filter(n => {
                    const num = parseInt(n);
                    return num >= 100 && num <= 600;
                }).map(n => parseInt(n));
                if (yards.length >= 9) {
                    yardageValues = yards;
                    console.log('[Scanner] Extracted yardages:', yardageValues);
                    break;
                }
            }
        }

        // Apply extracted data to holes
        // Most Thai scorecards show Front 9 and Back 9 side by side
        // So we get 9 values for front, 9 for back

        if (parValues.length >= 18) {
            // If we got 18 values, use them directly
            parValues.slice(0, 18).forEach((par, index) => {
                courseData.holes[index].par = par;
            });
        } else if (parValues.length >= 9) {
            // If we got 9 values, might be front 9 only
            // Duplicate for back 9 as fallback
            parValues.forEach((par, index) => {
                if (index < 9) {
                    courseData.holes[index].par = par;
                    courseData.holes[index + 9].par = par; // Duplicate to back 9
                }
            });
        }

        if (handicapValues.length >= 18) {
            handicapValues.slice(0, 18).forEach((idx, index) => {
                courseData.holes[index].strokeIndex = idx;
            });
        } else if (handicapValues.length >= 9) {
            handicapValues.forEach((idx, index) => {
                if (index < 9) {
                    courseData.holes[index].strokeIndex = idx;
                }
            });
        }

        if (yardageValues.length >= 18) {
            yardageValues.slice(0, 18).forEach((yards, index) => {
                courseData.holes[index].yardage = yards;
            });
        } else if (yardageValues.length >= 9) {
            yardageValues.forEach((yards, index) => {
                if (index < 9) {
                    courseData.holes[index].yardage = yards;
                }
            });
        }

        console.log('[Scanner] Parsed course data:', courseData);
        return courseData;
    }

    showCourseReview(courseData) {
        // Populate course info
        document.getElementById('reviewCourseName').value = courseData.name;
        document.getElementById('reviewTeeMarker').value = courseData.teeMarker;

        // Populate holes table
        const tbody = document.getElementById('reviewHolesTable');
        tbody.innerHTML = courseData.holes.map((hole, index) => `
            <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                <td class="px-4 py-2 font-medium">${hole.number}</td>
                <td class="px-4 py-2">
                    <select id="reviewPar${hole.number}" class="w-20 rounded border px-2 py-1">
                        <option value="3" ${hole.par === 3 ? 'selected' : ''}>3</option>
                        <option value="4" ${hole.par === 4 ? 'selected' : ''}>4</option>
                        <option value="5" ${hole.par === 5 ? 'selected' : ''}>5</option>
                    </select>
                </td>
                <td class="px-4 py-2">
                    <input type="number" id="reviewIndex${hole.number}" value="${hole.strokeIndex}" min="1" max="18" class="w-20 rounded border px-2 py-1">
                </td>
                <td class="px-4 py-2">
                    <input type="number" id="reviewYardage${hole.number}" value="${hole.yardage}" min="0" max="700" class="w-24 rounded border px-2 py-1">
                </td>
            </tr>
        `).join('');

        // Show modal
        document.getElementById('courseReviewModal').classList.remove('hidden');

        this.reviewedCourseData = courseData;
    }

    closeCourseReview() {
        document.getElementById('courseReviewModal').classList.add('hidden');
        this.reviewedCourseData = null;
    }

    async saveCourseData() {
        // Collect edited data
        const courseName = document.getElementById('reviewCourseName').value.trim();
        const teeMarker = document.getElementById('reviewTeeMarker').value;

        if (!courseName) {
            NotificationManager.show('Please enter course name', 'error');
            return;
        }

        const holes = [];
        for (let i = 1; i <= 18; i++) {
            holes.push({
                number: i,
                par: parseInt(document.getElementById(`reviewPar${i}`).value),
                strokeIndex: parseInt(document.getElementById(`reviewIndex${i}`).value),
                yardage: parseInt(document.getElementById(`reviewYardage${i}`).value) || 0
            });
        }

        try {
            // Save to database
            const courseId = `course_${Date.now()}`;

            // Insert course
            await window.SupabaseDB.client
                .from('courses')
                .insert([{
                    id: courseId,
                    name: courseName,
                    tee_marker: teeMarker
                }]);

            // Insert holes
            const holeRecords = holes.map(h => ({
                course_id: courseId,
                hole_number: h.number,
                par: h.par,
                stroke_index: h.strokeIndex,
                yardage: h.yardage,
                tee_marker: teeMarker
            }));

            await window.SupabaseDB.client
                .from('course_holes')
                .insert(holeRecords);

            // Clear course data cache for this course
            localStorage.removeItem(`mcipro_course_${courseId}`);

            // Auto-select the newly added course
            document.getElementById('scorecardCourseSelect').value = courseId;

            NotificationManager.show('Note: You may need to manually add this course to the dropdown in settings', 'info');

            // Update tee marker
            const teeRadio = document.querySelector(`input[name="teeMarker"][value="${teeMarker}"]`);
            if (teeRadio) teeRadio.checked = true;

            NotificationManager.show('✅ Course saved! Select it to start your round.', 'success');
            this.closeCourseReview();
            this.closeCourseLibrary();

        } catch (error) {
            console.error('[Scanner] Save error:', error);
            NotificationManager.show('Failed to save course data', 'error');
        }
    }

    manualCourseEntry() {
        // Close scanner modal
        this.closeScorecardScanner();

        // Create blank course data for manual entry
        const courseData = {
            name: '',
            teeMarker: 'white',
            holes: []
        };

        // Initialize 18 holes with defaults
        for (let i = 1; i <= 18; i++) {
            courseData.holes.push({
                number: i,
                par: 4,
                strokeIndex: i,
                yardage: 0
            });
        }

        // Show review modal for manual entry
        this.showCourseReview(courseData);
    }
}

// ============================================
// SCORING FORMAT CHECKBOX HANDLERS
// Inline handlers for immediate availability
// ============================================

// Toggle a single format checkbox when label is clicked
window.toggleFormatCheckbox = function(label, event) {
    const checkbox = label.querySelector('.scoring-format-checkbox');
    if (!checkbox) return;

    // If the click was directly on the checkbox, the browser has already toggled it
    // We just need to update the visual state
    // If the click was on the label, we need to toggle the checkbox AND update visual state
    const clickedCheckbox = event.target === checkbox;

    if (!clickedCheckbox) {
        // Click was on label, toggle the checkbox
        checkbox.checked = !checkbox.checked;
    }
    // else: Click was on checkbox itself, browser already toggled it

    // Update visual state based on current checkbox state
    if (checkbox.checked) {
        label.classList.remove('border-gray-300', 'bg-white');
        label.classList.add('border-green-500', 'bg-green-50');
        console.log(`[LiveScorecard] ✅ Selected: ${checkbox.value}`);
    } else {
        label.classList.remove('border-green-500', 'bg-green-50');
        label.classList.add('border-gray-300', 'bg-white');
        console.log(`[LiveScorecard] ❌ Deselected: ${checkbox.value}`);
    }

    // Log all selected formats
    const selectedFormats = Array.from(
        document.querySelectorAll('.scoring-format-checkbox:checked')
    ).map(cb => cb.value);
    console.log(`[LiveScorecard] Selected formats (${selectedFormats.length}):`, selectedFormats);

    // Show/hide skins value input
    const skinsSection = document.getElementById('skinsValueSection');
    if (skinsSection) {
        if (selectedFormats.includes('skins')) {
            skinsSection.style.display = 'block';
        } else {
            skinsSection.style.display = 'none';
        }
    }

    // Show/hide scramble configuration
    const scrambleSection = document.getElementById('scrambleConfigSection');
    if (scrambleSection) {
        if (selectedFormats.includes('scramble')) {
            scrambleSection.style.display = 'block';
        } else {
            scrambleSection.style.display = 'none';
        }
    }
};

// Toggle all scoring formats on/off
window.toggleAllFormats = function() {
    const checkboxes = document.querySelectorAll('.scoring-format-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);

    checkboxes.forEach(checkbox => {
        const label = checkbox.closest('.scoring-format-label');
        checkbox.checked = !allChecked;

        if (checkbox.checked) {
            label.classList.remove('border-gray-300', 'bg-white');
            label.classList.add('border-green-500', 'bg-green-50');
        } else {
            label.classList.remove('border-green-500', 'bg-green-50');
            label.classList.add('border-gray-300', 'bg-white');
        }
    });

    const count = Array.from(checkboxes).filter(cb => cb.checked).length;
    console.log(`[LiveScorecard] ${allChecked ? 'Deselected all' : 'Selected all'} formats (${count} active)`);
};

// ============================================
// SCRAMBLE HANDICAP CALCULATOR
// ============================================

window.updateScrambleHcpMethod = function() {
    const selected = document.querySelector('input[name="scrambleHcpMethod"]:checked')?.value;

    // Hide all method sections
    document.getElementById('scrambleHcpUSGA').style.display = 'none';
    document.getElementById('scrambleHcpPercentage').style.display = 'none';
    document.getElementById('scrambleHcpManual').style.display = 'none';

    // Show selected method
    if (selected === 'usga') {
        document.getElementById('scrambleHcpUSGA').style.display = 'block';
    } else if (selected === 'percentage') {
        document.getElementById('scrambleHcpPercentage').style.display = 'block';
    } else if (selected === 'manual') {
        document.getElementById('scrambleHcpManual').style.display = 'block';
    }

    // Update radio button styling
    document.querySelectorAll('input[name="scrambleHcpMethod"]').forEach(radio => {
        const label = radio.closest('label');
        if (radio.checked) {
            label.classList.remove('border-gray-300', 'bg-white');
            label.classList.add('border-green-500', 'bg-green-50');
        } else {
            label.classList.remove('border-green-500', 'bg-green-50');
            label.classList.add('border-gray-300', 'bg-white');
        }
    });

    // Recalculate preview
    calculateScrambleHcp();
};

window.calculateScrambleHcp = function() {
    const players = window.LiveScorecardManager?.players || [];
    const previewValue = document.getElementById('scrambleHcpPreviewValue');
    const previewDetails = document.getElementById('scrambleHcpPreviewDetails');

    if (!players || players.length === 0) {
        previewValue.textContent = '-';
        previewDetails.textContent = 'Add players to calculate';
        return;
    }

    const method = document.querySelector('input[name="scrambleHcpMethod"]:checked')?.value;
    // CRITICAL FIX: Convert handicaps to numbers to avoid string concatenation bug
    const handicaps = players.map(p => parseFloat(p.handicap) || 0);
    const sortedHandicaps = [...handicaps].sort((a, b) => a - b);
    let teamHcp = 0;
    let details = '';

    console.log('[Scramble HCP] Players:', players.map(p => `${p.name} (HCP ${p.handicap})`));
    console.log('[Scramble HCP] Handicaps as numbers:', handicaps);
    console.log('[Scramble HCP] Sorted handicaps:', sortedHandicaps);

    if (method === 'usga') {
        // USGA Standard formulas
        const teamSize = players.length;
        if (teamSize === 2) {
            teamHcp = (sortedHandicaps[0] * 0.35) + (sortedHandicaps[1] * 0.15);
            details = `${sortedHandicaps[0]} × 35% + ${sortedHandicaps[1]} × 15%`;
        } else if (teamSize === 3) {
            teamHcp = (sortedHandicaps[0] * 0.30) + (sortedHandicaps[1] * 0.20) + (sortedHandicaps[2] * 0.10);
            details = `${sortedHandicaps[0]} × 30% + ${sortedHandicaps[1]} × 20% + ${sortedHandicaps[2]} × 10%`;
        } else if (teamSize === 4) {
            teamHcp = (sortedHandicaps[0] * 0.25) + (sortedHandicaps[1] * 0.20) + (sortedHandicaps[2] * 0.15) + (sortedHandicaps[3] * 0.10);
            details = `${sortedHandicaps[0]} × 25% + ${sortedHandicaps[1]} × 20% + ${sortedHandicaps[2]} × 15% + ${sortedHandicaps[3]} × 10%`;
        } else {
            const avgHandicap = sortedHandicaps.reduce((sum, h) => sum + h, 0) / sortedHandicaps.length;
            teamHcp = avgHandicap * 0.20;
            details = `Average (${avgHandicap.toFixed(1)}) × 20%`;
        }
    } else if (method === 'percentage') {
        // Percentage REDUCTION of average handicap
        const percent = parseFloat(document.getElementById('scrambleHcpPercent')?.value) || 25;
        const avgHcp = handicaps.reduce((sum, h) => sum + h, 0) / handicaps.length;
        teamHcp = avgHcp * (100 - percent) / 100;
        details = `Average ${avgHcp.toFixed(1)} minus ${percent}% = ${avgHcp.toFixed(1)} × ${100-percent}%`;
        console.log('[Scramble HCP] Percentage calc: avg =', avgHcp, ', percent =', percent, ', teamHcp =', teamHcp);
    } else if (method === 'manual') {
        // Manual entry
        teamHcp = parseFloat(document.getElementById('scrambleHcpManualValue')?.value) || 0;
        details = `Manually entered by organizer`;
    }

    const playingHcp = Math.round(teamHcp);
    previewValue.textContent = `${teamHcp.toFixed(1)} (Playing: ${playingHcp})`;
    previewDetails.textContent = details;

    console.log(`[Scramble HCP] Method: ${method}, Team HCP: ${teamHcp.toFixed(1)}, Playing: ${playingHcp}`);
};

console.log('[LiveScorecard] ✅ Format checkbox handlers loaded and ready');

// Initialize global instance
window.LiveScorecardManager = new LiveScorecardSystem();
    </script>

    <script>
    // ============================================
    // SOCIETY ORGANIZER SYSTEM - UI Management
    // ============================================
// ============================================
// SOCIETY ORGANIZER SYSTEM - UI Management
// ============================================

class SocietyOrganizerManager {
    constructor() {
        this.currentEvent = null;
        this.events = [];
        this.currentRosterEvent = null;
        this.societyProfile = null;
        this.tempLogoData = null;
    }

    async init() {
        console.log('[SocietyOrganizer] Initializing...');
        await this.loadSocietyProfile();
        await this.loadEvents();
        this.subscribeToChanges();

        // Show Events tab by default
        setTimeout(() => {
            if (typeof showOrganizerTab === 'function') {
                showOrganizerTab('events');
            }
        }, 100);
    }

    async loadEvents() {
        try {
            const organizerId = AppState.currentUser?.lineUserId;
            if (!organizerId) {
                console.error('[SocietyOrganizer] No organizer ID');
                return;
            }

            console.log('[SocietyOrganizer] Loading events with stats and revenue...');
            const startTime = Date.now();

            // Use enhanced method that includes registration statistics
            const events = await SocietyGolfDB.getOrganizerEventsWithStats(organizerId);

            // Enrich each event with payment stats
            const enrichedEvents = await Promise.all(
                events.map(async (event) => {
                    const paymentStats = await SocietyGolfDB.getEventPaymentStats(event.id);
                    return {
                        ...event,
                        revenue: paymentStats
                    };
                })
            );

            this.events = enrichedEvents;

            const endTime = Date.now();
            console.log(`[SocietyOrganizer] ⚡ Loaded ${this.events.length} events with stats and revenue in ${endTime - startTime}ms`);

            this.renderEventsList();
        } catch (error) {
            console.error('[SocietyOrganizer] Error loading events:', error);
            NotificationManager.show('Failed to load events', 'error');
        }
    }

    async refreshEvents() {
        console.log('[SocietyOrganizer] 🔄 Manual refresh triggered');
        NotificationManager.show('Refreshing events...', 'info', 2000);
        await this.loadEvents();
        NotificationManager.show('✅ Events updated!', 'success', 2000);
    }

    // ============================================
    // PLAYER DIRECTORY MANAGEMENT
    // ============================================

    async loadPlayerDirectory() {
        try {
            if (!this.societyProfile) {
                console.error('[PlayerDirectory] No society profile loaded');
                return;
            }

            const societyName = this.societyProfile.society_name;
            const organizerId = AppState.currentUser?.lineUserId;

            console.log('[PlayerDirectory] Loading members for:', societyName);

            // Get all society members
            const members = await SocietyGolfDB.getSocietyMembers(societyName, organizerId);

            // Get full profile data for each member
            const memberIds = members.map(m => m.golfer_id);
            const profiles = await window.SupabaseDB.getProfilesByIds(memberIds);

            // Merge member data with profile data
            const enrichedMembers = members.map(member => {
                const profile = profiles.find(p => p.line_user_id === member.golfer_id);
                const golfInfo = profile?.profile_data?.golfInfo || {};

                return {
                    ...member,
                    playerName: profile?.name || 'Unknown',
                    handicap: golfInfo.handicap ? parseFloat(golfInfo.handicap) : 36,
                    homeClub: golfInfo.homeClub || '',
                    email: profile?.email || '',
                    phone: profile?.phone || ''
                };
            });

            this.renderPlayerDirectory(enrichedMembers);
            this.updatePlayerDirectoryStats(enrichedMembers);

        } catch (error) {
            console.error('[PlayerDirectory] Error loading:', error);
            NotificationManager.show('Failed to load player directory', 'error');
        }
    }

    renderPlayerDirectory(members) {
        const tbody = document.getElementById('playerDirectoryTable');
        if (!tbody) return;

        if (!members || members.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                        <span class="material-symbols-outlined text-5xl text-gray-300">group_off</span>
                        <p class="mt-2">No members yet. Click "Add Player" to get started.</p>
                    </td>
                </tr>
            `;
            return;
        }

        // Sort by member number
        members.sort((a, b) => {
            const numA = parseInt(a.member_number?.split('-')[1] || '9999');
            const numB = parseInt(b.member_number?.split('-')[1] || '9999');
            return numA - numB;
        });

        tbody.innerHTML = members.map(member => {
            const joinedDate = new Date(member.joined_at).toLocaleDateString();
            const statusColor = {
                'active': 'bg-green-100 text-green-700',
                'inactive': 'bg-gray-100 text-gray-700',
                'suspended': 'bg-red-100 text-red-700',
                'pending': 'bg-yellow-100 text-yellow-700'
            }[member.status] || 'bg-gray-100 text-gray-700';

            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="font-mono text-sm font-medium text-gray-900">${member.member_number || '-'}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <div class="flex-shrink-0 h-10 w-10 bg-green-100 rounded-full flex items-center justify-center">
                                <span class="material-symbols-outlined text-green-600 text-sm">person</span>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900">${member.playerName}</div>
                                ${member.is_primary_society ? '<span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">PRIMARY</span>' : ''}
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${Math.round(member.handicap)}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${member.homeClub || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${joinedDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColor}">${member.status}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex items-center justify-end gap-2">
                            <button onclick="SocietyOrganizerSystem.togglePrimarySociety('${member.golfer_id}', ${!member.is_primary_society})"
                                class="text-blue-600 hover:text-blue-900" title="${member.is_primary_society ? 'Remove as primary' : 'Set as primary'}">
                                <span class="material-symbols-outlined text-sm">${member.is_primary_society ? 'star' : 'star_outline'}</span>
                            </button>
                            <button onclick="SocietyOrganizerSystem.editMember('${member.golfer_id}')"
                                class="text-gray-600 hover:text-gray-900" title="Edit">
                                <span class="material-symbols-outlined text-sm">edit</span>
                            </button>
                            <button onclick="SocietyOrganizerSystem.removeMemberFromDirectory('${member.golfer_id}', '${member.playerName.replace(/'/g, "\\'")}')"
                                class="text-red-600 hover:text-red-900" title="Remove">
                                <span class="material-symbols-outlined text-sm">person_remove</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    updatePlayerDirectoryStats(members) {
        // Total members
        document.getElementById('playerDirTotalMembers').textContent = members.length;

        // Active members
        const activeCount = members.filter(m => m.status === 'active').length;
        document.getElementById('playerDirActiveMembers').textContent = activeCount;

        // Monthly joins
        const thisMonth = new Date();
        thisMonth.setDate(1);
        const monthlyJoins = members.filter(m => new Date(m.joined_at) >= thisMonth).length;
        document.getElementById('playerDirMonthlyJoins').textContent = monthlyJoins;

        // Average handicap
        if (members.length > 0) {
            const avgHandicap = members.reduce((sum, m) => sum + m.handicap, 0) / members.length;
            document.getElementById('playerDirAvgHandicap').textContent = avgHandicap.toFixed(1);
        } else {
            document.getElementById('playerDirAvgHandicap').textContent = '-';
        }
    }

    async refreshPlayerDirectory() {
        console.log('[PlayerDirectory] Refreshing...');
        NotificationManager.show('Refreshing player directory...', 'info', 2000);
        await this.loadPlayerDirectory();
        NotificationManager.show('✅ Player directory updated!', 'success', 2000);
    }

    async showAddPlayerModal() {
        // Re-use the existing manual player modal but in directory mode
        this.directoryAddMode = true;
        document.getElementById('manualPlayerModal').style.display = 'flex';
        document.getElementById('playerSearchInput').value = '';
        document.getElementById('playerSearchInput').focus();
    }

    async addPlayerToDirectory(playerId, playerName, handicap) {
        try {
            if (!this.societyProfile) {
                NotificationManager.show('Society profile not loaded', 'error');
                return;
            }

            const societyName = this.societyProfile.society_name;
            const organizerId = AppState.currentUser?.lineUserId;

            // Generate member number
            const memberNumber = await this.generateMemberNumber(societyName);

            // Add to society members table
            await SocietyGolfDB.addSocietyMember(societyName, organizerId, playerId, {
                memberNumber: memberNumber,
                status: 'active'
            });

            NotificationManager.show(`✅ ${playerName} added as member ${memberNumber}`, 'success');

            // Close modal and refresh
            document.getElementById('manualPlayerModal').style.display = 'none';
            this.directoryAddMode = false;
            await this.loadPlayerDirectory();

        } catch (error) {
            console.error('[PlayerDirectory] Error adding player:', error);
            NotificationManager.show('Failed to add player to directory', 'error');
        }
    }

    async generateMemberNumber(societyName) {
        try {
            // Get society prefix from society name
            const prefix = this.getSocietyPrefix(societyName);

            // Get all existing members to find highest number
            const members = await SocietyGolfDB.getSocietyMembers(societyName);

            let maxNumber = 0;
            members.forEach(member => {
                if (member.member_number && member.member_number.startsWith(prefix)) {
                    const num = parseInt(member.member_number.split('-')[1]);
                    if (!isNaN(num) && num > maxNumber) {
                        maxNumber = num;
                    }
                }
            });

            const nextNumber = maxNumber + 1;
            return `${prefix}-${String(nextNumber).padStart(3, '0')}`;

        } catch (error) {
            console.error('[PlayerDirectory] Error generating member number:', error);
            return 'MEMBER-001';
        }
    }

    getSocietyPrefix(societyName) {
        // Generate prefix from society name
        // Examples: "Travelers Rest" -> "TRGG", "Padia Sports Club" -> "PSC"
        const words = societyName.trim().split(/\s+/);

        if (words.length === 1) {
            return words[0].substring(0, 4).toUpperCase();
        } else if (words.length === 2) {
            return (words[0].substring(0, 2) + words[1].substring(0, 2)).toUpperCase();
        } else {
            // Take first letter of each word
            return words.map(w => w[0]).join('').toUpperCase().substring(0, 4);
        }
    }

    async togglePrimarySociety(golferId, setPrimary) {
        try {
            if (!this.societyProfile) return;

            const societyName = this.societyProfile.society_name;

            if (setPrimary) {
                await SocietyGolfDB.setPrimarySociety(golferId, societyName);
                NotificationManager.show('✅ Set as primary society', 'success');
            } else {
                // Remove primary flag
                await window.SupabaseDB.client
                    .from('society_members')
                    .update({ is_primary_society: false })
                    .eq('golfer_id', golferId)
                    .eq('society_name', societyName);
                NotificationManager.show('✅ Removed as primary society', 'success');
            }

            await this.loadPlayerDirectory();

        } catch (error) {
            console.error('[PlayerDirectory] Error toggling primary:', error);
            NotificationManager.show('Failed to update primary society', 'error');
        }
    }

    async removeMemberFromDirectory(golferId, playerName) {
        if (!confirm(`Remove ${playerName} from the member directory?`)) return;

        try {
            if (!this.societyProfile) return;

            const societyName = this.societyProfile.society_name;
            await SocietyGolfDB.removeSocietyMember(societyName, golferId);

            NotificationManager.show(`✅ ${playerName} removed from directory`, 'success');
            await this.loadPlayerDirectory();

        } catch (error) {
            console.error('[PlayerDirectory] Error removing member:', error);
            NotificationManager.show('Failed to remove member', 'error');
        }
    }

    async editMember(golferId) {
        // Future enhancement: Show edit modal
        NotificationManager.show('Edit member feature coming soon', 'info');
    }

    // =====================================================
    // PAYMENT TRACKING
    // =====================================================

    async editPlayerFee(registrationId, playerId, currentFee) {
        try {
            const feeInput = prompt(
                'Enter the total fee for this player (in Baht):',
                currentFee.toFixed(2)
            );

            if (feeInput === null) {
                // User cancelled
                return;
            }

            const newFee = parseFloat(feeInput);
            if (isNaN(newFee) || newFee < 0) {
                NotificationManager.show('Invalid fee amount', 'error');
                return;
            }

            // Update the registration's total_fee
            await SocietyGolfDB.updateRegistrationFee(registrationId, newFee);

            NotificationManager.show('✅ Fee updated', 'success');

            // Refresh roster to show updated fee
            await this.viewRoster(this.currentRosterEvent.id);

            // Refresh events list to update revenue display
            await this.loadEvents();

        } catch (error) {
            console.error('[EditFee] Error:', error);
            NotificationManager.show('Failed to update fee', 'error');
        }
    }

    async togglePayment(eventId, playerId, markAsPaid) {
        console.log('[PaymentToggle] Called with:', { eventId, playerId, markAsPaid });
        try {
            const organizerId = AppState.currentUser?.lineUserId;
            if (!organizerId) {
                console.error('[PaymentToggle] No organizer ID');
                NotificationManager.show('Not authorized', 'error');
                return;
            }

            console.log('[PaymentToggle] Organizer ID:', organizerId);

            if (markAsPaid) {
                console.log('[PaymentToggle] Marking as paid...');
                // Get booking to find total fee
                const bookings = await SocietyGolfDB.getEventBookingsWithPayment(eventId);
                const booking = bookings.find(b => b.player_id === playerId);

                if (!booking) {
                    NotificationManager.show('Booking not found', 'error');
                    return;
                }

                let totalFee = booking.total_fee || 0;

                // If no fee is set, prompt organizer to enter it
                if (totalFee === 0) {
                    const feeInput = prompt('Enter the total fee for this player (in Baht):', '2575');
                    if (feeInput === null) {
                        // User cancelled
                        return;
                    }
                    totalFee = parseFloat(feeInput) || 0;
                    if (totalFee <= 0) {
                        NotificationManager.show('Invalid fee amount', 'error');
                        return;
                    }

                    // Save the fee first
                    await SocietyGolfDB.updateRegistrationFee(booking.id, totalFee);
                }

                await SocietyGolfDB.markPlayerPaid(eventId, playerId, totalFee, organizerId);
                NotificationManager.show('✅ Marked as paid', 'success');
            } else {
                await SocietyGolfDB.markPlayerUnpaid(eventId, playerId);
                NotificationManager.show('✅ Marked as unpaid', 'success');
            }

            // Refresh roster to show updated payment status
            await this.viewRoster(eventId);

            // Refresh events list to update revenue display
            await this.loadEvents();

        } catch (error) {
            console.error('[PaymentToggle] Error:', error);
            NotificationManager.show('Failed to update payment status', 'error');
        }
    }

    generateRecurringEvents(baseEventData) {
        const recurringEvents = [];
        const startDate = new Date(baseEventData.date);

        // Determine how many instances to generate
        let maxInstances = 52; // Default: 1 year of weekly events
        if (baseEventData.recurEndType === 'count' && baseEventData.recurCount) {
            maxInstances = baseEventData.recurCount - 1; // -1 because original event is already created
        } else if (baseEventData.recurEndType === 'until' && baseEventData.recurUntil) {
            const untilDate = new Date(baseEventData.recurUntil);
            const daysDiff = Math.ceil((untilDate - startDate) / (1000 * 60 * 60 * 24));
            if (baseEventData.recurFrequency === 'weekly') {
                maxInstances = Math.ceil(daysDiff / 7);
            } else if (baseEventData.recurFrequency === 'biweekly') {
                maxInstances = Math.ceil(daysDiff / 14);
            } else if (baseEventData.recurFrequency === 'monthly') {
                maxInstances = Math.ceil(daysDiff / 30);
            }
        }

        for (let i = 0; i < maxInstances; i++) {
            let currentDate = new Date(startDate);

            // Calculate next occurrence based on frequency
            if (baseEventData.recurFrequency === 'weekly') {
                currentDate.setDate(startDate.getDate() + (7 * (i + 1)));
            } else if (baseEventData.recurFrequency === 'biweekly') {
                currentDate.setDate(startDate.getDate() + (14 * (i + 1)));
            } else if (baseEventData.recurFrequency === 'monthly') {
                currentDate.setMonth(startDate.getMonth() + (i + 1));
            }

            // Check if we've passed the end date
            if (baseEventData.recurEndType === 'until' && baseEventData.recurUntil) {
                const untilDate = new Date(baseEventData.recurUntil);
                if (currentDate > untilDate) break;
            }

            // Create date string in YYYY-MM-DD format
            const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;

            // Calculate cutoff datetime for this instance (same time, different date)
            let cutoffISO = null;
            if (baseEventData.cutoff) {
                const originalCutoff = new Date(baseEventData.cutoff);
                const newCutoff = new Date(currentDate);
                newCutoff.setHours(originalCutoff.getHours(), originalCutoff.getMinutes(), 0, 0);
                cutoffISO = newCutoff.toISOString().slice(0, 16) + ':00';
            }

            // Create a new event data object for this recurrence
            const recurEvent = {
                ...baseEventData,
                id: undefined, // Let DB generate new ID
                date: dateStr,
                cutoff: cutoffISO,
                recurring: false, // Each instance is NOT recurring itself
                recurFrequency: null,
                recurDayOfWeek: null,
                recurMonthlyPattern: null,
                recurEndType: null,
                recurUntil: null,
                recurCount: null
            };

            recurringEvents.push(recurEvent);
        }

        return recurringEvents;
    }

    subscribeToChanges() {
        // Subscribe to society_events table changes
        SocietyGolfDB.subscribeToEvents((payload) => {
            console.log('[SocietyOrganizer] Event change:', payload);
            this.loadEvents(); // Reload events when changes occur
        });

        // Subscribe to ALL registration changes for real-time stats updates
        const registrationSubscription = window.SupabaseDB.client
            .channel('all_registrations_changes')
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'event_registrations'
            }, (payload) => {
                console.log('[SocietyOrganizer] 🔄 Registration change detected:', payload.eventType);
                // Reload events to update statistics on cards
                this.loadEvents();
            })
            .subscribe();

        // Subscribe to ALL waitlist changes for real-time stats updates
        const waitlistSubscription = window.SupabaseDB.client
            .channel('all_waitlist_changes')
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'event_waitlist'
            }, (payload) => {
                console.log('[SocietyOrganizer] 🔄 Waitlist change detected:', payload.eventType);
                // Reload events to update statistics on cards
                this.loadEvents();
            })
            .subscribe();

        console.log('[SocietyOrganizer] ✅ Real-time subscriptions active (events, registrations, waitlist)');
    }

    // =====================================================
    // EVENT FORM MANAGEMENT
    // =====================================================

    showEventForm(eventId = null) {
        const form = document.getElementById('eventFormContainer');
        const title = document.getElementById('eventFormTitle');

        if (eventId) {
            // Edit mode
            const event = this.events.find(e => e.id === eventId);
            if (!event) return;

            title.textContent = 'Edit Event';
            this.currentEvent = event;

            // Populate form
            document.getElementById('eventName').value = event.name || '';
            document.getElementById('eventDate').value = event.date || '';
            document.getElementById('eventStartTime').value = event.startTime || '';
            document.getElementById('eventCutoff').value = event.cutoff?.substring(0, 16) || '';
            document.getElementById('eventMaxPlayers').value = event.maxPlayers || '';
            document.getElementById('eventCourse').value = event.courseName || '';
            document.getElementById('eventFormat').value = event.eventFormat || 'strokeplay';

            // NEW: Member/Non-Member fee structure (with backwards compatibility)
            document.getElementById('eventMemberFee').value = event.memberFee || event.baseFee || 0;
            document.getElementById('eventNonMemberFee').value = event.nonMemberFee || 0;
            document.getElementById('eventTransportFee').value = event.transportFee || 0;
            document.getElementById('eventCompetitionFee').value = event.competitionFee || 0;
            document.getElementById('eventOtherFee').value = event.otherFee || 0;

            document.getElementById('eventAutoWaitlist').checked = event.autoWaitlist || false;
            document.getElementById('eventNotes').value = event.notes || '';

            // Recurrence fields
            document.getElementById('eventRecurring').checked = event.recurring || false;
            if (event.recurring) {
                document.getElementById('eventRecurFrequency').value = event.recurFrequency || 'weekly';
                document.getElementById('eventRecurDayOfWeek').value = event.recurDayOfWeek || '5'; // Friday
                document.getElementById('eventRecurMonthlyPattern').value = event.recurMonthlyPattern || 'first_friday';
                document.getElementById('eventRecurEndType').value = event.recurEndType || 'until';
                document.getElementById('eventRecurUntil').value = event.recurUntil || '';
                document.getElementById('eventRecurCount').value = event.recurCount || '10';
                toggleRecurringOptions();
                updateRecurringPattern();
                updateRecurEndOptions();
            } else {
                document.getElementById('recurringOptions').style.display = 'none';
            }
        } else {
            // Create mode
            title.textContent = 'Create New Event';
            this.currentEvent = null;

            // Clear form
            document.getElementById('eventName').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventStartTime').value = '';
            document.getElementById('eventCutoff').value = '';
            document.getElementById('eventMaxPlayers').value = '40';
            document.getElementById('eventCourse').value = '';
            document.getElementById('eventFormat').value = 'strokeplay';

            // NEW: Member/Non-Member fee structure
            document.getElementById('eventMemberFee').value = '0';
            document.getElementById('eventNonMemberFee').value = '0';
            document.getElementById('eventTransportFee').value = '0';
            document.getElementById('eventCompetitionFee').value = '0';
            document.getElementById('eventOtherFee').value = '0';

            document.getElementById('eventAutoWaitlist').checked = true; // Default to enabled
            document.getElementById('eventNotes').value = '';

            // Clear recurrence fields
            document.getElementById('eventRecurring').checked = false;
            document.getElementById('eventRecurFrequency').value = 'weekly';
            document.getElementById('eventRecurDayOfWeek').value = '5'; // Friday default
            document.getElementById('eventRecurMonthlyPattern').value = 'first_friday';
            document.getElementById('eventRecurEndType').value = 'until';
            document.getElementById('eventRecurUntil').value = '';
            document.getElementById('eventRecurCount').value = '10';
            document.getElementById('recurringOptions').style.display = 'none';
        }

        form.style.display = 'block';
        form.scrollIntoView({ behavior: 'smooth' });
    }

    hideEventForm() {
        document.getElementById('eventFormContainer').style.display = 'none';
        this.currentEvent = null;
    }

    async saveEvent() {
        console.log('[SocietyOrganizer] 🎯 saveEvent called');
        try {
            const isRecurring = document.getElementById('eventRecurring').checked;
            const cutoffValue = document.getElementById('eventCutoff').value;
            const cutoffISO = cutoffValue ? cutoffValue + ':00' : null;

            const eventData = {
                name: document.getElementById('eventName').value.trim(),
                date: document.getElementById('eventDate').value,
                startTime: document.getElementById('eventStartTime').value || null,
                cutoff: cutoffISO,
                maxPlayers: parseInt(document.getElementById('eventMaxPlayers').value) || null,
                courseName: document.getElementById('eventCourse').value.trim(),
                eventFormat: document.getElementById('eventFormat').value,
                // NEW: Member/Non-Member pricing
                memberFee: parseFloat(document.getElementById('eventMemberFee').value) || 0,
                nonMemberFee: parseFloat(document.getElementById('eventNonMemberFee').value) || 0,
                // Optional add-on fees
                transportFee: parseFloat(document.getElementById('eventTransportFee').value) || 0,
                competitionFee: parseFloat(document.getElementById('eventCompetitionFee').value) || 0,
                otherFee: parseFloat(document.getElementById('eventOtherFee').value) || 0,
                // Keep old fields for backwards compatibility (will be deprecated)
                baseFee: parseFloat(document.getElementById('eventMemberFee').value) || 0,
                autoWaitlist: document.getElementById('eventAutoWaitlist').checked,
                notes: document.getElementById('eventNotes').value.trim(),
                organizerId: AppState.currentUser?.lineUserId,
                organizerName: AppState.currentUser?.name,
                // Recurrence fields
                recurring: isRecurring,
                recurFrequency: isRecurring ? document.getElementById('eventRecurFrequency').value : null,
                recurDayOfWeek: isRecurring && document.getElementById('eventRecurFrequency').value !== 'monthly'
                    ? parseInt(document.getElementById('eventRecurDayOfWeek').value) : null,
                recurMonthlyPattern: isRecurring && document.getElementById('eventRecurFrequency').value === 'monthly'
                    ? document.getElementById('eventRecurMonthlyPattern').value : null,
                recurEndType: isRecurring ? document.getElementById('eventRecurEndType').value : null,
                recurUntil: isRecurring && document.getElementById('eventRecurEndType').value === 'until'
                    ? document.getElementById('eventRecurUntil').value : null,
                recurCount: isRecurring && document.getElementById('eventRecurEndType').value === 'count'
                    ? parseInt(document.getElementById('eventRecurCount').value) : null
            };

            console.log('[SocietyOrganizer] Event data collected:', eventData);

            // Validation
            if (!eventData.name) {
                console.warn('[SocietyOrganizer] ⚠️ Validation failed: No event name');
                NotificationManager.show('❌ Please enter an event name', 'error');
                // Highlight the empty field
                const nameField = document.getElementById('eventName');
                nameField.focus();
                nameField.style.borderColor = '#ef4444';
                nameField.style.borderWidth = '2px';
                setTimeout(() => {
                    nameField.style.borderColor = '';
                    nameField.style.borderWidth = '';
                }, 3000);
                return;
            }
            if (!eventData.date) {
                console.warn('[SocietyOrganizer] ⚠️ Validation failed: No event date');
                NotificationManager.show('❌ Please select an event date', 'error');
                // Highlight the empty field
                const dateField = document.getElementById('eventDate');
                dateField.focus();
                dateField.style.borderColor = '#ef4444';
                dateField.style.borderWidth = '2px';
                setTimeout(() => {
                    dateField.style.borderColor = '';
                    dateField.style.borderWidth = '';
                }, 3000);
                return;
            }
            if (!eventData.courseName) {
                console.warn('[SocietyOrganizer] ⚠️ Validation failed: No golf course selected');
                NotificationManager.show('❌ Please select a golf course', 'error');
                // Highlight the empty field
                const courseField = document.getElementById('eventCourse');
                courseField.focus();
                courseField.style.borderColor = '#ef4444';
                courseField.style.borderWidth = '2px';
                setTimeout(() => {
                    courseField.style.borderColor = '';
                    courseField.style.borderWidth = '';
                }, 3000);
                return;
            }

            if (this.currentEvent) {
                // Update existing event
                console.log('[SocietyOrganizer] 📝 Updating event:', this.currentEvent.id);
                await SocietyGolfDB.updateEvent(this.currentEvent.id, eventData);
                console.log('[SocietyOrganizer] ✅ Event updated in database');
                NotificationManager.show('Event updated successfully', 'success');
            } else {
                // Create new event
                console.log('[SocietyOrganizer] ➕ Creating new event');
                await SocietyGolfDB.createEvent(eventData);
                console.log('[SocietyOrganizer] ✅ Event created in database');

                // If recurring, create additional events in the database
                if (isRecurring) {
                    const recurringEvents = this.generateRecurringEvents(eventData);
                    console.log(`[SocietyOrganizer] Creating ${recurringEvents.length} recurring events...`);

                    for (const recurEvent of recurringEvents) {
                        await SocietyGolfDB.createEvent(recurEvent);
                    }

                    NotificationManager.show(`Event created with ${recurringEvents.length} recurring instances`, 'success', 3000);
                } else {
                    NotificationManager.show('Event created successfully', 'success');
                }
            }

            console.log('[SocietyOrganizer] Hiding form...');
            this.hideEventForm();
            console.log('[SocietyOrganizer] Reloading events...');
            await this.loadEvents();
            console.log('[SocietyOrganizer] ✅ Events reloaded successfully');
        } catch (error) {
            console.error('[SocietyOrganizer] ❌ Error saving event:', error);
            console.error('[SocietyOrganizer] Error message:', error.message);
            console.error('[SocietyOrganizer] Error code:', error.code);
            console.error('[SocietyOrganizer] Error details:', error.details);
            console.error('[SocietyOrganizer] Error hint:', error.hint);
            console.error('[SocietyOrganizer] Error stack:', error.stack);
            console.error('[SocietyOrganizer] Full error:', JSON.stringify(error, null, 2));
            NotificationManager.show('Failed to save event: ' + error.message, 'error');
        }
    }

    async deleteEvent(eventId) {
        if (!confirm('Are you sure you want to delete this event? All registrations and pairings will be removed.')) {
            return;
        }

        try {
            await SocietyGolfDB.deleteEvent(eventId);
            NotificationManager.show('Event deleted', 'success');
            await this.loadEvents();
        } catch (error) {
            console.error('[SocietyOrganizer] Error deleting event:', error);
            NotificationManager.show('Failed to delete event', 'error');
        }
    }

    // =====================================================
    // EVENTS LIST RENDERING
    // =====================================================

    renderEventsList() {
        const container = document.getElementById('eventsListContainer');
        const emptyState = document.getElementById('eventsEmptyState');

        if (!this.events || this.events.length === 0) {
            container.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';
        container.innerHTML = this.events.map(event => this.renderEventCard(event)).join('');
    }

    renderEventCard(event) {
        const eventDate = event.date ? new Date(event.date).toLocaleDateString() : '-';

        // Format start time for display (HH:MM to 12-hour format)
        let startTimeDisplay = '';
        if (event.startTime) {
            const [hours, minutes] = event.startTime.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            startTimeDisplay = `${hour12}:${minutes} ${ampm}`;
        }

        // Format event format for display
        const formatLabels = {
            'strokeplay': 'Stroke Play',
            '2man_scramble': '2-Man Scramble',
            '4man_scramble': '4-Man Scramble',
            'fourball': 'Four Ball',
            'stableford': 'Stableford',
            'private': 'Private Game',
            'other': 'Other'
        };
        const formatDisplay = formatLabels[event.eventFormat] || 'Stroke Play';

        // Format cutoff date/time for display
        let cutoffDate = '-';
        let cutoffTime = '';
        if (event.cutoff) {
            const cutoffStr = event.cutoff.substring(0, 16);
            const [datePart, timePart] = cutoffStr.split('T');

            if (datePart && timePart) {
                const [year, month, day] = datePart.split('-');
                const [hours, minutes] = timePart.split(':');

                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const monthName = monthNames[parseInt(month) - 1];
                cutoffDate = `${monthName} ${parseInt(day)}, ${year}`;

                const hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const hour12 = hour % 12 || 12;
                cutoffTime = `${hour12}:${minutes} ${ampm}`;
            }
        }

        // ENHANCED: Registration statistics
        const stats = event.stats || { registered: 0, waitlist: 0, transportCount: 0, competitionCount: 0, paidCount: 0, revenue: 0 };
        const maxPlayers = event.maxPlayers || 0;
        const registered = stats.registered;
        const percentage = maxPlayers > 0 ? Math.round((registered / maxPlayers) * 100) : 0;
        const spotsRemaining = maxPlayers > 0 ? maxPlayers - registered : '∞';

        // Status badge with more states
        const now = new Date();
        let isPastCutoff = false;
        let isFull = false;
        if (event.cutoff) {
            const cutoffLocal = new Date(event.cutoff.substring(0, 16));
            isPastCutoff = now > cutoffLocal;
        }
        if (maxPlayers > 0 && registered >= maxPlayers) {
            isFull = true;
        }

        let statusBadge = '';
        if (isFull) {
            statusBadge = '<span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full font-semibold">Full</span>';
        } else if (isPastCutoff) {
            statusBadge = '<span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full font-semibold">Closed</span>';
        } else {
            statusBadge = '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-semibold">Open</span>';
        }

        // Progress bar color based on fill percentage
        let progressBarColor = 'bg-green-500';
        if (percentage >= 90) {
            progressBarColor = 'bg-orange-500';
        } else if (percentage >= 100) {
            progressBarColor = 'bg-red-500';
        }

        // Society branding
        const societyLogo = this.societyProfile?.societyLogo
            ? `<img src="${this.societyProfile.societyLogo}" class="w-12 h-12 rounded-full object-cover border-2 border-white" alt="Society Logo">`
            : '<div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center border-2 border-white"><span class="material-symbols-outlined text-white text-2xl">groups</span></div>';
        const societyName = this.societyProfile?.societyName || 'Golf Society';

        return `
            <div class="bg-white rounded-2xl shadow-lg border overflow-hidden hover:shadow-xl transition-shadow">
                <!-- Society Branding Banner -->
                <div class="bg-gradient-to-r from-gray-800 to-gray-600 text-white px-4 py-2">
                    <div class="flex items-center space-x-3">
                        ${societyLogo}
                        <div class="flex-1">
                            <div class="text-sm font-semibold">${societyName}</div>
                            <div class="text-xs text-gray-300">${formatDisplay}</div>
                        </div>
                    </div>
                </div>

                <!-- Event Details -->
                <div class="bg-gradient-to-r from-sky-600 to-sky-400 text-white p-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">${event.name}</h3>
                            <div class="text-sm text-sky-100 space-y-0.5">
                                ${startTimeDisplay ? `<div>🚐 Departure: ${startTimeDisplay}</div>` : ''}
                                <div>📅 ${eventDate}</div>
                                ${event.courseName ? `<div>⛳ ${event.courseName}</div>` : ''}
                            </div>
                        </div>
                        ${statusBadge}
                    </div>
                </div>

                <div class="p-4">
                    <!-- ENHANCED: Registration Statistics -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-3 border border-blue-100">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-semibold text-gray-700">📊 Registrations:</span>
                            <span class="text-lg font-bold text-gray-900">${registered}/${maxPlayers || '∞'} <span class="text-sm font-normal text-gray-600">(${percentage}%)</span></span>
                        </div>

                        <!-- Progress Bar -->
                        <div class="bg-gray-200 h-2 rounded-full mb-3 overflow-hidden">
                            <div class="${progressBarColor} h-2 rounded-full transition-all" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>

                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-gray-600">⏳ Waitlist:</span>
                                <span class="font-semibold text-gray-900">${stats.waitlist}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">🚐 Transport:</span>
                                <span class="font-semibold text-gray-900">${stats.transportCount}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">🏆 Competition:</span>
                                <span class="font-semibold text-gray-900">${stats.competitionCount}</span>
                            </div>
                        </div>
                    </div>

                    <!-- ENHANCED: Revenue Tracking -->
                    ${event.revenue ? `
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 mb-3 border border-green-100">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold text-gray-700">💰 Revenue</span>
                            <span class="text-xs font-medium ${
                                event.revenue.percentagePaid >= 80 ? 'text-green-600' :
                                event.revenue.percentagePaid >= 50 ? 'text-yellow-600' :
                                'text-red-600'
                            }">
                                ${event.revenue.paidCount}/${event.revenue.totalCount} Paid
                            </span>
                        </div>

                        <!-- Progress Bar -->
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                            <div class="h-2 rounded-full ${
                                event.revenue.percentagePaid >= 80 ? 'bg-green-500' :
                                event.revenue.percentagePaid >= 50 ? 'bg-yellow-500' :
                                'bg-red-500'
                            }" style="width: ${event.revenue.percentagePaid}%"></div>
                        </div>

                        <!-- Amount Display -->
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <span class="text-gray-600">Collected:</span>
                                <span class="font-bold text-green-700 ml-1">฿${event.revenue.totalPaid.toLocaleString()}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-gray-600">Expected:</span>
                                <span class="font-medium text-gray-900 ml-1">฿${event.revenue.totalExpected.toLocaleString()}</span>
                            </div>
                        </div>

                        ${event.revenue.totalUnpaid > 0 ? `
                            <div class="mt-2 text-xs text-red-600 font-medium">
                                ฿${event.revenue.totalUnpaid.toLocaleString()} outstanding
                            </div>
                        ` : `
                            <div class="mt-2 text-xs text-green-600 font-medium">
                                ✓ All payments collected
                            </div>
                        `}
                    </div>
                    ` : ''}

                    <!-- Event Details -->
                    <div class="bg-gray-50 rounded-lg p-3 mb-3 text-xs">
                        <div class="grid grid-cols-2 gap-x-3 gap-y-1.5">
                            <div class="text-gray-600">Registration Closes:</div>
                            <div class="font-medium text-gray-900">${cutoffDate} ${cutoffTime}</div>
                            <div class="text-gray-600">Spots Remaining:</div>
                            <div class="font-medium ${spotsRemaining === 0 ? 'text-red-600' : 'text-gray-900'}">${spotsRemaining}</div>
                        </div>
                    </div>

                    <!-- ENHANCED: Quick Actions -->
                    <div class="grid grid-cols-3 gap-2 mb-2">
                        <button onclick="SocietyOrganizerSystem.openRegistrationManager('${event.id}')" class="btn-primary text-xs py-2 flex items-center justify-center gap-1">
                            <span class="material-symbols-outlined text-sm">list_alt</span>
                            <span>Registrations</span>
                        </button>
                        <button onclick="SocietyOrganizerSystem.showEventForm('${event.id}')" class="btn-secondary text-xs py-2 flex items-center justify-center gap-1">
                            <span class="material-symbols-outlined text-sm">edit</span>
                            <span>Edit</span>
                        </button>
                        <button onclick="SocietyOrganizerSystem.exportEventCSV('${event.id}')" class="btn-secondary text-xs py-2 flex items-center justify-center gap-1">
                            <span class="material-symbols-outlined text-sm">download</span>
                            <span>Export</span>
                        </button>
                    </div>

                    <!-- Additional Actions -->
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="SocietyOrganizerSystem.openPairingsModal('${event.id}')" class="btn-secondary text-xs py-2 flex items-center justify-center gap-1">
                            <span class="material-symbols-outlined text-sm">grid_view</span>
                            <span>Pairings</span>
                        </button>
                        <button onclick="SocietyOrganizerSystem.copyRegistrationLink('${event.id}')" class="btn-secondary text-xs py-2 flex items-center justify-center gap-1">
                            <span class="material-symbols-outlined text-sm">link</span>
                            <span>Share Link</span>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // =====================================================
    // ROSTER MANAGEMENT
    // =====================================================

    async openRoster(eventId) {
        console.log('[Roster] Opening roster for event:', eventId);
        this.currentRosterEvent = this.events.find(e => e.id === eventId);

        if (!this.currentRosterEvent) {
            console.error('[Roster] Event not found:', eventId);
            return;
        }

        console.log('[Roster] currentRosterEvent set to:', this.currentRosterEvent);

        // Set modal title
        document.getElementById('rosterEventName').textContent = this.currentRosterEvent.name;
        document.getElementById('rosterEventDate').textContent = this.currentRosterEvent.date;

        // Load registrations
        await this.loadRosterData(eventId);

        // Show modal
        document.getElementById('rosterModal').style.display = 'flex';

        // Subscribe to changes
        SocietyGolfDB.subscribeToRegistrations(eventId, () => {
            this.loadRosterData(eventId);
        });
        SocietyGolfDB.subscribeToWaitlist(eventId, () => {
            this.loadRosterData(eventId);
        });
    }

    async loadRosterData(eventId) {
        try {
            const [registrations, waitlist] = await Promise.all([
                SocietyGolfDB.getRegistrations(eventId),
                SocietyGolfDB.getWaitlist(eventId)
            ]);

            // Update counts
            document.getElementById('confirmedCount').textContent = registrations.length;
            document.getElementById('waitlistCount').textContent = waitlist.length;

            // Render tables
            this.renderConfirmedPlayers(registrations);
            this.renderWaitlistPlayers(waitlist);
        } catch (error) {
            console.error('[SocietyOrganizer] Error loading roster:', error);
        }
    }

    renderConfirmedPlayers(registrations) {
        const tbody = document.getElementById('confirmedPlayersTable');
        if (!registrations || registrations.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">No registrations yet</td></tr>';
            return;
        }

        // Store eventId in a variable to use in the template
        const eventId = this.currentRosterEvent?.id;

        // Check if current user is Super Admin
        const isSuperAdmin = AppState.currentUser?.lineUserId === this.currentRosterEvent?.organizerId;

        tbody.innerHTML = registrations.map(reg => {
            const totalFee = reg.total_fee || 0;
            const paymentStatus = reg.payment_status || 'unpaid';
            const isPaid = paymentStatus === 'paid';

            return `
            <tr class="border-t">
                <td class="px-4 py-2">${reg.playerName}</td>
                <td class="px-4 py-2">${Math.round(reg.handicap)}</td>
                <td class="px-4 py-2 text-center">${reg.wantTransport ? '✓' : '-'}</td>
                <td class="px-4 py-2 text-center">${reg.wantCompetition ? '✓' : '-'}</td>
                <td class="px-4 py-2 text-center">${(reg.partnerPrefs || []).length}</td>
                <td class="px-4 py-2 text-right text-gray-900">
                    <button onclick="SocietyOrganizerSystem.editPlayerFee('${reg.id}', '${reg.playerId}', ${totalFee})"
                        class="hover:text-green-600 hover:underline cursor-pointer" title="Click to edit fee">
                        ฿${totalFee.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </button>
                </td>
                <td class="px-4 py-2 text-center">
                    <div class="flex items-center justify-center gap-2">
                        ${isPaid ? `
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">
                                PAID
                            </span>
                            ${isSuperAdmin ? `
                                <button onclick="SocietyOrganizerSystem.togglePayment('${eventId}', '${reg.playerId}', false)"
                                    class="text-xs text-gray-500 hover:text-red-600" title="Super Admin: Mark as unpaid">
                                    <span class="material-symbols-outlined text-sm">cancel</span>
                                </button>
                            ` : ''}
                        ` : `
                            <button onclick="SocietyOrganizerSystem.togglePayment('${eventId}', '${reg.playerId}', true)"
                                class="px-3 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700">
                                Mark Paid
                            </button>
                        `}
                    </div>
                </td>
                <td class="px-4 py-2 text-center">
                    <button onclick="SocietyOrganizerSystem.removeRegistration('${reg.id}')" class="text-xs text-red-600 hover:underline">
                        Remove
                    </button>
                </td>
            </tr>
        `}).join('');
    }

    renderWaitlistPlayers(waitlist) {
        const tbody = document.getElementById('waitlistPlayersTable');
        if (!waitlist || waitlist.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No one on waitlist</td></tr>';
            return;
        }

        tbody.innerHTML = waitlist.map((w, idx) => `
            <tr class="border-t">
                <td class="px-4 py-2 font-bold text-sky-600">#${idx + 1}</td>
                <td class="px-4 py-2">${w.playerName}</td>
                <td class="px-4 py-2">${Math.round(w.handicap)}</td>
                <td class="px-4 py-2 text-xs text-gray-600">${new Date(w.createdAt).toLocaleString()}</td>
                <td class="px-4 py-2 text-center">
                    <button onclick="SocietyOrganizerSystem.removeFromWaitlist('${w.id}')" class="text-xs text-red-600 hover:underline">
                        Remove
                    </button>
                </td>
            </tr>
        `).join('');
    }

    async removeRegistration(regId) {
        if (!confirm('Remove this player? They will be moved to waitlist if enabled.')) return;

        try {
            await SocietyGolfDB.deleteRegistration(regId);
            NotificationManager.show('Player removed', 'success');
            await this.loadRosterData(this.currentRosterEvent.id);
        } catch (error) {
            console.error('[SocietyOrganizer] Error removing registration:', error);
            NotificationManager.show('Failed to remove player', 'error');
        }
    }

    async removeFromWaitlist(waitId) {
        if (!confirm('Remove this player from waitlist?')) return;

        try {
            await SocietyGolfDB.removeFromWaitlist(waitId);
            NotificationManager.show('Player removed from waitlist', 'success');
            await this.loadRosterData(this.currentRosterEvent.id);
        } catch (error) {
            console.error('[SocietyOrganizer] Error removing from waitlist:', error);
            NotificationManager.show('Failed to remove from waitlist', 'error');
        }
    }

    closeRosterModal() {
        document.getElementById('rosterModal').style.display = 'none';
        // Don't clear currentRosterEvent here - it may be needed by child modals
        // this.currentRosterEvent = null;
    }

    openPairingsModalFromRoster() {
        if (!this.currentRosterEvent || !this.currentRosterEvent.id) {
            NotificationManager.show('No event selected', 'error');
            return;
        }
        this.openPairingsModal(this.currentRosterEvent.id);
    }

    // =====================================================
    // MANUAL PLAYER ADDITION
    // =====================================================

    openManualPlayerModal(destination) {
        console.log('[Manual Player] Opening modal, currentRosterEvent:', this.currentRosterEvent);

        if (!this.currentRosterEvent) {
            console.error('[Manual Player] currentRosterEvent is null!');
            NotificationManager.show('Error: No event context. Please close and reopen the roster.', 'error');
            return;
        }

        if (!this.currentRosterEvent.id) {
            console.error('[Manual Player] currentRosterEvent.id is missing!', this.currentRosterEvent);
            NotificationManager.show('Error: Event ID missing. Please close and reopen the roster.', 'error');
            return;
        }

        // Store destination (confirmed or waitlist)
        this.manualPlayerDestination = destination;

        // Set modal title
        document.getElementById('manualPlayerEventName').textContent = this.currentRosterEvent.name;
        document.getElementById('addToDestination').textContent =
            destination === 'confirmed' ? 'Confirmed Players' : 'Waitlist';

        // Reset form
        document.getElementById('manualPlayerSearchInput').value = '';
        document.getElementById('manualPlayerName').value = '';
        document.getElementById('manualPlayerHandicap').value = '';
        document.getElementById('manualPlayerTransport').checked = false;
        document.getElementById('manualPlayerCompetition').checked = false;
        document.getElementById('playerSearchResults').innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <span class="material-symbols-outlined text-5xl text-gray-300">search</span>
                <p class="text-sm mt-2">Start typing to search for players</p>
            </div>
        `;

        // Set to search mode by default
        this.setPlayerAddMode('search');

        // Show modal
        document.getElementById('manualPlayerModal').style.display = 'flex';
    }

    closeManualPlayerModal() {
        document.getElementById('manualPlayerModal').style.display = 'none';
        this.manualPlayerDestination = null;
        this.selectedPlayer = null;
    }

    setPlayerAddMode(mode) {
        const searchMode = document.getElementById('searchMode');
        const manualMode = document.getElementById('manualMode');
        const searchBtn = document.getElementById('searchModeBtn');
        const manualBtn = document.getElementById('manualModeBtn');

        if (mode === 'search') {
            searchMode.style.display = 'block';
            manualMode.style.display = 'none';
            searchBtn.classList.add('bg-white', 'text-green-600');
            searchBtn.classList.remove('bg-white/20', 'text-white');
            manualBtn.classList.remove('bg-white', 'text-green-600');
            manualBtn.classList.add('bg-white/20', 'text-white');
            this.selectedPlayer = null;
        } else {
            searchMode.style.display = 'none';
            manualMode.style.display = 'block';
            manualBtn.classList.add('bg-white', 'text-green-600');
            manualBtn.classList.remove('bg-white/20', 'text-white');
            searchBtn.classList.remove('bg-white', 'text-green-600');
            searchBtn.classList.add('bg-white/20', 'text-white');
            this.selectedPlayer = null;
        }
    }

    async handlePlayerSearch(searchTerm) {
        const resultsDiv = document.getElementById('playerSearchResults');

        if (!searchTerm || searchTerm.length < 2) {
            resultsDiv.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <span class="material-symbols-outlined text-5xl text-gray-300">search</span>
                    <p class="text-sm mt-2">Start typing to search for players</p>
                </div>
            `;
            return;
        }

        // Show loading
        resultsDiv.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto"></div>
                <p class="text-sm mt-2">Searching...</p>
            </div>
        `;

        try {
            // Pass society name for dual search (platform + society members)
            const societyName = this.currentEvent?.organizerName || null;
            const players = await SocietyGolfDB.searchPlayers(searchTerm, societyName);

            if (players.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <span class="material-symbols-outlined text-5xl text-gray-300">person_off</span>
                        <p class="text-sm mt-2">No players found</p>
                        <p class="text-xs mt-1 text-gray-400">Try a different search or use Manual Entry</p>
                    </div>
                `;
                return;
            }

            resultsDiv.innerHTML = players.map(player => `
                <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"
                     onclick="SocietyOrganizerSystem.selectPlayer('${player.id}', '${player.name.replace(/'/g, "\\'")}', ${player.handicap})">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 ${player.isSocietyMember ? 'bg-purple-100' : 'bg-green-100'} rounded-full flex items-center justify-center">
                            <span class="material-symbols-outlined ${player.isSocietyMember ? 'text-purple-600' : 'text-green-600'}">person</span>
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-gray-900">${player.name}</span>
                                ${player.isSocietyMember ? '<span class="text-[10px] bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full font-medium">MEMBER</span>' : ''}
                                ${player.isPrimarySociety ? '<span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-medium">PRIMARY</span>' : ''}
                            </div>
                            <div class="text-xs text-gray-500">
                                HCP: ${player.handicap}${player.homeClub ? ' • ' + player.homeClub : ''}${player.memberNumber ? ' • #' + player.memberNumber : ''}
                            </div>
                        </div>
                    </div>
                    <button class="btn-primary text-xs py-1 px-3">
                        Select
                    </button>
                </div>
            `).join('');
        } catch (error) {
            console.error('[Manual Player] Error searching:', error);
            resultsDiv.innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <span class="material-symbols-outlined text-5xl">error</span>
                    <p class="text-sm mt-2">Error searching players</p>
                </div>
            `;
        }
    }

    selectPlayer(playerId, playerName, handicap) {
        // Check if in directory add mode
        if (this.directoryAddMode) {
            // Directly add to directory instead of selecting
            this.addPlayerToDirectory(playerId, playerName, handicap);
            return;
        }

        this.selectedPlayer = {
            id: playerId,
            name: playerName,
            handicap: handicap
        };

        // Highlight selected
        const resultsDiv = document.getElementById('playerSearchResults');
        const items = resultsDiv.querySelectorAll('.border');
        items.forEach(item => {
            if (item.onclick.toString().includes(playerId)) {
                item.classList.add('bg-green-50', 'border-green-500');
                item.querySelector('button').textContent = 'Selected';
            } else {
                item.classList.remove('bg-green-50', 'border-green-500');
                item.querySelector('button').textContent = 'Select';
            }
        });

        NotificationManager.show(`${playerName} selected`, 'success', 2000);
    }

    async confirmAddPlayer() {
        const searchMode = document.getElementById('searchMode').style.display !== 'none';

        if (searchMode) {
            // Add from database
            if (!this.selectedPlayer) {
                NotificationManager.show('Please select a player', 'warning');
                return;
            }

            await this.addPlayerFromDatabase();
        } else {
            // Add manual player
            await this.addManualPlayer();
        }
    }

    async addPlayerFromDatabase() {
        // Check if current event is still available
        if (!this.currentRosterEvent || !this.currentRosterEvent.id) {
            console.error('[Manual Player] currentRosterEvent is null or missing id');
            NotificationManager.show('Error: Event context lost. Please close and reopen the roster.', 'error');
            this.closeManualPlayerModal();
            return;
        }

        try {
            const playerData = {
                name: this.selectedPlayer.name,
                playerId: this.selectedPlayer.id,
                handicap: this.selectedPlayer.handicap,
                wantTransport: false,
                wantCompetition: false
            };

            if (this.manualPlayerDestination === 'confirmed') {
                await SocietyGolfDB.registerPlayer(this.currentRosterEvent.id, playerData);
                NotificationManager.show(`${playerData.name} added to confirmed players`, 'success');
            } else {
                await SocietyGolfDB.joinWaitlist(this.currentRosterEvent.id, playerData);
                NotificationManager.show(`${playerData.name} added to waitlist`, 'success');
            }

            // Refresh roster
            await this.loadRosterData(this.currentRosterEvent.id);

            // Close modal
            this.closeManualPlayerModal();
        } catch (error) {
            console.error('[Manual Player] Error adding player:', error);
            NotificationManager.show('Failed to add player', 'error');
        }
    }

    async addManualPlayer() {
        // Check if current event is still available
        if (!this.currentRosterEvent || !this.currentRosterEvent.id) {
            console.error('[Manual Player] currentRosterEvent is null or missing id');
            NotificationManager.show('Error: Event context lost. Please close and reopen the roster.', 'error');
            this.closeManualPlayerModal();
            return;
        }

        const name = document.getElementById('manualPlayerName').value.trim();
        const handicap = parseFloat(document.getElementById('manualPlayerHandicap').value);
        const wantTransport = document.getElementById('manualPlayerTransport').checked;
        const wantCompetition = document.getElementById('manualPlayerCompetition').checked;

        // Validation
        if (!name) {
            NotificationManager.show('Please enter player name', 'warning');
            return;
        }

        if (isNaN(handicap) || handicap < 0 || handicap > 54) {
            NotificationManager.show('Please enter a valid handicap (0-54)', 'warning');
            return;
        }

        try {
            const playerData = {
                name: name,
                playerId: null, // Manual entry, no user ID
                handicap: handicap,
                wantTransport: wantTransport,
                wantCompetition: wantCompetition
            };

            if (this.manualPlayerDestination === 'confirmed') {
                await SocietyGolfDB.registerPlayer(this.currentRosterEvent.id, playerData);
                NotificationManager.show(`${name} added to confirmed players`, 'success');
            } else {
                await SocietyGolfDB.joinWaitlist(this.currentRosterEvent.id, playerData);
                NotificationManager.show(`${name} added to waitlist`, 'success');
            }

            // Refresh roster
            await this.loadRosterData(this.currentRosterEvent.id);

            // Close modal
            this.closeManualPlayerModal();
        } catch (error) {
            console.error('[Manual Player] Error adding manual player:', error);
            NotificationManager.show('Failed to add player', 'error');
        }
    }

    // =====================================================
    // ENHANCED REGISTRATION MANAGEMENT
    // =====================================================

    /**
     * Open the enhanced registration management modal
     * Shows detailed table with search, export, and payment tracking
     */
    async openRegistrationManager(eventId) {
        try {
            // Find the event
            const event = this.events.find(e => e.id === eventId);
            if (!event) {
                NotificationManager.show('Event not found', 'error');
                return;
            }

            this.currentRosterEvent = event;

            // Load registrations with full details
            const registrations = await SocietyGolfDB.getEventRegistrationsWithPlayers(eventId);

            // Store in manager
            this.currentRegistrations = registrations;

            // Render the registration table
            this.renderRegistrationManager();

            NotificationManager.show(`Loaded ${registrations.length} registrations`, 'info', 2000);

        } catch (error) {
            console.error('[SocietyOrganizer] Error opening registration manager:', error);
            NotificationManager.show('Failed to load registrations', 'error');
        }
    }

    /**
     * Render the registration management interface (simplified for now)
     * Will be enhanced with modal in next step
     */
    renderRegistrationManager() {
        if (!this.currentRosterEvent || !this.currentRegistrations) {
            NotificationManager.show('No event data loaded', 'error');
            return;
        }

        console.log('[SocietyOrganizer] Registration Manager:', {
            event: this.currentRosterEvent.name,
            registrations: this.currentRegistrations.length,
            stats: this.currentRosterEvent.stats
        });

        // For now, open the existing roster modal
        // This will be replaced with enhanced modal in next step
        this.openRoster(this.currentRosterEvent.id);
    }

    /**
     * Export event registrations to CSV
     */
    async exportEventCSV(eventId) {
        try {
            // Find the event
            const event = this.events.find(e => e.id === eventId);
            if (!event) {
                NotificationManager.show('Event not found', 'error');
                return;
            }

            // Load registrations
            const registrations = await SocietyGolfDB.getEventRegistrationsWithPlayers(eventId);

            if (!registrations || registrations.length === 0) {
                NotificationManager.show('No registrations to export', 'info');
                return;
            }

            // Generate CSV
            const csv = this.generateEnhancedRosterCSV(event, registrations);

            // Download
            const filename = `${event.name.replace(/[^a-z0-9]/gi, '_')}_Registrations_${new Date().toISOString().split('T')[0]}.csv`;
            this.downloadCSV(csv, filename);

            NotificationManager.show('Registration list exported successfully', 'success');

        } catch (error) {
            console.error('[SocietyOrganizer] Error exporting CSV:', error);
            NotificationManager.show('Failed to export registrations', 'error');
        }
    }

    /**
     * Generate enhanced CSV with all registration details
     */
    generateEnhancedRosterCSV(event, registrations) {
        const headers = [
            'Name',
            'Handicap',
            'Transport',
            'Competition',
            'Paid',
            'Payment Date',
            'Registered Date',
            'Partner Preferences Count'
        ];

        const rows = registrations.map(reg => [
            reg.playerName,
            Math.round(reg.handicap),
            reg.wantTransport ? 'Yes' : 'No',
            reg.wantCompetition ? 'Yes' : 'No',
            reg.isPaid ? 'Yes' : 'No',
            reg.paymentDate ? new Date(reg.paymentDate).toLocaleDateString() : '-',
            new Date(reg.createdAt).toLocaleDateString(),
            (reg.partnerPrefs || []).length
        ]);

        // Add summary row
        const stats = event.stats || {};
        const summaryRow = [
            '',
            '',
            `Total: ${stats.transportCount || 0}`,
            `Total: ${stats.competitionCount || 0}`,
            `${stats.paidCount || 0}/${registrations.length}`,
            '',
            '',
            ''
        ];

        // Add event info header
        const eventInfo = [
            [`Event: ${event.name}`],
            [`Date: ${event.date}`],
            [`Course: ${event.courseName || '-'}`],
            [`Total Registered: ${registrations.length}/${event.maxPlayers || '∞'}`],
            [`Total Revenue: ฿${stats.revenue?.toLocaleString() || 0}`],
            [''],  // Empty row
            headers,
            ...rows,
            [''],  // Empty row
            ['Summary'],
            summaryRow
        ];

        return eventInfo.map(row => row.join(',')).join('\n');
    }

    // Wrapper methods for Calendar compatibility
    viewRoster(eventId) {
        return this.openRoster(eventId);
    }

    editEvent(eventId) {
        return this.showEventForm(eventId);
    }

    showCreateEventForm() {
        return this.showEventForm(null);
    }

    async exportRoster() {
        // Export current roster to CSV
        try {
            const regs = await SocietyGolfDB.getRegistrations(this.currentRosterEvent.id);
            const csv = this.generateRosterCSV(regs);
            this.downloadCSV(csv, `${this.currentRosterEvent.name}_roster.csv`);
        } catch (error) {
            console.error('[SocietyOrganizer] Error exporting roster:', error);
            NotificationManager.show('Failed to export roster', 'error');
        }
    }

    generateRosterCSV(registrations) {
        const headers = ['Name', 'Handicap', 'Transport', 'Competition', 'Partner Preferences'];
        const rows = registrations.map(r => [
            r.playerName,
            Math.round(r.handicap),
            r.wantTransport ? 'Yes' : 'No',
            r.wantCompetition ? 'Yes' : 'No',
            (r.partnerPrefs || []).length
        ]);

        return [headers, ...rows].map(row => row.join(',')).join('\n');
    }

    downloadCSV(csvContent, filename) {
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    copyRegistrationLink(eventId) {
        const url = `${window.location.origin}${window.location.pathname}?event=${eventId}`;
        navigator.clipboard.writeText(url).then(() => {
            NotificationManager.show('Registration link copied to clipboard', 'success');
        });
    }

    async openPairingsModal(eventId) {
        try {
            // Load event
            this.currentRosterEvent = this.events.find(e => e.id === eventId);
            if (!this.currentRosterEvent) {
                NotificationManager.show('Event not found', 'error');
                return;
            }

            // Load registered players
            const registrations = await SocietyGolfDB.getRegistrations(eventId);
            this.currentPairings = {
                eventId: eventId,
                players: registrations,
                groups: [],
                groupSize: 4
            };

            // Initialize manual pairing state
            this.manualPairingEnabled = false;
            this.selectedPairingPlayers = [];

            // Set modal title
            document.getElementById('pairingsEventName').textContent = this.currentRosterEvent.name;
            document.getElementById('pairingsEventDate').textContent = this.currentRosterEvent.date;

            // Set event format if it exists
            if (this.currentRosterEvent.eventFormat && this.currentRosterEvent.eventFormat !== 'strokeplay') {
                document.getElementById('pairingsGroupSize').value = this.currentRosterEvent.eventFormat;
            }

            // Try to load existing pairings
            const existingPairings = await SocietyGolfDB.getPairings(eventId);
            if (existingPairings && existingPairings.groups) {
                this.currentPairings.groups = existingPairings.groups;
                this.currentPairings.groupSize = existingPairings.groupSize || 4;
                // Load 4-ball groups for 2-man scramble
                if (existingPairings.fourBallGroups) {
                    this.currentPairings.fourBallGroups = existingPairings.fourBallGroups;
                }
                document.getElementById('pairingsGroupSize').value = this.currentPairings.groupSize;
                this.renderPairings();
            }

            // Set up event listener for pairing mode change
            document.getElementById('pairingMode').onchange = () => this.toggleManualPairingMode();

            // Show modal
            document.getElementById('pairingsModal').style.display = 'flex';
        } catch (error) {
            console.error('[SocietyOrganizer] Error opening pairings:', error);
            NotificationManager.show('Failed to load pairings', 'error');
        }
    }

    closePairingsModal() {
        document.getElementById('pairingsModal').style.display = 'none';
        this.currentPairings = null;
    }

    handleFormatChange() {
        const formatSelect = document.getElementById('pairingsGroupSize');
        const pairingModeSelect = document.getElementById('pairingMode');

        // If scramble format selected, suggest manual mode
        if (formatSelect.value.includes('scramble')) {
            pairingModeSelect.value = 'manual';
            this.toggleManualPairingMode();
        }
    }

    toggleManualPairingMode() {
        const mode = document.getElementById('pairingMode').value;
        const instructionsDiv = document.getElementById('manualPairingInstructions');

        if (mode === 'manual') {
            instructionsDiv.style.display = 'block';
            this.manualPairingEnabled = true;
            this.selectedPairingPlayers = [];
        } else {
            instructionsDiv.style.display = 'none';
            this.manualPairingEnabled = false;
            this.selectedPairingPlayers = [];
        }

        // Re-render to show/hide click handlers
        this.renderPairings();
    }

    autoPairPlayers() {
        if (!this.currentPairings || !this.currentPairings.players.length) {
            NotificationManager.show('No players to pair', 'warning');
            return;
        }

        const formatValue = document.getElementById('pairingsGroupSize').value;
        let groupSize;

        // Determine group size from format
        if (formatValue === '2man_scramble') {
            groupSize = 2;
            this.currentPairings.format = '2man_scramble';
        } else if (formatValue === '4man_scramble') {
            groupSize = 4;
            this.currentPairings.format = '4man_scramble';
        } else {
            groupSize = parseInt(formatValue);
            this.currentPairings.format = 'standard';
        }

        this.currentPairings.groupSize = groupSize;

        // Shuffle players for random pairing
        const players = [...this.currentPairings.players];
        for (let i = players.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [players[i], players[j]] = [players[j], players[i]];
        }

        // Create groups
        const groups = [];
        for (let i = 0; i < players.length; i += groupSize) {
            groups.push(players.slice(i, i + groupSize));
        }

        this.currentPairings.groups = groups;
        this.renderPairings();

        const formatLabel = formatValue.includes('scramble') ? formatValue.replace('_', '-').toUpperCase() : 'Standard';
        NotificationManager.show(`Created ${groups.length} ${formatLabel} groups`, 'success');
    }

    shufflePairings() {
        if (!this.currentPairings || !this.currentPairings.groups.length) {
            NotificationManager.show('No pairings to shuffle', 'warning');
            return;
        }

        // Flatten all groups
        const allPlayers = this.currentPairings.groups.flat();

        // Shuffle
        for (let i = allPlayers.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [allPlayers[i], allPlayers[j]] = [allPlayers[j], allPlayers[i]];
        }

        // Recreate groups
        const groupSize = this.currentPairings.groupSize;
        const groups = [];
        for (let i = 0; i < allPlayers.length; i += groupSize) {
            groups.push(allPlayers.slice(i, i + groupSize));
        }

        this.currentPairings.groups = groups;
        this.renderPairings();
        NotificationManager.show('Pairings shuffled', 'success');
    }

    togglePlayerForPairing(player) {
        if (!this.selectedPairingPlayers) {
            this.selectedPairingPlayers = [];
        }

        const index = this.selectedPairingPlayers.findIndex(p => p.id === player.id);

        if (index > -1) {
            // Deselect
            this.selectedPairingPlayers.splice(index, 1);
        } else {
            // Select
            this.selectedPairingPlayers.push(player);
        }

        // Update UI
        document.getElementById('selectedPlayersCount').textContent = this.selectedPairingPlayers.length;
        const createBtn = document.getElementById('createGroupBtn');
        createBtn.disabled = this.selectedPairingPlayers.length < 2;

        // Re-render to show selection
        this.renderPairings();
    }

    createManualGroup() {
        if (!this.selectedPairingPlayers || this.selectedPairingPlayers.length < 2) {
            NotificationManager.show('Select at least 2 players to create a group', 'warning');
            return;
        }

        // Add selected players as a new group
        this.currentPairings.groups.push([...this.selectedPairingPlayers]);

        // DON'T remove players from currentPairings.players - they stay there and get filtered during rendering
        // This keeps behavior consistent with autoPairPlayers()

        // Clear selection
        this.selectedPairingPlayers = [];
        document.getElementById('selectedPlayersCount').textContent = '0';
        document.getElementById('createGroupBtn').disabled = true;

        // Re-render - paired players will be filtered out automatically
        this.renderPairings();
        NotificationManager.show('Group created successfully', 'success');
    }

    renderPairings() {
        const container = document.getElementById('pairingsContainer');
        const groups = this.currentPairings.groups;
        const manualMode = this.manualPairingEnabled;
        const formatValue = document.getElementById('pairingsGroupSize').value;
        const isScramble = formatValue.includes('scramble');
        const is2ManScramble = formatValue === '2man_scramble';
        const formatLabel = isScramble ? (formatValue === '2man_scramble' ? '2-Man Scramble' : '4-Man Scramble') : '';

        // Special rendering for 2-man scramble with drag-and-drop grouping
        if (is2ManScramble && groups && groups.length > 0) {
            this.render2ManScramblePairings();
            return;
        }

        if (!groups || groups.length === 0) {
            // ALWAYS show players if they exist, regardless of manual mode
            if (this.currentPairings.players.length > 0) {
                // In manual mode, make them clickable for selection
                if (manualMode) {
                    container.innerHTML = `
                        <div class="text-center py-2 text-gray-500">
                            <p class="text-xs mb-3">Click on players below to select them for pairing</p>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2">
                            ${this.currentPairings.players.map(player => {
                                const isSelected = this.selectedPairingPlayers?.find(p => p.id === player.id);
                                return `
                                    <div onclick="SocietyOrganizerSystem.togglePlayerForPairing(${JSON.stringify(player).replace(/"/g, '&quot;')})"
                                         class="flex items-center justify-between px-2 py-1.5 border-2 rounded cursor-pointer hover:bg-gray-50 ${isSelected ? 'bg-green-50 border-green-500' : 'border-gray-200'}">
                                        <span class="text-xs font-medium text-gray-900 truncate">${player.playerName}</span>
                                        <span class="text-[10px] text-gray-600 ml-1 shrink-0">${Math.round(player.handicap)}</span>
                                        ${isSelected ? '<span class="material-symbols-outlined text-green-600 text-xs ml-1">check_circle</span>' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else {
                    // Auto mode - show players as read-only list
                    container.innerHTML = `
                        <div class="text-center py-2 text-gray-500">
                            <p class="text-xs mb-3">Players available for pairing - Click "Auto-Pair" to create groups</p>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2">
                            ${this.currentPairings.players.map(player => {
                                return `
                                    <div class="flex items-center justify-between px-2 py-1.5 border-2 border-gray-200 rounded bg-white">
                                        <span class="text-xs font-medium text-gray-900 truncate">${player.playerName}</span>
                                        <span class="text-[10px] text-gray-600 ml-1 shrink-0">${Math.round(player.handicap)}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
            } else {
                // No players at all - show empty state
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <span class="material-symbols-outlined text-5xl mb-2">groups</span>
                        <p class="text-sm">No players registered for this event</p>
                    </div>
                `;
            }
            return;
        }

        // Get remaining unpaired players
        const pairedPlayerIds = new Set(groups.flat().map(p => p.id));
        const unpairedPlayers = this.currentPairings.players.filter(p => !pairedPlayerIds.has(p.id));

        container.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2">
            ${groups.map((group, groupIndex) => {
                const avgHandicap = group.reduce((sum, p) => sum + p.handicap, 0) / group.length;
                const groupLabel = isScramble ? `Team ${groupIndex + 1}` : `Group ${groupIndex + 1}`;
                return `
                    <div class="bg-white border-2 ${isScramble ? 'border-purple-200' : 'border-green-200'} rounded-lg p-2">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h3 class="text-sm font-bold text-gray-900">${groupLabel}</h3>
                                ${isScramble ? `<span class="text-[10px] text-purple-600 font-medium">${formatLabel}</span>` : ''}
                            </div>
                            <button onclick="SocietyOrganizerSystem.removeGroup(${groupIndex})" class="text-[10px] text-red-600 hover:underline px-1">
                                Remove
                            </button>
                        </div>
                        <div class="mb-1">
                            <span class="text-[10px] ${isScramble ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'} px-1.5 py-0.5 rounded-full">
                                Avg: ${avgHandicap.toFixed(1)}
                            </span>
                        </div>
                        <div class="space-y-1">
                            ${group.map((player, playerIndex) => `
                                <div class="flex items-center justify-between bg-gray-50 rounded px-2 py-1">
                                    <div class="flex items-center gap-1.5">
                                        <span class="text-[10px] font-bold text-gray-500">#${playerIndex + 1}</span>
                                        <span class="text-xs font-medium text-gray-900 truncate">${player.playerName}</span>
                                    </div>
                                    <div class="flex items-center gap-1 shrink-0">
                                        <span class="text-[11px] text-gray-600">${Math.round(player.handicap)}</span>
                                        ${player.wantTransport ? '<span class="text-[10px]">🚐</span>' : ''}
                                        ${player.wantCompetition ? '<span class="text-[10px]">🏆</span>' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('')}
            </div>

            ${unpairedPlayers.length > 0 && manualMode ? `
                <div class="mt-3 bg-amber-50 border-2 border-amber-200 rounded-lg p-3">
                    <h3 class="text-sm font-bold text-amber-900 mb-2">Available Players (Click to Select)</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2">
                        ${unpairedPlayers.map(player => {
                            const isSelected = this.selectedPairingPlayers?.find(p => p.id === player.id);
                            return `
                                <div onclick="SocietyOrganizerSystem.togglePlayerForPairing(${JSON.stringify(player).replace(/"/g, '&quot;')})"
                                     class="flex items-center justify-between px-2 py-1.5 border-2 rounded cursor-pointer hover:bg-amber-100 ${isSelected ? 'bg-green-50 border-green-500' : 'border-amber-200'}">
                                    <span class="text-xs font-medium text-gray-900 truncate">${player.playerName}</span>
                                    <span class="text-[10px] text-gray-600 ml-1 shrink-0">${Math.round(player.handicap)}</span>
                                    ${isSelected ? '<span class="material-symbols-outlined text-green-600 text-xs ml-1">check_circle</span>' : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : ''}
        `;
    }

    render2ManScramblePairings() {
        const container = document.getElementById('pairingsContainer');
        const teams = this.currentPairings.groups; // Each "group" is actually a team of 2

        // Initialize 4-ball groups structure if not exists
        if (!this.currentPairings.fourBallGroups) {
            this.currentPairings.fourBallGroups = [];
        }

        // Get teams that are already in 4-ball groups
        const assignedTeamIndices = new Set();
        this.currentPairings.fourBallGroups.forEach(group => {
            if (group.teamIndices) {
                group.teamIndices.forEach(idx => assignedTeamIndices.add(idx));
            }
        });

        // Unassigned teams (not in any 4-ball group)
        const unassignedTeams = teams.map((team, idx) => ({ team, idx }))
            .filter(({ idx }) => !assignedTeamIndices.has(idx));

        container.innerHTML = `
            <div class="space-y-4">
                <!-- 4-Ball Groups -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-bold text-gray-900">4-Ball Groups (Tee Times)</h3>
                        <button onclick="SocietyOrganizerSystem.add4BallGroup()" class="btn-primary text-xs py-1 px-2">
                            <span class="material-symbols-outlined text-xs">add</span>
                            Add Group
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="fourBallGroupsContainer">
                        ${this.currentPairings.fourBallGroups.map((group, groupIdx) => this.render4BallGroup(group, groupIdx, teams)).join('')}
                    </div>
                    ${this.currentPairings.fourBallGroups.length === 0 ? '<p class="text-sm text-gray-500 text-center py-4">No groups yet. Click "Add Group" to create tee time groups.</p>' : ''}
                </div>

                <!-- Unassigned Teams -->
                <div class="bg-purple-50 rounded-lg p-4">
                    <h3 class="text-sm font-bold text-purple-900 mb-3">Teams (2-Man Scramble) - Drag to assign to groups</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2">
                        ${unassignedTeams.map(({ team, idx }) => this.renderDraggableTeam(team, idx)).join('')}
                    </div>
                    ${unassignedTeams.length === 0 ? '<p class="text-xs text-purple-700">All teams have been assigned to groups!</p>' : ''}
                </div>
            </div>
        `;
    }

    render4BallGroup(group, groupIdx, allTeams) {
        const groupNumber = groupIdx + 1;
        const teamSlots = group.teamIndices || [];
        const team1 = teamSlots[0] !== undefined ? allTeams[teamSlots[0]] : null;
        const team2 = teamSlots[1] !== undefined ? allTeams[teamSlots[1]] : null;

        return `
            <div class="bg-white border-2 border-green-300 rounded-lg p-3"
                 ondrop="SocietyOrganizerSystem.handleTeamDrop(event, ${groupIdx})"
                 ondragover="SocietyOrganizerSystem.allowDrop(event)"
                 ondragleave="SocietyOrganizerSystem.handleDragLeave(event)">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-sm font-bold text-gray-900">Group ${groupNumber}</h4>
                    <button onclick="SocietyOrganizerSystem.remove4BallGroup(${groupIdx})" class="text-xs text-red-600 hover:underline">
                        Remove
                    </button>
                </div>

                <!-- Team Slot 1 -->
                <div class="mb-2">
                    ${team1 ? `
                        <div class="bg-purple-100 border border-purple-300 rounded p-2 relative">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-xs font-bold text-purple-900">Team A</span>
                                <button onclick="SocietyOrganizerSystem.removeTeamFromGroup(${groupIdx}, 0)" class="text-xs text-red-600 hover:underline">×</button>
                            </div>
                            ${team1.map((player, playerIdx) => `
                                <div class="flex items-center justify-between text-xs py-1">
                                    <span class="font-medium text-gray-900">${player.playerName}</span>
                                    <span class="text-gray-600">${Math.round(player.handicap)}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="border-2 border-dashed border-gray-300 rounded p-3 text-center text-xs text-gray-400">
                            Drop Team A here
                        </div>
                    `}
                </div>

                <!-- Team Slot 2 -->
                <div>
                    ${team2 ? `
                        <div class="bg-purple-100 border border-purple-300 rounded p-2 relative">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-xs font-bold text-purple-900">Team B</span>
                                <button onclick="SocietyOrganizerSystem.removeTeamFromGroup(${groupIdx}, 1)" class="text-xs text-red-600 hover:underline">×</button>
                            </div>
                            ${team2.map((player, playerIdx) => `
                                <div class="flex items-center justify-between text-xs py-1">
                                    <span class="font-medium text-gray-900">${player.playerName}</span>
                                    <span class="text-gray-600">${Math.round(player.handicap)}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="border-2 border-dashed border-gray-300 rounded p-3 text-center text-xs text-gray-400">
                            Drop Team B here
                        </div>
                    `}
                </div>
            </div>
        `;
    }

    renderDraggableTeam(team, teamIdx) {
        const avgHandicap = team.reduce((sum, p) => sum + p.handicap, 0) / team.length;
        return `
            <div draggable="true"
                 ondragstart="SocietyOrganizerSystem.handleTeamDragStart(event, ${teamIdx})"
                 ondragend="SocietyOrganizerSystem.handleTeamDragEnd(event)"
                 class="bg-white border-2 border-purple-200 rounded-lg p-2 cursor-move hover:shadow-lg transition-shadow">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-xs font-bold text-purple-900">Team ${teamIdx + 1}</span>
                    <span class="text-xs bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded-full">
                        Avg: ${avgHandicap.toFixed(1)}
                    </span>
                </div>
                <div class="space-y-1">
                    ${team.map((player, playerIdx) => `
                        <div class="flex items-center justify-between bg-purple-50 rounded px-2 py-1">
                            <span class="text-xs font-medium text-gray-900">${player.playerName}</span>
                            <span class="text-xs text-gray-600">${Math.round(player.handicap)}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // Drag-and-Drop handlers
    handleTeamDragStart(event, teamIdx) {
        event.dataTransfer.setData('teamIdx', teamIdx);
        event.target.style.opacity = '0.5';
    }

    handleTeamDragEnd(event) {
        event.target.style.opacity = '1';
    }

    allowDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.add('bg-green-50');
    }

    handleDragLeave(event) {
        event.currentTarget.classList.remove('bg-green-50');
    }

    handleTeamDrop(event, groupIdx) {
        event.preventDefault();
        event.currentTarget.classList.remove('bg-green-50');

        const teamIdx = parseInt(event.dataTransfer.getData('teamIdx'));

        // Ensure fourBallGroups structure exists
        if (!this.currentPairings.fourBallGroups[groupIdx]) {
            this.currentPairings.fourBallGroups[groupIdx] = { teamIndices: [] };
        }

        // Find next available slot (0 or 1)
        const group = this.currentPairings.fourBallGroups[groupIdx];
        if (!group.teamIndices) group.teamIndices = [];

        if (group.teamIndices.length < 2) {
            group.teamIndices.push(teamIdx);
            NotificationManager.show('Team added to group', 'success');
            this.renderPairings();
        } else {
            NotificationManager.show('Group is full (2 teams maximum)', 'warning');
        }
    }

    add4BallGroup() {
        if (!this.currentPairings.fourBallGroups) {
            this.currentPairings.fourBallGroups = [];
        }
        this.currentPairings.fourBallGroups.push({ teamIndices: [] });
        this.renderPairings();
        NotificationManager.show('Group added', 'success');
    }

    remove4BallGroup(groupIdx) {
        if (!confirm('Remove this group? Teams will be unassigned.')) return;
        this.currentPairings.fourBallGroups.splice(groupIdx, 1);
        this.renderPairings();
        NotificationManager.show('Group removed', 'success');
    }

    removeTeamFromGroup(groupIdx, slotIdx) {
        const group = this.currentPairings.fourBallGroups[groupIdx];
        if (group && group.teamIndices) {
            group.teamIndices.splice(slotIdx, 1);
            this.renderPairings();
            NotificationManager.show('Team removed from group', 'success');
        }
    }

    async removeGroup(groupIndex) {
        if (!confirm('Remove this group? Players will become available for pairing again.')) return;

        // Remove group (players remain in currentPairings.players - they're filtered during rendering)
        this.currentPairings.groups.splice(groupIndex, 1);

        // Auto-save to database so removal persists
        try {
            await SocietyGolfDB.savePairings(this.currentPairings.eventId, {
                groupSize: this.currentPairings.groupSize,
                groups: this.currentPairings.groups
            });
            console.log('[Pairings] Group removed and saved to database');
        } catch (error) {
            console.error('[Pairings] Error saving after group removal:', error);
        }

        // Re-render - unpaired players will automatically appear because renderPairings filters them
        this.renderPairings();
        NotificationManager.show('Group removed', 'success');
    }

    async savePairings() {
        if (!this.currentPairings || !this.currentPairings.groups.length) {
            NotificationManager.show('No pairings to save', 'warning');
            return;
        }

        try {
            const pairingsData = {
                groupSize: this.currentPairings.groupSize,
                groups: this.currentPairings.groups
            };

            // For 2-man scramble, also save 4-ball groups
            if (this.currentPairings.fourBallGroups) {
                pairingsData.fourBallGroups = this.currentPairings.fourBallGroups;
            }

            await SocietyGolfDB.savePairings(this.currentPairings.eventId, pairingsData);
            NotificationManager.show('Pairings saved successfully', 'success');
        } catch (error) {
            console.error('[SocietyOrganizer] Error saving pairings:', error);
            NotificationManager.show('Failed to save pairings', 'error');
        }
    }

    printTeeSheet() {
        if (!this.currentPairings || !this.currentPairings.groups.length) {
            NotificationManager.show('No pairings to print', 'warning');
            return;
        }

        const formatValue = document.getElementById('pairingsGroupSize').value;
        const is2ManScramble = formatValue === '2man_scramble';

        // Generate print HTML
        let printHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>${this.currentRosterEvent.name} - Tee Sheet</title>
                <style>
                    @media print {
                        body { margin: 0; }
                        @page { margin: 1cm; }
                    }
                    body {
                        font-family: Arial, sans-serif;
                        max-width: 800px;
                        margin: 0 auto;
                        padding: 20px;
                    }
                    .header {
                        text-align: center;
                        margin-bottom: 30px;
                        border-bottom: 3px solid #16a34a;
                        padding-bottom: 15px;
                    }
                    h1 {
                        margin: 0 0 10px 0;
                        color: #16a34a;
                        font-size: 28px;
                    }
                    .meta {
                        color: #666;
                        font-size: 14px;
                    }
                    .group {
                        page-break-inside: avoid;
                        margin-bottom: 25px;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        padding: 15px;
                        background: #f9fafb;
                    }
                    .group-header {
                        background: #16a34a;
                        color: white;
                        padding: 8px 12px;
                        margin: -15px -15px 12px -15px;
                        border-radius: 6px 6px 0 0;
                        font-weight: bold;
                        font-size: 16px;
                    }
                    .team {
                        background: white;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        padding: 10px;
                        margin-bottom: 10px;
                    }
                    .team-label {
                        font-weight: bold;
                        color: #7c3aed;
                        font-size: 14px;
                        margin-bottom: 5px;
                    }
                    .player {
                        display: flex;
                        justify-content: space-between;
                        padding: 5px 0;
                        border-bottom: 1px dotted #e5e7eb;
                    }
                    .player:last-child {
                        border-bottom: none;
                    }
                    .player-name {
                        font-weight: 500;
                    }
                    .player-hcp {
                        color: #666;
                        font-size: 14px;
                    }
                    .footer {
                        margin-top: 40px;
                        text-align: center;
                        color: #999;
                        font-size: 12px;
                        border-top: 1px solid #e5e7eb;
                        padding-top: 15px;
                    }
                    .avg-hcp {
                        background: #dbeafe;
                        color: #1e40af;
                        padding: 3px 8px;
                        border-radius: 4px;
                        font-size: 12px;
                        display: inline-block;
                        margin-left: 10px;
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>${this.currentRosterEvent.name}</h1>
                    <div class="meta">
                        <div><strong>Date:</strong> ${new Date(this.currentRosterEvent.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        ${this.currentRosterEvent.courseName ? `<div><strong>Course:</strong> ${this.currentRosterEvent.courseName}</div>` : ''}
                        ${this.currentRosterEvent.startTime ? `<div><strong>Start Time:</strong> ${this.currentRosterEvent.startTime}</div>` : ''}
                        <div><strong>Format:</strong> ${is2ManScramble ? '2-Man Scramble' : 'Stroke Play'}</div>
                    </div>
                </div>
        `;

        if (is2ManScramble && this.currentPairings.fourBallGroups && this.currentPairings.fourBallGroups.length > 0) {
            // Print 4-ball groups for 2-man scramble
            this.currentPairings.fourBallGroups.forEach((group, groupIdx) => {
                const teamSlots = group.teamIndices || [];
                const team1 = teamSlots[0] !== undefined ? this.currentPairings.groups[teamSlots[0]] : null;
                const team2 = teamSlots[1] !== undefined ? this.currentPairings.groups[teamSlots[1]] : null;

                printHTML += `
                    <div class="group">
                        <div class="group-header">Group ${groupIdx + 1}</div>
                `;

                if (team1) {
                    const avgHcp1 = team1.reduce((sum, p) => sum + p.handicap, 0) / team1.length;
                    printHTML += `
                        <div class="team">
                            <div class="team-label">Team A <span class="avg-hcp">Avg HCP: ${avgHcp1.toFixed(1)}</span></div>
                    `;
                    team1.forEach(player => {
                        printHTML += `
                            <div class="player">
                                <span class="player-name">${player.playerName}</span>
                                <span class="player-hcp">HCP ${Math.round(player.handicap)}</span>
                            </div>
                        `;
                    });
                    printHTML += `</div>`;
                }

                if (team2) {
                    const avgHcp2 = team2.reduce((sum, p) => sum + p.handicap, 0) / team2.length;
                    printHTML += `
                        <div class="team">
                            <div class="team-label">Team B <span class="avg-hcp">Avg HCP: ${avgHcp2.toFixed(1)}</span></div>
                    `;
                    team2.forEach(player => {
                        printHTML += `
                            <div class="player">
                                <span class="player-name">${player.playerName}</span>
                                <span class="player-hcp">HCP ${Math.round(player.handicap)}</span>
                            </div>
                        `;
                    });
                    printHTML += `</div>`;
                }

                printHTML += `</div>`;
            });
        } else {
            // Regular groups
            this.currentPairings.groups.forEach((group, groupIndex) => {
                const avgHandicap = group.reduce((sum, p) => sum + p.handicap, 0) / group.length;
                printHTML += `
                    <div class="group">
                        <div class="group-header">
                            Group ${groupIndex + 1}
                            <span class="avg-hcp">Avg HCP: ${avgHandicap.toFixed(1)}</span>
                        </div>
                `;
                group.forEach(player => {
                    printHTML += `
                        <div class="player">
                            <span class="player-name">${player.playerName}</span>
                            <span class="player-hcp">HCP ${Math.round(player.handicap)}</span>
                        </div>
                    `;
                });
                printHTML += `</div>`;
            });
        }

        printHTML += `
                <div class="footer">
                    Generated by MyCaddy Pro - ${new Date().toLocaleString()}
                </div>
            </body>
            </html>
        `;

        // Open print window
        const printWindow = window.open('', '_blank', 'width=800,height=600');
        printWindow.document.write(printHTML);
        printWindow.document.close();
        printWindow.focus();

        // Wait for content to load, then print
        setTimeout(() => {
            printWindow.print();
        }, 250);

        NotificationManager.show('Opening print preview...', 'success');
    }

    // =====================================================
    // SOCIETY PROFILE MANAGEMENT
    // =====================================================

    async loadSocietyProfile() {
        try {
            const organizerId = AppState.currentUser?.lineUserId;
            if (!organizerId) return;

            const profile = await SocietyGolfDB.getSocietyProfile(organizerId);
            this.societyProfile = profile;

            // Update header with society branding
            this.updateHeader();

            // Populate form if profile exists
            if (profile) {
                document.getElementById('societyName').value = profile.societyName || '';
                document.getElementById('societyDescription').value = profile.description || '';

                if (profile.societyLogo) {
                    const preview = document.getElementById('societyLogoPreview');
                    preview.innerHTML = `<img src="${profile.societyLogo}" class="w-full h-full object-cover" alt="Society Logo">`;
                }
            }
        } catch (error) {
            console.error('[SocietyOrganizer] Error loading profile:', error);
        }
    }

    updateHeader() {
        const logoContainer = document.getElementById('societyHeaderLogo');
        const nameElement = document.getElementById('societyHeaderName');

        if (!logoContainer || !nameElement) return;

        const profile = this.societyProfile;

        // Update logo
        if (profile?.societyLogo) {
            logoContainer.innerHTML = `<img src="${profile.societyLogo}" class="w-10 h-10 md:w-12 md:h-12 rounded-full object-cover border-2 border-sky-200" alt="${profile.societyName || 'Society'} Logo">`;
        } else {
            // Fallback to icon
            logoContainer.innerHTML = '<span class="material-symbols-outlined text-2xl text-sky-600">groups</span>';
        }

        // Update name
        if (profile?.societyName) {
            nameElement.textContent = profile.societyName;
        } else {
            nameElement.textContent = 'Society Organizer';
        }
    }

    handleLogoUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Validate file size (max 2MB)
        if (file.size > 2 * 1024 * 1024) {
            NotificationManager.show('Logo must be less than 2MB', 'error');
            return;
        }

        // Validate file type
        if (!file.type.startsWith('image/')) {
            NotificationManager.show('Please upload an image file', 'error');
            return;
        }

        // Read file as base64
        const reader = new FileReader();
        reader.onload = (e) => {
            this.tempLogoData = e.target.result;
            const preview = document.getElementById('societyLogoPreview');
            preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover" alt="Society Logo">`;
        };
        reader.readAsDataURL(file);
    }

    async saveSocietyProfile() {
        try {
            const organizerId = AppState.currentUser?.lineUserId;
            console.log('[SocietyOrganizer] Current user:', AppState.currentUser);
            console.log('[SocietyOrganizer] Organizer ID:', organizerId);

            if (!organizerId) {
                NotificationManager.show('User not logged in', 'error');
                return;
            }

            const profileData = {
                organizerId: organizerId,
                societyName: document.getElementById('societyName').value.trim(),
                description: document.getElementById('societyDescription').value.trim(),
                societyLogo: this.tempLogoData || this.societyProfile?.societyLogo || null
            };

            console.log('[SocietyOrganizer] Profile data to save:', profileData);

            if (!profileData.societyName) {
                NotificationManager.show('Please enter society name', 'error');
                return;
            }

            console.log('[SocietyOrganizer] Existing profile:', this.societyProfile);

            if (this.societyProfile) {
                // Update existing profile
                console.log('[SocietyOrganizer] Updating existing profile...');
                const result = await SocietyGolfDB.updateSocietyProfile(organizerId, profileData);
                console.log('[SocietyOrganizer] Update result:', result);
                NotificationManager.show('Profile updated successfully', 'success');
            } else {
                // Create new profile
                console.log('[SocietyOrganizer] Creating new profile...');
                const result = await SocietyGolfDB.createSocietyProfile(profileData);
                console.log('[SocietyOrganizer] Create result:', result);
                NotificationManager.show('Profile created successfully', 'success');
            }

            // Reload profile
            await this.loadSocietyProfile();

            // Reload events to show updated branding
            await this.loadEvents();
        } catch (error) {
            console.error('[SocietyOrganizer] Error saving profile:', error);
            console.error('[SocietyOrganizer] Error details:', JSON.stringify(error, null, 2));
            NotificationManager.show('ERROR: ' + (error.message || error.toString()), 'error');
        }
    }


    // ===== PIN MANAGEMENT METHODS =====

    async loadPinStatus() {
        const userId = AppState.currentUser?.lineUserId;
        if (!userId) return;

        try {
            const { data, error } = await window.SupabaseDB.client
                .rpc('organizer_has_pin', { org_id: userId });

            if (error) {
                console.error('[SocietyOrganizer] Error checking PIN status:', error);
                return;
            }

            const hasPinSet = data === true;
            const statusIcon = document.getElementById('pinStatusIcon');
            const statusText = document.getElementById('pinStatusText');
            const setPinButton = document.getElementById('setPinButton');
            const changePinSection = document.getElementById('changePinSection');

            if (hasPinSet) {
                statusIcon.textContent = 'lock';
                statusIcon.className = 'material-symbols-outlined text-2xl text-green-600';
                statusText.textContent = 'PIN Enabled';
                statusText.nextElementSibling.textContent = 'Your dashboard is protected';
                setPinButton.style.display = 'none';
                changePinSection.style.display = 'block';
            } else {
                statusIcon.textContent = 'lock_open';
                statusIcon.className = 'material-symbols-outlined text-2xl text-gray-400';
                statusText.textContent = 'No PIN Set';
                statusText.nextElementSibling.textContent = 'Anyone can access your organizer dashboard';
                setPinButton.style.display = 'inline-flex';
                changePinSection.style.display = 'none';
            }

            // Set organizer ID display
            document.getElementById('adminOrganizerId').textContent = userId;
        } catch (error) {
            console.error('[SocietyOrganizer] Exception checking PIN status:', error);
        }
    }

    showPinSetup() {
        document.getElementById('pinStatusSection').style.display = 'none';
        document.getElementById('pinSetupForm').style.display = 'block';
        document.getElementById('newPin').focus();
    }

    showChangePinForm() {
        document.getElementById('changePinSection').style.display = 'none';
        document.getElementById('pinSetupForm').style.display = 'block';
        document.getElementById('newPin').focus();
    }

    cancelPinSetup() {
        document.getElementById('pinStatusSection').style.display = 'block';
        document.getElementById('pinSetupForm').style.display = 'none';
        document.getElementById('changePinSection').style.display = 'block';
        document.getElementById('newPin').value = '';
        document.getElementById('confirmPin').value = '';
    }

    async saveDashboardPin() {
        const newPin = document.getElementById('newPin').value;
        const confirmPin = document.getElementById('confirmPin').value;
        const userId = AppState.currentUser?.lineUserId;

        if (!userId) {
            NotificationManager.show('User not authenticated', 'error');
            return;
        }

        if (!newPin || newPin.length < 4) {
            NotificationManager.show('PIN must be at least 4 digits', 'error');
            return;
        }

        if (newPin !== confirmPin) {
            NotificationManager.show('PINs do not match', 'error');
            return;
        }

        // Validate PIN contains only numbers
        if (!/^\d+$/.test(newPin)) {
            NotificationManager.show('PIN must contain only numbers', 'error');
            return;
        }

        try {
            const { data, error } = await window.SupabaseDB.client
                .rpc('set_organizer_pin', {
                    org_id: userId,
                    new_pin: newPin
                });

            if (error) {
                console.error('[SocietyOrganizer] Error setting PIN:', error);
                NotificationManager.show('Failed to save PIN', 'error');
                return;
            }

            NotificationManager.show('PIN saved successfully', 'success');

            // Clear form
            document.getElementById('newPin').value = '';
            document.getElementById('confirmPin').value = '';

            // Hide form and show status
            document.getElementById('pinSetupForm').style.display = 'none';
            document.getElementById('pinStatusSection').style.display = 'block';

            // Reload PIN status
            await this.loadPinStatus();

            // Clear session verification so they need to re-enter on next access
            sessionStorage.removeItem('society_organizer_verified');

        } catch (error) {
            console.error('[SocietyOrganizer] Exception saving PIN:', error);
            NotificationManager.show('Failed to save PIN', 'error');
        }
    }

    // =====================================================
    // ROLE-BASED ACCESS CONTROL
    // =====================================================

    async loadUserRole() {
        const userId = AppState.currentUser?.lineUserId;
        if (!userId) {
            console.error('[SocietyOrganizer] No user ID for role check');
            return null;
        }

        try {
            // Check if society_organizer_roles table exists and get user role
            const { data, error } = await window.SupabaseDB.client
                .from('society_organizer_roles')
                .select('role')
                .eq('user_id', userId)
                .eq('organizer_id', userId) // For now, user is their own organizer
                .single();

            if (error && error.code !== 'PGRST116') {
                console.error('[SocietyOrganizer] Error loading role:', error);
                // Default to super_admin if table doesn't exist or error occurs
                return 'super_admin';
            }

            const role = data?.role || 'super_admin'; // Default to super_admin if no role found
            console.log(`[SocietyOrganizer] User role: ${role}`);
            return role;
        } catch (error) {
            console.error('[SocietyOrganizer] Exception loading role:', error);
            return 'super_admin'; // Default to super_admin
        }
    }

    async updateAdminTabUI(role) {
        // Update role display
        const roleDisplay = document.getElementById('userRoleDisplay');
        const roleDescription = document.getElementById('userRoleDescription');
        const roleBadge = document.getElementById('userRoleBadge');
        const roleIcon = document.getElementById('userRoleIcon');
        const adminUserRole = document.getElementById('adminUserRole');

        const roleConfig = {
            super_admin: {
                name: 'Super Admin',
                description: 'Full system access with PIN and user management',
                badge: 'SUPER ADMIN',
                badgeColor: 'bg-red-600',
                icon: 'shield_person',
                iconColor: 'text-red-600'
            },
            admin: {
                name: 'Admin',
                description: 'Manage events, registrations, and pairings',
                badge: 'ADMIN',
                badgeColor: 'bg-blue-600',
                icon: 'admin_panel_settings',
                iconColor: 'text-blue-600'
            },
            staff: {
                name: 'Staff',
                description: 'View-only access to events and registrations',
                badge: 'STAFF',
                badgeColor: 'bg-gray-600',
                icon: 'badge',
                iconColor: 'text-gray-600'
            }
        };

        const config = roleConfig[role] || roleConfig.admin;

        roleDisplay.textContent = config.name;
        roleDescription.textContent = config.description;
        roleBadge.textContent = config.badge;
        roleBadge.className = `px-4 py-2 ${config.badgeColor} text-white rounded-full text-sm font-semibold`;
        roleIcon.textContent = config.icon;
        roleIcon.className = `material-symbols-outlined text-2xl ${config.iconColor}`;
        adminUserRole.textContent = config.name;

        // Show/hide sections based on role
        const superAdminPinSection = document.getElementById('superAdminPinSection');
        const superAdminUserManagement = document.getElementById('superAdminUserManagement');
        const limitedAccessMessage = document.getElementById('limitedAccessMessage');
        const limitedAccessRoleName = document.getElementById('limitedAccessRoleName');

        if (role === 'super_admin') {
            // Super Admin sees everything
            superAdminPinSection.style.display = 'block';
            superAdminUserManagement.style.display = 'block';
            limitedAccessMessage.style.display = 'none';
            await this.loadPinStatus();
            await this.loadAdminUsers();
        } else {
            // Regular Admin and Staff see limited message
            superAdminPinSection.style.display = 'none';
            superAdminUserManagement.style.display = 'none';
            limitedAccessMessage.style.display = 'block';
            limitedAccessRoleName.textContent = config.name;
        }

        console.log(`[SocietyOrganizer] Admin tab UI updated for ${role}`);
    }

    async loadAdminUsers() {
        const userId = AppState.currentUser?.lineUserId;
        if (!userId) return;

        try {
            const { data, error } = await window.SupabaseDB.client
                .from('society_organizer_roles')
                .select(`
                    user_id,
                    role,
                    created_at,
                    user_profiles!inner(
                        name,
                        profile_data
                    )
                `)
                .eq('organizer_id', userId);

            if (error) {
                console.error('[SocietyOrganizer] Error loading users:', error);
                this.renderAdminUsersList([]);
                return;
            }

            console.log(`[SocietyOrganizer] Loaded ${data?.length || 0} admin users`);
            this.renderAdminUsersList(data || []);
        } catch (error) {
            console.error('[SocietyOrganizer] Exception loading users:', error);
            this.renderAdminUsersList([]);
        }
    }

    renderAdminUsersList(users) {
        const container = document.getElementById('adminUsersList');

        if (!users || users.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <span class="material-symbols-outlined text-4xl mb-2">people_outline</span>
                    <p class="text-sm">No users assigned yet</p>
                    <p class="text-xs mt-1">Click "Add User" to grant dashboard access</p>
                </div>
            `;
            return;
        }

        const roleIcons = {
            super_admin: { icon: 'shield_person', color: 'text-red-600', bg: 'bg-red-50', label: 'Super Admin' },
            admin: { icon: 'admin_panel_settings', color: 'text-blue-600', bg: 'bg-blue-50', label: 'Admin' },
            staff: { icon: 'badge', color: 'text-gray-600', bg: 'bg-gray-50', label: 'Staff' }
        };

        container.innerHTML = users.map(user => {
            const roleConfig = roleIcons[user.role] || roleIcons.admin;
            const name = user.user_profiles?.name || 'Unknown User';
            const email = user.user_profiles?.profile_data?.personalInfo?.email || 'No email';

            return `
                <div class="flex items-center justify-between p-4 border-b hover:bg-gray-50">
                    <div class="flex items-center space-x-3 flex-1">
                        <div class="${roleConfig.bg} rounded-full p-2">
                            <span class="material-symbols-outlined ${roleConfig.color}">${roleConfig.icon}</span>
                        </div>
                        <div class="flex-1">
                            <p class="font-medium text-gray-900">${name}</p>
                            <p class="text-xs text-gray-600">${email}</p>
                        </div>
                        <div class="px-3 py-1 ${roleConfig.bg} rounded-full">
                            <span class="text-xs font-medium ${roleConfig.color}">${roleConfig.label}</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        <button onclick="SocietyOrganizerSystem.changeUserRole('${user.user_id}')" class="btn-secondary text-xs px-3 py-2">
                            <span class="material-symbols-outlined text-xs">edit</span>
                            Change Role
                        </button>
                        <button onclick="SocietyOrganizerSystem.removeUser('${user.user_id}')" class="text-red-600 hover:text-red-700 px-2">
                            <span class="material-symbols-outlined text-sm">delete</span>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // =====================================================
    // ADD USER MODAL FUNCTIONS
    // =====================================================

    showAddUserModal() {
        document.getElementById('addUserModal').style.display = 'flex';
        document.getElementById('addUserSearchInput').value = '';
        document.getElementById('userProfileSearchResults').style.display = 'none';
        document.getElementById('selectedUserDisplay').style.display = 'none';
        document.getElementById('roleAssignmentSection').style.display = 'none';
        document.getElementById('confirmAddUserButton').disabled = true;
        document.getElementById('confirmAddUserButton').style.opacity = '0.5';
        this.selectedUserForAdd = null;
        console.log('[SocietyOrganizer] Add User modal opened');
    }

    closeAddUserModal() {
        document.getElementById('addUserModal').style.display = 'none';
        this.selectedUserForAdd = null;
    }

    async searchUserProfiles() {
        const searchInput = document.getElementById('addUserSearchInput');
        const searchTerm = searchInput.value.toLowerCase().trim();
        const resultsContainer = document.getElementById('userProfileSearchResults');

        if (!searchTerm || searchTerm.length < 2) {
            resultsContainer.style.display = 'none';
            return;
        }

        try {
            const profiles = await window.SupabaseDB.getAllProfiles();
            const filtered = profiles.filter(profile => {
                const name = (profile.name || '').toLowerCase();
                const email = (profile.profile_data?.personalInfo?.email || '').toLowerCase();
                return name.includes(searchTerm) || email.includes(searchTerm);
            });

            if (filtered.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center py-6 text-gray-500">
                        <span class="material-symbols-outlined text-2xl">search_off</span>
                        <p class="text-sm mt-2">No users found</p>
                    </div>
                `;
                resultsContainer.style.display = 'block';
                return;
            }

            resultsContainer.innerHTML = filtered.map(profile => {
                const name = profile.name || 'Unknown';
                const email = profile.profile_data?.personalInfo?.email || 'No email';
                return `
                    <div class="flex items-center justify-between p-4 border-b hover:bg-blue-50 cursor-pointer" onclick="SocietyOrganizerSystem.selectUserForAdd('${profile.line_user_id}', '${name}', '${email}')">
                        <div>
                            <p class="font-medium text-gray-900">${name}</p>
                            <p class="text-xs text-gray-600">${email}</p>
                        </div>
                        <button class="btn-primary text-xs px-3 py-2">Select</button>
                    </div>
                `;
            }).join('');

            resultsContainer.style.display = 'block';
        } catch (error) {
            console.error('[SocietyOrganizer] Error searching profiles:', error);
        }
    }

    selectUserForAdd(userId, name, email) {
        this.selectedUserForAdd = { userId, name, email };

        document.getElementById('selectedUserName').textContent = name;
        document.getElementById('selectedUserEmail').textContent = email;
        document.getElementById('userProfileSearchResults').style.display = 'none';
        document.getElementById('selectedUserDisplay').style.display = 'block';
        document.getElementById('roleAssignmentSection').style.display = 'block';
        document.getElementById('confirmAddUserButton').disabled = false;
        document.getElementById('confirmAddUserButton').style.opacity = '1';

        console.log('[SocietyOrganizer] Selected user:', name);
    }

    clearSelectedUser() {
        this.selectedUserForAdd = null;
        document.getElementById('selectedUserDisplay').style.display = 'none';
        document.getElementById('roleAssignmentSection').style.display = 'none';
        document.getElementById('confirmAddUserButton').disabled = true;
        document.getElementById('confirmAddUserButton').style.opacity = '0.5';
        document.getElementById('addUserSearchInput').value = '';
    }

    updateRolePreview(role) {
        console.log('[SocietyOrganizer] Role selected:', role);
    }

    async confirmAddUser() {
        if (!this.selectedUserForAdd) {
            NotificationManager.show('Please select a user first', 'error');
            return;
        }

        const selectedRole = document.querySelector('input[name="userRole"]:checked')?.value;
        if (!selectedRole) {
            NotificationManager.show('Please select a role', 'error');
            return;
        }

        const organizerId = AppState.currentUser?.lineUserId;
        if (!organizerId) {
            NotificationManager.show('Not authenticated', 'error');
            return;
        }

        try {
            const { data, error} = await window.SupabaseDB.client
                .from('society_organizer_roles')
                .insert({
                    user_id: this.selectedUserForAdd.userId,
                    organizer_id: organizerId,
                    role: selectedRole
                });

            if (error) {
                console.error('[SocietyOrganizer] Error adding user:', error);
                NotificationManager.show('Failed to add user', 'error');
                return;
            }

            NotificationManager.show(`✅ ${this.selectedUserForAdd.name} added as ${selectedRole.replace('_', ' ')}`, 'success');
            this.closeAddUserModal();
            await this.loadAdminUsers();
        } catch (error) {
            console.error('[SocietyOrganizer] Exception adding user:', error);
            NotificationManager.show('Failed to add user', 'error');
        }
    }

    async changeUserRole(userId) {
        const newRole = prompt('Enter new role (super_admin, admin, or staff):');
        if (!newRole || !['super_admin', 'admin', 'staff'].includes(newRole)) {
            NotificationManager.show('Invalid role', 'error');
            return;
        }

        const organizerId = AppState.currentUser?.lineUserId;
        try {
            const { error } = await window.SupabaseDB.client
                .from('society_organizer_roles')
                .update({ role: newRole })
                .eq('user_id', userId)
                .eq('organizer_id', organizerId);

            if (error) {
                console.error('[SocietyOrganizer] Error changing role:', error);
                NotificationManager.show('Failed to change role', 'error');
                return;
            }

            NotificationManager.show('Role updated successfully', 'success');
            await this.loadAdminUsers();
        } catch (error) {
            console.error('[SocietyOrganizer] Exception changing role:', error);
            NotificationManager.show('Failed to change role', 'error');
        }
    }

    async removeUser(userId) {
        if (!confirm('Remove this user from dashboard access?')) return;

        const organizerId = AppState.currentUser?.lineUserId;
        try {
            const { error } = await window.SupabaseDB.client
                .from('society_organizer_roles')
                .delete()
                .eq('user_id', userId)
                .eq('organizer_id', organizerId);

            if (error) {
                console.error('[SocietyOrganizer] Error removing user:', error);
                NotificationManager.show('Failed to remove user', 'error');
                return;
            }

            NotificationManager.show('User removed successfully', 'success');
            await this.loadAdminUsers();
        } catch (error) {
            console.error('[SocietyOrganizer] Exception removing user:', error);
            NotificationManager.show('Failed to remove user', 'error');
        }
    }

    cleanup() {
        SocietyGolfDB.unsubscribeAll();
    }
}

// Recurring Event Helper Functions
function toggleRecurringOptions() {
    const checkbox = document.getElementById('eventRecurring');
    const options = document.getElementById('recurringOptions');
    options.style.display = checkbox.checked ? 'block' : 'none';

    if (checkbox.checked) {
        updateRecurringPattern();
    }
}

function updateRecurringPattern() {
    const frequency = document.getElementById('eventRecurFrequency').value;
    const dayOfWeekContainer = document.getElementById('recurDayOfWeekContainer');
    const monthlyPatternContainer = document.getElementById('recurMonthlyPatternContainer');

    if (frequency === 'monthly') {
        dayOfWeekContainer.style.display = 'none';
        monthlyPatternContainer.style.display = 'block';
    } else {
        dayOfWeekContainer.style.display = 'block';
        monthlyPatternContainer.style.display = 'none';
    }
}

function updateRecurEndOptions() {
    const endType = document.getElementById('eventRecurEndType').value;
    const untilContainer = document.getElementById('recurUntilContainer');
    const countContainer = document.getElementById('recurCountContainer');

    if (endType === 'until') {
        untilContainer.style.display = 'block';
        countContainer.style.display = 'none';
    } else {
        untilContainer.style.display = 'none';
        countContainer.style.display = 'block';
    }
}

// ==================================================================
// LIVE GAMES SYSTEM - Multi-Group Side Game Competition
// ==================================================================
// Allows multiple groups to compete in Skins, Match Play, Nassau
// across different tee times on the same course/day
// ==================================================================

const LiveGamesSystem = {
    // =====================================================
    // CORE HELPERS - Progress & Fairness Cutoff
    // =====================================================

    /**
     * Compute holes completed from scores cache
     * Returns { playerId: maxHole }
     */
    computeHolesCompleted(scoresCache) {
        const completed = {};
        for (const [playerId, holes] of Object.entries(scoresCache)) {
            const maxHole = Math.max(0, ...Object.keys(holes).map(h => parseInt(h)).filter(h => !isNaN(h)));
            completed[playerId] = maxHole || 0;
        }
        return completed;
    },

    /**
     * Get fairness cutoff: minimum hole completed across entrants
     */
    commonCutoffHole(entrantIds, holesCompleted) {
        if (!entrantIds || entrantIds.length === 0) return 0;
        let min = Infinity;
        for (const id of entrantIds) {
            const h = holesCompleted[id] || 0;
            if (h < min) min = h;
        }
        return Number.isFinite(min) ? min : 0;
    },

    /**
     * Filter scores to only include up to cutoff hole
     */
    filterScoresToCutoff(scoresCache, playerId, cutoffHole) {
        const playerScores = scoresCache[playerId] || {};
        const filtered = {};
        for (const [hole, score] of Object.entries(playerScores)) {
            const holeNum = parseInt(hole);
            if (holeNum <= cutoffHole) {
                filtered[hole] = score;
            }
        }
        return filtered;
    },

    // =====================================================
    // POOL MANAGEMENT
    // =====================================================

    /**
     * Create a new side game pool
     */
    async createPool(poolData) {
        try {
            const { data, error } = await window.SupabaseDB.client
                .from('side_game_pools')
                .insert({
                    course_id: poolData.courseId,
                    event_id: poolData.eventId || null,
                    date_iso: poolData.dateISO,
                    type: poolData.type,
                    name: poolData.name,
                    is_public: poolData.isPublic !== false,
                    config: poolData.config || {},
                    created_by: poolData.createdBy
                })
                .select()
                .single();

            if (error) throw error;

            console.log('[LiveGames] Pool created:', data);
            return { success: true, pool: data };
        } catch (error) {
            console.error('[LiveGames] Error creating pool:', error);
            return { success: false, error: error.message };
        }
    },

    /**
     * Join a pool
     */
    async joinPool(poolId, playerId) {
        try {
            const { data, error } = await window.SupabaseDB.client
                .from('pool_entrants')
                .insert({
                    pool_id: poolId,
                    player_id: playerId
                })
                .select()
                .single();

            if (error) throw error;

            console.log('[LiveGames] Joined pool:', poolId);
            return { success: true };
        } catch (error) {
            console.error('[LiveGames] Error joining pool:', error);
            return { success: false, error: error.message };
        }
    },

    /**
     * Leave a pool
     */
    async leavePool(poolId, playerId) {
        try {
            const { error } = await window.SupabaseDB.client
                .from('pool_entrants')
                .delete()
                .eq('pool_id', poolId)
                .eq('player_id', playerId);

            if (error) throw error;

            console.log('[LiveGames] Left pool:', poolId);
            return { success: true };
        } catch (error) {
            console.error('[LiveGames] Error leaving pool:', error);
            return { success: false, error: error.message };
        }
    },

    /**
     * Get available pools for current scope
     */
    async getAvailablePools(courseId, dateISO, eventId = null) {
        try {
            let query = window.SupabaseDB.client
                .from('side_game_pools')
                .select(`
                    *,
                    pool_entrants (
                        player_id,
                        joined_at
                    )
                `)
                .eq('course_id', courseId)
                .eq('date_iso', dateISO)
                .eq('status', 'active')
                .eq('is_public', true);

            if (eventId) {
                query = query.eq('event_id', eventId);
            }

            const { data, error } = await query;

            if (error) throw error;

            console.log(`[LiveGames] Found ${data?.length || 0} available pools`);
            return { success: true, pools: data || [] };
        } catch (error) {
            console.error('[LiveGames] Error getting pools:', error);
            return { success: false, error: error.message, pools: [] };
        }
    },

    /**
     * Update live progress for a player
     */
    async updateProgress(poolId, playerId, hole) {
        try {
            const { error } = await window.SupabaseDB.client
                .rpc('update_live_progress', {
                    p_pool_id: poolId,
                    p_player_id: playerId,
                    p_hole: hole
                });

            if (error) throw error;

            return { success: true };
        } catch (error) {
            console.error('[LiveGames] Error updating progress:', error);
            return { success: false, error: error.message };
        }
    },

    // =====================================================
    // LEADERBOARD CALCULATIONS
    // =====================================================

    /**
     * Calculate Skins leaderboard with fairness cutoff
     */
    async calculateSkinsLeaderboard(pool, allPlayerData, courseData) {
        // Get holes completed for all entrants
        const holesCompleted = {};
        for (const player of allPlayerData) {
            const maxHole = Math.max(0, ...Object.keys(player.scores).map(h => parseInt(h)));
            holesCompleted[player.playerId] = maxHole || 0;
        }

        // Get fairness cutoff
        const entrantIds = pool.pool_entrants.map(e => e.player_id);
        const cutoff = this.commonCutoffHole(entrantIds, holesCompleted);

        if (cutoff < 1) {
            return {
                cutoffHole: 0,
                leaderboard: [],
                message: 'Waiting for all players to complete at least one hole...'
            };
        }

        // Filter player data to cutoff
        const filteredPlayers = allPlayerData.map(player => ({
            ...player,
            scores: Object.fromEntries(
                Object.entries(player.scores).filter(([hole]) => parseInt(hole) <= cutoff)
            )
        }));

        // Calculate skins using existing engine
        const pointsPerHole = pool.config.pointsPerHole || 100;
        const skinsResults = window.golfScoringEngine.calculateSkins(
            filteredPlayers.map(p => ({
                playerId: p.playerId,
                playerName: p.playerName,
                scores: Object.entries(p.scores).map(([hole, strokes]) => ({
                    hole_number: parseInt(hole),
                    gross_score: strokes
                })),
                handicap: p.handicap
            })),
            courseData.holes,
            pool.config.useNet !== false,
            pointsPerHole
        );

        // Build leaderboard
        const leaderboard = entrantIds.map(playerId => {
            const player = allPlayerData.find(p => p.playerId === playerId);
            return {
                playerId: playerId,
                playerName: player?.playerName || 'Unknown',
                totalPoints: skinsResults.skinsWon[playerId] || 0,
                frontNine: skinsResults.frontNine[playerId] || 0,
                backNine: skinsResults.backNine[playerId] || 0,
                holesCompleted: holesCompleted[playerId] || 0
            };
        });

        // Sort by total points
        leaderboard.sort((a, b) => b.totalPoints - a.totalPoints);

        return {
            cutoffHole: cutoff,
            leaderboard: leaderboard,
            holeResults: skinsResults.holeResults
        };
    },

    /**
     * Calculate Match Play leaderboard with fairness cutoff
     */
    async calculateMatchPlayLeaderboard(pool, allPlayerData, courseData) {
        const holesCompleted = {};
        for (const player of allPlayerData) {
            const maxHole = Math.max(0, ...Object.keys(player.scores).map(h => parseInt(h)));
            holesCompleted[player.playerId] = maxHole || 0;
        }

        const entrantIds = pool.pool_entrants.map(e => e.player_id);
        const cutoff = this.commonCutoffHole(entrantIds, holesCompleted);

        if (cutoff < 1) {
            return {
                cutoffHole: 0,
                leaderboard: [],
                message: 'Waiting for players to complete holes...'
            };
        }

        // Filter to cutoff
        const filteredPlayers = allPlayerData.map(player => ({
            ...player,
            scores: Object.fromEntries(
                Object.entries(player.scores).filter(([hole]) => parseInt(hole) <= cutoff)
            )
        }));

        // Calculate match play using existing engine
        const matchResults = window.golfScoringEngine.calculateMatchPlay(
            filteredPlayers.map(p => ({
                playerId: p.playerId,
                playerName: p.playerName,
                scores: Object.entries(p.scores).map(([hole, strokes]) => ({
                    hole_number: parseInt(hole),
                    gross_score: strokes
                })),
                handicap: p.handicap
            })),
            courseData.holes,
            pool.config.useNet !== false
        );

        // Build leaderboard
        const leaderboard = entrantIds.map(playerId => {
            const player = allPlayerData.find(p => p.playerId === playerId);
            const matchData = matchResults[playerId] || {};
            return {
                playerId: playerId,
                playerName: player?.playerName || 'Unknown',
                holesUp: matchData.holesUp || 0,
                holesDown: matchData.holesDown || 0,
                holesHalved: matchData.holesHalved || 0,
                netHoles: matchData.netHoles || 0,
                status: matchData.status || 'All Square',
                matchFinished: matchData.matchFinished || false,
                holesCompleted: holesCompleted[playerId] || 0
            };
        });

        // Sort by net holes (most up first)
        leaderboard.sort((a, b) => b.netHoles - a.netHoles);

        return {
            cutoffHole: cutoff,
            leaderboard: leaderboard
        };
    },

    /**
     * Get pool leaderboard
     */
    async getPoolLeaderboard(poolId) {
        try {
            // Get pool with entrants
            const { data: pool, error: poolError } = await window.SupabaseDB.client
                .from('side_game_pools')
                .select(`
                    *,
                    pool_entrants (
                        player_id,
                        joined_at
                    )
                `)
                .eq('id', poolId)
                .single();

            if (poolError) throw poolError;

            // Get all players' scores for this pool
            // TODO: Fetch actual scorecard data based on pool scope
            // For now, return structure
            return {
                success: true,
                pool: pool,
                leaderboard: null,
                message: 'Leaderboard calculation in progress...'
            };

        } catch (error) {
            console.error('[LiveGames] Error getting leaderboard:', error);
            return { success: false, error: error.message };
        }
    }
};

// Make available globally
window.LiveGamesSystem = LiveGamesSystem;
console.log('[LiveGames] ✅ Multi-group competition system loaded');

// Initialize global instance
window.SocietyOrganizerSystem = new SocietyOrganizerManager();

// ==================================================================
// GOLFER EVENTS SYSTEM - Browse and Register for Society Events
// ==================================================================
class GolferEventsManager {
    constructor() {
        this.allEvents = [];
        this.filteredEvents = [];
        this.currentEvent = null;
        this.currentView = 'browse';
        this.calendarDate = new Date();
        this.myRegistrations = [];

        // Cache system for instant loading
        this.eventsCache = null;
        this.cacheTimestamp = null;
        this.cachedUserId = null; // FIXED: Track which user the cache belongs to
        this.CACHE_DURATION = 2 * 60 * 1000; // 2 minutes

        // Society subscriptions - Start empty, load from database in init()
        this.subscribedSocieties = [];
        this.allSocieties = [];
    }

    async init() {
        console.log('[GolferEventsSystem] Initializing...');

        // CRITICAL: Load subscriptions from database first
        await this.loadSubscriptionsFromDatabase();

        // Try to show cached data immediately if available
        if (this.isCacheValid()) {
            console.log('[GolferEventsSystem] ⚡ Using cached events (instant load)');
            this.allEvents = this.eventsCache;
            this.filteredEvents = this.allEvents;
            this.renderEvents();

            // Refresh in background
            this.loadEvents(false).then(() => {
                this.filterEvents();
            });
        } else {
            this.showLoadingState();
            await this.loadEvents();
            this.renderEvents();
        }

        // Subscribe to real-time event updates
        this.subscribeToEventChanges();
    }

    subscribeToEventChanges() {
        console.log('[GolferEventsSystem] 🔔 Setting up real-time subscriptions...');

        // Subscribe to society_events table changes (when organizer updates event details)
        SocietyGolfDB.subscribeToEvents((payload) => {
            console.log('[GolferEventsSystem] 📡 Event change detected:', payload.eventType);

            // Show notification to user about the update
            if (payload.eventType === 'UPDATE') {
                NotificationManager.show('Event information updated', 'info', 3000);
            } else if (payload.eventType === 'INSERT') {
                NotificationManager.show('New event available', 'success', 3000);
            } else if (payload.eventType === 'DELETE') {
                NotificationManager.show('An event was cancelled', 'warning', 3000);
            }

            // Refresh events list to show updated information
            this.loadEvents(false).then(() => {
                this.filterEvents();
                console.log('[GolferEventsSystem] ✅ Events refreshed after update');
            });
        });

        // Subscribe to ALL registration changes (when players register/unregister)
        const registrationSubscription = window.SupabaseDB.client
            .channel('golfer_view_registrations')
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'event_registrations'
            }, (payload) => {
                console.log('[GolferEventsSystem] 📡 Registration change detected:', payload.eventType);

                // Only show notification if it affects current user
                const currentUserId = AppState.currentUser?.lineUserId;
                if (payload.new?.player_id === currentUserId || payload.old?.player_id === currentUserId) {
                    if (payload.eventType === 'DELETE') {
                        NotificationManager.show('You have been removed from an event', 'warning', 3000);
                    }
                }

                // Refresh events to update registration counts and availability
                this.loadEvents(false).then(() => {
                    this.filterEvents();
                });
            })
            .subscribe();

        // Subscribe to ALL waitlist changes (when players are promoted/added to waitlist)
        const waitlistSubscription = window.SupabaseDB.client
            .channel('golfer_view_waitlist')
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'event_waitlist'
            }, (payload) => {
                console.log('[GolferEventsSystem] 📡 Waitlist change detected:', payload.eventType);

                // Refresh events to update waitlist counts and availability
                this.loadEvents(false).then(() => {
                    this.filterEvents();
                });
            })
            .subscribe();

        console.log('[GolferEventsSystem] ✅ Real-time subscriptions active (events, registrations, waitlist)');

    }

    
    isCacheValid() {
        if (!this.eventsCache || !this.cacheTimestamp) return false;

        // FIXED: Validate cache belongs to current user to prevent showing wrong registration status
        const currentUserId = AppState.currentUser?.lineUserId;
        if (this.cachedUserId !== currentUserId) {
            console.log('[GolferEventsSystem] ❌ Cache invalid: user changed from', this.cachedUserId, 'to', currentUserId);
            // Clear invalid cache
            this.eventsCache = null;
            this.cacheTimestamp = null;
            this.cachedUserId = null;
            return false;
        }

        const age = Date.now() - this.cacheTimestamp;
        const isValid = age < this.CACHE_DURATION;

        if (!isValid) {
            console.log('[GolferEventsSystem] ❌ Cache expired (age:', age, 'ms)');
        }

        return isValid;
    }

    showEventsView(view) {
        // Hide all views
        document.getElementById('eventsViewBrowseContent').style.display = 'none';
        document.getElementById('eventsViewCalendarContent').style.display = 'none';
        document.getElementById('eventsViewMyEventsContent').style.display = 'none';
        document.getElementById('eventsViewHistoryContent').style.display = 'none';

        // Remove active class from all buttons
        document.querySelectorAll('.events-subtab-btn').forEach(btn => {
            btn.classList.remove('active', 'border-green-500', 'text-green-600');
            btn.classList.add('border-transparent', 'text-gray-600');
        });

        // Show selected view
        this.currentView = view;
        if (view === 'browse') {
            document.getElementById('eventsViewBrowseContent').style.display = 'block';
            document.getElementById('eventsViewBrowse').classList.add('active', 'border-green-500', 'text-green-600');
            document.getElementById('eventsViewBrowse').classList.remove('border-transparent', 'text-gray-600');
        } else if (view === 'calendar') {
            document.getElementById('eventsViewCalendarContent').style.display = 'block';
            document.getElementById('eventsViewCalendar').classList.add('active', 'border-green-500', 'text-green-600');
            document.getElementById('eventsViewCalendar').classList.remove('border-transparent', 'text-gray-600');
            this.renderCalendar();
        } else if (view === 'myevents') {
            document.getElementById('eventsViewMyEventsContent').style.display = 'block';
            document.getElementById('eventsViewMyEvents').classList.add('active', 'border-green-500', 'text-green-600');
            document.getElementById('eventsViewMyEvents').classList.remove('border-transparent', 'text-gray-600');
            this.loadMyRegistrations();
        } else if (view === 'history') {
            document.getElementById('eventsViewHistoryContent').style.display = 'block';
            document.getElementById('eventsViewHistory').classList.add('active', 'border-green-500', 'text-green-600');
            document.getElementById('eventsViewHistory').classList.remove('border-transparent', 'text-gray-600');
            this.loadMyHistory();
        }
    }

    async loadEvents(showLoading = true) {
        try {
            if (showLoading) {
                console.log('[GolferEventsSystem] Loading all society events...');
            } else {
                console.log('[GolferEventsSystem] Background refresh...');
            }

            // Load ALL society events (now includes user registration status in one call)
            const events = await window.SocietyGolfDB.getAllPublicEvents();

            this.allEvents = events || [];

            // Load favorites from localStorage and mark events
            const favorites = JSON.parse(localStorage.getItem('mcipro_favorite_events') || '[]');
            this.allEvents.forEach(event => {
                event.isFavorited = favorites.includes(event.id);
            });

            this.filteredEvents = this.allEvents;

            // Update cache with current user ID
            this.eventsCache = this.allEvents;
            this.cacheTimestamp = Date.now();
            this.cachedUserId = AppState.currentUser?.lineUserId; // FIXED: Store user ID with cache

            // Update society subscriptions display
            this.updateSelectedSocietiesDisplay();

            console.log(`[GolferEventsSystem] ✅ Loaded ${this.allEvents.length} events${!showLoading ? ' (background)' : ''}`);
        } catch (error) {
            console.error('[GolferEventsSystem] Error loading events:', error);
            this.allEvents = [];
            this.filteredEvents = [];
        }
    }

    async refreshEvents() {
        // Force refresh - bypass cache
        this.showLoadingState();

        // Clear cache to force fresh data
        this.eventsCache = null;
        this.cacheTimestamp = null;

        await this.loadEvents(true);
        this.filterEvents();

        NotificationManager.show('Events refreshed', 'success', 2000);
    }

    showLoadingState() {
        const grid = document.getElementById('societyEventsGrid');
        if (!grid) return;

        grid.innerHTML = `
            <div class="col-span-full text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-green-500 border-t-transparent mb-4"></div>
                <p class="text-gray-600 font-medium">Loading events...</p>
            </div>
        `;
    }

    filterEvents() {
        const searchTerm = document.getElementById('societyEventSearch')?.value.toLowerCase() || '';
        const dateFilter = document.getElementById('societyEventDateFilter')?.value || 'all';
        const statusFilter = document.getElementById('societyEventStatusFilter')?.value || 'all';

        // Determine if user is actively searching/filtering
        const isActivelySearching = searchTerm || dateFilter !== 'all' || statusFilter !== 'all';

        this.filteredEvents = this.allEvents.filter(event => {
            // Get society name (use societyName or fallback to organizerName)
            const eventSocietyName = event.societyName || event.organizerName;

            // SOCIETY SUBSCRIPTION FILTER (only when NOT actively searching)
            if (!isActivelySearching && this.subscribedSocieties.length > 0) {
                if (!this.subscribedSocieties.includes(eventSocietyName)) {
                    return false;
                }
            }

            // Text search
            if (searchTerm) {
                const searchableText = `${event.name} ${event.courseName} ${event.organizerName} ${eventSocietyName}`.toLowerCase();
                if (!searchableText.includes(searchTerm)) return false;
            }

            // Date filter
            if (dateFilter !== 'all') {
                const eventDate = new Date(event.date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (dateFilter === 'upcoming') {
                    const weekFromNow = new Date(today);
                    weekFromNow.setDate(weekFromNow.getDate() + 7);
                    if (eventDate < today || eventDate > weekFromNow) return false;
                } else if (dateFilter === 'thismonth') {
                    if (eventDate.getMonth() !== today.getMonth() || eventDate.getFullYear() !== today.getFullYear()) return false;
                } else if (dateFilter === 'nextmonth') {
                    const nextMonth = new Date(today);
                    nextMonth.setMonth(nextMonth.getMonth() + 1);
                    if (eventDate.getMonth() !== nextMonth.getMonth() || eventDate.getFullYear() !== nextMonth.getFullYear()) return false;
                }
            }

            // Status filter
            if (statusFilter !== 'all') {
                // Favorites filter
                if (statusFilter === 'favorites') {
                    if (!event.isFavorited) return false;
                } else {
                    // Other status filters
                    const registered = event.registeredCount || 0;
                    const max = event.maxPlayers || 999;
                    const availability = max - registered;

                    if (statusFilter === 'open' && availability <= 0) return false;
                    if (statusFilter === 'filling' && (availability > max * 0.3 || availability <= 0)) return false;
                    if (statusFilter === 'waitlist' && availability > 0) return false;
                }
            }

            return true;
        });

        this.renderEvents();
    }

    renderEvents() {
        const grid = document.getElementById('societyEventsGrid');
        if (!grid) return;

        if (this.filteredEvents.length === 0) {
            grid.innerHTML = `
                <div class="col-span-full text-center py-12 text-gray-500">
                    <span class="material-symbols-outlined text-5xl mb-3 text-gray-300">search_off</span>
                    <p class="text-lg">No events found</p>
                    <p class="text-sm">Try adjusting your filters</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = this.filteredEvents.map(event => this.renderEventCard(event)).join('');
    }

    renderEventCard(event) {
        const eventDate = new Date(event.date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const isPast = eventDate < today;

        const registered = event.registeredCount || 0;
        const max = event.maxPlayers || 0;
        const availability = max - registered;
        const isFull = max > 0 && availability <= 0;
        const isFillingFast = max > 0 && availability > 0 && availability <= max * 0.3;

        // Check if registration is closed (past cutoff)
        let isPastCutoff = false;
        if (event.cutoff) {
            const cutoffDate = new Date(event.cutoff);
            const now = new Date();
            isPastCutoff = now > cutoffDate;
        }

        // Check if current user is registered for this event
        const isUserRegistered = event.isUserRegistered || false;

        let statusBadge = '';
        if (isUserRegistered) {
            statusBadge = '<span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-600 rounded-full">✓ Registered</span>';
        } else if (isPast) {
            statusBadge = '<span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-600 rounded-full">Past Event</span>';
        } else if (isPastCutoff) {
            statusBadge = '<span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-700 rounded-full">Closed</span>';
        } else if (isFull) {
            statusBadge = '<span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-600 rounded-full">Full - Waitlist</span>';
        } else if (isFillingFast) {
            statusBadge = '<span class="px-2 py-1 text-xs font-medium bg-amber-100 text-amber-600 rounded-full">Filling Fast</span>';
        } else {
            statusBadge = '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-600 rounded-full">Open</span>';
        }

        const totalFee = (event.baseFee || 0) + (event.cartFee || 0) + (event.caddyFee || 0);

        // Check if event is favorited
        const isFavorited = event.isFavorited || false;
        const starIcon = isFavorited ? 'star' : 'star_outline';

        return `
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow cursor-pointer"
                 onclick="GolferEventsSystem.openEventDetail('${event.id}')">
                <!-- Header with Society Branding -->
                <div class="bg-gradient-to-r from-green-500 to-green-400 px-4 py-3 text-white relative">
                    <!-- Favorite Star (absolute positioned top-right) -->
                    <button onclick="event.stopPropagation(); GolferEventsSystem.toggleFavorite('${event.id}')"
                            class="absolute top-2 right-2 p-1 hover:bg-white/20 rounded-full transition-colors"
                            title="${isFavorited ? 'Remove from favorites' : 'Add to favorites'}">
                        <span class="material-symbols-outlined text-yellow-300 ${isFavorited ? 'fill-icon' : ''}">${starIcon}</span>
                    </button>

                    <div class="flex items-start justify-between mb-2 pr-8">
                        <div class="flex items-center flex-1 pr-2">
                            ${event.societyLogo ? `
                                <img src="${event.societyLogo}" alt="${event.societyName}" class="w-10 h-10 rounded-full border-2 border-white mr-3 object-cover bg-white">
                            ` : ''}
                            <div class="flex-1">
                                <h3 class="font-bold text-lg">${event.name}</h3>
                                <div class="text-xs text-green-50 mt-1">
                                    ${event.societyName || event.organizerName || 'Society Golf'}
                                </div>
                            </div>
                        </div>
                        ${statusBadge}
                    </div>
                </div>

                <!-- Body -->
                <div class="p-4 space-y-3">
                    <!-- Date & Time -->
                    <div class="flex items-center text-sm">
                        <span class="material-symbols-outlined text-gray-400 text-base mr-2">event</span>
                        <div>
                            <div class="font-medium text-gray-900">${this.formatDate(event.date)}</div>
                            ${event.startTime ? `<div class="text-xs text-gray-600 mt-0.5">⏰ Departure: ${event.startTime}</div>` : ''}
                        </div>
                    </div>

                    <!-- Course -->
                    <div class="flex items-center text-sm">
                        <span class="material-symbols-outlined text-gray-400 text-base mr-2">golf_course</span>
                        <span class="text-gray-700">${event.courseName || 'TBD'}</span>
                    </div>

                    <!-- Event Format -->
                    ${event.eventFormat && event.eventFormat !== 'strokeplay' ? `
                    <div class="flex items-center text-sm">
                        <span class="material-symbols-outlined text-gray-400 text-base mr-2">sports_golf</span>
                        <span class="text-gray-700 font-medium">${this.formatEventFormat(event.eventFormat)}</span>
                    </div>
                    ` : ''}

                    <!-- Availability -->
                    ${max > 0 ? `
                    <div class="flex items-center text-sm">
                        <span class="material-symbols-outlined text-gray-400 text-base mr-2">groups</span>
                        <span class="text-gray-700">${registered}/${max} registered</span>
                        <span class="ml-auto text-xs ${availability > 0 ? 'text-green-600' : 'text-red-600'} font-medium">
                            ${availability > 0 ? `${availability} spots left` : 'Full'}
                        </span>
                    </div>
                    ` : ''}

                    <!-- Fee -->
                    ${totalFee > 0 ? `
                    <div class="flex items-center text-sm">
                        <span class="material-symbols-outlined text-gray-400 text-base mr-2">payments</span>
                        <span class="text-gray-700">฿${totalFee.toLocaleString()}</span>
                    </div>
                    ` : ''}
                </div>

                <!-- Footer -->
                <div class="px-4 py-3 bg-gray-50 border-t">
                    ${isUserRegistered && !isPast ? `
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <button class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white text-sm py-2 px-3 rounded-lg transition-all flex items-center justify-center gap-1 shadow-md"
                                onclick="event.stopPropagation(); GolferEventsSystem.quickBookFromEvent('${event.id}')"
                                title="Book tee time">
                            <span class="material-symbols-outlined text-sm">golf_course</span>
                            Book Tee Time
                        </button>
                        <button class="bg-gradient-to-r from-teal-600 to-teal-700 hover:from-teal-700 hover:to-teal-800 text-white text-sm py-2 px-3 rounded-lg transition-all flex items-center justify-center gap-1 shadow-md"
                                onclick="event.stopPropagation(); GolferEventsSystem.quickBookFromEvent('${event.id}')"
                                title="Request caddy">
                            <span class="material-symbols-outlined text-sm">person</span>
                            Request Caddy
                        </button>
                    </div>
                    ` : ''}
                    <div class="grid grid-cols-3 gap-2">
                        <button class="col-span-2 btn-primary text-sm py-2" onclick="event.stopPropagation(); GolferEventsSystem.openEventDetail('${event.id}')">
                            <span class="material-symbols-outlined text-sm">info</span>
                            View Details
                        </button>
                        <button class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-3 rounded-lg transition-colors flex items-center justify-center gap-1"
                                onclick="event.stopPropagation(); GolferEventsSystem.openShareModal('${event.id}')"
                                title="Share with friends">
                            <span class="material-symbols-outlined text-sm">share</span>
                            Share
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-GB', {
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    formatEventFormat(format) {
        const formats = {
            'strokeplay': 'Stroke Play',
            '2man_scramble': '2-Man Scramble',
            '4man_scramble': '4-Man Scramble',
            'scramble': 'Scramble',
            'matchplay': 'Match Play',
            'stableford': 'Stableford',
            'best_ball': 'Best Ball',
            'alternate_shot': 'Alternate Shot'
        };
        return formats[format] || format;
    }

    async openEventDetail(eventId) {
        this.currentEvent = this.allEvents.find(e => e.id === eventId);
        if (!this.currentEvent) return;

        // Populate modal
        document.getElementById('eventDetailName').textContent = this.currentEvent.name;
        const organizerText = this.currentEvent.societyName || this.currentEvent.organizerName || 'Society Organizer';
        document.getElementById('eventDetailOrganizer').innerHTML = `
            ${this.currentEvent.societyLogo ? `<img src="${this.currentEvent.societyLogo}" alt="${organizerText}" class="inline-block w-6 h-6 rounded-full border border-green-200 mr-2 object-cover bg-white">` : ''}
            Organized by ${organizerText}
        `;
        document.getElementById('eventDetailDate').textContent = this.formatDate(this.currentEvent.date);
        document.getElementById('eventDetailCourse').textContent = this.currentEvent.courseName || 'TBD';

        // Event Format
        if (this.currentEvent.eventFormat && this.currentEvent.eventFormat !== 'strokeplay') {
            document.getElementById('eventDetailFormat').textContent = this.formatEventFormat(this.currentEvent.eventFormat);
            document.getElementById('eventDetailFormatContainer').style.display = 'flex';
        } else {
            document.getElementById('eventDetailFormatContainer').style.display = 'none';
        }

        // Cutoff
        if (this.currentEvent.cutoff) {
            const cutoffDate = new Date(this.currentEvent.cutoff);
            document.getElementById('eventDetailCutoff').textContent = cutoffDate.toLocaleString('en-GB', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } else {
            document.getElementById('eventDetailCutoff').textContent = 'Not specified';
        }

        // Availability
        const registered = this.currentEvent.registeredCount || 0;
        const max = this.currentEvent.maxPlayers || 0;
        const availability = max - registered;

        if (max > 0) {
            document.getElementById('eventDetailAvailability').textContent = `${registered}/${max} registered (${availability} spots left)`;
        } else {
            document.getElementById('eventDetailAvailability').textContent = 'Unlimited';
        }

        // Fees
        const fees = [];
        if (this.currentEvent.baseFee) fees.push(`<div class="flex justify-between"><span>Green Fee:</span><span class="font-medium">฿${this.currentEvent.baseFee.toLocaleString()}</span></div>`);
        if (this.currentEvent.cartFee) fees.push(`<div class="flex justify-between"><span>Cart Fee:</span><span class="font-medium">฿${this.currentEvent.cartFee.toLocaleString()}</span></div>`);
        if (this.currentEvent.caddyFee) fees.push(`<div class="flex justify-between"><span>Caddy Fee:</span><span class="font-medium">฿${this.currentEvent.caddyFee.toLocaleString()}</span></div>`);
        if (this.currentEvent.transportFee) fees.push(`<div class="flex justify-between"><span>Transportation:</span><span class="font-medium">฿${this.currentEvent.transportFee.toLocaleString()}</span></div>`);
        if (this.currentEvent.competitionFee) fees.push(`<div class="flex justify-between"><span>Competition Entry:</span><span class="font-medium">฿${this.currentEvent.competitionFee.toLocaleString()}</span></div>`);

        const totalFee = (this.currentEvent.baseFee || 0) + (this.currentEvent.cartFee || 0) + (this.currentEvent.caddyFee || 0);
        fees.push(`<div class="flex justify-between pt-2 border-t font-bold"><span>Total (base):</span><span class="text-green-600">฿${totalFee.toLocaleString()}</span></div>`);

        document.getElementById('eventDetailFees').innerHTML = fees.join('');

        // Notes
        if (this.currentEvent.notes) {
            document.getElementById('eventDetailNotes').textContent = this.currentEvent.notes;
            document.getElementById('eventDetailNotesSection').style.display = 'block';
        } else {
            document.getElementById('eventDetailNotesSection').style.display = 'none';
        }

        // Load and display registered players
        await this.loadRegisteredPlayers(eventId);

        // Load and display pairing information
        await this.loadGolferPairing(eventId);

        // Pre-fill player name and handicap from profile
        if (AppState.currentUser?.name) {
            document.getElementById('regPlayerName').value = AppState.currentUser.name;
        }

        // Get handicap from profile golfInfo
        const profileKey = UserIDSystem.getProfileKey(AppState.currentUser.role, AppState.currentUser.lineUserId || AppState.currentUser.userId);
        const profile = JSON.parse(localStorage.getItem(profileKey) || '{}');
        const handicap = profile.golfInfo?.handicap || AppState.currentUser?.handicap;

        if (handicap) {
            document.getElementById('regHandicap').value = handicap;
        }

        // Reset registration form (only if not in edit mode)
        if (!this.editingRegistrationId) {
            document.getElementById('registrationForm').style.display = 'none';
            document.getElementById('eventRegisterBtn').style.display = 'inline-flex';
            document.getElementById('eventSubmitBtn').style.display = 'none';

            // Reset checkboxes for new registration
            document.getElementById('regWantTransport').checked = false;
            document.getElementById('regWantCompetition').checked = false;
        }

        // Show modal
        document.getElementById('eventDetailModal').style.display = 'flex';
    }

    async loadRegisteredPlayers(eventId) {
        try {
            const registrations = await window.SocietyGolfDB.getRegistrations(eventId);
            const playerCount = document.getElementById('regPlayerCount');
            const playerContent = document.getElementById('registeredPlayersContent');

            if (registrations.length === 0) {
                playerCount.textContent = 'No players yet';
                playerContent.innerHTML = `
                    <p class="text-gray-500 text-center py-4">
                        <span class="material-symbols-outlined text-3xl mb-2 block">person_off</span>
                        Be the first to register!
                    </p>
                `;
                return;
            }

            playerCount.textContent = `${registrations.length} player${registrations.length !== 1 ? 's' : ''}`;

            playerContent.innerHTML = registrations.map((reg, index) => `
                <div class="flex items-center justify-between py-2 px-3 bg-white rounded-lg">
                    <div class="flex items-center">
                        <span class="w-6 h-6 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-xs font-medium mr-3">
                            ${index + 1}
                        </span>
                        <div>
                            <div class="font-medium text-gray-900">${reg.playerName}</div>
                            ${reg.handicap !== null && reg.handicap !== undefined ? `<div class="text-xs text-gray-500">HCP: ${Math.round(reg.handicap)}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-2 text-xs">
                        ${reg.wantTransport ? '<span class="text-blue-600" title="Transport">🚐</span>' : ''}
                        ${reg.wantCompetition ? '<span class="text-amber-600" title="Competition">🏆</span>' : ''}
                    </div>
                </div>
            `).join('');

            // Store registrations for partner preferences
            this.currentEventRegistrations = registrations;
        } catch (error) {
            console.error('[GolferEventsSystem] Error loading registered players:', error);
            document.getElementById('regPlayerCount').textContent = 'Error loading';
            document.getElementById('registeredPlayersContent').innerHTML = `
                <p class="text-red-500 text-center py-2 text-xs">Failed to load player list</p>
            `;
        }
    }

    async loadGolferPairing(eventId) {
        try {
            // Get pairings for this event
            const pairings = await window.SocietyGolfDB.getPairings(eventId);
            const section = document.getElementById('golferPairingSection');
            const content = document.getElementById('golferPairingContent');

            if (!pairings || !pairings.groups || pairings.groups.length === 0) {
                section.style.display = 'none';
                return;
            }

            // Find which group the current golfer is in
            const currentPlayerId = AppState.currentUser?.lineUserId || AppState.currentUser?.userId;
            let myGroup = null;
            let groupIndex = -1;
            let is2ManScramble = false;
            let fourBallGroupIndex = -1;

            // Check for 2-man scramble with 4-ball groups
            if (pairings.fourBallGroups && pairings.fourBallGroups.length > 0) {
                is2ManScramble = true;
                // Find which team the player is in
                for (let teamIdx = 0; teamIdx < pairings.groups.length; teamIdx++) {
                    const team = pairings.groups[teamIdx];
                    if (team.some(p => p.playerId === currentPlayerId)) {
                        // Found player's team, now find which 4-ball group it's in
                        for (let groupIdx = 0; groupIdx < pairings.fourBallGroups.length; groupIdx++) {
                            const fourBallGroup = pairings.fourBallGroups[groupIdx];
                            if (fourBallGroup.teamIndices && fourBallGroup.teamIndices.includes(teamIdx)) {
                                fourBallGroupIndex = groupIdx;
                                groupIndex = teamIdx;
                                break;
                            }
                        }
                        break;
                    }
                }
            } else {
                // Regular format - find group
                groupIndex = pairings.groups.findIndex(group =>
                    group.some(p => p.playerId === currentPlayerId)
                );
                if (groupIndex !== -1) {
                    myGroup = pairings.groups[groupIndex];
                }
            }

            if (groupIndex === -1 && fourBallGroupIndex === -1) {
                // Player not in any group
                content.innerHTML = `
                    <div class="text-center py-3 text-gray-600">
                        <span class="material-symbols-outlined text-2xl mb-1 block">pending</span>
                        <p class="text-sm">Pairings have been set, but you're not assigned to a group yet.</p>
                        <p class="text-xs text-gray-500 mt-1">Contact the organizer if you should be included.</p>
                    </div>
                `;
                section.style.display = 'block';
                return;
            }

            // Display pairing information
            if (is2ManScramble && fourBallGroupIndex !== -1) {
                const fourBallGroup = pairings.fourBallGroups[fourBallGroupIndex];
                const team1Idx = fourBallGroup.teamIndices[0];
                const team2Idx = fourBallGroup.teamIndices[1];
                const team1 = team1Idx !== undefined ? pairings.groups[team1Idx] : null;
                const team2 = team2Idx !== undefined ? pairings.groups[team2Idx] : null;

                content.innerHTML = `
                    <div class="bg-white rounded-lg p-3 border border-green-300">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-bold text-green-700">Group ${fourBallGroupIndex + 1}</span>
                            <span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">2-Man Scramble</span>
                        </div>

                        ${team1 ? `
                            <div class="bg-purple-50 rounded p-2 mb-2">
                                <div class="text-xs font-bold text-purple-900 mb-1">Team A</div>
                                ${team1.map(player => `
                                    <div class="flex items-center justify-between text-sm py-1 ${player.playerId === currentPlayerId ? 'font-bold text-green-600' : ''}">
                                        <span>${player.playerId === currentPlayerId ? '👉 ' : ''}${player.playerName}</span>
                                        <span class="text-xs text-gray-600">HCP ${Math.round(player.handicap)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${team2 ? `
                            <div class="bg-purple-50 rounded p-2">
                                <div class="text-xs font-bold text-purple-900 mb-1">Team B</div>
                                ${team2.map(player => `
                                    <div class="flex items-center justify-between text-sm py-1 ${player.playerId === currentPlayerId ? 'font-bold text-green-600' : ''}">
                                        <span>${player.playerId === currentPlayerId ? '👉 ' : ''}${player.playerName}</span>
                                        <span class="text-xs text-gray-600">HCP ${Math.round(player.handicap)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            } else if (myGroup) {
                // Regular group display
                content.innerHTML = `
                    <div class="bg-white rounded-lg p-3 border border-green-300">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-bold text-green-700">Group ${groupIndex + 1}</span>
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">${myGroup.length} Players</span>
                        </div>
                        <div class="space-y-1">
                            ${myGroup.map(player => `
                                <div class="flex items-center justify-between text-sm py-1 ${player.playerId === currentPlayerId ? 'font-bold text-green-600' : ''}">
                                    <span>${player.playerId === currentPlayerId ? '👉 ' : ''}${player.playerName}</span>
                                    <span class="text-xs text-gray-600">HCP ${Math.round(player.handicap)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            section.style.display = 'block';
        } catch (error) {
            console.error('[GolferEventsSystem] Error loading pairing:', error);
            // Silently fail - pairings are optional
            document.getElementById('golferPairingSection').style.display = 'none';
        }
    }

    showRegistrationForm() {
        document.getElementById('registrationForm').style.display = 'block';
        document.getElementById('eventRegisterBtn').style.display = 'none';
        document.getElementById('eventSubmitBtn').style.display = 'inline-flex';

        // Populate partner preferences
        this.populatePartnerPreferences();

        // Initialize cost calculator
        this.updateRegistrationTotal();

        // Scroll to form
        document.getElementById('registrationForm').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    updateRegistrationTotal() {
        if (!this.currentEvent) return;

        const baseFee = (this.currentEvent.baseFee || 0) + (this.currentEvent.cartFee || 0) + (this.currentEvent.caddyFee || 0);
        const transportFee = this.currentEvent.transportFee || 0;
        const competitionFee = this.currentEvent.competitionFee || 0;

        const wantTransport = document.getElementById('regWantTransport')?.checked || false;
        const wantCompetition = document.getElementById('regWantCompetition')?.checked || false;

        // Update base fee
        document.getElementById('regBaseFeeDisplay').textContent = `฿${baseFee.toLocaleString()}`;

        // Show/hide and update transport fee
        const transportRow = document.getElementById('regTransportFeeRow');
        if (transportFee > 0) {
            document.getElementById('regTransportFeeDisplay').textContent = `฿${transportFee.toLocaleString()}`;
            if (wantTransport) {
                transportRow.style.display = 'flex';
                transportRow.classList.remove('text-gray-400');
                transportRow.classList.add('text-gray-700');
            } else {
                transportRow.style.display = 'flex';
                transportRow.classList.remove('text-gray-700');
                transportRow.classList.add('text-gray-400');
            }
        } else {
            transportRow.style.display = 'none';
        }

        // Show/hide and update competition fee
        const competitionRow = document.getElementById('regCompetitionFeeRow');
        if (competitionFee > 0) {
            document.getElementById('regCompetitionFeeDisplay').textContent = `฿${competitionFee.toLocaleString()}`;
            if (wantCompetition) {
                competitionRow.style.display = 'flex';
                competitionRow.classList.remove('text-gray-400');
                competitionRow.classList.add('text-gray-700');
            } else {
                competitionRow.style.display = 'flex';
                competitionRow.classList.remove('text-gray-700');
                competitionRow.classList.add('text-gray-400');
            }
        } else {
            competitionRow.style.display = 'none';
        }

        // Calculate and display total
        let total = baseFee;
        if (wantTransport) total += transportFee;
        if (wantCompetition) total += competitionFee;

        document.getElementById('regTotalCost').textContent = `฿${total.toLocaleString()}`;
    }

    populatePartnerPreferences() {
        const container = document.getElementById('partnerPrefsContainer');
        const registrations = this.currentEventRegistrations || [];

        if (registrations.length === 0) {
            container.innerHTML = '<p class="text-xs text-gray-500">No other players registered yet. Register first and others can select you as a partner!</p>';
            return;
        }

        container.innerHTML = registrations.map(reg => `
            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                <input type="checkbox"
                       class="partner-pref-checkbox mr-3 rounded"
                       value="${reg.id}"
                       data-name="${reg.playerName}">
                <div class="flex-1">
                    <span class="text-sm font-medium text-gray-700">${reg.playerName}</span>
                    ${reg.handicap !== null && reg.handicap !== undefined ? `<span class="text-xs text-gray-500 ml-2">(HCP: ${Math.round(reg.handicap)})</span>` : ''}
                </div>
            </label>
        `).join('');
    }

    async submitRegistration() {
        const playerName = document.getElementById('regPlayerName').value.trim();
        const handicap = parseFloat(document.getElementById('regHandicap').value);
        const wantTransport = document.getElementById('regWantTransport').checked;
        const wantCompetition = document.getElementById('regWantCompetition').checked;

        // Collect partner preferences
        const partnerPrefs = [];
        document.querySelectorAll('.partner-pref-checkbox:checked').forEach(checkbox => {
            partnerPrefs.push({
                playerId: checkbox.value,
                playerName: checkbox.getAttribute('data-name')
            });
        });

        // Validation
        if (!playerName) {
            NotificationManager.show('Please enter your name', 'error');
            return;
        }
        if (isNaN(handicap) || handicap < 0 || handicap > 54) {
            NotificationManager.show('Please enter a valid handicap (0-54)', 'error');
            return;
        }

        try {
            // Check if we're in edit mode
            if (this.editingRegistrationId) {
                // UPDATE existing registration
                const { error: updateError } = await window.SupabaseDB.client
                    .from('event_registrations')
                    .update({
                        player_name: playerName,
                        handicap: handicap,
                        want_transport: wantTransport,
                        want_competition: wantCompetition,
                        partner_prefs: partnerPrefs
                    })
                    .eq('id', this.editingRegistrationId);

                if (updateError) throw updateError;

                NotificationManager.show(`Registration updated successfully! Changes saved for ${this.currentEvent.name}`, 'success', 3000);

                // Clear edit mode
                this.editingRegistrationId = null;

                // Reload data (invalidate cache since data changed)
                this.closeEventDetail();
                await this.loadMyRegistrations();

                // Clear cache and reload
                this.eventsCache = null;
                this.cacheTimestamp = null;
                await this.loadEvents();
                this.filterEvents();

            } else {
                // CREATE new registration
                const registration = {
                    eventId: this.currentEvent.id,
                    playerName: playerName,
                    playerId: AppState.currentUser?.lineUserId || null,
                    handicap: handicap,
                    wantTransport: wantTransport,
                    wantCompetition: wantCompetition,
                    partnerPrefs: partnerPrefs
                };

                await window.SocietyGolfDB.registerForEvent(registration);

                let confirmMsg = `Successfully registered for ${this.currentEvent.name}! You will receive confirmation from the event organizer.`;
                if (partnerPrefs.length > 0) {
                    confirmMsg += ` Partner preferences: ${partnerPrefs.map(p => p.playerName).join(',')}`;
                }

                NotificationManager.show(confirmMsg, 'success', 4000);

                // Offer to book tee time and caddy
                setTimeout(() => {
                    this.showBookingOffer(this.currentEvent);
                }, 500);

                this.closeEventDetail();
                await this.refreshEvents();
            }

        } catch (error) {
            console.error('[GolferEventsSystem] Registration error:', error);
            NotificationManager.show(`${this.editingRegistrationId ? 'Update' : 'Registration'} failed: ${error.message}`, 'error', 4000);
        }
    }

    closeEventDetail() {
        document.getElementById('eventDetailModal').style.display = 'none';
        this.currentEvent = null;
        this.editingRegistrationId = null; // Clear edit mode

        // Reset button text back to normal
        document.getElementById('eventSubmitBtn').innerHTML = `
            <span class="material-symbols-outlined text-sm">send</span>
            Submit Registration
        `;
    }

    showBookingOffer(event) {
        if (!event || !event.courseName || !event.date) return;

        const bookingConfirm = confirm(
            `🏌️ Book Your Tee Time & Caddy?\n\n` +
            `Event: ${event.name}\n` +
            `Course: ${event.courseName}\n` +
            `Date: ${this.formatDate(event.date)}\n` +
            `${event.startTime ? 'Time: ' + event.startTime + '\n' : ''}\n` +
            `Would you like to book your tee time now?\n\n` +
            `You can also request a caddy during booking.`
        );

        if (bookingConfirm) {
            // Store event context for booking
            localStorage.setItem('pendingEventBooking', JSON.stringify({
                eventId: event.id,
                eventName: event.name,
                courseId: event.courseId,
                courseName: event.courseName,
                date: event.date,
                time: event.startTime || '08:00'
            }));

            // Switch to booking tab
            showGolferTab('booking');
            NotificationManager.show('Opening booking form with event details...', 'info', 2000);
        }
    }

    quickBookFromEvent(eventId) {
        const event = this.allEvents.find(e => e.id === eventId);
        if (!event) {
            NotificationManager.show('Event not found', 'error', 2000);
            return;
        }

        // Store event context for booking
        localStorage.setItem('pendingEventBooking', JSON.stringify({
            eventId: event.id,
            eventName: event.name,
            courseId: event.courseId,
            courseName: event.courseName,
            date: event.date,
            time: event.startTime || '08:00'
        }));

        // Switch to booking tab
        showGolferTab('booking');
        NotificationManager.show(`Booking tee time for ${event.name}...`, 'info', 2000);
    }

    async editRegistration(registrationId, eventId) {
        try {
            // Load registration details
            const { data: regData, error: regError } = await window.SupabaseDB.client
                .from('event_registrations')
                .select('*')
                .eq('id', registrationId)
                .single();

            if (regError) throw regError;

            console.log('[GolferEventsSystem] Editing registration:', regData);

            // Store registration ID for edit mode
            this.editingRegistrationId = registrationId;

            // Open the event detail modal with the event
            await this.openEventDetail(eventId);

            // Pre-fill the form with existing registration data
            document.getElementById('regPlayerName').value = regData.player_name || '';
            document.getElementById('regHandicap').value = regData.handicap || '';
            document.getElementById('regWantTransport').checked = regData.want_transport || false;
            document.getElementById('regWantCompetition').checked = regData.want_competition || false;

            // Show the registration form immediately (in edit mode)
            document.getElementById('registrationForm').style.display = 'block';
            document.getElementById('eventRegisterBtn').style.display = 'none';
            document.getElementById('eventSubmitBtn').style.display = 'inline-flex';

            // Change button text to "Update Registration"
            document.getElementById('eventSubmitBtn').innerHTML = `
                <span class="material-symbols-outlined text-sm">check_circle</span>
                Update Registration
            `;

            // Update the cost calculator to reflect current selections
            this.updateRegistrationTotal();

        } catch (error) {
            console.error('[GolferEventsSystem] Error editing registration:', error);
            NotificationManager.show(`Failed to load registration: ${error.message}`, 'error', 3000);
        }
    }

    async deleteRegistration(registrationId, eventName) {
        const confirmed = confirm(`⚠️ Unregister from "${eventName}"?\n\nThis action cannot be undone.\n\nClick OK to unregister.`);

        if (!confirmed) return;

        try {
            const { error } = await window.SupabaseDB.client
                .from('event_registrations')
                .delete()
                .eq('id', registrationId);

            if (error) throw error;

            NotificationManager.show(`Successfully unregistered from "${eventName}"`, 'success', 3000);

            // Reload registrations and events to update counts (invalidate cache)
            await this.loadMyRegistrations();

            // Clear cache and reload
            this.eventsCache = null;
            this.cacheTimestamp = null;
            await this.loadEvents();
            this.filterEvents();

        } catch (error) {
            console.error('[GolferEventsSystem] Error deleting registration:', error);
            NotificationManager.show(`Failed to unregister: ${error.message}`, 'error', 3000);
        }
    }

    // ======================
    // CALENDAR VIEW
    // ======================

    calendarPrevMonth() {
        this.calendarDate.setMonth(this.calendarDate.getMonth() - 1);
        this.renderCalendar();
    }

    calendarNextMonth() {
        this.calendarDate.setMonth(this.calendarDate.getMonth() + 1);
        this.renderCalendar();
    }

    renderCalendar() {
        const year = this.calendarDate.getFullYear();
        const month = this.calendarDate.getMonth();

        // Update month/year header
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
        document.getElementById('golferCalendarMonthYear').textContent = `${monthNames[month]} ${year}`;

        // Get calendar data
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay()); // Start on Sunday

        const grid = document.getElementById('golferCalendarGrid');
        const cells = [];

        // Generate 42 cells (6 weeks)
        for (let i = 0; i < 42; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);

            const isCurrentMonth = date.getMonth() === month;
            const isToday = date.toDateString() === new Date().toDateString();

            // FIXED: Create date string using local date values (no timezone conversion)
            // This prevents date shifting when toISOString() converts to UTC
            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

            // Find events on this date (filtered by subscribed societies)
            const eventsOnDate = this.allEvents.filter(e => {
                if (e.date !== dateStr) return false;
                // Only show events from subscribed societies
                const eventSocietyName = e.societyName || e.organizerName;
                if (this.subscribedSocieties.length > 0 && !this.subscribedSocieties.includes(eventSocietyName)) {
                    return false;
                }
                return true;
            });

            cells.push(`
                <div class="calendar-cell min-h-20 border border-gray-200 p-2 rounded-lg cursor-pointer hover:bg-gray-50 ${isCurrentMonth ? 'bg-white' : 'bg-gray-50'} ${isToday ? 'ring-2 ring-green-500' : ''}"
                     onclick="GolferEventsSystem.showCalendarDate('${dateStr}')">
                    <div class="text-sm font-medium ${isCurrentMonth ? 'text-gray-900' : 'text-gray-400'} mb-1">
                        ${date.getDate()}
                    </div>
                    ${eventsOnDate.length > 0 ? `
                        <div class="space-y-1">
                            ${eventsOnDate.slice(0, 2).map(event => {
                                const registered = event.registeredCount || 0;
                                const max = event.maxPlayers || 0;
                                const isFull = max > 0 && registered >= max;
                                const color = isFull ? 'bg-red-500' : 'bg-green-500';
                                return `<div class="${color} text-white text-xs px-2 py-1 rounded truncate" title="${event.name} - ${event.societyName}">${event.societyName || event.name}</div>`;
                            }).join('')}
                            ${eventsOnDate.length > 2 ? `<div class="text-xs text-gray-600">+${eventsOnDate.length - 2} more</div>` : ''}
                        </div>
                    ` : ''}
                </div>
            `);
        }

        grid.innerHTML = cells.join('');
    }

    showCalendarDate(dateStr) {
        // Filter events by date AND subscribed societies
        const eventsOnDate = this.allEvents.filter(e => {
            if (e.date !== dateStr) return false;
            // Only show events from subscribed societies
            const eventSocietyName = e.societyName || e.organizerName;
            if (this.subscribedSocieties.length > 0 && !this.subscribedSocieties.includes(eventSocietyName)) {
                return false;
            }
            return true;
        });
        const sidebar = document.getElementById('golferCalendarSidebar');

        if (eventsOnDate.length === 0) {
            // FIXED: Parse date string as local date (add time to prevent UTC conversion)
            const localDate = new Date(dateStr + 'T00:00:00');
            sidebar.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <span class="material-symbols-outlined text-5xl mb-3">event_busy</span>
                    <h3 class="font-bold text-gray-700 mb-2">${localDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}</h3>
                    <p class="text-sm">No events on this date</p>
                </div>
            `;
            return;
        }

        // FIXED: Parse date string as local date (add time to prevent UTC conversion)
        const localDate = new Date(dateStr + 'T00:00:00');
        sidebar.innerHTML = `
            <div>
                <h3 class="font-bold text-gray-900 mb-4 flex items-center">
                    <span class="material-symbols-outlined text-sm mr-2">event</span>
                    ${localDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                </h3>
                <div class="space-y-3">
                    ${eventsOnDate.map(event => {
                        const registered = event.registeredCount || 0;
                        const max = event.maxPlayers || 0;
                        const isFull = max > 0 && registered >= max;
                        return `
                            <div class="border border-gray-200 rounded-lg p-3 hover:shadow-md transition-shadow cursor-pointer" onclick="GolferEventsSystem.openEventDetail('${event.id}')">
                                <div class="flex items-center mb-2">
                                    ${event.societyLogo ? `<img src="${event.societyLogo}" class="w-6 h-6 rounded-full mr-2 object-cover">` : ''}
                                    <div class="flex-1">
                                        <div class="font-bold text-sm text-gray-900 truncate">${event.name}</div>
                                        <div class="text-xs text-gray-600">${event.societyName || event.organizerName}</div>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-600 space-y-1">
                                    ${event.startTime ? `<div>⏰ ${event.startTime}</div>` : ''}
                                    <div>📍 ${event.courseName || 'TBD'}</div>
                                    ${max > 0 ? `<div class="${isFull ? 'text-red-600' : 'text-green-600'}">${registered}/${max} registered</div>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }

    // ======================
    // MY REGISTRATIONS
    // ======================

    async loadMyRegistrations() {
        const container = document.getElementById('myRegistrationsList');
        const playerId = AppState.currentUser?.lineUserId;

        if (!playerId) {
            container.innerHTML = `
                <div class="text-center py-12">
                    <span class="material-symbols-outlined text-5xl mb-3 text-gray-300">person_off</span>
                    <p class="text-gray-600">Please log in to view your registrations</p>
                </div>
            `;
            return;
        }

        try {
            container.innerHTML = '<p class="text-center py-12 text-gray-500">Loading your registrations...</p>';

            // Query all registrations for this player
            const { data: regData, error: regError } = await window.SupabaseDB.client
                .from('event_registrations')
                .select('*')
                .eq('player_id', playerId)
                .order('created_at', { ascending: false });

            if (regError) throw regError;

            if (!regData || regData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <span class="material-symbols-outlined text-5xl mb-3 text-gray-300">confirmation_number</span>
                        <h3 class="text-lg font-bold text-gray-900 mb-2">No Registrations Yet</h3>
                        <p class="text-gray-600 mb-4">You haven't registered for any events</p>
                        <button onclick="GolferEventsSystem.showEventsView('browse')" class="btn-primary">
                            Browse Events
                        </button>
                    </div>
                `;
                return;
            }

            // Get unique event IDs
            const eventIds = [...new Set(regData.map(r => r.event_id))];

            // Get events data
            const { data: eventsData, error: eventsError } = await window.SupabaseDB.client
                .from('society_events')
                .select('*')
                .in('id', eventIds);

            if (eventsError) throw eventsError;

            // Get society profiles for organizers
            const organizerIds = [...new Set(eventsData.map(e => e.organizer_id).filter(id => id))];
            const { data: societyProfiles } = await window.SupabaseDB.client
                .from('society_profiles')
                .select('organizer_id, society_name, society_logo')
                .in('organizer_id', organizerIds);

            // Create maps
            const eventsMap = {};
            eventsData.forEach(e => {
                eventsMap[e.id] = e;
            });

            const societyMap = {};
            if (societyProfiles) {
                societyProfiles.forEach(s => {
                    societyMap[s.organizer_id] = s;
                });
            }

            // Combine data
            const data = regData.map(reg => {
                const event = eventsMap[reg.event_id];
                if (!event) return null;

                const society = societyMap[event.organizer_id];
                return {
                    ...reg,
                    society_events: {
                        ...event,
                        society_profiles: society || null
                    }
                };
            }).filter(r => r !== null);


            // Filter to ONLY upcoming events (past events go to History tab)
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            const upcoming = data.filter(r => new Date(r.society_events.date) >= now);

            if (upcoming.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <span class="material-symbols-outlined text-5xl mb-3 text-gray-300">confirmation_number</span>
                        <h3 class="text-lg font-bold text-gray-900 mb-2">No Upcoming Registrations</h3>
                        <p class="text-gray-600 mb-4">You haven't registered for any upcoming events</p>
                        <button onclick="GolferEventsSystem.showEventsView('browse')" class="btn-primary">
                            Browse Events
                        </button>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="space-y-3">
                    ${upcoming.map(reg => this.renderMyRegistrationCard(reg)).join('')}
                </div>
            `;

            container.innerHTML = html;
        } catch (error) {
            console.error('[GolferEventsSystem] Error loading registrations:', error);
            container.innerHTML = `
                <div class="text-center py-12 text-red-500">
                    <span class="material-symbols-outlined text-5xl mb-3">error</span>
                    <p>Failed to load registrations</p>
                </div>
            `;
        }
    }

    async loadMyHistory() {
        const container = document.getElementById('myHistoryList');
        const playerId = AppState.currentUser?.lineUserId;

        if (!playerId) {
            container.innerHTML = `
                <div class="text-center py-12">
                    <span class="material-symbols-outlined text-5xl mb-3 text-gray-300">person_off</span>
                    <p class="text-gray-600">Please log in to view your history</p>
                </div>
            `;
            return;
        }

        try {
            container.innerHTML = '<p class="text-center py-12 text-gray-500">Loading your history...</p>';

            // Query all registrations for this player
            const { data: regData, error: regError } = await window.SupabaseDB.client
                .from('event_registrations')
                .select('*')
                .eq('player_id', playerId)
                .order('created_at', { ascending: false });

            if (regError) throw regError;

            if (!regData || regData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <span class="material-symbols-outlined text-5xl mb-3 text-gray-300">history</span>
                        <h3 class="text-lg font-bold text-gray-900 mb-2">No History Yet</h3>
                        <p class="text-gray-600">You haven't played any events yet</p>
                    </div>
                `;
                return;
            }

            // Get unique event IDs
            const eventIds = [...new Set(regData.map(r => r.event_id))];

            // Get events data
            const { data: eventsData, error: eventsError } = await window.SupabaseDB.client
                .from('society_events')
                .select('*')
                .in('id', eventIds);

            if (eventsError) throw eventsError;

            // Get society profiles for organizers
            const organizerIds = [...new Set(eventsData.map(e => e.organizer_id).filter(id => id))];
            const { data: societyProfiles } = await window.SupabaseDB.client
                .from('society_profiles')
                .select('organizer_id, society_name, society_logo')
                .in('organizer_id', organizerIds);

            // Create maps
            const eventsMap = {};
            eventsData.forEach(e => {
                eventsMap[e.id] = e;
            });

            const societyMap = {};
            if (societyProfiles) {
                societyProfiles.forEach(s => {
                    societyMap[s.organizer_id] = s;
                });
            }

            // Combine data
            const data = regData.map(reg => {
                const event = eventsMap[reg.event_id];
                if (!event) return null;

                const society = societyMap[event.organizer_id];
                return {
                    ...reg,
                    society_events: {
                        ...event,
                        society_profiles: society || null
                    }
                };
            }).filter(r => r !== null);

            // Filter to ONLY past events
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            const past = data.filter(r => new Date(r.society_events.date) < now);

            if (past.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <span class="material-symbols-outlined text-5xl mb-3 text-gray-300">history</span>
                        <h3 class="text-lg font-bold text-gray-900 mb-2">No Past Events</h3>
                        <p class="text-gray-600">You haven't played any events yet</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="space-y-3">
                    ${past.map(reg => this.renderMyRegistrationCard(reg, true)).join('')}
                </div>
            `;

            container.innerHTML = html;
        } catch (error) {
            console.error('[GolferEventsSystem] Error loading history:', error);
            container.innerHTML = `
                <div class="text-center py-12 text-red-500">
                    <span class="material-symbols-outlined text-5xl mb-3">error</span>
                    <p>Failed to load history</p>
                </div>
            `;
        }
    }

    renderMyRegistrationCard(reg, isPast = false) {
        const event = reg.society_events;
        if (!event) return '';

        const date = new Date(event.date);
        const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });

        // Get society name from profile or fallback to organizer_name
        const societyName = event.society_profiles?.society_name || event.organizer_name || 'Society Golf';
        const societyLogo = event.society_profiles?.society_logo || '';

        // Check if before cutoff time for editing
        const now = new Date();
        const cutoffDate = event.cutoff ? new Date(event.cutoff) : null;
        const canEdit = !isPast && (!cutoffDate || now < cutoffDate);

        return `
            <div class="bg-white border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow ${isPast ? 'opacity-75' : ''}">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center flex-1">
                        ${societyLogo ? `<img src="${societyLogo}" class="w-10 h-10 rounded-full mr-3 object-cover border-2 border-gray-200">` : ''}
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-900">${event.name}</h4>
                            <p class="text-sm text-gray-600">${societyName}</p>
                        </div>
                    </div>
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${isPast ? 'bg-gray-100 text-gray-600' : 'bg-green-100 text-green-600'}">
                        ${isPast ? 'Completed' : 'Registered'}
                    </span>
                </div>

                <div class="space-y-2 text-sm mb-4">
                    <div class="flex items-center text-gray-700">
                        <span class="material-symbols-outlined text-sm mr-2">event</span>
                        <div>
                            <div>${dateStr}</div>
                            ${event.start_time ? `<div class="text-xs text-gray-500 mt-0.5">⏰ Departure: ${event.start_time}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center text-gray-700">
                        <span class="material-symbols-outlined text-sm mr-2">golf_course</span>
                        ${event.course_name || 'TBD'}
                    </div>
                    <div class="flex items-center text-gray-700">
                        <span class="material-symbols-outlined text-sm mr-2">person</span>
                        HCP: ${Math.round(reg.handicap)}
                        ${reg.want_transport ? ' • 🚐 Transport' : ''}
                        ${reg.want_competition ? ' • 🏆 Competition' : ''}
                    </div>
                    ${reg.partner_prefs && reg.partner_prefs.length > 0 ? `
                        <div class="flex items-center text-gray-700">
                            <span class="material-symbols-outlined text-sm mr-2">groups</span>
                            Partner prefs: ${reg.partner_prefs.map(p => p.playerName).join(', ')}
                        </div>
                    ` : ''}
                </div>

                <div class="grid grid-cols-3 gap-2">
                    <button onclick="GolferEventsSystem.openEventDetail('${event.id}')" class="btn-secondary text-xs py-2">
                        <span class="material-symbols-outlined text-sm">info</span>
                        Details
                    </button>
                    ${canEdit ? `
                        <button onclick="GolferEventsSystem.editRegistration('${reg.id}', '${event.id}')" class="btn-secondary text-xs py-2">
                            <span class="material-symbols-outlined text-sm">edit</span>
                            Edit
                        </button>
                        <button onclick="GolferEventsSystem.deleteRegistration('${reg.id}', '${event.name}')" class="bg-red-500 hover:bg-red-600 text-white text-xs py-2 px-3 rounded-lg transition-colors flex items-center justify-center gap-1">
                            <span class="material-symbols-outlined text-sm">delete</span>
                            Unregister
                        </button>
                    ` : `
                        <div class="col-span-2 flex items-center justify-center text-xs text-gray-500">
                            ${cutoffDate && now >= cutoffDate ? 'Registration closed' : ''}
                        </div>
                    `}
                </div>
            </div>
        `;
    }

    // ======================
    // SHARE EVENT FUNCTIONS
    // ======================

    toggleFavorite(eventId) {
        // Get favorites from localStorage
        let favorites = JSON.parse(localStorage.getItem('mcipro_favorite_events') || '[]');

        const index = favorites.indexOf(eventId);
        if (index > -1) {
            // Remove from favorites
            favorites.splice(index, 1);
            NotificationManager.show('Removed from favorites', 'success', 2000);
        } else {
            // Add to favorites
            favorites.push(eventId);
            NotificationManager.show('Added to favorites ⭐', 'success', 2000);
        }

        // Save to localStorage
        localStorage.setItem('mcipro_favorite_events', JSON.stringify(favorites));

        // Update the isFavorited property on events
        this.allEvents.forEach(event => {
            event.isFavorited = favorites.includes(event.id);
        });

        // Re-render to update star icons
        this.filterEvents();
    }

    // ======================
    // SOCIETY SUBSCRIPTIONS
    // ======================

    // DEPRECATED - Old localStorage method
    loadSubscribedSocieties() {
        const stored = localStorage.getItem('mcipro_subscribed_societies');
        return stored ? JSON.parse(stored) : [];
    }

    // NEW: Load subscriptions from database
    async loadSubscriptionsFromDatabase() {
        try {
            const golferId = AppState.currentUser?.lineUserId;
            if (!golferId) {
                console.warn('[GolferEventsSystem] No user logged in, skipping subscription load');
                return;
            }

            console.log('[GolferEventsSystem] Loading subscriptions from database for:', golferId);

            // First, check if there are localStorage subscriptions to migrate
            const localSubscriptions = this.loadSubscribedSocieties();
            if (localSubscriptions.length > 0) {
                console.log('[GolferEventsSystem] Migrating', localSubscriptions.length, 'subscriptions from localStorage to database');
                await this.migrateSubscriptionsToDatabase(golferId, localSubscriptions);
            }

            // Load from database
            const subscriptions = await SocietyGolfDB.getSocietySubscriptions(golferId);
            this.subscribedSocieties = subscriptions.map(s => s.society_name);

            console.log('[GolferEventsSystem] ✅ Loaded', this.subscribedSocieties.length, 'subscriptions from database');

            // Update display and ensure checkboxes reflect current state
            this.updateSelectedSocietiesDisplay();

            // Re-render checkboxes if selector panel is open
            const panel = document.getElementById('societySelectorPanel');
            if (panel && panel.style.display !== 'none') {
                this.renderSocietyCheckboxes();
            }
        } catch (error) {
            console.error('[GolferEventsSystem] Error loading subscriptions from database:', error);
            // Don't fallback to localStorage - it's been migrated and cleared
            this.subscribedSocieties = [];
        }
    }

    async migrateSubscriptionsToDatabase(golferId, societyNames) {
        try {
            for (const societyName of societyNames) {
                await SocietyGolfDB.saveSocietySubscription(golferId, societyName);
            }
            console.log('[GolferEventsSystem] ✅ Migration complete - clearing localStorage');
            localStorage.removeItem('mcipro_subscribed_societies');
        } catch (error) {
            console.error('[GolferEventsSystem] Error migrating subscriptions:', error);
        }
    }

    async saveSubscriptionToDatabase(societyName, isSubscribing) {
        try {
            const golferId = AppState.currentUser?.lineUserId;
            if (!golferId) {
                console.warn('[GolferEventsSystem] No user logged in, cannot save subscription');
                return;
            }

            if (isSubscribing) {
                await SocietyGolfDB.saveSocietySubscription(golferId, societyName);
                console.log('[GolferEventsSystem] ✅ Subscribed to:', societyName);
            } else {
                await SocietyGolfDB.removeSocietySubscription(golferId, societyName);
                console.log('[GolferEventsSystem] ❌ Unsubscribed from:', societyName);
            }
        } catch (error) {
            console.error('[GolferEventsSystem] Error saving subscription:', error);
            NotificationManager.show('Failed to update subscription', 'error');
        }
    }

    extractUniqueSocieties() {
        const societiesSet = new Set();
        this.allEvents.forEach(event => {
            // Use societyName if available, fallback to organizerName
            const societyName = event.societyName || event.organizerName;
            if (societyName) {
                societiesSet.add(societyName);
            }
        });
        this.allSocieties = Array.from(societiesSet).sort();
        console.log('[GolferEventsSystem] Found societies:', this.allSocieties);
    }

    renderSocietyCheckboxes() {
        const container = document.getElementById('societyCheckboxList');
        if (!container) return;

        this.extractUniqueSocieties();

        container.innerHTML = this.allSocieties.map(society => {
            const isChecked = this.subscribedSocieties.includes(society);
            return `
                <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded-lg cursor-pointer">
                    <input
                        type="checkbox"
                        value="${society}"
                        ${isChecked ? 'checked' : ''}
                        onchange="GolferEventsSystem.toggleSocietySubscription('${society}')"
                        class="w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500"
                    >
                    <span class="text-sm text-gray-700">${society}</span>
                </label>
            `;
        }).join('');

        this.updateSelectedSocietiesDisplay();
    }

    async toggleSocietySubscription(society) {
        const index = this.subscribedSocieties.indexOf(society);
        const isSubscribing = index === -1;

        if (index > -1) {
            this.subscribedSocieties.splice(index, 1);
        } else {
            this.subscribedSocieties.push(society);
        }

        // Save to database
        await this.saveSubscriptionToDatabase(society, isSubscribing);

        // Update UI
        this.updateSelectedSocietiesDisplay();

        // Re-render checkboxes to reflect the change
        const panel = document.getElementById('societySelectorPanel');
        if (panel && panel.style.display !== 'none') {
            this.renderSocietyCheckboxes();
        }

        this.filterEvents();
    }

    updateSelectedSocietiesDisplay() {
        const display = document.getElementById('selectedSocietiesDisplay');
        if (!display) return;

        if (this.subscribedSocieties.length === 0) {
            display.innerHTML = '<span class="text-sm text-gray-500">Select societies to see their events...</span>';
        } else {
            display.innerHTML = this.subscribedSocieties.map(society => `
                <span class="inline-flex items-center gap-1 px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">
                    ${society}
                    <button onclick="event.stopPropagation(); GolferEventsSystem.toggleSocietySubscription('${society}')" class="hover:text-green-900">
                        <span class="material-symbols-outlined text-xs">close</span>
                    </button>
                </span>
            `).join('');
        }
    }

    async toggleSocietySelector() {
        const panel = document.getElementById('societySelectorPanel');
        if (!panel) return;

        if (panel.style.display === 'none') {
            // Reload subscriptions from database to ensure fresh state
            await this.loadSubscriptionsFromDatabase();
            this.renderSocietyCheckboxes();
            panel.style.display = 'block';
        } else {
            panel.style.display = 'none';
        }
    }

    async selectAllSocieties() {
        const golferId = AppState.currentUser?.lineUserId;
        if (!golferId) return;

        this.subscribedSocieties = [...this.allSocieties];

        // Save all to database
        try {
            for (const society of this.allSocieties) {
                await SocietyGolfDB.saveSocietySubscription(golferId, society);
            }
            console.log('[GolferEventsSystem] ✅ Subscribed to all societies');
        } catch (error) {
            console.error('[GolferEventsSystem] Error subscribing to all societies:', error);
        }

        this.renderSocietyCheckboxes();
        this.filterEvents();
    }

    async clearAllSocieties() {
        const golferId = AppState.currentUser?.lineUserId;
        if (!golferId) return;

        this.subscribedSocieties = [];

        // Clear from database
        try {
            await SocietyGolfDB.clearAllSubscriptions(golferId);
            console.log('[GolferEventsSystem] ✅ Cleared all subscriptions');
        } catch (error) {
            console.error('[GolferEventsSystem] Error clearing subscriptions:', error);
        }

        this.renderSocietyCheckboxes();
        this.filterEvents();
    }

    async openShareModal(eventId) {
        this.shareEvent = this.allEvents.find(e => e.id === eventId);
        if (!this.shareEvent) {
            NotificationManager.show('Event not found', 'error');
            return;
        }

        this.selectedShareUsers = [];

        // Populate event summary
        const summary = document.getElementById('shareEventSummary');
        const eventDate = new Date(this.shareEvent.date);
        const dateStr = eventDate.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });

        summary.innerHTML = `
            <div class="flex items-start gap-3">
                ${this.shareEvent.societyLogo ? `<img src="${this.shareEvent.societyLogo}" class="w-12 h-12 rounded-full border-2 border-green-300">` : ''}
                <div class="flex-1">
                    <h3 class="font-bold text-lg text-gray-900">${this.shareEvent.name}</h3>
                    <div class="text-sm text-gray-600 space-y-1 mt-2">
                        <div>📅 ${dateStr} ${this.shareEvent.startTime ? `at ${this.shareEvent.startTime}` : ''}</div>
                        <div>⛳ ${this.shareEvent.courseName || 'TBD'}</div>
                        <div>🏢 ${this.shareEvent.societyName || this.shareEvent.organizerName}</div>
                    </div>
                </div>
            </div>
        `;

        // Load platform users
        await this.loadPlatformUsers();

        // Show modal
        document.getElementById('shareEventModal').style.display = 'flex';
    }

    async loadPlatformUsers() {
        try {
            // Get all user profiles from localStorage
            const allProfiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');

            // Filter out current user
            const currentUserId = AppState.currentUser?.lineUserId || AppState.currentUser?.userId;
            this.allShareUsers = allProfiles.filter(p => {
                const userId = p.lineUserId || p.userId;
                return userId && userId !== currentUserId;
            });

            console.log('[ShareEvent] Loaded users:', this.allShareUsers.length);

            this.filterShareUsers('');
        } catch (error) {
            console.error('[ShareEvent] Error loading users:', error);
            document.getElementById('shareUsersList').innerHTML = `
                <div class="col-span-full text-center py-8 text-red-500">
                    <span class="material-symbols-outlined text-4xl mb-2 block">error</span>
                    <p>Failed to load users</p>
                </div>
            `;
        }
    }

    filterShareUsers(searchTerm) {
        if (!this.allShareUsers) return;

        const term = searchTerm.toLowerCase();
        const filtered = term ? this.allShareUsers.filter(user => {
            const name = (user.name || '').toLowerCase();
            const username = (user.username || '').toLowerCase();
            const role = (user.role || '').toLowerCase();
            const email = (user.email || '').toLowerCase();

            return name.includes(term) || username.includes(term) || role.includes(term) || email.includes(term);
        }) : this.allShareUsers;

        this.renderShareUsersList(filtered);
    }

    renderShareUsersList(users) {
        const container = document.getElementById('shareUsersList');

        if (users.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-8 text-gray-500">
                    <span class="material-symbols-outlined text-4xl mb-2 block">search_off</span>
                    <p>No users found</p>
                </div>
            `;
            return;
        }

        container.innerHTML = users.map(user => {
            const userId = user.lineUserId || user.userId;
            const isSelected = this.selectedShareUsers.some(u => u.userId === userId);

            return `
                <div class="flex items-center gap-3 p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors ${isSelected ? 'ring-2 ring-blue-500 bg-blue-50' : ''}"
                     onclick="GolferEventsSystem.toggleUserSelection('${userId}', '${(user.name || user.username || 'User').replace(/'/g, "\\'")}')">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} class="rounded text-blue-500" onclick="event.stopPropagation();">
                    <div class="flex-1">
                        <div class="font-medium text-gray-900">${user.name || user.username || 'User'}</div>
                        <div class="text-xs text-gray-500">${user.role || 'Member'} ${user.email ? `• ${user.email}` : ''}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    toggleUserSelection(userId, userName) {
        const index = this.selectedShareUsers.findIndex(u => u.userId === userId);

        if (index >= 0) {
            // Remove from selection
            this.selectedShareUsers.splice(index, 1);
        } else {
            // Add to selection
            this.selectedShareUsers.push({ userId, userName });
        }

        // Update UI
        this.updateSelectedUsersDisplay();
        this.filterShareUsers(document.getElementById('shareUserSearch').value);
    }

    updateSelectedUsersDisplay() {
        const container = document.getElementById('selectedUsersContainer');
        const list = document.getElementById('selectedUsersList');
        const countSpan = document.getElementById('selectedUserCount');
        const sendBtn = document.getElementById('sendInvitesBtn');

        countSpan.textContent = this.selectedShareUsers.length;

        if (this.selectedShareUsers.length === 0) {
            container.style.display = 'none';
            sendBtn.disabled = true;
        } else {
            container.style.display = 'block';
            sendBtn.disabled = false;

            list.innerHTML = this.selectedShareUsers.map(user => `
                <div class="inline-flex items-center gap-2 bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">
                    <span>${user.userName}</span>
                    <button onclick="event.stopPropagation(); GolferEventsSystem.toggleUserSelection('${user.userId}', '${user.userName.replace(/'/g, "\\'")}');"
                            class="hover:text-blue-900">
                        <span class="material-symbols-outlined text-sm">close</span>
                    </button>
                </div>
            `).join('');
        }
    }

    async sendEventInvitations() {
        // TODO: Implement event invitations with professional chat system
        NotificationManager.show('Chat invitations will be available soon with the new chat system', 'info', 3000);
        this.closeShareModal();
    }


    closeShareModal() {
        document.getElementById('shareEventModal').style.display = 'none';
        this.shareEvent = null;
        this.selectedShareUsers = [];
        this.allShareUsers = [];
        document.getElementById('shareUserSearch').value = '';
    }
}

// Initialize global instance
window.GolferEventsSystem = new GolferEventsManager();


    // ===== SOCIETY ORGANIZER PIN AUTHENTICATION (Per-Organizer) =====
    const SocietyOrganizerAuth = {
        pendingRole: null,

        isVerified() {
            return sessionStorage.getItem('society_organizer_verified') === 'true';
        },

        async checkIfPinRequired() {
            const userId = AppState.currentUser?.lineUserId;
            if (!userId) return false;

            try {
                const { data, error } = await window.SupabaseDB.client
                    .rpc('organizer_has_pin', { org_id: userId });

                if (error) {
                    console.error('[SocietyAuth] Error checking PIN:', error);
                    return false;
                }

                return data === true;
            } catch (error) {
                console.error('[SocietyAuth] Exception checking PIN:', error);
                return false;
            }
        },

        async showPinModal(targetRole) {
            this.pendingRole = targetRole;
            document.getElementById('societyOrganizerPinModal').style.display = 'flex';
            document.getElementById('societyOrganizerPinInput').value = '';
            document.getElementById('pinErrorMessage').classList.add('hidden');
            setTimeout(() => {
                document.getElementById('societyOrganizerPinInput').focus();
            }, 100);
        },

        hidePinModal() {
            document.getElementById('societyOrganizerPinModal').style.display = 'none';
            document.getElementById('societyOrganizerPinInput').value = '';
            document.getElementById('pinErrorMessage').classList.add('hidden');
        },

        async verifyPin() {
            const inputPin = document.getElementById('societyOrganizerPinInput').value;
            const userId = AppState.currentUser?.lineUserId;

            if (!inputPin || inputPin.trim() === '') {
                this.showError('Please enter a PIN');
                return;
            }

            if (!userId) {
                this.showError('User not authenticated');
                return;
            }

            try {
                const { data, error } = await window.SupabaseDB.client
                    .rpc('verify_society_organizer_pin', {
                        org_id: userId,
                        input_pin: inputPin
                    });

                if (error) {
                    console.error('[SocietyAuth] Error verifying PIN:', error);
                    this.showError('Error verifying PIN. Please try again.');
                    return;
                }

                if (data === true) {
                    sessionStorage.setItem('society_organizer_verified', 'true');
                    this.hidePinModal();
                    if (this.pendingRole) {
                        DevMode.proceedWithRoleSwitch(this.pendingRole);
                    }
                } else {
                    this.showError('Incorrect PIN. Please try again.');
                    document.getElementById('societyOrganizerPinInput').value = '';
                    document.getElementById('societyOrganizerPinInput').focus();
                }
            } catch (error) {
                console.error('[SocietyAuth] Exception verifying PIN:', error);
                this.showError('Error verifying PIN. Please try again.');
            }
        },

        cancelPinEntry() {
            this.pendingRole = null;
            this.hidePinModal();
        },

        showError(message) {
            const errorEl = document.getElementById('pinErrorMessage');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        },

        clearVerification() {
            sessionStorage.removeItem('society_organizer_verified');
        }
    };

    // Override DevMode.switchToRole to check PIN for society_organizer
    if (typeof DevMode !== 'undefined') {
        DevMode.originalSwitchToRole = DevMode.switchToRole;

        DevMode.switchToRole = async function(role) {
            if (role === 'society_organizer') {
                if (SocietyOrganizerAuth.isVerified()) {
                    this.proceedWithRoleSwitch(role);
                } else {
                    // Check if this organizer has a PIN set
                    const hasPinSet = await SocietyOrganizerAuth.checkIfPinRequired();
                    if (hasPinSet) {
                        SocietyOrganizerAuth.showPinModal(role);
                    } else {
                        // No PIN set, allow direct access
                        this.proceedWithRoleSwitch(role);
                    }
                }
            } else {
                this.proceedWithRoleSwitch(role);
            }
        };

        DevMode.proceedWithRoleSwitch = function(role) {
            if (AppState.currentUser) {
                AppState.currentUser.role = role;
                const profiles = JSON.parse(localStorage.getItem('mcipro_user_profiles') || '[]');
                const myProfile = profiles.find(p => p.lineUserId === AppState.currentUser.lineUserId);
                if (myProfile) {
                    myProfile.role = role;
                    localStorage.setItem('mcipro_user_profiles', JSON.stringify(profiles));
                }
            }

            const dashboardMap = {
                'golfer': 'golferDashboard',
                'caddie': 'caddieDashboard',
                'manager': 'managerDashboard',
                'proshop': 'proshopDashboard',
                'admin': 'adminDashboard',
                'society_organizer': 'societyOrganizerDashboard'
            };

            const targetScreen = dashboardMap[role];
            if (targetScreen) {
                showScreen(targetScreen);
                this.showNotification(`Switched to ${role.toUpperCase()} dashboard`, 'success');
            }
            this.hide();
        };
    }

    console.log('[SocietyAuth] PIN Authentication System loaded (Per-Organizer)');


// Tab switching functions
function showOrganizerTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.organizer-tab-content').forEach(tab => {
        tab.style.display = 'none';
    });

    // Remove active class from buttons
    document.querySelectorAll('.organizer-tab-button').forEach(btn => {
        btn.classList.remove('active', 'border-b-2', 'border-sky-600', 'text-sky-600');
        btn.classList.add('text-gray-600');
    });

    // Show selected tab
    document.getElementById(`organizerTab-${tabName}`).style.display = 'block';

    // Add active class to button
    const activeBtn = document.getElementById(`organizer-${tabName}-tab`);
    activeBtn.classList.add('active', 'border-b-2', 'border-sky-600', 'text-sky-600');
    activeBtn.classList.remove('text-gray-600');

    // Scroll to top of content when switching tabs
    const dashboard = document.getElementById('societyOrganizerDashboard');
    if (dashboard) {
        dashboard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}


// Update showOrganizerTab to load data when specific tabs are shown
const originalShowOrganizerTab = showOrganizerTab;
showOrganizerTab = function(tabName) {
    originalShowOrganizerTab(tabName);

    // Load player directory when Players tab is shown
    if (tabName === 'players' && window.SocietyOrganizerSystem) {
        setTimeout(async () => {
            await window.SocietyOrganizerSystem.loadPlayerDirectory();
        }, 100);
    }

    // Load user role and update admin tab UI when Admin tab is shown
    if (tabName === 'admin' && window.SocietyOrganizerSystem) {
        setTimeout(async () => {
            const role = await window.SocietyOrganizerSystem.loadUserRole();
            await window.SocietyOrganizerSystem.updateAdminTabUI(role);
        }, 100);
    }
};


function showRosterTab(tabName) {
    // Hide all views
    document.querySelectorAll('.roster-view').forEach(view => {
        view.style.display = 'none';
    });

    // Remove active class from buttons
    document.querySelectorAll('.roster-tab-button').forEach(btn => {
        btn.classList.remove('active', 'text-sky-600');
        btn.classList.add('text-gray-600');
    });

    // Show selected view
    document.getElementById(`rosterView-${tabName}`).style.display = 'block';

    // Add active class to button
    const activeBtn = document.getElementById(`rosterTab-${tabName}`);
    activeBtn.classList.add('active', 'text-sky-600');
    activeBtn.classList.remove('text-gray-600');
}

// ===== SOCIETY CALENDAR CLASS =====

class SocietyCalendar {
    constructor() {
        this.currentYear = new Date().getFullYear();
        this.currentMonth = new Date().getMonth(); // 0-11
        this.events = [];
        this.selectedDate = null;
    }

    async init() {
        console.log('[Calendar] Initializing Society Calendar...');
        await this.loadEvents();
        this.render();
        this.updateStats();
    }

    async loadEvents() {
        try {
            // FIXED: Load events with stats to match Events tab and show accurate registration counts
            const organizerId = AppState.currentUser?.lineUserId;
            if (!organizerId) {
                console.error('[Calendar] No organizer ID');
                return;
            }

            this.events = await window.SocietyGolfDB.getOrganizerEventsWithStats(organizerId);
            console.log(`[Calendar] Loaded ${this.events.length} events with stats`);
        } catch (error) {
            console.error('[Calendar] Exception loading events:', error);
            NotificationManager.show('Failed to load events', 'error');
        }
    }

    prevMonth() {
        this.currentMonth--;
        if (this.currentMonth < 0) {
            this.currentMonth = 11;
            this.currentYear--;
        }
        this.render();
        this.updateStats();
    }

    nextMonth() {
        this.currentMonth++;
        if (this.currentMonth > 11) {
            this.currentMonth = 0;
            this.currentYear++;
        }
        this.render();
        this.updateStats();
    }

    render() {
        // Update month/year header
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
        document.getElementById('calendarMonthYear').textContent =
            `${monthNames[this.currentMonth]} ${this.currentYear}`;

        // Get first day of month and number of days
        const firstDay = new Date(this.currentYear, this.currentMonth, 1);
        const lastDay = new Date(this.currentYear, this.currentMonth + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay(); // 0 = Sunday

        // Build calendar grid (7x6 = 42 cells)
        const grid = document.getElementById('calendarGrid');
        let html = '';

        // Add empty cells for days before month starts
        for (let i = 0; i < startingDayOfWeek; i++) {
            html += '<div class="aspect-square bg-gray-50 rounded-lg"></div>';
        }

        // Add cells for each day of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${this.currentYear}-${String(this.currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayEvents = this.getEventsForDate(dateStr);
            const isToday = this.isToday(this.currentYear, this.currentMonth, day);

            // Build event dots (max 3 visible)
            let eventDots = '';
            if (dayEvents.length > 0) {
                const visibleEvents = dayEvents.slice(0, 3);
                eventDots = visibleEvents.map(event => {
                    const color = this.getEventColor(event);
                    return `<div class="w-2 h-2 rounded-full ${color}"></div>`;
                }).join('');

                if (dayEvents.length > 3) {
                    eventDots += `<div class="text-xs text-gray-500">+${dayEvents.length - 3}</div>`;
                }
            }

            const todayClass = isToday ? 'ring-2 ring-sky-500 bg-sky-50' : 'hover:bg-gray-50';
            // FIXED: Make ALL dates clickable, not just dates with events
            const hasEventsClass = 'cursor-pointer';
            const onclickAttr = `onclick="window.SocietyCalendar.showDateEvents('${dateStr}')"`;

            html += `
                <div class="aspect-square bg-white border rounded-lg p-2 ${todayClass} ${hasEventsClass} transition" ${onclickAttr}>
                    <div class="text-sm font-medium text-gray-700 mb-1">${day}</div>
                    <div class="flex flex-wrap gap-1">
                        ${eventDots}
                    </div>
                </div>
            `;
        }

        // Fill remaining cells to complete the 6x7 grid
        const totalCells = startingDayOfWeek + daysInMonth;
        const remainingCells = 42 - totalCells;
        for (let i = 0; i < remainingCells; i++) {
            html += '<div class="aspect-square bg-gray-50 rounded-lg"></div>';
        }

        grid.innerHTML = html;
    }

    getStatusBadge(event) {
        const eventDate = new Date(event.date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const daysUntil = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));

        // Past event
        if (daysUntil < 0) {
            return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">Past</span>';
        }

        // Check if closed/full
        // FIXED: Read from event.stats.registered
        const registered = event.stats?.registered || 0;
        const max = event.maxPlayers || 0;
        if (event.status === 'closed' || (max > 0 && registered >= max)) {
            return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">Full</span>';
        }

        // Almost full (90%+)
        if (max > 0 && (registered / max) >= 0.9) {
            return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-700">Almost Full</span>';
        }

        // Closing soon (within 48 hours)
        if (event.cutoff) {
            const cutoff = new Date(event.cutoff);
            const hoursUntil = (cutoff - today) / (1000 * 60 * 60);
            if (hoursUntil > 0 && hoursUntil <= 48) {
                return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-orange-100 text-orange-700">Closing Soon</span>';
            }
        }

        // Upcoming within 7 days
        if (daysUntil <= 7) {
            return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-700">Soon</span>';
        }

        // Open
        return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">Open</span>';
    }

    showEventDetails(eventId) {
        const event = this.events.find(e => e.id === eventId);
        if (!event) return;

        const sidebar = document.getElementById('calendarSidebar');
        const eventDate = new Date(event.date);
        const dateDisplay = eventDate.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // FIXED: Read from event.stats.registered
        const registered = event.stats?.registered || 0;
        const max = event.maxPlayers || 0;
        const percentFull = max > 0 ? Math.round((registered / max) * 100) : 0;

        // Calculate fees
        const baseFee = event.baseFee || 0;
        const cartFee = event.cartFee || 0;
        const caddyFee = event.caddyFee || 0;
        const transportFee = event.transportFee || 0;
        const compFee = event.competitionFee || 0;

        sidebar.innerHTML = `
            <div class="mb-4 pb-4 border-b border-gray-200">
                <h3 class="text-lg font-bold text-gray-800 mb-1">${event.name}</h3>
                <p class="text-sm text-gray-600">${dateDisplay}</p>
                <div class="mt-2">
                    ${this.getStatusBadge(event)}
                </div>
            </div>

            <div class="space-y-3 text-sm">
                <div>
                    <div class="text-xs text-gray-500 uppercase font-medium">Format</div>
                    <div class="text-gray-800">${event.eventFormat || 'Not specified'}</div>
                </div>

                <div>
                    <div class="text-xs text-gray-500 uppercase font-medium">Course</div>
                    <div class="text-gray-800">${event.courseName || 'TBD'}</div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <div class="text-xs text-gray-500 uppercase font-medium">Departure</div>
                        <div class="text-gray-800">${event.startTime || 'TBD'}</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 uppercase font-medium">Players</div>
                        <div class="text-gray-800 font-semibold">${registered}/${max}</div>
                    </div>
                </div>

                ${percentFull > 0 ? `
                <div>
                    <div class="text-xs text-gray-500 uppercase font-medium mb-1">Capacity</div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-sky-600 h-2 rounded-full" style="width: ${percentFull}%"></div>
                    </div>
                    <div class="text-xs text-gray-600 mt-1">${percentFull}% full</div>
                </div>
                ` : ''}

                <div class="pt-3 border-t border-gray-200">
                    <div class="text-xs text-gray-500 uppercase font-medium mb-2">Fees (THB)</div>
                    <div class="space-y-1 text-xs text-gray-700">
                        ${baseFee > 0 ? `<div class="flex justify-between"><span>Green Fee:</span><span>฿${baseFee}</span></div>` : ''}
                        ${cartFee > 0 ? `<div class="flex justify-between"><span>Cart:</span><span>฿${cartFee}</span></div>` : ''}
                        ${caddyFee > 0 ? `<div class="flex justify-between"><span>Caddy:</span><span>฿${caddyFee}</span></div>` : ''}
                        ${transportFee > 0 ? `<div class="flex justify-between"><span>Transport:</span><span>฿${transportFee}</span></div>` : ''}
                        ${compFee > 0 ? `<div class="flex justify-between"><span>Competition:</span><span>฿${compFee}</span></div>` : ''}
                        <div class="flex justify-between font-semibold text-gray-900 pt-1 border-t border-gray-200">
                            <span>Total:</span>
                            <span>฿${(baseFee + cartFee + caddyFee + transportFee + compFee).toLocaleString()}</span>
                        </div>
                    </div>
                </div>

                ${event.notes ? `
                <div class="pt-3 border-t border-gray-200">
                    <div class="text-xs text-gray-500 uppercase font-medium mb-1">Notes</div>
                    <div class="text-xs text-gray-700">${event.notes}</div>
                </div>
                ` : ''}
            </div>

            <div class="mt-6 space-y-2">
                <button onclick="window.SocietyOrganizerSystem.viewRoster('${event.id}')"
                        class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined text-sm">groups</span>
                    View Roster (${registered})
                </button>
                <button onclick="window.SocietyOrganizerSystem.editEvent('${event.id}')"
                        class="w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined text-sm">edit</span>
                    Edit Event
                </button>
            </div>
        `;
    }

        getEventsForDate(dateStr) {
        return this.events.filter(event => event.date === dateStr);
    }

    isToday(year, month, day) {
        const today = new Date();
        return year === today.getFullYear() &&
               month === today.getMonth() &&
               day === today.getDate();
    }

    getEventColor(event) {
        const eventDate = new Date(event.date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const daysUntil = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));

        // Past event
        if (daysUntil < 0) return 'bg-gray-400';

        // Check if closed
        // FIXED: Read from event.stats.registered
        if (event.status === 'closed' ||
            (event.maxPlayers && (event.stats?.registered || 0) >= event.maxPlayers)) {
            return 'bg-red-500';
        }

        // Upcoming within 7 days
        if (daysUntil <= 7) return 'bg-blue-500';

        // Open event
        return 'bg-green-500';
    }

    showDateEvents(dateStr) {
        const events = this.getEventsForDate(dateStr);
        this.showEventsForDate(dateStr, events);
    }

    showEventsForDate(dateStr, events) {
        this.selectedDate = dateStr;
        const sidebar = document.getElementById('calendarSidebar');

        // FIXED: Parse date string as local date (add time to prevent UTC conversion)
        const date = new Date(dateStr + 'T00:00:00');
        const dateDisplay = date.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        let html = `
            <div class="mb-4">
                <h3 class="text-lg font-bold text-gray-800">${dateDisplay}</h3>
                <p class="text-sm text-gray-600">${events.length} event${events.length !== 1 ? 's' : ''}</p>
            </div>
            <div class="space-y-3">
        `;

        events.forEach(event => {
            const statusColor = this.getEventColor(event).replace('bg-', '');
            // FIXED: Read from event.stats.registered (populated by getOrganizerEventsWithStats)
            const registered = event.stats?.registered || 0;
            const max = event.maxPlayers || 0;

            html += `
                <div class="p-3 border border-gray-200 rounded-lg hover:shadow-md transition cursor-pointer"
                     onclick="window.SocietyOrganizerSystem.editEvent('${event.id}')">
                    <div class="flex items-start gap-2 mb-2">
                        <div class="w-3 h-3 rounded-full ${this.getEventColor(event)} mt-1"></div>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800">${event.name}</div>
                            <div class="text-xs text-gray-600">${event.eventFormat || 'Format not set'}</div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600 space-y-1">
                        <div>📍 ${event.courseName || 'Location TBD'}</div>
                        <div>👥 ${registered}/${max} players</div>
                        ${event.startTime ? `<div>🚐 Departs ${event.startTime}</div>` : ''}
                    </div>
                    <div class="mt-2 flex gap-2">
                        <button onclick="event.stopPropagation(); window.SocietyOrganizerSystem.viewRoster('${event.id}')"
                                class="text-xs px-2 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100">
                            View Roster
                        </button>
                        <button onclick="event.stopPropagation(); window.SocietyOrganizerSystem.editEvent('${event.id}')"
                                class="text-xs px-2 py-1 bg-gray-50 text-gray-600 rounded hover:bg-gray-100">
                            Edit
                        </button>
                    </div>
                </div>
            `;
        });

        html += `
            </div>
            <div class="mt-4 pt-4 border-t border-gray-200">
                <button onclick="window.SocietyOrganizerSystem.showCreateEventForm()"
                        class="w-full px-4 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 transition flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">add</span>
                    Add Event for This Date
                </button>
            </div>
        `;

        sidebar.innerHTML = html;
    }

    updateStats() {
        // Events this month
        const eventsThisMonth = this.events.filter(e => {
            const eventDate = new Date(e.date);
            return eventDate.getFullYear() === this.currentYear &&
                   eventDate.getMonth() === this.currentMonth;
        });

        document.getElementById('calendarStatThisMonth').textContent = eventsThisMonth.length;

        // Total players
        // FIXED: Read from event.stats.registered
        const totalPlayers = eventsThisMonth.reduce((sum, e) => sum + (e.stats?.registered || 0), 0);
        document.getElementById('calendarStatPlayers').textContent = totalPlayers;

        // Upcoming in next 7 days
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const sevenDaysLater = new Date(today);
        sevenDaysLater.setDate(today.getDate() + 7);

        const upcoming = this.events.filter(e => {
            const eventDate = new Date(e.date);
            return eventDate >= today && eventDate <= sevenDaysLater;
        });

        document.getElementById('calendarStatUpcoming').textContent = upcoming.length;

        // Events needing attention (near capacity or near cutoff)
        const needAttention = eventsThisMonth.filter(e => {
            // FIXED: Read from event.stats.registered
            const registered = e.stats?.registered || 0;
            const max = e.maxPlayers || 0;
            const percentFull = max > 0 ? (registered / max) * 100 : 0;

            // Near capacity (>80%)
            if (percentFull >= 80 && percentFull < 100) return true;

            // Near cutoff (within 48 hours)
            if (e.cutoff) {
                const cutoff = new Date(e.cutoff);
                const hoursUntil = (cutoff - today) / (1000 * 60 * 60);
                if (hoursUntil > 0 && hoursUntil <= 48) return true;
            }

            return false;
        });

        document.getElementById('calendarStatAttention').textContent = needAttention.length;
    }

    async refresh() {
        await this.loadEvents();
        this.render();
        this.updateStats();
    }
}

// ===== ORGANIZER SCORING SYSTEM CLASS =====

class OrganizerScoringSystem {
    constructor() {
        this.currentEventId = null;
        this.currentFormat = 'stableford';
        this.leaderboardData = [];
        this.pointAllocation = {};
        this.refreshInterval = null;
    }

    async init() {
        console.log('[OrganizerScoring] Initializing scoring system...');
        await this.loadEvents();
        this.updatePointsTable();
    }

    async loadEvents() {
        try {
            const userId = AppState.currentUser?.lineUserId;
            if (!userId) return;

            // Load organizer's events
            const { data: events, error } = await window.SupabaseDB.client
                .from('society_events')
                .select('*')
                .eq('organizer_id', userId)
                .order('date', { ascending: false })
                .limit(50);

            if (error) {
                console.error('[OrganizerScoring] Error loading events:', error);
                return;
            }

            const select = document.getElementById('organizerScoringEventSelect');
            if (!select) return;

            select.innerHTML = '<option value="">-- Select an event --</option>';
            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.id;
                const date = new Date(event.date).toLocaleDateString();
                option.textContent = `${event.title} - ${date} (${event.course})`;
                select.appendChild(option);
            });

            console.log(`[OrganizerScoring] Loaded ${events.length} events`);
        } catch (error) {
            console.error('[OrganizerScoring] Error in loadEvents:', error);
        }
    }

    async loadEventScores(eventId) {
        if (!eventId) {
            document.getElementById('noEventSelected').style.display = 'block';
            document.getElementById('pointAllocationSettings').style.display = 'none';
            document.getElementById('eventLeaderboardContainer').style.display = 'none';
            return;
        }

        this.currentEventId = eventId;
        document.getElementById('noEventSelected').style.display = 'none';
        document.getElementById('pointAllocationSettings').style.display = 'block';
        document.getElementById('eventLeaderboardContainer').style.display = 'block';

        await this.refreshScores();

        // Auto-refresh every 30 seconds
        if (this.refreshInterval) clearInterval(this.refreshInterval);
        this.refreshInterval = setInterval(() => {
            this.refreshScores();
        }, 30000);
    }

    async refreshScores() {
        if (!this.currentEventId) return;

        try {
            // Fetch all rounds for this event
            const { data: rounds, error } = await window.SupabaseDB.client
                .from('rounds')
                .select('*')
                .eq('society_event_id', this.currentEventId)
                .order('total_stableford', { ascending: false });

            if (error) {
                console.error('[OrganizerScoring] Error loading scores:', error);
                return;
            }

            this.leaderboardData = rounds || [];
            this.renderLeaderboard();
            this.updateStats();

            console.log(`[OrganizerScoring] Loaded ${rounds.length} scores`);
        } catch (error) {
            console.error('[OrganizerScoring] Error in refreshScores:', error);
        }
    }

    renderLeaderboard() {
        const tbody = document.getElementById('eventLeaderboardBody');
        if (!tbody || this.leaderboardData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-500">No scores yet</td></tr>';
            return;
        }

        // Sort based on current format
        const sorted = [...this.leaderboardData];
        switch (this.currentFormat) {
            case 'stableford':
                sorted.sort((a, b) => (b.total_stableford || 0) - (a.total_stableford || 0));
                break;
            case 'strokeplay':
            case 'scramble':
                sorted.sort((a, b) => (a.total_gross || 999) - (b.total_gross || 999));
                break;
            case 'nassau':
                sorted.sort((a, b) => {
                    const aTotal = a.format_scores?.nassau?.total || 999;
                    const bTotal = b.format_scores?.nassau?.total || 999;
                    return aTotal - bTotal;
                });
                break;
            case 'skins':
                sorted.sort((a, b) => {
                    const aHoles = a.format_scores?.skins?.holes_won || 0;
                    const bHoles = b.format_scores?.skins?.holes_won || 0;
                    return bHoles - aHoles;
                });
                break;
        }

        tbody.innerHTML = sorted.map((round, index) => {
            const position = index + 1;
            const points = this.pointAllocation[position] || 0;
            const score = this.getScoreForFormat(round, this.currentFormat);
            const status = round.status === 'completed' ? '<span class="text-green-600">✓ Complete</span>' : '<span class="text-blue-600">In Progress</span>';

            // Net score calculation
            const netScore = round.total_gross ? round.total_gross - Math.round(round.handicap_used || 0) : '-';

            return `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="py-2 px-3 font-bold">${position}</td>
                    <td class="py-2 px-3">${this.getPlayerName(round.golfer_id)}</td>
                    <td class="py-2 px-3">${Math.round(round.handicap_used || 0)}</td>
                    <td class="py-2 px-3">${round.total_gross || '-'}</td>
                    <td class="py-2 px-3">${netScore}</td>
                    <td class="py-2 px-3 font-bold">${score}</td>
                    <td class="py-2 px-3 text-yellow-600 font-bold">${points}</td>
                    <td class="py-2 px-3">${status}</td>
                </tr>
            `;
        }).join('');
    }

    getScoreForFormat(round, format) {
        switch (format) {
            case 'stableford':
                return round.total_stableford || 0;
            case 'strokeplay':
            case 'scramble':
                return round.total_gross || 0;
            case 'nassau':
                return round.format_scores?.nassau?.total || '-';
            case 'skins':
                return round.format_scores?.skins?.holes_won || 0;
            default:
                return round.total_stableford || 0;
        }
    }

    getPlayerName(golferId) {
        // Try to get player name from cache or return ID
        // In a real implementation, you'd have a player name lookup
        return golferId ? golferId.substring(0, 20) + '...' : 'Unknown';
    }

    updateStats() {
        const total = this.leaderboardData.length;
        const completed = this.leaderboardData.filter(r => r.status === 'completed').length;
        const inProgress = total - completed;
        const avgScore = total > 0
            ? Math.round(this.leaderboardData.reduce((sum, r) => sum + (r.total_stableford || 0), 0) / total)
            : '-';

        document.getElementById('statTotalPlayers').textContent = total;
        document.getElementById('statCompleted').textContent = completed;
        document.getElementById('statInProgress').textContent = inProgress;
        document.getElementById('statAvgScore').textContent = avgScore;
    }

    changeFormat(format) {
        this.currentFormat = format;
        this.renderLeaderboard();
    }

    updatePointsTable() {
        const count = parseInt(document.getElementById('scoringPlacesCount')?.value) || 5;
        const tbody = document.getElementById('pointsAllocationBody');
        if (!tbody) return;

        tbody.innerHTML = '';
        for (let i = 1; i <= count; i++) {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-200';
            tr.innerHTML = `
                <td class="py-2 px-3 font-medium">${this.getPositionLabel(i)}</td>
                <td class="py-2 px-3">
                    <input type="number"
                           id="points_${i}"
                           value="${this.pointAllocation[i] || 0}"
                           onchange="OrganizerScoringSystem.updatePointValue(${i}, this.value)"
                           class="w-20 rounded border px-2 py-1 text-sm">
                </td>
            `;
            tbody.appendChild(tr);
        }
    }

    getPositionLabel(pos) {
        const labels = {
            1: '1st Place',
            2: '2nd Place',
            3: '3rd Place'
        };
        return labels[pos] || `${pos}th Place`;
    }

    applyPointSystem(system) {
        const count = parseInt(document.getElementById('scoringPlacesCount')?.value) || 5;

        switch (system) {
            case 'f1':
                // F1 style: 25, 18, 15, 12, 10, 8, 6, 4, 2, 1
                const f1Points = [25, 18, 15, 12, 10, 8, 6, 4, 2, 1];
                for (let i = 1; i <= count; i++) {
                    this.pointAllocation[i] = f1Points[i-1] || 0;
                }
                break;

            case 'linear':
                // Linear: 10, 9, 8, 7, 6...
                for (let i = 1; i <= count; i++) {
                    this.pointAllocation[i] = Math.max(0, 11 - i);
                }
                break;

            case 'winner-heavy':
                // Winner heavy: 100, 50, 25, 15, 10, 8, 6, 4, 2, 1
                const whPoints = [100, 50, 25, 15, 10, 8, 6, 4, 2, 1];
                for (let i = 1; i <= count; i++) {
                    this.pointAllocation[i] = whPoints[i-1] || 0;
                }
                break;

            default:
                // Custom - keep existing values
                break;
        }

        this.updatePointsTable();
    }

    updatePointValue(position, value) {
        this.pointAllocation[position] = parseInt(value) || 0;
        this.renderLeaderboard();
    }

    async savePointAllocation() {
        // Save point allocation to event metadata
        try {
            const { error } = await window.SupabaseDB.client
                .from('society_events')
                .update({
                    point_allocation: this.pointAllocation
                })
                .eq('id', this.currentEventId);

            if (error) throw error;

            NotificationManager.show('Point allocation saved!', 'success');
        } catch (error) {
            console.error('[OrganizerScoring] Error saving points:', error);
            NotificationManager.show('Error saving point allocation', 'error');
        }
    }

    assignPoints() {
        this.renderLeaderboard();
        NotificationManager.show('Points assigned to leaderboard!', 'success');
    }

    async publishResults() {
        if (!confirm('Publish results and notify all players?')) return;

        try {
            // Mark event as results published
            const { error } = await window.SupabaseDB.client
                .from('society_events')
                .update({
                    results_published: true,
                    results_published_at: new Date().toISOString()
                })
                .eq('id', this.currentEventId);

            if (error) throw error;

            NotificationManager.show('Results published successfully!', 'success');
        } catch (error) {
            console.error('[OrganizerScoring] Error publishing results:', error);
            NotificationManager.show('Error publishing results', 'error');
        }
    }

    exportToCSV() {
        if (this.leaderboardData.length === 0) {
            NotificationManager.show('No data to export', 'warning');
            return;
        }

        // Create CSV content
        const headers = ['Position', 'Player ID', 'Handicap', 'Gross', 'Net', 'Score', 'Points', 'Status'];
        const rows = this.leaderboardData.map((round, index) => {
            const position = index + 1;
            const points = this.pointAllocation[position] || 0;
            const score = this.getScoreForFormat(round, this.currentFormat);
            const netScore = round.total_gross - Math.round(round.handicap_used || 0);
            return [
                position,
                round.golfer_id,
                Math.round(round.handicap_used || 0),
                round.total_gross || 0,
                netScore,
                score,
                points,
                round.status
            ].join(',');
        });

        const csv = [headers.join(','), ...rows].join('\n');

        // Download CSV
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `event-${this.currentEventId}-results.csv`;
        a.click();
        window.URL.revokeObjectURL(url);

        NotificationManager.show('CSV exported successfully!', 'success');
    }

    destroy() {
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
        }
    }
}

// Create global instance
window.OrganizerScoringSystem = new OrganizerScoringSystem();

// Initialize calendar when Calendar tab is shown
const originalShowOrganizerTab2 = showOrganizerTab;
showOrganizerTab = function(tabName) {
    originalShowOrganizerTab2(tabName);

    // Initialize calendar when Calendar tab is shown
    if (tabName === 'calendar') {
        if (!window.SocietyCalendar) {
            window.SocietyCalendar = new SocietyCalendar();
        }
        setTimeout(() => {
            window.SocietyCalendar.init();
        }, 100);
    }

    // Initialize scoring system when Scoring tab is shown
    if (tabName === 'scoring' && window.OrganizerScoringSystem) {
        setTimeout(() => {
            window.OrganizerScoringSystem.init();
        }, 100);
    }

    // Load user role and update admin tab UI when Admin tab is shown
    if (tabName === 'admin' && window.SocietyOrganizerSystem) {
        setTimeout(async () => {
            const role = await window.SocietyOrganizerSystem.loadUserRole();
            await window.SocietyOrganizerSystem.updateAdminTabUI(role);
        }, 100);
    }
};


    </script>

    <!-- Professional Chat Container - Dual Panel System -->
    <div id="professionalChatContainer" class="professional-chat" style="display: none;">
        <style>
            /* Desktop: Floating 2-panel chat window (contacts + messages) */
            @media (min-width: 769px) {
                #professionalChatContainer {
                    position: fixed !important;
                    top: auto;
                    bottom: 0;
                    right: 20px;
                    width: 850px;
                    height: 600px;
                    max-width: calc(100vw - 40px);
                    max-height: calc(100vh - 100px);
                    z-index: 10000;
                }
                #professionalChatContainer .chat-wrapper {
                    display: flex;
                    height: 100%;
                    background: white;
                    border-radius: 12px 12px 0 0;
                    box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
                    overflow: hidden;
                }
                #professionalChatContainer .chat-sidebar { display: flex !important; }
                #professionalChatContainer #main #chatBackBtn { display: none !important; }
            }

            /* Mobile: Single-panel toggle between contacts and chat */
            @media (max-width: 768px) {
                #professionalChatContainer {
                    position: fixed !important;
                    top: max(60px, env(safe-area-inset-top)) !important; /* Respect notches */
                    left: env(safe-area-inset-left, 0) !important;
                    right: env(safe-area-inset-right, 0) !important;
                    bottom: max(70px, calc(10px + env(safe-area-inset-bottom))) !important; /* Adaptive spacing for phone UI */
                    width: 100vw !important;
                    height: auto !important; /* Auto height based on top/bottom */
                    background: rgba(0, 0, 0, 0.3) !important;
                    z-index: 9999 !important;
                }
                #professionalChatContainer .chat-wrapper {
                    height: 100% !important;
                    display: flex !important;
                    flex-direction: column !important;
                    background: white !important;
                    border-radius: 16px 16px 0 0;
                    box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
                }

                /* Contacts sidebar - full screen on mobile */
                #professionalChatContainer .chat-sidebar {
                    width: 100% !important;
                    border-right: none !important;
                    flex: 1 !important;
                    display: flex !important;
                    flex-direction: column !important;
                    overflow: hidden !important;
                }

                /* Main chat area - full screen on mobile when active */
                #professionalChatContainer #main {
                    width: 100% !important;
                    flex: 1 !important;
                    min-height: 0;
                    display: none !important; /* Hidden by default on mobile */
                    flex-direction: column !important;
                }

                /* Show chat header on mobile when chat is open */
                #professionalChatContainer #chatHeader {
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                }

                /* When chat is active, hide sidebar and show main */
                #professionalChatContainer.chat-active .chat-sidebar {
                    display: none !important;
                }
                #professionalChatContainer.chat-active #main {
                    display: flex !important;
                }

                #professionalChatContainer #messages {
                    flex: 1 !important;
                    overflow-y: auto !important;
                    min-height: 200px !important; /* Ensure messages have minimum space */
                }
                #professionalChatContainer .close-btn {
                    font-size: 1.5rem !important;
                    padding: 0.5rem !important;
                    background: rgba(255, 255, 255, 0.2) !important;
                    border-radius: 50% !important;
                    width: 36px !important;
                    height: 36px !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                }
                #professionalChatContainer #composerRow {
                    padding: 0.75rem 1rem !important;
                    padding-bottom: calc(0.75rem + var(--safe-bottom)) !important; /* Add safe area to bottom padding */
                    margin-bottom: 0 !important; /* Ensure no extra bottom margin */
                    flex-shrink: 0 !important; /* Don't shrink the input area */
                }
                #professionalChatContainer #composer {
                    font-size: 16px !important; /* Prevents zoom on iOS */
                    padding: 0.625rem 1rem !important;
                }
                #professionalChatContainer #sendBtn {
                    padding: 0.625rem 1rem !important;
                    font-size: 14px !important;
                    white-space: nowrap !important;
                }
            }
        </style>
        <div class="chat-wrapper" style="display: flex;">
            <!-- Sidebar -->
            <div class="chat-sidebar" style="width: 280px; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; overflow: hidden; background: white;">
                <div style="padding: 1rem; border-bottom: 1px solid #e5e7eb; position: relative; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                    <h2 style="margin: 0; font-size: 1.125rem; font-weight: 600;">💬 Messages</h2>
                    <button class="close-btn" onclick="document.querySelector('#professionalChatContainer').style.display='none'"
                            style="position: absolute; top: 0.75rem; right: 0.75rem; background: rgba(255,255,255,0.2); border: none; font-size: 1.25rem; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px; color: white;">
                        ✕
                    </button>
                </div>

                <!-- Contacts Search Bar + Group Button -->
                <div id="contactsHeader" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; border-bottom: 1px solid #e5e7eb; background: white; position: sticky; top: 0; z-index: 20;">
                    <div style="position: relative; flex: 1;">
                        <input id="contactsSearch"
                               type="search"
                               placeholder="Search by name or ID…"
                               style="width: 100%; border-radius: 0.75rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; padding-right: 2.25rem; font-size: 14px;"
                               autocomplete="off" />
                        <span style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none;">🔎</span>
                    </div>
                    <button id="openGroupBuilder"
                            style="border-radius: 0.75rem; border: 1px solid #000; padding: 0.5rem 0.75rem; background: #000; color: white; font-weight: 500; font-size: 14px; cursor: pointer; white-space: nowrap;">
                        + Group
                    </button>
                </div>

                <ul id="conversations" style="flex: 1; overflow-y: auto; list-style: none; padding: 0.5rem 0; margin: 0; background: #f9fafb;">
                    <!-- Conversations will be rendered here -->
                </ul>
            </div>

            <!-- Main Chat Area -->
            <div id="main" style="flex: 1; display: flex; flex-direction: column; overflow: hidden; background: white;">
                <!-- Chat Header (mobile back button + contact name) -->
                <div id="chatHeader" style="display: none; padding: 1rem; border-bottom: 1px solid #e5e7eb; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; position: relative;">
                    <button id="chatBackBtn" onclick="window.chatBackToContacts()"
                            style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; font-size: 1.25rem; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px; color: white; display: flex; align-items: center; gap: 0.25rem;">
                        ← Back
                    </button>
                    <h3 id="chatContactName" style="margin: 0; font-size: 1rem; font-weight: 600; text-align: center;">Chat</h3>
                    <button class="close-btn" onclick="document.querySelector('#professionalChatContainer').style.display='none'"
                            style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; font-size: 1.25rem; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px; color: white;">
                        ✕
                    </button>
                </div>

                <!-- Messages -->
                <div id="messages" style="flex: 1; overflow-y: auto; padding: 1rem; background: #f9fafb;">
                    <div style="text-align: center; padding: 2rem; color: #9ca3af;">
                        Select a conversation to start chatting
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div id="typing" style="padding: 0.5rem 1rem; min-height: 1.5rem; color: #6b7280; font-size: 0.875rem;">
                    <!-- "typing..." will appear here -->
                </div>

                <!-- Composer -->
                <div id="composerRow" style="padding: 1rem; border-top: 1px solid #e5e7eb; display: flex; gap: 0.5rem; align-items: center; background: white;">
                    <input id="composer" placeholder="Type a message..."
                           style="flex: 1; padding: 0.625rem 1rem; border: 1px solid #d1d5db; border-radius: 1.5rem; outline: none; min-width: 0; font-size: 14px;" />
                    <button id="sendBtn" style="padding: 0.625rem 1.25rem; background: #10b981; color: white; border: none; border-radius: 1.5rem; cursor: pointer; font-weight: 500; flex-shrink: 0; font-size: 14px;">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Professional Chat System Initialization -->
    <script type="module">
        // Import new chat system modules
        import { initChat, subscribeGlobalMessages } from '/chat/chat-system-full.js?v=2025-10-13-REALTIME-FIX&t=1760319200';
        import { openOrCreateDM, updateUnreadBadge } from '/chat/chat-database-functions.js?v=2025-10-13-REALTIME-FIX&t=1760319200';

        // Initialize chat when chat button is clicked
        window.openProfessionalChat = async function() {
            console.log('[Chat] Opening professional chat system...');

            // Hide old chat if open
            const oldChat = document.querySelector('#chatModal');
            if (oldChat) oldChat.style.display = 'none';

            // Show new chat container
            const chatContainer = document.querySelector('#professionalChatContainer');
            if (!chatContainer) {
                console.error('[Chat] Container not found');
                return;
            }

            chatContainer.style.display = 'block';

            // Close on backdrop click (mobile)
            chatContainer.onclick = (e) => {
                if (e.target === chatContainer) {
                    chatContainer.style.display = 'none';
                }
            };

            // Initialize chat (loads conversations)
            try {
                await initChat();
                console.log('[Chat] ✅ Professional chat system initialized');
            } catch (error) {
                console.error('[Chat] ❌ Failed to initialize:', error);
            }
        };

        // Mobile navigation: Back to contacts list
        window.chatBackToContacts = function() {
            const chatContainer = document.querySelector('#professionalChatContainer');
            if (chatContainer) {
                chatContainer.classList.remove('chat-active');
                console.log('[Chat] Navigated back to contacts');
            }
        };

        // Mobile navigation: Show chat view (called when contact is clicked)
        window.chatShowConversation = function(contactName) {
            const chatContainer = document.querySelector('#professionalChatContainer');
            const chatContactName = document.querySelector('#chatContactName');

            if (chatContainer) {
                // On mobile, toggle to chat view
                if (window.innerWidth <= 768) {
                    chatContainer.classList.add('chat-active');
                    if (chatContactName && contactName) {
                        chatContactName.textContent = contactName;
                    }
                    console.log('[Chat] Switched to chat view:', contactName);
                }
            }
        };

        // ChatSystem has been removed - all buttons now call window.openProfessionalChat() directly

        // Initialize badge system on page load
        (async function initChatBadgeSystem() {
            try {
                // Wait for Supabase to be ready
                await new Promise(resolve => {
                    if (window.SupabaseDB?.ready) {
                        resolve();
                    } else {
                        const checkInterval = setInterval(() => {
                            if (window.SupabaseDB?.ready) {
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 100);
                    }
                });

                console.log('[Chat] Initializing badge system...');

                // Update badge with initial count
                await updateUnreadBadge();

                // Subscribe to global messages for real-time badge updates
                await subscribeGlobalMessages();

                console.log('[Chat] ✅ Badge system initialized');
            } catch (error) {
                console.error('[Chat] ❌ Failed to initialize badge system:', error);
            }
        })();

        // Expose for testing and external access
        window.__professionalChat = {
            initChat,
            openOrCreateDM,
            openProfessionalChat: window.openProfessionalChat,
            updateUnreadBadge,
            subscribeGlobalMessages
        };

        console.log('[Chat] Professional chat module loaded');
    </script>

</body>
</html>



