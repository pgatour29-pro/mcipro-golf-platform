<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MyCaddy Pro â€¢ Maintenance Management</title>
  <style>
    :root{--bg:#f4f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;--brand:#2563eb;--border:rgba(0,0,0,.12);--success:#10b981;--warning:#f59e0b;--danger:#ef4444}
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    
    .topbar{height:56px;display:flex;align-items:center;gap:12px;padding:0 16px;background:#fff;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50}
    .brand{font-weight:800;color:#0f172a}
    .page{max-width:1400px;margin:14px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:20px;margin-bottom:16px}
    
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:repeat(auto-fit,minmax(400px,1fr))}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
    .grid-4{grid-template-columns:repeat(auto-fit,minmax(250px,1fr))}
    
    .export-controls{margin-bottom:16px;display:flex;gap:8px;flex-wrap:wrap}
    .export-btn{display:flex;align-items:center;gap:6px;padding:6px 12px;border:1px solid var(--border);background:#fff;border-radius:6px;cursor:pointer;font-size:0.75rem;transition:all 0.2s}
    .export-btn:hover{background:#f8fafc;border-color:var(--brand)}
    
    .metric-card{text-align:center;padding:16px;position:relative;overflow:hidden}
    .metric-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--brand),var(--success))}
    .metric-value{font-size:2rem;font-weight:700;margin-bottom:4px}
    .metric-label{font-size:0.875rem;color:var(--muted);margin-bottom:8px}
    
    h1{margin:0 0 20px 0;font-size:1.5rem;font-weight:700}
    h2{margin:0 0 12px 0;font-size:1.125rem;font-weight:600}
    h3{margin:0 0 8px 0;font-size:1rem;font-weight:600}
    
    .btn{padding:6px 12px;border:1px solid var(--border);background:#fff;border-radius:6px;cursor:pointer;font-size:0.75rem;transition:all 0.2s;display:inline-block;text-decoration:none;margin-right:4px}
    .btn:hover{background:#f8fafc}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn-primary:hover{background:#1d4ed8}
    .btn-success{background:var(--success);color:#fff;border-color:var(--success)}
    .btn-warning{background:var(--warning);color:#fff;border-color:var(--warning)}
    .btn-danger{background:var(--danger);color:#fff;border-color:var(--danger)}
    .btn-sm{padding:4px 8px;font-size:0.7rem}
    
    /* Work Order Styles */
    .work-order{border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px;background:#fff;transition:all 0.2s}
    .work-order:hover{box-shadow:0 4px 12px rgba(0,0,0,0.1);transform:translateY(-1px)}
    .work-order-header{display:flex;justify-content:between;align-items:flex-start;margin-bottom:12px}
    .work-order-title{font-weight:600;font-size:1rem;margin-bottom:4px}
    .work-order-details{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;font-size:0.875rem;color:var(--muted)}
    .work-order-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    
    .priority-badge{padding:2px 8px;border-radius:12px;font-size:0.7rem;font-weight:600;text-transform:uppercase}
    .priority-high{background:#fee2e2;color:#dc2626}
    .priority-medium{background:#fef3c7;color:#92400e}
    .priority-low{background:#dcfce7;color:#166534}
    
    .status-badge{padding:2px 8px;border-radius:12px;font-size:0.7rem;font-weight:600}
    .status-pending{background:#f1f5f9;color:#475569}
    .status-in-progress{background:#dbeafe;color:#1e40af}
    .status-completed{background:#dcfce7;color:#166534}
    .status-on-hold{background:#fef3c7;color:#92400e}
    
    /* Course Condition Styles */
    .condition-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;background:#fff}
    .condition-label{font-weight:600;font-size:0.875rem}
    .condition-controls{display:flex;gap:8px;align-items:center}
    .condition-dropdown{padding:4px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.75rem;cursor:pointer}
    .condition-excellent{background:#dcfce7;color:#166534}
    .condition-good{background:#dbeafe;color:#1e40af}
    .condition-fair{background:#fef3c7;color:#92400e}
    .condition-poor{background:#fee2e2;color:#dc2626}
    
    /* Progress Bar */
    .progress-container{margin:8px 0}
    .progress-bar{background:#f1f5f9;height:8px;border-radius:4px;overflow:hidden}
    .progress-fill{height:100%;border-radius:4px;transition:width 0.3s ease}
    .progress-success{background:var(--success)}
    .progress-warning{background:var(--warning)}
    .progress-brand{background:var(--brand)}
    
    /* Dropdown Styles */
    .dropdown{position:relative;display:inline-block}
    .dropdown-content{display:none;position:absolute;background:#fff;min-width:160px;box-shadow:0 8px 16px rgba(0,0,0,0.1);border:1px solid var(--border);border-radius:6px;z-index:100;top:100%;left:0}
    .dropdown-content a{color:var(--ink);padding:8px 12px;text-decoration:none;display:block;font-size:0.8rem;transition:background 0.2s}
    .dropdown-content a:hover{background:#f8fafc}
    .dropdown.active .dropdown-content{display:block}
    
    /* Weather Widget */
    .weather-widget{background:linear-gradient(135deg,#0ea5e9,#3b82f6);color:white;padding:16px;border-radius:12px;text-align:center;margin-bottom:16px}
    .weather-temp{font-size:1.5rem;font-weight:700;margin-bottom:4px}
    .weather-desc{font-size:0.875rem;opacity:0.9;margin-bottom:8px}
    .weather-details{font-size:0.75rem;opacity:0.8}
    
    /* Alert Box */
    .alert-box{padding:12px;border-radius:8px;margin-bottom:12px;border-left:4px solid}
    .alert-warning{background:#fef3c7;border-color:var(--warning);color:#92400e}
    .alert-info{background:#dbeafe;border-color:var(--brand);color:#1e40af}
    .alert-success{background:#dcfce7;border-color:var(--success);color:#166534}
    
    /* Modal Styles */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000}
    .modal.active{display:flex;align-items:center;justify-content:center}
    .modal-content{background:#fff;border-radius:12px;padding:24px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;padding:4px}
    
    /* Form Styles */
    .form-group{margin-bottom:16px}
    .form-label{display:block;margin-bottom:4px;font-weight:600;font-size:0.875rem}
    .form-input,.form-select,.form-textarea{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:0.875rem}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,0.1)}
    .form-textarea{resize:vertical;min-height:80px}
    
    /* Toast Notification */
    .toast{position:fixed;bottom:20px;right:20px;background:var(--success);color:white;padding:12px 16px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1100;transform:translateX(400px);transition:transform 0.3s ease;font-size:0.875rem}
    .toast.show{transform:translateX(0)}
    .toast.error{background:var(--danger)}
    .toast.warning{background:var(--warning)}
    .toast.info{background:var(--brand)}
    
    @media (max-width: 768px) {
      .grid-2,.grid-3,.grid-4{grid-template-columns:1fr}
      .work-order-details{grid-template-columns:1fr}
      .work-order-actions{justify-content:flex-start}
      .condition-controls{flex-direction:column;gap:4px}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">MyCaddy Pro</div>
    <div style="color:#64748b">Maintenance Management Center</div>
    <div style="margin-left:auto;display:flex;align-items:center;gap:12px">
      <div style="font-size:12px;color:#64748b" id="currentTime">14:33</div>
    </div>
  </header>

  <main class="page">
    <h1>Maintenance Management System</h1>
    
    <div class="export-controls">
      <button class="export-btn" onclick="exportData('maintenance', 'pdf')">ðŸ“„ Export PDF</button>
      <button class="export-btn" onclick="createWorkOrder()">ðŸ”§ New Work Order</button>
      <button class="export-btn" onclick="scheduleMaintenanceWindow()">ðŸ“… Schedule</button>
      <button class="export-btn" onclick="generateMaintenanceReport()">ðŸ“Š Generate Report</button>
    </div>
    
    <!-- Weather and Recommendations -->
    <div class="grid grid-3">
      <div class="weather-widget" id="weatherWidget">
        <div class="weather-temp" id="weatherTemp">28Â°C</div>
        <div class="weather-desc" id="weatherDesc">Partly Cloudy</div>
        <div class="weather-details" id="weatherDetails">Humidity: 65% â€¢ Wind: 8 km/h</div>
      </div>
      
      <div class="card">
        <h3>Weather-Based Recommendations</h3>
        <div id="weatherRecommendations">
          <div class="alert-box alert-info">
            <strong>Optimal Conditions:</strong> Perfect weather for outdoor maintenance tasks and irrigation system checks.
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3>Today's Priority Tasks</h3>
        <div id="priorityTasks">
          <div style="font-size:0.875rem;color:var(--muted);margin-bottom:8px">Based on weather and schedule</div>
          <ul style="margin:0;padding-left:16px;font-size:0.875rem">
            <li>Complete Cart #23 battery replacement</li>
            <li>Inspect irrigation system - Zone 3</li>
            <li>Bunker sand replenishment</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Key Metrics -->
    <div class="grid grid-4">
      <div class="card metric-card">
        <div class="metric-value" style="color:var(--warning)" id="openWorkOrders">7</div>
        <div class="metric-label">Open Work Orders</div>
      </div>
      <div class="card metric-card">
        <div class="metric-value" style="color:var(--success)" id="completedToday">23</div>
        <div class="metric-label">Completed Today</div>
      </div>
      <div class="card metric-card">
        <div class="metric-value" style="color:var(--brand)" id="equipmentUptime">94%</div>
        <div class="metric-label">Equipment Uptime</div>
      </div>
      <div class="card metric-card">
        <div class="metric-value" style="color:var(--success)" id="courseRating">8.2</div>
        <div class="metric-label">Course Rating</div>
      </div>
    </div>

    <div class="grid grid-2">
      <!-- Active Work Orders -->
      <div class="card">
        <h2>Active Work Orders</h2>
        <div id="workOrdersList">
          <!-- Work orders will be populated here -->
        </div>
        <button class="btn btn-primary" onclick="createWorkOrder()">+ Add New Work Order</button>
      </div>

      <!-- Course Conditions -->
      <div class="card">
        <h2>Course Conditions</h2>
        <div id="courseConditionsList">
          <!-- Course conditions will be populated here -->
        </div>
        
        <div id="bunkerAlert" class="alert-box alert-warning" style="margin-top:16px">
          <div style="font-weight:600">Bunker Maintenance</div>
          <div style="font-size:0.875rem;margin-bottom:8px">Sand levels low on holes 3, 7, and 14</div>
          <button class="btn btn-warning btn-sm" onclick="scheduleBunkerMaintenance()">Schedule Maintenance</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Work Order Modal -->
  <div id="workOrderModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Create Work Order</h3>
        <button class="modal-close" onclick="closeModal('workOrderModal')">&times;</button>
      </div>
      <form id="workOrderForm">
        <div class="form-group">
          <label class="form-label">Title</label>
          <input type="text" class="form-input" id="workOrderTitle" required>
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-textarea" id="workOrderDescription" required></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Priority</label>
          <select class="form-select" id="workOrderPriority" required>
            <option value="">Select Priority</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Assign To</label>
          <select class="form-select" id="workOrderAssignee" required>
            <option value="">Select Staff Member</option>
            <option value="mike-wilson">Mike Wilson - Maintenance</option>
            <option value="tom-johnson">Tom Johnson - Maintenance</option>
            <option value="dave-miller">Dave Miller - Equipment</option>
            <option value="external">External Contractor</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Due Date</label>
          <input type="datetime-local" class="form-input" id="workOrderDueDate" required>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button type="button" class="btn" onclick="closeModal('workOrderModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Work Order</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bunker Maintenance Modal -->
  <div id="bunkerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Schedule Bunker Maintenance</h3>
        <button class="modal-close" onclick="closeModal('bunkerModal')">&times;</button>
      </div>
      <form id="bunkerForm">
        <div class="form-group">
          <label class="form-label">Select Holes</label>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
            <label style="display:flex;align-items:center;gap:4px">
              <input type="checkbox" value="3" checked> Hole 3
            </label>
            <label style="display:flex;align-items:center;gap:4px">
              <input type="checkbox" value="7" checked> Hole 7
            </label>
            <label style="display:flex;align-items:center;gap:4px">
              <input type="checkbox" value="14" checked> Hole 14
            </label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Maintenance Type</label>
          <select class="form-select" id="bunkerType" required>
            <option value="sand-replenishment">Sand Replenishment</option>
            <option value="edge-repair">Edge Repair</option>
            <option value="drainage-check">Drainage Check</option>
            <option value="full-renovation">Full Renovation</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Assign To</label>
          <select class="form-select" id="bunkerAssignee" required>
            <option value="">Select Team</option>
            <option value="grounds-crew">Grounds Crew</option>
            <option value="mike-wilson">Mike Wilson</option>
            <option value="tom-johnson">Tom Johnson</option>
            <option value="external">External Contractor</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Scheduled Date</label>
          <input type="datetime-local" class="form-input" id="bunkerDate" required>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button type="button" class="btn" onclick="closeModal('bunkerModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Schedule Maintenance</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <script>
    // Application State
    const MaintenanceApp = {
      state: {
        workOrders: [],
        courseConditions: {
          greens: 'excellent',
          fairways: 'good', 
          bunkers: 'fair',
          cartPaths: 'excellent'
        },
        weather: null,
        staff: [
          { id: 'mike-wilson', name: 'Mike Wilson', department: 'Maintenance', available: true },
          { id: 'tom-johnson', name: 'Tom Johnson', department: 'Maintenance', available: true },
          { id: 'dave-miller', name: 'Dave Miller', department: 'Equipment', available: true },
          { id: 'external', name: 'External Contractor', department: 'Contract', available: true }
        ]
      },
      
      config: {
        weatherAPIKey: 'demo', // In production, use real API key
        weatherRecommendations: {
          sunny: {
            icon: 'â˜€ï¸',
            tasks: ['Irrigation system maintenance', 'Cart path cleaning', 'Equipment servicing'],
            warnings: ['Avoid chemical applications during peak heat', 'Ensure adequate hydration for outdoor crews']
          },
          cloudy: {
            icon: 'â˜ï¸', 
            tasks: ['Bunker maintenance', 'Tree trimming', 'Fertilizer application'],
            warnings: ['Monitor for rain development', 'Complete outdoor tasks before weather changes']
          },
          rainy: {
            icon: 'ðŸŒ§ï¸',
            tasks: ['Indoor equipment maintenance', 'Inventory management', 'Administrative tasks'],
            warnings: ['Postpone chemical applications', 'Avoid heavy equipment on course', 'Check drainage systems']
          },
          windy: {
            icon: 'ðŸ’¨',
            tasks: ['Indoor maintenance only', 'Secure loose equipment', 'Check flag conditions'],
            warnings: ['Avoid tree work', 'Postpone chemical spraying', 'Monitor course debris']
          }
        }
      }
    };

    // Initialize application
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });

    function initializeApp() {
      loadInitialData();
      updateCurrentTime();
      setInterval(updateCurrentTime, 30000);
      fetchWeatherData();
      
      // Setup event listeners
      setupEventListeners();
      
      console.log('Maintenance Management System initialized');
    }

    function setupEventListeners() {
      // Work order form
      document.getElementById('workOrderForm').addEventListener('submit', handleWorkOrderSubmit);
      
      // Bunker form
      document.getElementById('bunkerForm').addEventListener('submit', handleBunkerSubmit);
      
      // Close modal when clicking outside
      document.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
          closeModal(event.target.id);
        }
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
        if (!event.target.matches('.dropdown')) {
          closeAllDropdowns();
        }
      });
    }

    function loadInitialData() {
      // Initialize work orders
      MaintenanceApp.state.workOrders = [
        {
          id: 1,
          title: 'Cart #23 - Battery Issue',
          description: 'Battery not holding charge, replacement needed',
          priority: 'high',
          status: 'in-progress',
          assignee: 'mike-wilson',
          created: new Date('2024-01-15T10:30:00'),
          dueDate: new Date('2024-01-15T16:00:00'),
          progress: 65
        },
        {
          id: 2,
          title: 'Hole 7 - Sprinkler Repair',
          description: 'Sprinkler head damaged, water pressure issues',
          priority: 'medium',
          status: 'in-progress',
          assignee: 'tom-johnson',
          created: new Date('2024-01-15T08:00:00'),
          dueDate: new Date('2024-01-15T17:00:00'),
          progress: 40
        },
        {
          id: 3,
          title: 'Pro Shop - AC Maintenance',
          description: 'Annual AC system maintenance and filter replacement',
          priority: 'low',
          status: 'pending',
          assignee: 'external',
          created: new Date('2024-01-15T09:00:00'),
          dueDate: new Date('2024-01-15T14:00:00'),
          progress: 0
        },
        {
          id: 4,
          title: 'Mower #2 - Blade Replacement',
          description: 'Blades worn, affecting cut quality',
          priority: 'high',
          status: 'pending',
          assignee: 'dave-miller',
          created: new Date('2024-01-15T11:00:00'),
          dueDate: new Date('2024-01-15T16:00:00'),
          progress: 0
        }
      ];
      
      renderWorkOrders();
      renderCourseConditions();
      updateMetrics();
    }

    function renderWorkOrders() {
      const container = document.getElementById('workOrdersList');
      container.innerHTML = '';
      
      MaintenanceApp.state.workOrders
        .filter(wo => wo.status !== 'completed')
        .forEach(workOrder => {
          const orderElement = createWorkOrderElement(workOrder);
          container.appendChild(orderElement);
        });
    }

    function createWorkOrderElement(workOrder) {
      const element = document.createElement('div');
      element.className = 'work-order';
      element.innerHTML = `
        <div class="work-order-header">
          <div style="flex:1">
            <div class="work-order-title">${workOrder.title}</div>
            <div style="font-size:0.875rem;color:var(--muted);margin-bottom:8px">${workOrder.description}</div>
            <span class="priority-badge priority-${workOrder.priority}">${workOrder.priority}</span>
            <span class="status-badge status-${workOrder.status.replace('-', '')}">${workOrder.status.replace('-', ' ')}</span>
          </div>
        </div>
        
        <div class="work-order-details">
          <div>
            <strong>Assigned to:</strong> ${getStaffName(workOrder.assignee)}
          </div>
          <div>
            <strong>Due:</strong> ${formatDateTime(workOrder.dueDate)}
          </div>
        </div>
        
        <div class="progress-container">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;font-size:0.75rem">
            <span>Progress</span>
            <span>${workOrder.progress}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill ${workOrder.progress >= 80 ? 'progress-success' : workOrder.progress >= 40 ? 'progress-brand' : 'progress-warning'}" 
                 style="width:${workOrder.progress}%"></div>
          </div>
        </div>
        
        <div class="work-order-actions">
          <div class="dropdown">
            <button class="btn btn-sm" onclick="toggleDropdown(event, 'assign-${workOrder.id}')">Reassign</button>
            <div id="assign-${workOrder.id}" class="dropdown-content">
              ${MaintenanceApp.state.staff.map(staff => 
                `<a href="#" onclick="event.preventDefault(); reassignWorkOrder(${workOrder.id}, '${staff.id}')">${staff.name}</a>`
              ).join('')}
            </div>
          </div>
          
          <div class="dropdown">
            <button class="btn btn-sm" onclick="toggleDropdown(event, 'status-${workOrder.id}')">Update Status</button>
            <div id="status-${workOrder.id}" class="dropdown-content">
              <a href="#" onclick="event.preventDefault(); updateWorkOrderStatus(${workOrder.id}, 'pending')">Pending</a>
              <a href="#" onclick="event.preventDefault(); updateWorkOrderStatus(${workOrder.id}, 'in-progress')">In Progress</a>
              <a href="#" onclick="event.preventDefault(); updateWorkOrderStatus(${workOrder.id}, 'on-hold')">On Hold</a>
              <a href="#" onclick="event.preventDefault(); updateWorkOrderStatus(${workOrder.id}, 'completed')">Completed</a>
            </div>
          </div>
          
          <div class="dropdown">
            <button class="btn btn-sm" onclick="toggleDropdown(event, 'progress-${workOrder.id}')">Update Progress</button>
            <div id="progress-${workOrder.id}" class="dropdown-content">
              <a href="#" onclick="event.preventDefault(); updateWorkOrderProgress(${workOrder.id}, 0)">0%</a>
              <a href="#" onclick="event.preventDefault(); updateWorkOrderProgress(${workOrder.id}, 25)">25%</a>
              <a href="#" onclick="event.preventDefault(); updateWorkOrderProgress(${workOrder.id}, 50)">50%</a>
              <a href="#" onclick="event.preventDefault(); updateWorkOrderProgress(${workOrder.id}, 75)">75%</a>
              <a href="#" onclick="event.preventDefault(); updateWorkOrderProgress(${workOrder.id}, 100)">100%</a>
            </div>
          </div>
          
          <button class="btn btn-sm btn-primary" onclick="viewWorkOrderDetails(${workOrder.id})">Details</button>
        </div>
      `;
      
      return element;
    }

    function renderCourseConditions() {
      const container = document.getElementById('courseConditionsList');
      const conditions = [
        { name: 'Greens Quality', key: 'greens' },
        { name: 'Fairway Condition', key: 'fairways' },
        { name: 'Bunker Condition', key: 'bunkers' },
        { name: 'Cart Path Condition', key: 'cartPaths' }
      ];
      
      container.innerHTML = conditions.map(condition => `
        <div class="condition-item">
          <div class="condition-label">${condition.name}</div>
          <div class="condition-controls">
            <div class="dropdown">
              <button class="condition-dropdown condition-${MaintenanceApp.state.courseConditions[condition.key]}" 
                      onclick="toggleDropdown(event, 'condition-${condition.key}')">
                ${MaintenanceApp.state.courseConditions[condition.key].charAt(0).toUpperCase() + MaintenanceApp.state.courseConditions[condition.key].slice(1)}
              </button>
              <div id="condition-${condition.key}" class="dropdown-content">
                <a href="#" onclick="event.preventDefault(); updateCourseCondition('${condition.key}', 'excellent')">Excellent</a>
                <a href="#" onclick="event.preventDefault(); updateCourseCondition('${condition.key}', 'good')">Good</a>
                <a href="#" onclick="event.preventDefault(); updateCourseCondition('${condition.key}', 'fair')">Fair</a>
                <a href="#" onclick="event.preventDefault(); updateCourseCondition('${condition.key}', 'poor')">Poor</a>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Work Order Management Functions
    function reassignWorkOrder(workOrderId, newAssignee) {
      const workOrder = MaintenanceApp.state.workOrders.find(wo => wo.id === workOrderId);
      if (workOrder) {
        const oldAssignee = getStaffName(workOrder.assignee);
        const newAssigneeName = getStaffName(newAssignee);
        
        workOrder.assignee = newAssignee;
        renderWorkOrders();
        closeAllDropdowns();
        
        showToast(`Work order reassigned from ${oldAssignee} to ${newAssigneeName}`, 'success');
      }
    }

    function updateWorkOrderStatus(workOrderId, newStatus) {
      const workOrder = MaintenanceApp.state.workOrders.find(wo => wo.id === workOrderId);
      if (workOrder) {
        workOrder.status = newStatus;
        
        if (newStatus === 'completed') {
          workOrder.progress = 100;
        } else if (newStatus === 'in-progress' && workOrder.progress === 0) {
          workOrder.progress = 25;
        }
        
        renderWorkOrders();
        updateMetrics();
        closeAllDropdowns();
        
        showToast(`Work order status updated to ${newStatus.replace('-', ' ')}`, 'success');
      }
    }

    function updateWorkOrderProgress(workOrderId, newProgress) {
      const workOrder = MaintenanceApp.state.workOrders.find(wo => wo.id === workOrderId);
      if (workOrder) {
        workOrder.progress = newProgress;
        
        if (newProgress === 100) {
          workOrder.status = 'completed';
        } else if (newProgress > 0 && workOrder.status === 'pending') {
          workOrder.status = 'in-progress';
        }
        
        renderWorkOrders();
        updateMetrics();
        closeAllDropdowns();
        
        showToast(`Work order progress updated to ${newProgress}%`, 'success');
      }
    }

    function updateCourseCondition(conditionKey, newValue) {
      MaintenanceApp.state.courseConditions[conditionKey] = newValue;
      renderCourseConditions();
      closeAllDropdowns();
      
      const conditionName = conditionKey.charAt(0).toUpperCase() + conditionKey.slice(1);
      showToast(`${conditionName} condition updated to ${newValue}`, 'success');
      
      // Auto-generate work order for poor conditions
      if (newValue === 'poor') {
        autoGenerateMaintenanceOrder(conditionKey);
      }
    }

    function autoGenerateMaintenanceOrder(conditionKey) {
      const maintenanceTasks = {
        greens: 'Greens restoration and treatment required',
        fairways: 'Fairway maintenance and reseeding needed', 
        bunkers: 'Bunker renovation and sand replacement required',
        cartPaths: 'Cart path repair and resurfacing needed'
      };
      
      const newWorkOrder = {
        id: Date.now(),
        title: `${conditionKey.charAt(0).toUpperCase() + conditionKey.slice(1)} Maintenance - Auto Generated`,
        description: maintenanceTasks[conditionKey],
        priority: 'high',
        status: 'pending',
        assignee: 'mike-wilson',
        created: new Date(),
        dueDate: new Date(Date.now() + 24 * 60 * 60 * 1000), // Tomorrow
        progress: 0
      };
      
      MaintenanceApp.state.workOrders.push(newWorkOrder);
      renderWorkOrders();
      updateMetrics();
      
      showToast('Auto-generated maintenance work order created', 'info');
    }

    // Weather and Recommendations
    async function fetchWeatherData() {
      try {
        // Golf course location: Bang Lamung, Chon Buri, Thailand
        const latitude = 12.9236;
        const longitude = 100.8824;
        
        // Use OpenWeatherMap API (free tier available)
        const apiKey = 'demo_key'; // Replace with actual API key in production
        const weatherUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=${apiKey}&units=metric`;
        
        // For demo purposes, use realistic Thailand weather data
        // In production, uncomment the fetch call below:
        /*
        const response = await fetch(weatherUrl);
        const weatherData = await response.json();
        
        MaintenanceApp.state.weather = {
          condition: determineCondition(weatherData.weather[0].main),
          temperature: Math.round(weatherData.main.temp),
          humidity: weatherData.main.humidity,
          windSpeed: Math.round(weatherData.wind.speed * 3.6), // Convert m/s to km/h
          description: weatherData.weather[0].description
        };
        */
        
        // Demo data for Bang Lamung, Chon Buri - realistic for tropical climate
        MaintenanceApp.state.weather = {
          condition: 'cloudy',
          temperature: 32,
          humidity: 78,
          windSpeed: 12,
          description: 'Partly Cloudy with High Humidity',
          location: 'Bang Lamung, Chon Buri'
        };
        
        updateWeatherDisplay();
        updateWeatherRecommendations();
        
      } catch (error) {
        console.error('Weather fetch error:', error);
        
        // Fallback to default tropical weather data
        MaintenanceApp.state.weather = {
          condition: 'cloudy',
          temperature: 30,
          humidity: 75,
          windSpeed: 10,
          description: 'Tropical Climate',
          location: 'Bang Lamung, Chon Buri'
        };
        
        updateWeatherDisplay();
        updateWeatherRecommendations();
        
        showToast('Using default weather data - API connection failed', 'warning');
      }
    }

    function determineCondition(weatherMain) {
      const conditionMap = {
        'Clear': 'sunny',
        'Clouds': 'cloudy', 
        'Rain': 'rainy',
        'Drizzle': 'rainy',
        'Thunderstorm': 'rainy',
        'Snow': 'cloudy',
        'Mist': 'cloudy',
        'Fog': 'cloudy'
      };
      
      return conditionMap[weatherMain] || 'cloudy';
    }

    function updateWeatherDisplay() {
      const weather = MaintenanceApp.state.weather;
      document.getElementById('weatherTemp').textContent = `${weather.temperature}Â°C`;
      document.getElementById('weatherDesc').textContent = weather.description;
      document.getElementById('weatherDetails').textContent = 
        `Humidity: ${weather.humidity}% â€¢ Wind: ${weather.windSpeed} km/h${weather.location ? ' â€¢ ' + weather.location : ''}`;
    }

    function updateWeatherRecommendations() {
      const weather = MaintenanceApp.state.weather;
      const recommendations = MaintenanceApp.config.weatherRecommendations[weather.condition];
      const container = document.getElementById('weatherRecommendations');
      
      // Customize recommendations based on tropical Thailand conditions
      let tropicalRecommendations = { ...recommendations };
      
      if (weather.humidity > 80) {
        tropicalRecommendations.warnings = [
          ...tropicalRecommendations.warnings,
          'High humidity - ensure crew hydration and frequent breaks',
          'Optimal conditions for fungal growth - monitor turf closely'
        ];
      }
      
      if (weather.temperature > 35) {
        tropicalRecommendations.warnings = [
          ...tropicalRecommendations.warnings,
          'Extreme heat - limit outdoor work to early morning/evening',
          'Increase irrigation frequency to prevent heat stress'
        ];
      }
      
      let html = `
        <div class="alert-box alert-info">
          <strong>${tropicalRecommendations.icon} ${weather.condition.charAt(0).toUpperCase() + weather.condition.slice(1)} Conditions:</strong>
          Current weather conditions for ${weather.location || 'golf course location'}.
        </div>
      `;
      
      html += '<div style="margin-bottom:12px"><strong>Recommended Tasks:</strong></div>';
      html += '<ul style="margin:0 0 12px 16px;font-size:0.875rem">';
      tropicalRecommendations.tasks.forEach(task => {
        html += `<li>${task}</li>`;
      });
      html += '</ul>';
      
      if (tropicalRecommendations.warnings.length > 0) {
        html += '<div style="margin-bottom:8px"><strong>Weather Warnings:</strong></div>';
        html += '<ul style="margin:0 0 12px 16px;font-size:0.875rem;color:var(--warning)">';
        tropicalRecommendations.warnings.forEach(warning => {
          html += `<li>${warning}</li>`;
        });
        html += '</ul>';
      }
      
      container.innerHTML = html;
    }

    // Modal Management
    function createWorkOrder() {
      document.getElementById('modalTitle').textContent = 'Create Work Order';
      document.getElementById('workOrderForm').reset();
      document.getElementById('workOrderModal').classList.add('active');
      
      // Set default due date to tomorrow
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(17, 0, 0, 0);
      document.getElementById('workOrderDueDate').value = tomorrow.toISOString().slice(0, 16);
    }

    function scheduleBunkerMaintenance() {
      document.getElementById('bunkerModal').classList.add('active');
      
      // Set default date to tomorrow morning
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(8, 0, 0, 0);
      document.getElementById('bunkerDate').value = tomorrow.toISOString().slice(0, 16);
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function handleWorkOrderSubmit(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const newWorkOrder = {
        id: Date.now(),
        title: document.getElementById('workOrderTitle').value,
        description: document.getElementById('workOrderDescription').value,
        priority: document.getElementById('workOrderPriority').value,
        status: 'pending',
        assignee: document.getElementById('workOrderAssignee').value,
        created: new Date(),
        dueDate: new Date(document.getElementById('workOrderDueDate').value),
        progress: 0
      };
      
      MaintenanceApp.state.workOrders.push(newWorkOrder);
      renderWorkOrders();
      updateMetrics();
      closeModal('workOrderModal');
      
      showToast('Work order created successfully', 'success');
    }

    function handleBunkerSubmit(event) {
      event.preventDefault();
      
      const checkedHoles = Array.from(document.querySelectorAll('#bunkerForm input[type="checkbox"]:checked'))
        .map(cb => cb.value);
      
      const bunkerType = document.getElementById('bunkerType').value;
      const assignee = document.getElementById('bunkerAssignee').value;
      const scheduledDate = new Date(document.getElementById('bunkerDate').value);
      
      const newWorkOrder = {
        id: Date.now(),
        title: `Bunker Maintenance - Holes ${checkedHoles.join(', ')}`,
        description: `${bunkerType.replace('-', ' ')} for bunkers on holes ${checkedHoles.join(', ')}`,
        priority: 'medium',
        status: 'pending',
        assignee: assignee,
        created: new Date(),
        dueDate: scheduledDate,
        progress: 0
      };
      
      MaintenanceApp.state.workOrders.push(newWorkOrder);
      renderWorkOrders();
      updateMetrics();
      closeModal('bunkerModal');
      
      // Update bunker condition if it was fair
      if (MaintenanceApp.state.courseConditions.bunkers === 'fair') {
        MaintenanceApp.state.courseConditions.bunkers = 'good';
        renderCourseConditions();
      }
      
      // Hide bunker alert
      document.getElementById('bunkerAlert').style.display = 'none';
      
      showToast('Bunker maintenance scheduled successfully', 'success');
    }

    // Utility Functions
    function toggleDropdown(event, dropdownId) {
      event.stopPropagation();
      closeAllDropdowns();
      document.getElementById(dropdownId).parentElement.classList.add('active');
    }

    function closeAllDropdowns() {
      document.querySelectorAll('.dropdown').forEach(dropdown => {
        dropdown.classList.remove('active');
      });
    }

    function getStaffName(staffId) {
      const staff = MaintenanceApp.state.staff.find(s => s.id === staffId);
      return staff ? staff.name : 'Unassigned';
    }

    function formatDateTime(date) {
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function updateMetrics() {
      const openOrders = MaintenanceApp.state.workOrders.filter(wo => wo.status !== 'completed').length;
      const completedToday = MaintenanceApp.state.workOrders.filter(wo => 
        wo.status === 'completed' && 
        wo.dueDate.toDateString() === new Date().toDateString()
      ).length;
      
      document.getElementById('openWorkOrders').textContent = openOrders;
      document.getElementById('completedToday').textContent = completedToday;
    }

    function updateCurrentTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('th-TH', { 
        hour12: false, 
        hour: '2-digit', 
        minute: '2-digit'
      });
      document.getElementById('currentTime').textContent = timeString;
    }

    function viewWorkOrderDetails(workOrderId) {
      const workOrder = MaintenanceApp.state.workOrders.find(wo => wo.id === workOrderId);
      if (workOrder) {
        showToast(`Viewing details for: ${workOrder.title}`, 'info');
      }
    }

    function showToast(message, type = 'success', duration = 3000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      
      container.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (container.contains(toast)) {
            container.removeChild(toast);
          }
        }, 300);
      }, duration);
    }

    // Additional functions for export and reporting
    function exportData(module, format) {
      showToast(`Exporting ${module} data as ${format.toUpperCase()}...`, 'info');
    }

    function scheduleMaintenanceWindow() {
      showToast('Opening maintenance scheduler...', 'info');
    }

    function generateMaintenanceReport() {
      showToast('Generating comprehensive maintenance report...', 'info');
    }

    // Error handling
    window.addEventListener('error', function(event) {
      console.error('Maintenance System Error:', event.error);
      showToast('An error occurred. Please refresh if problems persist.', 'error');
    });
  </script>
</body>
</html>