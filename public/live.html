<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Leaderboards - MyCaddiPro</title>
    <link rel="icon" href="data:,">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .winner-row { background: linear-gradient(90deg, #fef3c7 0%, #fde68a 50%, #fef3c7 100%); }
        .player-name { cursor: pointer; }
        .player-name:hover { text-decoration: underline; color: #059669; }
        .expand-icon { transition: transform 0.2s; }
        .expand-icon.expanded { transform: rotate(180deg); }
        .hole-details { display: none; }
        .hole-details.show { display: table-row; }
        .hole-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 2px; }
        .hole-cell { text-align: center; padding: 4px 2px; font-size: 11px; }
        .hole-header { background: #f3f4f6; font-weight: 600; }
        .hole-score { background: #fff; border: 1px solid #e5e7eb; }
        /* Score indicators */
        .score-eagle { background: #3b82f6; color: white; border-radius: 50%; font-weight: bold; box-shadow: 0 0 0 2px #1d4ed8; }
        .score-birdie { background: #60a5fa; color: white; border-radius: 50%; font-weight: bold; }
        .score-par { background: #fff; }
        .score-bogey { background: #ef4444; color: white; font-weight: bold; }
        .score-double { background: #991b1b; color: white; font-weight: bold; box-shadow: inset 0 0 0 2px #fca5a5; }
        .event-item { cursor: pointer; transition: all 0.2s; }
        .event-item:hover { background-color: #f3f4f6; }
        .event-item.active { background-color: #dcfce7; border-left: 3px solid #16a34a; }
        .sidebar-scroll { max-height: calc(100vh - 200px); overflow-y: auto; }
        .live-badge { animation: pulse 2s infinite; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-green-600 to-green-700 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-3xl">sports_golf</span>
                    <div>
                        <h1 class="text-xl font-bold">MyCaddiPro</h1>
                        <p class="text-green-200 text-sm">Live Leaderboards</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 text-sm">
                    <span class="material-symbols-outlined text-red-300 pulse">radio_button_checked</span>
                    <span>LIVE</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content - Two Column Layout -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Left/Center: Main Leaderboard Area -->
            <div class="flex-1 lg:w-2/3">
                <!-- Status Bar -->
                <div class="bg-white rounded-lg shadow-sm p-3 mb-4 flex items-center justify-between">
                    <div class="flex items-center gap-2 text-gray-600">
                        <span class="material-symbols-outlined">schedule</span>
                        <span id="lastUpdate">Loading...</span>
                    </div>
                    <button onclick="loadAllData()" class="flex items-center gap-1 text-green-600 hover:text-green-700">
                        <span class="material-symbols-outlined">refresh</span>
                        Refresh
                    </button>
                </div>

                <!-- Selected Event Header (for archived events) -->
                <div id="selectedEventHeader" class="hidden bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-amber-600">history</span>
                            <span class="text-amber-800 font-medium">Viewing Archived Event</span>
                        </div>
                        <button onclick="showLiveEvents()" class="text-amber-700 hover:text-amber-900 text-sm flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">arrow_back</span>
                            Back to Live
                        </button>
                    </div>
                </div>

                <!-- Leaderboards Container -->
                <div id="leaderboardsContainer">
                    <div class="text-center py-12 text-gray-500">
                        <span class="material-symbols-outlined text-5xl mb-4">hourglass_empty</span>
                        <p class="text-lg">Loading live leaderboards...</p>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar: Event History -->
            <div class="lg:w-1/3">
                <div class="bg-white rounded-lg shadow-sm overflow-hidden sticky top-4">
                    <div class="bg-gradient-to-r from-gray-700 to-gray-800 text-white p-4">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined">calendar_month</span>
                            <h2 class="font-bold">Event History</h2>
                        </div>
                        <p class="text-gray-300 text-sm mt-1">Select an event to view leaderboard</p>
                    </div>
                    <div id="eventHistorySidebar" class="sidebar-scroll p-2">
                        <div class="text-center py-6 text-gray-400">
                            <span class="material-symbols-outlined">event</span>
                            <p class="text-sm">Loading events...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="text-center py-6 text-gray-500 text-sm">
        <p>Auto-refreshes every 30 seconds for live events</p>
        <p class="mt-1">Powered by MyCaddiPro</p>
    </footer>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://pyeeplwsnupmhgbguwqs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZWVwbHdzbnVwbWhnYmd1d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDM2NjksImV4cCI6MjA3NTQxOTY2OX0.KVQ6WvDKz9s77lxn3AhSA_YTMCN6rsht9kDkMIDhngk';

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let allEvents = [];
        let allPools = [];
        let selectedEventId = null;
        let selectedPoolId = null;
        let viewingArchived = false;
        const expandedPlayers = new Set();
        let isLoading = false;
        let consecutiveErrors = 0;
        let refreshInterval = null;
        const BASE_REFRESH_MS = 30000; // 30 seconds (golf scores don't change every 5s)

        // Get today's date in YYYY-MM-DD format (LOCAL timezone, not UTC)
        function getToday() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Check if a date is in the past
        function isPastDate(dateStr) {
            const today = getToday();
            return dateStr < today;
        }

        // Check if a date is today
        function isToday(dateStr) {
            return dateStr === getToday();
        }

        // Format date for display
        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T12:00:00');
            const today = getToday();

            // Calculate yesterday using local time
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = `${yesterday.getFullYear()}-${String(yesterday.getMonth() + 1).padStart(2, '0')}-${String(yesterday.getDate()).padStart(2, '0')}`;

            if (dateStr === today) return 'Today';
            if (dateStr === yesterdayStr) return 'Yesterday';

            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
        }

        // Load all data (with guard against overlapping calls)
        async function loadAllData() {
            if (isLoading) return; // Prevent overlapping requests
            isLoading = true;
            try {
                await Promise.all([
                    loadEventHistory(),
                    viewingArchived ? loadArchivedLeaderboard() : loadLiveLeaderboards()
                ]);
                consecutiveErrors = 0; // Reset on success
            } catch (e) {
                consecutiveErrors++;
                console.error('loadAllData failed:', e);
            } finally {
                isLoading = false;
            }
        }

        // Load event history for sidebar (last 30 days + upcoming)
        async function loadEventHistory() {
            const sidebar = document.getElementById('eventHistorySidebar');

            try {
                // Get events from last 30 days
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const cutoffDate = thirtyDaysAgo.toISOString().split('T')[0];

                const { data: events, error: eventError } = await supabaseClient
                    .from('society_events')
                    .select('id, title, event_date, course_name, organizer_name, format')
                    .gte('event_date', cutoffDate)
                    .order('event_date', { ascending: false });

                if (eventError) throw eventError;

                // Also get pools from last 30 days
                const { data: pools, error: poolError } = await supabaseClient
                    .from('side_game_pools')
                    .select(`
                        id, name, type, date_iso, created_at,
                        pool_entrants (player_id)
                    `)
                    .gte('date_iso', cutoffDate)
                    .eq('is_public', true)
                    .order('date_iso', { ascending: false });

                if (poolError) throw poolError;

                allEvents = events || [];
                allPools = pools || [];

                // Group by date
                const eventsByDate = {};

                for (const event of allEvents) {
                    const date = event.event_date;
                    if (!eventsByDate[date]) eventsByDate[date] = [];
                    eventsByDate[date].push({ type: 'event', data: event });
                }

                for (const pool of allPools) {
                    const date = pool.date_iso;
                    if (!eventsByDate[date]) eventsByDate[date] = [];
                    eventsByDate[date].push({ type: 'pool', data: pool });
                }

                // Sort dates descending
                const sortedDates = Object.keys(eventsByDate).sort((a, b) => b.localeCompare(a));

                if (sortedDates.length === 0) {
                    sidebar.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <span class="material-symbols-outlined text-3xl mb-2">event_busy</span>
                            <p class="text-sm">No events found</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                for (const date of sortedDates) {
                    const items = eventsByDate[date];
                    const isLive = isToday(date);
                    const isPast = isPastDate(date);

                    html += `
                        <div class="mb-3">
                            <div class="flex items-center gap-2 px-2 py-1 text-xs font-semibold text-gray-500 uppercase">
                                ${isLive ? '<span class="w-2 h-2 bg-red-500 rounded-full live-badge"></span>' : ''}
                                ${formatDate(date)}
                                ${isPast ? '<span class="text-amber-600 font-normal">(Archived)</span>' : ''}
                            </div>
                            ${items.map(item => renderSidebarItem(item, isLive, isPast)).join('')}
                        </div>
                    `;
                }

                sidebar.innerHTML = html;

            } catch (error) {
                console.error('Error loading event history:', error);
                sidebar.innerHTML = `
                    <div class="text-center py-8 text-red-400">
                        <span class="material-symbols-outlined text-3xl mb-2">error</span>
                        <p class="text-sm">Error loading events</p>
                    </div>
                `;
            }
        }

        // Render sidebar item
        function renderSidebarItem(item, isLive, isPast) {
            if (item.type === 'event') {
                const event = item.data;
                const isActive = selectedEventId === event.id && viewingArchived;
                return `
                    <div class="event-item rounded-lg p-2 mb-1 ${isActive ? 'active' : ''}"
                         onclick="selectEvent('${event.id}', ${isPast})">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm ${isLive ? 'text-red-500' : 'text-blue-500'}">
                                ${isLive ? 'radio_button_checked' : 'emoji_events'}
                            </span>
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-sm text-gray-800 truncate">${event.title}</div>
                                <div class="text-xs text-gray-500 truncate">${event.organizer_name || 'Golf Society'}</div>
                            </div>
                            ${isLive ? '<span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full">LIVE</span>' : ''}
                        </div>
                    </div>
                `;
            } else {
                const pool = item.data;
                const isActive = selectedPoolId === pool.id && viewingArchived;
                const typeLabels = { skins: 'Skins', nassau: 'Nassau', matchplay: 'Match Play', stableford: 'Stableford' };
                return `
                    <div class="event-item rounded-lg p-2 mb-1 ${isActive ? 'active' : ''}"
                         onclick="selectPool('${pool.id}', ${isPast})">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm ${isLive ? 'text-orange-500' : 'text-gray-500'}">
                                ${isLive ? 'radio_button_checked' : 'sports_score'}
                            </span>
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-sm text-gray-800 truncate">${pool.name}</div>
                                <div class="text-xs text-gray-500">${typeLabels[pool.type] || 'Side Game'} - ${pool.pool_entrants?.length || 0} players</div>
                            </div>
                            ${isLive ? '<span class="text-xs bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full">LIVE</span>' : ''}
                        </div>
                    </div>
                `;
            }
        }

        // Select an event to view
        function selectEvent(eventId, isPast) {
            selectedEventId = eventId;
            selectedPoolId = null;
            viewingArchived = isPast;

            if (isPast) {
                document.getElementById('selectedEventHeader').classList.remove('hidden');
            } else {
                document.getElementById('selectedEventHeader').classList.add('hidden');
            }

            loadAllData();
        }

        // Select a pool to view
        function selectPool(poolId, isPast) {
            selectedPoolId = poolId;
            selectedEventId = null;
            viewingArchived = isPast;

            if (isPast) {
                document.getElementById('selectedEventHeader').classList.remove('hidden');
            } else {
                document.getElementById('selectedEventHeader').classList.add('hidden');
            }

            loadAllData();
        }

        // Show live events (back to default view)
        function showLiveEvents() {
            selectedEventId = null;
            selectedPoolId = null;
            viewingArchived = false;
            document.getElementById('selectedEventHeader').classList.add('hidden');
            loadAllData();
        }

        // Load archived leaderboard (specific event/pool)
        async function loadArchivedLeaderboard() {
            const container = document.getElementById('leaderboardsContainer');

            try {
                let html = '';

                if (selectedEventId) {
                    const event = allEvents.find(e => e.id === selectedEventId);
                    if (event) {
                        const format = event.format || 'stableford';
                        const leaderboard = await getEventLeaderboard(event.id, format);
                        html = renderEventCard(event, leaderboard, true, format);
                    }
                } else if (selectedPoolId) {
                    const pool = allPools.find(p => p.id === selectedPoolId);
                    if (pool) {
                        const leaderboard = await getPoolLeaderboard(pool);
                        html = renderPoolCard(pool, leaderboard, true);
                    }
                }

                if (!html) {
                    html = `
                        <div class="bg-white rounded-lg shadow-sm p-8 text-center">
                            <span class="material-symbols-outlined text-6xl text-gray-300 mb-4">search_off</span>
                            <h2 class="text-xl font-semibold text-gray-700 mb-2">Event Not Found</h2>
                            <p class="text-gray-500">The selected event could not be loaded.</p>
                        </div>
                    `;
                }

                container.innerHTML = html;
                document.getElementById('lastUpdate').textContent = `Viewing archived event`;

                // Restore expanded state
                setTimeout(restoreExpandedState, 50);

            } catch (error) {
                console.error('Error loading archived leaderboard:', error);
                container.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                        <span class="material-symbols-outlined text-4xl text-red-400 mb-2">error</span>
                        <p class="text-red-600">Error loading leaderboard</p>
                        <p class="text-red-400 text-sm mt-1">${error.message}</p>
                    </div>
                `;
            }
        }

        // Load live leaderboards (today's events)
        async function loadLiveLeaderboards() {
            const container = document.getElementById('leaderboardsContainer');
            const today = getToday();

            try {
                // Get today's pools
                const todayPools = allPools.filter(p => p.date_iso === today && p.status !== 'completed');

                // Get today's events
                const todayEvents = allEvents.filter(e => e.event_date === today);

                // NEW: Get today's public casual rounds (live spectatable)
                const { data: publicRounds, error: roundsError } = await supabaseClient
                    .from('scorecards')
                    .select(`
                        group_id, course_name, created_at,
                        player_id, player_name, status
                    `)
                    .eq('is_live_spectatable', true)
                    .eq('status', 'in_progress')
                    .gte('created_at', `${today}T00:00:00`)
                    .lte('created_at', `${today}T23:59:59`)
                    .order('created_at', { ascending: false });

                if (roundsError) {
                    console.warn('Error loading public rounds (non-fatal):', roundsError);
                }

                // Group by group_id to get unique rounds
                const uniqueRounds = [];
                const seenGroups = new Set();
                for (const sc of (publicRounds || [])) {
                    if (!seenGroups.has(sc.group_id)) {
                        seenGroups.add(sc.group_id);
                        uniqueRounds.push(sc);
                    }
                }

                // Update last refresh time
                document.getElementById('lastUpdate').textContent =
                    `Last updated: ${new Date().toLocaleTimeString()}`;

                // No active games today
                if (todayPools.length === 0 && todayEvents.length === 0 && uniqueRounds.length === 0) {
                    container.innerHTML = `
                        <div class="bg-white rounded-lg shadow-sm p-8 text-center">
                            <span class="material-symbols-outlined text-6xl text-gray-300 mb-4">sports_golf</span>
                            <h2 class="text-xl font-semibold text-gray-700 mb-2">No Live Games Right Now</h2>
                            <p class="text-gray-500">Check back when golfers are on the course!</p>
                            <p class="text-gray-400 text-sm mt-4">Today: ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                            <p class="text-green-600 text-sm mt-4">Select an archived event from the right to view past results</p>
                        </div>
                    `;
                    return;
                }

                let html = '';

                // Render Society Events
                for (const event of todayEvents) {
                    const format = event.format || 'stableford';
                    const leaderboard = await getEventLeaderboard(event.id, format);
                    html += renderEventCard(event, leaderboard, false, format);
                }

                // NEW: Render Public Casual Rounds (Live Spectatable)
                for (const round of uniqueRounds) {
                    const leaderboard = await getCasualRoundLeaderboard(round.group_id);
                    html += renderCasualRoundCard(round, leaderboard);
                }

                // Render Public Pools (Side Games)
                for (const pool of todayPools) {
                    const leaderboard = await getPoolLeaderboard(pool);
                    html += renderPoolCard(pool, leaderboard, false);
                }

                container.innerHTML = html;

                // Restore expanded state after DOM update
                setTimeout(restoreExpandedState, 50);

            } catch (error) {
                console.error('Error loading leaderboards:', error);
                container.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                        <span class="material-symbols-outlined text-4xl text-red-400 mb-2">error</span>
                        <p class="text-red-600">Error loading leaderboards</p>
                        <p class="text-red-400 text-sm mt-1">${error.message}</p>
                        <button onclick="loadAllData()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Get event leaderboard
        async function getEventLeaderboard(eventId, format = 'stableford') {
            const { data: scorecards, error } = await supabaseClient
                .from('scorecards')
                .select(`
                    id, player_id, total_gross, total_net, status, created_at,
                    scores (hole_number, gross_score, net_score, stableford_points, par)
                `)
                .eq('event_id', eventId);

            if (error || !scorecards) return [];

            // Get player names
            const playerIds = [...new Set(scorecards.map(s => s.player_id))];
            const { data: profiles } = await supabaseClient
                .from('user_profiles')
                .select('line_user_id, name')
                .in('line_user_id', playerIds);

            const nameMap = {};
            (profiles || []).forEach(p => nameMap[p.line_user_id] = p.name);

            // DEDUPLICATE: Keep only the best scorecard per player (most holes played, or latest if tied)
            const bestByPlayer = new Map();
            for (const sc of scorecards) {
                const existing = bestByPlayer.get(sc.player_id);
                const scHoles = (sc.scores || []).length;
                const existingHoles = existing ? (existing.scores || []).length : 0;

                if (!existing || scHoles > existingHoles ||
                    (scHoles === existingHoles && new Date(sc.created_at) > new Date(existing.created_at))) {
                    bestByPlayer.set(sc.player_id, sc);
                }
            }
            const uniqueScorecards = Array.from(bestByPlayer.values());
            console.log(`[Live] Deduplicated ${scorecards.length} scorecards to ${uniqueScorecards.length} unique players`);

            const leaderboard = uniqueScorecards.map(sc => {
                // Store both gross and par for each hole
                const holeScores = new Array(18).fill(null);
                const holePars = new Array(18).fill(null);
                for (const score of (sc.scores || [])) {
                    if (score.hole_number >= 1 && score.hole_number <= 18) {
                        holeScores[score.hole_number - 1] = score.gross_score;
                        holePars[score.hole_number - 1] = score.par || 4; // Default to par 4 if not set
                    }
                }

                return {
                    player_id: sc.player_id,
                    player_name: nameMap[sc.player_id] || 'Player',
                    total_gross: (sc.scores || []).reduce((sum, s) => sum + (s.gross_score || 0), 0),
                    total_net: (sc.scores || []).reduce((sum, s) => sum + (s.net_score || 0), 0),
                    total_stableford: (sc.scores || []).reduce((sum, s) => sum + (s.stableford_points || 0), 0),
                    front9_stableford: (sc.scores || []).filter(s => s.hole_number <= 9).reduce((sum, s) => sum + (s.stableford_points || 0), 0),
                    back9_stableford: (sc.scores || []).filter(s => s.hole_number > 9).reduce((sum, s) => sum + (s.stableford_points || 0), 0),
                    front9_gross: (sc.scores || []).filter(s => s.hole_number <= 9).reduce((sum, s) => sum + (s.gross_score || 0), 0),
                    back9_gross: (sc.scores || []).filter(s => s.hole_number > 9).reduce((sum, s) => sum + (s.gross_score || 0), 0),
                    holes_played: (sc.scores || []).length,
                    hole_scores: holeScores,
                    hole_pars: holePars,
                    status: sc.status
                };
            });

            // Sort based on format
            if (format === 'stroke_play') {
                // Stroke play: lowest gross wins, but only compare players with same holes played fairly
                // Players with more holes should generally be ahead of those with fewer
                leaderboard.sort((a, b) => {
                    // If same holes played, sort by gross (lower is better)
                    if (a.holes_played === b.holes_played) {
                        return a.total_gross - b.total_gross;
                    }
                    // Players with more holes played come first (they're further along)
                    // Among those, lower gross per hole is better
                    const aAvg = a.holes_played > 0 ? a.total_gross / a.holes_played : 999;
                    const bAvg = b.holes_played > 0 ? b.total_gross / b.holes_played : 999;
                    if (a.holes_played > b.holes_played) return -1;
                    if (b.holes_played > a.holes_played) return 1;
                    return aAvg - bAvg;
                });
            } else {
                // Stableford and others: highest points wins
                leaderboard.sort((a, b) => {
                    // Higher stableford is better
                    if (b.total_stableford !== a.total_stableford) {
                        return b.total_stableford - a.total_stableford;
                    }
                    // Tiebreaker: more holes played
                    return b.holes_played - a.holes_played;
                });
            }

            return leaderboard;
        }

        // Get pool leaderboard
        async function getPoolLeaderboard(pool) {
            const entrantIds = (pool.pool_entrants || []).map(e => e.player_id);
            if (entrantIds.length === 0) return [];

            const poolDate = pool.date_iso;

            const { data: scorecards, error } = await supabaseClient
                .from('scorecards')
                .select(`
                    id, player_id, created_at,
                    scores (hole_number, gross_score, stableford_points, par)
                `)
                .in('player_id', entrantIds)
                .gte('created_at', poolDate + 'T00:00:00')
                .lte('created_at', poolDate + 'T23:59:59');

            if (error || !scorecards) return [];

            const { data: profiles } = await supabaseClient
                .from('user_profiles')
                .select('line_user_id, name')
                .in('line_user_id', entrantIds);

            const nameMap = {};
            (profiles || []).forEach(p => nameMap[p.line_user_id] = p.name);

            // Use scorecard with MOST HOLES per player
            const bestScorecardByPlayer = {};
            for (const sc of scorecards) {
                const holesCount = (sc.scores || []).length;
                if (!bestScorecardByPlayer[sc.player_id] ||
                    holesCount > (bestScorecardByPlayer[sc.player_id].scores || []).length) {
                    bestScorecardByPlayer[sc.player_id] = sc;
                }
            }

            const playerScores = {};
            for (const sc of Object.values(bestScorecardByPlayer)) {
                const holeScores = new Array(18).fill(null);
                const holePars = new Array(18).fill(null);
                for (const score of (sc.scores || [])) {
                    if (score.hole_number >= 1 && score.hole_number <= 18) {
                        holeScores[score.hole_number - 1] = score.gross_score;
                        holePars[score.hole_number - 1] = score.par || 4;
                    }
                }

                playerScores[sc.player_id] = {
                    player_id: sc.player_id,
                    player_name: nameMap[sc.player_id] || 'Player',
                    total_gross: 0,
                    total_stableford: 0,
                    front9_stableford: 0,
                    back9_stableford: 0,
                    holes_played: 0,
                    hole_scores: holeScores,
                    hole_pars: holePars
                };
                for (const score of (sc.scores || [])) {
                    playerScores[sc.player_id].total_gross += score.gross_score || 0;
                    playerScores[sc.player_id].total_stableford += score.stableford_points || 0;
                    playerScores[sc.player_id].holes_played++;
                    if (score.hole_number <= 9) {
                        playerScores[sc.player_id].front9_stableford += score.stableford_points || 0;
                    } else {
                        playerScores[sc.player_id].back9_stableford += score.stableford_points || 0;
                    }
                }
            }

            return Object.values(playerScores).sort((a, b) => b.total_stableford - a.total_stableford);
        }

        // NEW: Get casual round leaderboard (for public live spectatable rounds)
        async function getCasualRoundLeaderboard(groupId) {
            const { data: scorecards, error } = await supabaseClient
                .from('scorecards')
                .select(`
                    id, player_id, player_name, created_at,
                    scores (hole_number, gross_score, net_score, stableford_points, par)
                `)
                .eq('group_id', groupId)
                .eq('is_live_spectatable', true);

            if (error || !scorecards) return [];

            // Build leaderboard same as events
            const leaderboard = scorecards.map(sc => {
                const holeScores = new Array(18).fill(null);
                const holePars = new Array(18).fill(null);
                for (const score of (sc.scores || [])) {
                    if (score.hole_number >= 1 && score.hole_number <= 18) {
                        holeScores[score.hole_number - 1] = score.gross_score;
                        holePars[score.hole_number - 1] = score.par || 4;
                    }
                }

                return {
                    player_id: sc.player_id,
                    player_name: sc.player_name || 'Player',
                    total_gross: (sc.scores || []).reduce((sum, s) => sum + (s.gross_score || 0), 0),
                    total_net: (sc.scores || []).reduce((sum, s) => sum + (s.net_score || 0), 0),
                    total_stableford: (sc.scores || []).reduce((sum, s) => sum + (s.stableford_points || 0), 0),
                    front9_stableford: (sc.scores || []).filter(s => s.hole_number <= 9).reduce((sum, s) => sum + (s.stableford_points || 0), 0),
                    back9_stableford: (sc.scores || []).filter(s => s.hole_number > 9).reduce((sum, s) => sum + (s.stableford_points || 0), 0),
                    front9_gross: (sc.scores || []).filter(s => s.hole_number <= 9).reduce((sum, s) => sum + (s.gross_score || 0), 0),
                    back9_gross: (sc.scores || []).filter(s => s.hole_number > 9).reduce((sum, s) => sum + (s.gross_score || 0), 0),
                    holes_played: (sc.scores || []).length,
                    hole_scores: holeScores,
                    hole_pars: holePars,
                    status: 'in_progress'
                };
            });

            // Sort by stableford points
            leaderboard.sort((a, b) => b.total_stableford - a.total_stableford);
            return leaderboard;
        }

        // NEW: Render casual round card (for public live spectatable rounds)
        function renderCasualRoundCard(round, leaderboard) {
            const courseName = round.course_name || 'Golf Course';
            const startTime = new Date(round.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            return `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-6 border-2 border-red-200">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-red-500 to-pink-500 text-white p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-2xl">visibility</span>
                                <div>
                                    <h3 class="text-lg font-bold">${courseName}</h3>
                                    <p class="text-red-100 text-sm">Casual Round (Live Spectatable)</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="inline-flex items-center gap-1 bg-red-600 px-3 py-1 rounded-full text-xs font-semibold pulse">
                                    <span class="w-2 h-2 bg-white rounded-full"></span>
                                    LIVE
                                </span>
                                <p class="text-red-100 text-xs mt-1">Started ${startTime}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Leaderboard Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="text-left p-3 text-sm font-semibold text-gray-600">Pos</th>
                                    <th class="text-left p-3 text-sm font-semibold text-gray-600">Player</th>
                                    <th class="text-center p-3 text-sm font-semibold text-gray-600">Holes</th>
                                    <th class="text-center p-3 text-sm font-semibold text-gray-600">Pts</th>
                                    <th class="text-center p-3 text-sm font-semibold text-gray-600">Gross</th>
                                    <th class="text-center p-3 text-sm font-semibold text-gray-600">F9</th>
                                    <th class="text-center p-3 text-sm font-semibold text-gray-600">B9</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${leaderboard.length > 0 ? leaderboard.map((player, idx) => `
                                    <tr class="border-b hover:bg-gray-50 ${idx === 0 ? 'winner-row' : ''}" onclick="togglePlayerDetails('${player.player_id}')">
                                        <td class="p-3">
                                            <span class="font-bold text-gray-700">${idx + 1}</span>
                                            ${idx === 0 ? '<span class="ml-1">üèÜ</span>' : ''}
                                        </td>
                                        <td class="p-3">
                                            <div class="flex items-center gap-2">
                                                <span class="player-name font-medium text-gray-900">${player.player_name}</span>
                                                <span class="material-symbols-outlined expand-icon text-gray-400 text-sm" id="icon-${player.player_id}">expand_more</span>
                                            </div>
                                        </td>
                                        <td class="text-center p-3 text-gray-600">${player.holes_played}/18</td>
                                        <td class="text-center p-3 font-semibold text-green-600">${player.total_stableford}</td>
                                        <td class="text-center p-3 text-gray-900">${player.total_gross}</td>
                                        <td class="text-center p-3 text-gray-600">${player.front9_stableford}</td>
                                        <td class="text-center p-3 text-gray-600">${player.back9_stableford}</td>
                                    </tr>
                                    <!-- Hole-by-hole details row -->
                                    <tr class="hole-details bg-gray-50" id="details-${player.player_id}">
                                        <td colspan="7" class="p-4">
                                            <div class="text-xs font-semibold text-gray-600 mb-2">Hole-by-Hole</div>
                                            <div class="hole-grid">
                                                ${[...Array(18)].map((_, i) => `
                                                    <div class="hole-cell hole-header">H${i + 1}</div>
                                                `).join('')}
                                                ${player.hole_scores.map((score, i) => {
                                                    if (score === null) return '<div class="hole-cell hole-score">-</div>';
                                                    const par = player.hole_pars[i] || 4;
                                                    const diff = score - par;
                                                    let cssClass = 'hole-score score-par';
                                                    if (diff <= -2) cssClass = 'hole-score score-eagle';
                                                    else if (diff === -1) cssClass = 'hole-score score-birdie';
                                                    else if (diff === 1) cssClass = 'hole-score score-bogey';
                                                    else if (diff >= 2) cssClass = 'hole-score score-double';
                                                    return `<div class="${cssClass}">${score}</div>`;
                                                }).join('')}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('') : `
                                    <tr>
                                        <td colspan="7" class="text-center py-6 text-gray-400">
                                            <span class="material-symbols-outlined text-4xl">hourglass_empty</span>
                                            <p class="mt-2">Waiting for scores...</p>
                                        </td>
                                    </tr>
                                `}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Toggle player details expansion
        function togglePlayerDetails(playerId) {
            const detailRow = document.getElementById('details-' + playerId);
            const icon = document.getElementById('icon-' + playerId);
            if (detailRow) {
                const isExpanded = detailRow.classList.toggle('show');
                if (icon) icon.classList.toggle('expanded');
                if (isExpanded) {
                    expandedPlayers.add(playerId);
                } else {
                    expandedPlayers.delete(playerId);
                }
            }
        }

        // Restore expanded state after DOM update
        function restoreExpandedState() {
            expandedPlayers.forEach(playerId => {
                const detailRow = document.getElementById('details-' + playerId);
                const icon = document.getElementById('icon-' + playerId);
                if (detailRow) {
                    detailRow.classList.add('show');
                    if (icon) icon.classList.add('expanded');
                }
            });
        }

        // Event delegation for player clicks
        document.addEventListener('click', function(e) {
            const playerName = e.target.closest('.player-name');
            if (playerName) {
                const playerId = playerName.getAttribute('data-player-id');
                if (playerId) {
                    togglePlayerDetails(playerId);
                }
            }
        });

        // Get score class based on score vs par
        function getScoreClass(score, par) {
            if (score === null || par === null) return 'hole-score';
            const diff = score - par;
            if (diff <= -2) return 'hole-score score-eagle';   // Eagle or better (double circle)
            if (diff === -1) return 'hole-score score-birdie'; // Birdie (circle)
            if (diff === 0) return 'hole-score score-par';     // Par (normal)
            if (diff === 1) return 'hole-score score-bogey';   // Bogey (red square)
            return 'hole-score score-double';                   // Double bogey+ (dark red square)
        }

        // Render hole-by-hole details row
        function renderHoleDetails(entry, colspan, playerId) {
            const holes = entry.hole_scores || [];
            const pars = entry.hole_pars || new Array(18).fill(4);
            const front9 = holes.slice(0, 9);
            const back9 = holes.slice(9, 18);
            const front9Pars = pars.slice(0, 9);
            const back9Pars = pars.slice(9, 18);
            const front9Total = front9.reduce((sum, s) => sum + (s || 0), 0);
            const back9Total = back9.reduce((sum, s) => sum + (s || 0), 0);

            return `
                <tr id="details-${playerId}" class="hole-details bg-gray-50">
                    <td colspan="${colspan}" class="p-3">
                        <div class="text-xs font-semibold text-gray-600 mb-2">
                            Hole-by-Hole (Gross)
                            <span class="ml-4 font-normal">
                                <span class="inline-block w-3 h-3 rounded-full bg-blue-500 mr-1"></span>Birdie
                                <span class="inline-block w-3 h-3 rounded-full bg-blue-600 ml-2 mr-1" style="box-shadow: 0 0 0 2px #1d4ed8;"></span>Eagle
                                <span class="inline-block w-3 h-3 bg-red-500 ml-2 mr-1"></span>Bogey
                                <span class="inline-block w-3 h-3 bg-red-800 ml-2 mr-1"></span>Double+
                            </span>
                        </div>
                        <div class="mb-2">
                            <div class="hole-grid mb-1">
                                ${[1,2,3,4,5,6,7,8,9].map(h => `<div class="hole-cell hole-header">${h}</div>`).join('')}
                            </div>
                            <div class="hole-grid mb-1">
                                ${front9Pars.map(p => `<div class="hole-cell text-gray-400" style="font-size:9px;">P${p || 4}</div>`).join('')}
                            </div>
                            <div class="hole-grid">
                                ${front9.map((s, i) => `<div class="hole-cell ${getScoreClass(s, front9Pars[i])}">${s !== null ? s : '-'}</div>`).join('')}
                            </div>
                            <div class="text-right text-xs mt-1 text-gray-600">Out: <span class="font-bold">${front9Total || '-'}</span></div>
                        </div>
                        <div>
                            <div class="hole-grid mb-1">
                                ${[10,11,12,13,14,15,16,17,18].map(h => `<div class="hole-cell hole-header">${h}</div>`).join('')}
                            </div>
                            <div class="hole-grid mb-1">
                                ${back9Pars.map(p => `<div class="hole-cell text-gray-400" style="font-size:9px;">P${p || 4}</div>`).join('')}
                            </div>
                            <div class="hole-grid">
                                ${back9.map((s, i) => `<div class="hole-cell ${getScoreClass(s, back9Pars[i])}">${s !== null ? s : '-'}</div>`).join('')}
                            </div>
                            <div class="text-right text-xs mt-1 text-gray-600">In: <span class="font-bold">${back9Total || '-'}</span> | Total: <span class="font-bold">${entry.total_gross || '-'}</span></div>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Render event card
        function renderEventCard(event, leaderboard, isArchived, format = 'stableford') {
            const societyName = event.organizer_name || 'Golf Event';
            const dateDisplay = formatDate(event.event_date);
            const formatLabels = {
                'stroke_play': 'Stroke Play',
                'stableford': 'Stableford',
                'match_play': 'Match Play',
                'scramble': 'Scramble',
                'best_ball': 'Best Ball'
            };
            const formatLabel = formatLabels[format] || 'Stableford';

            return `
                <div class="bg-white rounded-lg shadow-sm mb-4 overflow-hidden">
                    <div class="bg-gradient-to-r ${isArchived ? 'from-gray-600 to-gray-700' : 'from-blue-600 to-blue-700'} text-white p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="flex items-center gap-2">
                                    <h2 class="font-bold text-lg">${event.title}</h2>
                                    ${isArchived ? `<span class="text-xs bg-amber-500 text-white px-2 py-0.5 rounded-full">ARCHIVED</span>` : '<span class="text-xs bg-red-500 text-white px-2 py-0.5 rounded-full live-badge">LIVE</span>'}
                                </div>
                                <p class="${isArchived ? 'text-gray-300' : 'text-blue-200'} text-sm">${societyName} - ${event.course_name || 'Golf Course'}</p>
                                <p class="${isArchived ? 'text-gray-400' : 'text-blue-300'} text-xs mt-1">${dateDisplay} ‚Ä¢ ${formatLabel}</p>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center gap-1 text-sm">
                                    <span class="material-symbols-outlined text-green-300">group</span>
                                    <span>${leaderboard.length} players</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    ${renderLeaderboardTable(leaderboard, format)}
                </div>
            `;
        }

        // Render pool card
        function renderPoolCard(pool, leaderboard, isArchived) {
            const typeConfig = {
                skins: { icon: 'monetization_on', color: 'orange', label: 'Skins' },
                nassau: { icon: 'emoji_events', color: 'blue', label: 'Nassau' },
                matchplay: { icon: 'sports_score', color: 'green', label: 'Match Play' },
                stableford: { icon: 'star', color: 'yellow', label: 'Stableford' }
            };
            const config = typeConfig[pool.type] || typeConfig.stableford;
            const dateDisplay = formatDate(pool.date_iso);

            return `
                <div class="bg-white rounded-lg shadow-sm mb-4 overflow-hidden">
                    <div class="bg-gradient-to-r ${isArchived ? 'from-gray-600 to-gray-700' : `from-${config.color}-500 to-${config.color}-600`} text-white p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined">${config.icon}</span>
                                <div>
                                    <div class="flex items-center gap-2">
                                        <h2 class="font-bold">${pool.name}</h2>
                                        ${isArchived ? `<span class="text-xs bg-amber-500 text-white px-2 py-0.5 rounded-full">ARCHIVED</span>` : '<span class="text-xs bg-red-500 text-white px-2 py-0.5 rounded-full live-badge">LIVE</span>'}
                                    </div>
                                    <p class="${isArchived ? 'text-gray-300' : `text-${config.color}-200`} text-sm">${config.label} Competition</p>
                                    <p class="${isArchived ? 'text-gray-400' : `text-${config.color}-300`} text-xs">${dateDisplay}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-1 text-sm">
                                <span class="material-symbols-outlined">group</span>
                                <span>${pool.pool_entrants?.length || 0}</span>
                            </div>
                        </div>
                    </div>
                    ${pool.type === 'nassau' ? renderNassauTable(leaderboard) : renderLeaderboardTable(leaderboard, pool.type)}
                </div>
            `;
        }

        // Render standard leaderboard table
        function renderLeaderboardTable(leaderboard, format) {
            if (leaderboard.length === 0) {
                return `
                    <div class="p-6 text-center text-gray-500">
                        <span class="material-symbols-outlined text-3xl mb-2">hourglass_empty</span>
                        <p>No scores recorded</p>
                    </div>
                `;
            }

            const isStrokePlay = format === 'stroke_play';

            const rows = leaderboard.map((entry, i) => {
                const isLeader = i === 0;
                const playerId = entry.player_id || ('player-' + i);

                if (isStrokePlay) {
                    // Stroke Play: Show gross score
                    return `
                        <tr class="${isLeader ? 'winner-row font-bold' : 'border-b border-gray-100'}">
                            <td class="py-3 px-4 text-center">${i + 1}</td>
                            <td class="py-3 px-4">
                                <span class="player-name flex items-center gap-1" data-player-id="${playerId}" style="cursor:pointer;">
                                    <span class="material-symbols-outlined text-sm expand-icon" id="icon-${playerId}">expand_more</span>
                                    ${entry.player_name}
                                    ${isLeader ? '<span class="ml-2">üèÜ</span>' : ''}
                                </span>
                            </td>
                            <td class="py-3 px-4 text-center">${entry.holes_played}</td>
                            <td class="py-3 px-4 text-center font-bold text-blue-600">${entry.total_gross}</td>
                        </tr>
                        ${renderHoleDetails(entry, 4, playerId)}
                    `;
                } else {
                    // Stableford: Show points
                    return `
                        <tr class="${isLeader ? 'winner-row font-bold' : 'border-b border-gray-100'}">
                            <td class="py-3 px-4 text-center">${i + 1}</td>
                            <td class="py-3 px-4">
                                <span class="player-name flex items-center gap-1" data-player-id="${playerId}" style="cursor:pointer;">
                                    <span class="material-symbols-outlined text-sm expand-icon" id="icon-${playerId}">expand_more</span>
                                    ${entry.player_name}
                                    ${isLeader ? '<span class="ml-2">üèÜ</span>' : ''}
                                </span>
                            </td>
                            <td class="py-3 px-4 text-center">${entry.holes_played}</td>
                            <td class="py-3 px-4 text-center font-bold text-green-600">${entry.total_stableford}</td>
                        </tr>
                        ${renderHoleDetails(entry, 4, playerId)}
                    `;
                }
            }).join('');

            return `
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 border-b">
                        <tr class="text-gray-600">
                            <th class="py-2 px-4 text-center">Pos</th>
                            <th class="py-2 px-4 text-left">Player</th>
                            <th class="py-2 px-4 text-center">Thru</th>
                            <th class="py-2 px-4 text-center">${isStrokePlay ? 'Gross' : 'Pts'}</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        // Render Nassau-specific table
        function renderNassauTable(leaderboard) {
            if (leaderboard.length === 0) {
                return `
                    <div class="p-6 text-center text-gray-500">
                        <span class="material-symbols-outlined text-3xl mb-2">hourglass_empty</span>
                        <p>No scores recorded</p>
                    </div>
                `;
            }

            const f9Winner = leaderboard.reduce((max, e) => e.front9_stableford > (max?.front9_stableford || 0) ? e : max, null);
            const b9Winner = leaderboard.reduce((max, e) => e.back9_stableford > (max?.back9_stableford || 0) ? e : max, null);
            const totalWinner = leaderboard[0];

            const rows = leaderboard.map((entry, i) => {
                const wonF9 = entry.player_name === f9Winner?.player_name && entry.front9_stableford > 0;
                const wonB9 = entry.player_name === b9Winner?.player_name && entry.back9_stableford > 0;
                const wonTotal = i === 0;
                const playerId = entry.player_id || ('nassau-player-' + i);

                return `
                    <tr class="${wonTotal ? 'winner-row' : 'border-b border-gray-100'}">
                        <td class="py-3 px-3 text-center font-semibold">${i + 1}</td>
                        <td class="py-3 px-3">
                            <span class="player-name flex items-center gap-1" data-player-id="${playerId}" style="cursor:pointer;">
                                <span class="material-symbols-outlined text-sm expand-icon" id="icon-${playerId}">expand_more</span>
                                ${entry.player_name}
                            </span>
                        </td>
                        <td class="py-3 px-3 text-center ${wonF9 ? 'bg-blue-200 font-bold' : ''}">${entry.front9_stableford || '-'}</td>
                        <td class="py-3 px-3 text-center ${wonB9 ? 'bg-green-200 font-bold' : ''}">${entry.back9_stableford || '-'}</td>
                        <td class="py-3 px-3 text-center ${wonTotal ? 'bg-yellow-200 font-bold' : ''}">${entry.total_stableford || '-'}</td>
                        <td class="py-3 px-3 text-center">${entry.holes_played}</td>
                    </tr>
                    ${renderHoleDetails(entry, 6, playerId)}
                `;
            }).join('');

            return `
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 border-b">
                        <tr class="text-gray-600">
                            <th class="py-2 px-3">#</th>
                            <th class="py-2 px-3 text-left">Player</th>
                            <th class="py-2 px-3 text-center bg-blue-50">F9</th>
                            <th class="py-2 px-3 text-center bg-green-50">B9</th>
                            <th class="py-2 px-3 text-center bg-yellow-50">Total</th>
                            <th class="py-2 px-3 text-center">Thru</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
                <div class="px-4 py-2 bg-gray-50 text-xs text-gray-600">
                    Tap player name to see hole-by-hole scores
                </div>
            `;
        }

        // Initial load
        loadAllData();

        // Auto-refresh every 30 seconds for live events (only when viewing live)
        // Uses setTimeout chain instead of setInterval to prevent overlap
        function scheduleNextRefresh() {
            // Back off on consecutive errors: 30s, 60s, 120s, max 120s
            const delay = Math.min(BASE_REFRESH_MS * Math.pow(2, consecutiveErrors), 120000);
            refreshInterval = setTimeout(async () => {
                if (!viewingArchived && !document.hidden) {
                    await loadAllData();
                }
                scheduleNextRefresh();
            }, delay);
        }
        scheduleNextRefresh();

        // Pause refresh when tab is hidden, resume when visible
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && !viewingArchived) {
                loadAllData();
            }
        });
    </script>
</body>
</html>
