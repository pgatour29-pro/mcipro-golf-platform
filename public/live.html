<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Leaderboards - MyCaddiPro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .winner-row { background: linear-gradient(90deg, #fef3c7 0%, #fde68a 50%, #fef3c7 100%); }
        .player-name { cursor: pointer; }
        .player-name:hover { text-decoration: underline; color: #059669; }
        .expand-icon { transition: transform 0.2s; }
        .expand-icon.expanded { transform: rotate(180deg); }
        .hole-details { display: none; }
        .hole-details.show { display: table-row; }
        .hole-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 2px; }
        .hole-cell { text-align: center; padding: 4px 2px; font-size: 11px; }
        .hole-header { background: #f3f4f6; font-weight: 600; }
        .hole-score { background: #fff; border: 1px solid #e5e7eb; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-green-600 to-green-700 text-white shadow-lg">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-3xl">sports_golf</span>
                    <div>
                        <h1 class="text-xl font-bold">MyCaddiPro</h1>
                        <p class="text-green-200 text-sm">Live Leaderboards</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 text-sm">
                    <span class="material-symbols-outlined text-red-300 pulse">radio_button_checked</span>
                    <span>LIVE</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-6">
        <!-- Status Bar -->
        <div class="bg-white rounded-lg shadow-sm p-3 mb-4 flex items-center justify-between">
            <div class="flex items-center gap-2 text-gray-600">
                <span class="material-symbols-outlined">schedule</span>
                <span id="lastUpdate">Loading...</span>
            </div>
            <button onclick="loadLeaderboards()" class="flex items-center gap-1 text-green-600 hover:text-green-700">
                <span class="material-symbols-outlined">refresh</span>
                Refresh
            </button>
        </div>

        <!-- Leaderboards Container -->
        <div id="leaderboardsContainer">
            <div class="text-center py-12 text-gray-500">
                <span class="material-symbols-outlined text-5xl mb-4">hourglass_empty</span>
                <p class="text-lg">Loading live leaderboards...</p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="text-center py-6 text-gray-500 text-sm">
        <p>Auto-refreshes every 5 seconds</p>
        <p class="mt-1">Powered by MyCaddiPro</p>
    </footer>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://pyeeplwsnupmhgbguwqs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZWVwbHdzbnVwbWhnYmd1d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDM2NjksImV4cCI6MjA3NTQxOTY2OX0.KVQ6WvDKz9s77lxn3AhSA_YTMCN6rsht9kDkMIDhngk';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Load leaderboards
        async function loadLeaderboards() {
            const container = document.getElementById('leaderboardsContainer');
            const today = new Date().toISOString().split('T')[0];

            try {
                // Get all active pools from today
                const { data: pools, error: poolError } = await supabase
                    .from('side_game_pools')
                    .select(`
                        id, name, type, course_id, date_iso, config, created_at,
                        pool_entrants (player_id)
                    `)
                    .eq('date_iso', today)
                    .eq('status', 'active')
                    .eq('is_public', true);

                if (poolError) throw poolError;

                // Also get society events happening today
                const { data: events, error: eventError } = await supabase
                    .from('society_events')
                    .select('id, title, event_date, course_name, organizer_name')
                    .eq('event_date', today);

                if (eventError) throw eventError;

                // Update last refresh time
                document.getElementById('lastUpdate').textContent =
                    `Last updated: ${new Date().toLocaleTimeString()}`;

                // No active games
                if ((!pools || pools.length === 0) && (!events || events.length === 0)) {
                    container.innerHTML = `
                        <div class="bg-white rounded-lg shadow-sm p-8 text-center">
                            <span class="material-symbols-outlined text-6xl text-gray-300 mb-4">sports_golf</span>
                            <h2 class="text-xl font-semibold text-gray-700 mb-2">No Live Games Right Now</h2>
                            <p class="text-gray-500">Check back when golfers are on the course!</p>
                            <p class="text-gray-400 text-sm mt-4">Today: ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                        </div>
                    `;
                    return;
                }

                let html = '';

                // Render Society Events
                if (events && events.length > 0) {
                    for (const event of events) {
                        const leaderboard = await getEventLeaderboard(event.id);
                        html += renderEventCard(event, leaderboard);
                    }
                }

                // Render Public Pools (Side Games)
                if (pools && pools.length > 0) {
                    for (const pool of pools) {
                        const leaderboard = await getPoolLeaderboard(pool);
                        html += renderPoolCard(pool, leaderboard);
                    }
                }

                container.innerHTML = html;

            } catch (error) {
                console.error('Error loading leaderboards:', error);
                container.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                        <span class="material-symbols-outlined text-4xl text-red-400 mb-2">error</span>
                        <p class="text-red-600">Error loading leaderboards</p>
                        <p class="text-red-400 text-sm mt-1">${error.message}</p>
                        <button onclick="loadLeaderboards()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Get event leaderboard
        async function getEventLeaderboard(eventId) {
            const { data: scorecards, error } = await supabase
                .from('scorecards')
                .select(`
                    id, player_id, total_gross, total_net, status, created_at,
                    scores (hole_number, gross_score, net_score, stableford_points)
                `)
                .eq('event_id', eventId)
                .order('total_gross', { ascending: true });

            if (error || !scorecards) return [];

            // Get player names
            const playerIds = [...new Set(scorecards.map(s => s.player_id))];
            const { data: profiles } = await supabase
                .from('user_profiles')
                .select('line_user_id, name')
                .in('line_user_id', playerIds);

            const nameMap = {};
            (profiles || []).forEach(p => nameMap[p.line_user_id] = p.name);

            return scorecards.map(sc => ({
                player_name: nameMap[sc.player_id] || 'Player',
                total_gross: sc.total_gross || 0,
                total_stableford: (sc.scores || []).reduce((sum, s) => sum + (s.stableford_points || 0), 0),
                holes_played: (sc.scores || []).length,
                status: sc.status
            })).sort((a, b) => b.total_stableford - a.total_stableford);
        }

        // Get pool leaderboard
        async function getPoolLeaderboard(pool) {
            const entrantIds = pool.pool_entrants.map(e => e.player_id);
            if (entrantIds.length === 0) return [];

            const today = new Date().toISOString().split('T')[0];

            // Get scorecards for today
            const { data: scorecards, error } = await supabase
                .from('scorecards')
                .select(`
                    id, player_id, created_at,
                    scores (hole_number, gross_score, stableford_points)
                `)
                .in('player_id', entrantIds)
                .gte('created_at', today + 'T00:00:00')
                .lte('created_at', today + 'T23:59:59');

            if (error || !scorecards) return [];

            // Get player names
            const { data: profiles } = await supabase
                .from('user_profiles')
                .select('line_user_id, name')
                .in('line_user_id', entrantIds);

            const nameMap = {};
            (profiles || []).forEach(p => nameMap[p.line_user_id] = p.name);

            // Use scorecard with MOST HOLES per player (the active round, not abandoned ones)
            const bestScorecardByPlayer = {};
            for (const sc of scorecards) {
                const holesCount = (sc.scores || []).length;
                if (!bestScorecardByPlayer[sc.player_id] ||
                    holesCount > (bestScorecardByPlayer[sc.player_id].scores || []).length) {
                    bestScorecardByPlayer[sc.player_id] = sc;
                }
            }

            // Debug: log what we're using
            console.log('[Live] Scorecards selected:', Object.entries(bestScorecardByPlayer).map(([pid, sc]) => ({
                player: nameMap[pid],
                scorecard_id: sc.id,
                holes: (sc.scores || []).length,
                stableford: (sc.scores || []).reduce((sum, s) => sum + (s.stableford_points || 0), 0)
            })));

            // Aggregate scores by player (using only their best scorecard)
            const playerScores = {};
            for (const sc of Object.values(bestScorecardByPlayer)) {
                // Build hole-by-hole array (1-18)
                const holeScores = new Array(18).fill(null);
                for (const score of (sc.scores || [])) {
                    if (score.hole_number >= 1 && score.hole_number <= 18) {
                        holeScores[score.hole_number - 1] = score.gross_score;
                    }
                }

                playerScores[sc.player_id] = {
                    player_id: sc.player_id,
                    player_name: nameMap[sc.player_id] || 'Player',
                    total_gross: 0,
                    total_stableford: 0,
                    front9_stableford: 0,
                    back9_stableford: 0,
                    holes_played: 0,
                    hole_scores: holeScores
                };
                for (const score of (sc.scores || [])) {
                    playerScores[sc.player_id].total_gross += score.gross_score || 0;
                    playerScores[sc.player_id].total_stableford += score.stableford_points || 0;
                    playerScores[sc.player_id].holes_played++;
                    if (score.hole_number <= 9) {
                        playerScores[sc.player_id].front9_stableford += score.stableford_points || 0;
                    } else {
                        playerScores[sc.player_id].back9_stableford += score.stableford_points || 0;
                    }
                }
            }

            return Object.values(playerScores).sort((a, b) => b.total_stableford - a.total_stableford);
        }

        // Toggle player details expansion
        function togglePlayerDetails(playerId) {
            console.log('[Live] Toggle clicked for:', playerId);
            const detailRow = document.getElementById('details-' + playerId);
            const icon = document.getElementById('icon-' + playerId);
            console.log('[Live] Found elements:', { detailRow: !!detailRow, icon: !!icon });
            if (detailRow) {
                detailRow.classList.toggle('show');
                if (icon) icon.classList.toggle('expanded');
            }
        }

        // Event delegation for player clicks (more reliable than inline onclick)
        document.addEventListener('click', function(e) {
            const playerName = e.target.closest('.player-name');
            if (playerName) {
                const playerId = playerName.getAttribute('data-player-id');
                if (playerId) {
                    togglePlayerDetails(playerId);
                }
            }
        });

        // Render hole-by-hole details row
        function renderHoleDetails(entry, colspan, playerId) {
            const holes = entry.hole_scores || [];
            const front9 = holes.slice(0, 9);
            const back9 = holes.slice(9, 18);
            const front9Total = front9.reduce((sum, s) => sum + (s || 0), 0);
            const back9Total = back9.reduce((sum, s) => sum + (s || 0), 0);

            return `
                <tr id="details-${playerId}" class="hole-details bg-gray-50">
                    <td colspan="${colspan}" class="p-3">
                        <div class="text-xs font-semibold text-gray-600 mb-2">Hole-by-Hole (Gross)</div>
                        <!-- Front 9 -->
                        <div class="mb-2">
                            <div class="hole-grid mb-1">
                                ${[1,2,3,4,5,6,7,8,9].map(h => `<div class="hole-cell hole-header">${h}</div>`).join('')}
                            </div>
                            <div class="hole-grid">
                                ${front9.map(s => `<div class="hole-cell hole-score">${s !== null ? s : '-'}</div>`).join('')}
                            </div>
                            <div class="text-right text-xs mt-1 text-gray-600">Out: <span class="font-bold">${front9Total || '-'}</span></div>
                        </div>
                        <!-- Back 9 -->
                        <div>
                            <div class="hole-grid mb-1">
                                ${[10,11,12,13,14,15,16,17,18].map(h => `<div class="hole-cell hole-header">${h}</div>`).join('')}
                            </div>
                            <div class="hole-grid">
                                ${back9.map(s => `<div class="hole-cell hole-score">${s !== null ? s : '-'}</div>`).join('')}
                            </div>
                            <div class="text-right text-xs mt-1 text-gray-600">In: <span class="font-bold">${back9Total || '-'}</span> | Total: <span class="font-bold">${entry.total_gross || '-'}</span></div>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Render event card
        function renderEventCard(event, leaderboard) {
            const societyName = event.organizer_name || 'Golf Event';
            return `
                <div class="bg-white rounded-lg shadow-sm mb-4 overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="font-bold text-lg">${event.title}</h2>
                                <p class="text-blue-200 text-sm">${societyName} - ${event.course_name || 'Golf Course'}</p>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center gap-1 text-sm">
                                    <span class="material-symbols-outlined text-green-300">group</span>
                                    <span>${leaderboard.length} players</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    ${renderLeaderboardTable(leaderboard, 'stableford')}
                </div>
            `;
        }

        // Render pool card
        function renderPoolCard(pool, leaderboard) {
            const typeConfig = {
                skins: { icon: 'monetization_on', color: 'orange', label: 'Skins' },
                nassau: { icon: 'emoji_events', color: 'blue', label: 'Nassau' },
                matchplay: { icon: 'sports_score', color: 'green', label: 'Match Play' },
                stableford: { icon: 'star', color: 'yellow', label: 'Stableford' }
            };
            const config = typeConfig[pool.type] || typeConfig.stableford;

            return `
                <div class="bg-white rounded-lg shadow-sm mb-4 overflow-hidden">
                    <div class="bg-gradient-to-r from-${config.color}-500 to-${config.color}-600 text-white p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined">${config.icon}</span>
                                <div>
                                    <h2 class="font-bold">${pool.name}</h2>
                                    <p class="text-${config.color}-200 text-sm">${config.label} Competition</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-1 text-sm">
                                <span class="material-symbols-outlined">group</span>
                                <span>${pool.pool_entrants.length}</span>
                            </div>
                        </div>
                    </div>
                    ${pool.type === 'nassau' ? renderNassauTable(leaderboard) : renderLeaderboardTable(leaderboard, pool.type)}
                </div>
            `;
        }

        // Render standard leaderboard table
        function renderLeaderboardTable(leaderboard, type) {
            if (leaderboard.length === 0) {
                return `
                    <div class="p-6 text-center text-gray-500">
                        <span class="material-symbols-outlined text-3xl mb-2">hourglass_empty</span>
                        <p>Waiting for scores...</p>
                    </div>
                `;
            }

            const rows = leaderboard.map((entry, i) => {
                const isLeader = i === 0;
                const playerId = entry.player_id || ('player-' + i);
                return `
                    <tr class="${isLeader ? 'winner-row font-bold' : 'border-b border-gray-100'}">
                        <td class="py-3 px-4 text-center">${i + 1}</td>
                        <td class="py-3 px-4">
                            <span class="player-name flex items-center gap-1" data-player-id="${playerId}" style="cursor:pointer;">
                                <span class="material-symbols-outlined text-sm expand-icon" id="icon-${playerId}">expand_more</span>
                                ${entry.player_name}
                                ${isLeader ? '<span class="ml-2">üèÜ</span>' : ''}
                            </span>
                        </td>
                        <td class="py-3 px-4 text-center">${entry.holes_played}</td>
                        <td class="py-3 px-4 text-center font-bold text-green-600">${entry.total_stableford}</td>
                    </tr>
                    ${renderHoleDetails(entry, 4, playerId)}
                `;
            }).join('');

            return `
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 border-b">
                        <tr class="text-gray-600">
                            <th class="py-2 px-4 text-center">Pos</th>
                            <th class="py-2 px-4 text-left">Player</th>
                            <th class="py-2 px-4 text-center">Thru</th>
                            <th class="py-2 px-4 text-center">Pts</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        // Render Nassau-specific table
        function renderNassauTable(leaderboard) {
            if (leaderboard.length === 0) {
                return `
                    <div class="p-6 text-center text-gray-500">
                        <span class="material-symbols-outlined text-3xl mb-2">hourglass_empty</span>
                        <p>Waiting for scores...</p>
                    </div>
                `;
            }

            // Find winners for each segment
            const f9Winner = leaderboard.reduce((max, e) => e.front9_stableford > (max?.front9_stableford || 0) ? e : max, null);
            const b9Winner = leaderboard.reduce((max, e) => e.back9_stableford > (max?.back9_stableford || 0) ? e : max, null);
            const totalWinner = leaderboard[0]; // Already sorted by total

            const rows = leaderboard.map((entry, i) => {
                const wonF9 = entry.player_name === f9Winner?.player_name && entry.front9_stableford > 0;
                const wonB9 = entry.player_name === b9Winner?.player_name && entry.back9_stableford > 0;
                const wonTotal = i === 0;
                const playerId = entry.player_id || ('nassau-player-' + i);

                return `
                    <tr class="${wonTotal ? 'winner-row' : 'border-b border-gray-100'}">
                        <td class="py-3 px-3 text-center font-semibold">${i + 1}</td>
                        <td class="py-3 px-3">
                            <span class="player-name flex items-center gap-1" data-player-id="${playerId}" style="cursor:pointer;">
                                <span class="material-symbols-outlined text-sm expand-icon" id="icon-${playerId}">expand_more</span>
                                ${entry.player_name}
                            </span>
                        </td>
                        <td class="py-3 px-3 text-center ${wonF9 ? 'bg-blue-200 font-bold' : ''}">${entry.front9_stableford || '-'}</td>
                        <td class="py-3 px-3 text-center ${wonB9 ? 'bg-green-200 font-bold' : ''}">${entry.back9_stableford || '-'}</td>
                        <td class="py-3 px-3 text-center ${wonTotal ? 'bg-yellow-200 font-bold' : ''}">${entry.total_stableford || '-'}</td>
                        <td class="py-3 px-3 text-center">${entry.holes_played}</td>
                    </tr>
                    ${renderHoleDetails(entry, 6, playerId)}
                `;
            }).join('');

            return `
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 border-b">
                        <tr class="text-gray-600">
                            <th class="py-2 px-3">#</th>
                            <th class="py-2 px-3 text-left">Player</th>
                            <th class="py-2 px-3 text-center bg-blue-50">F9</th>
                            <th class="py-2 px-3 text-center bg-green-50">B9</th>
                            <th class="py-2 px-3 text-center bg-yellow-50">Total</th>
                            <th class="py-2 px-3 text-center">Thru</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
                <div class="px-4 py-2 bg-gray-50 text-xs text-gray-600">
                    Tap player name to see hole-by-hole scores
                </div>
            `;
        }

        // Initial load
        loadLeaderboards();

        // Auto-refresh every 5 seconds for near real-time updates
        setInterval(loadLeaderboards, 5000);
    </script>
</body>
</html>
