<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MyCaddy Pro â€¢ GM Dashboard (Embedded Tee Sheet)</title>
  <style>
    :root{--bg:#f4f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;--brand:#2563eb;--border:rgba(0,0,0,.12);--pill:#dcfce7;--pillink:#064e3b}
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    a{color:var(--brand);text-decoration:none}
    .topbar{height:56px;display:flex;align-items:center;gap:12px;padding:0 16px;background:#fff;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50}
    .brand{font-weight:800;color:#0f172a}
    .tabs{display:flex;gap:6px;padding:8px 12px;background:#fff;border-bottom:1px solid var(--border);position:sticky;top:56px;z-index:40}
    .tab{padding:8px 12px;border-radius:10px;cursor:pointer}
    .tab.active{background:#eef2ff;color:#1d4ed8}
    .page{max-width:1280px;margin:14px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:12px}

    /* ========== Tee Sheet ========== */
    #abcv11 h1{margin:0;font-size:18px}
    #abcv11 .sub{color:var(--muted);font-size:12px;margin:4px 0 10px}
    #abcv11 label{font-size:12px;color:var(--muted)}
    #abcv11 input,#abcv11 select,#abcv11 textarea{border:1px solid var(--border);border-radius:10px;padding:7px 9px;background:#fff;color:var(--ink);outline:none}
    #abcv11 button{border:1px solid var(--border);background:#f3f4f6;border-radius:10px;padding:8px 10px;cursor:pointer}
    #abcv11 button:hover{background:#eef2ff}
    #abcv11 .btn-primary{background:var(--brand);color:#fff;border-color:#1d4ed8}
    #abcv11 .iconbtn{width:34px;height:34px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center}

    #abcv11 .legend{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted);margin-top:6px}
    #abcv11 .legend span{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:4px}
    .lgA{background:#84cc16}.lgB{background:#38bdf8}.lgC{background:#f59e0b}.lgD{background:#a78bfa}

    #abcv11 .tee-grid{display:grid;grid-template-columns:90px repeat(var(--cols), minmax(140px,1fr));gap:6px}
    #abcv11 .tee-header{position:sticky;top:0;background:#f9fafb;z-index:5;border-bottom:1px solid var(--border)}
    #abcv11 .time-cell{position:sticky;left:0;background:#f9fafb;border:1px dashed var(--border);border-radius:10px;padding:6px;text-align:center;font-size:12px;z-index:3}
    #abcv11 .col-title{padding:8px 6px;text-align:center;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:12px}
    #abcv11 .group-title{padding:8px 6px;text-align:center;border:1px solid var(--border);border-radius:10px;background:#eef2ff;font-weight:700;letter-spacing:.2px;font-size:12px}
    #abcv11 .slot{border:1px dashed var(--border);border-radius:10px;min-height:40px;position:relative;background:#fff}
    #abcv11 .slot.group-boundary{border-left:2px solid rgba(0,0,0,.28)}
    #abcv11 .slot:hover{background:#f8fafc}
    #abcv11 .pill{display:block;background:var(--pill);color:var(--pillink);border:1px solid #86efac;border-radius:10px;padding:5px 6px;margin:3px;font-size:12px;cursor:grab;line-height:1.2}
    .mono{font-variant-numeric:tabular-nums}
    .tag{padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}

    dialog::backdrop{background:rgba(0,0,0,.35)}
    dialog{border:none;border-radius:14px;box-shadow:0 14px 36px rgba(0,0,0,.2);padding:0;background:#fff}
    .m-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:#f8fafc}
    .m-body{padding:12px}
    .m-foot{padding:10px 12px;border-top:1px solid var(--border);background:#f8fafc;display:flex;gap:8px;justify-content:flex-end}

    /* Month picker */
    .mp-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
    .mp-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:12px}
    .mp-dow{font-size:11px;color:var(--muted);text-align:center}
    .mp-day{padding:8px 0;text-align:center;border:1px solid var(--border);border-radius:10px;cursor:pointer;background:#fff}
    .mp-day.muted{opacity:.6}
    .mp-day.today{border-color:var(--brand)}
    .mp-day:hover{background:#eff6ff}

    /* Utility */
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 260px}
    .right{margin-left:auto}
    .wrap{max-width:1280px;margin:0 auto}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">MyCaddy Pro</div>
    <div style="color:#64748b">Robert Anderson â€¢ GM</div>
    <div class="right"></div>
    <div style="font-size:12px;color:#64748b">Live</div>
  </header>

  <nav class="tabs">
    <div class="tab" data-tab="dash">Dashboard</div>
    <div class="tab" data-tab="caddy">Caddy Status</div>
    <div class="tab active" data-tab="tee">Tee Sheet</div>
    <div class="tab" data-tab="ann">Announcements</div>
    <div class="tab" data-tab="dayoff">Day Off Requests</div>
  </nav>

  <main class="page">
    <section class="panel" data-tab="dash">
      <div class="card">Welcome to the GM dashboard.</div>
    </section>

    <section class="panel" data-tab="caddy" hidden>
      <div class="card">Caddy status placeholder.</div>
    </section>

    <section class="panel" data-tab="tee">
      <div id="abcv11" class="wrap">
        <h1>Tee Sheet</h1>
        <div class="sub">Aâ†’D straight across â€¢ 18/27/36 hole complexes â€¢ 1â€“2 tees per course â€¢ 5/7/10/15 min intervals</div>

        <div class="card">
          <div class="row">
            <div>
              <label>Complex</label><br>
              <select id="v11-complex">
                <option value="18">18 holes (A/B)</option>
                <option value="27" selected>27 holes (A/B/C)</option>
                <option value="36">36 holes (A/B/C/D)</option>
              </select>
            </div>
            <div>
              <label>Date</label><br>
              <div class="row" style="gap:6px">
                <button id="v11-prevDay" class="iconbtn" title="Previous day">â€¹</button>
                <input type="date" id="v11-date">
                <button id="v11-nextDay" class="iconbtn" title="Next day">â€º</button>
                <button id="v11-openMonth" class="iconbtn" title="Open month picker">ðŸ“…</button>
              </div>
            </div>
            <div><label>Start</label><br><input type="time" id="v11-start" value="06:00"></div>
            <div><label>End</label><br><input type="time" id="v11-end" value="18:00"></div>
            <div><label>Interval</label><br>
              <select id="v11-interval">
                <option value="5" selected>5 min</option>
                <option value="7">7 min</option>
                <option value="10">10 min</option>
                <option value="15">15 min</option>
              </select>
            </div>
            <div><label>Tees per Course</label><br>
              <select id="v11-teesPerCourse">
                <option value="1" selected>1</option>
                <option value="2">2</option>
              </select>
            </div>
            <div class="tag">Total Tees: <span id="v11-totalTeesTag">3</span></div>
            <div class="right"><button id="v11-clearDay">Clear Day</button></div>
            <div class="grow">
              <label>Golfer Name</label><br>
              <input id="v11-searchQuery" placeholder="Type golfer name or caddy number" style="width:100%">
              <div style="font-size:12px;color:var(--muted)">Press Enter to find; Next to jump to the following match.</div>
            </div>
            <div style="align-self:end"><label>&nbsp;</label><br><button id="v11-searchGo" class="btn-primary">Find</button></div>
            <div style="align-self:end"><label>&nbsp;</label><br><button id="v11-searchNext">Next</button></div>
            <div class="tag" style="align-self:end">Matches: <span id="v11-matchCount">0</span></div>
          </div>

          <div class="legend">
            <div><span class="lgA"></span>Course A</div>
            <div><span class="lgB"></span>Course B</div>
            <div id="v11-legC"><span class="lgC"></span>Course C</div>
            <div id="v11-legD" style="display:none"><span class="lgD"></span>Course D</div>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <div id="v11-sheet"></div>
        </div>
      </div>
    </section>

    <section class="panel" data-tab="ann" hidden>
      <div class="card">Announcements placeholder.</div>
    </section>

    <section class="panel" data-tab="dayoff" hidden>
      <div class="card">Day-off requests placeholder.</div>
    </section>
  </main>

  <!-- Booking Dialog -->
  <dialog id="v11-bookingDialog">
    <form method="dialog" id="v11-bookingForm">
      <div class="m-head">
        <div style="font-weight:800">Book Slot(s)</div>
        <button id="v11-closeDialog" type="button" class="iconbtn" title="Close">âœ•</button>
      </div>
      <div class="m-body">
        <input type="hidden" id="v11-bkId">
        <div class="row">
          <div class="grow"><label>Golfer Name</label><br><input id="v11-bkName" placeholder="Golfer name"></div>
          <div><label>Caddy Number</label><br><input id="v11-bkCaddy" placeholder="e.g., 27"></div>
          <div><label>Member ID</label><br><input id="v11-bkMid" placeholder="e.g., 004"></div>
          <div><label>Course</label><br><input id="v11-bkCourse" readonly style="width:84px"></div>
          <div><label>Tee #</label><br>
            <select id="v11-bkTeeNo"><option value="1">1</option><option value="2">2</option></select>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <div><label>From</label><br><input type="time" id="v11-bkFrom" class="mono"></div>
          <div><label>To</label><br><input type="time" id="v11-bkTo" class="mono"></div>
          <div style="align-self:end"><label>&nbsp;</label><br><label style="font-size:12px;color:#374151"><input type="checkbox" id="v11-bkApplyAll"> Apply details to all slots in range</label></div>
        </div>
        <div style="font-size:12px;color:var(--muted);margin-top:4px">Range aligns to the interval and clamped to Start/End.</div>
        <div style="margin-top:8px"><label>Notes</label><br><textarea id="v11-bkNotes" rows="3" style="width:100%"></textarea></div>
      </div>
      <div class="m-foot">
        <button id="v11-deleteBooking" type="button" style="background:#fff;border:1px solid #ef4444;color:#ef4444;border-radius:10px;padding:8px 12px;display:none">Delete</button>
        <button id="v11-saveBooking" class="btn-primary" value="default">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Month Picker -->
  <dialog id="v11-monthPicker">
    <div class="mp-head">
      <button id="v11-mpPrev" class="iconbtn">â€¹</button>
      <div>
        <select id="v11-mpMonth"></select>
        <select id="v11-mpYear"></select>
      </div>
      <button id="v11-mpNext" class="iconbtn">â€º</button>
    </div>
    <div class="mp-grid" id="v11-mpGrid">
      <div class="mp-dow">Sun</div><div class="mp-dow">Mon</div><div class="mp-dow">Tue</div><div class="mp-dow">Wed</div><div class="mp-dow">Thu</div><div class="mp-dow">Fri</div><div class="mp-dow">Sat</div>
    </div>
  </dialog>

  <script>
  (function(){
    "use strict";

    // Tabs
    var tabs = document.querySelectorAll(".tab");
    tabs.forEach(function(t){
      t.addEventListener("click", function(){
        tabs.forEach(function(x){ x.classList.toggle("active", x===t); });
        document.querySelectorAll(".panel").forEach(function(p){
          p.hidden = p.getAttribute("data-tab") !== t.getAttribute("data-tab");
        });
      });
    });

    // Helpers
    function pad2(n){ n=String(n); return n.length<2?("0"+n):n; }
    function minutes(hm){ var a=(hm||"").split(":").map(Number); return a[0]*60 + a[1]; }
    function hhmm(m){ return pad2(Math.floor(m/60))+":"+pad2(m%60); }
    function todayISO(){ var d=new Date(); return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); }
    function parseISO(s){ var a=(s||"").split("-").map(Number); return new Date(a[0]||NaN,(a[1]||1)-1,a[2]||NaN); }
    function genId(){ try{ return (crypto.getRandomValues(new Uint32Array(1))[0].toString(16)+Date.now().toString(16)); }catch(_){ return (Math.floor(Math.random()*1e9).toString(16)+Date.now().toString(16)); } }

    // DOM
    var $ = function(id){ return document.getElementById(id); };
    var el = {
      complex: $("v11-complex"), date: $("v11-date"), prev: $("v11-prevDay"), next: $("v11-nextDay"), openMonth: $("v11-openMonth"),
      start: $("v11-start"), end: $("v11-end"), interval: $("v11-interval"), tees: $("v11-teesPerCourse"),
      total: $("v11-totalTeesTag"), sheet: $("v11-sheet"), legC: $("v11-legC"), legD: $("v11-legD"),
      clear: $("v11-clearDay"),
      dlg: $("v11-bookingDialog"), id: $("v11-bkId"), name: $("v11-bkName"), caddy: $("v11-bkCaddy"), mid: $("v11-bkMid"),
      course: $("v11-bkCourse"), teeNo: $("v11-bkTeeNo"), from: $("v11-bkFrom"), to: $("v11-bkTo"), apply: $("v11-bkApplyAll"), notes: $("v11-bkNotes"),
      delBtn: $("v11-deleteBooking"), saveBtn: $("v11-saveBooking"), closeBtn: $("v11-closeDialog"),
      mp: $("v11-monthPicker"), mpPrev: $("v11-mpPrev"), mpNext: $("v11-mpNext"), mpM: $("v11-mpMonth"), mpY: $("v11-mpYear"), mpGrid: $("v11-mpGrid"),
      q: $("v11-searchQuery"), qGo: $("v11-searchGo"), qNext: $("v11-searchNext"), qCount: $("v11-matchCount")
    };

    // Storage
    var keyDay = function(d){ return "mctsheet.bookings.v12::"+d; };
    var keySettings = "mctsheet.settings.v12";
    function getDay(d){ try { return JSON.parse(localStorage.getItem(keyDay(d)) || "[]"); } catch(_){ return []; } }
    function setDay(d,a){ localStorage.setItem(keyDay(d), JSON.stringify(a||[])); }

    // Settings
    if(!el.date.value) el.date.value = todayISO();
    try {
      var s = JSON.parse(localStorage.getItem(keySettings) || "{}");
      ["complex","start","end","interval","tees","date"].forEach(function(k){ if(s[k]) el[k].value = s[k]; });
    } catch(_){}
    function saveSettings(){
      var s = { complex: el.complex.value, start: el.start.value, end: el.end.value, interval: el.interval.value, tees: el.tees.value, date: el.date.value };
      localStorage.setItem(keySettings, JSON.stringify(s));
    }

    // Layout
    function groups(){ var t = el.complex.value; if(t==="18") return ["A","B"]; if(t==="27") return ["A","B","C"]; return ["A","B","C","D"]; }
    function layout(){
      var gs = groups();
      var per = Math.max(1, Math.min(2, parseInt(el.tees.value||"1",10)));
      var cols = []; gs.forEach(function(g){ for(var i=0;i<per;i++) cols.push(g); });
      return { gs: gs, per: per, cols: cols, total: cols.length };
    }

    // Render
    function render(){
      saveSettings();
      var L = layout();
      el.total.textContent = L.total;
      el.legC.style.display = L.gs.indexOf("C")>=0 ? "" : "none";
      el.legD.style.display = L.gs.indexOf("D")>=0 ? "" : "none";
      el.sheet.style.setProperty("--cols", L.total);
      el.sheet.innerHTML = "";

      var header = document.createElement("div");
      header.className = "tee-grid tee-header";
      header.appendChild(document.createElement("div"));
      var within = {A:0,B:0,C:0,D:0};
      L.cols.forEach(function(g){
        within[g]++;
        var h = document.createElement("div");
        h.className = "col-title";
        h.textContent = g+"-"+within[g];
        header.appendChild(h);
      });
      el.sheet.appendChild(header);

      var ghead = document.createElement("div");
      ghead.className = "tee-grid";
      ghead.appendChild(document.createElement("div"));
      L.gs.forEach(function(g){
        var cell = document.createElement("div");
        cell.className = "group-title";
        cell.textContent = "Course "+g;
        if(g==="A") cell.style.background = "#d9f99d";
        if(g==="B") cell.style.background = "#bae6fd";
        if(g==="C") cell.style.background = "#fde68a";
        if(g==="D") cell.style.background = "#ddd6fe";
        cell.style.gridColumn = "span "+L.per;
        ghead.appendChild(cell);
      });
      el.sheet.appendChild(ghead);

      var startM = minutes(el.start.value), endM = minutes(el.end.value), step = +el.interval.value;
      var day = getDay(el.date.value);

      for(var m = startM; m <= endM; m += step){
        var row = document.createElement("div");
        row.className = "tee-grid";
        var label = hhmm(m);
        var tCell = document.createElement("div");
        tCell.className = "time-cell mono";
        tCell.textContent = label;
        row.appendChild(tCell);

        var count = {A:0,B:0,C:0,D:0};
        L.cols.forEach(function(g, idx){
          count[g]++;
          var slot = document.createElement("div");
          slot.className = "slot"+(count[g]===1?" group-boundary":"");
          slot.dataset.group = g;
          slot.dataset.tee = count[g];
          slot.dataset.time = label;
          slot.dataset.col = String(idx);

          day.filter(function(b){ return b.time===slot.dataset.time && b.col===idx; }).forEach(function(b){
            slot.appendChild(pill(b));
          });

          slot.addEventListener("click", function(e){
            if(e.target.closest(".pill")) return;
            openDlg({ id:"", name:"", caddyNumber:"", mid:"", course: slot.dataset.group, tee: parseInt(slot.dataset.tee,10)||1, time: slot.dataset.time, col: parseInt(slot.dataset.col,10)||0, notes:"" });
          });
          slot.addEventListener("dragover", function(e){ e.preventDefault(); });
          slot.addEventListener("drop", function(e){
            e.preventDefault();
            var id = e.dataTransfer.getData("text/id"); if(!id) return;
            var data = getDay(el.date.value);
            var i = data.findIndex(function(x){ return x.id===id; }); if(i<0) return;
            data[i].time = slot.dataset.time;
            data[i].col  = parseInt(slot.dataset.col,10) || 0;
            data[i].course = slot.dataset.group;
            data[i].tee = parseInt(slot.dataset.tee,10) || 1;
            setDay(el.date.value, data); render();
          });

          row.appendChild(slot);
        });

        el.sheet.appendChild(row);
      }

      computeMatches(el.q.value||"");
    }

    // Pill
    function pill(b){
      var p = document.createElement("div");
      p.className = "pill";
      p.draggable = true;
      p.dataset.id = b.id;
      var caddy = b.caddyNumber ? (" â€¢ Caddy "+b.caddyNumber) : "";
      p.innerHTML = "<strong>"+(b.name||"Player")+"</strong><br><span style='font-size:11px'>ID: "+(b.mid||"â€”")+caddy+" â€¢ "+b.course+"-"+(b.tee||1)+" â€¢ "+b.time+"</span>";
      p.addEventListener("dragstart", function(e){ e.dataTransfer.setData("text/id", b.id); });
      p.addEventListener("click", function(e){ openDlg(b); e.stopPropagation(); });
      return p;
    }

    // Dialog
    function openDlg(seed){
      el.id.value = seed.id || "";
      el.name.value = seed.name || "";
      el.caddy.value = seed.caddyNumber || "";
      el.mid.value = seed.mid || "";
      el.course.value = seed.course || "A";
      el.teeNo.value = String(seed.tee || 1);
      el.from.value = seed.time || "";
      el.to.value = seed.time || "";
      el.apply.checked = false;
      el.notes.value = seed.notes || "";
      el.delBtn.style.display = seed.id ? "" : "none";
      if(el.dlg.showModal) el.dlg.showModal(); else el.dlg.setAttribute("open","");
    }
    function closeDlg(){ if(el.dlg.close) el.dlg.close(); else el.dlg.removeAttribute("open"); }
    el.closeBtn.addEventListener("click", closeDlg);

    function aligned(from,to,step,start,end){
      function mins(hm){ var a=hm.split(":").map(Number); return a[0]*60+a[1]; }
      function tohm(min){ return pad2(Math.floor(min/60))+":"+pad2(min%60); }
      var a=mins(from||""), b=mins(to||""); if(isNaN(a)||isNaN(b)) return [];
      if(b<a){ var t=a;a=b;b=t; }
      var s=mins(start), e=mins(end); a=Math.max(a,s); b=Math.min(b,e); if(b<a) return [];
      var off=(a-s)%step; if(off!==0) a+=(step-off);
      var out=[]; for(var m=a;m<=b;m+=step) out.push(tohm(m)); return out;
    }

    el.saveBtn.addEventListener("click", function(e){
      e.preventDefault();
      var date = el.date.value || todayISO();
      var arr = getDay(date);
      var L = layout();
      var course = el.course.value;
      var tee = Math.max(1, Math.min(2, parseInt(el.teeNo.value||"1",10)));
      var applyAll = !!el.apply.checked;
      var step = +el.interval.value;
      var times = aligned(el.from.value, el.to.value, step, el.start.value, el.end.value);
      if(!times.length){ alert("Selected range has no times on this sheet."); return; }

      var colIndex = 0, count = {A:0,B:0,C:0,D:0};
      for(var i=0;i<L.cols.length;i++){ var g=L.cols[i]; count[g]++; if(g===course && count[g]===tee){ colIndex=i; break; } }

      function upsertAt(t, seedId, copy){
        var idx = arr.findIndex(function(x){ return x.time===t && x.col===colIndex; });
        var base = { id: seedId || genId(), course:course, tee:tee, time:t, col:colIndex, name:"", caddyNumber:"", mid:"", notes:"" };
        var payload = base; if(copy){ payload = Object.assign({}, base, { name:el.name.value.trim(), caddyNumber:el.caddy.value.trim(), mid:el.mid.value.trim(), notes:el.notes.value.trim() }); }
        if(idx>=0){ if(copy){ arr[idx] = Object.assign({}, arr[idx], payload, {id:arr[idx].id}); } return arr[idx] && arr[idx].id || payload.id; }
        else { arr.push(payload); return payload.id; }
      }

      if(times.length===1){
        var id = el.id.value || null;
        var idx = id ? arr.findIndex(function(x){ return x.id===id; }) : -1;
        if(idx>=0){
          arr[idx] = Object.assign({}, arr[idx], { name:el.name.value.trim(), caddyNumber:el.caddy.value.trim(), mid:el.mid.value.trim(), course:course, tee:tee, time:times[0], col:colIndex, notes:el.notes.value.trim() });
        } else {
          upsertAt(times[0], null, true);
        }
      } else {
        upsertAt(times[0], el.id.value||null, true);
        for(var j=1;j<times.length;j++) upsertAt(times[j], null, applyAll);
      }

      setDay(date, arr); closeDlg(); render();
    });

    el.delBtn.addEventListener("click", function(){
      var date = el.date.value || todayISO();
      var arr = getDay(date).filter(function(x){ return x.id !== el.id.value; });
      setDay(date, arr); closeDlg(); render();
    });

    // Date controls
    el.prev.addEventListener("click", function(){ var d=parseISO(el.date.value||todayISO()); d.setDate(d.getDate()-1); el.date.value=d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); render(); });
    el.next.addEventListener("click", function(){ var d=parseISO(el.date.value||todayISO()); d.setDate(d.getDate()+1); el.date.value=d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); render(); });
    el.date.addEventListener("change", render);
    el.complex.addEventListener("change", render);
    el.interval.addEventListener("change", render);
    el.start.addEventListener("change", render);
    el.end.addEventListener("change", render);
    el.tees.addEventListener("change", render);
    el.clear.addEventListener("click", function(){
      if(!confirm("Clear all bookings for "+el.date.value+"?")) return;
      setDay(el.date.value, []); render();
    });

    // Month picker
    var monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    (function buildMonthPicker(){
      el.mpM.innerHTML = monthNames.map(function(n,i){ return "<option value='"+i+"'>"+n+"</option>"; }).join("");
      var base = new Date().getFullYear(), years=[]; for(var y=base-5;y<=base+6;y++) years.push("<option value='"+y+"'>"+y+"</option>");
      el.mpY.innerHTML = years.join("");
    })();
    function renderMonth(year, month){
      Array.from(el.mpGrid.querySelectorAll(".mp-day")).forEach(function(n){ n.remove(); });
      var first = new Date(year, month, 1), firstDow = first.getDay(), daysInMonth = new Date(year, month+1, 0).getDate();
      var prevDays = new Date(year, month, 0).getDate();
      var t = new Date(); var today = t.getFullYear()+"-"+pad2(t.getMonth()+1)+"-"+pad2(t.getDate());
      for(var i=0;i<42;i++){
        var cell = document.createElement("div"); cell.className = "mp-day";
        var iso, muted=false;
        if(i<firstDow){ var d=new Date(year, month-1, prevDays - firstDow + 1 + i); iso=d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); muted=true; }
        else if(i>=firstDow + daysInMonth){ var d2=new Date(year, month+1, i - (firstDow + daysInMonth) + 1); iso=d2.getFullYear()+"-"+pad2(d2.getMonth()+1)+"-"+pad2(d2.getDate()); muted=true; }
        else { var d3=new Date(year, month, i - firstDow + 1); iso=d3.getFullYear()+"-"+pad2(d3.getMonth()+1)+"-"+pad2(d3.getDate()); }
        cell.textContent = String(new Date(iso).getDate());
        if(muted) cell.classList.add("muted");
        if(iso === today) cell.classList.add("today");
        (function(finalISO){ cell.addEventListener("click", function(){ el.date.value = finalISO; render(); el.mp.close(); }); })(iso);
        el.mpGrid.appendChild(cell);
      }
    }
    el.openMonth.addEventListener("click", function(){ var cur=parseISO(el.date.value||todayISO()); el.mpM.value=String(cur.getMonth()); el.mpY.value=String(cur.getFullYear()); renderMonth(cur.getFullYear(), cur.getMonth()); if(el.mp.showModal) el.mp.showModal(); else el.mp.setAttribute("open",""); });
    el.mpPrev.addEventListener("click", function(){ var y=parseInt(el.mpY.value,10), m=parseInt(el.mpM.value,10); var d=new Date(y, m-1, 1); el.mpY.value=String(d.getFullYear()); el.mpM.value=String(d.getMonth()); renderMonth(d.getFullYear(), d.getMonth()); });
    el.mpNext.addEventListener("click", function(){ var y=parseInt(el.mpY.value,10), m=parseInt(el.mpM.value,10); var d=new Date(y, m+1, 1); el.mpY.value=String(d.getFullYear()); el.mpM.value=String(d.getMonth()); renderMonth(d.getFullYear(), d.getMonth()); });
    el.mpM.addEventListener("change", function(){ renderMonth(parseInt(el.mpY.value,10), parseInt(el.mpM.value,10)); });
    el.mpY.addEventListener("change", function(){ renderMonth(parseInt(el.mpY.value,10), parseInt(el.mpM.value,10)); });

    // Search
    var state = { ids:[], idx:0 };
    function computeMatches(q){
      var data = getDay(el.date.value || todayISO());
      var needle = (q||"").trim().toLowerCase(); if(!needle){ state.ids=[]; state.idx=0; el.qCount.textContent="0"; return; }
      state.ids = data.filter(function(b){
        var name = (b.name||"").toLowerCase();
        var c = (b.caddyNumber||"").toLowerCase();
        return name.indexOf(needle)>=0 || c.indexOf(needle)>=0;
      }).sort(function(a,b){
        var da = minutes(a.time||"00:00"), db = minutes(b.time||"00:00");
        if(da!==db) return da-db; return (a.col||0)-(b.col||0);
      }).map(function(b){ return b.id; });
      el.qCount.textContent = String(state.ids.length||0);
    }
    function jump(id){
      if(!id) return;
      var data = getDay(el.date.value || todayISO());
      var rec = data.find(function(r){ return r.id===id; }); if(!rec) return;
      var slot = document.querySelector('#v11-sheet .slot[data-time="'+rec.time+'"][data-col="'+rec.col+'"]');
      if(!slot) return;
      slot.style.outline="2px solid #10b981";
      slot.scrollIntoView({behavior:"smooth", block:"center", inline:"center"});
      setTimeout(function(){ slot.style.outline=""; }, 1600);
    }
    el.qGo.addEventListener("click", function(e){ e.preventDefault(); computeMatches(el.q.value||""); if(state.ids.length){ jump(state.ids[0]); } else { alert("No matches on this date."); } });
    el.qNext.addEventListener("click", function(e){ e.preventDefault(); if(!state.ids.length){ el.qGo.click(); return; } state.idx=(state.idx+1)%state.ids.length; jump(state.ids[state.idx]); });
    el.q.addEventListener("keydown", function(e){ if(e.key==="Enter"){ e.preventDefault(); el.qGo.click(); } });

    // Init
    render();
  })();
  </script>
</body>
</html>
