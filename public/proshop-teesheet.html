<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MyCaddy Pro ‚Ä¢ Pro Shop Tee Sheet</title>
  <style>
    :root{--bg:#f4f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;--brand:#2563eb;--border:rgba(0,0,0,.12);--pill:#dcfce7;--pillink:#064e3b;--vip:#fef3c7;--vipink:#92400e;--society:#dbeafe;--societyink:#1e40af;--tournament:#fce7f3;--tournamentink:#9d174d}
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    a{color:var(--brand);text-decoration:none}
    .topbar{height:56px;display:flex;align-items:center;gap:12px;padding:0 16px;background:#fff;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50}
    .brand{font-weight:800;color:#0f172a}
    .tabs{display:flex;gap:6px;padding:8px 12px;background:#fff;border-bottom:1px solid var(--border);position:sticky;top:56px;z-index:40}
    .tab{padding:8px 12px;border-radius:10px;cursor:pointer}
    .tab.active{background:#eef2ff;color:#1d4ed8}
    .page{max-width:1280px;margin:14px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:12px}

    /* ========== Tee Sheet ========== */
    #abcv11 h1{margin:0;font-size:18px}
    #abcv11 .sub{color:var(--muted);font-size:12px;margin:4px 0 10px}
    #abcv11 label{font-size:12px;color:var(--muted)}
    #abcv11 input,#abcv11 select,#abcv11 textarea{border:1px solid var(--border);border-radius:10px;padding:7px 9px;background:#fff;color:var(--ink);outline:none}
    #abcv11 button{border:1px solid var(--border);background:#f3f4f6;border-radius:10px;padding:8px 10px;cursor:pointer}
    #abcv11 button:hover{background:#eef2ff}
    #abcv11 .btn-primary{background:var(--brand);color:#fff;border-color:#1d4ed8}
    #abcv11 .iconbtn{width:34px;height:34px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center}

    #abcv11 .legend{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted);margin-top:6px}
    #abcv11 .legend span{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:4px}
    .lgA{background:#84cc16}.lgB{background:#38bdf8}.lgC{background:#f59e0b}.lgD{background:#a78bfa}

    #abcv11 .tee-grid{display:grid;grid-template-columns:90px repeat(var(--cols), minmax(140px,1fr));gap:6px}
    #abcv11 .tee-header{position:sticky;top:0;background:#f9fafb;z-index:5;border-bottom:1px solid var(--border)}
    #abcv11 .time-cell{position:sticky;left:0;background:#f9fafb;border:1px dashed var(--border);border-radius:10px;padding:6px;text-align:center;font-size:12px;z-index:3}
    #abcv11 .col-title{padding:8px 6px;text-align:center;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:12px}
    #abcv11 .group-title{padding:8px 6px;text-align:center;border:1px solid var(--border);border-radius:10px;background:#eef2ff;font-weight:700;letter-spacing:.2px;font-size:12px}
    #abcv11 .slot{border:1px dashed var(--border);border-radius:10px;min-height:40px;position:relative;background:#fff}
    #abcv11 .slot.group-boundary{border-left:2px solid rgba(0,0,0,.28)}
    #abcv11 .slot:hover{background:#f8fafc}
    #abcv11 .pill{display:block;background:var(--pill);color:var(--pillink);border:1px solid #86efac;border-radius:10px;padding:5px 6px;margin:3px;font-size:12px;cursor:grab;line-height:1.2}
    #abcv11 .pill.vip{background:var(--vip);color:var(--vipink);border-color:#fcd34d}
    #abcv11 .pill.society{background:var(--society);color:var(--societyink);border-color:#93c5fd}
    #abcv11 .pill.tournament{background:var(--tournament);color:var(--tournamentink);border-color:#f9a8d4}
    .mono{font-variant-numeric:tabular-nums}
    .lang-btn{padding:4px 8px;border:1px solid var(--border);border-radius:6px;background:#fff;cursor:pointer;font-size:11px}
    .lang-btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .golfer-row{display:flex;gap:8px;align-items:center;padding:8px;background:#f9fafb;border-radius:8px;margin-bottom:6px}
    .golfer-row .golfer-num{min-width:24px;height:24px;background:var(--brand);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}
    .golfer-row input{flex:1;min-width:100px}
    .caddy-select{position:relative;flex:1;min-width:140px}
    .caddy-select input{width:100%}
    .caddy-dropdown{position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:100;display:none}
    .caddy-dropdown.show{display:block}
    .caddy-option{padding:8px 10px;cursor:pointer;border-bottom:1px solid #f3f4f6;font-size:13px}
    .caddy-option:hover{background:#eff6ff}
    .caddy-option .caddy-name{font-weight:600}
    .caddy-option .caddy-info{color:var(--muted);font-size:11px}
    .caddy-option .caddy-rating{float:right;color:#f59e0b}
    .tag{padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}

    dialog::backdrop{background:rgba(0,0,0,.35)}
    dialog{border:none;border-radius:14px;box-shadow:0 14px 36px rgba(0,0,0,.2);padding:0;background:#fff}
    .m-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:#f8fafc}
    .m-body{padding:12px}
    .m-foot{padding:10px 12px;border-top:1px solid var(--border);background:#f8fafc;display:flex;gap:8px;justify-content:flex-end}

    /* Month picker */
    .mp-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
    .mp-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:12px}
    .mp-dow{font-size:11px;color:var(--muted);text-align:center}
    .mp-day{padding:8px 0;text-align:center;border:1px solid var(--border);border-radius:10px;cursor:pointer;background:#fff}
    .mp-day.muted{opacity:.6}
    .mp-day.today{border-color:var(--brand)}
    .mp-day:hover{background:#eff6ff}

    /* Utility */
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 260px}
    .right{margin-left:auto}
    .wrap{max-width:1280px;margin:0 auto}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">MyCaddy Pro</div>
    <div style="color:#64748b" data-i18n="proshop">Pro Shop</div>
    <div class="right"></div>
    <div id="lang-selector" style="display:flex;gap:4px">
      <button class="lang-btn active" data-lang="en">EN</button>
      <button class="lang-btn" data-lang="th">TH</button>
      <button class="lang-btn" data-lang="ko">KO</button>
      <button class="lang-btn" data-lang="ja">JA</button>
    </div>
    <div style="font-size:12px;color:#64748b;margin-left:8px">Live</div>
  </header>

  <nav class="tabs">
    <div class="tab" data-tab="dash" data-i18n="dashboard">Dashboard</div>
    <div class="tab" data-tab="caddy" data-i18n="caddyStatus">Caddy Status</div>
    <div class="tab active" data-tab="tee" data-i18n="teeSheet">Tee Sheet</div>
    <div class="tab" data-tab="ann" data-i18n="announcements">Announcements</div>
    <div class="tab" data-tab="dayoff" data-i18n="dayOffRequests">Day Off Requests</div>
  </nav>

  <main class="page">
    <section class="panel" data-tab="dash">
      <div class="card">Welcome to the GM dashboard.</div>
    </section>

    <section class="panel" data-tab="caddy" hidden>
      <div class="card">Caddy status placeholder.</div>
    </section>

    <section class="panel" data-tab="tee">
      <div id="abcv11" class="wrap">
        <h1>Tee Sheet</h1>
        <div class="sub">A‚ÜíD straight across ‚Ä¢ 18/27/36 hole complexes ‚Ä¢ 1‚Äì2 tees per course ‚Ä¢ 5/7/10/15 min intervals</div>

        <div class="card">
          <div class="row">
            <div>
              <label>Complex</label><br>
              <select id="v11-complex">
                <option value="18">18 holes (A/B)</option>
                <option value="27" selected>27 holes (A/B/C)</option>
                <option value="36">36 holes (A/B/C/D)</option>
              </select>
            </div>
            <div>
              <label>Date</label><br>
              <div class="row" style="gap:6px">
                <button id="v11-prevDay" class="iconbtn" title="Previous day">‚Äπ</button>
                <input type="date" id="v11-date">
                <button id="v11-nextDay" class="iconbtn" title="Next day">‚Ä∫</button>
                <button id="v11-openMonth" class="iconbtn" title="Open month picker">üìÖ</button>
              </div>
            </div>
            <div><label>Start</label><br><input type="time" id="v11-start" value="06:00"></div>
            <div><label>End</label><br><input type="time" id="v11-end" value="18:00"></div>
            <div><label>Interval</label><br>
              <select id="v11-interval">
                <option value="5" selected>5 min</option>
                <option value="7">7 min</option>
                <option value="10">10 min</option>
                <option value="15">15 min</option>
              </select>
            </div>
            <div><label>Tees per Course</label><br>
              <select id="v11-teesPerCourse">
                <option value="1" selected>1</option>
                <option value="2">2</option>
              </select>
            </div>
            <div class="tag">Total Tees: <span id="v11-totalTeesTag">3</span></div>
            <div class="right"><button id="v11-clearDay">Clear Day</button></div>
            <div class="grow">
              <label>Golfer Name</label><br>
              <input id="v11-searchQuery" placeholder="Type golfer name or caddy number" style="width:100%">
              <div style="font-size:12px;color:var(--muted)">Press Enter to find; Next to jump to the following match.</div>
            </div>
            <div style="align-self:end"><label>&nbsp;</label><br><button id="v11-searchGo" class="btn-primary">Find</button></div>
            <div style="align-self:end"><label>&nbsp;</label><br><button id="v11-searchNext">Next</button></div>
            <div class="tag" style="align-self:end">Matches: <span id="v11-matchCount">0</span></div>
          </div>

          <div class="legend">
            <div><span class="lgA"></span>Course A</div>
            <div><span class="lgB"></span>Course B</div>
            <div id="v11-legC"><span class="lgC"></span>Course C</div>
            <div id="v11-legD" style="display:none"><span class="lgD"></span>Course D</div>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <div id="v11-sheet"></div>
        </div>
      </div>
    </section>

    <section class="panel" data-tab="ann" hidden>
      <div class="card">Announcements placeholder.</div>
    </section>

    <section class="panel" data-tab="dayoff" hidden>
      <div class="card">Day-off requests placeholder.</div>
    </section>
  </main>

  <!-- Booking Dialog -->
  <dialog id="v11-bookingDialog" style="width:580px;max-width:95vw">
    <form method="dialog" id="v11-bookingForm">
      <div class="m-head">
        <div style="font-weight:800" data-i18n="bookSlots">Book Slot(s)</div>
        <button id="v11-closeDialog" type="button" class="iconbtn" title="Close">‚úï</button>
      </div>
      <div class="m-body">
        <input type="hidden" id="v11-bkId">

        <!-- Booking Type & Course Info -->
        <div class="row" style="margin-bottom:10px">
          <div>
            <label data-i18n="bookingType">Booking Type</label><br>
            <select id="v11-bkType" style="min-width:120px">
              <option value="regular" data-i18n="regular">Regular</option>
              <option value="vip" data-i18n="vip">VIP</option>
              <option value="society" data-i18n="society">Society</option>
              <option value="tournament" data-i18n="tournament">Tournament</option>
            </select>
          </div>
          <div><label data-i18n="course">Course</label><br><input id="v11-bkCourse" readonly style="width:84px"></div>
          <div><label data-i18n="teeNum">Tee #</label><br>
            <select id="v11-bkTeeNo"><option value="1">1</option><option value="2">2</option></select>
          </div>
          <div><label data-i18n="from">From</label><br><input type="time" id="v11-bkFrom" class="mono"></div>
          <div><label data-i18n="to">To</label><br><input type="time" id="v11-bkTo" class="mono"></div>
        </div>

        <!-- Golfers Section -->
        <div style="margin-bottom:10px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <label style="font-weight:600" data-i18n="golfers">Golfers</label>
            <button type="button" id="v11-addGolfer" style="font-size:11px;padding:4px 8px" data-i18n="addGolfer">+ Add Golfer</button>
          </div>
          <div id="v11-golfersList"></div>
        </div>

        <div class="row" style="margin-top:6px">
          <div style="align-self:end"><label style="font-size:12px;color:#374151"><input type="checkbox" id="v11-bkApplyAll"> <span data-i18n="applyAll">Apply details to all slots in range</span></label></div>
        </div>
        <div style="font-size:12px;color:var(--muted);margin-top:4px" data-i18n="rangeNote">Range aligns to the interval and clamped to Start/End.</div>
        <div style="margin-top:8px"><label data-i18n="notes">Notes</label><br><textarea id="v11-bkNotes" rows="2" style="width:100%"></textarea></div>
      </div>
      <div class="m-foot">
        <button id="v11-deleteBooking" type="button" style="background:#fff;border:1px solid #ef4444;color:#ef4444;border-radius:10px;padding:8px 12px;display:none" data-i18n="delete">Delete</button>
        <button id="v11-saveBooking" class="btn-primary" value="default" data-i18n="save">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Month Picker -->
  <dialog id="v11-monthPicker">
    <div class="mp-head">
      <button id="v11-mpPrev" class="iconbtn">‚Äπ</button>
      <div>
        <select id="v11-mpMonth"></select>
        <select id="v11-mpYear"></select>
      </div>
      <button id="v11-mpNext" class="iconbtn">‚Ä∫</button>
    </div>
    <div class="mp-grid" id="v11-mpGrid">
      <div class="mp-dow">Sun</div><div class="mp-dow">Mon</div><div class="mp-dow">Tue</div><div class="mp-dow">Wed</div><div class="mp-dow">Thu</div><div class="mp-dow">Fri</div><div class="mp-dow">Sat</div>
    </div>
  </dialog>

  <script>
  (function(){
    "use strict";

    // ==================== TRANSLATIONS ====================
    var translations = {
      en: {
        proshop: "Pro Shop",
        dashboard: "Dashboard",
        caddyStatus: "Caddy Status",
        teeSheet: "Tee Sheet",
        announcements: "Announcements",
        dayOffRequests: "Day Off Requests",
        bookSlots: "Book Slot(s)",
        bookingType: "Booking Type",
        regular: "Regular",
        vip: "VIP",
        society: "Society",
        tournament: "Tournament",
        course: "Course",
        teeNum: "Tee #",
        from: "From",
        to: "To",
        golfers: "Golfers",
        addGolfer: "+ Add Golfer",
        golferName: "Golfer Name",
        selectCaddy: "Select Caddy",
        searchCaddy: "Search caddy...",
        noCaddy: "No Caddy",
        applyAll: "Apply details to all slots in range",
        rangeNote: "Range aligns to the interval and clamped to Start/End.",
        notes: "Notes",
        delete: "Delete",
        save: "Save",
        clearDay: "Clear Day",
        find: "Find",
        next: "Next",
        matches: "Matches",
        complex: "Complex",
        date: "Date",
        start: "Start",
        end: "End",
        interval: "Interval",
        teesPerCourse: "Tees per Course",
        totalTees: "Total Tees",
        searchPlaceholder: "Type golfer name or caddy number",
        searchHint: "Press Enter to find; Next to jump to the following match.",
        noMatches: "No matches on this date.",
        confirmClear: "Clear all bookings for",
        noTimes: "Selected range has no times on this sheet.",
        player: "Player",
        players: "players"
      },
      th: {
        proshop: "‡πÇ‡∏õ‡∏£‡∏ä‡πá‡∏≠‡∏õ",
        dashboard: "‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î",
        caddyStatus: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏Ñ‡∏î‡∏î‡∏µ‡πâ",
        teeSheet: "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡∏≠‡∏≠‡∏ü",
        announcements: "‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®",
        dayOffRequests: "‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î",
        bookSlots: "‡∏à‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤",
        bookingType: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á",
        regular: "‡∏õ‡∏Å‡∏ï‡∏¥",
        vip: "VIP",
        society: "‡∏Å‡∏•‡∏∏‡πà‡∏°",
        tournament: "‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ô‡∏≤‡πÄ‡∏°‡∏ô‡∏ï‡πå",
        course: "‡∏Ñ‡∏≠‡∏£‡πå‡∏™",
        teeNum: "‡∏ó‡∏µ‡∏≠‡∏≠‡∏ü #",
        from: "‡∏à‡∏≤‡∏Å",
        to: "‡∏ñ‡∏∂‡∏á",
        golfers: "‡∏ô‡∏±‡∏Å‡∏Å‡∏≠‡∏•‡πå‡∏ü",
        addGolfer: "+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏Å‡∏≠‡∏•‡πå‡∏ü",
        golferName: "‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏Å‡∏≠‡∏•‡πå‡∏ü",
        selectCaddy: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏Ñ‡∏î‡∏î‡∏µ‡πâ",
        searchCaddy: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏Ñ‡∏î‡∏î‡∏µ‡πâ...",
        noCaddy: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏Ñ‡∏î‡∏î‡∏µ‡πâ",
        applyAll: "‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤",
        rangeNote: "‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏∞‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î",
        notes: "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏",
        delete: "‡∏•‡∏ö",
        save: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",
        clearDay: "‡∏•‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô",
        find: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤",
        next: "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ",
        matches: "‡∏û‡∏ö",
        complex: "‡∏Ñ‡∏≠‡∏°‡πÄ‡∏û‡∏•‡πá‡∏Å‡∏ã‡πå",
        date: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà",
        start: "‡πÄ‡∏£‡∏¥‡πà‡∏°",
        end: "‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î",
        interval: "‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤",
        teesPerCourse: "‡∏ó‡∏µ‡∏≠‡∏≠‡∏ü‡∏ï‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™",
        totalTees: "‡∏ó‡∏µ‡∏≠‡∏≠‡∏ü‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
        searchPlaceholder: "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏Å‡∏≠‡∏•‡πå‡∏ü‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏Ñ‡∏î‡∏î‡∏µ‡πâ",
        searchHint: "‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤; ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ",
        noMatches: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ",
        confirmClear: "‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö",
        noTimes: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ",
        player: "‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô",
        players: "‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô"
      },
      ko: {
        proshop: "ÌîÑÎ°úÏÉµ",
        dashboard: "ÎåÄÏãúÎ≥¥Îìú",
        caddyStatus: "Ï∫êÎîî ÏÉÅÌÉú",
        teeSheet: "Ìã∞ ÏãúÌä∏",
        announcements: "Í≥µÏßÄÏÇ¨Ìï≠",
        dayOffRequests: "Ìú¥Í∞Ä ÏöîÏ≤≠",
        bookSlots: "Ïä¨Î°Ø ÏòàÏïΩ",
        bookingType: "ÏòàÏïΩ Ïú†Ìòï",
        regular: "ÏùºÎ∞ò",
        vip: "VIP",
        society: "Îã®Ï≤¥",
        tournament: "ÌÜ†ÎÑàÎ®ºÌä∏",
        course: "ÏΩîÏä§",
        teeNum: "Ìã∞ #",
        from: "ÏãúÏûë",
        to: "Ï¢ÖÎ£å",
        golfers: "Í≥®Ìçº",
        addGolfer: "+ Í≥®Ìçº Ï∂îÍ∞Ä",
        golferName: "Í≥®Ìçº Ïù¥Î¶Ñ",
        selectCaddy: "Ï∫êÎîî ÏÑ†ÌÉù",
        searchCaddy: "Ï∫êÎîî Í≤ÄÏÉâ...",
        noCaddy: "Ï∫êÎîî ÏóÜÏùå",
        applyAll: "Î™®Îì† Ïä¨Î°ØÏóê Ï†ÅÏö©",
        rangeNote: "Î≤îÏúÑÎäî Í∞ÑÍ≤©Ïóê ÎßûÏ∂∞ Ï°∞Ï†ïÎê©ÎãàÎã§.",
        notes: "Î©îÎ™®",
        delete: "ÏÇ≠Ï†ú",
        save: "Ï†ÄÏû•",
        clearDay: "ÏùºÏùº ÏÇ≠Ï†ú",
        find: "Í≤ÄÏÉâ",
        next: "Îã§Ïùå",
        matches: "Í≤∞Í≥º",
        complex: "Î≥µÌï©",
        date: "ÎÇ†Ïßú",
        start: "ÏãúÏûë",
        end: "Ï¢ÖÎ£å",
        interval: "Í∞ÑÍ≤©",
        teesPerCourse: "ÏΩîÏä§Îãπ Ìã∞",
        totalTees: "Ï¥ù Ìã∞",
        searchPlaceholder: "Í≥®Ìçº Ïù¥Î¶Ñ ÎòêÎäî Ï∫êÎîî Î≤àÌò∏ ÏûÖÎ†•",
        searchHint: "EnterÎ•º ÎàåÎü¨ Í≤ÄÏÉâ; Îã§ÏùåÏúºÎ°ú Ïù¥Îèô",
        noMatches: "Ïò§Îäò ÎÇ†ÏßúÏóê Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.",
        confirmClear: "Î™®Îì† ÏòàÏïΩ ÏÇ≠Ï†ú",
        noTimes: "ÏÑ†ÌÉùÌïú Î≤îÏúÑÏóê ÏãúÍ∞ÑÏù¥ ÏóÜÏäµÎãàÎã§.",
        player: "ÌîåÎ†àÏù¥Ïñ¥",
        players: "Î™Ö"
      },
      ja: {
        proshop: "„Éó„É≠„Ç∑„Éß„ÉÉ„Éó",
        dashboard: "„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ",
        caddyStatus: "„Ç≠„É£„Éá„Ç£„ÉºÁä∂Ê≥Å",
        teeSheet: "„ÉÜ„Ç£„Éº„Ç∑„Éº„Éà",
        announcements: "„ÅäÁü•„Çâ„Åõ",
        dayOffRequests: "‰ºëÊöáÁî≥Ë´ã",
        bookSlots: "„Çπ„É≠„ÉÉ„Éà‰∫àÁ¥Ñ",
        bookingType: "‰∫àÁ¥Ñ„Çø„Ç§„Éó",
        regular: "‰∏ÄËà¨",
        vip: "VIP",
        society: "Âõ£‰Ωì",
        tournament: "„Éà„Éº„Éä„É°„É≥„Éà",
        course: "„Ç≥„Éº„Çπ",
        teeNum: "„ÉÜ„Ç£„Éº #",
        from: "ÈñãÂßã",
        to: "ÁµÇ‰∫Ü",
        golfers: "„Ç¥„É´„Éï„Ç°„Éº",
        addGolfer: "+ „Ç¥„É´„Éï„Ç°„ÉºËøΩÂä†",
        golferName: "„Ç¥„É´„Éï„Ç°„ÉºÂêç",
        selectCaddy: "„Ç≠„É£„Éá„Ç£„ÉºÈÅ∏Êäû",
        searchCaddy: "„Ç≠„É£„Éá„Ç£„ÉºÊ§úÁ¥¢...",
        noCaddy: "„Ç≠„É£„Éá„Ç£„Éº„Å™„Åó",
        applyAll: "„Åô„Åπ„Å¶„ÅÆ„Çπ„É≠„ÉÉ„Éà„Å´ÈÅ©Áî®",
        rangeNote: "ÁØÑÂõ≤„ÅØÈñìÈöî„Å´Âêà„Çè„Åõ„Å¶Ë™øÊï¥„Åï„Çå„Åæ„Åô„ÄÇ",
        notes: "„É°„É¢",
        delete: "ÂâäÈô§",
        save: "‰øùÂ≠ò",
        clearDay: "Êó•‰ªò„ÇØ„É™„Ç¢",
        find: "Ê§úÁ¥¢",
        next: "Ê¨°„Å∏",
        matches: "‰ª∂",
        complex: "„Ç≥„É≥„Éó„É¨„ÉÉ„ÇØ„Çπ",
        date: "Êó•‰ªò",
        start: "ÈñãÂßã",
        end: "ÁµÇ‰∫Ü",
        interval: "ÈñìÈöî",
        teesPerCourse: "„Ç≥„Éº„ÇπÊØé„ÉÜ„Ç£„Éº",
        totalTees: "Á∑è„ÉÜ„Ç£„Éº",
        searchPlaceholder: "„Ç¥„É´„Éï„Ç°„ÉºÂêç„Åæ„Åü„ÅØ„Ç≠„É£„Éá„Ç£„ÉºÁï™Âè∑„ÇíÂÖ•Âäõ",
        searchHint: "Enter„ÅßÊ§úÁ¥¢; Ê¨°„Å∏„ÅßÁßªÂãï",
        noMatches: "Êú¨Êó•„ÅÆÁµêÊûú„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ",
        confirmClear: "‰∫àÁ¥Ñ„Çí„Åô„Åπ„Å¶ÂâäÈô§",
        noTimes: "ÈÅ∏Êäû„Åó„ÅüÁØÑÂõ≤„Å´ÊôÇÈñì„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ",
        player: "„Éó„É¨„Ç§„É§„Éº",
        players: "Âêç"
      }
    };

    var currentLang = localStorage.getItem("teesheet.lang") || "en";

    function t(key) {
      return (translations[currentLang] && translations[currentLang][key]) || translations.en[key] || key;
    }

    function applyTranslations() {
      document.querySelectorAll("[data-i18n]").forEach(function(el) {
        var key = el.getAttribute("data-i18n");
        el.textContent = t(key);
      });
      // Update placeholders
      var searchInput = document.getElementById("v11-searchQuery");
      if (searchInput) searchInput.placeholder = t("searchPlaceholder");
    }

    // Language selector
    document.querySelectorAll("#lang-selector .lang-btn").forEach(function(btn) {
      btn.addEventListener("click", function() {
        document.querySelectorAll("#lang-selector .lang-btn").forEach(function(b) { b.classList.remove("active"); });
        btn.classList.add("active");
        currentLang = btn.dataset.lang;
        localStorage.setItem("teesheet.lang", currentLang);
        applyTranslations();
      });
      if (btn.dataset.lang === currentLang) {
        document.querySelectorAll("#lang-selector .lang-btn").forEach(function(b) { b.classList.remove("active"); });
        btn.classList.add("active");
      }
    });

    // ==================== CADDY DATA ====================
    // Sample caddies - in production this would come from CaddySystem.allCaddys
    var allCaddies = [];

    // Try to load from MciPro platform
    if (window.CaddySystem && window.CaddySystem.allCaddys) {
      allCaddies = window.CaddySystem.allCaddys;
    } else {
      // Demo caddies
      allCaddies = [
        { id: 1, name: "Somchai K.", number: "001", rating: 4.8, language: "TH/EN", status: "available" },
        { id: 2, name: "Napat P.", number: "002", rating: 4.9, language: "TH/EN/KO", status: "available" },
        { id: 3, name: "Wanida S.", number: "003", rating: 4.7, language: "TH/EN/JA", status: "available" },
        { id: 4, name: "Thanaporn M.", number: "004", rating: 4.6, language: "TH/EN", status: "available" },
        { id: 5, name: "Apinya R.", number: "005", rating: 4.9, language: "TH/EN/KO", status: "available" },
        { id: 6, name: "Channarong T.", number: "006", rating: 4.5, language: "TH/EN", status: "busy" },
        { id: 7, name: "Duangjai L.", number: "007", rating: 4.8, language: "TH/EN/JA", status: "available" },
        { id: 8, name: "Ekachai N.", number: "008", rating: 4.4, language: "TH/EN", status: "available" },
        { id: 9, name: "Fah C.", number: "009", rating: 4.7, language: "TH/EN/KO", status: "available" },
        { id: 10, name: "Ganya W.", number: "010", rating: 4.6, language: "TH/EN", status: "dayoff" }
      ];
    }

    // ==================== TABS ====================
    var tabs = document.querySelectorAll(".tab");
    tabs.forEach(function(t){
      t.addEventListener("click", function(){
        tabs.forEach(function(x){ x.classList.toggle("active", x===t); });
        document.querySelectorAll(".panel").forEach(function(p){
          p.hidden = p.getAttribute("data-tab") !== t.getAttribute("data-tab");
        });
      });
    });

    // ==================== HELPERS ====================
    function pad2(n){ n=String(n); return n.length<2?("0"+n):n; }
    function minutes(hm){ var a=(hm||"").split(":").map(Number); return a[0]*60 + a[1]; }
    function hhmm(m){ return pad2(Math.floor(m/60))+":"+pad2(m%60); }
    function todayISO(){ var d=new Date(); return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); }
    function parseISO(s){ var a=(s||"").split("-").map(Number); return new Date(a[0]||NaN,(a[1]||1)-1,a[2]||NaN); }
    function genId(){ try{ return (crypto.getRandomValues(new Uint32Array(1))[0].toString(16)+Date.now().toString(16)); }catch(_){ return (Math.floor(Math.random()*1e9).toString(16)+Date.now().toString(16)); } }

    // ==================== DOM ====================
    var $ = function(id){ return document.getElementById(id); };
    var el = {
      complex: $("v11-complex"), date: $("v11-date"), prev: $("v11-prevDay"), next: $("v11-nextDay"), openMonth: $("v11-openMonth"),
      start: $("v11-start"), end: $("v11-end"), interval: $("v11-interval"), tees: $("v11-teesPerCourse"),
      total: $("v11-totalTeesTag"), sheet: $("v11-sheet"), legC: $("v11-legC"), legD: $("v11-legD"),
      clear: $("v11-clearDay"),
      dlg: $("v11-bookingDialog"), id: $("v11-bkId"), type: $("v11-bkType"),
      course: $("v11-bkCourse"), teeNo: $("v11-bkTeeNo"), from: $("v11-bkFrom"), to: $("v11-bkTo"),
      apply: $("v11-bkApplyAll"), notes: $("v11-bkNotes"), golfersList: $("v11-golfersList"),
      addGolfer: $("v11-addGolfer"),
      delBtn: $("v11-deleteBooking"), saveBtn: $("v11-saveBooking"), closeBtn: $("v11-closeDialog"),
      mp: $("v11-monthPicker"), mpPrev: $("v11-mpPrev"), mpNext: $("v11-mpNext"), mpM: $("v11-mpMonth"), mpY: $("v11-mpYear"), mpGrid: $("v11-mpGrid"),
      q: $("v11-searchQuery"), qGo: $("v11-searchGo"), qNext: $("v11-searchNext"), qCount: $("v11-matchCount")
    };

    // ==================== STORAGE ====================
    var keyDay = function(d){ return "mctsheet.bookings.v13::"+d; };
    var keySettings = "mctsheet.settings.v13";
    function getDay(d){ try { return JSON.parse(localStorage.getItem(keyDay(d)) || "[]"); } catch(_){ return []; } }
    function setDay(d,a){ localStorage.setItem(keyDay(d), JSON.stringify(a||[])); }

    // ==================== SETTINGS ====================
    if(!el.date.value) el.date.value = todayISO();
    try {
      var s = JSON.parse(localStorage.getItem(keySettings) || "{}");
      ["complex","start","end","interval","tees","date"].forEach(function(k){ if(s[k]) el[k].value = s[k]; });
    } catch(_){}
    function saveSettings(){
      var s = { complex: el.complex.value, start: el.start.value, end: el.end.value, interval: el.interval.value, tees: el.tees.value, date: el.date.value };
      localStorage.setItem(keySettings, JSON.stringify(s));
    }

    // ==================== LAYOUT ====================
    function groups(){ var t = el.complex.value; if(t==="18") return ["A","B"]; if(t==="27") return ["A","B","C"]; return ["A","B","C","D"]; }
    function layout(){
      var gs = groups();
      var per = Math.max(1, Math.min(2, parseInt(el.tees.value||"1",10)));
      var cols = []; gs.forEach(function(g){ for(var i=0;i<per;i++) cols.push(g); });
      return { gs: gs, per: per, cols: cols, total: cols.length };
    }

    // ==================== GOLFER ROWS ====================
    var currentGolfers = [];

    function createGolferRow(index, golfer) {
      golfer = golfer || { name: "", caddyId: null, caddyNumber: "", caddyName: "" };
      var row = document.createElement("div");
      row.className = "golfer-row";
      row.dataset.index = index;

      var numDiv = document.createElement("div");
      numDiv.className = "golfer-num";
      numDiv.textContent = index + 1;

      var nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = t("golferName");
      nameInput.value = golfer.name || "";
      nameInput.className = "golfer-name-input";

      var caddySelect = document.createElement("div");
      caddySelect.className = "caddy-select";

      var caddyInput = document.createElement("input");
      caddyInput.type = "text";
      caddyInput.placeholder = t("searchCaddy");
      caddyInput.className = "caddy-search-input";
      caddyInput.value = golfer.caddyNumber ? (golfer.caddyNumber + " - " + (golfer.caddyName || "")) : "";
      caddyInput.dataset.caddyId = golfer.caddyId || "";
      caddyInput.dataset.caddyNumber = golfer.caddyNumber || "";
      caddyInput.dataset.caddyName = golfer.caddyName || "";

      var dropdown = document.createElement("div");
      dropdown.className = "caddy-dropdown";

      caddyInput.addEventListener("focus", function() {
        renderCaddyDropdown(dropdown, caddyInput, "");
        dropdown.classList.add("show");
      });

      caddyInput.addEventListener("input", function() {
        renderCaddyDropdown(dropdown, caddyInput, caddyInput.value);
        dropdown.classList.add("show");
      });

      caddyInput.addEventListener("blur", function() {
        setTimeout(function() { dropdown.classList.remove("show"); }, 200);
      });

      caddySelect.appendChild(caddyInput);
      caddySelect.appendChild(dropdown);

      var removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.textContent = "‚úï";
      removeBtn.style.cssText = "width:28px;height:28px;padding:0;font-size:14px;background:#fee2e2;border-color:#fecaca;color:#dc2626";
      removeBtn.addEventListener("click", function() {
        if (el.golfersList.children.length > 1) {
          row.remove();
          renumberGolfers();
        }
      });

      row.appendChild(numDiv);
      row.appendChild(nameInput);
      row.appendChild(caddySelect);
      row.appendChild(removeBtn);

      return row;
    }

    function renderCaddyDropdown(dropdown, input, query) {
      dropdown.innerHTML = "";
      query = (query || "").toLowerCase();

      // No caddy option
      var noCaddyOpt = document.createElement("div");
      noCaddyOpt.className = "caddy-option";
      noCaddyOpt.innerHTML = '<span class="caddy-name">' + t("noCaddy") + '</span>';
      noCaddyOpt.addEventListener("mousedown", function(e) {
        e.preventDefault();
        input.value = "";
        input.dataset.caddyId = "";
        input.dataset.caddyNumber = "";
        input.dataset.caddyName = "";
        dropdown.classList.remove("show");
      });
      dropdown.appendChild(noCaddyOpt);

      // Filter caddies
      var filtered = allCaddies.filter(function(c) {
        if (c.status === "dayoff" || c.status === "busy") return false;
        var searchStr = ((c.number || "") + " " + (c.name || "")).toLowerCase();
        return !query || searchStr.indexOf(query) >= 0;
      }).slice(0, 10);

      filtered.forEach(function(caddy) {
        var opt = document.createElement("div");
        opt.className = "caddy-option";
        var stars = "‚òÖ".repeat(Math.floor(caddy.rating || 0)) + (caddy.rating % 1 >= 0.5 ? "¬Ω" : "");
        opt.innerHTML = '<span class="caddy-name">#' + (caddy.number || caddy.id) + ' ' + caddy.name + '</span>' +
                        '<span class="caddy-rating">' + stars + ' ' + (caddy.rating || 0).toFixed(1) + '</span>' +
                        '<div class="caddy-info">' + (caddy.language || "TH/EN") + '</div>';
        opt.addEventListener("mousedown", function(e) {
          e.preventDefault();
          input.value = (caddy.number || caddy.id) + " - " + caddy.name;
          input.dataset.caddyId = caddy.id || "";
          input.dataset.caddyNumber = caddy.number || caddy.id || "";
          input.dataset.caddyName = caddy.name || "";
          dropdown.classList.remove("show");
        });
        dropdown.appendChild(opt);
      });
    }

    function renumberGolfers() {
      Array.from(el.golfersList.children).forEach(function(row, i) {
        row.dataset.index = i;
        row.querySelector(".golfer-num").textContent = i + 1;
      });
    }

    function getGolfersFromDialog() {
      var golfers = [];
      Array.from(el.golfersList.children).forEach(function(row) {
        var nameInput = row.querySelector(".golfer-name-input");
        var caddyInput = row.querySelector(".caddy-search-input");
        if (nameInput && nameInput.value.trim()) {
          golfers.push({
            name: nameInput.value.trim(),
            caddyId: caddyInput.dataset.caddyId || null,
            caddyNumber: caddyInput.dataset.caddyNumber || "",
            caddyName: caddyInput.dataset.caddyName || ""
          });
        }
      });
      return golfers;
    }

    function setGolfersInDialog(golfers) {
      el.golfersList.innerHTML = "";
      golfers = golfers || [{ name: "", caddyId: null, caddyNumber: "", caddyName: "" }];
      golfers.forEach(function(g, i) {
        el.golfersList.appendChild(createGolferRow(i, g));
      });
    }

    el.addGolfer.addEventListener("click", function() {
      var count = el.golfersList.children.length;
      if (count < 4) {
        el.golfersList.appendChild(createGolferRow(count, {}));
      }
    });

    // ==================== RENDER ====================
    function render(){
      saveSettings();
      var L = layout();
      el.total.textContent = L.total;
      el.legC.style.display = L.gs.indexOf("C")>=0 ? "" : "none";
      el.legD.style.display = L.gs.indexOf("D")>=0 ? "" : "none";
      el.sheet.style.setProperty("--cols", L.total);
      el.sheet.innerHTML = "";

      var header = document.createElement("div");
      header.className = "tee-grid tee-header";
      header.appendChild(document.createElement("div"));
      var within = {A:0,B:0,C:0,D:0};
      L.cols.forEach(function(g){
        within[g]++;
        var h = document.createElement("div");
        h.className = "col-title";
        h.textContent = g+"-"+within[g];
        header.appendChild(h);
      });
      el.sheet.appendChild(header);

      var ghead = document.createElement("div");
      ghead.className = "tee-grid";
      ghead.appendChild(document.createElement("div"));
      L.gs.forEach(function(g){
        var cell = document.createElement("div");
        cell.className = "group-title";
        cell.textContent = t("course") + " " + g;
        if(g==="A") cell.style.background = "#d9f99d";
        if(g==="B") cell.style.background = "#bae6fd";
        if(g==="C") cell.style.background = "#fde68a";
        if(g==="D") cell.style.background = "#ddd6fe";
        cell.style.gridColumn = "span "+L.per;
        ghead.appendChild(cell);
      });
      el.sheet.appendChild(ghead);

      var startM = minutes(el.start.value), endM = minutes(el.end.value), step = +el.interval.value;
      var day = getDay(el.date.value);

      for(var m = startM; m <= endM; m += step){
        var row = document.createElement("div");
        row.className = "tee-grid";
        var label = hhmm(m);
        var tCell = document.createElement("div");
        tCell.className = "time-cell mono";
        tCell.textContent = label;
        row.appendChild(tCell);

        var count = {A:0,B:0,C:0,D:0};
        L.cols.forEach(function(g, idx){
          count[g]++;
          var slot = document.createElement("div");
          slot.className = "slot"+(count[g]===1?" group-boundary":"");
          slot.dataset.group = g;
          slot.dataset.tee = count[g];
          slot.dataset.time = label;
          slot.dataset.col = String(idx);

          day.filter(function(b){ return b.time===slot.dataset.time && b.col===idx; }).forEach(function(b){
            slot.appendChild(pill(b));
          });

          slot.addEventListener("click", function(e){
            if(e.target.closest(".pill")) return;
            openDlg({ id:"", golfers: [], bookingType: "regular", course: slot.dataset.group, tee: parseInt(slot.dataset.tee,10)||1, time: slot.dataset.time, col: parseInt(slot.dataset.col,10)||0, notes:"" });
          });
          slot.addEventListener("dragover", function(e){ e.preventDefault(); });
          slot.addEventListener("drop", function(e){
            e.preventDefault();
            var id = e.dataTransfer.getData("text/id"); if(!id) return;
            var data = getDay(el.date.value);
            var i = data.findIndex(function(x){ return x.id===id; }); if(i<0) return;
            data[i].time = slot.dataset.time;
            data[i].col  = parseInt(slot.dataset.col,10) || 0;
            data[i].course = slot.dataset.group;
            data[i].tee = parseInt(slot.dataset.tee,10) || 1;
            setDay(el.date.value, data); render();
          });

          row.appendChild(slot);
        });

        el.sheet.appendChild(row);
      }

      computeMatches(el.q.value||"");
    }

    // ==================== PILL ====================
    function pill(b){
      var p = document.createElement("div");
      var pillClass = "pill";
      if (b.bookingType === "vip") pillClass += " vip";
      else if (b.bookingType === "society") pillClass += " society";
      else if (b.bookingType === "tournament") pillClass += " tournament";
      p.className = pillClass;
      p.draggable = true;
      p.dataset.id = b.id;

      var golfers = b.golfers || [];
      var displayName = golfers.length > 0 ? golfers[0].name : (b.name || t("player"));
      var playerCount = golfers.length > 1 ? " +" + (golfers.length - 1) : "";
      var caddyInfo = "";
      if (golfers.length > 0 && golfers[0].caddyNumber) {
        caddyInfo = " ‚Ä¢ C" + golfers[0].caddyNumber;
      } else if (b.caddyNumber) {
        caddyInfo = " ‚Ä¢ C" + b.caddyNumber;
      }

      var typeLabel = b.bookingType && b.bookingType !== "regular" ? "[" + b.bookingType.toUpperCase() + "] " : "";
      p.innerHTML = "<strong>" + typeLabel + displayName + playerCount + "</strong><br><span style='font-size:11px'>" + b.course + "-" + (b.tee||1) + caddyInfo + " ‚Ä¢ " + b.time + "</span>";

      p.addEventListener("dragstart", function(e){ e.dataTransfer.setData("text/id", b.id); });
      p.addEventListener("click", function(e){ openDlg(b); e.stopPropagation(); });
      return p;
    }

    // ==================== DIALOG ====================
    function openDlg(seed){
      el.id.value = seed.id || "";
      el.type.value = seed.bookingType || "regular";
      el.course.value = seed.course || "A";
      el.teeNo.value = String(seed.tee || 1);
      el.from.value = seed.time || "";
      el.to.value = seed.time || "";
      el.apply.checked = false;
      el.notes.value = seed.notes || "";

      // Handle golfers - support both old format (name, caddyNumber) and new format (golfers array)
      var golfers = seed.golfers || [];
      if (golfers.length === 0 && seed.name) {
        golfers = [{ name: seed.name, caddyNumber: seed.caddyNumber || "", caddyId: null, caddyName: "" }];
      }
      if (golfers.length === 0) {
        golfers = [{ name: "", caddyNumber: "", caddyId: null, caddyName: "" }];
      }
      setGolfersInDialog(golfers);

      el.delBtn.style.display = seed.id ? "" : "none";
      if(el.dlg.showModal) el.dlg.showModal(); else el.dlg.setAttribute("open","");
    }

    function closeDlg(){ if(el.dlg.close) el.dlg.close(); else el.dlg.removeAttribute("open"); }
    el.closeBtn.addEventListener("click", closeDlg);

    function aligned(from,to,step,start,end){
      function mins(hm){ var a=hm.split(":").map(Number); return a[0]*60+a[1]; }
      function tohm(min){ return pad2(Math.floor(min/60))+":"+pad2(min%60); }
      var a=mins(from||""), b=mins(to||""); if(isNaN(a)||isNaN(b)) return [];
      if(b<a){ var temp=a;a=b;b=temp; }
      var s=mins(start), e=mins(end); a=Math.max(a,s); b=Math.min(b,e); if(b<a) return [];
      var off=(a-s)%step; if(off!==0) a+=(step-off);
      var out=[]; for(var m=a;m<=b;m+=step) out.push(tohm(m)); return out;
    }

    el.saveBtn.addEventListener("click", function(e){
      e.preventDefault();
      var date = el.date.value || todayISO();
      var arr = getDay(date);
      var L = layout();
      var course = el.course.value;
      var tee = Math.max(1, Math.min(2, parseInt(el.teeNo.value||"1",10)));
      var bookingType = el.type.value;
      var applyAll = !!el.apply.checked;
      var step = +el.interval.value;
      var times = aligned(el.from.value, el.to.value, step, el.start.value, el.end.value);
      if(!times.length){ alert(t("noTimes")); return; }

      var golfers = getGolfersFromDialog();
      if (golfers.length === 0) {
        golfers = [{ name: t("player"), caddyNumber: "", caddyId: null, caddyName: "" }];
      }

      var colIndex = 0, count = {A:0,B:0,C:0,D:0};
      for(var i=0;i<L.cols.length;i++){ var g=L.cols[i]; count[g]++; if(g===course && count[g]===tee){ colIndex=i; break; } }

      function upsertAt(t, seedId, copy){
        var idx = arr.findIndex(function(x){ return x.time===t && x.col===colIndex; });
        var base = { id: seedId || genId(), course:course, tee:tee, time:t, col:colIndex, golfers:[], bookingType:"regular", notes:"" };
        var payload = base;
        if(copy){
          payload = Object.assign({}, base, {
            golfers: golfers,
            bookingType: bookingType,
            notes: el.notes.value.trim(),
            // Keep legacy fields for backward compatibility
            name: golfers[0] ? golfers[0].name : "",
            caddyNumber: golfers[0] ? golfers[0].caddyNumber : ""
          });
        }
        if(idx>=0){
          if(copy){ arr[idx] = Object.assign({}, arr[idx], payload, {id:arr[idx].id}); }
          return arr[idx] && arr[idx].id || payload.id;
        }
        else { arr.push(payload); return payload.id; }
      }

      if(times.length===1){
        var id = el.id.value || null;
        var idx = id ? arr.findIndex(function(x){ return x.id===id; }) : -1;
        if(idx>=0){
          arr[idx] = Object.assign({}, arr[idx], {
            golfers: golfers,
            bookingType: bookingType,
            course: course,
            tee: tee,
            time: times[0],
            col: colIndex,
            notes: el.notes.value.trim(),
            name: golfers[0] ? golfers[0].name : "",
            caddyNumber: golfers[0] ? golfers[0].caddyNumber : ""
          });
        } else {
          upsertAt(times[0], null, true);
        }
      } else {
        upsertAt(times[0], el.id.value||null, true);
        for(var j=1;j<times.length;j++) upsertAt(times[j], null, applyAll);
      }

      setDay(date, arr); closeDlg(); render();
    });

    el.delBtn.addEventListener("click", function(){
      var date = el.date.value || todayISO();
      var arr = getDay(date).filter(function(x){ return x.id !== el.id.value; });
      setDay(date, arr); closeDlg(); render();
    });

    // ==================== DATE CONTROLS ====================
    el.prev.addEventListener("click", function(){ var d=parseISO(el.date.value||todayISO()); d.setDate(d.getDate()-1); el.date.value=d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); render(); });
    el.next.addEventListener("click", function(){ var d=parseISO(el.date.value||todayISO()); d.setDate(d.getDate()+1); el.date.value=d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); render(); });
    el.date.addEventListener("change", render);
    el.complex.addEventListener("change", render);
    el.interval.addEventListener("change", render);
    el.start.addEventListener("change", render);
    el.end.addEventListener("change", render);
    el.tees.addEventListener("change", render);
    el.clear.addEventListener("click", function(){
      if(!confirm(t("confirmClear") + " " + el.date.value + "?")) return;
      setDay(el.date.value, []); render();
    });

    // ==================== MONTH PICKER ====================
    var monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    (function buildMonthPicker(){
      el.mpM.innerHTML = monthNames.map(function(n,i){ return "<option value='"+i+"'>"+n+"</option>"; }).join("");
      var base = new Date().getFullYear(), years=[]; for(var y=base-5;y<=base+6;y++) years.push("<option value='"+y+"'>"+y+"</option>");
      el.mpY.innerHTML = years.join("");
    })();
    function renderMonth(year, month){
      Array.from(el.mpGrid.querySelectorAll(".mp-day")).forEach(function(n){ n.remove(); });
      var first = new Date(year, month, 1), firstDow = first.getDay(), daysInMonth = new Date(year, month+1, 0).getDate();
      var prevDays = new Date(year, month, 0).getDate();
      var td = new Date(); var today = td.getFullYear()+"-"+pad2(td.getMonth()+1)+"-"+pad2(td.getDate());
      for(var i=0;i<42;i++){
        var cell = document.createElement("div"); cell.className = "mp-day";
        var iso, muted=false;
        if(i<firstDow){ var d=new Date(year, month-1, prevDays - firstDow + 1 + i); iso=d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); muted=true; }
        else if(i>=firstDow + daysInMonth){ var d2=new Date(year, month+1, i - (firstDow + daysInMonth) + 1); iso=d2.getFullYear()+"-"+pad2(d2.getMonth()+1)+"-"+pad2(d2.getDate()); muted=true; }
        else { var d3=new Date(year, month, i - firstDow + 1); iso=d3.getFullYear()+"-"+pad2(d3.getMonth()+1)+"-"+pad2(d3.getDate()); }
        cell.textContent = String(new Date(iso).getDate());
        if(muted) cell.classList.add("muted");
        if(iso === today) cell.classList.add("today");
        (function(finalISO){ cell.addEventListener("click", function(){ el.date.value = finalISO; render(); el.mp.close(); }); })(iso);
        el.mpGrid.appendChild(cell);
      }
    }
    el.openMonth.addEventListener("click", function(){ var cur=parseISO(el.date.value||todayISO()); el.mpM.value=String(cur.getMonth()); el.mpY.value=String(cur.getFullYear()); renderMonth(cur.getFullYear(), cur.getMonth()); if(el.mp.showModal) el.mp.showModal(); else el.mp.setAttribute("open",""); });
    el.mpPrev.addEventListener("click", function(){ var y=parseInt(el.mpY.value,10), m=parseInt(el.mpM.value,10); var d=new Date(y, m-1, 1); el.mpY.value=String(d.getFullYear()); el.mpM.value=String(d.getMonth()); renderMonth(d.getFullYear(), d.getMonth()); });
    el.mpNext.addEventListener("click", function(){ var y=parseInt(el.mpY.value,10), m=parseInt(el.mpM.value,10); var d=new Date(y, m+1, 1); el.mpY.value=String(d.getFullYear()); el.mpM.value=String(d.getMonth()); renderMonth(d.getFullYear(), d.getMonth()); });
    el.mpM.addEventListener("change", function(){ renderMonth(parseInt(el.mpY.value,10), parseInt(el.mpM.value,10)); });
    el.mpY.addEventListener("change", function(){ renderMonth(parseInt(el.mpY.value,10), parseInt(el.mpM.value,10)); });

    // ==================== SEARCH ====================
    var state = { ids:[], idx:0 };
    function computeMatches(q){
      var data = getDay(el.date.value || todayISO());
      var needle = (q||"").trim().toLowerCase(); if(!needle){ state.ids=[]; state.idx=0; el.qCount.textContent="0"; return; }
      state.ids = data.filter(function(b){
        // Search in golfers array
        var golfers = b.golfers || [];
        var matchGolfer = golfers.some(function(g) {
          return (g.name || "").toLowerCase().indexOf(needle) >= 0 ||
                 (g.caddyNumber || "").toLowerCase().indexOf(needle) >= 0;
        });
        // Also search legacy fields
        var name = (b.name||"").toLowerCase();
        var c = (b.caddyNumber||"").toLowerCase();
        return matchGolfer || name.indexOf(needle)>=0 || c.indexOf(needle)>=0;
      }).sort(function(a,b){
        var da = minutes(a.time||"00:00"), db = minutes(b.time||"00:00");
        if(da!==db) return da-db; return (a.col||0)-(b.col||0);
      }).map(function(b){ return b.id; });
      el.qCount.textContent = String(state.ids.length||0);
    }
    function jump(id){
      if(!id) return;
      var data = getDay(el.date.value || todayISO());
      var rec = data.find(function(r){ return r.id===id; }); if(!rec) return;
      var slot = document.querySelector('#v11-sheet .slot[data-time="'+rec.time+'"][data-col="'+rec.col+'"]');
      if(!slot) return;
      slot.style.outline="2px solid #10b981";
      slot.scrollIntoView({behavior:"smooth", block:"center", inline:"center"});
      setTimeout(function(){ slot.style.outline=""; }, 1600);
    }
    el.qGo.addEventListener("click", function(e){ e.preventDefault(); computeMatches(el.q.value||""); if(state.ids.length){ jump(state.ids[0]); } else { alert(t("noMatches")); } });
    el.qNext.addEventListener("click", function(e){ e.preventDefault(); if(!state.ids.length){ el.qGo.click(); return; } state.idx=(state.idx+1)%state.ids.length; jump(state.ids[state.idx]); });
    el.q.addEventListener("keydown", function(e){ if(e.key==="Enter"){ e.preventDefault(); el.qGo.click(); } });

    // ==================== INIT ====================
    applyTranslations();
    render();
  })();
  </script>
</body>
</html>
