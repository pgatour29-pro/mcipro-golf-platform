<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MciPro Tee Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
  <style>
    :root{--bg:#f8fafc;--card:#fff;--ink:#111827;--muted:#6b7280;--brand:#7c3aed;--border:rgba(0,0,0,.1);--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--blue:#3b82f6}
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;font-size:14px}

    /* Header - Two Row Layout */
    .header{padding:16px 20px;background:#fff;border-bottom:1px solid var(--border)}
    .header-row{display:flex;align-items:center;gap:20px;flex-wrap:wrap}
    .header-row:first-child{margin-bottom:12px}
    .header h1{font-size:20px;font-weight:700;color:#1e1b4b;margin-right:20px}
    .header-controls{display:flex;gap:16px;align-items:flex-end;flex-wrap:wrap}
    .control-group{display:flex;flex-direction:column;min-width:80px}
    .control-group label{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}

    /* Form elements */
    input,select,textarea{border:1px solid var(--border);border-radius:8px;padding:10px 12px;background:#fff;color:var(--ink);font-size:14px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(124,58,237,0.1)}
    button{border:1px solid var(--border);background:#f3f4f6;border-radius:8px;padding:10px 16px;cursor:pointer;font-size:14px;font-weight:500;display:inline-flex;align-items:center;gap:6px}
    button:hover{background:#e5e7eb}
    .btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn-primary:hover{background:#6d28d9}
    .btn-danger{background:#fee2e2;color:#dc2626;border-color:#fca5a5}
    .btn-danger:hover{background:#fecaca}
    .icon-btn{width:40px;height:40px;padding:0;display:inline-flex;align-items:center;justify-content:center;font-size:18px}

    /* Grid */
    .sheet-container{padding:16px;overflow-x:auto}
    .tee-grid{display:grid;grid-template-columns:90px repeat(var(--cols,3),minmax(180px,1fr));gap:1px;background:var(--border)}
    .tee-grid>*{background:#fff}
    .time-cell{padding:12px 8px;text-align:center;font-size:14px;font-weight:700;color:#374151;position:sticky;left:0;z-index:2;background:#f9fafb;border-right:2px solid #e5e7eb}
    .course-header{padding:14px;text-align:center;font-weight:700;font-size:14px;position:sticky;top:0;z-index:3}
    .course-a{background:#dcfce7;color:#166534}
    .course-b{background:#dbeafe;color:#1e40af}
    .course-c{background:#fef3c7;color:#92400e}
    .course-d{background:#ede9fe;color:#5b21b6}

    /* Slots - Taller with better spacing */
    .slot{min-height:70px;padding:6px;position:relative;cursor:pointer;transition:background 0.15s;border-bottom:1px solid #f3f4f6}
    .slot:hover{background:#f8fafc}
    .slot.drag-over{background:#ede9fe;outline:2px dashed var(--brand)}
    .slot.locked{background:#fef2f2;cursor:not-allowed}
    .slot.locked::after{content:'üîí';position:absolute;top:4px;right:4px;font-size:10px}

    /* Booking pills */
    .pill{background:#f0fdf4;border:1px solid #86efac;border-radius:8px;padding:6px 8px;margin:2px;font-size:12px;cursor:grab;transition:transform 0.1s,box-shadow 0.1s}
    .pill:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .pill.dragging{opacity:0.5}
    .pill.vip{background:#fef3c7;border-color:#fcd34d}
    .pill.society{background:#dbeafe;border-color:#93c5fd}
    .pill.tournament{background:#ede9fe;border-color:#c4b5fd}
    .pill-name{font-weight:600;color:#1f2937}
    .pill-info{font-size:11px;color:var(--muted);margin-top:2px}
    .pill-caddy{font-size:11px;color:#059669;margin-top:2px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:100;display:none;align-items:center;justify-content:center;padding:20px}
    .modal-backdrop.open{display:flex}
    .modal{background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);width:100%;max-width:700px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
    .modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:#f9fafb}
    .modal-header h2{font-size:16px;font-weight:700}
    .modal-body{padding:20px;overflow-y:auto;flex:1}
    .modal-footer{padding:16px 20px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;background:#f9fafb}

    /* Golfer rows */
    .golfer-section{margin-bottom:16px}
    .golfer-row{display:grid;grid-template-columns:1fr 80px 1fr;gap:10px;padding:12px;background:#f9fafb;border-radius:10px;margin-bottom:8px;align-items:end}
    .golfer-row.empty{opacity:0.5}
    .golfer-number{font-size:11px;color:var(--muted);margin-bottom:4px}

    /* Caddy selector */
    .caddy-select{position:relative}
    .caddy-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);max-height:200px;overflow-y:auto;z-index:10;display:none}
    .caddy-dropdown.open{display:block}
    .caddy-option{padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;border-bottom:1px solid #f3f4f6}
    .caddy-option:hover{background:#f3f4f6}
    .caddy-option.selected{background:#ede9fe}
    .caddy-num{font-weight:700;color:var(--brand);min-width:40px}
    .caddy-name{flex:1}
    .caddy-rating{color:#f59e0b;font-size:12px}
    .caddy-status{font-size:11px;padding:2px 6px;border-radius:4px}
    .caddy-status.available{background:#dcfce7;color:#166534}
    .caddy-status.booked{background:#fee2e2;color:#dc2626}

    /* Booking type pills */
    .type-selector{display:flex;gap:6px;margin-bottom:16px}
    .type-btn{padding:8px 16px;border-radius:20px;border:2px solid var(--border);background:#fff;cursor:pointer;font-size:12px;font-weight:600}
    .type-btn:hover{border-color:var(--brand)}
    .type-btn.active{border-color:var(--brand);background:var(--brand);color:#fff}
    .type-btn.vip.active{background:#f59e0b;border-color:#f59e0b}
    .type-btn.society.active{background:#3b82f6;border-color:#3b82f6}
    .type-btn.tournament.active{background:#8b5cf6;border-color:#8b5cf6}

    /* Search highlight */
    .slot.highlighted{animation:pulse 1.5s ease-out}
    @keyframes pulse{0%,100%{box-shadow:none}50%{box-shadow:0 0 0 4px rgba(16,185,129,0.4)}}

    /* Legend */
    .legend{display:flex;gap:20px;font-size:13px;color:var(--muted);padding:12px 20px;background:#fff;border-bottom:1px solid var(--border);flex-wrap:wrap}
    .legend-item{display:flex;align-items:center;gap:6px}
    .legend-dot{width:14px;height:14px;border-radius:4px}

    /* Status bar */
    .status-bar{padding:10px 20px;background:#f0fdf4;border-bottom:1px solid #86efac;font-size:13px;color:#166534;display:none}
    .status-bar.connected{display:block}

    /* Responsive */
    @media(max-width:900px){
      .header-row{flex-direction:column;align-items:stretch;gap:12px}
      .header-controls{justify-content:flex-start}
      .header-controls[style*="margin-left:auto"]{margin-left:0!important}
    }
    @media(max-width:640px){
      .control-group{min-width:100%}
      .golfer-row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <!-- Status bar for MciPro connection -->
  <div class="status-bar" id="statusBar">‚úì Connected to MciPro</div>

  <!-- Header -->
  <div class="header">
    <!-- Row 1: Title, Date, Language -->
    <div class="header-row">
      <h1 id="mainTitle">Tee Sheet</h1>
      <div class="header-controls">
        <div class="control-group">
          <label id="lblDate">DATE</label>
          <div style="display:flex;gap:6px;align-items:center">
            <button class="icon-btn" id="prevDay" title="Previous day">‚Äπ</button>
            <input type="date" id="dateInput" style="width:150px">
            <button class="icon-btn" id="nextDay" title="Next day">‚Ä∫</button>
          </div>
        </div>
      </div>
      <div class="header-controls" style="margin-left:auto">
        <div class="control-group">
          <label>üåê LANGUAGE</label>
          <select id="langSelect" style="width:100px">
            <option value="en">English</option>
            <option value="th">‡πÑ‡∏ó‡∏¢</option>
            <option value="ko">ÌïúÍµ≠Ïñ¥</option>
            <option value="ja">Êó•Êú¨Ë™û</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Row 2: Course Settings -->
    <div class="header-row">
      <div class="header-controls">
        <div class="control-group">
          <label id="lblCourseLayout">COURSE LAYOUT</label>
          <select id="complexSelect" style="width:160px">
            <option value="18" id="opt18">18 holes (A/B)</option>
            <option value="27" id="opt27">27 holes (A/B/C)</option>
            <option value="36" id="opt36">36 holes (A/B/C/D)</option>
          </select>
        </div>
        <div class="control-group">
          <label id="lblStart">START</label>
          <input type="time" id="startTime" value="06:00" style="width:110px">
        </div>
        <div class="control-group">
          <label id="lblEnd">END</label>
          <input type="time" id="endTime" value="18:00" style="width:110px">
        </div>
        <div class="control-group">
          <label id="lblInterval">INTERVAL</label>
          <select id="intervalSelect" style="width:100px">
            <option value="7">7 min</option>
            <option value="8">8 min</option>
            <option value="10" selected>10 min</option>
            <option value="12">12 min</option>
            <option value="15">15 min</option>
          </select>
        </div>
        <div class="control-group">
          <label id="lblTeesPerCourse">TEES/COURSE</label>
          <select id="teesSelect" style="width:80px">
            <option value="1">1</option>
            <option value="2" selected>2</option>
          </select>
        </div>
      </div>
      <div class="header-controls" style="margin-left:auto">
        <div class="control-group">
          <label id="lblSearch">SEARCH</label>
          <div style="display:flex;gap:6px">
            <input type="text" id="searchInput" placeholder="Golfer or caddy..." style="width:180px">
            <button id="searchBtn">Find</button>
            <button id="searchNextBtn">Next</button>
          </div>
        </div>
        <button class="btn-danger" id="clearDayBtn" style="align-self:flex-end">Clear Day</button>
      </div>
    </div>
  </div>

  <!-- Legend -->
  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:#dcfce7"></div> <span id="legCourseA">Course A</span></div>
    <div class="legend-item"><div class="legend-dot" style="background:#dbeafe"></div> <span id="legCourseB">Course B</span></div>
    <div class="legend-item" id="legC"><div class="legend-dot" style="background:#fef3c7"></div> <span id="legCourseC">Course C</span></div>
    <div class="legend-item" id="legD" style="display:none"><div class="legend-dot" style="background:#ede9fe"></div> <span id="legCourseD">Course D</span></div>
    <div style="margin-left:auto;display:flex;gap:12px">
      <div class="legend-item"><div class="legend-dot" style="background:#f0fdf4;border:1px solid #86efac"></div> <span id="legRegular">Regular</span></div>
      <div class="legend-item"><div class="legend-dot" style="background:#fef3c7;border:1px solid #fcd34d"></div> <span id="legVip">VIP</span></div>
      <div class="legend-item"><div class="legend-dot" style="background:#dbeafe;border:1px solid #93c5fd"></div> <span id="legSociety">Society</span></div>
      <div class="legend-item"><div class="legend-dot" style="background:#ede9fe;border:1px solid #c4b5fd"></div> <span id="legTournament">Tournament</span></div>
    </div>
  </div>

  <!-- Tee Sheet Grid -->
  <div class="sheet-container">
    <div id="teeSheet" class="tee-grid"></div>
  </div>

  <!-- Booking Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">Book Tee Time</h2>
        <button class="icon-btn" id="closeModal">‚úï</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="bookingId">
        <input type="hidden" id="bookingSlot">

        <!-- Slot Info -->
        <div style="display:flex;gap:16px;margin-bottom:16px;padding:12px;background:#f9fafb;border-radius:8px">
          <div><label id="lblTime">Time</label><div id="slotTime" style="font-weight:600">--:--</div></div>
          <div><label id="lblCourse">Course</label><div id="slotCourse" style="font-weight:600">-</div></div>
          <div><label id="lblTee">Tee</label><div id="slotTee" style="font-weight:600">-</div></div>
        </div>

        <!-- Booking Type -->
        <div>
          <label id="lblBookingType" style="margin-bottom:8px">Booking Type</label>
          <div class="type-selector">
            <button type="button" class="type-btn active" data-type="regular" id="btnRegular">Regular</button>
            <button type="button" class="type-btn vip" data-type="vip" id="btnVip">VIP</button>
            <button type="button" class="type-btn society" data-type="society" id="btnSociety">Society</button>
            <button type="button" class="type-btn tournament" data-type="tournament" id="btnTournament">Tournament</button>
          </div>
        </div>

        <!-- Golfers -->
        <div class="golfer-section">
          <label id="lblGolfersAndCaddies" style="margin-bottom:8px">Golfers & Caddies (up to 4)</label>
          <div id="golferRows"></div>
        </div>

        <!-- Notes -->
        <div>
          <label id="lblNotes">Notes</label>
          <textarea id="bookingNotes" rows="2" style="width:100%" placeholder="Special requests, group info..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-danger" id="deleteBooking" style="display:none">Delete Booking</button>
        <button id="cancelBooking">Cancel</button>
        <button class="btn-primary" id="saveBooking">Save Booking</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    "use strict";

    // ============= TRANSLATIONS =============
    const TRANSLATIONS = {
      en: {
        title: 'Tee Sheet',
        date: 'Date',
        courseLayout: 'Course Layout',
        start: 'Start',
        end: 'End',
        interval: 'Interval',
        teesPerCourse: 'Tees/Course',
        search: 'Search',
        searchPlaceholder: 'Golfer or caddy...',
        find: 'Find',
        next: 'Next',
        clearDay: 'Clear Day',
        holes18: '18 holes (A/B)',
        holes27: '27 holes (A/B/C)',
        holes36: '36 holes (A/B/C/D)',
        min: 'min',
        courseA: 'Course A',
        courseB: 'Course B',
        courseC: 'Course C',
        courseD: 'Course D',
        regular: 'Regular',
        vip: 'VIP',
        society: 'Society',
        tournament: 'Tournament',
        bookTeeTime: 'Book Tee Time',
        editBooking: 'Edit Booking',
        time: 'Time',
        course: 'Course',
        tee: 'Tee',
        bookingType: 'Booking Type',
        golfersAndCaddies: 'Golfers & Caddies (up to 4)',
        golfer: 'Golfer',
        name: 'Name',
        handicap: 'Handicap',
        caddy: 'Caddy',
        searchCaddy: 'Search caddy...',
        noCaddy: 'No caddy',
        caddies: 'Caddies',
        notes: 'Notes',
        notesPlaceholder: 'Special requests, group info...',
        cancel: 'Cancel',
        saveBooking: 'Save Booking',
        deleteBooking: 'Delete Booking',
        confirmClear: 'Clear all bookings for',
        confirmDelete: 'Delete this booking?',
        noMatches: 'No matches found',
        addGolfer: 'Please add at least one golfer',
        connected: 'Connected to MciPro',
        prevDay: 'Previous day',
        nextDay: 'Next day',
        emptySlot: 'Empty slot'
      },
      th: {
        title: '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡∏≠‡∏≠‡∏ü',
        date: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà',
        courseLayout: '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏ô‡∏≤‡∏°',
        start: '‡πÄ‡∏£‡∏¥‡πà‡∏°',
        end: '‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î',
        interval: '‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤',
        teesPerCourse: '‡∏ó‡∏µ‡∏≠‡∏≠‡∏ü/‡∏™‡∏ô‡∏≤‡∏°',
        search: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤',
        searchPlaceholder: '‡∏ô‡∏±‡∏Å‡∏Å‡∏≠‡∏•‡πå‡∏ü‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Ñ‡∏î‡∏î‡∏µ‡πâ...',
        find: '‡∏´‡∏≤',
        next: '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ',
        clearDay: '‡∏•‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô',
        holes18: '18 ‡∏´‡∏•‡∏∏‡∏° (A/B)',
        holes27: '27 ‡∏´‡∏•‡∏∏‡∏° (A/B/C)',
        holes36: '36 ‡∏´‡∏•‡∏∏‡∏° (A/B/C/D)',
        min: '‡∏ô‡∏≤‡∏ó‡∏µ',
        courseA: '‡∏™‡∏ô‡∏≤‡∏° A',
        courseB: '‡∏™‡∏ô‡∏≤‡∏° B',
        courseC: '‡∏™‡∏ô‡∏≤‡∏° C',
        courseD: '‡∏™‡∏ô‡∏≤‡∏° D',
        regular: '‡∏õ‡∏Å‡∏ï‡∏¥',
        vip: '‡∏ß‡∏µ‡πÑ‡∏≠‡∏û‡∏µ',
        society: '‡∏™‡∏±‡∏á‡∏Ñ‡∏°',
        tournament: '‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô',
        bookTeeTime: '‡∏à‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡∏≠‡∏≠‡∏ü',
        editBooking: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á',
        time: '‡πÄ‡∏ß‡∏•‡∏≤',
        course: '‡∏™‡∏ô‡∏≤‡∏°',
        tee: '‡∏ó‡∏µ‡∏≠‡∏≠‡∏ü',
        bookingType: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á',
        golfersAndCaddies: '‡∏ô‡∏±‡∏Å‡∏Å‡∏≠‡∏•‡πå‡∏ü‡πÅ‡∏•‡∏∞‡πÅ‡∏Ñ‡∏î‡∏î‡∏µ‡πâ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 4)',
        golfer: '‡∏ô‡∏±‡∏Å‡∏Å‡∏≠‡∏•‡πå‡∏ü',
        name: '‡∏ä‡∏∑‡πà‡∏≠',
        handicap: '‡πÅ‡∏Æ‡∏ô‡∏î‡∏¥‡πÅ‡∏Ñ‡∏õ',
        caddy: '‡πÅ‡∏Ñ‡∏î‡∏î‡∏µ‡πâ',
        searchCaddy: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏Ñ‡∏î‡∏î‡∏µ‡πâ...',
        noCaddy: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏Ñ‡∏î‡∏î‡∏µ‡πâ',
        caddies: '‡πÅ‡∏Ñ‡∏î‡∏î‡∏µ‡πâ',
        notes: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏',
        notesPlaceholder: '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°...',
        cancel: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        saveBooking: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á',
        deleteBooking: '‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á',
        confirmClear: '‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö',
        confirmDelete: '‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        noMatches: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
        addGolfer: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏Å‡∏≠‡∏•‡πå‡∏ü‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô',
        connected: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö MciPro ‡πÅ‡∏•‡πâ‡∏ß',
        prevDay: '‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤',
        nextDay: '‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ',
        emptySlot: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á'
      },
      ko: {
        title: 'Ìã∞ ÏãúÌä∏',
        date: 'ÎÇ†Ïßú',
        courseLayout: 'ÏΩîÏä§ Î†àÏù¥ÏïÑÏõÉ',
        start: 'ÏãúÏûë',
        end: 'Ï¢ÖÎ£å',
        interval: 'Í∞ÑÍ≤©',
        teesPerCourse: 'Ìã∞/ÏΩîÏä§',
        search: 'Í≤ÄÏÉâ',
        searchPlaceholder: 'Í≥®Ìçº ÎòêÎäî Ï∫êÎîî...',
        find: 'Ï∞æÍ∏∞',
        next: 'Îã§Ïùå',
        clearDay: 'ÏùºÏ†ï ÏÇ≠Ï†ú',
        holes18: '18ÌôÄ (A/B)',
        holes27: '27ÌôÄ (A/B/C)',
        holes36: '36ÌôÄ (A/B/C/D)',
        min: 'Î∂Ñ',
        courseA: 'ÏΩîÏä§ A',
        courseB: 'ÏΩîÏä§ B',
        courseC: 'ÏΩîÏä§ C',
        courseD: 'ÏΩîÏä§ D',
        regular: 'ÏùºÎ∞ò',
        vip: 'VIP',
        society: 'Îã®Ï≤¥',
        tournament: 'ÌÜ†ÎÑàÎ®ºÌä∏',
        bookTeeTime: 'Ìã∞ ÌÉÄÏûÑ ÏòàÏïΩ',
        editBooking: 'ÏòàÏïΩ ÏàòÏ†ï',
        time: 'ÏãúÍ∞Ñ',
        course: 'ÏΩîÏä§',
        tee: 'Ìã∞',
        bookingType: 'ÏòàÏïΩ Ïú†Ìòï',
        golfersAndCaddies: 'Í≥®Ìçº Î∞è Ï∫êÎîî (ÏµúÎåÄ 4Î™Ö)',
        golfer: 'Í≥®Ìçº',
        name: 'Ïù¥Î¶Ñ',
        handicap: 'Ìï∏ÎîîÏ∫°',
        caddy: 'Ï∫êÎîî',
        searchCaddy: 'Ï∫êÎîî Í≤ÄÏÉâ...',
        noCaddy: 'Ï∫êÎîî ÏóÜÏùå',
        caddies: 'Ï∫êÎîî',
        notes: 'Î©îÎ™®',
        notesPlaceholder: 'ÌäπÎ≥Ñ ÏöîÏ≤≠, Í∑∏Î£π Ï†ïÎ≥¥...',
        cancel: 'Ï∑®ÏÜå',
        saveBooking: 'ÏòàÏïΩ Ï†ÄÏû•',
        deleteBooking: 'ÏòàÏïΩ ÏÇ≠Ï†ú',
        confirmClear: 'Î™®Îì† ÏòàÏïΩÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?',
        confirmDelete: 'Ïù¥ ÏòàÏïΩÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?',
        noMatches: 'Í≤ÄÏÉâ Í≤∞Í≥º ÏóÜÏùå',
        addGolfer: 'Í≥®ÌçºÎ•º Ìïú Î™Ö Ïù¥ÏÉÅ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî',
        connected: 'MciProÏóê Ïó∞Í≤∞Îê®',
        prevDay: 'Ïù¥Ï†Ñ ÎÇ†',
        nextDay: 'Îã§Ïùå ÎÇ†',
        emptySlot: 'Îπà Ïä¨Î°Ø'
      },
      ja: {
        title: '„ÉÜ„Ç£„Éº„Ç∑„Éº„Éà',
        date: 'Êó•‰ªò',
        courseLayout: '„Ç≥„Éº„Çπ„É¨„Ç§„Ç¢„Ç¶„Éà',
        start: 'ÈñãÂßã',
        end: 'ÁµÇ‰∫Ü',
        interval: 'ÈñìÈöî',
        teesPerCourse: '„ÉÜ„Ç£„Éº/„Ç≥„Éº„Çπ',
        search: 'Ê§úÁ¥¢',
        searchPlaceholder: '„Ç¥„É´„Éï„Ç°„Éº„Åæ„Åü„ÅØ„Ç≠„É£„Éá„Ç£...',
        find: 'Ê§úÁ¥¢',
        next: 'Ê¨°„Å∏',
        clearDay: '‰∫àÁ¥Ñ„Çí„ÇØ„É™„Ç¢',
        holes18: '18„Éõ„Éº„É´ (A/B)',
        holes27: '27„Éõ„Éº„É´ (A/B/C)',
        holes36: '36„Éõ„Éº„É´ (A/B/C/D)',
        min: 'ÂàÜ',
        courseA: '„Ç≥„Éº„Çπ A',
        courseB: '„Ç≥„Éº„Çπ B',
        courseC: '„Ç≥„Éº„Çπ C',
        courseD: '„Ç≥„Éº„Çπ D',
        regular: 'ÈÄöÂ∏∏',
        vip: 'VIP',
        society: 'Âõ£‰Ωì',
        tournament: '„Éà„Éº„Éä„É°„É≥„Éà',
        bookTeeTime: '„ÉÜ„Ç£„Éº„Çø„Ç§„É†‰∫àÁ¥Ñ',
        editBooking: '‰∫àÁ¥ÑÁ∑®ÈõÜ',
        time: 'ÊôÇÈñì',
        course: '„Ç≥„Éº„Çπ',
        tee: '„ÉÜ„Ç£„Éº',
        bookingType: '‰∫àÁ¥Ñ„Çø„Ç§„Éó',
        golfersAndCaddies: '„Ç¥„É´„Éï„Ç°„ÉºÔºÜ„Ç≠„É£„Éá„Ç£ (ÊúÄÂ§ß4Âêç)',
        golfer: '„Ç¥„É´„Éï„Ç°„Éº',
        name: 'ÂêçÂâç',
        handicap: '„Éè„É≥„Éá„Ç£„Ç≠„É£„ÉÉ„Éó',
        caddy: '„Ç≠„É£„Éá„Ç£',
        searchCaddy: '„Ç≠„É£„Éá„Ç£„ÇíÊ§úÁ¥¢...',
        noCaddy: '„Ç≠„É£„Éá„Ç£„Å™„Åó',
        caddies: '„Ç≠„É£„Éá„Ç£',
        notes: '„É°„É¢',
        notesPlaceholder: 'ÁâπÂà•„É™„ÇØ„Ç®„Çπ„Éà„ÄÅ„Ç∞„É´„Éº„ÉóÊÉÖÂ†±...',
        cancel: '„Ç≠„É£„É≥„Çª„É´',
        saveBooking: '‰∫àÁ¥Ñ„Çí‰øùÂ≠ò',
        deleteBooking: '‰∫àÁ¥Ñ„ÇíÂâäÈô§',
        confirmClear: '„Åô„Åπ„Å¶„ÅÆ‰∫àÁ¥Ñ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü',
        confirmDelete: '„Åì„ÅÆ‰∫àÁ¥Ñ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü',
        noMatches: 'Ë©≤ÂΩì„Å™„Åó',
        addGolfer: '„Ç¥„É´„Éï„Ç°„Éº„Çí1Âêç‰ª•‰∏äËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
        connected: 'MciPro„Å´Êé•Á∂öÊ∏à„Åø',
        prevDay: 'ÂâçÊó•',
        nextDay: 'ÁøåÊó•',
        emptySlot: 'Á©∫„Åç„Çπ„É≠„ÉÉ„Éà'
      }
    };

    let currentLang = 'en';
    function t(key) { return TRANSLATIONS[currentLang][key] || TRANSLATIONS.en[key] || key; }

    // ============= CADDY DATA =============
    const CADDIES = [
      { id: 'c001', number: '001', name: 'Somchai', rating: 4.8, languages: ['Thai', 'English'], status: 'available' },
      { id: 'c002', number: '002', name: 'Sunan', rating: 4.7, languages: ['Thai', 'English', 'German'], status: 'available' },
      { id: 'c003', number: '003', name: 'Niran', rating: 4.6, languages: ['Thai', 'English', 'Japanese'], status: 'available' },
      { id: 'c004', number: '004', name: 'Ploy', rating: 4.9, languages: ['Thai', 'English'], status: 'available' },
      { id: 'c005', number: '005', name: 'Anuwat', rating: 4.5, languages: ['Thai', 'English', 'Russian'], status: 'booked' },
      { id: 'c006', number: '006', name: 'Kanya', rating: 4.8, languages: ['Thai', 'English', 'Korean'], status: 'available' },
      { id: 'c007', number: '007', name: 'Mali', rating: 4.9, languages: ['Thai', 'English'], status: 'available' },
      { id: 'c008', number: '008', name: 'Chai', rating: 4.4, languages: ['Thai', 'English'], status: 'available' },
      { id: 'c009', number: '009', name: 'Noi', rating: 4.7, languages: ['Thai', 'English', 'Chinese'], status: 'booked' },
      { id: 'c010', number: '010', name: 'Benz', rating: 4.3, languages: ['Thai', 'English'], status: 'available' },
      { id: 'c011', number: '011', name: 'Lek', rating: 4.8, languages: ['Thai', 'Korean', 'English'], status: 'available' },
      { id: 'c012', number: '012', name: 'Porn', rating: 4.7, languages: ['Thai', 'Korean'], status: 'available' },
      { id: 'c013', number: '013', name: 'Malee', rating: 4.5, languages: ['Thai', 'English'], status: 'available' },
      { id: 'c014', number: '014', name: 'Jin', rating: 4.4, languages: ['Thai', 'Korean'], status: 'available' },
      { id: 'c015', number: '015', name: 'Oy', rating: 4.6, languages: ['Thai', 'Japanese'], status: 'available' },
      { id: 'c016', number: '016', name: 'Fah', rating: 4.8, languages: ['Thai', 'English', 'French'], status: 'available' },
      { id: 'c017', number: '017', name: 'Dao', rating: 4.5, languages: ['Thai', 'English'], status: 'available' },
      { id: 'c018', number: '018', name: 'Wat', rating: 4.6, languages: ['Thai', 'English'], status: 'available' },
      { id: 'c019', number: '019', name: 'Pim', rating: 4.9, languages: ['Thai', 'English', 'Japanese'], status: 'available' },
      { id: 'c020', number: '020', name: 'Tong', rating: 4.4, languages: ['Thai', 'English'], status: 'available' }
    ];

    // ============= HELPERS =============
    function pad2(n) { return String(n).padStart(2, '0'); }
    function minutes(hm) { const [h, m] = (hm || '').split(':').map(Number); return h * 60 + (m || 0); }
    function toHHMM(m) { return pad2(Math.floor(m / 60)) + ':' + pad2(m % 60); }
    function todayISO() { const d = new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
    function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 9); }

    // ============= STORAGE =============
    const STORAGE_KEY = 'mciproteesheet_v1';

    function getBookings(date) {
      try {
        const data = JSON.parse(localStorage.getItem(`${STORAGE_KEY}::${date}`) || '[]');
        return data;
      } catch (e) { return []; }
    }

    function saveBookings(date, bookings) {
      localStorage.setItem(`${STORAGE_KEY}::${date}`, JSON.stringify(bookings));
      // Notify MciPro if connected
      if (window.MciProBridge && window.MciProBridge.isConnected) {
        window.MciProBridge.syncBookings(date, bookings);
      }
    }

    function getSettings() {
      try {
        return JSON.parse(localStorage.getItem(`${STORAGE_KEY}::settings`) || '{}');
      } catch (e) { return {}; }
    }

    function saveSettings(settings) {
      localStorage.setItem(`${STORAGE_KEY}::settings`, JSON.stringify(settings));
    }

    // ============= DOM ELEMENTS =============
    const $ = id => document.getElementById(id);
    const el = {
      sheet: $('teeSheet'),
      date: $('dateInput'),
      complex: $('complexSelect'),
      start: $('startTime'),
      end: $('endTime'),
      interval: $('intervalSelect'),
      tees: $('teesSelect'),
      search: $('searchInput'),
      searchBtn: $('searchBtn'),
      searchNextBtn: $('searchNextBtn'),
      clearBtn: $('clearDayBtn'),
      prevDay: $('prevDay'),
      nextDay: $('nextDay'),
      legC: $('legC'),
      legD: $('legD'),
      statusBar: $('statusBar'),
      langSelect: $('langSelect'),
      // Modal
      modalBackdrop: $('modalBackdrop'),
      modalTitle: $('modalTitle'),
      closeModal: $('closeModal'),
      bookingId: $('bookingId'),
      bookingSlot: $('bookingSlot'),
      slotTime: $('slotTime'),
      slotCourse: $('slotCourse'),
      slotTee: $('slotTee'),
      golferRows: $('golferRows'),
      bookingNotes: $('bookingNotes'),
      deleteBtn: $('deleteBooking'),
      cancelBtn: $('cancelBooking'),
      saveBtn: $('saveBooking')
    };

    // ============= LANGUAGE FUNCTIONS =============
    function updateLanguage() {
      // Header
      $('mainTitle').textContent = t('title');
      $('lblDate').textContent = t('date');
      $('lblCourseLayout').textContent = t('courseLayout');
      $('lblStart').textContent = t('start');
      $('lblEnd').textContent = t('end');
      $('lblInterval').textContent = t('interval');
      $('lblTeesPerCourse').textContent = t('teesPerCourse');
      $('lblSearch').textContent = t('search');

      el.search.placeholder = t('searchPlaceholder');
      el.searchBtn.textContent = t('find');
      el.searchNextBtn.textContent = t('next');
      el.clearBtn.textContent = t('clearDay');
      el.prevDay.title = t('prevDay');
      el.nextDay.title = t('nextDay');

      // Course layout options
      $('opt18').textContent = t('holes18');
      $('opt27').textContent = t('holes27');
      $('opt36').textContent = t('holes36');

      // Update interval options
      el.interval.querySelectorAll('option').forEach(opt => {
        const val = opt.value;
        opt.textContent = `${val} ${t('min')}`;
      });

      // Legend
      $('legCourseA').textContent = t('courseA');
      $('legCourseB').textContent = t('courseB');
      $('legCourseC').textContent = t('courseC');
      $('legCourseD').textContent = t('courseD');
      $('legRegular').textContent = t('regular');
      $('legVip').textContent = t('vip');
      $('legSociety').textContent = t('society');
      $('legTournament').textContent = t('tournament');

      // Status bar
      el.statusBar.textContent = '‚úì ' + t('connected');

      // Modal
      $('lblTime').textContent = t('time');
      $('lblCourse').textContent = t('course');
      $('lblTee').textContent = t('tee');
      $('lblBookingType').textContent = t('bookingType');
      $('lblGolfersAndCaddies').textContent = t('golfersAndCaddies');
      $('lblNotes').textContent = t('notes');
      el.bookingNotes.placeholder = t('notesPlaceholder');

      // Type buttons
      $('btnRegular').textContent = t('regular');
      $('btnVip').textContent = t('vip');
      $('btnSociety').textContent = t('society');
      $('btnTournament').textContent = t('tournament');

      // Modal footer buttons
      el.deleteBtn.textContent = t('deleteBooking');
      el.cancelBtn.textContent = t('cancel');
      el.saveBtn.textContent = t('saveBooking');

      // Re-render to update pill caddies text and dynamic content
      render();
    }

    function setLanguage(lang) {
      if (TRANSLATIONS[lang]) {
        currentLang = lang;
        el.langSelect.value = lang;
        const settings = getSettings();
        settings.lang = lang;
        saveSettings(settings);
        updateLanguage();
      }
    }

    // ============= STATE =============
    let currentBookingType = 'regular';
    let searchResults = [];
    let searchIndex = 0;
    let draggedBookingId = null;

    // ============= MCIPRO BRIDGE =============
    window.MciProBridge = {
      isConnected: false,
      parent: null,

      init() {
        try {
          if (window.parent && window.parent !== window && window.parent.CaddySystem) {
            this.isConnected = true;
            this.parent = window.parent;
            el.statusBar.classList.add('connected');
            console.log('[TeeSheet] Connected to MciPro');

            // Load caddies from MciPro if available
            if (this.parent.CaddySystem.allCaddys) {
              this.loadCaddies();
            }
            return true;
          }
        } catch (e) {
          console.log('[TeeSheet] Standalone mode');
        }
        return false;
      },

      loadCaddies() {
        // Could update CADDIES array from MciPro's CaddySystem
        // For now using built-in demo caddies
      },

      syncBookings(date, bookings) {
        // Sync to MciPro's BookingManager if available
        if (this.parent && this.parent.BookingManager) {
          console.log('[TeeSheet] Syncing to MciPro BookingManager');
        }
      }
    };

    // ============= LAYOUT =============
    function getCourses() {
      const val = el.complex.value;
      if (val === '18') return ['A', 'B'];
      if (val === '27') return ['A', 'B', 'C'];
      return ['A', 'B', 'C', 'D'];
    }

    function getLayout() {
      const courses = getCourses();
      const teesPerCourse = parseInt(el.tees.value) || 1;
      const cols = [];
      courses.forEach(c => {
        for (let i = 0; i < teesPerCourse; i++) {
          cols.push({ course: c, tee: i + 1 });
        }
      });
      return { courses, teesPerCourse, cols };
    }

    // ============= RENDER =============
    function render() {
      saveSettings({
        complex: el.complex.value,
        start: el.start.value,
        end: el.end.value,
        interval: el.interval.value,
        tees: el.tees.value,
        date: el.date.value
      });

      const layout = getLayout();
      const date = el.date.value;
      const bookings = getBookings(date);
      const startM = minutes(el.start.value);
      const endM = minutes(el.end.value);
      const step = parseInt(el.interval.value) || 10;

      // Update legend
      el.legC.style.display = layout.courses.includes('C') ? '' : 'none';
      el.legD.style.display = layout.courses.includes('D') ? '' : 'none';

      // Set CSS variable for columns
      el.sheet.style.setProperty('--cols', layout.cols.length);
      el.sheet.innerHTML = '';

      // Header row
      const headerRow = document.createElement('div');
      headerRow.className = 'tee-grid';
      headerRow.innerHTML = '<div class="time-cell">Time</div>';
      layout.cols.forEach(col => {
        const cell = document.createElement('div');
        cell.className = `course-header course-${col.course.toLowerCase()}`;
        cell.textContent = `${col.course}-${col.tee}`;
        headerRow.appendChild(cell);
      });
      el.sheet.appendChild(headerRow);

      // Time rows
      for (let m = startM; m <= endM; m += step) {
        const time = toHHMM(m);
        const row = document.createElement('div');
        row.className = 'tee-grid';
        row.dataset.time = time;

        // Time cell
        const timeCell = document.createElement('div');
        timeCell.className = 'time-cell';
        timeCell.textContent = time;
        row.appendChild(timeCell);

        // Slot cells
        layout.cols.forEach((col, colIdx) => {
          const slot = document.createElement('div');
          slot.className = 'slot';
          slot.dataset.time = time;
          slot.dataset.course = col.course;
          slot.dataset.tee = col.tee;
          slot.dataset.col = colIdx;

          // Find bookings for this slot
          const slotBookings = bookings.filter(b =>
            b.time === time && b.col === colIdx
          );

          slotBookings.forEach(booking => {
            slot.appendChild(createPill(booking));
          });

          // Click to open modal
          slot.addEventListener('click', e => {
            if (e.target.closest('.pill')) return;
            openModal({
              time,
              course: col.course,
              tee: col.tee,
              col: colIdx
            });
          });

          // Drag & drop
          slot.addEventListener('dragover', e => {
            e.preventDefault();
            slot.classList.add('drag-over');
          });
          slot.addEventListener('dragleave', () => {
            slot.classList.remove('drag-over');
          });
          slot.addEventListener('drop', e => {
            e.preventDefault();
            slot.classList.remove('drag-over');
            const id = e.dataTransfer.getData('text/plain');
            if (!id) return;
            moveBooking(id, time, colIdx, col.course, col.tee);
          });

          row.appendChild(slot);
        });

        el.sheet.appendChild(row);
      }
    }

    function createPill(booking) {
      const pill = document.createElement('div');
      pill.className = `pill ${booking.type || 'regular'}`;
      pill.draggable = true;
      pill.dataset.id = booking.id;

      // Content
      const golferNames = (booking.golfers || [])
        .filter(g => g.name)
        .map(g => g.name)
        .join(', ') || t('emptySlot');

      const caddyInfo = (booking.golfers || [])
        .filter(g => g.caddyId)
        .map(g => {
          const caddy = CADDIES.find(c => c.id === g.caddyId);
          return caddy ? `#${caddy.number}` : '';
        })
        .filter(Boolean)
        .join(', ');

      pill.innerHTML = `
        <div class="pill-name">${golferNames}</div>
        ${caddyInfo ? `<div class="pill-caddy">${t('caddies')}: ${caddyInfo}</div>` : ''}
        ${booking.notes ? `<div class="pill-info">${booking.notes.substring(0, 30)}${booking.notes.length > 30 ? '...' : ''}</div>` : ''}
      `;

      // Click to edit
      pill.addEventListener('click', e => {
        e.stopPropagation();
        openModal(booking, true);
      });

      // Drag
      pill.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', booking.id);
        pill.classList.add('dragging');
        draggedBookingId = booking.id;
      });
      pill.addEventListener('dragend', () => {
        pill.classList.remove('dragging');
        draggedBookingId = null;
      });

      return pill;
    }

    // ============= BOOKING OPERATIONS =============
    function moveBooking(id, newTime, newCol, newCourse, newTee) {
      const date = el.date.value;
      const bookings = getBookings(date);
      const idx = bookings.findIndex(b => b.id === id);
      if (idx < 0) return;

      bookings[idx].time = newTime;
      bookings[idx].col = newCol;
      bookings[idx].course = newCourse;
      bookings[idx].tee = newTee;

      saveBookings(date, bookings);
      render();
    }

    function saveBooking(booking) {
      const date = el.date.value;
      const bookings = getBookings(date);
      const idx = bookings.findIndex(b => b.id === booking.id);

      if (idx >= 0) {
        bookings[idx] = booking;
      } else {
        bookings.push(booking);
      }

      saveBookings(date, bookings);
      render();
    }

    function deleteBooking(id) {
      const date = el.date.value;
      const bookings = getBookings(date).filter(b => b.id !== id);
      saveBookings(date, bookings);
      render();
    }

    // ============= MODAL =============
    function openModal(data, isEdit = false) {
      el.modalTitle.textContent = isEdit ? t('editBooking') : t('bookTeeTime');
      el.bookingId.value = data.id || '';
      el.bookingSlot.value = JSON.stringify({
        time: data.time,
        course: data.course,
        tee: data.tee,
        col: data.col
      });

      el.slotTime.textContent = data.time;
      el.slotCourse.textContent = `Course ${data.course}`;
      el.slotTee.textContent = data.tee;

      // Booking type
      currentBookingType = data.type || 'regular';
      document.querySelectorAll('.type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === currentBookingType);
      });

      // Golfer rows
      renderGolferRows(data.golfers || [{}, {}, {}, {}]);

      // Notes
      el.bookingNotes.value = data.notes || '';

      // Show/hide delete button
      el.deleteBtn.style.display = isEdit ? '' : 'none';

      el.modalBackdrop.classList.add('open');
    }

    function closeModal() {
      el.modalBackdrop.classList.remove('open');
    }

    function renderGolferRows(golfers) {
      el.golferRows.innerHTML = '';

      for (let i = 0; i < 4; i++) {
        const golfer = golfers[i] || {};
        const row = document.createElement('div');
        row.className = `golfer-row ${golfer.name ? '' : 'empty'}`;
        row.innerHTML = `
          <div>
            <div class="golfer-number">${t('golfer')} ${i + 1}</div>
            <input type="text" class="golfer-name" placeholder="${t('name')}" value="${golfer.name || ''}" data-idx="${i}">
          </div>
          <div>
            <label>${t('handicap')}</label>
            <input type="number" class="golfer-hcp" placeholder="HCP" value="${golfer.handicap || ''}" min="0" max="54" style="width:100%" data-idx="${i}">
          </div>
          <div class="caddy-select">
            <label>${t('caddy')}</label>
            <input type="text" class="caddy-input" placeholder="${t('searchCaddy')}" value="${getCaddyDisplay(golfer.caddyId)}" data-idx="${i}" data-caddy-id="${golfer.caddyId || ''}">
            <div class="caddy-dropdown" data-idx="${i}"></div>
          </div>
        `;
        el.golferRows.appendChild(row);
      }

      // Setup caddy search
      document.querySelectorAll('.caddy-input').forEach(input => {
        const dropdown = input.nextElementSibling;

        input.addEventListener('focus', () => {
          renderCaddyDropdown(dropdown, input.value, input.dataset.caddyId);
          dropdown.classList.add('open');
        });

        input.addEventListener('input', () => {
          renderCaddyDropdown(dropdown, input.value, input.dataset.caddyId);
        });

        input.addEventListener('blur', () => {
          setTimeout(() => dropdown.classList.remove('open'), 200);
        });
      });

      // Update row styling on name change
      document.querySelectorAll('.golfer-name').forEach(input => {
        input.addEventListener('input', () => {
          input.closest('.golfer-row').classList.toggle('empty', !input.value.trim());
        });
      });
    }

    function getCaddyDisplay(caddyId) {
      if (!caddyId) return '';
      const caddy = CADDIES.find(c => c.id === caddyId);
      return caddy ? `#${caddy.number} ${caddy.name}` : '';
    }

    function renderCaddyDropdown(dropdown, searchTerm, selectedId) {
      const term = (searchTerm || '').toLowerCase();
      const filtered = CADDIES.filter(c =>
        c.name.toLowerCase().includes(term) ||
        c.number.includes(term)
      ).slice(0, 10);

      dropdown.innerHTML = `
        <div class="caddy-option" data-id="">
          <span class="caddy-num">--</span>
          <span class="caddy-name">${t('noCaddy')}</span>
        </div>
        ${filtered.map(c => `
          <div class="caddy-option ${c.id === selectedId ? 'selected' : ''}" data-id="${c.id}">
            <span class="caddy-num">#${c.number}</span>
            <span class="caddy-name">${c.name}</span>
            <span class="caddy-rating">‚òÖ${c.rating}</span>
            <span class="caddy-status ${c.status}">${c.status}</span>
          </div>
        `).join('')}
      `;

      dropdown.querySelectorAll('.caddy-option').forEach(opt => {
        opt.addEventListener('mousedown', e => {
          e.preventDefault();
          const input = dropdown.previousElementSibling;
          const caddyId = opt.dataset.id;
          input.dataset.caddyId = caddyId;
          input.value = getCaddyDisplay(caddyId);
          dropdown.classList.remove('open');
        });
      });
    }

    function collectModalData() {
      const slotData = JSON.parse(el.bookingSlot.value);
      const golfers = [];

      document.querySelectorAll('.golfer-row').forEach((row, idx) => {
        const name = row.querySelector('.golfer-name').value.trim();
        const handicap = row.querySelector('.golfer-hcp').value;
        const caddyId = row.querySelector('.caddy-input').dataset.caddyId;

        if (name || caddyId) {
          golfers.push({
            id: `g${idx}`,
            name,
            handicap: handicap ? parseInt(handicap) : null,
            caddyId: caddyId || null
          });
        }
      });

      return {
        id: el.bookingId.value || genId(),
        time: slotData.time,
        course: slotData.course,
        tee: slotData.tee,
        col: slotData.col,
        type: currentBookingType,
        golfers,
        notes: el.bookingNotes.value.trim(),
        updatedAt: new Date().toISOString()
      };
    }

    // ============= SEARCH =============
    function search(query) {
      const term = query.toLowerCase().trim();
      if (!term) {
        searchResults = [];
        return;
      }

      const bookings = getBookings(el.date.value);
      searchResults = bookings.filter(b => {
        const golferMatch = (b.golfers || []).some(g =>
          (g.name || '').toLowerCase().includes(term)
        );
        const caddyMatch = (b.golfers || []).some(g => {
          if (!g.caddyId) return false;
          const caddy = CADDIES.find(c => c.id === g.caddyId);
          return caddy && (caddy.name.toLowerCase().includes(term) || caddy.number.includes(term));
        });
        const notesMatch = (b.notes || '').toLowerCase().includes(term);
        return golferMatch || caddyMatch || notesMatch;
      });
      searchIndex = 0;
    }

    function highlightResult() {
      if (searchResults.length === 0) {
        alert(t('noMatches'));
        return;
      }

      const booking = searchResults[searchIndex];
      const slot = document.querySelector(`.slot[data-time="${booking.time}"][data-col="${booking.col}"]`);

      if (slot) {
        slot.scrollIntoView({ behavior: 'smooth', block: 'center' });
        slot.classList.add('highlighted');
        setTimeout(() => slot.classList.remove('highlighted'), 1500);
      }
    }

    // ============= EVENT LISTENERS =============
    // Date navigation
    el.prevDay.addEventListener('click', () => {
      const d = new Date(el.date.value);
      d.setDate(d.getDate() - 1);
      el.date.value = d.toISOString().split('T')[0];
      render();
    });

    el.nextDay.addEventListener('click', () => {
      const d = new Date(el.date.value);
      d.setDate(d.getDate() + 1);
      el.date.value = d.toISOString().split('T')[0];
      render();
    });

    // Settings changes
    el.date.addEventListener('change', render);
    el.complex.addEventListener('change', render);
    el.start.addEventListener('change', render);
    el.end.addEventListener('change', render);
    el.interval.addEventListener('change', render);
    el.tees.addEventListener('change', render);

    // Language change
    el.langSelect.addEventListener('change', () => {
      setLanguage(el.langSelect.value);
    });

    // Clear day
    el.clearBtn.addEventListener('click', () => {
      if (confirm(`${t('confirmClear')} ${el.date.value}?`)) {
        saveBookings(el.date.value, []);
        render();
      }
    });

    // Search
    el.searchBtn.addEventListener('click', () => {
      search(el.search.value);
      highlightResult();
    });

    el.searchNextBtn.addEventListener('click', () => {
      if (searchResults.length === 0) {
        search(el.search.value);
      } else {
        searchIndex = (searchIndex + 1) % searchResults.length;
      }
      highlightResult();
    });

    el.search.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        el.searchBtn.click();
      }
    });

    // Modal
    el.closeModal.addEventListener('click', closeModal);
    el.cancelBtn.addEventListener('click', closeModal);
    el.modalBackdrop.addEventListener('click', e => {
      if (e.target === el.modalBackdrop) closeModal();
    });

    // Booking type buttons
    document.querySelectorAll('.type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentBookingType = btn.dataset.type;
        document.querySelectorAll('.type-btn').forEach(b => {
          b.classList.toggle('active', b === btn);
        });
      });
    });

    // Save booking
    el.saveBtn.addEventListener('click', () => {
      const booking = collectModalData();
      if (booking.golfers.length === 0) {
        alert(t('addGolfer'));
        return;
      }
      saveBooking(booking);
      closeModal();
    });

    // Delete booking
    el.deleteBtn.addEventListener('click', () => {
      if (confirm(t('confirmDelete'))) {
        deleteBooking(el.bookingId.value);
        closeModal();
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && el.modalBackdrop.classList.contains('open')) {
        closeModal();
      }
    });

    // ============= INIT =============
    function init() {
      // Load settings
      const settings = getSettings();
      if (settings.date) el.date.value = settings.date;
      else el.date.value = todayISO();

      if (settings.complex) el.complex.value = settings.complex;
      if (settings.start) el.start.value = settings.start;
      if (settings.end) el.end.value = settings.end;
      if (settings.interval) el.interval.value = settings.interval;
      if (settings.tees) el.tees.value = settings.tees;

      // Load language
      if (settings.lang && TRANSLATIONS[settings.lang]) {
        currentLang = settings.lang;
        el.langSelect.value = settings.lang;
      }

      // Try to connect to MciPro
      window.MciProBridge.init();

      // Apply language and render
      updateLanguage();

      console.log('[TeeSheet] Initialized with language:', currentLang);
    }

    init();
  })();
  </script>
</body>
</html>
