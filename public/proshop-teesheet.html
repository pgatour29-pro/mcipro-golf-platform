<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MyCaddy Pro • Tee Sheet</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #fff;
      --ink: #1e293b;
      --muted: #64748b;
      --brand: #3b82f6;
      --border: #e2e8f0;
      --course-a: #dcfce7;
      --course-a-header: #86efac;
      --course-b: #dbeafe;
      --course-b-header: #93c5fd;
      --course-c: #fef3c7;
      --course-c-header: #fcd34d;
      --course-d: #f3e8ff;
      --course-d-header: #d8b4fe;
      --regular: #dcfce7;
      --vip: #fef3c7;
      --society: #dbeafe;
      --tournament: #fce7f3;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--ink);
      height: 100vh;
      overflow: hidden;
    }

    /* Full-Screen Container */
    .teesheet-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
    }

    /* Top Header Bar (dark) */
    .top-header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px;
      background: linear-gradient(90deg, #166534 0%, #15803d 50%, #166534 100%);
      border-bottom: 2px solid #22c55e;
      flex-shrink: 0;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .logo-section {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-section svg {
      width: 28px;
      height: 28px;
      fill: #22c55e;
    }
    .course-name-display {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
    }
    .live-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(0,0,0,0.3);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
    }
    .live-dot {
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      animation: pulse-dot 1.5s infinite;
    }
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }
    .header-center {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .date-display-large {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      background: rgba(0,0,0,0.3);
      padding: 6px 16px;
      border-radius: 8px;
      cursor: pointer;
    }
    .date-nav-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #fff;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      transition: background 0.15s;
    }
    .date-nav-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .current-time-display {
      font-size: 24px;
      font-weight: 700;
      color: #22c55e;
      font-variant-numeric: tabular-nums;
    }
    .header-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      color: #fff;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      text-decoration: none;
    }
    .header-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    .header-btn.primary {
      background: #22c55e;
      border-color: #22c55e;
    }
    .header-btn.primary:hover {
      background: #16a34a;
    }

    /* Main Content Area */
    .main-content {
      flex: 1;
      overflow: auto;
      padding: 12px;
    }

    /* Header Row - now inside main content */
    .header-row {
      display: none; /* Hide old header, replaced by top-header-bar */
    }
    .language-select {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--muted);
    }
    .language-select svg {
      width: 16px;
      height: 16px;
    }
    .language-select select {
      padding: 8px 32px 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M2 4l4 4 4-4'/%3E%3C/svg%3E") no-repeat right 12px center;
      appearance: none;
      font-size: 14px;
      cursor: pointer;
    }

    /* Controls Row */
    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-end;
      margin-bottom: 16px;
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .control-group label {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .control-group input,
    .control-group select {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: #fff;
      min-width: 120px;
    }
    .control-group input:focus,
    .control-group select:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Date Control */
    .date-control {
      display: flex;
      align-items: center;
      gap: 0;
    }
    .date-control button {
      width: 40px;
      height: 42px;
      border: 1px solid var(--border);
      background: var(--ink);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .date-control button:first-child {
      border-radius: 8px 0 0 8px;
    }
    .date-control button:last-child {
      border-radius: 0 8px 8px 0;
    }
    .date-control input[type="date"] {
      border-radius: 0;
      border-left: none;
      border-right: none;
      min-width: 140px;
    }

    /* Search */
    .search-group {
      flex: 1;
      min-width: 200px;
    }
    .search-group input {
      width: 100%;
    }

    /* Buttons */
    .btn {
      padding: 10px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      background: #fff;
      color: var(--ink);
      transition: all 0.15s;
    }
    .btn:hover {
      background: #f8fafc;
    }
    .btn-clear {
      background: #fff;
      color: #ef4444;
      border-color: #fecaca;
    }
    .btn-clear:hover {
      background: #fef2f2;
    }
    .btn-primary {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand);
    }
    .btn-primary:hover {
      background: #2563eb;
    }

    /* Legend Row */
    .legend-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .course-legend,
    .type-legend {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--muted);
    }
    .legend-dot {
      width: 14px;
      height: 14px;
      border-radius: 4px;
    }
    .legend-dot.course-a { background: var(--course-a-header); }
    .legend-dot.course-b { background: var(--course-b-header); }
    .legend-dot.course-c { background: var(--course-c-header); }
    .legend-dot.course-d { background: var(--course-d-header); }
    .legend-dot.regular { background: var(--regular); border: 1px solid #86efac; }
    .legend-dot.vip { background: var(--vip); border: 1px solid #fcd34d; }
    .legend-dot.society { background: var(--society); border: 1px solid #93c5fd; }
    .legend-dot.tournament { background: var(--tournament); border: 1px solid #f9a8d4; }

    /* Tee Sheet Grid */
    .teesheet-grid {
      background: #fff;
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .grid-header {
      display: grid;
      grid-template-columns: 80px repeat(var(--cols), 1fr);
      background: #f8fafc;
      border-bottom: 2px solid var(--border);
    }
    .grid-header-cell {
      padding: 14px 8px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
      border-right: 1px solid var(--border);
    }
    .grid-header-cell:last-child {
      border-right: none;
    }
    .grid-header-cell.time-header {
      background: #fff;
      color: var(--ink);
    }
    .grid-header-cell.course-a { background: var(--course-a-header); color: #166534; }
    .grid-header-cell.course-b { background: var(--course-b-header); color: #1e40af; }
    .grid-header-cell.course-c { background: var(--course-c-header); color: #92400e; }
    .grid-header-cell.course-d { background: var(--course-d-header); color: #6b21a8; }

    .grid-row {
      display: grid;
      grid-template-columns: 80px repeat(var(--cols), 1fr);
      border-bottom: 1px solid var(--border);
    }
    .grid-row:last-child {
      border-bottom: none;
    }
    .grid-row:hover {
      background: #fafbfc;
    }
    .time-cell {
      padding: 12px 8px;
      text-align: center;
      font-weight: 600;
      font-size: 13px;
      color: var(--ink);
      background: #fff;
      border-right: 1px solid var(--border);
      font-variant-numeric: tabular-nums;
    }
    .slot {
      padding: 4px;
      min-height: 52px;
      border-right: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.15s;
    }
    .slot:hover {
      background: #f1f5f9;
    }
    .slot.course-a { background: var(--course-a); }
    .slot.course-b { background: var(--course-b); }
    .slot.course-c { background: var(--course-c); }
    .slot.course-d { background: var(--course-d); }
    .slot.course-a:hover { background: #bbf7d0; }
    .slot.course-b:hover { background: #bfdbfe; }
    .slot.course-c:hover { background: #fde68a; }
    .slot.course-d:hover { background: #e9d5ff; }

    /* Booking Pills */
    .pill {
      background: #fff;
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 12px;
      cursor: grab;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-left: 3px solid #86efac;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    .pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    .pill:active {
      cursor: grabbing;
    }
    .pill.vip { border-left-color: #fcd34d; background: #fffbeb; }
    .pill.society { border-left-color: #93c5fd; background: #eff6ff; }
    .pill.tournament { border-left-color: #f9a8d4; background: #fdf2f8; }
    .pill-name {
      font-weight: 600;
      color: var(--ink);
      margin-bottom: 2px;
    }
    .pill-info {
      font-size: 11px;
      color: var(--muted);
    }

    /* Modal */
    dialog {
      border: none;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      padding: 0;
      max-width: 700px;
      width: 95%;
      margin: auto;
      max-height: 90vh;
      overflow: hidden;
    }
    dialog[open] {
      display: flex;
      flex-direction: column;
    }
    dialog::backdrop {
      background: rgba(0,0,0,0.5);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      background: #f8fafc;
      flex-shrink: 0;
    }
    .modal-header h2 {
      font-size: 16px;
      font-weight: 600;
    }
    .modal-close {
      width: 28px;
      height: 28px;
      border: none;
      background: none;
      font-size: 18px;
      cursor: pointer;
      color: var(--muted);
      border-radius: 6px;
    }
    .modal-close:hover {
      background: #e2e8f0;
    }
    .modal-body {
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: #f8fafc;
      flex-shrink: 0;
    }

    /* Form */
    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-width: 100px;
    }
    .form-group label {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
    }
    .form-group textarea {
      resize: none;
      height: 50px;
    }

    /* Golfer Rows */
    .golfers-section h3 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .golfer-row {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      padding: 14px;
      background: #f8fafc;
      border-radius: 10px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
    }
    .golfer-num {
      width: 32px;
      height: 32px;
      background: var(--brand);
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      flex-shrink: 0;
      margin-top: 20px;
    }
    .golfer-fields {
      flex: 1;
      display: flex;
      gap: 12px;
    }
    .golfer-field {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .golfer-field label {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
    }
    .golfer-field input {
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      width: 100%;
    }
    .golfer-field input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .caddy-select-wrapper {
      position: relative;
      width: 100%;
    }
    .caddy-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    .caddy-dropdown.show { display: block; }
    .caddy-option {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f1f5f9;
    }
    .caddy-option:hover { background: #f8fafc; }
    .caddy-option:last-child { border-bottom: none; }
    .caddy-option-name { font-weight: 600; font-size: 13px; }
    .caddy-option-info { font-size: 11px; color: var(--muted); }
    .caddy-option-rating { float: right; color: #f59e0b; font-size: 12px; }
    .caddy-option.booked {
      background: #fef2f2;
      opacity: 0.7;
      cursor: not-allowed;
    }
    .caddy-option.booked:hover { background: #fef2f2; }
    .caddy-option.booked .caddy-option-name {
      color: #991b1b;
      text-decoration: line-through;
    }
    .caddy-booked-badge {
      display: inline-block;
      background: #ef4444;
      color: #fff;
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .remove-golfer {
      width: 32px;
      height: 32px;
      border: 1px solid #fecaca;
      background: #fef2f2;
      color: #ef4444;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      flex-shrink: 0;
      margin-top: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .remove-golfer:hover { background: #fee2e2; }
    .add-golfer-btn {
      font-size: 13px;
      padding: 8px 16px;
      background: #eff6ff;
      color: var(--brand);
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    .add-golfer-btn:hover { background: #dbeafe; }

    /* Range Booking Toggle */
    .range-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .range-toggle input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--brand);
    }
    .range-toggle label {
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      cursor: pointer;
    }
    .range-toggle .range-hint {
      font-size: 12px;
      color: var(--muted);
      margin-left: auto;
    }

    /* Recurring Booking Styles */
    .recurring-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px dashed var(--border);
    }
    .recurring-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: #fdf4ff;
      border: 1px solid #e879f9;
      border-radius: 8px;
    }
    .recurring-toggle input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #a855f7;
    }
    .recurring-toggle label {
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      cursor: pointer;
    }
    .recurring-toggle .recurring-hint {
      font-size: 12px;
      color: var(--muted);
      margin-left: auto;
    }
    .recurring-options {
      margin-top: 12px;
      padding: 12px;
      background: #faf5ff;
      border: 1px solid #e9d5ff;
      border-radius: 8px;
    }
    .weekdays-row {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .weekdays-row > label {
      font-size: 13px;
      font-weight: 500;
      color: var(--ink);
    }
    .weekday-checkboxes {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .weekday-checkboxes label {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .weekday-checkboxes label:has(input:checked) {
      background: #a855f7;
      border-color: #a855f7;
      color: #fff;
    }
    .weekday-checkboxes input {
      display: none;
    }
    .recurring-preview {
      margin-top: 12px;
      padding: 10px;
      background: #fff;
      border: 1px solid #e9d5ff;
      border-radius: 6px;
      font-size: 13px;
      color: var(--muted);
    }
    .recurring-preview strong {
      color: #7c3aed;
    }

    /* Range Time Selectors */
    .range-time-row {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      padding: 12px;
      background: #fef3c7;
      border: 1px solid #fcd34d;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .range-time-row .form-group {
      flex: 1;
    }
    .range-time-row .range-info {
      font-size: 13px;
      color: #92400e;
      font-weight: 500;
      padding: 8px 0;
    }

    /* Slot Cards for Range Booking */
    .range-slots-container {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 8px;
    }
    .slot-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 12px;
      overflow: hidden;
    }
    .slot-card.collapsed .slot-body { display: none; }
    .slot-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: #f8fafc;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }
    .slot-header:hover { background: #f1f5f9; }
    .slot-time-badge {
      background: var(--brand);
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }
    .slot-summary {
      flex: 1;
      font-size: 13px;
      color: var(--muted);
    }
    .slot-summary .names {
      color: var(--ink);
      font-weight: 500;
    }
    .slot-expand-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 18px;
      transition: transform 0.2s;
    }
    .slot-card:not(.collapsed) .slot-expand-icon { transform: rotate(180deg); }
    .slot-body {
      padding: 14px;
    }

    /* Range Booking Pill */
    .pill.range-group {
      border-left-width: 5px;
      position: relative;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .pill.range-group.society {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border-left-color: #3b82f6;
    }
    .pill.range-group.tournament {
      background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
      border-left-color: #ec4899;
    }
    .pill.range-group.vip {
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      border-left-color: #f59e0b;
    }
    .pill.range-start {
      border-radius: 6px 6px 2px 2px;
      margin-bottom: 2px;
    }
    .pill.range-middle {
      border-radius: 2px;
      margin-bottom: 2px;
    }
    .pill.range-end {
      border-radius: 2px 2px 6px 6px;
    }
    .pill.range-group .pill-name {
      font-weight: 600;
    }

    .btn-delete {
      background: #fff;
      color: #ef4444;
      border-color: #fecaca;
    }
    .btn-delete:hover {
      background: #fef2f2;
    }

    /* Back to Top Button */
    .back-to-top {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 50px;
      height: 50px;
      background: var(--brand);
      color: #fff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      z-index: 1000;
      transition: transform 0.2s, opacity 0.2s;
    }
    .back-to-top:hover {
      transform: scale(1.1);
    }
    .back-to-top.show {
      display: flex;
    }

    /* Settings Modal */
    .settings-btn {
      background: var(--ink);
      color: #fff;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .settings-btn:hover {
      background: #334155;
    }
    .settings-modal {
      max-width: 900px;
      width: 95%;
    }
    .settings-tabs {
      display: flex;
      gap: 0;
      border-bottom: 2px solid var(--border);
      background: #f8fafc;
      padding: 0 16px;
    }
    .settings-tab {
      padding: 14px 20px;
      border: none;
      background: none;
      font-size: 14px;
      font-weight: 500;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.15s;
    }
    .settings-tab:hover {
      color: var(--ink);
    }
    .settings-tab.active {
      color: var(--brand);
      border-bottom-color: var(--brand);
      background: #fff;
    }
    .settings-content {
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }
    .settings-panel {
      display: none;
    }
    .settings-panel.active {
      display: block;
    }
    .settings-section {
      margin-bottom: 24px;
    }
    .settings-section h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }
    .settings-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .settings-field label {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
    }
    .settings-field input,
    .settings-field select {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
    }
    .settings-field input:focus,
    .settings-field select:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Time Periods */
    .time-period-row {
      display: grid;
      grid-template-columns: 100px 120px 120px 100px 40px;
      gap: 12px;
      align-items: center;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .time-period-row input {
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
    }
    .time-period-label {
      font-weight: 600;
      font-size: 13px;
      color: var(--ink);
    }
    .add-period-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: #eff6ff;
      color: var(--brand);
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }
    .add-period-btn:hover {
      background: #dbeafe;
    }
    .remove-period-btn {
      width: 32px;
      height: 32px;
      border: 1px solid #fecaca;
      background: #fef2f2;
      color: #ef4444;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }
    .remove-period-btn:hover {
      background: #fee2e2;
    }

    /* Package Cards */
    .package-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .package-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .package-name {
      font-weight: 600;
      font-size: 14px;
    }
    .package-fields {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .package-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .package-field label {
      font-size: 11px;
      color: var(--muted);
    }
    .package-field input,
    .package-field select {
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
    }

    /* Currency Input */
    .currency-input {
      position: relative;
    }
    .currency-input::before {
      content: '฿';
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      font-size: 14px;
    }
    .currency-input input {
      padding-left: 28px;
    }

    /* Settings Summary */
    .settings-summary {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    .settings-summary h4 {
      font-size: 13px;
      font-weight: 600;
      color: #0369a1;
      margin-bottom: 8px;
    }
    .settings-summary-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      font-size: 12px;
    }
    .summary-item {
      display: flex;
      flex-direction: column;
    }
    .summary-label {
      color: var(--muted);
    }
    .summary-value {
      font-weight: 600;
      color: var(--ink);
    }
  </style>
</head>
<body>
  <div class="teesheet-container">
    <!-- Top Header Bar -->
    <div class="top-header-bar">
      <div class="header-left">
        <div class="logo-section">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="#22c55e" stroke-width="2"/><path d="M8 12l3 3 5-6" stroke="#22c55e" stroke-width="2" fill="none"/></svg>
          <span class="course-name-display" id="course-name-display">Select Course</span>
        </div>
        <div class="live-badge">
          <div class="live-dot"></div>
          <span>LIVE TEE SHEET</span>
        </div>
      </div>
      <div class="header-center">
        <button class="date-nav-btn" id="header-prev-day">‹</button>
        <div class="date-display-large" id="date-display-large">Loading...</div>
        <button class="date-nav-btn" id="header-next-day">›</button>
      </div>
      <div class="header-right">
        <div class="current-time-display" id="current-time-display">--:--</div>
        <select id="lang-select" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:6px 10px;border-radius:6px;font-size:12px;">
          <option value="en">EN</option>
          <option value="th">TH</option>
          <option value="ko">KO</option>
          <option value="ja">JA</option>
        </select>
        <button class="header-btn" id="settings-btn">⚙ Settings</button>
        <a href="/index.html#proshop" class="header-btn primary">← Dashboard</a>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
    <!-- Old Header (hidden) -->
    <div class="header-row">
      <h1 data-i18n="teeSheet">Tee Sheet</h1>
    </div>

    <!-- Controls -->
    <div class="controls-row">
      <!-- Course select hidden - controlled via URL param and settings only -->
      <select id="course-select" style="display:none;">
        <option value="">-- Select Course --</option>
        <option value="bangpakong">Bangpakong Riverside Country Club</option>
        <option value="bangpra">Bangpra International Golf Club</option>
        <option value="burapha_ac">Burapha Golf Club - A+C</option>
        <option value="burapha_cd">Burapha Golf Club - C+D</option>
        <option value="burapha_east">Burapha Golf Club - East Course</option>
        <option value="cheechan">Chee Chan Golf Resort</option>
        <option value="crystal_bay">Crystal Bay Golf Club</option>
        <option value="eastern_star">Eastern Star Country Club</option>
        <option value="grand_prix">Grand Prix International Golf Club</option>
        <option value="greenwood">Greenwood Golf Club</option>
        <option value="hermes">Hermes Golf Club</option>
        <option value="khao_kheow">Khao Kheow Country Club</option>
        <option value="laem_chabang">Laem Chabang International Country Club</option>
        <option value="mountain_shadow">Mountain Shadow Golf Club</option>
        <option value="pattana">Pattana Golf Club & Resort</option>
        <option value="pattavia">Pattavia Century Golf Club</option>
        <option value="pattaya_county">Pattaya County Golf Club</option>
        <option value="phoenix">Phoenix Gold Golf & Country Club</option>
        <option value="pleasant_valley">Pleasant Valley Country Club</option>
        <option value="plutaluang">Plutaluang Royal Thai Navy Golf Course</option>
        <option value="royal_lakeside">Royal Lakeside Golf Club</option>
        <option value="siam_cc_old">Siam Country Club - Old Course</option>
        <option value="siam_cc_plantation">Siam Country Club - Plantation</option>
        <option value="siam_cc_waterside">Siam Country Club - Waterside</option>
        <option value="siam_plantation">Siam Plantation Golf Club</option>
        <option value="st_andrews_2000">St. Andrews 2000 Golf Club</option>
        <option value="treasure_hill">Treasure Hill Golf & Country Club</option>
      </select>

      <div class="control-group">
        <label data-i18n="date">DATE</label>
        <div class="date-control">
          <button id="prev-day">‹</button>
          <input type="date" id="date-input">
          <button id="next-day">›</button>
        </div>
      </div>

      <div class="control-group">
        <label data-i18n="courseLayout">COURSE LAYOUT</label>
        <select id="complex-select">
          <option value="18" selected>18 holes (A/B)</option>
          <option value="27">27 holes (A/B/C)</option>
          <option value="36">36 holes (A/B/C/D)</option>
        </select>
      </div>

      <div class="control-group">
        <label data-i18n="start">START</label>
        <input type="time" id="start-time" value="06:00">
      </div>

      <div class="control-group">
        <label data-i18n="end">END</label>
        <input type="time" id="end-time" value="18:00">
      </div>

      <div class="control-group">
        <label data-i18n="interval">INTERVAL</label>
        <select id="interval-select">
          <option value="5">5 min</option>
          <option value="7" selected>7 min</option>
          <option value="10">10 min</option>
          <option value="15">15 min</option>
        </select>
      </div>

      <div class="control-group">
        <label data-i18n="teesCourse">TEES/COURSE</label>
        <select id="tees-select">
          <option value="1">1</option>
          <option value="2" selected>2</option>
        </select>
      </div>

      <div class="control-group search-group">
        <label data-i18n="search">SEARCH</label>
        <input type="text" id="search-input" placeholder="Golfer or caddy..." data-i18n-placeholder="searchPlaceholder">
      </div>

      <button class="btn" id="find-btn" data-i18n="find">Find</button>
      <button class="btn" id="next-btn" data-i18n="next">Next</button>
      <button class="btn btn-clear" id="clear-btn" data-i18n="clearDay">Clear Day</button>
    </div>

    <!-- Legend -->
    <div class="legend-row">
      <div class="course-legend" id="course-legend">
        <div class="legend-item"><span class="legend-dot course-a"></span> <span data-i18n="courseA">Course A</span></div>
        <div class="legend-item"><span class="legend-dot course-b"></span> <span data-i18n="courseB">Course B</span></div>
        <div class="legend-item" id="legend-c"><span class="legend-dot course-c"></span> <span data-i18n="courseC">Course C</span></div>
        <div class="legend-item" id="legend-d" style="display:none"><span class="legend-dot course-d"></span> <span data-i18n="courseD">Course D</span></div>
      </div>
      <div class="type-legend">
        <div class="legend-item"><span class="legend-dot regular"></span> <span data-i18n="regular">Regular</span></div>
        <div class="legend-item"><span class="legend-dot vip"></span> <span data-i18n="vip">VIP</span></div>
        <div class="legend-item"><span class="legend-dot society"></span> <span data-i18n="society">Society</span></div>
        <div class="legend-item"><span class="legend-dot tournament"></span> <span data-i18n="tournament">Tournament</span></div>
      </div>
    </div>

    <!-- Tee Sheet Grid -->
    <div class="teesheet-grid">
      <div class="grid-header" id="grid-header"></div>
      <div id="grid-body"></div>
    </div>
    </div><!-- end main-content -->
  </div><!-- end teesheet-container -->

  <!-- Booking Modal -->
  <dialog id="booking-dialog">
    <div class="modal-header">
      <h2 data-i18n="bookSlot">Book Slot</h2>
      <button class="modal-close" id="close-dialog">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="booking-id">
      <input type="hidden" id="booking-group-id">

      <!-- Range Booking Toggle -->
      <div class="range-toggle">
        <input type="checkbox" id="range-mode-toggle">
        <label for="range-mode-toggle" data-i18n="blockTimeRange">Block Time Range</label>
        <span class="range-hint" data-i18n="rangeHint">For society/group bookings</span>
      </div>

      <!-- Single Booking Row (shown when range mode is OFF) -->
      <div class="form-row" id="single-booking-row">
        <div class="form-group">
          <label data-i18n="time">Time</label>
          <select id="booking-time" style="font-weight:600;"></select>
        </div>
        <div class="form-group">
          <label data-i18n="course">Course</label>
          <select id="booking-course"></select>
        </div>
        <div class="form-group">
          <label data-i18n="tee">Tee</label>
          <select id="booking-tee">
            <option value="1">1</option>
            <option value="2">2</option>
          </select>
        </div>
        <div class="form-group">
          <label data-i18n="bookingType">Booking Type</label>
          <select id="booking-type">
            <option value="regular" data-i18n="regular">Regular</option>
            <option value="vip" data-i18n="vip">VIP</option>
            <option value="society" data-i18n="society">Society</option>
            <option value="tournament" data-i18n="tournament">Tournament</option>
          </select>
        </div>
      </div>

      <!-- Range Time Row (shown when range mode is ON) -->
      <div class="range-time-row" id="range-time-row" style="display:none;">
        <div class="form-group">
          <label data-i18n="startTime">Start Time</label>
          <select id="range-start-time" style="font-weight:600;"></select>
        </div>
        <div class="form-group">
          <label data-i18n="endTime">End Time</label>
          <select id="range-end-time" style="font-weight:600;"></select>
        </div>
        <div class="form-group">
          <label data-i18n="course">Course</label>
          <select id="range-course"></select>
        </div>
        <div class="form-group">
          <label data-i18n="tee">Tee</label>
          <select id="range-tee">
            <option value="1">1</option>
            <option value="2">2</option>
          </select>
        </div>
        <div class="form-group">
          <label data-i18n="bookingType">Booking Type</label>
          <select id="range-type">
            <option value="society" data-i18n="society" selected>Society</option>
            <option value="tournament" data-i18n="tournament">Tournament</option>
            <option value="vip" data-i18n="vip">VIP</option>
          </select>
        </div>
        <div class="range-info" id="range-info"></div>
      </div>

      <!-- Group Name for Range Booking -->
      <div class="form-row" id="range-group-name-row" style="display:none;">
        <div class="form-group" style="flex:1">
          <label data-i18n="groupName">Group / Society Name</label>
          <input type="text" id="range-group-name" placeholder="e.g., XYZ Corporate Outing">
        </div>
      </div>

      <!-- Single Booking Golfers (when range mode is OFF) -->
      <div class="golfers-section" id="single-golfers-section">
        <h3>
          <span data-i18n="golfers">Golfers</span>
          <button type="button" class="add-golfer-btn" id="add-golfer" data-i18n="addGolfer">+ Add Golfer</button>
        </h3>
        <div id="golfers-list"></div>
      </div>

      <!-- Range Booking Slots (when range mode is ON) -->
      <div class="golfers-section" id="range-slots-section" style="display:none;">
        <h3>
          <span data-i18n="timeSlots">Time Slots</span>
          <span id="slot-count-badge" style="background:#e0f2fe;color:#0369a1;padding:4px 10px;border-radius:12px;font-size:12px;margin-left:8px;">0 slots</span>
        </h3>
        <div class="range-slots-container" id="range-slots-list"></div>
      </div>

      <div class="form-row">
        <div class="form-group" style="flex:1">
          <label data-i18n="notes">Notes</label>
          <textarea id="booking-notes" rows="2"></textarea>
        </div>
      </div>

      <!-- Recurring Booking Section -->
      <div class="recurring-section" id="recurring-section">
        <div class="recurring-toggle">
          <input type="checkbox" id="recurring-toggle">
          <label for="recurring-toggle" data-i18n="recurringBooking">Recurring Booking</label>
          <span class="recurring-hint" data-i18n="recurringHint">For standing tee times</span>
        </div>
        <div class="recurring-options" id="recurring-options" style="display:none;">
          <div class="form-row">
            <div class="form-group">
              <label data-i18n="repeatFrequency">Repeat</label>
              <select id="recurring-frequency">
                <option value="daily" data-i18n="daily">Daily</option>
                <option value="weekly" data-i18n="weekly" selected>Weekly</option>
                <option value="biweekly" data-i18n="biweekly">Every 2 Weeks</option>
                <option value="monthly" data-i18n="monthly">Monthly</option>
              </select>
            </div>
            <div class="form-group">
              <label data-i18n="repeatUntil">Until</label>
              <input type="date" id="recurring-until">
            </div>
            <div class="form-group">
              <label data-i18n="occurrences">Or # of times</label>
              <input type="number" id="recurring-count" min="1" max="52" placeholder="e.g., 12">
            </div>
          </div>
          <div class="form-row weekdays-row" id="weekdays-row">
            <label data-i18n="repeatOn">Repeat on:</label>
            <div class="weekday-checkboxes">
              <label><input type="checkbox" name="weekday" value="0"> <span data-i18n="sun">Sun</span></label>
              <label><input type="checkbox" name="weekday" value="1"> <span data-i18n="mon">Mon</span></label>
              <label><input type="checkbox" name="weekday" value="2"> <span data-i18n="tue">Tue</span></label>
              <label><input type="checkbox" name="weekday" value="3"> <span data-i18n="wed">Wed</span></label>
              <label><input type="checkbox" name="weekday" value="4"> <span data-i18n="thu">Thu</span></label>
              <label><input type="checkbox" name="weekday" value="5"> <span data-i18n="fri">Fri</span></label>
              <label><input type="checkbox" name="weekday" value="6"> <span data-i18n="sat">Sat</span></label>
            </div>
          </div>
          <div class="recurring-preview" id="recurring-preview"></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-delete" id="delete-booking" style="display:none" data-i18n="delete">Delete</button>
      <button class="btn" id="cancel-booking" data-i18n="cancel">Cancel</button>
      <button class="btn btn-primary" id="save-booking" data-i18n="save">Save</button>
    </div>
  </dialog>

  <!-- Back to Top Button -->
  <button class="back-to-top" id="back-to-top" title="Back to top">↑</button>

  <!-- Settings Modal -->
  <dialog id="settings-dialog" class="settings-modal">
    <div class="modal-header">
      <h2 data-i18n="teeSheetSettings">Tee Sheet Settings</h2>
      <button class="modal-close" id="close-settings">&times;</button>
    </div>

    <div class="settings-tabs">
      <button class="settings-tab active" data-tab="course" data-i18n="courseConfig">Course Configuration</button>
      <button class="settings-tab" data-tab="pricing" data-i18n="pricing">Green Fees & Pricing</button>
      <button class="settings-tab" data-tab="services" data-i18n="services">Caddy & Cart</button>
      <button class="settings-tab" data-tab="packages" data-i18n="packages">Packages & Promotions</button>
    </div>

    <div class="settings-content">
      <!-- Course Configuration Tab -->
      <div class="settings-panel active" id="panel-course">
        <div class="settings-section">
          <h3 data-i18n="courseDetails">Course Details</h3>
          <div class="settings-grid">
            <div class="settings-field" style="grid-column: span 2;">
              <label data-i18n="golfCourse">Golf Course</label>
              <select id="settings-course">
                <option value="">-- Select Course --</option>
                <option value="bangpakong">Bangpakong Riverside Country Club</option>
                <option value="bangpra">Bangpra International Golf Club</option>
                <option value="burapha_ac">Burapha Golf Club - A+C</option>
                <option value="burapha_cd">Burapha Golf Club - C+D</option>
                <option value="burapha_east">Burapha Golf Club - East Course</option>
                <option value="cheechan">Chee Chan Golf Resort</option>
                <option value="crystal_bay">Crystal Bay Golf Club</option>
                <option value="eastern_star">Eastern Star Country Club</option>
                <option value="grand_prix">Grand Prix International Golf Club</option>
                <option value="greenwood">Greenwood Golf Club</option>
                <option value="hermes">Hermes Golf Club</option>
                <option value="khao_kheow">Khao Kheow Country Club</option>
                <option value="laem_chabang">Laem Chabang International Country Club</option>
                <option value="mountain_shadow">Mountain Shadow Golf Club</option>
                <option value="pattana">Pattana Golf Club & Resort</option>
                <option value="pattavia">Pattavia Century Golf Club</option>
                <option value="pattaya_county">Pattaya County Golf Club</option>
                <option value="phoenix">Phoenix Gold Golf & Country Club</option>
                <option value="pleasant_valley">Pleasant Valley Country Club</option>
                <option value="plutaluang">Plutaluang Royal Thai Navy Golf Course</option>
                <option value="royal_lakeside">Royal Lakeside Golf Club</option>
                <option value="siam_cc_old">Siam Country Club - Old Course</option>
                <option value="siam_cc_plantation">Siam Country Club - Plantation</option>
                <option value="siam_cc_waterside">Siam Country Club - Waterside</option>
                <option value="siam_plantation">Siam Plantation Golf Club</option>
                <option value="st_andrews_2000">St. Andrews 2000 Golf Club</option>
                <option value="treasure_hill">Treasure Hill Golf & Country Club</option>
              </select>
            </div>
            <div class="settings-field">
              <label data-i18n="courseLayout">Course Layout</label>
              <select id="settings-layout">
                <option value="18">18 holes (A/B)</option>
                <option value="27">27 holes (A/B/C)</option>
                <option value="36">36 holes (A/B/C/D)</option>
              </select>
            </div>
            <div class="settings-field">
              <label data-i18n="teesCourse">Tees Per Course</label>
              <select id="settings-tees">
                <option value="1">1 Tee</option>
                <option value="2">2 Tees</option>
              </select>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3 data-i18n="operatingHours">Operating Hours</h3>
          <div class="settings-grid">
            <div class="settings-field">
              <label data-i18n="firstTeeTime">First Tee Time</label>
              <input type="time" id="settings-start" value="06:00">
            </div>
            <div class="settings-field">
              <label data-i18n="lastTeeTime">Last Tee Time</label>
              <input type="time" id="settings-end" value="18:00">
            </div>
            <div class="settings-field">
              <label data-i18n="interval">Tee Time Interval</label>
              <select id="settings-interval">
                <option value="5">5 minutes</option>
                <option value="7">7 minutes</option>
                <option value="8">8 minutes</option>
                <option value="10">10 minutes</option>
                <option value="12">12 minutes</option>
                <option value="15">15 minutes</option>
              </select>
            </div>
            <div class="settings-field">
              <label data-i18n="roundDuration">Round Duration (hrs)</label>
              <select id="settings-round-duration">
                <option value="240">4 hours</option>
                <option value="270" selected>4.5 hours</option>
                <option value="300">5 hours</option>
                <option value="330">5.5 hours</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Green Fees & Pricing Tab -->
      <div class="settings-panel" id="panel-pricing">
        <div class="settings-section">
          <h3 data-i18n="weekdayPricing">Weekday Pricing (Mon-Fri)</h3>
          <div id="weekday-periods">
            <div class="time-period-row">
              <span class="time-period-label" data-i18n="peak">Peak</span>
              <input type="time" class="period-start" value="06:00">
              <input type="time" class="period-end" value="10:00">
              <div class="currency-input">
                <input type="number" class="period-price" value="2500" placeholder="Price">
              </div>
              <button class="remove-period-btn" title="Remove">&times;</button>
            </div>
            <div class="time-period-row">
              <span class="time-period-label" data-i18n="offPeak">Off-Peak</span>
              <input type="time" class="period-start" value="10:00">
              <input type="time" class="period-end" value="14:00">
              <div class="currency-input">
                <input type="number" class="period-price" value="1800" placeholder="Price">
              </div>
              <button class="remove-period-btn" title="Remove">&times;</button>
            </div>
            <div class="time-period-row">
              <span class="time-period-label" data-i18n="twilight">Twilight</span>
              <input type="time" class="period-start" value="14:00">
              <input type="time" class="period-end" value="18:00">
              <div class="currency-input">
                <input type="number" class="period-price" value="1200" placeholder="Price">
              </div>
              <button class="remove-period-btn" title="Remove">&times;</button>
            </div>
          </div>
          <button class="add-period-btn" id="add-weekday-period">+ <span data-i18n="addPeriod">Add Time Period</span></button>
        </div>

        <div class="settings-section">
          <h3 data-i18n="weekendPricing">Weekend/Holiday Pricing (Sat-Sun)</h3>
          <div id="weekend-periods">
            <div class="time-period-row">
              <span class="time-period-label" data-i18n="peak">Peak</span>
              <input type="time" class="period-start" value="06:00">
              <input type="time" class="period-end" value="12:00">
              <div class="currency-input">
                <input type="number" class="period-price" value="3500" placeholder="Price">
              </div>
              <button class="remove-period-btn" title="Remove">&times;</button>
            </div>
            <div class="time-period-row">
              <span class="time-period-label" data-i18n="twilight">Twilight</span>
              <input type="time" class="period-start" value="12:00">
              <input type="time" class="period-end" value="18:00">
              <div class="currency-input">
                <input type="number" class="period-price" value="2200" placeholder="Price">
              </div>
              <button class="remove-period-btn" title="Remove">&times;</button>
            </div>
          </div>
          <button class="add-period-btn" id="add-weekend-period">+ <span data-i18n="addPeriod">Add Time Period</span></button>
        </div>
      </div>

      <!-- Caddy & Cart Tab -->
      <div class="settings-panel" id="panel-services">
        <div class="settings-section">
          <h3 data-i18n="caddyFees">Caddy Fees</h3>
          <div class="settings-grid">
            <div class="settings-field">
              <label data-i18n="caddyFee18">18 Holes Caddy Fee</label>
              <div class="currency-input">
                <input type="number" id="caddy-fee-18" value="400" placeholder="400">
              </div>
            </div>
            <div class="settings-field">
              <label data-i18n="caddyFee9">9 Holes Caddy Fee</label>
              <div class="currency-input">
                <input type="number" id="caddy-fee-9" value="250" placeholder="250">
              </div>
            </div>
            <div class="settings-field">
              <label data-i18n="caddyTip">Suggested Caddy Tip</label>
              <div class="currency-input">
                <input type="number" id="caddy-tip" value="300" placeholder="300">
              </div>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3 data-i18n="cartFees">Golf Cart Fees</h3>
          <div class="settings-grid">
            <div class="settings-field">
              <label data-i18n="cartFee18">18 Holes Cart Fee</label>
              <div class="currency-input">
                <input type="number" id="cart-fee-18" value="700" placeholder="700">
              </div>
            </div>
            <div class="settings-field">
              <label data-i18n="cartFee9">9 Holes Cart Fee</label>
              <div class="currency-input">
                <input type="number" id="cart-fee-9" value="400" placeholder="400">
              </div>
            </div>
            <div class="settings-field">
              <label data-i18n="cartSharing">Cart Sharing</label>
              <select id="cart-sharing">
                <option value="single">Single Rider Only</option>
                <option value="shared" selected>Shared (2 riders)</option>
                <option value="both">Both Options</option>
              </select>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3 data-i18n="otherServices">Other Services</h3>
          <div class="settings-grid">
            <div class="settings-field">
              <label data-i18n="clubRental">Club Rental</label>
              <div class="currency-input">
                <input type="number" id="club-rental" value="1500" placeholder="1500">
              </div>
            </div>
            <div class="settings-field">
              <label data-i18n="shoeRental">Shoe Rental</label>
              <div class="currency-input">
                <input type="number" id="shoe-rental" value="300" placeholder="300">
              </div>
            </div>
            <div class="settings-field">
              <label data-i18n="rangeBalls">Range Balls (bucket)</label>
              <div class="currency-input">
                <input type="number" id="range-balls" value="100" placeholder="100">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Packages & Promotions Tab -->
      <div class="settings-panel" id="panel-packages">
        <div class="settings-section">
          <h3 data-i18n="societyRates">Society / Group Rates</h3>
          <div class="settings-grid">
            <div class="settings-field">
              <label data-i18n="minGroupSize">Minimum Group Size</label>
              <input type="number" id="society-min-size" value="12" min="4">
            </div>
            <div class="settings-field">
              <label data-i18n="societyDiscount">Discount (%)</label>
              <input type="number" id="society-discount" value="15" min="0" max="50">
            </div>
            <div class="settings-field">
              <label data-i18n="freeSlots">Free Slots per Group</label>
              <input type="number" id="society-free-slots" value="1" min="0">
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3 data-i18n="promotionalPackages">Promotional Packages</h3>
          <div id="packages-list">
            <div class="package-card">
              <div class="package-header">
                <input type="text" class="package-name" value="Weekday Special" placeholder="Package Name">
                <button class="remove-period-btn remove-package">&times;</button>
              </div>
              <div class="package-fields">
                <div class="package-field">
                  <label data-i18n="greenFee">Green Fee</label>
                  <div class="currency-input">
                    <input type="number" class="pkg-green-fee" value="1500">
                  </div>
                </div>
                <div class="package-field">
                  <label data-i18n="includesCaddy">Includes Caddy</label>
                  <select class="pkg-includes-caddy">
                    <option value="yes" data-i18n="yes">Yes</option>
                    <option value="no" data-i18n="no">No</option>
                  </select>
                </div>
                <div class="package-field">
                  <label data-i18n="includesCart">Includes Cart</label>
                  <select class="pkg-includes-cart">
                    <option value="yes" data-i18n="yes">Yes</option>
                    <option value="no" selected data-i18n="no">No</option>
                  </select>
                </div>
                <div class="package-field">
                  <label data-i18n="validDays">Valid Days</label>
                  <select class="pkg-valid-days">
                    <option value="weekday">Mon-Fri</option>
                    <option value="weekend">Sat-Sun</option>
                    <option value="all">All Days</option>
                  </select>
                </div>
                <div class="package-field">
                  <label data-i18n="validFrom">Valid From</label>
                  <input type="time" class="pkg-valid-from" value="10:00">
                </div>
                <div class="package-field">
                  <label data-i18n="validUntil">Valid Until</label>
                  <input type="time" class="pkg-valid-until" value="14:00">
                </div>
              </div>
            </div>

            <div class="package-card">
              <div class="package-header">
                <input type="text" class="package-name" value="Twilight Deal" placeholder="Package Name">
                <button class="remove-period-btn remove-package">&times;</button>
              </div>
              <div class="package-fields">
                <div class="package-field">
                  <label data-i18n="greenFee">Green Fee</label>
                  <div class="currency-input">
                    <input type="number" class="pkg-green-fee" value="1200">
                  </div>
                </div>
                <div class="package-field">
                  <label data-i18n="includesCaddy">Includes Caddy</label>
                  <select class="pkg-includes-caddy">
                    <option value="yes" data-i18n="yes">Yes</option>
                    <option value="no" data-i18n="no">No</option>
                  </select>
                </div>
                <div class="package-field">
                  <label data-i18n="includesCart">Includes Cart</label>
                  <select class="pkg-includes-cart">
                    <option value="yes" selected data-i18n="yes">Yes</option>
                    <option value="no" data-i18n="no">No</option>
                  </select>
                </div>
                <div class="package-field">
                  <label data-i18n="validDays">Valid Days</label>
                  <select class="pkg-valid-days">
                    <option value="weekday">Mon-Fri</option>
                    <option value="weekend">Sat-Sun</option>
                    <option value="all" selected>All Days</option>
                  </select>
                </div>
                <div class="package-field">
                  <label data-i18n="validFrom">Valid From</label>
                  <input type="time" class="pkg-valid-from" value="14:00">
                </div>
                <div class="package-field">
                  <label data-i18n="validUntil">Valid Until</label>
                  <input type="time" class="pkg-valid-until" value="18:00">
                </div>
              </div>
            </div>
          </div>
          <button class="add-period-btn" id="add-package">+ <span data-i18n="addPackage">Add Package</span></button>
        </div>
      </div>

      <!-- Settings Summary -->
      <div class="settings-summary">
        <h4 data-i18n="currentSettings">Current Settings Summary</h4>
        <div class="settings-summary-grid">
          <div class="summary-item">
            <span class="summary-label" data-i18n="course">Course</span>
            <span class="summary-value" id="summary-course">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label" data-i18n="layout">Layout</span>
            <span class="summary-value" id="summary-layout">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label" data-i18n="hours">Hours</span>
            <span class="summary-value" id="summary-hours">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label" data-i18n="interval">Interval</span>
            <span class="summary-value" id="summary-interval">-</span>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn" id="cancel-settings" data-i18n="cancel">Cancel</button>
      <button class="btn btn-primary" id="save-settings" data-i18n="saveSettings">Save Settings</button>
    </div>
  </dialog>

  <script>
  (function() {
    'use strict';

    // ==================== TRANSLATIONS ====================
    const translations = {
      en: {
        teeSheet: "Tee Sheet", language: "LANGUAGE", golfCourse: "GOLF COURSE", date: "DATE", courseLayout: "COURSE LAYOUT",
        start: "START", end: "END", interval: "INTERVAL", teesCourse: "TEES/COURSE", search: "SEARCH",
        find: "Find", next: "Next", clearDay: "Clear Day",
        courseA: "Course A", courseB: "Course B", courseC: "Course C", courseD: "Course D",
        regular: "Regular", vip: "VIP", society: "Society", tournament: "Tournament",
        bookSlot: "Book Slot", bookingType: "Booking Type", course: "Course", tee: "Tee", time: "Time",
        golfers: "Golfers", addGolfer: "+ Add Golfer",
        golferName: "Golfer Name", caddy: "Caddy", searchCaddy: "Search caddy...", noCaddy: "No Caddy",
        notes: "Notes", delete: "Delete", cancel: "Cancel", save: "Save",
        searchPlaceholder: "Golfer or caddy...", confirmClear: "Clear all bookings for this day?",
        noMatches: "No matches found.", player: "Player",
        blockTimeRange: "Block Time Range", rangeHint: "For society/group bookings",
        startTime: "Start Time", endTime: "End Time", groupName: "Group / Society Name",
        timeSlots: "Time Slots", slotsCount: "{n} slots", noGolfers: "No golfers assigned",
        deleteGroup: "Delete Entire Group", confirmDeleteGroup: "Delete all {n} slots in this group?",
        booked: "BOOKED", caddyAlreadyBooked: "This caddy is already booked for this time",
        // Recurring booking translations
        recurringBooking: "Recurring Booking", recurringHint: "For standing tee times",
        repeatFrequency: "Repeat", repeatUntil: "Until", occurrences: "Or # of times",
        repeatOn: "Repeat on:", daily: "Daily", weekly: "Weekly", biweekly: "Every 2 Weeks", monthly: "Monthly",
        sun: "Sun", mon: "Mon", tue: "Tue", wed: "Wed", thu: "Thu", fri: "Fri", sat: "Sat",
        recurringPreview: "Will create {n} bookings through {date}",
        // Settings translations
        settings: "Settings", teeSheetSettings: "Tee Sheet Settings", courseConfig: "Course Configuration",
        pricing: "Green Fees & Pricing", services: "Caddy & Cart", packages: "Packages & Promotions",
        courseDetails: "Course Details", operatingHours: "Operating Hours", firstTeeTime: "First Tee Time",
        lastTeeTime: "Last Tee Time", roundDuration: "Round Duration (hrs)", weekdayPricing: "Weekday Pricing (Mon-Fri)",
        weekendPricing: "Weekend/Holiday Pricing (Sat-Sun)", peak: "Peak", offPeak: "Off-Peak", twilight: "Twilight",
        addPeriod: "Add Time Period", caddyFees: "Caddy Fees", caddyFee18: "18 Holes Caddy Fee",
        caddyFee9: "9 Holes Caddy Fee", caddyTip: "Suggested Caddy Tip", cartFees: "Golf Cart Fees",
        cartFee18: "18 Holes Cart Fee", cartFee9: "9 Holes Cart Fee", cartSharing: "Cart Sharing",
        otherServices: "Other Services", clubRental: "Club Rental", shoeRental: "Shoe Rental",
        rangeBalls: "Range Balls (bucket)", societyRates: "Society / Group Rates", minGroupSize: "Minimum Group Size",
        societyDiscount: "Discount (%)", freeSlots: "Free Slots per Group", promotionalPackages: "Promotional Packages",
        greenFee: "Green Fee", includesCaddy: "Includes Caddy", includesCart: "Includes Cart",
        validDays: "Valid Days", validFrom: "Valid From", validUntil: "Valid Until", addPackage: "Add Package",
        currentSettings: "Current Settings Summary", layout: "Layout", hours: "Hours", saveSettings: "Save Settings",
        yes: "Yes", no: "No"
      },
      th: {
        teeSheet: "ตารางทีออฟ", language: "ภาษา", golfCourse: "สนามกอล์ฟ", date: "วันที่", courseLayout: "รูปแบบคอร์ส",
        start: "เริ่ม", end: "สิ้นสุด", interval: "ช่วงเวลา", teesCourse: "ทีออฟ/คอร์ส", search: "ค้นหา",
        find: "ค้นหา", next: "ถัดไป", clearDay: "ล้างวัน",
        courseA: "คอร์ส A", courseB: "คอร์ส B", courseC: "คอร์ส C", courseD: "คอร์ส D",
        regular: "ปกติ", vip: "VIP", society: "กลุ่ม", tournament: "ทัวร์นาเมนต์",
        bookSlot: "จองช่วงเวลา", bookingType: "ประเภทการจอง", course: "คอร์ส", tee: "ทีออฟ", time: "เวลา",
        golfers: "นักกอล์ฟ", addGolfer: "+ เพิ่มนักกอล์ฟ",
        golferName: "ชื่อนักกอล์ฟ", caddy: "แคดดี้", searchCaddy: "ค้นหาแคดดี้...", noCaddy: "ไม่มีแคดดี้",
        notes: "หมายเหตุ", delete: "ลบ", cancel: "ยกเลิก", save: "บันทึก",
        searchPlaceholder: "นักกอล์ฟหรือแคดดี้...", confirmClear: "ล้างการจองทั้งหมดสำหรับวันนี้?",
        noMatches: "ไม่พบผลลัพธ์", player: "ผู้เล่น",
        blockTimeRange: "จองช่วงเวลา", rangeHint: "สำหรับกลุ่มหรือสังคม",
        startTime: "เวลาเริ่มต้น", endTime: "เวลาสิ้นสุด", groupName: "ชื่อกลุ่ม / สังคม",
        timeSlots: "ช่วงเวลา", slotsCount: "{n} ช่วง", noGolfers: "ยังไม่มีนักกอล์ฟ",
        deleteGroup: "ลบทั้งกลุ่ม", confirmDeleteGroup: "ลบทั้งหมด {n} ช่วงในกลุ่มนี้?",
        booked: "จองแล้ว", caddyAlreadyBooked: "แคดดี้นี้จองแล้วสำหรับเวลานี้",
        // Recurring booking translations
        recurringBooking: "จองซ้ำ", recurringHint: "สำหรับเวลาทีออฟประจำ",
        repeatFrequency: "ทำซ้ำ", repeatUntil: "จนถึง", occurrences: "หรือจำนวนครั้ง",
        repeatOn: "ทำซ้ำวัน:", daily: "ทุกวัน", weekly: "ทุกสัปดาห์", biweekly: "ทุก 2 สัปดาห์", monthly: "ทุกเดือน",
        sun: "อา", mon: "จ", tue: "อ", wed: "พ", thu: "พฤ", fri: "ศ", sat: "ส",
        recurringPreview: "จะสร้าง {n} การจองถึง {date}",
        // Settings translations
        settings: "ตั้งค่า", teeSheetSettings: "ตั้งค่าตารางทีออฟ", courseConfig: "การตั้งค่าคอร์ส",
        pricing: "ค่ากรีนฟี & ราคา", services: "แคดดี้ & รถกอล์ฟ", packages: "แพ็คเกจ & โปรโมชั่น",
        courseDetails: "รายละเอียดคอร์ส", operatingHours: "เวลาทำการ", firstTeeTime: "ทีออฟแรก",
        lastTeeTime: "ทีออฟสุดท้าย", roundDuration: "ระยะเวลารอบ (ชม.)", weekdayPricing: "ราคาวันธรรมดา (จ-ศ)",
        weekendPricing: "ราคาวันหยุด (ส-อา)", peak: "Peak", offPeak: "Off-Peak", twilight: "Twilight",
        addPeriod: "เพิ่มช่วงเวลา", caddyFees: "ค่าแคดดี้", caddyFee18: "ค่าแคดดี้ 18 หลุม",
        caddyFee9: "ค่าแคดดี้ 9 หลุม", caddyTip: "ทิปแคดดี้แนะนำ", cartFees: "ค่ารถกอล์ฟ",
        cartFee18: "ค่ารถ 18 หลุม", cartFee9: "ค่ารถ 9 หลุม", cartSharing: "แชร์รถ",
        otherServices: "บริการอื่นๆ", clubRental: "เช่าไม้", shoeRental: "เช่ารองเท้า",
        rangeBalls: "ลูกซ้อม (ตะกร้า)", societyRates: "อัตรากลุ่ม / สังคม", minGroupSize: "จำนวนขั้นต่ำ",
        societyDiscount: "ส่วนลด (%)", freeSlots: "ฟรีต่อกลุ่ม", promotionalPackages: "แพ็คเกจโปรโมชั่น",
        greenFee: "ค่ากรีนฟี", includesCaddy: "รวมแคดดี้", includesCart: "รวมรถ",
        validDays: "วันที่ใช้ได้", validFrom: "ตั้งแต่", validUntil: "จนถึง", addPackage: "เพิ่มแพ็คเกจ",
        currentSettings: "สรุปการตั้งค่า", layout: "รูปแบบ", hours: "เวลา", saveSettings: "บันทึกตั้งค่า",
        yes: "ใช่", no: "ไม่"
      },
      ko: {
        teeSheet: "티 시트", language: "언어", golfCourse: "골프장", date: "날짜", courseLayout: "코스 레이아웃",
        start: "시작", end: "종료", interval: "간격", teesCourse: "티/코스", search: "검색",
        find: "검색", next: "다음", clearDay: "일일 삭제",
        courseA: "코스 A", courseB: "코스 B", courseC: "코스 C", courseD: "코스 D",
        regular: "일반", vip: "VIP", society: "단체", tournament: "토너먼트",
        bookSlot: "슬롯 예약", bookingType: "예약 유형", course: "코스", tee: "티", time: "시간",
        golfers: "골퍼", addGolfer: "+ 골퍼 추가",
        golferName: "골퍼 이름", caddy: "캐디", searchCaddy: "캐디 검색...", noCaddy: "캐디 없음",
        notes: "메모", delete: "삭제", cancel: "취소", save: "저장",
        searchPlaceholder: "골퍼 또는 캐디...", confirmClear: "오늘 예약을 모두 삭제하시겠습니까?",
        noMatches: "결과를 찾을 수 없습니다.", player: "플레이어",
        blockTimeRange: "시간대 차단", rangeHint: "단체/그룹 예약용",
        startTime: "시작 시간", endTime: "종료 시간", groupName: "그룹/단체 이름",
        timeSlots: "시간대", slotsCount: "{n}개 슬롯", noGolfers: "골퍼 미배정",
        deleteGroup: "그룹 전체 삭제", confirmDeleteGroup: "이 그룹의 {n}개 슬롯을 모두 삭제하시겠습니까?",
        booked: "예약됨", caddyAlreadyBooked: "이 캐디는 해당 시간에 이미 예약되어 있습니다",
        // Recurring booking translations
        recurringBooking: "반복 예약", recurringHint: "정기 티타임용",
        repeatFrequency: "반복", repeatUntil: "까지", occurrences: "또는 횟수",
        repeatOn: "반복 요일:", daily: "매일", weekly: "매주", biweekly: "2주마다", monthly: "매월",
        sun: "일", mon: "월", tue: "화", wed: "수", thu: "목", fri: "금", sat: "토",
        recurringPreview: "{date}까지 {n}개 예약 생성",
        // Settings translations
        settings: "설정", teeSheetSettings: "티 시트 설정", courseConfig: "코스 설정",
        pricing: "그린피 & 요금", services: "캐디 & 카트", packages: "패키지 & 프로모션",
        courseDetails: "코스 정보", operatingHours: "운영 시간", firstTeeTime: "첫 티 타임",
        lastTeeTime: "마지막 티 타임", roundDuration: "라운드 시간 (시)", weekdayPricing: "평일 요금 (월-금)",
        weekendPricing: "주말/공휴일 요금 (토-일)", peak: "피크", offPeak: "오프피크", twilight: "트와일라잇",
        addPeriod: "시간대 추가", caddyFees: "캐디 요금", caddyFee18: "18홀 캐디 요금",
        caddyFee9: "9홀 캐디 요금", caddyTip: "권장 캐디 팁", cartFees: "카트 요금",
        cartFee18: "18홀 카트 요금", cartFee9: "9홀 카트 요금", cartSharing: "카트 공유",
        otherServices: "기타 서비스", clubRental: "클럽 렌탈", shoeRental: "신발 렌탈",
        rangeBalls: "연습구 (버킷)", societyRates: "단체 요금", minGroupSize: "최소 그룹 인원",
        societyDiscount: "할인 (%)", freeSlots: "그룹당 무료 슬롯", promotionalPackages: "프로모션 패키지",
        greenFee: "그린피", includesCaddy: "캐디 포함", includesCart: "카트 포함",
        validDays: "유효 요일", validFrom: "시작 시간", validUntil: "종료 시간", addPackage: "패키지 추가",
        currentSettings: "현재 설정 요약", layout: "레이아웃", hours: "시간", saveSettings: "설정 저장",
        yes: "예", no: "아니오"
      },
      ja: {
        teeSheet: "ティーシート", language: "言語", golfCourse: "ゴルフ場", date: "日付", courseLayout: "コースレイアウト",
        start: "開始", end: "終了", interval: "間隔", teesCourse: "ティー/コース", search: "検索",
        find: "検索", next: "次へ", clearDay: "日付クリア",
        courseA: "コース A", courseB: "コース B", courseC: "コース C", courseD: "コース D",
        regular: "一般", vip: "VIP", society: "団体", tournament: "トーナメント",
        bookSlot: "スロット予約", bookingType: "予約タイプ", course: "コース", tee: "ティー", time: "時間",
        golfers: "ゴルファー", addGolfer: "+ ゴルファー追加",
        golferName: "ゴルファー名", caddy: "キャディー", searchCaddy: "キャディー検索...", noCaddy: "キャディーなし",
        notes: "メモ", delete: "削除", cancel: "キャンセル", save: "保存",
        searchPlaceholder: "ゴルファーまたはキャディー...", confirmClear: "本日の予約をすべて削除しますか?",
        noMatches: "結果が見つかりません。", player: "プレイヤー",
        blockTimeRange: "時間帯をブロック", rangeHint: "団体/グループ予約用",
        startTime: "開始時間", endTime: "終了時間", groupName: "グループ/団体名",
        timeSlots: "タイムスロット", slotsCount: "{n}スロット", noGolfers: "ゴルファー未割当",
        deleteGroup: "グループ全体を削除", confirmDeleteGroup: "このグループの{n}スロットをすべて削除しますか?",
        booked: "予約済", caddyAlreadyBooked: "このキャディーはこの時間に既に予約されています",
        // Recurring booking translations
        recurringBooking: "繰り返し予約", recurringHint: "定期ティータイム用",
        repeatFrequency: "繰り返し", repeatUntil: "まで", occurrences: "または回数",
        repeatOn: "繰り返し曜日:", daily: "毎日", weekly: "毎週", biweekly: "隔週", monthly: "毎月",
        sun: "日", mon: "月", tue: "火", wed: "水", thu: "木", fri: "金", sat: "土",
        recurringPreview: "{date}まで{n}件の予約を作成",
        // Settings translations
        settings: "設定", teeSheetSettings: "ティーシート設定", courseConfig: "コース設定",
        pricing: "グリーンフィー & 料金", services: "キャディー & カート", packages: "パッケージ & プロモーション",
        courseDetails: "コース詳細", operatingHours: "営業時間", firstTeeTime: "最初のティータイム",
        lastTeeTime: "最後のティータイム", roundDuration: "ラウンド時間 (時)", weekdayPricing: "平日料金 (月-金)",
        weekendPricing: "週末/祝日料金 (土-日)", peak: "ピーク", offPeak: "オフピーク", twilight: "トワイライト",
        addPeriod: "時間帯を追加", caddyFees: "キャディー料金", caddyFee18: "18ホール キャディー料金",
        caddyFee9: "9ホール キャディー料金", caddyTip: "推奨キャディーチップ", cartFees: "カート料金",
        cartFee18: "18ホール カート料金", cartFee9: "9ホール カート料金", cartSharing: "カート共有",
        otherServices: "その他サービス", clubRental: "クラブレンタル", shoeRental: "シューズレンタル",
        rangeBalls: "練習球 (バケツ)", societyRates: "団体料金", minGroupSize: "最小グループサイズ",
        societyDiscount: "割引 (%)", freeSlots: "グループ毎の無料スロット", promotionalPackages: "プロモーションパッケージ",
        greenFee: "グリーンフィー", includesCaddy: "キャディー含む", includesCart: "カート含む",
        validDays: "有効曜日", validFrom: "開始", validUntil: "終了", addPackage: "パッケージ追加",
        currentSettings: "現在の設定概要", layout: "レイアウト", hours: "時間", saveSettings: "設定を保存",
        yes: "はい", no: "いいえ"
      }
    };

    let currentLang = localStorage.getItem('teesheet.lang') || 'en';

    function t(key) {
      return (translations[currentLang] && translations[currentLang][key]) || translations.en[key] || key;
    }

    function applyTranslations() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        el.textContent = t(el.dataset.i18n);
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        el.placeholder = t(el.dataset.i18nPlaceholder);
      });
    }

    // ==================== CADDY DATA ====================
    let allCaddies = [];
    if (window.CaddySystem && window.CaddySystem.allCaddys) {
      allCaddies = window.CaddySystem.allCaddys;
    } else {
      allCaddies = [
        { id: 1, name: "Somchai K.", number: "001", rating: 4.8, language: "TH/EN", status: "available" },
        { id: 2, name: "Napat P.", number: "002", rating: 4.9, language: "TH/EN/KO", status: "available" },
        { id: 3, name: "Wanida S.", number: "003", rating: 4.7, language: "TH/EN/JA", status: "available" },
        { id: 4, name: "Thanaporn M.", number: "004", rating: 4.6, language: "TH/EN", status: "available" },
        { id: 5, name: "Apinya R.", number: "005", rating: 4.9, language: "TH/EN/KO", status: "available" },
        { id: 6, name: "Channarong T.", number: "006", rating: 4.5, language: "TH/EN", status: "busy" },
        { id: 7, name: "Duangjai L.", number: "007", rating: 4.8, language: "TH/EN/JA", status: "available" },
        { id: 8, name: "Ekachai N.", number: "008", rating: 4.4, language: "TH/EN", status: "available" }
      ];
    }

    // ==================== DOM ====================
    const $ = id => document.getElementById(id);
    const el = {
      langSelect: $('lang-select'),
      courseSelect: $('course-select'),
      dateInput: $('date-input'),
      prevDay: $('prev-day'),
      nextDay: $('next-day'),
      complexSelect: $('complex-select'),
      startTime: $('start-time'),
      endTime: $('end-time'),
      intervalSelect: $('interval-select'),
      teesSelect: $('tees-select'),
      searchInput: $('search-input'),
      findBtn: $('find-btn'),
      nextBtn: $('next-btn'),
      clearBtn: $('clear-btn'),
      gridHeader: $('grid-header'),
      gridBody: $('grid-body'),
      legendC: $('legend-c'),
      legendD: $('legend-d'),
      dialog: $('booking-dialog'),
      closeDialog: $('close-dialog'),
      bookingId: $('booking-id'),
      bookingGroupId: $('booking-group-id'),
      bookingType: $('booking-type'),
      bookingCourse: $('booking-course'),
      bookingTee: $('booking-tee'),
      bookingTime: $('booking-time'),
      golfersList: $('golfers-list'),
      addGolfer: $('add-golfer'),
      bookingNotes: $('booking-notes'),
      deleteBooking: $('delete-booking'),
      cancelBooking: $('cancel-booking'),
      saveBooking: $('save-booking'),
      backToTop: $('back-to-top'),
      // Range booking elements
      rangeModeToggle: $('range-mode-toggle'),
      singleBookingRow: $('single-booking-row'),
      rangeTimeRow: $('range-time-row'),
      rangeGroupNameRow: $('range-group-name-row'),
      rangeStartTime: $('range-start-time'),
      rangeEndTime: $('range-end-time'),
      rangeCourse: $('range-course'),
      rangeTee: $('range-tee'),
      rangeType: $('range-type'),
      rangeInfo: $('range-info'),
      rangeGroupName: $('range-group-name'),
      singleGolfersSection: $('single-golfers-section'),
      rangeSlotsSection: $('range-slots-section'),
      rangeSlotsList: $('range-slots-list'),
      slotCountBadge: $('slot-count-badge'),
      // Recurring booking elements
      recurringToggle: $('recurring-toggle'),
      recurringOptions: $('recurring-options'),
      recurringFrequency: $('recurring-frequency'),
      recurringUntil: $('recurring-until'),
      recurringCount: $('recurring-count'),
      weekdaysRow: $('weekdays-row'),
      recurringPreview: $('recurring-preview')
    };

    // Current range slots data (for range booking mode)
    let rangeSlots = [];

    // ==================== HELPERS ====================
    const pad2 = n => String(n).padStart(2, '0');
    const minutes = hm => { const [h, m] = (hm || '').split(':').map(Number); return h * 60 + m; };
    const hhmm = m => `${pad2(Math.floor(m / 60))}:${pad2(m % 60)}`;
    const todayISO = () => { const d = new Date(); return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`; };
    const genId = () => crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substr(2, 9);

    // ==================== CADDY AVAILABILITY CHECK ====================
    // Round duration in minutes - a caddy is unavailable for this long after their tee time
    const ROUND_DURATION_MINUTES = 270; // 4.5 hours = 270 minutes

    /**
     * Check if a time slot falls within a caddy's active round
     * A caddy booked at 10:00 is unavailable from 10:00 to ~14:30 (4.5 hours)
     * @param {string} bookedTime - The time the caddy was booked (HH:MM)
     * @param {string} checkTime - The time we're checking availability for (HH:MM)
     * @returns {boolean} True if checkTime falls within the caddy's active round
     */
    function isTimeWithinRound(bookedTime, checkTime) {
      const bookedM = minutes(bookedTime);
      const checkM = minutes(checkTime);
      const roundEndM = bookedM + ROUND_DURATION_MINUTES;

      // Check if the time we're booking falls within the existing round's window
      // A new booking at checkTime would mean the caddy starts at checkTime
      // They conflict if: checkTime falls within [bookedTime, bookedTime + duration)
      // OR if: bookedTime falls within [checkTime, checkTime + duration)
      const newRoundEndM = checkM + ROUND_DURATION_MINUTES;

      // Overlap check: two time ranges overlap if start1 < end2 AND start2 < end1
      return (checkM < roundEndM) && (bookedM < newRoundEndM);
    }

    /**
     * Get all caddies that are already booked for a specific date and time
     * Takes into account that a round takes ~4.5 hours
     * @param {string} date - The date to check (YYYY-MM-DD)
     * @param {string} time - The time to check (HH:MM)
     * @param {string} excludeBookingId - Optional booking ID to exclude (for editing existing booking)
     * @returns {Set} Set of booked caddy numbers
     */
    function getBookedCaddiesForSlot(date, time, excludeBookingId = null) {
      const bookings = getDay(date);
      const bookedCaddyNumbers = new Set();

      bookings.forEach(booking => {
        // Skip the booking we're currently editing
        if (excludeBookingId && booking.id === excludeBookingId) return;

        // Check if this booking's time window overlaps with the requested time
        if (isTimeWithinRound(booking.time, time)) {
          // Collect all caddies from this booking's golfers
          const golfers = booking.golfers || [];
          golfers.forEach(g => {
            if (g.caddyNumber) {
              bookedCaddyNumbers.add(g.caddyNumber);
            }
          });
          // Also check legacy caddyNumber field
          if (booking.caddyNumber) {
            bookedCaddyNumbers.add(booking.caddyNumber);
          }
        }
      });

      return bookedCaddyNumbers;
    }

    /**
     * Get all caddies booked for a time range (for range booking mode)
     * Takes into account round duration for each slot
     * @param {string} date - The date to check
     * @param {string} startTime - Start time of range
     * @param {string} endTime - End time of range
     * @param {string} excludeGroupId - Optional group ID to exclude
     * @returns {Map} Map of time -> Set of booked caddy numbers
     */
    function getBookedCaddiesForRange(date, startTime, endTime, excludeGroupId = null) {
      const bookings = getDay(date);
      const bookedByTime = new Map();
      const startM = minutes(startTime);
      const endM = minutes(endTime);
      const step = parseInt(el.intervalSelect.value) || 7;

      // Initialize map for each time slot in range
      for (let m = startM; m <= endM; m += step) {
        bookedByTime.set(hhmm(m), new Set());
      }

      // For each time slot in range, check which caddies are booked
      bookedByTime.forEach((caddySet, slotTime) => {
        bookings.forEach(booking => {
          // Skip bookings from the group we're editing
          if (excludeGroupId && booking.groupId === excludeGroupId) return;

          // Check if this booking's time window overlaps with the slot time
          if (isTimeWithinRound(booking.time, slotTime)) {
            const golfers = booking.golfers || [];
            golfers.forEach(g => {
              if (g.caddyNumber) caddySet.add(g.caddyNumber);
            });
            if (booking.caddyNumber) caddySet.add(booking.caddyNumber);
          }
        });
      });

      return bookedByTime;
    }

    // Current slot context for caddy dropdown
    let currentSlotTime = null;
    let currentEditingBookingId = null;

    // ==================== STORAGE ====================
    const storageKey = d => `teesheet.bookings.v2::${d}`;
    const getDay = d => { try { return JSON.parse(localStorage.getItem(storageKey(d)) || '[]'); } catch { return []; } };
    const setDay = (d, arr) => localStorage.setItem(storageKey(d), JSON.stringify(arr || []));

    // Settings storage - persists course configuration
    const SETTINGS_KEY = 'teesheet.settings';
    function getSettings() {
      try {
        return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {};
      } catch { return {}; }
    }
    function saveSettings() {
      const settings = {
        golfCourse: el.courseSelect.value,
        courseLayout: el.complexSelect.value,
        startTime: el.startTime.value,
        endTime: el.endTime.value,
        interval: el.intervalSelect.value,
        teesPerCourse: el.teesSelect.value
      };
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      console.log('[TeeSheet] Settings saved:', settings);
    }

    // ==================== INIT ====================
    // Load saved settings first
    const savedSettings = getSettings();
    if (savedSettings.golfCourse) el.courseSelect.value = savedSettings.golfCourse;
    if (savedSettings.courseLayout) el.complexSelect.value = savedSettings.courseLayout;
    if (savedSettings.startTime) el.startTime.value = savedSettings.startTime;
    if (savedSettings.endTime) el.endTime.value = savedSettings.endTime;
    if (savedSettings.interval) el.intervalSelect.value = savedSettings.interval;
    if (savedSettings.teesPerCourse) el.teesSelect.value = savedSettings.teesPerCourse;
    console.log('[TeeSheet] Loaded settings:', savedSettings);

    if (!el.dateInput.value) el.dateInput.value = todayISO();
    el.langSelect.value = currentLang;

    // ==================== LAYOUT ====================
    function getCourses() {
      const v = el.complexSelect.value;
      if (v === '18') return ['A', 'B'];
      if (v === '27') return ['A', 'B', 'C'];
      return ['A', 'B', 'C', 'D'];
    }

    function getLayout() {
      const courses = getCourses();
      const teesPerCourse = parseInt(el.teesSelect.value) || 1;
      const cols = [];
      courses.forEach(c => {
        for (let i = 0; i < teesPerCourse; i++) cols.push({ course: c, tee: i + 1 });
      });
      return { courses, teesPerCourse, cols };
    }

    // ==================== RENDER ====================
    function render() {
      const layout = getLayout();
      const startM = minutes(el.startTime.value);
      const endM = minutes(el.endTime.value);
      const step = parseInt(el.intervalSelect.value) || 7;
      const bookings = getDay(el.dateInput.value);

      // Update legends
      el.legendC.style.display = layout.courses.includes('C') ? '' : 'none';
      el.legendD.style.display = layout.courses.includes('D') ? '' : 'none';

      // Set CSS variable for columns
      document.documentElement.style.setProperty('--cols', layout.cols.length);

      // Render header
      el.gridHeader.innerHTML = '';
      el.gridHeader.innerHTML = `<div class="grid-header-cell time-header">Time</div>`;
      layout.cols.forEach(col => {
        el.gridHeader.innerHTML += `<div class="grid-header-cell course-${col.course.toLowerCase()}">${col.course}-${col.tee}</div>`;
      });

      // Render rows
      el.gridBody.innerHTML = '';
      for (let m = startM; m <= endM; m += step) {
        const timeStr = hhmm(m);

        let rowHtml = `<div class="grid-row">`;
        rowHtml += `<div class="time-cell">${timeStr}</div>`;

        layout.cols.forEach((col, idx) => {
          const slotBookings = bookings.filter(b => b.time === timeStr && b.col === idx);
          let pillsHtml = '';
          slotBookings.forEach(b => {
            const golfers = b.golfers || [];
            const name = golfers.length > 0 ? golfers[0].name : (b.name || t('player'));
            const extra = golfers.length > 1 ? ` +${golfers.length - 1}` : '';
            const caddy = (golfers.length > 0 && golfers[0].caddyNumber) ? `C${golfers[0].caddyNumber}` : '';

            // Determine group position class for visual styling
            let groupClass = '';
            if (b.groupId && b.groupTotal > 1) {
              groupClass = 'range-group ';
              if (b.groupIndex === 0) groupClass += 'range-start';
              else if (b.groupIndex === b.groupTotal - 1) groupClass += 'range-end';
              else groupClass += 'range-middle';
            }

            // Show group name for group bookings
            const displayName = b.groupName ? `${b.groupName}` : name;
            const groupInfo = b.groupId ? `<span style="opacity:0.7;font-size:10px;">[${b.groupIndex + 1}/${b.groupTotal}]</span> ` : '';

            pillsHtml += `<div class="pill ${b.bookingType || 'regular'} ${groupClass}" data-id="${b.id}" data-group-id="${b.groupId || ''}" draggable="${b.groupId ? 'false' : 'true'}">
              <div class="pill-name">${groupInfo}${displayName}${extra}</div>
              <div class="pill-info">${caddy}</div>
            </div>`;
          });
          rowHtml += `<div class="slot course-${col.course.toLowerCase()}" data-time="${timeStr}" data-col="${idx}" data-course="${col.course}" data-tee="${col.tee}">${pillsHtml}</div>`;
        });

        rowHtml += `</div>`;
        el.gridBody.innerHTML += rowHtml;
      }

      // Attach slot click handlers
      document.querySelectorAll('.slot').forEach(slot => {
        slot.addEventListener('click', e => {
          if (e.target.closest('.pill')) return;
          openDialog({
            id: '', golfers: [], bookingType: 'regular',
            course: slot.dataset.course, tee: parseInt(slot.dataset.tee),
            time: slot.dataset.time, col: parseInt(slot.dataset.col), notes: ''
          });
        });
      });

      // Attach pill click handlers
      document.querySelectorAll('.pill').forEach(pill => {
        pill.addEventListener('click', e => {
          e.stopPropagation();
          const booking = bookings.find(b => b.id === pill.dataset.id);
          if (booking) openDialog(booking);
        });

        // Drag start
        pill.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text/plain', pill.dataset.id);
          pill.style.opacity = '0.5';
        });

        pill.addEventListener('dragend', e => {
          pill.style.opacity = '1';
        });
      });

      // Attach slot drag/drop handlers
      document.querySelectorAll('.slot').forEach(slot => {
        slot.addEventListener('dragover', e => {
          e.preventDefault();
          slot.style.background = '#e0f2fe';
        });

        slot.addEventListener('dragleave', e => {
          slot.style.background = '';
        });

        slot.addEventListener('drop', e => {
          e.preventDefault();
          slot.style.background = '';
          const bookingId = e.dataTransfer.getData('text/plain');
          if (!bookingId) return;

          const date = el.dateInput.value;
          const bookings = getDay(date);
          const bookingIdx = bookings.findIndex(b => b.id === bookingId);
          if (bookingIdx < 0) return;

          // Update booking with new slot info
          bookings[bookingIdx].time = slot.dataset.time;
          bookings[bookingIdx].col = parseInt(slot.dataset.col);
          bookings[bookingIdx].course = slot.dataset.course;
          bookings[bookingIdx].tee = parseInt(slot.dataset.tee);

          setDay(date, bookings);
          render();
        });
      });
    }

    // ==================== GOLFER ROWS ====================
    function createGolferRow(index, golfer = {}) {
      const row = document.createElement('div');
      row.className = 'golfer-row';
      const hasCaddy = golfer.caddyNumber ? true : false;
      row.innerHTML = `
        <div class="golfer-num">${index + 1}</div>
        <div class="golfer-fields">
          <div class="golfer-field">
            <label>${t('golferName')}</label>
            <input type="text" class="golfer-name" placeholder="${t('golferName')}" value="${golfer.name || ''}">
          </div>
          <div class="golfer-field">
            <label>${t('caddy')}</label>
            <div class="caddy-select-wrapper">
              <input type="text" class="caddy-input" placeholder="${t('searchCaddy')}" style="padding-right:32px;"
                value="${golfer.caddyNumber ? '#' + golfer.caddyNumber + ' - ' + (golfer.caddyName || '') : ''}"
                data-caddy-id="${golfer.caddyId || ''}" data-caddy-number="${golfer.caddyNumber || ''}" data-caddy-name="${golfer.caddyName || ''}">
              <button type="button" class="clear-caddy-btn" style="display:${hasCaddy ? 'flex' : 'none'};position:absolute;right:8px;top:50%;transform:translateY(-50%);width:20px;height:20px;border:none;background:#ef4444;color:#fff;border-radius:50%;font-size:14px;cursor:pointer;align-items:center;justify-content:center;line-height:1;">&times;</button>
              <div class="caddy-dropdown"></div>
            </div>
          </div>
        </div>
        ${index > 0 ? '<button type="button" class="remove-golfer">&times;</button>' : '<div style="width:32px"></div>'}
      `;

      const caddyInput = row.querySelector('.caddy-input');
      const dropdown = row.querySelector('.caddy-dropdown');
      const clearCaddyBtn = row.querySelector('.clear-caddy-btn');
      const removeBtn = row.querySelector('.remove-golfer');

      // Show/hide clear button based on caddy selection
      function updateClearBtn() {
        clearCaddyBtn.style.display = caddyInput.dataset.caddyNumber ? 'flex' : 'none';
      }

      caddyInput.addEventListener('focus', () => { renderCaddyDropdown(dropdown, caddyInput, ''); dropdown.classList.add('show'); });
      caddyInput.addEventListener('input', () => { renderCaddyDropdown(dropdown, caddyInput, caddyInput.value); dropdown.classList.add('show'); });
      caddyInput.addEventListener('blur', () => setTimeout(() => dropdown.classList.remove('show'), 200));

      // Clear caddy button
      clearCaddyBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        caddyInput.value = '';
        caddyInput.dataset.caddyId = '';
        caddyInput.dataset.caddyNumber = '';
        caddyInput.dataset.caddyName = '';
        updateClearBtn();
      });

      // Store updateClearBtn reference for external updates
      caddyInput._updateClearBtn = updateClearBtn;

      if (removeBtn) {
        removeBtn.addEventListener('click', () => {
          if (el.golfersList.children.length > 1) {
            row.remove();
            renumberGolfers();
          }
        });
      }

      return row;
    }

    function renderCaddyDropdown(dropdown, input, query) {
      dropdown.innerHTML = '';
      query = (query || '').toLowerCase();

      // Get booked caddies for current time slot (from other bookings)
      const currentTime = el.bookingTime.value;
      const bookedCaddies = getBookedCaddiesForSlot(el.dateInput.value, currentTime, currentEditingBookingId);

      // Also get caddies already assigned to OTHER golfers in THIS booking dialog
      const caddiesInThisGroup = new Set();
      const currentInputCaddyNumber = input.dataset.caddyNumber || '';
      Array.from(el.golfersList.children).forEach(row => {
        const caddyInput = row.querySelector('.caddy-input');
        if (caddyInput && caddyInput !== input) {
          const caddyNum = caddyInput.dataset.caddyNumber;
          if (caddyNum) caddiesInThisGroup.add(caddyNum);
        }
      });

      // Combine: external bookings + other golfers in same group
      const allUnavailable = new Set([...bookedCaddies, ...caddiesInThisGroup]);

      // No caddy option
      const noCaddyOpt = document.createElement('div');
      noCaddyOpt.className = 'caddy-option';
      noCaddyOpt.innerHTML = `<span class="caddy-option-name">${t('noCaddy')}</span>`;
      noCaddyOpt.addEventListener('mousedown', e => {
        e.preventDefault();
        input.value = '';
        input.dataset.caddyId = '';
        input.dataset.caddyNumber = '';
        input.dataset.caddyName = '';
      });
      dropdown.appendChild(noCaddyOpt);

      // Filter caddies - show all but mark booked/assigned ones
      allCaddies.filter(c => c.status === 'available' && (!query || (c.number + ' ' + c.name).toLowerCase().includes(query)))
        .slice(0, 10).forEach(caddy => {
          const isBookedExternal = bookedCaddies.has(caddy.number);
          const isInThisGroup = caddiesInThisGroup.has(caddy.number);
          const isUnavailable = isBookedExternal || isInThisGroup;
          const opt = document.createElement('div');
          opt.className = `caddy-option ${isUnavailable ? 'booked' : ''}`;
          opt.title = isUnavailable ? t('caddyAlreadyBooked') : '';
          const stars = '★'.repeat(Math.floor(caddy.rating));
          const badgeText = isInThisGroup ? 'IN GROUP' : (isBookedExternal ? t('booked') : '');
          const bookedBadge = isUnavailable ? `<span class="caddy-booked-badge">${badgeText}</span>` : '';
          opt.innerHTML = `<span class="caddy-option-name">#${caddy.number} ${caddy.name}${bookedBadge}</span>
            <span class="caddy-option-rating">${stars} ${caddy.rating}</span>
            <div class="caddy-option-info">${caddy.language}</div>`;

          if (!isUnavailable) {
            opt.addEventListener('mousedown', e => {
              e.preventDefault();
              input.value = `${caddy.number} - ${caddy.name}`;
              input.dataset.caddyId = caddy.id;
              input.dataset.caddyNumber = caddy.number;
              input.dataset.caddyName = caddy.name;
              // Show the clear button
              if (input._updateClearBtn) input._updateClearBtn();
            });
          } else {
            opt.addEventListener('mousedown', e => {
              e.preventDefault();
              // Show alert that caddy is already booked/assigned
              alert(isInThisGroup ? 'This caddy is already assigned to another golfer in this group' : t('caddyAlreadyBooked'));
            });
          }
          dropdown.appendChild(opt);
        });
    }

    function renumberGolfers() {
      Array.from(el.golfersList.children).forEach((row, i) => {
        row.querySelector('.golfer-num').textContent = i + 1;
      });
    }

    function getGolfersFromDialog() {
      return Array.from(el.golfersList.children).map(row => {
        const nameInput = row.querySelector('input.golfer-name');
        const caddyInput = row.querySelector('input.caddy-input');
        if (!nameInput) return null;
        return {
          name: nameInput.value.trim(),
          caddyId: caddyInput?.dataset.caddyId || null,
          caddyNumber: caddyInput?.dataset.caddyNumber || '',
          caddyName: caddyInput?.dataset.caddyName || ''
        };
      }).filter(g => g && g.name);
    }

    function setGolfersInDialog(golfers) {
      el.golfersList.innerHTML = '';
      (golfers.length ? golfers : [{}]).forEach((g, i) => {
        el.golfersList.appendChild(createGolferRow(i, g));
      });
    }

    el.addGolfer.addEventListener('click', () => {
      if (el.golfersList.children.length < 4) {
        el.golfersList.appendChild(createGolferRow(el.golfersList.children.length, {}));
      }
    });

    // ==================== RANGE BOOKING MODE ====================
    function toggleRangeMode(enabled) {
      el.singleBookingRow.style.display = enabled ? 'none' : '';
      el.singleGolfersSection.style.display = enabled ? 'none' : '';
      el.rangeTimeRow.style.display = enabled ? '' : 'none';
      el.rangeGroupNameRow.style.display = enabled ? '' : 'none';
      el.rangeSlotsSection.style.display = enabled ? '' : 'none';

      if (enabled) {
        updateRangeSlots();
      }
    }

    function getTimeSlots(startTime, endTime) {
      const startM = minutes(startTime);
      const endM = minutes(endTime);
      const step = parseInt(el.intervalSelect.value) || 7;
      const slots = [];

      for (let m = startM; m <= endM; m += step) {
        slots.push(hhmm(m));
      }
      return slots;
    }

    function updateRangeSlots() {
      const startTime = el.rangeStartTime.value;
      const endTime = el.rangeEndTime.value;

      if (!startTime || !endTime || minutes(startTime) > minutes(endTime)) {
        el.rangeInfo.textContent = '';
        el.slotCountBadge.textContent = '0 slots';
        rangeSlots = [];
        renderRangeSlots();
        return;
      }

      const slots = getTimeSlots(startTime, endTime);
      el.rangeInfo.textContent = `${slots.length} ${t('timeSlots').toLowerCase()}`;
      el.slotCountBadge.textContent = t('slotsCount').replace('{n}', slots.length);

      // Preserve existing slot data when updating
      const existingSlotMap = {};
      rangeSlots.forEach(s => { existingSlotMap[s.time] = s; });

      rangeSlots = slots.map(time => {
        if (existingSlotMap[time]) {
          return existingSlotMap[time];
        }
        return {
          time,
          golfers: [{ name: '', caddyId: null, caddyNumber: '', caddyName: '' }],
          collapsed: true
        };
      });

      renderRangeSlots();
    }

    function renderRangeSlots() {
      el.rangeSlotsList.innerHTML = '';

      rangeSlots.forEach((slot, slotIdx) => {
        const card = document.createElement('div');
        card.className = `slot-card ${slot.collapsed ? 'collapsed' : ''}`;
        card.dataset.slotIdx = slotIdx;

        const golferNames = slot.golfers.filter(g => g.name).map(g => g.name).join(', ');
        const caddyNums = slot.golfers.filter(g => g.caddyNumber).map(g => `C${g.caddyNumber}`).join(', ');
        const summary = golferNames || t('noGolfers');

        card.innerHTML = `
          <div class="slot-header">
            <span class="slot-time-badge">${slot.time}</span>
            <div class="slot-summary">
              <span class="names">${summary}</span>
              ${caddyNums ? ` <span style="color:var(--muted)">• ${caddyNums}</span>` : ''}
            </div>
            <span class="slot-expand-icon">▼</span>
          </div>
          <div class="slot-body" id="slot-body-${slotIdx}"></div>
        `;

        const header = card.querySelector('.slot-header');
        header.addEventListener('click', () => {
          slot.collapsed = !slot.collapsed;
          card.classList.toggle('collapsed');
        });

        el.rangeSlotsList.appendChild(card);

        // Render golfer rows inside slot body
        const slotBody = card.querySelector(`#slot-body-${slotIdx}`);
        renderSlotGolfers(slotBody, slot, slotIdx);
      });
    }

    function renderSlotGolfers(container, slot, slotIdx) {
      container.innerHTML = '';

      slot.golfers.forEach((golfer, gIdx) => {
        const row = createSlotGolferRow(slotIdx, gIdx, golfer);
        container.appendChild(row);
      });

      // Add golfer button (max 4 per slot)
      if (slot.golfers.length < 4) {
        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'add-golfer-btn';
        addBtn.textContent = t('addGolfer');
        addBtn.style.marginTop = '8px';
        addBtn.addEventListener('click', () => {
          slot.golfers.push({ name: '', caddyId: null, caddyNumber: '', caddyName: '' });
          renderSlotGolfers(container, slot, slotIdx);
          updateSlotCardSummary(slotIdx);
        });
        container.appendChild(addBtn);
      }
    }

    function createSlotGolferRow(slotIdx, gIdx, golfer) {
      const row = document.createElement('div');
      row.className = 'golfer-row';
      row.style.marginBottom = '8px';
      row.innerHTML = `
        <div class="golfer-num">${gIdx + 1}</div>
        <div class="golfer-fields">
          <div class="golfer-field">
            <label>${t('golferName')}</label>
            <input type="text" class="slot-golfer-name" placeholder="${t('golferName')}" value="${golfer.name || ''}"
              data-slot="${slotIdx}" data-golfer="${gIdx}">
          </div>
          <div class="golfer-field">
            <label>${t('caddy')}</label>
            <div class="caddy-select-wrapper">
              <input type="text" class="slot-caddy-input" placeholder="${t('searchCaddy')}"
                value="${golfer.caddyNumber ? '#' + golfer.caddyNumber + ' - ' + (golfer.caddyName || '') : ''}"
                data-caddy-id="${golfer.caddyId || ''}" data-caddy-number="${golfer.caddyNumber || ''}" data-caddy-name="${golfer.caddyName || ''}"
                data-slot="${slotIdx}" data-golfer="${gIdx}">
              <div class="caddy-dropdown"></div>
            </div>
          </div>
        </div>
        ${gIdx > 0 ? '<button type="button" class="remove-golfer">&times;</button>' : '<div style="width:32px"></div>'}
      `;

      // Name input handler
      const nameInput = row.querySelector('.slot-golfer-name');
      nameInput.addEventListener('input', () => {
        rangeSlots[slotIdx].golfers[gIdx].name = nameInput.value.trim();
        updateSlotCardSummary(slotIdx);
      });

      // Caddy input handler
      const caddyInput = row.querySelector('.slot-caddy-input');
      const dropdown = row.querySelector('.caddy-dropdown');

      caddyInput.addEventListener('focus', () => { renderCaddyDropdownForSlot(dropdown, caddyInput, '', slotIdx, gIdx); dropdown.classList.add('show'); });
      caddyInput.addEventListener('input', () => { renderCaddyDropdownForSlot(dropdown, caddyInput, caddyInput.value, slotIdx, gIdx); dropdown.classList.add('show'); });
      caddyInput.addEventListener('blur', () => setTimeout(() => dropdown.classList.remove('show'), 200));

      // Remove button
      const removeBtn = row.querySelector('.remove-golfer');
      if (removeBtn) {
        removeBtn.addEventListener('click', () => {
          if (rangeSlots[slotIdx].golfers.length > 1) {
            rangeSlots[slotIdx].golfers.splice(gIdx, 1);
            const slotBody = document.getElementById(`slot-body-${slotIdx}`);
            if (slotBody) renderSlotGolfers(slotBody, rangeSlots[slotIdx], slotIdx);
            updateSlotCardSummary(slotIdx);
          }
        });
      }

      return row;
    }

    function renderCaddyDropdownForSlot(dropdown, input, query, slotIdx, gIdx) {
      dropdown.innerHTML = '';
      query = (query || '').toLowerCase();

      // Get the specific time for this slot
      const slotTime = rangeSlots[slotIdx]?.time;
      const editingGroupId = el.bookingGroupId.value || null;

      // Get booked caddies for this specific time slot
      const bookedCaddies = getBookedCaddiesForSlot(el.dateInput.value, slotTime, null);

      // Also check what caddies are already assigned in OTHER slots of the same group at THIS time
      // (Allow same caddy in different time slots of same group, but not same time)
      const currentGroupCaddiesAtTime = new Set();
      rangeSlots.forEach((slot, idx) => {
        if (slot.time === slotTime && idx !== slotIdx) {
          slot.golfers.forEach(g => {
            if (g.caddyNumber) currentGroupCaddiesAtTime.add(g.caddyNumber);
          });
        }
      });

      // Combine external bookings with current group assignments at same time
      const allBookedForTime = new Set([...bookedCaddies, ...currentGroupCaddiesAtTime]);

      const noCaddyOpt = document.createElement('div');
      noCaddyOpt.className = 'caddy-option';
      noCaddyOpt.innerHTML = `<span class="caddy-option-name">${t('noCaddy')}</span>`;
      noCaddyOpt.addEventListener('mousedown', e => {
        e.preventDefault();
        input.value = '';
        input.dataset.caddyId = '';
        input.dataset.caddyNumber = '';
        input.dataset.caddyName = '';
        rangeSlots[slotIdx].golfers[gIdx].caddyId = null;
        rangeSlots[slotIdx].golfers[gIdx].caddyNumber = '';
        rangeSlots[slotIdx].golfers[gIdx].caddyName = '';
        updateSlotCardSummary(slotIdx);
      });
      dropdown.appendChild(noCaddyOpt);

      allCaddies.filter(c => c.status === 'available' && (!query || (c.number + ' ' + c.name).toLowerCase().includes(query)))
        .slice(0, 10).forEach(caddy => {
          const isBooked = allBookedForTime.has(caddy.number);
          const opt = document.createElement('div');
          opt.className = `caddy-option ${isBooked ? 'booked' : ''}`;
          opt.title = isBooked ? t('caddyAlreadyBooked') : '';
          const stars = '★'.repeat(Math.floor(caddy.rating));
          const bookedBadge = isBooked ? `<span class="caddy-booked-badge">${t('booked')}</span>` : '';
          opt.innerHTML = `<span class="caddy-option-name">#${caddy.number} ${caddy.name}${bookedBadge}</span>
            <span class="caddy-option-rating">${stars} ${caddy.rating}</span>
            <div class="caddy-option-info">${caddy.language}</div>`;

          if (!isBooked) {
            opt.addEventListener('mousedown', e => {
              e.preventDefault();
              input.value = `${caddy.number} - ${caddy.name}`;
              input.dataset.caddyId = caddy.id;
              input.dataset.caddyNumber = caddy.number;
              input.dataset.caddyName = caddy.name;
              rangeSlots[slotIdx].golfers[gIdx].caddyId = caddy.id;
              rangeSlots[slotIdx].golfers[gIdx].caddyNumber = caddy.number;
              rangeSlots[slotIdx].golfers[gIdx].caddyName = caddy.name;
              updateSlotCardSummary(slotIdx);
            });
          } else {
            opt.addEventListener('mousedown', e => {
              e.preventDefault();
              alert(t('caddyAlreadyBooked'));
            });
          }
          dropdown.appendChild(opt);
        });
    }

    function updateSlotCardSummary(slotIdx) {
      const slot = rangeSlots[slotIdx];
      const card = document.querySelector(`.slot-card[data-slot-idx="${slotIdx}"]`);
      if (!card) return;

      const golferNames = slot.golfers.filter(g => g.name).map(g => g.name).join(', ');
      const caddyNums = slot.golfers.filter(g => g.caddyNumber).map(g => `C${g.caddyNumber}`).join(', ');
      const summary = golferNames || t('noGolfers');

      const summaryEl = card.querySelector('.slot-summary');
      if (summaryEl) {
        summaryEl.innerHTML = `<span class="names">${summary}</span>${caddyNums ? ` <span style="color:var(--muted)">• ${caddyNums}</span>` : ''}`;
      }
    }

    // Range mode toggle handler
    el.rangeModeToggle.addEventListener('change', () => {
      toggleRangeMode(el.rangeModeToggle.checked);
    });

    // Range time change handlers
    el.rangeStartTime.addEventListener('change', updateRangeSlots);
    el.rangeEndTime.addEventListener('change', updateRangeSlots);

    // ==================== RECURRING BOOKING ====================
    el.recurringToggle?.addEventListener('change', () => {
      const show = el.recurringToggle.checked;
      el.recurringOptions.style.display = show ? 'block' : 'none';
      if (show) {
        // Set default end date to 3 months from now
        const defaultEnd = new Date(el.dateInput.value);
        defaultEnd.setMonth(defaultEnd.getMonth() + 3);
        el.recurringUntil.value = defaultEnd.toISOString().split('T')[0];
        // Default to current day of week checked
        const currentDow = new Date(el.dateInput.value).getDay();
        document.querySelectorAll('input[name="weekday"]').forEach(cb => {
          cb.checked = parseInt(cb.value) === currentDow;
        });
        updateRecurringPreview();
      }
    });

    el.recurringFrequency?.addEventListener('change', () => {
      const freq = el.recurringFrequency.value;
      // Show weekdays row only for weekly/biweekly
      el.weekdaysRow.style.display = (freq === 'weekly' || freq === 'biweekly') ? 'flex' : 'none';
      updateRecurringPreview();
    });

    el.recurringUntil?.addEventListener('change', updateRecurringPreview);
    el.recurringCount?.addEventListener('input', updateRecurringPreview);
    document.querySelectorAll('input[name="weekday"]').forEach(cb => {
      cb.addEventListener('change', updateRecurringPreview);
    });

    function getRecurringDates() {
      const startDate = new Date(el.dateInput.value + 'T00:00:00');
      const frequency = el.recurringFrequency.value;
      const untilDate = el.recurringUntil.value ? new Date(el.recurringUntil.value + 'T23:59:59') : null;
      const maxCount = parseInt(el.recurringCount.value) || 52;
      const selectedDays = Array.from(document.querySelectorAll('input[name="weekday"]:checked')).map(cb => parseInt(cb.value));

      const dates = [];
      let current = new Date(startDate);
      let count = 0;

      // Max iterations to prevent infinite loops
      const maxIterations = 365;
      let iterations = 0;

      while (iterations < maxIterations && count < maxCount && (!untilDate || current <= untilDate)) {
        if (frequency === 'daily') {
          dates.push(new Date(current));
          count++;
          current.setDate(current.getDate() + 1);
        } else if (frequency === 'weekly' || frequency === 'biweekly') {
          if (selectedDays.length === 0 || selectedDays.includes(current.getDay())) {
            dates.push(new Date(current));
            count++;
          }
          current.setDate(current.getDate() + 1);
          // For biweekly, skip to next week after completing one week
          if (frequency === 'biweekly' && current.getDay() === startDate.getDay()) {
            current.setDate(current.getDate() + 7);
          }
        } else if (frequency === 'monthly') {
          dates.push(new Date(current));
          count++;
          current.setMonth(current.getMonth() + 1);
        }
        iterations++;
      }

      return dates;
    }

    function updateRecurringPreview() {
      if (!el.recurringToggle?.checked) return;
      const dates = getRecurringDates();
      if (dates.length > 0) {
        const lastDate = dates[dates.length - 1];
        const dateStr = lastDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        el.recurringPreview.innerHTML = `<strong>${dates.length}</strong> bookings will be created through <strong>${dateStr}</strong>`;
      } else {
        el.recurringPreview.innerHTML = 'No dates selected';
      }
    }

    function resetRecurringSection() {
      el.recurringToggle.checked = false;
      el.recurringOptions.style.display = 'none';
      el.recurringFrequency.value = 'weekly';
      el.recurringUntil.value = '';
      el.recurringCount.value = '';
      el.weekdaysRow.style.display = 'flex';
      document.querySelectorAll('input[name="weekday"]').forEach(cb => cb.checked = false);
      el.recurringPreview.innerHTML = '';
    }

    // ==================== DIALOG ====================
    function openDialog(seed) {
      // Set the current editing booking ID for caddy availability check
      currentEditingBookingId = seed.id || null;

      el.bookingId.value = seed.id || '';
      el.bookingGroupId.value = seed.groupId || '';
      el.bookingType.value = seed.bookingType || 'regular';
      el.bookingNotes.value = seed.notes || '';

      // Populate time dropdowns with all available time slots
      const startM = minutes(el.startTime.value);
      const endM = minutes(el.endTime.value);
      const step = parseInt(el.intervalSelect.value) || 7;

      // Single booking time
      el.bookingTime.innerHTML = '';
      for (let m = startM; m <= endM; m += step) {
        const timeStr = hhmm(m);
        const opt = document.createElement('option');
        opt.value = timeStr;
        opt.textContent = timeStr;
        if (timeStr === seed.time) opt.selected = true;
        el.bookingTime.appendChild(opt);
      }

      // Range booking times
      el.rangeStartTime.innerHTML = '';
      el.rangeEndTime.innerHTML = '';
      for (let m = startM; m <= endM; m += step) {
        const timeStr = hhmm(m);
        const optStart = document.createElement('option');
        optStart.value = timeStr;
        optStart.textContent = timeStr;
        if (timeStr === seed.time) optStart.selected = true;
        el.rangeStartTime.appendChild(optStart);

        const optEnd = document.createElement('option');
        optEnd.value = timeStr;
        optEnd.textContent = timeStr;
        el.rangeEndTime.appendChild(optEnd);
      }

      // Set a default end time (1 hour after start)
      const defaultEndM = Math.min(minutes(seed.time) + 60, endM);
      el.rangeEndTime.value = hhmm(defaultEndM);

      // Populate course dropdowns
      const courses = getCourses();
      el.bookingCourse.innerHTML = '';
      el.rangeCourse.innerHTML = '';
      courses.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = t('course') + ' ' + c;
        if (c === seed.course) opt.selected = true;
        el.bookingCourse.appendChild(opt);

        const optRange = document.createElement('option');
        optRange.value = c;
        optRange.textContent = t('course') + ' ' + c;
        if (c === seed.course) optRange.selected = true;
        el.rangeCourse.appendChild(optRange);
      });

      el.bookingTee.value = seed.tee || 1;
      el.rangeTee.value = seed.tee || 1;

      // Reset range mode
      el.rangeModeToggle.checked = false;
      rangeSlots = [];
      el.rangeGroupName.value = '';
      toggleRangeMode(false);
      resetRecurringSection();

      // Check if this is part of a group booking - if so, open group edit mode
      if (seed.groupId) {
        const date = el.dateInput.value;
        const bookings = getDay(date);
        const groupBookings = bookings.filter(b => b.groupId === seed.groupId);

        if (groupBookings.length > 1) {
          el.rangeModeToggle.checked = true;
          el.rangeGroupName.value = seed.groupName || '';
          el.rangeType.value = seed.bookingType || 'society';

          // Sort by time and set range
          groupBookings.sort((a, b) => minutes(a.time) - minutes(b.time));
          el.rangeStartTime.value = groupBookings[0].time;
          el.rangeEndTime.value = groupBookings[groupBookings.length - 1].time;

          // Populate rangeSlots with existing data
          rangeSlots = groupBookings.map(b => ({
            time: b.time,
            golfers: b.golfers || [{ name: b.name || '', caddyNumber: b.caddyNumber || '', caddyId: null, caddyName: '' }],
            collapsed: true,
            id: b.id
          }));

          toggleRangeMode(true);
        }
      }

      let golfers = seed.golfers || [];
      if (!golfers.length && seed.name) golfers = [{ name: seed.name, caddyNumber: seed.caddyNumber || '' }];
      setGolfersInDialog(golfers);

      el.deleteBooking.style.display = seed.id ? '' : 'none';
      el.dialog.showModal();
    }

    el.closeDialog.addEventListener('click', () => el.dialog.close());
    el.cancelBooking.addEventListener('click', () => el.dialog.close());

    el.saveBooking.addEventListener('click', () => {
      const date = el.dateInput.value;
      let bookings = getDay(date);
      const layout = getLayout();

      // ==================== DOUBLE BOOKING VALIDATION ====================
      function validateNoDuplicateCaddies(golfersToSave, time, excludeBookingId = null) {
        const bookedCaddies = getBookedCaddiesForSlot(date, time, excludeBookingId);
        const conflicts = [];
        golfersToSave.forEach(g => {
          if (g.caddyNumber && bookedCaddies.has(g.caddyNumber)) {
            conflicts.push(`${g.caddyName || g.caddyNumber} @ ${time}`);
          }
        });
        return conflicts;
      }

      // Check if range mode is enabled
      if (el.rangeModeToggle.checked && rangeSlots.length > 0) {
        // Range booking mode - create/update multiple bookings
        const course = el.rangeCourse.value;
        const tee = parseInt(el.rangeTee.value);
        const colIndex = layout.cols.findIndex(c => c.course === course && c.tee === tee);
        const bookingType = el.rangeType.value;
        const groupName = el.rangeGroupName.value.trim();
        const notes = el.bookingNotes.value;

        // Use existing groupId or create new one
        const groupId = el.bookingGroupId.value || genId();

        // Remove existing group bookings if editing
        if (el.bookingGroupId.value) {
          bookings = bookings.filter(b => b.groupId !== el.bookingGroupId.value);
        }

        // Validate no double-booked caddies in range mode
        const allConflicts = [];
        rangeSlots.forEach(slot => {
          const golfers = slot.golfers.filter(g => g.name && g.caddyNumber);
          const conflicts = validateNoDuplicateCaddies(golfers, slot.time, slot.id);
          allConflicts.push(...conflicts);
        });

        if (allConflicts.length > 0) {
          alert(`${t('caddyAlreadyBooked')}:\n\n${allConflicts.join('\n')}`);
          return;
        }

        // Create bookings for each slot
        rangeSlots.forEach((slot, idx) => {
          const golfers = slot.golfers.filter(g => g.name);
          if (!golfers.length) golfers.push({ name: groupName || t('player'), caddyNumber: '', caddyId: null, caddyName: '' });

          const booking = {
            id: slot.id || genId(),
            groupId,
            groupName,
            groupIndex: idx,
            groupTotal: rangeSlots.length,
            bookingType,
            course, tee, col: colIndex,
            time: slot.time,
            golfers,
            notes,
            name: golfers[0]?.name || groupName || '',
            caddyNumber: golfers[0]?.caddyNumber || ''
          };

          bookings.push(booking);
        });

        console.log(`[TeeSheet] Saved group booking: ${rangeSlots.length} slots, groupId=${groupId}`);

      } else {
        // Single booking mode
        const course = el.bookingCourse.value;
        const tee = parseInt(el.bookingTee.value);
        const colIndex = layout.cols.findIndex(c => c.course === course && c.tee === tee);
        const golfers = getGolfersFromDialog();
        const bookingTime = el.bookingTime.value;

        if (!golfers.length) golfers.push({ name: t('player'), caddyNumber: '' });

        // Validate no double-booked caddies
        const golfersWithCaddies = golfers.filter(g => g.caddyNumber);
        const conflicts = validateNoDuplicateCaddies(golfersWithCaddies, bookingTime, el.bookingId.value);
        if (conflicts.length > 0) {
          alert(`${t('caddyAlreadyBooked')}:\n\n${conflicts.join('\n')}`);
          return;
        }

        const booking = {
          id: el.bookingId.value || genId(),
          bookingType: el.bookingType.value,
          course, tee, col: colIndex,
          time: bookingTime,
          golfers,
          notes: el.bookingNotes.value,
          name: golfers[0]?.name || '',
          caddyNumber: golfers[0]?.caddyNumber || ''
        };

        const idx = bookings.findIndex(b => b.id === booking.id);
        if (idx >= 0) bookings[idx] = booking;
        else bookings.push(booking);

        // Handle recurring bookings
        if (el.recurringToggle?.checked && !el.bookingId.value) {
          const recurringDates = getRecurringDates();
          // Skip the first date since we already created it above
          const futureDates = recurringDates.slice(1);

          if (futureDates.length > 0) {
            // Generate a recurring group ID to link all these bookings
            const recurringGroupId = 'rec_' + genId();
            booking.recurringGroupId = recurringGroupId;

            futureDates.forEach(futureDate => {
              const futureDateStr = futureDate.toISOString().split('T')[0];
              const futureDayBookings = getDay(futureDateStr);

              const recurringBooking = {
                id: genId(),
                bookingType: booking.bookingType,
                course: booking.course,
                tee: booking.tee,
                col: booking.col,
                time: booking.time,
                golfers: JSON.parse(JSON.stringify(booking.golfers)), // Deep copy
                notes: booking.notes,
                name: booking.name,
                caddyNumber: booking.caddyNumber,
                recurringGroupId: recurringGroupId
              };

              futureDayBookings.push(recurringBooking);
              setDay(futureDateStr, futureDayBookings);
            });

            console.log(`[TeeSheet] Created ${futureDates.length + 1} recurring bookings`);
          }
        }
      }

      setDay(date, bookings);
      el.dialog.close();
      render();
    });

    el.deleteBooking.addEventListener('click', () => {
      const date = el.dateInput.value;
      let bookings = getDay(date);

      // Check if this is a group booking
      const groupId = el.bookingGroupId.value;
      if (groupId) {
        const groupBookings = bookings.filter(b => b.groupId === groupId);
        const confirmMsg = t('confirmDeleteGroup').replace('{n}', groupBookings.length);
        if (confirm(confirmMsg)) {
          bookings = bookings.filter(b => b.groupId !== groupId);
        } else {
          return; // User cancelled
        }
      } else {
        bookings = bookings.filter(b => b.id !== el.bookingId.value);
      }

      setDay(date, bookings);
      el.dialog.close();
      render();
    });

    // ==================== CONTROLS ====================
    el.prevDay.addEventListener('click', () => {
      const d = new Date(el.dateInput.value);
      d.setDate(d.getDate() - 1);
      el.dateInput.value = d.toISOString().split('T')[0];
      render();
    });

    el.nextDay.addEventListener('click', () => {
      const d = new Date(el.dateInput.value);
      d.setDate(d.getDate() + 1);
      el.dateInput.value = d.toISOString().split('T')[0];
      render();
    });

    el.dateInput.addEventListener('change', render);

    // Settings controls - save on change
    el.courseSelect.addEventListener('change', () => { saveSettings(); render(); });
    el.complexSelect.addEventListener('change', () => { saveSettings(); render(); });
    el.startTime.addEventListener('change', () => { saveSettings(); render(); });
    el.endTime.addEventListener('change', () => { saveSettings(); render(); });
    el.intervalSelect.addEventListener('change', () => { saveSettings(); render(); });
    el.teesSelect.addEventListener('change', () => { saveSettings(); render(); });

    el.clearBtn.addEventListener('click', () => {
      if (confirm(t('confirmClear'))) {
        setDay(el.dateInput.value, []);
        render();
      }
    });

    el.langSelect.addEventListener('change', () => {
      currentLang = el.langSelect.value;
      localStorage.setItem('teesheet.lang', currentLang);
      applyTranslations();
      render();
    });

    // ==================== SEARCH ====================
    let searchResults = [], searchIdx = 0;

    el.findBtn.addEventListener('click', () => {
      const q = el.searchInput.value.toLowerCase().trim();
      if (!q) return;
      const bookings = getDay(el.dateInput.value);
      searchResults = bookings.filter(b => {
        // Search in booking-level fields
        if ((b.name || '').toLowerCase().includes(q)) return true;
        if ((b.caddyNumber || '').toLowerCase().includes(q)) return true;

        // Search in each golfer
        const golfers = b.golfers || [];
        return golfers.some(g => {
          if ((g.name || '').toLowerCase().includes(q)) return true;
          if ((g.caddyNumber || '').toLowerCase().includes(q)) return true;
          if ((g.caddyName || '').toLowerCase().includes(q)) return true;
          return false;
        });
      });
      searchIdx = 0;
      if (searchResults.length) highlightBooking(searchResults[0]);
      else alert(t('noMatches'));
    });

    el.nextBtn.addEventListener('click', () => {
      if (!searchResults.length) { el.findBtn.click(); return; }
      searchIdx = (searchIdx + 1) % searchResults.length;
      highlightBooking(searchResults[searchIdx]);
    });

    function highlightBooking(booking) {
      const pill = document.querySelector(`.pill[data-id="${booking.id}"]`);
      if (pill) {
        pill.scrollIntoView({ behavior: 'smooth', block: 'center' });
        pill.style.outline = '3px solid #3b82f6';
        setTimeout(() => pill.style.outline = '', 1500);
      }
    }

    el.searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') el.findBtn.click(); });

    // ==================== BACK TO TOP ====================
    // Back to top - listen on main-content since that's where scrolling happens
    const mainContent = document.querySelector('.main-content');
    mainContent?.addEventListener('scroll', () => {
      if (mainContent.scrollTop > 300) {
        el.backToTop.classList.add('show');
      } else {
        el.backToTop.classList.remove('show');
      }
    });

    el.backToTop.addEventListener('click', () => {
      mainContent?.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // ==================== SETTINGS MODAL ====================
    const settingsDialog = $('settings-dialog');
    const settingsBtn = $('settings-btn');
    const closeSettings = $('close-settings');
    const cancelSettings = $('cancel-settings');
    const saveSettingsBtn = $('save-settings');

    // Settings form elements
    const settingsEls = {
      course: $('settings-course'),
      layout: $('settings-layout'),
      tees: $('settings-tees'),
      start: $('settings-start'),
      end: $('settings-end'),
      interval: $('settings-interval'),
      roundDuration: $('settings-round-duration'),
      // Caddy & Cart
      caddyFee18: $('caddy-fee-18'),
      caddyFee9: $('caddy-fee-9'),
      caddyTip: $('caddy-tip'),
      cartFee18: $('cart-fee-18'),
      cartFee9: $('cart-fee-9'),
      cartSharing: $('cart-sharing'),
      clubRental: $('club-rental'),
      shoeRental: $('shoe-rental'),
      rangeBalls: $('range-balls'),
      // Society rates
      societyMinSize: $('society-min-size'),
      societyDiscount: $('society-discount'),
      societyFreeSlots: $('society-free-slots'),
      // Summary
      summaryCourse: $('summary-course'),
      summaryLayout: $('summary-layout'),
      summaryHours: $('summary-hours'),
      summaryInterval: $('summary-interval')
    };

    // Extended settings storage key
    const FULL_SETTINGS_KEY = 'teesheet.fullSettings';

    // Load full settings from localStorage
    function getFullSettings() {
      try {
        return JSON.parse(localStorage.getItem(FULL_SETTINGS_KEY)) || {};
      } catch { return {}; }
    }

    // Save full settings to localStorage
    function saveFullSettings(settings) {
      localStorage.setItem(FULL_SETTINGS_KEY, JSON.stringify(settings));
    }

    // Get pricing periods from DOM
    function getPricingPeriods(containerId) {
      const container = $(containerId);
      const periods = [];
      container.querySelectorAll('.time-period-row').forEach(row => {
        const labelEl = row.querySelector('.time-period-label');
        // Check if it's an input or a span
        const label = labelEl?.tagName === 'INPUT' ? labelEl.value : (labelEl?.textContent || 'Period');
        periods.push({
          label: label,
          start: row.querySelector('.period-start')?.value || '',
          end: row.querySelector('.period-end')?.value || '',
          price: parseInt(row.querySelector('.period-price')?.value) || 0
        });
      });
      return periods;
    }

    // Set pricing periods in DOM
    function setPricingPeriods(containerId, periods) {
      const container = $(containerId);
      // Clear existing rows
      container.innerHTML = '';
      (periods || []).forEach(period => {
        addPeriodRow(containerId, period.label, period.start, period.end, period.price);
      });
    }

    // Add a new time period row
    function addPeriodRow(containerId, label = 'Period', start = '', end = '', price = 0) {
      const container = $(containerId);
      const row = document.createElement('div');
      row.className = 'time-period-row';
      row.innerHTML = `
        <input type="text" class="time-period-label" value="${label}" style="width:80px;background:#f0f0f0;border:1px solid #ddd;padding:6px 8px;border-radius:4px;">
        <input type="time" class="period-start" value="${start}">
        <input type="time" class="period-end" value="${end}">
        <div class="currency-input">
          <input type="number" class="period-price" value="${price}" placeholder="Price">
        </div>
        <button class="remove-period-btn" title="Remove">&times;</button>
      `;
      row.querySelector('.remove-period-btn').addEventListener('click', () => row.remove());
      container.appendChild(row);
    }

    // Get packages from DOM
    function getPackages() {
      const container = $('packages-list');
      const packages = [];
      container.querySelectorAll('.package-card').forEach(card => {
        packages.push({
          name: card.querySelector('.package-name')?.value || '',
          greenFee: parseInt(card.querySelector('.pkg-green-fee')?.value) || 0,
          includesCaddy: card.querySelector('.pkg-includes-caddy')?.value || 'no',
          includesCart: card.querySelector('.pkg-includes-cart')?.value || 'no',
          validDays: card.querySelector('.pkg-valid-days')?.value || 'all',
          validFrom: card.querySelector('.pkg-valid-from')?.value || '',
          validUntil: card.querySelector('.pkg-valid-until')?.value || ''
        });
      });
      return packages;
    }

    // Set packages in DOM
    function setPackages(packages) {
      const container = $('packages-list');
      container.innerHTML = '';
      (packages || []).forEach(pkg => addPackageCard(pkg));
    }

    // Add a new package card
    function addPackageCard(pkg = {}) {
      const container = $('packages-list');
      const card = document.createElement('div');
      card.className = 'package-card';
      card.innerHTML = `
        <div class="package-header">
          <input type="text" class="package-name" value="${pkg.name || ''}" placeholder="Package Name">
          <button class="remove-period-btn remove-package">&times;</button>
        </div>
        <div class="package-fields">
          <div class="package-field">
            <label data-i18n="greenFee">Green Fee</label>
            <div class="currency-input">
              <input type="number" class="pkg-green-fee" value="${pkg.greenFee || 0}">
            </div>
          </div>
          <div class="package-field">
            <label data-i18n="includesCaddy">Includes Caddy</label>
            <select class="pkg-includes-caddy">
              <option value="yes" ${pkg.includesCaddy === 'yes' ? 'selected' : ''}>Yes</option>
              <option value="no" ${pkg.includesCaddy !== 'yes' ? 'selected' : ''}>No</option>
            </select>
          </div>
          <div class="package-field">
            <label data-i18n="includesCart">Includes Cart</label>
            <select class="pkg-includes-cart">
              <option value="yes" ${pkg.includesCart === 'yes' ? 'selected' : ''}>Yes</option>
              <option value="no" ${pkg.includesCart !== 'yes' ? 'selected' : ''}>No</option>
            </select>
          </div>
          <div class="package-field">
            <label data-i18n="validDays">Valid Days</label>
            <select class="pkg-valid-days">
              <option value="weekday" ${pkg.validDays === 'weekday' ? 'selected' : ''}>Mon-Fri</option>
              <option value="weekend" ${pkg.validDays === 'weekend' ? 'selected' : ''}>Sat-Sun</option>
              <option value="all" ${pkg.validDays === 'all' || !pkg.validDays ? 'selected' : ''}>All Days</option>
            </select>
          </div>
          <div class="package-field">
            <label data-i18n="validFrom">Valid From</label>
            <input type="time" class="pkg-valid-from" value="${pkg.validFrom || '06:00'}">
          </div>
          <div class="package-field">
            <label data-i18n="validUntil">Valid Until</label>
            <input type="time" class="pkg-valid-until" value="${pkg.validUntil || '18:00'}">
          </div>
        </div>
      `;
      card.querySelector('.remove-package').addEventListener('click', () => card.remove());
      container.appendChild(card);
      applyTranslations();
    }

    // Load settings into modal
    function loadSettingsIntoModal() {
      const full = getFullSettings();
      const basic = getSettings();

      // Course config - sync from tee sheet controls
      settingsEls.course.value = basic.golfCourse || el.courseSelect.value || '';
      settingsEls.layout.value = basic.courseLayout || el.complexSelect.value || '18';
      settingsEls.tees.value = basic.teesPerCourse || el.teesSelect.value || '1';
      settingsEls.start.value = basic.startTime || el.startTime.value || '06:00';
      settingsEls.end.value = basic.endTime || el.endTime.value || '18:00';
      settingsEls.interval.value = basic.interval || el.intervalSelect.value || '7';
      settingsEls.roundDuration.value = full.roundDuration || '270';

      // Caddy & Cart fees
      settingsEls.caddyFee18.value = full.caddyFee18 || 400;
      settingsEls.caddyFee9.value = full.caddyFee9 || 250;
      settingsEls.caddyTip.value = full.caddyTip || 300;
      settingsEls.cartFee18.value = full.cartFee18 || 700;
      settingsEls.cartFee9.value = full.cartFee9 || 400;
      settingsEls.cartSharing.value = full.cartSharing || 'shared';
      settingsEls.clubRental.value = full.clubRental || 1500;
      settingsEls.shoeRental.value = full.shoeRental || 300;
      settingsEls.rangeBalls.value = full.rangeBalls || 100;

      // Society rates
      settingsEls.societyMinSize.value = full.societyMinSize || 12;
      settingsEls.societyDiscount.value = full.societyDiscount || 15;
      settingsEls.societyFreeSlots.value = full.societyFreeSlots || 1;

      // Pricing periods
      if (full.weekdayPeriods && full.weekdayPeriods.length > 0) {
        setPricingPeriods('weekday-periods', full.weekdayPeriods);
      }
      if (full.weekendPeriods && full.weekendPeriods.length > 0) {
        setPricingPeriods('weekend-periods', full.weekendPeriods);
      }

      // Packages
      if (full.packages && full.packages.length > 0) {
        setPackages(full.packages);
      }

      // Update summary
      updateSettingsSummary();
    }

    // Save settings from modal
    function saveSettingsFromModal() {
      // Basic settings (sync with tee sheet controls)
      const basicSettings = {
        golfCourse: settingsEls.course.value,
        courseLayout: settingsEls.layout.value,
        teesPerCourse: settingsEls.tees.value,
        startTime: settingsEls.start.value,
        endTime: settingsEls.end.value,
        interval: settingsEls.interval.value
      };
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(basicSettings));

      // Full settings
      const fullSettings = {
        roundDuration: settingsEls.roundDuration.value,
        // Caddy & Cart
        caddyFee18: parseInt(settingsEls.caddyFee18.value) || 400,
        caddyFee9: parseInt(settingsEls.caddyFee9.value) || 250,
        caddyTip: parseInt(settingsEls.caddyTip.value) || 300,
        cartFee18: parseInt(settingsEls.cartFee18.value) || 700,
        cartFee9: parseInt(settingsEls.cartFee9.value) || 400,
        cartSharing: settingsEls.cartSharing.value,
        clubRental: parseInt(settingsEls.clubRental.value) || 1500,
        shoeRental: parseInt(settingsEls.shoeRental.value) || 300,
        rangeBalls: parseInt(settingsEls.rangeBalls.value) || 100,
        // Society
        societyMinSize: parseInt(settingsEls.societyMinSize.value) || 12,
        societyDiscount: parseInt(settingsEls.societyDiscount.value) || 15,
        societyFreeSlots: parseInt(settingsEls.societyFreeSlots.value) || 1,
        // Pricing
        weekdayPeriods: getPricingPeriods('weekday-periods'),
        weekendPeriods: getPricingPeriods('weekend-periods'),
        // Packages
        packages: getPackages()
      };
      saveFullSettings(fullSettings);

      // Sync with tee sheet controls
      el.courseSelect.value = basicSettings.golfCourse;
      el.complexSelect.value = basicSettings.courseLayout;
      el.teesSelect.value = basicSettings.teesPerCourse;
      el.startTime.value = basicSettings.startTime;
      el.endTime.value = basicSettings.endTime;
      el.intervalSelect.value = basicSettings.interval;

      console.log('[TeeSheet] Settings saved:', { basic: basicSettings, full: fullSettings });
    }

    // Update settings summary panel
    function updateSettingsSummary() {
      const courseOption = settingsEls.course.options[settingsEls.course.selectedIndex];
      settingsEls.summaryCourse.textContent = courseOption ? courseOption.text : '-';

      const layoutOption = settingsEls.layout.options[settingsEls.layout.selectedIndex];
      settingsEls.summaryLayout.textContent = layoutOption ? layoutOption.text : '-';

      settingsEls.summaryHours.textContent = `${settingsEls.start.value} - ${settingsEls.end.value}`;
      settingsEls.summaryInterval.textContent = `${settingsEls.interval.value} min`;
    }

    // Tab switching
    document.querySelectorAll('.settings-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active from all tabs and panels
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
        // Activate clicked tab and corresponding panel
        tab.classList.add('active');
        const panelId = 'panel-' + tab.dataset.tab;
        const panel = $(panelId);
        if (panel) panel.classList.add('active');
      });
    });

    // Add period buttons
    $('add-weekday-period')?.addEventListener('click', () => {
      addPeriodRow('weekday-periods', 'Custom', '12:00', '14:00', 1500);
    });

    $('add-weekend-period')?.addEventListener('click', () => {
      addPeriodRow('weekend-periods', 'Custom', '12:00', '14:00', 2500);
    });

    // Add package button
    $('add-package')?.addEventListener('click', () => {
      addPackageCard({
        name: 'New Package',
        greenFee: 2000,
        includesCaddy: 'no',
        includesCart: 'no',
        validDays: 'all',
        validFrom: '06:00',
        validUntil: '18:00'
      });
    });

    // Remove period buttons - attach to existing rows
    document.querySelectorAll('.time-period-row .remove-period-btn').forEach(btn => {
      btn.addEventListener('click', () => btn.closest('.time-period-row').remove());
    });

    // Remove package buttons - attach to existing cards
    document.querySelectorAll('.package-card .remove-package').forEach(btn => {
      btn.addEventListener('click', () => btn.closest('.package-card').remove());
    });

    // Open settings dialog (both header and controls buttons)
    settingsBtn?.addEventListener('click', () => {
      loadSettingsIntoModal();
      settingsDialog.showModal();
    });

    // Close settings dialog
    closeSettings?.addEventListener('click', () => settingsDialog.close());
    cancelSettings?.addEventListener('click', () => settingsDialog.close());

    // Save settings
    saveSettingsBtn?.addEventListener('click', () => {
      saveSettingsFromModal();
      settingsDialog.close();
      render();
    });

    // Update summary on input change in course config tab
    settingsEls.course?.addEventListener('change', updateSettingsSummary);
    settingsEls.layout?.addEventListener('change', updateSettingsSummary);
    settingsEls.start?.addEventListener('change', updateSettingsSummary);
    settingsEls.end?.addEventListener('change', updateSettingsSummary);
    settingsEls.interval?.addEventListener('change', updateSettingsSummary);

    // ==================== HEADER BAR FUNCTIONALITY ====================
    const courseNameDisplay = $('course-name-display');
    const dateDisplayLarge = $('date-display-large');
    const currentTimeDisplay = $('current-time-display');
    const headerPrevDay = $('header-prev-day');
    const headerNextDay = $('header-next-day');

    // Course name mapping for display
    const courseDisplayNames = {
      'bangpakong': 'Bangpakong Riverside CC',
      'bangpra': 'Bangpra International GC',
      'burapha_ac': 'Burapha Golf Club A+C',
      'burapha_cd': 'Burapha Golf Club C+D',
      'burapha_east': 'Burapha Golf Club East',
      'cheechan': 'Chee Chan Golf Resort',
      'crystal_bay': 'Crystal Bay Golf Club',
      'eastern_star': 'Eastern Star CC',
      'grand_prix': 'Grand Prix International GC',
      'greenwood': 'Greenwood Golf Club',
      'hermes': 'Hermes Golf Club',
      'khao_kheow': 'Khao Kheow Country Club',
      'laem_chabang': 'Laem Chabang International CC',
      'mountain_shadow': 'Mountain Shadow GC',
      'pattana': 'Pattana Golf Resort',
      'pattavia': 'Pattavia Century GC',
      'pattaya_county': 'Pattaya County GC',
      'phoenix': 'Phoenix Gold Golf CC',
      'pleasant_valley': 'Pleasant Valley CC',
      'plutaluang': 'Plutaluang Navy GC',
      'royal_lakeside': 'Royal Lakeside GC',
      'siam_cc_old': 'Siam CC Old Course',
      'siam_cc_plantation': 'Siam CC Plantation',
      'siam_cc_waterside': 'Siam CC Waterside',
      'siam_plantation': 'Siam Plantation GC',
      'st_andrews_2000': 'St. Andrews 2000 GC',
      'treasure_hill': 'Treasure Hill GC'
    };

    // Update header course name when course changes
    function updateHeaderCourseName() {
      const courseId = el.courseSelect.value;
      if (courseId && courseDisplayNames[courseId]) {
        courseNameDisplay.textContent = courseDisplayNames[courseId];
      } else {
        courseNameDisplay.textContent = 'Select Course';
      }
    }

    // Update header date display
    function updateHeaderDate() {
      const dateStr = el.dateInput.value;
      if (dateStr) {
        const d = new Date(dateStr + 'T00:00:00');
        const options = { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' };
        dateDisplayLarge.textContent = d.toLocaleDateString('en-US', options);
      }
    }

    // Real-time clock
    function updateClock() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      currentTimeDisplay.textContent = `${hours}:${minutes}:${seconds}`;
    }

    // Header date navigation
    headerPrevDay?.addEventListener('click', () => {
      const d = new Date(el.dateInput.value);
      d.setDate(d.getDate() - 1);
      el.dateInput.value = d.toISOString().split('T')[0];
      updateHeaderDate();
      render();
    });

    headerNextDay?.addEventListener('click', () => {
      const d = new Date(el.dateInput.value);
      d.setDate(d.getDate() + 1);
      el.dateInput.value = d.toISOString().split('T')[0];
      updateHeaderDate();
      render();
    });

    // Click on date display to show date picker
    dateDisplayLarge?.addEventListener('click', () => {
      el.dateInput.showPicker?.();
    });

    // Sync header when course or date changes
    el.courseSelect.addEventListener('change', updateHeaderCourseName);
    el.dateInput.addEventListener('change', updateHeaderDate);

    // URL parameter handling for course selection
    function handleUrlParams() {
      const params = new URLSearchParams(window.location.search);
      const courseParam = params.get('course');
      if (courseParam && el.courseSelect.querySelector(`option[value="${courseParam}"]`)) {
        el.courseSelect.value = courseParam;
        updateHeaderCourseName();
        saveSettings();
      }
    }

    // Start the clock
    setInterval(updateClock, 1000);
    updateClock();

    // ==================== INIT ====================
    handleUrlParams();
    updateHeaderCourseName();
    updateHeaderDate();
    applyTranslations();
    render();
  })();
  </script>
</body>
</html>
