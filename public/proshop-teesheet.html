<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MciPro Tee Sheet</title>
  <style>
    :root{--bg:#f4f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;--brand:#7c3aed;--border:rgba(0,0,0,.12);--green:#10b981;--red:#ef4444}
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;font-size:14px}

    /* Layout */
    .wrap{max-width:1400px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:16px;margin-bottom:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .grow{flex:1 1 200px}

    /* Header */
    h1{font-size:22px;font-weight:800;color:#1e1b4b;margin-bottom:4px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:16px}

    /* Form elements */
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    input,select,textarea{border:1px solid var(--border);border-radius:8px;padding:10px 12px;background:#fff;color:var(--ink);font-size:14px;outline:none;width:100%}
    input:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(124,58,237,0.1)}
    button{border:1px solid var(--border);background:#f3f4f6;border-radius:8px;padding:10px 14px;cursor:pointer;font-size:14px;font-weight:500}
    button:hover{background:#e5e7eb}
    .btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn-primary:hover{background:#6d28d9}
    .btn-danger{background:#fee2e2;color:#dc2626;border-color:#fca5a5}
    .iconbtn{width:40px;height:40px;padding:0;display:inline-flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
    .tag{padding:8px 12px;border:1px solid var(--border);border-radius:20px;font-size:13px;color:var(--muted);background:#f9fafb;white-space:nowrap}

    /* Legend */
    .legend{display:flex;gap:16px;align-items:center;font-size:13px;color:var(--muted);margin-top:12px;flex-wrap:wrap}
    .legend span{display:inline-block;width:14px;height:14px;border-radius:4px;margin-right:6px;vertical-align:middle}
    .lgA{background:#84cc16}.lgB{background:#38bdf8}.lgC{background:#f59e0b}.lgD{background:#a78bfa}
    .lgReg{background:#dcfce7;border:1px solid #86efac}.lgVip{background:#fef3c7;border:1px solid #fcd34d}
    .lgSoc{background:#dbeafe;border:1px solid #93c5fd}.lgTour{background:#ede9fe;border:1px solid #c4b5fd}

    /* Tee Grid */
    .tee-grid{display:grid;grid-template-columns:80px repeat(var(--cols,4),minmax(160px,1fr));gap:1px;background:var(--border)}
    .tee-grid>*{background:#fff}
    .time-cell{padding:10px 6px;text-align:center;font-size:13px;font-weight:700;color:#374151;background:#f9fafb;border-right:2px solid #e5e7eb}
    .col-header{padding:12px 8px;text-align:center;font-weight:700;font-size:13px}
    .col-header.a{background:#ecfccb;color:#3f6212}
    .col-header.b{background:#e0f2fe;color:#0369a1}
    .col-header.c{background:#fef3c7;color:#92400e}
    .col-header.d{background:#ede9fe;color:#6d28d9}

    /* Slots */
    .slot{min-height:56px;padding:4px;cursor:pointer;transition:background 0.15s}
    .slot:hover{background:#fafafa}
    .slot.drag-over{background:#ede9fe;outline:2px dashed var(--brand)}

    /* Pills */
    .pill{background:#dcfce7;border:1px solid #86efac;border-radius:8px;padding:6px 8px;margin:2px;font-size:12px;cursor:grab}
    .pill:hover{box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .pill.dragging{opacity:0.5}
    .pill.vip{background:#fef3c7;border-color:#fcd34d}
    .pill.society{background:#dbeafe;border-color:#93c5fd}
    .pill.tournament{background:#ede9fe;border-color:#c4b5fd}
    .pill-name{font-weight:600;color:#1f2937}
    .pill-info{font-size:11px;color:var(--muted);margin-top:2px}

    /* Modal */
    dialog{border:none;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:0;max-width:700px;width:90%}
    dialog::backdrop{background:rgba(0,0,0,.4)}
    .m-head{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);background:#f9fafb}
    .m-head h2{font-size:18px;font-weight:700}
    .m-body{padding:20px;max-height:60vh;overflow-y:auto}
    .m-foot{padding:16px 20px;border-top:1px solid var(--border);background:#f9fafb;display:flex;gap:8px;justify-content:flex-end}

    /* Golfer rows */
    .golfer-row{display:grid;grid-template-columns:1fr 80px 1fr;gap:10px;padding:12px;background:#f9fafb;border-radius:10px;margin-bottom:8px}
    .golfer-row.empty{opacity:0.5}
    .golfer-num{font-size:11px;color:var(--muted);margin-bottom:4px;font-weight:600}

    /* Caddy dropdown */
    .caddy-wrap{position:relative}
    .caddy-list{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);max-height:200px;overflow-y:auto;z-index:10;display:none}
    .caddy-list.open{display:block}
    .caddy-opt{padding:10px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;border-bottom:1px solid #f3f4f6}
    .caddy-opt:hover{background:#f3f4f6}
    .caddy-opt.selected{background:#ede9fe}

    /* Type buttons */
    .type-row{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
    .type-btn{padding:10px 20px;border-radius:20px;border:2px solid var(--border);background:#fff;cursor:pointer;font-size:13px;font-weight:600}
    .type-btn:hover{border-color:var(--brand)}
    .type-btn.active{border-color:var(--brand);background:var(--brand);color:#fff}
    .type-btn.vip.active{background:#f59e0b;border-color:#f59e0b}
    .type-btn.society.active{background:#3b82f6;border-color:#3b82f6}
    .type-btn.tournament.active{background:#8b5cf6;border-color:#8b5cf6}

    /* Status */
    .status-bar{padding:10px 16px;background:#f0fdf4;border:1px solid #86efac;border-radius:8px;font-size:13px;color:#166534;margin-bottom:12px;display:none}
    .status-bar.show{display:block}

    /* Responsive */
    @media(max-width:768px){
      .row{gap:8px}
      .golfer-row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

<div class="wrap">
  <!-- Status -->
  <div class="status-bar" id="statusBar">Connected to MciPro Platform</div>

  <!-- Header -->
  <h1 id="mainTitle">Tee Sheet</h1>
  <p class="sub" id="subTitle">Standalone tee time management with caddy booking</p>

  <!-- Controls Card -->
  <div class="card">
    <div class="row">
      <div style="min-width:140px">
        <label id="lblDate">Date</label>
        <div style="display:flex;gap:4px">
          <button class="iconbtn" id="prevDay" title="Previous">&#8249;</button>
          <input type="date" id="dateInput" style="flex:1">
          <button class="iconbtn" id="nextDay" title="Next">&#8250;</button>
        </div>
      </div>
      <div style="min-width:140px">
        <label id="lblLayout">Course Layout</label>
        <select id="complexSelect">
          <option value="18" id="opt18">18 holes (A/B)</option>
          <option value="27" id="opt27">27 holes (A/B/C)</option>
          <option value="36" id="opt36">36 holes (A/B/C/D)</option>
        </select>
      </div>
      <div style="min-width:100px">
        <label id="lblStart">Start Time</label>
        <input type="time" id="startTime" value="06:00">
      </div>
      <div style="min-width:100px">
        <label id="lblEnd">End Time</label>
        <input type="time" id="endTime" value="18:00">
      </div>
      <div style="min-width:90px">
        <label id="lblInterval">Interval</label>
        <select id="intervalSelect">
          <option value="7">7 min</option>
          <option value="8">8 min</option>
          <option value="10" selected>10 min</option>
          <option value="12">12 min</option>
          <option value="15">15 min</option>
        </select>
      </div>
      <div style="min-width:80px">
        <label id="lblTees">Tees</label>
        <select id="teesSelect">
          <option value="1">1</option>
          <option value="2" selected>2</option>
        </select>
      </div>
      <div class="tag" id="totalTag">Total: 4 tees</div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="grow">
        <label id="lblSearch">Search</label>
        <input type="text" id="searchInput" placeholder="Golfer name or caddy number...">
      </div>
      <button id="searchBtn">Find</button>
      <button id="searchNext">Next</button>
      <div class="tag" id="matchTag">Matches: 0</div>
      <div style="margin-left:auto">
        <label>Language</label>
        <select id="langSelect" style="width:100px">
          <option value="en">English</option>
          <option value="th">ไทย</option>
          <option value="ko">한국어</option>
          <option value="ja">日本語</option>
        </select>
      </div>
      <button class="btn-danger" id="clearDay">Clear Day</button>
    </div>

    <div class="legend">
      <div><span class="lgA"></span><span id="legA">Course A</span></div>
      <div><span class="lgB"></span><span id="legB">Course B</span></div>
      <div id="legCwrap"><span class="lgC"></span><span id="legC">Course C</span></div>
      <div id="legDwrap" style="display:none"><span class="lgD"></span><span id="legD">Course D</span></div>
      <div style="margin-left:auto;display:flex;gap:12px;flex-wrap:wrap">
        <div><span class="lgReg"></span><span id="legReg">Regular</span></div>
        <div><span class="lgVip"></span><span id="legVip">VIP</span></div>
        <div><span class="lgSoc"></span><span id="legSoc">Society</span></div>
        <div><span class="lgTour"></span><span id="legTour">Tournament</span></div>
      </div>
    </div>
  </div>

  <!-- Tee Sheet Grid -->
  <div class="card" style="overflow-x:auto">
    <div id="teeSheet" class="tee-grid"></div>
  </div>
</div>

<!-- Booking Modal -->
<dialog id="bookingDialog">
  <div class="m-head">
    <h2 id="modalTitle">Book Tee Time</h2>
    <button class="iconbtn" id="closeDialog">&times;</button>
  </div>
  <div class="m-body">
    <input type="hidden" id="bookingId">
    <input type="hidden" id="bookingSlot">

    <!-- Slot info -->
    <div class="row" style="margin-bottom:16px;padding:12px;background:#f9fafb;border-radius:8px">
      <div><label id="lblTime">Time</label><div id="slotTime" style="font-weight:700;font-size:16px">--:--</div></div>
      <div><label id="lblCourse">Course</label><div id="slotCourse" style="font-weight:700;font-size:16px">-</div></div>
      <div><label id="lblTee">Tee</label><div id="slotTee" style="font-weight:700;font-size:16px">-</div></div>
    </div>

    <!-- Booking type -->
    <label id="lblType" style="margin-bottom:8px">Booking Type</label>
    <div class="type-row">
      <button type="button" class="type-btn active" data-type="regular" id="btnReg">Regular</button>
      <button type="button" class="type-btn vip" data-type="vip" id="btnVip">VIP</button>
      <button type="button" class="type-btn society" data-type="society" id="btnSoc">Society</button>
      <button type="button" class="type-btn tournament" data-type="tournament" id="btnTour">Tournament</button>
    </div>

    <!-- Golfers -->
    <label id="lblGolfers" style="margin-bottom:8px">Golfers & Caddies (up to 4)</label>
    <div id="golferRows"></div>

    <!-- Notes -->
    <div style="margin-top:12px">
      <label id="lblNotes">Notes</label>
      <textarea id="bookingNotes" rows="2" placeholder="Special requests..."></textarea>
    </div>
  </div>
  <div class="m-foot">
    <button class="btn-danger" id="deleteBtn" style="display:none">Delete</button>
    <button id="cancelBtn">Cancel</button>
    <button class="btn-primary" id="saveBtn">Save Booking</button>
  </div>
</dialog>

<script>
(function(){
  "use strict";

  // ========== TRANSLATIONS ==========
  const T = {
    en: {
      title: 'Tee Sheet', sub: 'Standalone tee time management with caddy booking',
      date: 'Date', layout: 'Course Layout', start: 'Start Time', end: 'End Time', interval: 'Interval', tees: 'Tees',
      search: 'Search', find: 'Find', next: 'Next', clearDay: 'Clear Day',
      holes18: '18 holes (A/B)', holes27: '27 holes (A/B/C)', holes36: '36 holes (A/B/C/D)',
      courseA: 'Course A', courseB: 'Course B', courseC: 'Course C', courseD: 'Course D',
      regular: 'Regular', vip: 'VIP', society: 'Society', tournament: 'Tournament',
      bookTee: 'Book Tee Time', editBooking: 'Edit Booking', time: 'Time', course: 'Course', tee: 'Tee',
      type: 'Booking Type', golfers: 'Golfers & Caddies (up to 4)', golfer: 'Golfer', name: 'Name',
      handicap: 'HCP', caddy: 'Caddy', searchCaddy: 'Search caddy...', noCaddy: 'No caddy',
      notes: 'Notes', cancel: 'Cancel', save: 'Save Booking', delete: 'Delete',
      total: 'Total', matches: 'Matches', connected: 'Connected to MciPro Platform',
      confirmClear: 'Clear all bookings for this date?', confirmDelete: 'Delete this booking?',
      noMatch: 'No matches found', addGolfer: 'Add at least one golfer', caddies: 'Caddies'
    },
    th: {
      title: 'ตารางทีออฟ', sub: 'ระบบจัดการเวลาทีออฟพร้อมจองแคดดี้',
      date: 'วันที่', layout: 'รูปแบบสนาม', start: 'เวลาเริ่ม', end: 'เวลาสิ้นสุด', interval: 'ช่วงเวลา', tees: 'ทีออฟ',
      search: 'ค้นหา', find: 'หา', next: 'ถัดไป', clearDay: 'ล้างวัน',
      holes18: '18 หลุม (A/B)', holes27: '27 หลุม (A/B/C)', holes36: '36 หลุม (A/B/C/D)',
      courseA: 'สนาม A', courseB: 'สนาม B', courseC: 'สนาม C', courseD: 'สนาม D',
      regular: 'ปกติ', vip: 'VIP', society: 'กลุ่ม', tournament: 'แข่งขัน',
      bookTee: 'จองทีออฟ', editBooking: 'แก้ไขการจอง', time: 'เวลา', course: 'สนาม', tee: 'ทีออฟ',
      type: 'ประเภทการจอง', golfers: 'นักกอล์ฟและแคดดี้ (สูงสุด 4)', golfer: 'นักกอล์ฟ', name: 'ชื่อ',
      handicap: 'HCP', caddy: 'แคดดี้', searchCaddy: 'ค้นหาแคดดี้...', noCaddy: 'ไม่มีแคดดี้',
      notes: 'หมายเหตุ', cancel: 'ยกเลิก', save: 'บันทึก', delete: 'ลบ',
      total: 'รวม', matches: 'พบ', connected: 'เชื่อมต่อกับ MciPro แล้ว',
      confirmClear: 'ล้างการจองทั้งหมดสำหรับวันนี้?', confirmDelete: 'ลบการจองนี้?',
      noMatch: 'ไม่พบ', addGolfer: 'กรุณาเพิ่มนักกอล์ฟ', caddies: 'แคดดี้'
    },
    ko: {
      title: '티 시트', sub: '캐디 예약이 포함된 티 타임 관리',
      date: '날짜', layout: '코스 레이아웃', start: '시작', end: '종료', interval: '간격', tees: '티',
      search: '검색', find: '찾기', next: '다음', clearDay: '삭제',
      holes18: '18홀 (A/B)', holes27: '27홀 (A/B/C)', holes36: '36홀 (A/B/C/D)',
      courseA: '코스 A', courseB: '코스 B', courseC: '코스 C', courseD: '코스 D',
      regular: '일반', vip: 'VIP', society: '단체', tournament: '토너먼트',
      bookTee: '티 타임 예약', editBooking: '예약 수정', time: '시간', course: '코스', tee: '티',
      type: '예약 유형', golfers: '골퍼 및 캐디 (최대 4명)', golfer: '골퍼', name: '이름',
      handicap: 'HCP', caddy: '캐디', searchCaddy: '캐디 검색...', noCaddy: '캐디 없음',
      notes: '메모', cancel: '취소', save: '저장', delete: '삭제',
      total: '총', matches: '결과', connected: 'MciPro 연결됨',
      confirmClear: '이 날짜의 모든 예약을 삭제하시겠습니까?', confirmDelete: '이 예약을 삭제하시겠습니까?',
      noMatch: '결과 없음', addGolfer: '골퍼를 추가하세요', caddies: '캐디'
    },
    ja: {
      title: 'ティーシート', sub: 'キャディ予約付きティータイム管理',
      date: '日付', layout: 'コースレイアウト', start: '開始', end: '終了', interval: '間隔', tees: 'ティー',
      search: '検索', find: '検索', next: '次へ', clearDay: 'クリア',
      holes18: '18ホール (A/B)', holes27: '27ホール (A/B/C)', holes36: '36ホール (A/B/C/D)',
      courseA: 'コース A', courseB: 'コース B', courseC: 'コース C', courseD: 'コース D',
      regular: '通常', vip: 'VIP', society: '団体', tournament: 'トーナメント',
      bookTee: 'ティータイム予約', editBooking: '予約編集', time: '時間', course: 'コース', tee: 'ティー',
      type: '予約タイプ', golfers: 'ゴルファー＆キャディ (最大4名)', golfer: 'ゴルファー', name: '名前',
      handicap: 'HCP', caddy: 'キャディ', searchCaddy: 'キャディ検索...', noCaddy: 'キャディなし',
      notes: 'メモ', cancel: 'キャンセル', save: '保存', delete: '削除',
      total: '合計', matches: '件', connected: 'MciPro接続中',
      confirmClear: 'この日の予約をすべて削除しますか？', confirmDelete: 'この予約を削除しますか？',
      noMatch: '該当なし', addGolfer: 'ゴルファーを追加してください', caddies: 'キャディ'
    }
  };

  let lang = 'en';
  const t = k => T[lang][k] || T.en[k] || k;

  // ========== DEMO CADDIES ==========
  const CADDIES = [
    {id:'c01',num:'001',name:'Somchai',rating:4.8,status:'available'},
    {id:'c02',num:'002',name:'Sunan',rating:4.7,status:'available'},
    {id:'c03',num:'003',name:'Niran',rating:4.6,status:'available'},
    {id:'c04',num:'004',name:'Ploy',rating:4.9,status:'available'},
    {id:'c05',num:'005',name:'Anuwat',rating:4.5,status:'booked'},
    {id:'c06',num:'006',name:'Kanya',rating:4.8,status:'available'},
    {id:'c07',num:'007',name:'Mali',rating:4.9,status:'available'},
    {id:'c08',num:'008',name:'Chai',rating:4.4,status:'available'},
    {id:'c09',num:'009',name:'Noi',rating:4.7,status:'booked'},
    {id:'c10',num:'010',name:'Benz',rating:4.3,status:'available'},
    {id:'c11',num:'011',name:'Lek',rating:4.8,status:'available'},
    {id:'c12',num:'012',name:'Porn',rating:4.7,status:'available'}
  ];

  // ========== HELPERS ==========
  const pad = n => String(n).padStart(2,'0');
  const mins = hm => { const [h,m]=(hm||'').split(':').map(Number); return h*60+(m||0); };
  const hhmm = m => pad(Math.floor(m/60))+':'+pad(m%60);
  const today = () => { const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
  const genId = () => Date.now().toString(36)+Math.random().toString(36).substr(2,6);

  // ========== STORAGE ==========
  const KEY = 'mciprotee_v2';
  const getDay = d => { try { return JSON.parse(localStorage.getItem(`${KEY}::${d}`)||'[]'); } catch(_){ return []; } };
  const setDay = (d,arr) => { localStorage.setItem(`${KEY}::${d}`, JSON.stringify(arr)); };
  const getSettings = () => { try { return JSON.parse(localStorage.getItem(`${KEY}::settings`)||'{}'); } catch(_){ return {}; } };
  const setSettings = s => localStorage.setItem(`${KEY}::settings`, JSON.stringify(s));

  // ========== DOM ==========
  const $ = id => document.getElementById(id);
  const el = {
    sheet: $('teeSheet'), date: $('dateInput'), complex: $('complexSelect'),
    start: $('startTime'), end: $('endTime'), interval: $('intervalSelect'), tees: $('teesSelect'),
    search: $('searchInput'), searchBtn: $('searchBtn'), searchNext: $('searchNext'),
    clearDay: $('clearDay'), langSelect: $('langSelect'),
    totalTag: $('totalTag'), matchTag: $('matchTag'), statusBar: $('statusBar'),
    legCwrap: $('legCwrap'), legDwrap: $('legDwrap'),
    // Modal
    dialog: $('bookingDialog'), modalTitle: $('modalTitle'),
    bookingId: $('bookingId'), bookingSlot: $('bookingSlot'),
    slotTime: $('slotTime'), slotCourse: $('slotCourse'), slotTee: $('slotTee'),
    golferRows: $('golferRows'), notes: $('bookingNotes'),
    closeBtn: $('closeDialog'), cancelBtn: $('cancelBtn'), saveBtn: $('saveBtn'), deleteBtn: $('deleteBtn')
  };

  // ========== STATE ==========
  let bookingType = 'regular';
  let searchHits = [], searchIdx = 0;

  // ========== PLATFORM BRIDGE ==========
  const Bridge = {
    connected: false,
    init() {
      try {
        if (window.parent && window.parent !== window && window.parent.CaddySystem) {
          this.connected = true;
          el.statusBar.classList.add('show');
        }
      } catch(e) {}
    }
  };

  // ========== LAYOUT ==========
  const getCourses = () => {
    const v = el.complex.value;
    if (v === '18') return ['A','B'];
    if (v === '27') return ['A','B','C'];
    return ['A','B','C','D'];
  };

  const getLayout = () => {
    const courses = getCourses();
    const perCourse = parseInt(el.tees.value) || 1;
    const cols = [];
    courses.forEach(c => { for(let i=0; i<perCourse; i++) cols.push({course:c, tee:i+1}); });
    return { courses, perCourse, cols };
  };

  // ========== LANGUAGE ==========
  function updateLang() {
    $('mainTitle').textContent = t('title');
    $('subTitle').textContent = t('sub');
    $('lblDate').textContent = t('date');
    $('lblLayout').textContent = t('layout');
    $('lblStart').textContent = t('start');
    $('lblEnd').textContent = t('end');
    $('lblInterval').textContent = t('interval');
    $('lblTees').textContent = t('tees');
    $('lblSearch').textContent = t('search');
    el.searchBtn.textContent = t('find');
    el.searchNext.textContent = t('next');
    el.clearDay.textContent = t('clearDay');
    $('opt18').textContent = t('holes18');
    $('opt27').textContent = t('holes27');
    $('opt36').textContent = t('holes36');
    $('legA').textContent = t('courseA');
    $('legB').textContent = t('courseB');
    $('legC').textContent = t('courseC');
    $('legD').textContent = t('courseD');
    $('legReg').textContent = t('regular');
    $('legVip').textContent = t('vip');
    $('legSoc').textContent = t('society');
    $('legTour').textContent = t('tournament');
    // Modal
    $('lblTime').textContent = t('time');
    $('lblCourse').textContent = t('course');
    $('lblTee').textContent = t('tee');
    $('lblType').textContent = t('type');
    $('lblGolfers').textContent = t('golfers');
    $('lblNotes').textContent = t('notes');
    $('btnReg').textContent = t('regular');
    $('btnVip').textContent = t('vip');
    $('btnSoc').textContent = t('society');
    $('btnTour').textContent = t('tournament');
    el.cancelBtn.textContent = t('cancel');
    el.saveBtn.textContent = t('save');
    el.deleteBtn.textContent = t('delete');
    el.statusBar.textContent = t('connected');
    render();
  }

  // ========== RENDER ==========
  function render() {
    const settings = { date: el.date.value, complex: el.complex.value, start: el.start.value,
      end: el.end.value, interval: el.interval.value, tees: el.tees.value, lang };
    setSettings(settings);

    const layout = getLayout();
    el.totalTag.textContent = `${t('total')}: ${layout.cols.length} tees`;
    el.legCwrap.style.display = layout.courses.includes('C') ? '' : 'none';
    el.legDwrap.style.display = layout.courses.includes('D') ? '' : 'none';
    el.sheet.style.setProperty('--cols', layout.cols.length);
    el.sheet.innerHTML = '';

    // Header row
    const hdr = document.createElement('div');
    hdr.className = 'tee-grid';
    hdr.innerHTML = '<div class="time-cell"></div>';
    layout.cols.forEach(col => {
      const cell = document.createElement('div');
      cell.className = `col-header ${col.course.toLowerCase()}`;
      cell.textContent = `${col.course}-${col.tee}`;
      hdr.appendChild(cell);
    });
    el.sheet.appendChild(hdr);

    // Time rows
    const startM = mins(el.start.value), endM = mins(el.end.value), step = parseInt(el.interval.value)||10;
    const bookings = getDay(el.date.value);

    for (let m = startM; m <= endM; m += step) {
      const time = hhmm(m);
      const row = document.createElement('div');
      row.className = 'tee-grid';

      const timeCell = document.createElement('div');
      timeCell.className = 'time-cell';
      timeCell.textContent = time;
      row.appendChild(timeCell);

      layout.cols.forEach((col, idx) => {
        const slot = document.createElement('div');
        slot.className = 'slot';
        slot.dataset.time = time;
        slot.dataset.course = col.course;
        slot.dataset.tee = col.tee;
        slot.dataset.col = idx;

        // Find bookings
        bookings.filter(b => b.time === time && b.col === idx).forEach(b => {
          slot.appendChild(createPill(b));
        });

        // Click
        slot.addEventListener('click', e => {
          if (e.target.closest('.pill')) return;
          openModal({ time, course: col.course, tee: col.tee, col: idx });
        });

        // Drag/drop
        slot.addEventListener('dragover', e => { e.preventDefault(); slot.classList.add('drag-over'); });
        slot.addEventListener('dragleave', () => slot.classList.remove('drag-over'));
        slot.addEventListener('drop', e => {
          e.preventDefault();
          slot.classList.remove('drag-over');
          const id = e.dataTransfer.getData('text/plain');
          if (id) moveBooking(id, time, idx, col.course, col.tee);
        });

        row.appendChild(slot);
      });

      el.sheet.appendChild(row);
    }

    updateSearch();
  }

  function createPill(b) {
    const pill = document.createElement('div');
    pill.className = `pill ${b.type || 'regular'}`;
    pill.draggable = true;
    pill.dataset.id = b.id;

    const names = (b.golfers||[]).filter(g=>g.name).map(g=>g.name).join(', ') || '—';
    const caddyNums = (b.golfers||[]).filter(g=>g.caddyId).map(g => {
      const c = CADDIES.find(x=>x.id===g.caddyId);
      return c ? `#${c.num}` : '';
    }).filter(Boolean).join(', ');

    pill.innerHTML = `<div class="pill-name">${names}</div>` +
      (caddyNums ? `<div class="pill-info">${t('caddies')}: ${caddyNums}</div>` : '');

    pill.addEventListener('click', e => { e.stopPropagation(); openModal(b, true); });
    pill.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', b.id); pill.classList.add('dragging'); });
    pill.addEventListener('dragend', () => pill.classList.remove('dragging'));
    return pill;
  }

  // ========== BOOKING CRUD ==========
  function moveBooking(id, time, col, course, tee) {
    const date = el.date.value;
    const arr = getDay(date);
    const idx = arr.findIndex(b => b.id === id);
    if (idx < 0) return;
    arr[idx].time = time;
    arr[idx].col = col;
    arr[idx].course = course;
    arr[idx].tee = tee;
    setDay(date, arr);
    render();
  }

  function saveBooking(b) {
    const date = el.date.value;
    const arr = getDay(date);
    const idx = arr.findIndex(x => x.id === b.id);
    if (idx >= 0) arr[idx] = b; else arr.push(b);
    setDay(date, arr);
    render();
  }

  function deleteBooking(id) {
    const date = el.date.value;
    setDay(date, getDay(date).filter(b => b.id !== id));
    render();
  }

  // ========== MODAL ==========
  function openModal(data, isEdit = false) {
    el.modalTitle.textContent = isEdit ? t('editBooking') : t('bookTee');
    el.bookingId.value = data.id || '';
    el.bookingSlot.value = JSON.stringify({ time: data.time, course: data.course, tee: data.tee, col: data.col });
    el.slotTime.textContent = data.time;
    el.slotCourse.textContent = `${t('course')} ${data.course}`;
    el.slotTee.textContent = data.tee;

    bookingType = data.type || 'regular';
    document.querySelectorAll('.type-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.type === bookingType);
    });

    renderGolferRows(data.golfers || [{},{},{},{}]);
    el.notes.value = data.notes || '';
    el.deleteBtn.style.display = isEdit ? '' : 'none';

    if (el.dialog.showModal) el.dialog.showModal();
  }

  function closeModal() {
    if (el.dialog.close) el.dialog.close();
  }

  function renderGolferRows(golfers) {
    el.golferRows.innerHTML = '';
    for (let i = 0; i < 4; i++) {
      const g = golfers[i] || {};
      const row = document.createElement('div');
      row.className = `golfer-row ${g.name ? '' : 'empty'}`;
      row.innerHTML = `
        <div>
          <div class="golfer-num">${t('golfer')} ${i+1}</div>
          <input type="text" class="g-name" placeholder="${t('name')}" value="${g.name||''}" data-idx="${i}">
        </div>
        <div>
          <label>${t('handicap')}</label>
          <input type="number" class="g-hcp" placeholder="HCP" value="${g.hcp||''}" min="0" max="54" data-idx="${i}">
        </div>
        <div class="caddy-wrap">
          <label>${t('caddy')}</label>
          <input type="text" class="g-caddy" placeholder="${t('searchCaddy')}" value="${getCaddyName(g.caddyId)}" data-idx="${i}" data-caddy="${g.caddyId||''}">
          <div class="caddy-list" data-idx="${i}"></div>
        </div>
      `;
      el.golferRows.appendChild(row);
    }

    // Caddy dropdowns
    document.querySelectorAll('.g-caddy').forEach(input => {
      const list = input.nextElementSibling;
      input.addEventListener('focus', () => { fillCaddyList(list, input.value, input.dataset.caddy); list.classList.add('open'); });
      input.addEventListener('input', () => fillCaddyList(list, input.value, input.dataset.caddy));
      input.addEventListener('blur', () => setTimeout(() => list.classList.remove('open'), 150));
    });

    document.querySelectorAll('.g-name').forEach(input => {
      input.addEventListener('input', () => {
        input.closest('.golfer-row').classList.toggle('empty', !input.value.trim());
      });
    });
  }

  function getCaddyName(id) {
    if (!id) return '';
    const c = CADDIES.find(x => x.id === id);
    return c ? `#${c.num} ${c.name}` : '';
  }

  function fillCaddyList(list, search, selectedId) {
    const term = (search||'').toLowerCase();
    const filtered = CADDIES.filter(c => c.name.toLowerCase().includes(term) || c.num.includes(term)).slice(0,8);

    list.innerHTML = `<div class="caddy-opt" data-id=""><strong>--</strong> ${t('noCaddy')}</div>` +
      filtered.map(c => `
        <div class="caddy-opt ${c.id===selectedId?'selected':''}" data-id="${c.id}">
          <strong>#${c.num}</strong> ${c.name} <span style="color:#f59e0b">★${c.rating}</span>
          <span style="margin-left:auto;font-size:11px;color:${c.status==='available'?'#16a34a':'#dc2626'}">${c.status}</span>
        </div>
      `).join('');

    list.querySelectorAll('.caddy-opt').forEach(opt => {
      opt.addEventListener('mousedown', e => {
        e.preventDefault();
        const input = list.previousElementSibling;
        input.dataset.caddy = opt.dataset.id;
        input.value = getCaddyName(opt.dataset.id);
        list.classList.remove('open');
      });
    });
  }

  function collectFormData() {
    const slot = JSON.parse(el.bookingSlot.value);
    const golfers = [];
    document.querySelectorAll('.golfer-row').forEach((row, i) => {
      const name = row.querySelector('.g-name').value.trim();
      const hcp = row.querySelector('.g-hcp').value;
      const caddyId = row.querySelector('.g-caddy').dataset.caddy;
      if (name || caddyId) golfers.push({ id: `g${i}`, name, hcp: hcp ? parseInt(hcp) : null, caddyId: caddyId || null });
    });
    return {
      id: el.bookingId.value || genId(),
      time: slot.time, course: slot.course, tee: slot.tee, col: slot.col,
      type: bookingType, golfers, notes: el.notes.value.trim()
    };
  }

  // ========== SEARCH ==========
  function updateSearch() {
    const q = (el.search.value || '').toLowerCase().trim();
    if (!q) { searchHits = []; el.matchTag.textContent = `${t('matches')}: 0`; return; }
    const arr = getDay(el.date.value);
    searchHits = arr.filter(b => {
      const nameMatch = (b.golfers||[]).some(g => (g.name||'').toLowerCase().includes(q));
      const caddyMatch = (b.golfers||[]).some(g => {
        const c = CADDIES.find(x => x.id === g.caddyId);
        return c && (c.name.toLowerCase().includes(q) || c.num.includes(q));
      });
      return nameMatch || caddyMatch;
    });
    searchIdx = 0;
    el.matchTag.textContent = `${t('matches')}: ${searchHits.length}`;
  }

  function jumpToHit() {
    if (!searchHits.length) { alert(t('noMatch')); return; }
    const b = searchHits[searchIdx];
    const slot = document.querySelector(`.slot[data-time="${b.time}"][data-col="${b.col}"]`);
    if (slot) {
      slot.scrollIntoView({ behavior: 'smooth', block: 'center' });
      slot.style.outline = '3px solid var(--green)';
      setTimeout(() => slot.style.outline = '', 1500);
    }
  }

  // ========== EVENTS ==========
  $('prevDay').addEventListener('click', () => {
    const d = new Date(el.date.value); d.setDate(d.getDate() - 1);
    el.date.value = d.toISOString().split('T')[0]; render();
  });
  $('nextDay').addEventListener('click', () => {
    const d = new Date(el.date.value); d.setDate(d.getDate() + 1);
    el.date.value = d.toISOString().split('T')[0]; render();
  });

  el.date.addEventListener('change', render);
  el.complex.addEventListener('change', render);
  el.start.addEventListener('change', render);
  el.end.addEventListener('change', render);
  el.interval.addEventListener('change', render);
  el.tees.addEventListener('change', render);

  el.langSelect.addEventListener('change', () => {
    lang = el.langSelect.value;
    updateLang();
  });

  el.clearDay.addEventListener('click', () => {
    if (confirm(t('confirmClear'))) { setDay(el.date.value, []); render(); }
  });

  el.searchBtn.addEventListener('click', () => { updateSearch(); jumpToHit(); });
  el.searchNext.addEventListener('click', () => {
    if (!searchHits.length) updateSearch();
    else searchIdx = (searchIdx + 1) % searchHits.length;
    jumpToHit();
  });
  el.search.addEventListener('keydown', e => { if (e.key === 'Enter') el.searchBtn.click(); });

  // Modal events
  el.closeBtn.addEventListener('click', closeModal);
  el.cancelBtn.addEventListener('click', closeModal);

  document.querySelectorAll('.type-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      bookingType = btn.dataset.type;
      document.querySelectorAll('.type-btn').forEach(b => b.classList.toggle('active', b === btn));
    });
  });

  el.saveBtn.addEventListener('click', () => {
    const data = collectFormData();
    if (!data.golfers.length) { alert(t('addGolfer')); return; }
    saveBooking(data);
    closeModal();
  });

  el.deleteBtn.addEventListener('click', () => {
    if (confirm(t('confirmDelete'))) {
      deleteBooking(el.bookingId.value);
      closeModal();
    }
  });

  // ========== INIT ==========
  function init() {
    const s = getSettings();
    el.date.value = s.date || today();
    if (s.complex) el.complex.value = s.complex;
    if (s.start) el.start.value = s.start;
    if (s.end) el.end.value = s.end;
    if (s.interval) el.interval.value = s.interval;
    if (s.tees) el.tees.value = s.tees;
    if (s.lang && T[s.lang]) { lang = s.lang; el.langSelect.value = lang; }

    Bridge.init();
    updateLang();
    console.log('[TeeSheet] Ready - lang:', lang);
  }

  init();
})();
</script>
</body>
</html>
