<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup JOA Golf Pattaya Access</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üèåÔ∏è JOA Golf Pattaya Society Setup</h1>

    <div class="section">
        <h2>Step 1: Check Current Status</h2>
        <button onclick="checkStatus()">Check Status</button>
        <div id="status-results"></div>
    </div>

    <div class="section">
        <h2>Step 2: Create/Verify JOA Society Profile</h2>
        <p>Society Name: <strong>JOA Golf Pattaya</strong></p>
        <p>Organizer ID: <input type="text" id="organizer-id" value="JOAGOLFPAT" style="width: 300px; padding: 5px;"></p>
        <p>Description: <input type="text" id="description" value="JOA Golf Pattaya Society - Weekly tournaments and events" style="width: 500px; padding: 5px;"></p>
        <button onclick="createJOASociety()">Create JOA Society Profile</button>
        <div id="create-results"></div>
    </div>

    <div class="section">
        <h2>Step 3: Grant User Access</h2>
        <p>User LINE ID: <input type="text" id="user-line-id" placeholder="Enter your LINE user ID" style="width: 300px; padding: 5px;"></p>
        <button onclick="grantAccess()">Grant Society Organizer Access</button>
        <div id="grant-results"></div>
    </div>

    <div class="section">
        <h2>Step 4: Verify Access</h2>
        <button onclick="verifyAccess()">Verify Dashboard Access</button>
        <div id="verify-results"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pyeeplwsnupmhgbguwqs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZWVwbHdzbnVwbWhnYmd1d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDM2NjksImV4cCI6MjA3NTQxOTY2OX0.KVQ6WvDKz9s77lxn3AhSA_YTMCN6rsht9kDkMIDhngk';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function checkStatus() {
            const results = document.getElementById('status-results');
            results.innerHTML = '<p>Checking...</p>';

            try {
                // Check all society profiles
                const { data: societies, error: societiesError } = await supabase
                    .from('society_profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (societiesError) {
                    results.innerHTML = `<p class="error">Error: ${societiesError.message}</p>`;
                    return;
                }

                results.innerHTML = `<h3>All Society Profiles (${societies.length}):</h3>`;
                results.innerHTML += `<pre>${JSON.stringify(societies, null, 2)}</pre>`;

                // Check for JOA specifically
                const joaSociety = societies.find(s =>
                    s.organizer_id === 'JOAGOLFPAT' ||
                    s.society_name.includes('JOA')
                );

                if (joaSociety) {
                    results.innerHTML += `<p class="success">‚úÖ JOA Golf Pattaya society found!</p>`;
                    results.innerHTML += `<pre>${JSON.stringify(joaSociety, null, 2)}</pre>`;
                } else {
                    results.innerHTML += `<p class="error">‚ùå JOA Golf Pattaya society NOT found</p>`;
                }

                // Check current user
                const currentUser = JSON.parse(localStorage.getItem('userProfile') || '{}');
                if (currentUser.lineUserId) {
                    document.getElementById('user-line-id').value = currentUser.lineUserId;

                    const { data: userProfile, error: userError } = await supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('line_user_id', currentUser.lineUserId)
                        .single();

                    if (userProfile) {
                        results.innerHTML += `<h3>Your Profile:</h3>`;
                        results.innerHTML += `<pre>${JSON.stringify(userProfile, null, 2)}</pre>`;

                        if (userProfile.role === 'society_organizer') {
                            results.innerHTML += `<p class="success">‚úÖ You have society_organizer role</p>`;
                        } else {
                            results.innerHTML += `<p class="error">‚ùå You do NOT have society_organizer role (current: ${userProfile.role})</p>`;
                        }
                    }
                }

            } catch (error) {
                results.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        async function createJOASociety() {
            const results = document.getElementById('create-results');
            results.innerHTML = '<p>Creating...</p>';

            const organizerId = document.getElementById('organizer-id').value;
            const description = document.getElementById('description').value;

            try {
                // Check if already exists
                const { data: existing, error: checkError } = await supabase
                    .from('society_profiles')
                    .select('*')
                    .eq('organizer_id', organizerId)
                    .maybeSingle();

                if (existing) {
                    results.innerHTML = `<p class="success">‚úÖ Society profile already exists!</p>`;
                    results.innerHTML += `<pre>${JSON.stringify(existing, null, 2)}</pre>`;
                    return;
                }

                // Create new society profile
                const { data, error } = await supabase
                    .from('society_profiles')
                    .insert({
                        organizer_id: organizerId,
                        society_name: 'JOA Golf Pattaya',
                        society_logo: './societylogos/JOAgolf.jpeg',
                        description: description
                    })
                    .select()
                    .single();

                if (error) {
                    results.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                    console.error('Full error:', error);
                    return;
                }

                results.innerHTML = `<p class="success">‚úÖ JOA Golf Pattaya society profile created!</p>`;
                results.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;

            } catch (error) {
                results.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        async function grantAccess() {
            const results = document.getElementById('grant-results');
            results.innerHTML = '<p>Granting access...</p>';

            const lineUserId = document.getElementById('user-line-id').value;
            if (!lineUserId) {
                results.innerHTML = '<p class="error">Please enter your LINE user ID</p>';
                return;
            }

            try {
                // Get current profile
                const { data: currentProfile, error: fetchError } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('line_user_id', lineUserId)
                    .single();

                if (fetchError && fetchError.code !== 'PGRST116') {
                    results.innerHTML = `<p class="error">Error fetching profile: ${fetchError.message}</p>`;
                    return;
                }

                if (!currentProfile) {
                    results.innerHTML = `<p class="error">Profile not found for LINE ID: ${lineUserId}</p>`;
                    return;
                }

                // Update to society_organizer role and associate with JOA
                const { data, error } = await supabase
                    .from('user_profiles')
                    .update({
                        role: 'society_organizer',
                        society_id: 'JOAGOLFPAT',
                        society_name: 'JOA Golf Pattaya',
                        updated_at: new Date().toISOString()
                    })
                    .eq('line_user_id', lineUserId)
                    .select()
                    .single();

                if (error) {
                    results.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                    return;
                }

                results.innerHTML = `<p class="success">‚úÖ Access granted! You are now a society organizer for JOA Golf Pattaya</p>`;
                results.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;

                // Update localStorage
                const localProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                localProfile.role = 'society_organizer';
                localProfile.societyId = 'JOAGOLFPAT';
                localProfile.societyName = 'JOA Golf Pattaya';
                if (!localProfile.organizationInfo) {
                    localProfile.organizationInfo = {};
                }
                localProfile.organizationInfo.societyId = 'JOAGOLFPAT';
                localProfile.organizationInfo.societyName = 'JOA Golf Pattaya';
                localStorage.setItem('userProfile', JSON.stringify(localProfile));

                results.innerHTML += `<p class="success">‚úÖ Local profile updated</p>`;

            } catch (error) {
                results.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        async function verifyAccess() {
            const results = document.getElementById('verify-results');
            results.innerHTML = '<p>Verifying...</p>';

            const lineUserId = document.getElementById('user-line-id').value;
            if (!lineUserId) {
                results.innerHTML = '<p class="error">Please enter your LINE user ID</p>';
                return;
            }

            try {
                // Check user profile
                const { data: userProfile, error: userError } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('line_user_id', lineUserId)
                    .single();

                if (userError) {
                    results.innerHTML = `<p class="error">Error: ${userError.message}</p>`;
                    return;
                }

                // Check society profile
                const { data: societyProfile, error: societyError } = await supabase
                    .from('society_profiles')
                    .select('*')
                    .eq('organizer_id', 'JOAGOLFPAT')
                    .single();

                let html = '<h3>Verification Results:</h3>';

                // Check 1: User has society_organizer role
                if (userProfile.role === 'society_organizer') {
                    html += '<p class="success">‚úÖ User has society_organizer role</p>';
                } else {
                    html += `<p class="error">‚ùå User role is: ${userProfile.role}</p>`;
                }

                // Check 2: User is associated with JOA
                if (userProfile.society_id === 'JOAGOLFPAT' || userProfile.society_name?.includes('JOA')) {
                    html += '<p class="success">‚úÖ User is associated with JOA Golf Pattaya</p>';
                } else {
                    html += `<p class="error">‚ùå User society: ${userProfile.society_name || 'None'}</p>`;
                }

                // Check 3: Society profile exists
                if (societyProfile) {
                    html += '<p class="success">‚úÖ JOA Golf Pattaya society profile exists</p>';
                } else {
                    html += '<p class="error">‚ùå JOA Golf Pattaya society profile NOT found</p>';
                }

                // Check 4: localStorage is updated
                const localProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                if (localProfile.role === 'society_organizer') {
                    html += '<p class="success">‚úÖ localStorage profile updated</p>';
                } else {
                    html += '<p class="error">‚ùå localStorage profile NOT updated (reload page or clear cache)</p>';
                }

                html += '<hr><h3>Full Details:</h3>';
                html += '<h4>User Profile:</h4>';
                html += `<pre>${JSON.stringify(userProfile, null, 2)}</pre>`;

                if (societyProfile) {
                    html += '<h4>Society Profile:</h4>';
                    html += `<pre>${JSON.stringify(societyProfile, null, 2)}</pre>`;
                }

                html += '<hr><p class="success"><strong>‚úÖ If all checks pass, you can now access the JOA Golf Pattaya dashboard!</strong></p>';
                html += '<p>Go to the main app and select "Society Organizer" from your profile menu.</p>';

                results.innerHTML = html;

            } catch (error) {
                results.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        // Auto-check status on load
        window.addEventListener('load', checkStatus);
    </script>
</body>
</html>
